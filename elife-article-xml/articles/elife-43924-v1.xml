<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1 20151215//EN"  "JATS-archivearticle1.dtd"><article article-type="research-article" dtd-version="1.1" xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn pub-type="epub" publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">43924</article-id><article-id pub-id-type="doi">10.7554/eLife.43924</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Tools and Resources</subject></subj-group><subj-group subj-group-type="heading"><subject>Neuroscience</subject></subj-group></article-categories><title-group><article-title>optoPAD, a closed-loop optogenetics system to study the circuit basis of feeding behaviors</article-title></title-group><contrib-group><contrib contrib-type="author" equal-contrib="yes" id="author-103565"><name><surname>Moreira</surname><given-names>José-Maria</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0003-2420-7930</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="equal-contrib1">†</xref><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" equal-contrib="yes" id="author-126585"><name><surname>Itskov</surname><given-names>Pavel M</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-2191-7083</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="equal-contrib1">†</xref><xref ref-type="other" rid="fund1"/><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf2"/><xref ref-type="fn" rid="pa1">‡</xref></contrib><contrib contrib-type="author" equal-contrib="yes" id="author-126587"><name><surname>Goldschmidt</surname><given-names>Dennis</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-0603-7176</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="equal-contrib1">†</xref><xref ref-type="other" rid="fund4"/><xref ref-type="fn" rid="con3"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-96796"><name><surname>Baltazar</surname><given-names>Celia</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="con4"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-96793"><name><surname>Steck</surname><given-names>Kathrin</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0003-2711-2873</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="con5"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-142246"><name><surname>Tastekin</surname><given-names>Ibrahim</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="con6"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-126586"><name><surname>Walker</surname><given-names>Samuel J</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0003-3118-8467</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="con7"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" corresp="yes" id="author-62672"><name><surname>Ribeiro</surname><given-names>Carlos</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-9542-7335</contrib-id><email>carlos.ribeiro@neuro.fchampalimaud.org</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="other" rid="fund5"/><xref ref-type="fn" rid="con8"/><xref ref-type="fn" rid="conf1"/></contrib><aff id="aff1"><label>1</label><institution>Champalimaud Centre for the Unknown</institution><addr-line><named-content content-type="city">Lisbon</named-content></addr-line><country>Portugal</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Ramaswami</surname><given-names>Mani</given-names></name><role>Reviewing Editor</role><aff><institution>Trinity College Dublin</institution><country>Ireland</country></aff></contrib><contrib contrib-type="senior_editor"><name><surname>VijayRaghavan</surname><given-names>K</given-names></name><role>Senior Editor</role><aff><institution>National Centre for Biological Sciences, Tata Institute of Fundamental Research</institution><country>India</country></aff></contrib></contrib-group><author-notes><fn fn-type="present-address" id="pa1"><label>‡</label><p>Pharmacology, Sechenov First Moscow State Medical University, Moscow, Russia</p></fn><fn fn-type="con" id="equal-contrib1"><label>†</label><p>These authors contributed equally to this work</p></fn></author-notes><pub-date date-type="publication" publication-format="electronic"><day>22</day><month>06</month><year>2019</year></pub-date><pub-date pub-type="collection"><year>2019</year></pub-date><volume>8</volume><elocation-id>e43924</elocation-id><history><date date-type="received" iso-8601-date="2018-11-30"><day>30</day><month>11</month><year>2018</year></date><date date-type="accepted" iso-8601-date="2019-06-02"><day>02</day><month>06</month><year>2019</year></date></history><permissions><copyright-statement>© 2019, Moreira et al</copyright-statement><copyright-year>2019</copyright-year><copyright-holder>Moreira et al</copyright-holder><ali:free_to_read/><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><ali:license_ref>http://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-43924-v1.pdf"/><related-article ext-link-type="doi" id="ra1" related-article-type="article-reference" xlink:href="10.7554/eLife.31625"/><abstract><object-id pub-id-type="doi">10.7554/eLife.43924.001</object-id><p>The regulation of feeding plays a key role in determining the fitness of animals through its impact on nutrition. Elucidating the circuit basis of feeding and related behaviors is an important goal in neuroscience. We recently used a system for closed-loop optogenetic manipulation of neurons contingent on the feeding behavior of <italic>Drosophila</italic> to dissect the impact of a specific subset of taste neurons on yeast feeding. Here, we describe the development and validation of this system, which we term the optoPAD. We use the optoPAD to induce appetitive and aversive effects on feeding by activating or inhibiting gustatory neurons in closed-loop – effectively creating virtual taste realities. The use of optogenetics allowed us to vary the dynamics and probability of stimulation in single flies and assess the impact on feeding behavior quantitatively and with high throughput. These data demonstrate that the optoPAD is a powerful tool to dissect the circuit basis of feeding behavior, allowing the efficient implementation of sophisticated behavioral paradigms to study the mechanistic basis of animals’ adaptation to dynamic environments.</p></abstract><kwd-group kwd-group-type="author-keywords"><kwd>feeding</kwd><kwd>optogenetics</kwd><kwd>behavior</kwd><kwd>methods</kwd><kwd>taste</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd><italic>D. melanogaster</italic></kwd></kwd-group><funding-group><award-group id="fund1"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001871</institution-id><institution>Fundação para a Ciência e a Tecnologia</institution></institution-wrap></funding-source><award-id>SFRH/BPD/79325/2011</award-id><principal-award-recipient><name><surname>Itskov</surname><given-names>Pavel M</given-names></name></principal-award-recipient></award-group><award-group id="fund2"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100005032</institution-id><institution>Fundação Bial</institution></institution-wrap></funding-source><award-id>283/14</award-id><principal-award-recipient><name><surname>Ribeiro</surname><given-names>Carlos</given-names></name></principal-award-recipient></award-group><award-group id="fund3"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100005032</institution-id><institution>Fundação Bial</institution></institution-wrap></funding-source><award-id>279/16</award-id><principal-award-recipient><name><surname>Ribeiro</surname><given-names>Carlos</given-names></name></principal-award-recipient></award-group><award-group id="fund4"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001871</institution-id><institution>Fundação para a Ciência e a Tecnologia</institution></institution-wrap></funding-source><award-id>PD/BD/114273/2016</award-id><principal-award-recipient><name><surname>Goldschmidt</surname><given-names>Dennis</given-names></name></principal-award-recipient></award-group><award-group id="fund5"><funding-source><institution-wrap><institution>Champalimaud Foundation</institution></institution-wrap></funding-source><principal-award-recipient><name><surname>Ribeiro</surname><given-names>Carlos</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>The optoPAD system combines real-time behavioral analysis with optogenetic manipulations to study how animals adapt to dynamic gustatory environments and to identify the circuit basis of feeding.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>The ability to experimentally manipulate the activity of neurons with cellular resolution has revolutionized our understanding of how circuits generate behavior (<xref ref-type="bibr" rid="bib23">Luo et al., 2018</xref>). This ability has gone hand in hand with an improvement in technologies allowing for the automated and quantitative analysis of behavior (<xref ref-type="bibr" rid="bib1">Anderson and Perona, 2014</xref>; <xref ref-type="bibr" rid="bib2">Branson et al., 2009</xref>; <xref ref-type="bibr" rid="bib3">Brown and de Bivort, 2018</xref>; <xref ref-type="bibr" rid="bib4">Calhoun and Murthy, 2017</xref>; <xref ref-type="bibr" rid="bib10">Egnor and Branson, 2016</xref>; <xref ref-type="bibr" rid="bib25">Mathis et al., 2018</xref>; <xref ref-type="bibr" rid="bib36">Wiltschko et al., 2015</xref>). While most methods for analyzing behavior quantitatively rely on video recordings, alternative methods play important roles in neuroscience research (<xref ref-type="bibr" rid="bib8">Davis, 1973</xref>; <xref ref-type="bibr" rid="bib26">McLean and Kinsey, 1964</xref>). Such approaches have become especially important to study feeding in <italic>Drosophila melanogaster</italic> (<xref ref-type="bibr" rid="bib28">Murphy et al., 2017</xref>; <xref ref-type="bibr" rid="bib31">Ro et al., 2014</xref>; <xref ref-type="bibr" rid="bib37">Yapici et al., 2016</xref>). We have recently established a new method for quantifying feeding behavior in the fly which relies on capacitance measurements (<xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>). The flyPAD allows automated, high-throughput, quantitative analysis of feeding behavior with high temporal resolution. This high temporal resolution enables the dissection of feeding behavior at the level of the motor pattern and the microstructure of feeding. Using this framework, we have shown that different circuit and molecular mechanisms impinge on food intake by modulating two key variables of the feeding microstructure: the probability of initiating a feeding burst and the length of feeding bursts (<xref ref-type="bibr" rid="bib7">Corrales-Carvajal et al., 2016</xref>; <xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>; <xref ref-type="bibr" rid="bib33">Steck et al., 2018</xref>; <xref ref-type="bibr" rid="bib35">Walker et al., 2015</xref>).</p><p>At the neural circuit level, gustation plays a pivotal role in regulating food intake. Classically, gustation has been shown to allow animals to both detect suitable food sources as well as to reject harmful foods (<xref ref-type="bibr" rid="bib9">Dethier, 1976</xref>; <xref ref-type="bibr" rid="bib16">Jaeger et al., 2018</xref>; <xref ref-type="bibr" rid="bib32">Scott, 2018</xref>; <xref ref-type="bibr" rid="bib38">Yarmolinsky et al., 2009</xref>). A key feature of gustation when compared to olfaction or audition is that it requires the physical interaction of taste organs with the sampled substrate. As such, gustatory information is outstandingly contextual and depends critically on the behavior of the animal as it actively explores substrates. Ideally, therefore, manipulations of circuit function during feeding should be tightly coupled to the ongoing behavior. Techniques allowing for the real-time analysis of behavior have enabled neuroscientists to trigger neuronal manipulation specifically when the animal is performing specific behaviors. We have previously used such an approach to show that in <italic>D. melanogaster</italic>, taste peg sensory neurons specifically control the length of yeast feeding bursts (<xref ref-type="bibr" rid="bib33">Steck et al., 2018</xref>).</p><p>Here, we describe the design and implementation of such a high-throughput system allowing optogenetic manipulation of neurons in <italic>Drosophila</italic> contingent on the feeding behavior of the fly: the optoPAD. We show that the optoPAD system allows for the specific, bidirectional manipulation of sweet and bitter neurons thereby triggering or suppressing appetitive or aversive feeding behaviors. We furthermore demonstrate the ability of our system to implement dynamic as well as probabilistic stimulation protocols. These protocols significantly expand the scope of the optoPAD, allowing for complex experimental designs. These additions significantly extend the toolset available to study complex behaviors in high throughput in <italic>Drosophila</italic>.</p></sec><sec id="s2" sec-type="results"><title>Results</title><sec id="s2-1"><title>The optoPAD system</title><p>We set out to develop a system allowing the optogenetic manipulation of circuit activity in <italic>Drosophila</italic> conditional on specific aspects of its ongoing feeding behavior (<xref ref-type="fig" rid="fig1">Figure 1A</xref>). To develop such a device, it is essential to be able to measure specific parameters of feeding behavior in real time. We previously developed the flyPAD system, which reliably measures feeding behavior in high throughput using capacitive proximity sensors from two food sources (<xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>). To allow for optogenetic manipulation of neurons, we designed an LED board housing a high-power multicolor LED (four colors), as well as metal-oxide-semiconductor field-effect transistor (MOSFET) gates and current limiting resistors, that fits on top of the flyPAD arenas (<xref ref-type="fig" rid="fig1">Figure 1B</xref>).</p><fig-group><fig id="fig1" position="float"><object-id pub-id-type="doi">10.7554/eLife.43924.002</object-id><label>Figure 1.</label><caption><title>The optoPAD system.</title><p>(<bold>A</bold>) Concept for the use of closed-loop capacitance measurement of feeding with optogenetic manipulation of neurons in behaving flies. The interaction of the fly with the food source triggers the activation of the LED. (<bold>B</bold>) Overview of the components of the optoPAD, the flyPAD arena and the high-power RGBA LEDs. (<bold>C</bold>) Algorithm for real-time detection of food interactions. Extracted food interaction bouts (activity bouts) are shaded in gray. (<bold>D</bold>) Schematic overview of the optoPAD experimental dataflow.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43924-fig1-v1.tif"/></fig><fig id="fig1s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43924.003</object-id><label>Figure 1—figure supplement 1.</label><caption><title>Quantification of the probability of the occurrence of a feeding burst onset depending on the time after activity bout onset.</title><p>Bins are 0.1 s wide and probabilities are plotted for two different genetic background controls feeding on yeast, on an optoPAD channel triggering light activation.</p><p><supplementary-material id="fig1s1sdata1"><object-id pub-id-type="doi">10.7554/eLife.43924.004</object-id><label>Figure 1—figure supplement 1—source data 1.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1</xref>.</title></caption><media mime-subtype="xlsx" mimetype="application" xlink:href="elife-43924-fig1-figsupp1-data1-v1.xlsx"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43924-fig1-figsupp1-v1.tif"/></fig></fig-group><p>In the original flyPAD system, the relevant aspects of feeding behavior are extracted by offline processing of the capacitance signal after the behavioral experiment. We took advantage of the low complexity of the capacitance signal paired with the real-time data processing capacities of the Bonsai data stream processing language (<xref ref-type="bibr" rid="bib21">Lopes et al., 2015</xref>) to analyze feeding behavior of flies in real time. Bonsai is a powerful visual programming framework especially designed for the acquisition and online processing of complex data streams such as those generated during behavioral experiments. We focused on using Bonsai to extract the periods in which the fly was actively interacting with food (‘activity bouts’), as we previously showed that the total time of these interactions correlated well with total food intake (<xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>). After a series of simple signal processing steps (<xref ref-type="fig" rid="fig1">Figure 1C</xref>), we could obtain the onset time of activity bouts in real time. In order to precisely control the LED illumination, we designed a control breakout board (a standard 32-arena flyPAD system requires three of these boards), each of which uses one microcontroller (Arduino Mega) which operates as an IO device controlling the gates of the MOSFETs. This included a power distribution circuit to distribute power to the 128 channels of the LEDs (32 LEDs x 4 colors) (blueprints available at <ext-link ext-link-type="uri" xlink:href="https://github.com/ribeiro-lab/optoPAD-hardware">https://github.com/ribeiro-lab/optoPAD-hardware</ext-link>). The Arduino Mega runs a standard Firmata software, allowing it to function as a digital general-purpose input/output (GPIO) board from within the Bonsai environment. This allowed us to write all the controlling software, including the finite state machine controlling the experiments for all of the 64 channels of the flyPAD, in Bonsai.</p><p>The resulting optoPAD system has the following dataflow (<xref ref-type="fig" rid="fig1">Figure 1D</xref>): The flyPAD system uses a capacitance-to-digital converter to measure the interaction of the fly with the food. The capacitance information is sent to a computer via the flyPAD mainboard, and the real-time Bonsai algorithm detects when the fly starts to interact with one of the food electrodes. The software sends a signal to one of the digital pins of the microcontroller, which in turn controls the opening of the MOSFET on the LED board, leading to the illumination of a predefined LED color channel and thereby corresponding activation/inactivation of genetically identified neurons (<xref ref-type="video" rid="video1">Video 1</xref>).</p><media id="video1" mime-subtype="mp4" mimetype="video" xlink:href="elife-43924-video1.mp4"><object-id pub-id-type="doi">10.7554/eLife.43924.005</object-id><label>Video 1.</label><caption><title>Video showing the optopad system in operation.</title></caption></media><p>Importantly, five parameters of LED activation can be easily controlled using this software: which food source triggers LED activation; which LED color is activated; the delay between the detection of the initiation of an interaction with the food and light onset; the duration the LED remains on during the light stimulation; and the probability with which an onset of food interaction leads to LED illumination. Furthermore, the user can set how many times the light is triggered, can use a script which allows the delivery of the light after an activity bout is terminated, and can choose to deliver the light in an open-loop mode using predefined set intervals.</p><p>In order to ensure that the LED can be rapidly activated following the initiation of food interactions, we measured the latency of this system. The latency is defined as the time between food contact and LED illumination (with the ‘delay’ parameter set to 0). Our measurements revealed that it takes between 50 and 120 ms for the LED to be activated upon contact with the food. The latency is likely to originate in delays inherent to the serial communication bus, while the range of the latency is likely due to the buffer length of the flyPAD’s system communication. Importantly, this latency is very short relative to the time it takes the fly to initiate a feeding burst after touching the food. This delay is quite reproducibly in the range of 400 ms (<xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1</xref>). It is therefore very unlikely that the fly starts feeding before the LED is activated. By setting the delay parameter to 250 ms one can even time the light onset to coincide even better with feeding onset. Thus, our system is fast enough to ‘close the loop’ within the duration of a single sip.</p><p>To test how well the online activity bout detector works, we compared the performance of the new online algorithm with the previously validated offline algorithm (<xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>). We wrote a MATLAB script that replicates the online Bonsai workflow and classified each sample of a raw capacitance trace as belonging to an activity bout or not and compared this classification to the already validated flyPAD offline detector (<xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>). We then performed an ROC analysis to confirm the accuracy of the online detector. The detection of activity bouts by the online method correctly identified 91.5% of the capacitance trace samples as belonging to an activity bout (8.5% false negatives) and misclassified 1.6% of the samples as activity bouts (false positives). These data show that the online activity bout detector operates within the range of accuracy observed for state-of-the-art offline methods (<xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>).</p></sec><sec id="s2-2"><title>Optogenetic gustatory virtual realities</title><p>To validate the ability of the optoPAD system to manipulate neuronal activity in closed-loop, we decided to use it to create ‘virtual gustatory realities’ and test their impact on feeding behavior. To be able to better control the stimulation parameters, we used a switching DC power supply (40 A) to regulate the intensity of the LEDs. The luminous flux of the LEDs increased linearly with the forward voltage on the LEDs above 2 V for the red and amber LEDs and 2.5 V for the green and blue LEDs (<xref ref-type="fig" rid="fig2">Figure 2A</xref>), allowing us to vary the intensity of stimulation over a significant range. It is important to note that the maximum level of irradiance which can be achieved strongly depends on the wavelength of the LED.</p><fig-group><fig id="fig2" position="float"><object-id pub-id-type="doi">10.7554/eLife.43924.006</object-id><label>Figure 2.</label><caption><title>Increasing light intensity affects the feeding behavior of flies expressing different optogenetic effectors.</title><p>(<bold>A</bold>) Irradiance of all four LEDs increases linearly with increasing voltage (for red and amber above 2 V, for green and blue above 2.5 V). The average value of the three measurements is shown and error bars indicate standard error of mean. (<bold>B</bold>) Difference in total number of sips on the stimulated (ON) and unstimulated (OFF) food patches of the same arena for 24 hr starved male flies expressing CsChrimson under the control of <italic>Gr5a-GAL4</italic>, and corresponding genetic controls. Both food sources contained 5 mM sucrose solution in 1% agarose. (<bold>C</bold>) Difference in total number of sips on the stimulated (ON) and unstimulated (OFF) food patches of the same arena for 3 days yeast-deprived, mated female flies expressing GtACR1 under the control of <italic>57</italic> F03-GAL4, which labels taste peg GRNs, and corresponding genetic control. For genotypes, see Materials and methods and key resources table. Both food sources contained 10% yeast solution in 1% agarose. The numbers below the graphs indicate the number of flies tested in each condition. ***p&lt;0.001, **p&lt;0.01, *p&lt;0.05, ns non-significance. Boxes represent median with upper/lower quartiles; groups compared by Wilcoxon rank-sum test, followed by Bonferroni multiple comparison test when more than two groups were compared.</p><p><supplementary-material id="fig2sdata1"><object-id pub-id-type="doi">10.7554/eLife.43924.011</object-id><label>Figure 2—source data 1.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig2">Figure 2A</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig2-data1-v1.csv"/></supplementary-material></p><p><supplementary-material id="fig2sdata2"><object-id pub-id-type="doi">10.7554/eLife.43924.012</object-id><label>Figure 2—source data 2.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig2">Figure 2B</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig2-data2-v1.csv"/></supplementary-material></p><p><supplementary-material id="fig2sdata3"><object-id pub-id-type="doi">10.7554/eLife.43924.013</object-id><label>Figure 2—source data 3.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig2">Figure 2C</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig2-data3-v1.csv"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43924-fig2-v1.tif"/></fig><fig id="fig2s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43924.007</object-id><label>Figure 2—figure supplement 1.</label><caption><title>Mean number of sips per feeding bursts during open-loop stimulation (1 s ON, 2 s OFF) measured on both food patches of the same arena for 3 days yeast-deprived, mated female flies expressing <italic>GtACR1</italic> under the control of <italic>57</italic> F03-GAL4 or <italic>67E03-GAL4</italic>, which both label taste peg GRNs, and corresponding genetic control (<xref ref-type="bibr" rid="bib33">Steck et al., 2018</xref>).</title><p>Both food sources contained 10% yeast solution in 1% agarose. The numbers below the graphs indicate the number of flies tested in each condition. ****p&lt;0.0001. Boxes represent median with upper/lower quartiles; groups compared by Wilcoxon rank-sum test, followed by Bonferroni multiple comparison test for two comparisons.</p><p><supplementary-material id="fig2s1sdata1"><object-id pub-id-type="doi">10.7554/eLife.43924.008</object-id><label>Figure 2—figure supplement 1—source data 1.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig2-figsupp1-data1-v1.csv"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43924-fig2-figsupp1-v1.tif"/></fig><fig id="fig2s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43924.009</object-id><label>Figure 2—figure supplement 2.</label><caption><title>Difference in total number of sips on the stimulated (ON) and unstimulated (OFF) food patches of the same arena for 3 days yeast-deprived, mated female flies expressing <italic>CsChrimson</italic> under the control of <italic>SS02299-GAL4</italic>, and corresponding genetic controls.</title><p>All genotypes have been supplemented either with (+) or without (-) 5 ml of 400 mM all-trans retinal for 6 days. Both food sources contained 10% yeast solution in 1% agarose. The numbers below the graphs indicate the number of flies tested in each condition. ***p&lt;0.001, **p&lt;0.01, *p&lt;0.05, ns non-significance. Boxes represent median with upper/lower quartiles; groups compared by Wilcoxon rank-sum test, followed by Bonferroni multiple comparison test when more than two groups were compared.</p><p><supplementary-material id="fig2s2sdata2"><object-id pub-id-type="doi">10.7554/eLife.43924.010</object-id><label>Figure 2—figure supplement 2—source data 2.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig2-figsupp2-data2-v1.csv"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43924-fig2-figsupp2-v1.tif"/></fig></fig-group><p>To test if we can induce appetitive consummatory behaviors using the optoPAD, we used the <italic>Gr5a-GAL4</italic> line, which drives expression in sugar-sensing neurons of the labellum (<xref ref-type="bibr" rid="bib24">Marella et al., 2006</xref>; <xref ref-type="bibr" rid="bib34">Thorne et al., 2004</xref>). These neurons have been shown to be sufficient to initiate feeding (<xref ref-type="bibr" rid="bib39">Zhang et al., 2007</xref>). Starved male flies expressing the red-shifted channelrhodopsin CsChrimson (<xref ref-type="bibr" rid="bib18">Klapoetke et al., 2014</xref>) in <italic>Gr5a</italic> neurons were given the choice to feed from two 5 mM sucrose sources in an optoPAD arena. One food source in each arena was programmed to trigger the activation of the red LED upon interaction (ON channel) while interactions with the other food source in the same arena never led to light activation (OFF channel). Even very low stimulation intensities (2 V) led to a clear and strong increase of feeding from the food source paired with optogenetic stimulation compared to the unstimulated source (<xref ref-type="fig" rid="fig2">Figure 2B</xref>). Interestingly, increasing the stimulation intensity did not lead to an increase in appetitiveness, indicating that a maximal behavioral impact can be achieved at low irradiances, thereby minimizing possible side effects caused by light.</p><p>Mated female flies deprived of protein for 3 days develop a robust appetite for yeast – their main protein source (<xref ref-type="bibr" rid="bib5">Carvalho-Santos and Ribeiro, 2018</xref>; <xref ref-type="bibr" rid="bib20">Leitão-Gonçalves et al., 2017</xref>; <xref ref-type="bibr" rid="bib30">Ribeiro and Dickson, 2010</xref>; <xref ref-type="bibr" rid="bib33">Steck et al., 2018</xref>). This appetite is driven by an increase in the length of feeding bursts, which is controlled by the activity of specific subsets of yeast gustatory neurons (taste pegs gustatory neurons) located on the labellum (<xref ref-type="bibr" rid="bib7">Corrales-Carvajal et al., 2016</xref>; <xref ref-type="bibr" rid="bib33">Steck et al., 2018</xref>). We previously demonstrated that silencing taste peg neurons with the anion channelrhodopsin GtACR1 (<xref ref-type="bibr" rid="bib27">Mohammad et al., 2017</xref>) using the optoPAD system is sufficient to terminate feeding on yeast (<xref ref-type="bibr" rid="bib33">Steck et al., 2018</xref>). To better characterize this silencing effect, flies were given the choice between two sources of yeast, one of which was paired with green light illumination. As we increased the intensity of light by increasing the voltage of the LED to 3 V, flies expressing GtACR1 in taste peg neurons fed significantly less from the channel paired with light compared to control flies (<xref ref-type="fig" rid="fig2">Figure 2C</xref>). In contrast to the <italic>Gr5a</italic> activation experiments (<xref ref-type="fig" rid="fig2">Figure 2B</xref>), the decrease in yeast feeding was accentuated with the increase in the applied voltage. This can be easily explained by the fact that the irradiance for the red and green lights reach the same intensity at different voltages (<xref ref-type="fig" rid="fig2">Figure 2A</xref>). Furthermore, it is important to note that in both experiments, we observed no behavioral effect of light in control genotypes. This indicates that the illumination itself has minimal effects on fly feeding behavior. Importantly, the optoPAD can also be used to stimulate neurons using open-loop experimental designs. Indeed, silencing taste peg neurons by delivering the light in a fixed pattern not contingent on the behavior of the animal led to a specific decrease in the length of feeding bursts (<xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>). Such experiments can be very useful when no hypothesis exists as to how the activity of a neuronal population of interest relates to the microstructure of the behavior. By correlating the relationship between light onset and specific behavioral phenotypes post-hoc, it should be possible to generate specific hypotheses of how the activity of a neuron relates to specific features of feeding behavior, guiding the design of specific follow-up closed-loop experiments.</p><p>To show that the optoPAD can also be used to manipulate sparse sets of neurons located deeply within the brain, we chose to activate giant fiber neurons in closed-loop upon initiation of feeding. The rationale of this proof-of-concept experiment was to use a sparse line labeling few (2) neurons deep in the brain of the fly, which has a readily observable phenotype (jumping), and which should have a clear effect on feeding behavior (termination of feeding). Indeed, upon the initiation of feeding and concomitant light activation, flies expressing CsChrimson in escape neurons (<xref ref-type="bibr" rid="bib29">Namiki et al., 2018</xref>) jumped, leading to the termination of feeding (<xref ref-type="video" rid="video2">Videos 2</xref> and <xref ref-type="video" rid="video3">3</xref>). This led to a drastic decrease in feeding from the food source triggering light when compared with the control food source (<xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2</xref>). These results show that the optoPAD can be used to manipulate very sparse, centrally located neurons, and monitor the impact of the manipulation on feeding behavior.</p><media id="video2" mime-subtype="mp4" mimetype="video" xlink:href="elife-43924-video2.mp4"><object-id pub-id-type="doi">10.7554/eLife.43924.014</object-id><label>Video 2.</label><caption><title>Optogenetic activation of the giant fiber neurons marked by the C17-Gal4 line triggers escape responses upon feeding initation.</title></caption></media><media id="video3" mime-subtype="mp4" mimetype="video" xlink:href="elife-43924-video3.mp4"><object-id pub-id-type="doi">10.7554/eLife.43924.015</object-id><label>Video 3.</label><caption><title>Optogenetic stimulation of control fly triggers no escape responses upon feeding initation.</title></caption></media><p>The mechanistic dissection of specific neurons’ contribution to a behavior often requires the observation of opposite behavioral effects upon increases and decreases in their activity. Gustatory neurons are an ideal test case for this as they elicit both appetitive (e.g. sweet neurons) as well as aversive behavioral responses (e.g. bitter neurons). We tested the ability of the optoPAD system to both induce and suppress appetitive feeding responses using the <italic>Gr64f-GAL4</italic> line, which labels appetitive sugar-sensing neurons previously shown to be important to sustain carbohydrate feeding (<xref ref-type="bibr" rid="bib17">Jiao et al., 2008</xref>). As observed for <italic>Gr5a</italic> neurons, closed-loop activation of <italic>Gr64f</italic> neurons using CsChrimson led to increased feeding (<xref ref-type="fig" rid="fig3">Figure 3A</xref>, left panel). This effect was absent in control genotypes (<xref ref-type="fig" rid="fig3">Figure 3A</xref>, right panel). Conversely, hyperpolarization of <italic>Gr64f</italic> neurons using GtACR1 led to a loss of appetitive behavior and hence a decrease in feeding from the sugar source paired with green light activation (<xref ref-type="fig" rid="fig3">Figure 3B</xref>).</p><fig id="fig3" position="float"><object-id pub-id-type="doi">10.7554/eLife.43924.016</object-id><label>Figure 3.</label><caption><title>Creating virtual taste realities for <italic>Drosophila</italic> using the optoPAD.</title><p>(<bold>A–D</bold>) Total number of sips from the unstimulated (LED OFF) and the light-stimulated (LED ON) food patches of the same arena by flies expressing CsChrimson (<bold>A and C</bold>) or GtACR1 (<bold>B and D</bold>), under the control of <italic>Gr64f-GAL4</italic> (<bold>A and B</bold>) or <italic>Gr66a-GAL4</italic> (<bold>C and D</bold>) (left side of the panels). Difference in total number of sips on the stimulated (ON) and unstimulated (OFF) food patches for flies expressing CsChrimson or GtACR1 (<bold>A and C</bold>), under the control of <italic>Gr64f-GAL4</italic> (<bold>A and B</bold>) or <italic>Gr66a-GAL4</italic> (<bold>C and D</bold>), and corresponding genetic controls (right side of the panels). All flies were 24 hr starved male flies (for genotypes, see Materials and methods and key resources table). The food substrate is indicated in each panel. The numbers below the graphs indicate the number of flies tested in each condition. ***p&lt;0.001, **p&lt;0.01, *p&lt;0.05. Boxes represent median with upper/lower quartiles; groups compared by Kruskal-Wallis test, followed by Dunn’s multiple comparison test.</p><p><supplementary-material id="fig3sdata1"><object-id pub-id-type="doi">10.7554/eLife.43924.017</object-id><label>Figure 3—source data 1.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig3">Figure 3A</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig3-data1-v1.csv"/></supplementary-material></p><p><supplementary-material id="fig3sdata2"><object-id pub-id-type="doi">10.7554/eLife.43924.018</object-id><label>Figure 3—source data 2.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig3">Figure 3B</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig3-data2-v1.csv"/></supplementary-material></p><p><supplementary-material id="fig3sdata3"><object-id pub-id-type="doi">10.7554/eLife.43924.019</object-id><label>Figure 3—source data 3.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig3">Figure 3C</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig3-data3-v1.csv"/></supplementary-material></p><p><supplementary-material id="fig3sdata4"><object-id pub-id-type="doi">10.7554/eLife.43924.020</object-id><label>Figure 3—source data 4.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig3">Figure 3D</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig3-data4-v1.csv"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43924-fig3-v1.tif"/></fig><p>To characterize the effect of closed-loop optogenetic manipulation of aversive neurons on feeding, we used <italic>Gr66a-GAL4</italic>, which labels bitter-sensing neurons (<xref ref-type="bibr" rid="bib24">Marella et al., 2006</xref>; <xref ref-type="bibr" rid="bib34">Thorne et al., 2004</xref>). In contrast to the depolarization of sweet gustatory neurons, flies expressing CsChrimson in bitter gustatory neurons immediately terminated feeding from an appetitive food source upon light activation (<xref ref-type="fig" rid="fig3">Figure 3C</xref>). This strong effect clearly mimics the potent aversive effect bitter substances have on feeding behavior. To test if we could suppress the aversive effect of bitter food using the optoPAD setup, we expressed GtACR1 in <italic>Gr66a</italic> neurons and observed the effect of green light activation on feeding from a quinine-laced sucrose solution. Indeed, flies exhibited higher feeding from the bitter food source paired with light stimulation than from the unpaired food source (<xref ref-type="fig" rid="fig3">Figure 3D</xref>). These experiments demonstrate the ability of the optoPAD to induce and suppress both appetitive and aversive effects on feeding behavior using either optogenetic activation or inhibition of different neuronal populations.</p></sec><sec id="s2-3"><title>Creating dynamic gustatory virtual realities</title><p>One of the unique features of virtual realities is the ability to generate stimuli that can change dynamically in a way that might be impossible with natural stimuli. The high temporal precision of optogenetics makes it ideal to both tightly link changes in activity of specific neurons to the behavior of the animal, as well as to change this contingency in a flexible while precise manner. We therefore implemented the ability to arbitrarily predefine the conditions upon which the behavior of the animal triggers light activation. As a proof of concept, we first set out to determine how flies would respond to dynamically changing the identity of the food source triggering gustatory stimulation. When flies expressing CsChrimson in bitter neurons (using <italic>Gr66a-GAL4</italic>) are given the choice between two identical appetitive food sources, they avoid feeding from the one paired with light activation (<xref ref-type="fig" rid="fig3">Figure 3C</xref>). Bonsai allows us to change the variables controlling this stimulation in a dynamic fashion. We programmed the system to switch the identity of the food source paired with light activation every 5 min (<xref ref-type="fig" rid="fig4">Figure 4A</xref>). From the beginning of the assay, the behavior of the flies appears to follow the stimulation pattern, with flies feeding less from the food source paired with light activation (<xref ref-type="fig" rid="fig4">Figure 4B</xref>). Only after 10 min of exploration, however, did these preferences reach statistical significance. As clearly visible in the raster plots of the feeding behavior, some flies always interact with both channels, but in the two first blocks of the experiment (0–5 min and 5–10 min) overall few flies interact with the food (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>). This likely reduces the statistical power to detect a possible preference and might be due to an ‘acclimatization’ period from the moment the animals are introduced into the chambers (<xref ref-type="bibr" rid="bib7">Corrales-Carvajal et al., 2016</xref>).</p><fig-group><fig id="fig4" position="float"><object-id pub-id-type="doi">10.7554/eLife.43924.021</object-id><label>Figure 4.</label><caption><title>The optoPAD allows for complex dynamic closed-loop experimental designs.</title><p>In all experiments, 5–7 days old female <italic>Gr66a-GAL4 &gt; CsChrimson</italic> flies were used. (<bold>A</bold>) Schematic overview of the dynamic virtual taste reality experiment: every five minutes the contingency of the experiment is reversed (in each experimental block the fly’s interaction with a different channel triggered light stimulation). (<bold>B</bold>) Number of sips from channel 1 (upper half of the plot) and channel 2 (lower half of the plot) across time in the changing virtual taste reality setting described in A. Columns and lines represent mean and the standard error of the mean, respectively. The trials leading to LED activation are shaded in red. (<bold>C</bold>) Onset of light stimulation (red box) can be freely set to occur at different times after the initiation of an interaction with food (delay of 1.5, 3 and 6 s). The lower part of the diagram represents a representative capacitance trace with the onset of food contact marked with an arrow. (<bold>D</bold>) Duration of activity bouts in flies exposed to light after different delays relative to the initiation of food interactions and corresponding controls (experimental design described in C). Plotted are the duration of activity bouts for the stimulated flies (light) and for the same number of trials that were longer than 1.5, 3 and 6 s (from left to right) performed by the ‘no light’ control flies. (<bold>E</bold>) Schematic of the experimental design in which light activation was set to happen in a probabilistic manner. (<bold>F</bold>) Duration of activity bouts of the catch trials. Plotted are the duration of activity bouts for the stimulated flies (light) and for a selection of 10% of all the trials that were longer than 1.5, 3 and 6 s (from left to right) performed by the ‘no light’ control flies. (<bold>G</bold>) Cumulative feeding for the four different groups of the experiment described in (<bold>E</bold>). Line represents the mean and the shading the standard error of the mean. Dotted line indicates the 1100 sips threshold used to calibrate the data for the internal state of the animal. (<bold>H</bold>) Duration of activity bouts of the catch-trials for sip-calibrated flies (trials performed until the flies had reached a total of 1100 sips). Plotted are the duration of activity bouts for the stimulated flies (light) and for a selection of 10% of all the trials that were longer than 1.5, 3 and 6 s (from left to right) performed by the ‘no light’ control flies. For genotypes, see Materials and methods and key resources table. ***p&lt;0.001, **p&lt;0.01, *p&lt;0.05, ns non-significance. The numbers below the graphs in D, F and H indicate the number of flies tested in each condition. In D, F, and H, boxes represent median with upper/lower quartiles. In D, F and H, groups were compared by Kruskal-Wallis test, followed by Dunn’s multiple comparison test. In B, the total number of sips for all bins in each channel during each period of 5 min was compared by Wilcoxon rank-sum test.</p><p><supplementary-material id="fig4sdata1"><object-id pub-id-type="doi">10.7554/eLife.43924.024</object-id><label>Figure 4—source data 1.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig4">Figure 4B</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig4-data1-v1.csv"/></supplementary-material></p><p><supplementary-material id="fig4sdata2"><object-id pub-id-type="doi">10.7554/eLife.43924.025</object-id><label>Figure 4—source data 2.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig4">Figure 4D</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig4-data2-v1.csv"/></supplementary-material></p><p><supplementary-material id="fig4sdata3"><object-id pub-id-type="doi">10.7554/eLife.43924.026</object-id><label>Figure 4—source data 3.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig4">Figure 4F</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig4-data3-v1.csv"/></supplementary-material></p><p><supplementary-material id="fig4sdata4"><object-id pub-id-type="doi">10.7554/eLife.43924.027</object-id><label>Figure 4—source data 4.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig4">Figure 4G</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig4-data4-v1.csv"/></supplementary-material></p><p><supplementary-material id="fig4sdata5"><object-id pub-id-type="doi">10.7554/eLife.43924.028</object-id><label>Figure 4—source data 5.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig4">Figure 4H</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig4-data5-v1.csv"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43924-fig4-v1.tif"/></fig><fig id="fig4s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43924.022</object-id><label>Figure 4—figure supplement 1.</label><caption><title>Activity bouts of individual flies in a dynamic experimental protocol experiment.</title><p>(<bold>A</bold>) Raster plot of the data shown in <xref ref-type="fig" rid="fig4">Figure 4B</xref>. Every line corresponds to a single fly undergoing the dynamic experimental protocol. Gray marks activity bouts with the food source not triggering light stimulation and red marks activity bouts triggering light activation and hence likely activation of bitter neurons. Dashed lines symbolize the time point at which the channel triggering light activation was changed. (<bold>B</bold>) Summed time flies are interacting with the food in a 20 s wide bin for non-light triggering channel (gray) and light triggering channel (red). Data in the bin are normalized by the total number of flies in the assay.</p><p><supplementary-material id="fig4s1sdata1"><object-id pub-id-type="doi">10.7554/eLife.43924.023</object-id><label>Figure 4—figure supplement 1—source data 1.</label><caption><title>Source data file for <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43924-fig4-figsupp1-data1-v1.csv"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43924-fig4-figsupp1-v1.tif"/></fig></fig-group><p>Next, we tested if we can alter the length of the interaction of the fly with food by increasing the delay between the initiation of food interactions and LED activation (<xref ref-type="fig" rid="fig4">Figure 4C</xref>). By initiating the optogenetic activation of <italic>Gr66a</italic> neurons 1.5, 3 or 6 s after the fly starts interacting with the food, we could make the flies terminate their interaction with food after precisely 2.66, 4.25 or 7.34 s, respectively (<xref ref-type="fig" rid="fig4">Figure 4D</xref>). This was a dramatic shortening of their activity bout, as control flies displayed reproducibly long bouts with a median of around 15 s. These experiments show that the optoPAD system can be used to dynamically change the contingency between the behavior of the animal and the optogenetic stimulation.</p></sec><sec id="s2-4"><title>Creating probabilistic gustatory virtual realities</title><p>While the optogenetic experiments described up to this point have been deterministic in nature, behavioral experiments in which the behavior of the animal is linked to a probabilistic delivery of a reward or punishment have been very powerful in probing the neuronal substrates of complex learned behaviors (<xref ref-type="bibr" rid="bib11">Fiorillo et al., 2003</xref>). Such designs can be either used to allow the animal to learn specific statistical properties of the environment (<xref ref-type="bibr" rid="bib22">Lottem et al., 2018</xref>), or unstimulated trials (catch trials) can be used as controls within a task (<xref ref-type="bibr" rid="bib19">Lak et al., 2014</xref>). We tested the ability of the optoPAD system to implement such probabilistic experimental designs. We used Bonsai to set the probability of red light activation upon food interactions to 90% for both food sources (<xref ref-type="fig" rid="fig4">Figure 4E</xref>). Therefore, 10% of food interactions (trials) did not result in LED activation. Importantly, these ‘catch trials’ were randomly selected and therefore could not be predicted by the fly. Protein-deprived female flies expressing CsChrimson in bitter taste neurons were subjected to such a probabilistic experimental design for an hour. Similarly to the experiments described in <xref ref-type="fig" rid="fig4">Figure 4C and D</xref>, for each fly red light was either triggered after 1.5, 3, or 6 s. As expected from <xref ref-type="fig" rid="fig4">Figure 4D</xref>, in stimulation trials, the length of activity bouts was shortened to different extents under the three different delays. Intriguingly however, in the catch trials, the food interaction bouts were much longer than in control experiments where no light was triggered throughout the experiment (<xref ref-type="fig" rid="fig4">Figure 4F</xref>). This effect was independent of the length of the interval between food contact and light onset.</p><p>This data is consistent with the hypothesis that flies undergoing the optogenetic activation protocol learn to expect that their interaction with the food will be ‘interrupted’ by a bitter stimulus after a relatively short time window. When this expectation is not met, the animal compensates by staying longer on the food, allowing it to ingest as much food as possible during the bout. An alternative explanation of why flies exhibit longer activity bouts might be due to a rebound effect: since activation of <italic>Gr66a</italic> neurons prevents consumption of sufficient food, flies remain hungry which leads them to overconsume on catch trials. This hypothesis is supported by the analysis of the dynamics of food intake, which reveals clear differences in total food intake across the experimental groups (<xref ref-type="fig" rid="fig4">Figure 4G</xref>). These differences should lead to drastic differences in internal states between the flies exposed to the light and those exposed to the no-light control situation, and hence big differences in the feeding microstructure (<xref ref-type="bibr" rid="bib7">Corrales-Carvajal et al., 2016</xref>; <xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>). In order to control for the effect of internal state on the catch trials, we decided to only include in our analysis the catch trials, in the time period until the flies have performed their first 1100 sips of yeast, therefore controlling for differences in food intake (dashed line in <xref ref-type="fig" rid="fig4">Figure 4G</xref>). This analysis revealed no significant differences in the length of food interactions in catch trials between the flies that did not receive <italic>Gr66a</italic> neurons stimulation (no light) and any of the experimental groups (<xref ref-type="fig" rid="fig4">Figure 4H</xref>). This result strongly suggests that the originally observed increase in the duration of food interactions during catch trials can be explained by differences in the deprivation state of the fly. This interpretation is supported by the observation that the main difference between the calibrated and non-calibrated data is the increase in the length of activity bouts in the non-light population of the calibrated dataset (<xref ref-type="fig" rid="fig4">Figure 4H</xref>). While we cannot rule out that in this behavioral paradigm flies learn to adapt their behavior to an expectation of a possible outcome, the behavioral effects can be explained by differences in internal metabolic state induced by alteration in the feeding behavior of the animal. Overall these experiments show that the optoPAD system allows the implementation of behavioral paradigms, in which stimuli are delivered optogenetically in a probabilistic manner. It however also highlights the importance of controlling for differences in internal state induced by complex experimental designs when interpreting behavioral data. Importantly, this challenge can be overcome using the rich and highly quantitative behavioral data generated by the flyPAD system.</p></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>We describe an experimental setup which allows the closed-loop optogenetic manipulation of specific neurons in <italic>Drosophila melanogaster</italic> contingent on the feeding behavior of the animal. The system extends the ability of the flyPAD to efficiently detect interactions of flies with food using capacitive sensing, by implementing real-time analysis of feeding behavior and the ability to activate light sources of different wavelengths depending on this behavior. This has allowed us to explore the effect of activating and silencing specific gustatory neurons on feeding behavior. Importantly, by activating and inhibiting sweet and bitter neurons, we were able to produce both phagostimulatory and phagoinhibiting effects in a coherent manner. This demonstrates that our closed-loop optogenetic manipulations are able to induce all phenotypes expected from the known biology of these neurons. Given that the exposure of the animal to gustatory stimuli is highly dependent on its behavior, it is essential that the design of gustatory circuit manipulations takes into account the behavior of the animal. We therefore envisage that the optoPAD will be especially valuable when exploring the involvement of sensorimotor circuits in feeding behavior. As the modular regulation of feeding microstructure plays a key role in nutrient homeostasis, the high temporal sensitivity of the flyPAD makes the optoPAD ideally suited to study its circuit basis.</p><p>The ability to analyze feeding behavior in a quantitative, high-resolution, and high-throughput fashion using the flyPAD technology has been leveraged to significantly advance our understanding of <italic>Drosophila</italic> feeding behavior. The optoPAD highlights a further advantage of this technology: its flexibility and expandability. After we described the first use of the flyPAD technology to manipulate behavior using optogenetics (<xref ref-type="bibr" rid="bib33">Steck et al., 2018</xref>), Jaeger and colleagues also described an adaptation of the flyPAD technology to manipulate taste neurons during feeding (<xref ref-type="bibr" rid="bib16">Jaeger et al., 2018</xref>). Interestingly, their approach is fundamentally different from the one we described, attesting to the flexibility of the flyPAD system. They define at the level of the hardware, specific features of the capacitance signal to trigger light activation. This approach allows the rapid triggering of light when the capacitance signal reaches a certain level, which is likely to be highly correlated with the time periods the fly touches the food. Given that the analysis of the behavior is implemented at the level of the hardware, it is however not possible for the user to readily modify the analysis of the behavior leading to the triggering of the light or to modify how and when the light stimulus gets triggered (delays, probabilities of stimulation, dynamic changes to the stimulation protocol). Furthermore, while this system is fast, the signal is not processed to detect sips and the light onset is therefore unlikely to reliably coincide with these feeding events. While our experiments clearly show that the current optoPAD system is able to modulate feeding behavior using closed-loop optogenetic manipulations, the ability to process the behavioral data in a flexible and complex way is likely to introduce a longer latency than that of the STROBE system. This latency can be counteracted using the existing knowledge of the very stereotyped parameters underlying feeding behavior, which allow us to tune the stimulation parameters in order for the light to better coincide with sip onset. It should also be possible to further optimize the efficiency with which the hardware handles the incoming signals and the speed at which the software processes these, leading to a significant improvement in the temporal precision of the delivery of the light stimulus. This might be important when dissecting the relationship between circuit activity and behavior at the scale of a single action potential. There will, however, always be a conflict between flexibility in experimental design, requiring computation time to analyze the behavioral signal, and minimizing the delay between behavior detection and light stimulation. We propose that as long as the delay is not beyond the behaviorally meaningful scale, the advantages of flexibility outweigh small improvements in the speed of the system. In any case as shown by both the optoPAD and the STROBE system, the flyPAD technology is flexible enough to allow the implementation of either priority.</p><p>Given its flexible design, the optoPAD system not only allows for a fixed closed-loop manipulation of neurons, but confers substantial flexibility to define how feeding behavior is linked to light activation. The researcher can for example predefine how many light stimulations will happen in one session, stimulate after the termination of an activity bout, or perform experiments in an open-loop mode. An important further feature if the possibility to design experiments in which light activation is altered to be probabilistic, while occurring at a fixed rate. This allows the experimenter to probe the effect of neuronal manipulations altering feeding behavior using interleaved control trials (catch trials). We expect that the ability to alter the dynamics and probabilities of optogenetic manipulations will be most useful to manipulate the behavior of <italic>Drosophila</italic> in order to probe its ability to learn complex contingencies. By activating ‘reward’ and ‘punishment’ neurons in closed-loop using different behavioral contingencies, the optoPAD system should allow the design of new operant conditioning paradigms in which the animal learns to associate the consequences of its own behavior with specific outcomes or the statistical structure of its environment. Learning such abstract environmental structures is a fundamental ability animals use to optimize their foraging strategies (<xref ref-type="bibr" rid="bib6">Chittka, 2017</xref>; <xref ref-type="bibr" rid="bib12">Glimcher and Fehr, 2013</xref>). The extent to which <italic>Drosophila</italic> is able to perform such proto-cognitive computations is currently an important frontier in fly systems neuroscience. We expect that the flexibility of the optoPAD as well as its high-throughput design will allow researchers to explore how flies adapt their behavior to complex environmental features and identify the underlying neuronal circuits and computations.</p></sec><sec id="s4" sec-type="materials|methods"><title>Materials and methods</title><table-wrap id="keyresource" position="anchor"><label>Key resources table</label><table frame="hsides" rules="groups"><thead><tr><th>Reagent type <break/>(species) or <break/>resource</th><th>Designation</th><th>Source or reference</th><th>Identifiers</th><th>Additional <break/>information</th></tr></thead><tbody><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>Gr5a-GAL4</italic></td><td>other</td><td/><td>Obtained from Kristin Scott lab</td></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>pUAS-Chrimson-mVenus</italic></td><td>BDSC</td><td valign="bottom">BDSC ID: 55136</td><td/></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>57</italic> F03-GAL4</td><td>BDSC</td><td valign="bottom">BDSC ID: 46386</td><td/></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>pBDP-GAL4Uw</italic></td><td>BDSC</td><td valign="bottom">BDSC ID: 68384</td><td/></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>W[1118]</italic></td><td>other</td><td/><td>Obtained from Barry Dickson lab</td></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>UAS-GtACR1</italic></td><td>doi: <ext-link ext-link-type="uri" xlink:href="https://dx.doi.org/10.1038/nmeth.4148">10.1038/nmeth.4148</ext-link></td><td/><td>Obtained from Adam Claridge-Chang lab</td></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>Gr64f-GAL4</italic></td><td>BDSC</td><td valign="bottom">BDSC ID: 57668</td><td/></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>attP2</italic></td><td>BDSC</td><td valign="bottom">BDSC ID: 8622</td><td/></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>Gr66a-GAL4</italic></td><td>other</td><td valign="bottom"/><td>Obtained from Bassem Hassan lab <break/></td></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>67E03-GAL4</italic></td><td>BDSC</td><td valign="bottom">BDSC ID: 39441</td><td/></tr><tr><td valign="bottom">Genetic reagent (<italic>D. melanogaster</italic>)</td><td><italic>SS02299-GAL4</italic></td><td>Janelia Research Campus; doi: <ext-link ext-link-type="uri" xlink:href="https://dx.doi.org/10.7554/elife.34272">10.7554/elife.34272</ext-link></td><td>Robot ID: 3018165</td><td/></tr><tr><td>Software</td><td>Custom-written scripts in MATLAB R2013b</td><td>MathWorks</td><td>RRID: <ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/SCR_001622">SCR_001622</ext-link></td><td/></tr><tr><td>Software</td><td>Bonsai 2.4</td><td><ext-link ext-link-type="uri" xlink:href="https://bonsai-rx.org/">https://bonsai-rx.org/</ext-link>, doi: <ext-link ext-link-type="uri" xlink:href="https://dx.doi.org/10.3389/fninf.2015.00007">10.3389/fninf.2015.00007</ext-link></td><td/><td/></tr></tbody></table></table-wrap><sec id="s4-1"><title>Fly stocks and rearing conditions</title><p>Flies were reared at 25°C, 70% relative humidity (RH) in the dark to prevent non-specific activation of neurons. Flies were reared at standard density and were matched for age and husbandry conditions. The yeast-based fly medium (YBM) contained 80 g cane molasses, 22 g sugar beet syrup, 8 g agar, 80 g corn flour, 10 g soya flour, 18 g yeast extract, 8 ml propionic acid, and 12 ml nipagin (15% in ethanol), per liter. All data are from 24 hr wet-starved male flies unless otherwise stated. After hatching flies were aged for 5–7 days, then groups of 12–15 males were transferred to new vials and approximately 10 wild-type female flies were added. They were kept on YBM medium containing 0.4 mM all-trans-retinal (Sigma-Aldrich, #R2500, made using a stock solution of 100 mM all-trans-retinal dissolved in ethanol) for 2 days. To induce starvation, the flies were then transferred to vials containing tissue paper soaked with 5 ml Milli-Q water containing 0.4 mM all-trans-retinal 24 hr before the experiment. The starvation was chosen to increase carbohydrate appetite and to ensure robust feeding on sucrose.</p><p>For the experiments described in <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1</xref>, <xref ref-type="fig" rid="fig2">Figure 2B</xref>, <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>, <xref ref-type="fig" rid="fig4">Figure 4</xref> and <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref> mated female flies were deprived of yeast for 3 days on a tissue soaked with 6.5 ml of 100 mM sucrose, and 0.4 mM all-trans-retinal.</p></sec><sec id="s4-2"><title>Hardware design and real-time data analysis</title><p>The optoPAD system is a new generation of the flyPAD, that was previously described in <xref ref-type="bibr" rid="bib15">Itskov et al. (2014)</xref>. Additional hardware to the flyPAD was designed to fit on top of each of the 32 behavioral arenas and allow independent activation of 32 high-power (10 W) RGBA LEDs (ref. no. LZ4-00MA10; LED Engin, San Jose, CA, USA). Printed circuit boards were designed using Eagle CAD software (Cadsoft - version 6.2.0). The designs were then sent to Eurocircuits (<ext-link ext-link-type="uri" xlink:href="http://www.eurocircuits.com/">http://www.eurocircuits.com/</ext-link>) for production.</p><p>The PCBs hosting the LED (LED board) measure 5 × 5 cm and fit exactly on top of the flyPAD arenas supported by screws and nuts that align the two boards. The LED is placed at the center of each board directly facing the middle of the flyPAD arena. An additional electrical circuit on each LED board includes four MOSFET N-ch (one for each LED color) that serve as switches for the LEDs and a set of five resistors connected in series to set the correct voltage to the pole of each individual color LED (3.3 and 0.5 Ω for red; 1 and 0.5 Ω for amber; 2 Ω for green, no voltage drop resistor was used for the blue color).</p><p>Three groups of twelve LED boards (3 × 12 = 36, four were not used) receive power and LED control signals from a control breakout board, which hosts the microcontroller (Arduino Mega 2560). These boards receive and distribute power from an external power supply unit (Corsair CSM 550W 80 + Gold Certified Semi-Modular ATX) through SATA power cables, allocating a maximum of 3.3 V to both amber and blue LEDs and of 5 V to both red and green LEDs. The microcontroller sends activation signals of 5 V to the correct transistor to be activated based on the information from serial communication with the computer. To alter the LED brightness, we used the Voltage dial of a switch mode bench power supply (Circuit Specialists CSI3060) to set the voltage applied to the LED.</p><p>All PCB designs can be found on the following GitHub repository: <ext-link ext-link-type="uri" xlink:href="https://github.com/ribeiro-lab/optoPAD-hardware">https://github.com/ribeiro-lab/optoPAD-hardware</ext-link> (<xref ref-type="bibr" rid="bib14">Goldschmidt, 2019b</xref>; copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/optoPAD-hardware">https://github.com/elifesciences-publications/optoPAD-hardware</ext-link>).</p></sec><sec id="s4-3"><title>Real-time detection of food interactions and LED activation</title><p>The detection of food interactions in real time as well as the closed-loop control of LED illumination was performed using a custom-written Bonsai workflow (<xref ref-type="bibr" rid="bib21">Lopes et al., 2015</xref>). This visual programming framework allows for real-time analysis of the flyPAD capacitance data sampled at 100 Hz and is capable of online communication with actuators for closed-loop experiments.</p><p>Unlike the data processing described in <xref ref-type="bibr" rid="bib15">Itskov et al. (2014)</xref>, the optoPAD system detects when the fly interacts with a food source in real time. To do so, the Bonsai workflow continuously takes the absolute difference of two consecutive samples and applies a finite impulse response (FIR) filter with a running window of 50 samples. The filtered signal is finally thresholded with a value of 120 (a.u.), resulting in a binary signal representing if activity bouts were detected (<xref ref-type="fig" rid="fig1">Figure 1C</xref>). We chose the values for the running window size and threshold based on optimizing the accuracy of the activity bout detection using the output of the offline detection algorithm as a standard (<xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>).</p><p>The protocol for LED activation implemented in Bonsai is a series of conditional nodes that can be programmed to perform flexible experiments.</p><p>Through this Bonsai workflow, each experiment can be programmed to run with the same protocol for as long as the user desires. The protocol used to control LED activation can be programmed independently for each flyPAD capacitance channel. Every time the fly starts interacting with food, a trial is initiated. From there, two possible behavioral outcomes are possible: 1. the fly stops interacting with food before the set ‘delay’ period (such activity bouts are classified as short trials, with no LED activation); 2. the fly keeps eating for longer than the ‘delay’ period. When the latter occurs, and depending on the experimental design, LED activation may or may not occur. This feature is dependent on the setting of the ‘probability of stimulation’ value. Bonsai pseudo-randomly samples a real number between 0 and 1 from a uniform distribution and compares it to a given previously defined probability. If this number is less or equal than the defined probability, the fly receives light stimulation for a period of time that is set by the user prior to the experiment. Else no stimulation occurs and the trial is considered a ‘catch-trial’, which only terminates when the fly stops interacting with the food at the end of the activity bout. Upon termination of light stimulation, the protocol is restarted, and the system will wait for the fly to start interacting with food again (if the fly continues to interact with food during the light stimulation, the ongoing activity bout is considered a new activity bout). Additionally, the user can define how many stimulations will occur on each channel.</p><p>For dynamic virtual taste environment experiments (<xref ref-type="fig" rid="fig4">Figure 4A and B</xref>), in which the channel controlling LED activation is changed every five minutes, a timer was added to the Bonsai workflow, which after a set time instructs the software to change the experimental parameters by reading from another configuration file.</p><p>Software can be found on the following GitHub repository: <ext-link ext-link-type="uri" xlink:href="https://github.com/ribeiro-lab/optoPAD-software">https://github.com/ribeiro-lab/optoPAD-software</ext-link> (<xref ref-type="bibr" rid="bib13">Goldschmidt, 2019a</xref>; copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/optoPAD-software">https://github.com/elifesciences-publications/optoPAD-software</ext-link>).</p></sec><sec id="s4-4"><title>Irradiance measurements</title><p>We performed the irradiance measurements shown in <xref ref-type="fig" rid="fig2">Figure 2A</xref> using an optical power meter (Thorlabs PM100D) and a standard photodiode power sensor (Thorlabs S121C). In order to accurately measure how much irradiance reaches the fly upon LED illumination, we placed the sensor at the same distance from the LED as the arena. We varied the voltage applied to the LED between 1.5 and 5 V in 0.5 V steps, and measured the peak value of power on the optical power meter upon LED illumination. Measurements were started at 1.5 V as no measurable optical power was detected below this voltage. We carried out each measurement three times. The irradiance was computed by dividing the optical power measurements by the effective sensor area (14.923 mm<sup>2</sup>).</p></sec><sec id="s4-5"><title>Behavioral experiments</title><p>Behavioral experiments were performed at 25°C, 70% RH. We used flies expressing either GtACR1 (<xref ref-type="bibr" rid="bib27">Mohammad et al., 2017</xref>) or CsChrimson (<xref ref-type="bibr" rid="bib18">Klapoetke et al., 2014</xref>) in subsets of gustatory neurons. The genotypes of the lines used in the manuscript are listed in the key resources table. optoPAD assays were performed following a protocol previously described (<xref ref-type="bibr" rid="bib15">Itskov et al., 2014</xref>). Briefly, both wells of the optoPAD were filled with solutions containing different concentrations of sucrose (<xref ref-type="fig" rid="fig2">Figures 2B</xref> and <xref ref-type="fig" rid="fig3">3A</xref>: 5 mM; <xref ref-type="fig" rid="fig3">Figure 3B</xref>: 20 mM; <xref ref-type="fig" rid="fig3">Figure 3C</xref>: 100 mM; <xref ref-type="fig" rid="fig3">Figure 3D</xref>: 50 mM +10 mM quinine) or 10% yeast solution (<xref ref-type="fig" rid="fig2">Figures 2C</xref> and <xref ref-type="fig" rid="fig4">4</xref>). All solutions were in 1% agarose. Single flies were transferred to optoPAD arenas by mouth aspiration and allowed to feed for 1 hr in a light shielded box.</p><p>To test how different light intensities affect feeding behavior (<xref ref-type="fig" rid="fig2">Figure 2B and C</xref>), red (625 nm) LED activation was set to occur 0 s after the initiation of each activity bout for the experiment shown in <xref ref-type="fig" rid="fig2">Figure 2B</xref> and green (523 nm) LED activation was set to occur 0.5 s after each bout initiation for <xref ref-type="fig" rid="fig2">Figure 2C</xref>. For both experiments, light stimulation was sustained for 1.5 s independent of the flies’ behavior. Based on the dose-response curves in <xref ref-type="fig" rid="fig2">Figure 2</xref>, we chose to use 3.5 V for the green LED and 2.25 V for the red LED for the experiments in <xref ref-type="fig" rid="fig3">Figure 3</xref>.</p><p>For the experiments aiming at inducing and repressing aversive and appetitive behaviors (<xref ref-type="fig" rid="fig3">Figure 3</xref>), LED activation was set to occur 0.01 s (<xref ref-type="fig" rid="fig3">Figure 3A</xref>), 0 s (<xref ref-type="fig" rid="fig3">Figure 3B</xref>), and 0.5 s (<xref ref-type="fig" rid="fig3">Figure 3C and D</xref>) after an activity bout was detected in the light-triggering channel. In <xref ref-type="fig" rid="fig3">Figure 3A and C</xref> the red LED was used and in <xref ref-type="fig" rid="fig3">Figure 3B and D</xref> the green LED was used. Light stimulation was sustained for 1.5 s independent of the behavior of the fly.</p><p>For the dynamic virtual taste environment experiment (<xref ref-type="fig" rid="fig4">Figure 4A and B</xref>), red LED activation was set to occur 0.5 s after the initiation of each activity bout in the light-triggering channel (channel 1 or two depending on the experimental block), and the light activation was sustained for 2 s independently of the activity of the fly. For the ‘control’ channel, interactions of the fly with the food did not trigger any LED activation.</p><p>For the experiments testing the flies’ behavioral response to activation of bitter-sensing neurons following a delay in relation to the initiation of the activity bout (<xref ref-type="fig" rid="fig4">Figure 4C–H</xref>), the red LED was set to occur 1.5, 3 or 6 s after an activity bout was detected in 90% of the trials on both food sources. Light stimulation was sustained for 2 s. A new trial was initiated when a new interaction with food was detected. The 10% of trials with no LED activation were terminated at the end of the respective activity bout.</p></sec><sec id="s4-6"><title>Statistics</title><p>Results of optoPAD experiments were compared using the Kruskal-Wallis test, followed by Dunn’s multiple comparison test when more than two groups were compared or Wilcoxon rank-sum test, followed by Bonferroni correction when multiple comparisons were made. All tests were two-tailed.</p></sec></sec></body><back><ack id="ack"><title>Acknowledgements</title><p>We thank Gwyneth Card, Richard Benton, and Adam Claridge-Chang for providing fly strains. Lines obtained from the Bloomington Drosophila Stock Center (NIH P40OD018537) were used in this study. We thank Gonçalo Lopes, João Frazão, Niccolò Bonacchi, Filipe Carvalho and Artur Silva for help in software and hardware design. We thank Daniel Münch, and all members of the Behavior and Metabolism laboratory for helpful discussions and comments on the manuscript. This project was supported by the Portuguese Foundation for Science and Technology (FCT) postdoctoral fellowship SFRH/BPD/79325/2011 to PMI and doctoral fellowship PD/BD/114273/2016 to DG; the Human Frontier Science Program Project Grant RGP0022/2012; the BIAL Foundation Grants (283/14 and 279/16). Research at the Centre for the Unknown is supported by the Champalimaud Foundation.</p></ack><sec id="s5" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="COI-statement" id="conf1"><p>No competing interests declared</p></fn><fn fn-type="COI-statement" id="conf2"><p>has a commercial interest in the flyPAD open-source technology.</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>Resources, Data curation, Software, Formal analysis, Validation, Investigation, Visualization, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con2"><p>Conceptualization, Resources, Data curation, Software, Formal analysis, Supervision, Visualization, Methodology, Writing—original draft, Writing—review and editing</p></fn><fn fn-type="con" id="con3"><p>Conceptualization, Data curation, Software, Formal analysis, Validation, Investigation, Visualization, Methodology, Writing—original draft, Project administration, Writing—review and editing, Supervision</p></fn><fn fn-type="con" id="con4"><p>Validation, Investigation, Writing—review and editing</p></fn><fn fn-type="con" id="con5"><p>Data curation, Formal analysis, Validation, Investigation, Visualization, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con6"><p>Formal analysis, Validation, Investigation, Writing—review and editing, Supervision</p></fn><fn fn-type="con" id="con7"><p>Formal analysis, Validation, Investigation, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con8"><p>Conceptualization, Formal analysis, Supervision, Funding acquisition, Visualization, Methodology, Writing—original draft, Project administration, Writing—review and editing</p></fn></fn-group></sec><sec id="s6" sec-type="supplementary-material"><title>Additional files</title><supplementary-material id="transrepform"><object-id pub-id-type="doi">10.7554/eLife.43924.029</object-id><label>Transparent reporting form</label><media mime-subtype="pdf" mimetype="application" xlink:href="elife-43924-transrepform-v1.pdf"/></supplementary-material></sec><sec id="s7" sec-type="data-availability"><title>Data availability</title><p>Data used to generate the plots in the figures are included in the manuscript and supporting files. The optoPAD hardware designs and software are made available on GitHub at <ext-link ext-link-type="uri" xlink:href="https://github.com/ribeiro-lab/optoPAD-hardware">https://github.com/ribeiro-lab/optoPAD-hardware</ext-link> and <ext-link ext-link-type="uri" xlink:href="https://github.com/ribeiro-lab/optoPAD-software">https://github.com/ribeiro-lab/optoPAD-software</ext-link>, respectively. Copies have been archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/optoPAD-hardware">https://github.com/elifesciences-publications/optoPAD-hardware</ext-link> and <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/optoPAD-software">https://github.com/elifesciences-publications/optoPAD-software</ext-link>.</p></sec><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Anderson</surname> <given-names>DJ</given-names></name><name><surname>Perona</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Toward a science of computational ethology</article-title><source>Neuron</source><volume>84</volume><fpage>18</fpage><lpage>31</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2014.09.005</pub-id><pub-id pub-id-type="pmid">25277452</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Branson</surname> <given-names>K</given-names></name><name><surname>Robie</surname> <given-names>AA</given-names></name><name><surname>Bender</surname> <given-names>J</given-names></name><name><surname>Perona</surname> <given-names>P</given-names></name><name><surname>Dickinson</surname> <given-names>MH</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>High-throughput ethomics in large groups of Drosophila</article-title><source>Nature Methods</source><volume>6</volume><fpage>451</fpage><lpage>457</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1328</pub-id><pub-id pub-id-type="pmid">19412169</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Brown</surname> <given-names>AEX</given-names></name><name><surname>de Bivort</surname> <given-names>B</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Ethology as a physical science</article-title><source>Nature Physics</source><volume>14</volume><fpage>653</fpage><lpage>657</lpage><pub-id pub-id-type="doi">10.1038/s41567-018-0093-0</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Calhoun</surname> <given-names>AJ</given-names></name><name><surname>Murthy</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Quantifying behavior to solve sensorimotor transformations: advances from worms and flies</article-title><source>Current Opinion in Neurobiology</source><volume>46</volume><fpage>90</fpage><lpage>98</lpage><pub-id pub-id-type="doi">10.1016/j.conb.2017.08.006</pub-id><pub-id pub-id-type="pmid">28850885</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Carvalho-Santos</surname> <given-names>Z</given-names></name><name><surname>Ribeiro</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Gonadal ecdysone titers are modulated by protein availability but do not impact protein appetite</article-title><source>Journal of Insect Physiology</source><volume>106</volume><fpage>30</fpage><lpage>35</lpage><pub-id pub-id-type="doi">10.1016/j.jinsphys.2017.08.006</pub-id><pub-id pub-id-type="pmid">28842196</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chittka</surname> <given-names>L</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Bee cognition</article-title><source>Current Biology</source><volume>27</volume><fpage>R1049</fpage><lpage>R1053</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2017.08.008</pub-id><pub-id pub-id-type="pmid">29017035</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Corrales-Carvajal</surname> <given-names>VM</given-names></name><name><surname>Faisal</surname> <given-names>AA</given-names></name><name><surname>Ribeiro</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Internal states drive nutrient homeostasis by modulating exploration-exploitation trade-off</article-title><source>eLife</source><volume>5</volume><elocation-id>e19920</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.19920</pub-id><pub-id pub-id-type="pmid">27770569</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Davis</surname> <given-names>JD</given-names></name></person-group><year iso-8601-date="1973">1973</year><article-title>The effectiveness of some sugars in stimulating licking behavior in the rat</article-title><source>Physiology &amp; Behavior</source><volume>11</volume><fpage>39</fpage><lpage>45</lpage><pub-id pub-id-type="doi">10.1016/0031-9384(73)90120-0</pub-id><pub-id pub-id-type="pmid">4732426</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Dethier</surname> <given-names>VG</given-names></name></person-group><year iso-8601-date="1976">1976</year><source>The Hungry Fly: A Physiological Study of the Behavior Associated with Feeding</source><publisher-loc>Oxford, England</publisher-loc><publisher-name>Harvard University Press</publisher-name></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Egnor</surname> <given-names>SE</given-names></name><name><surname>Branson</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Computational analysis of behavior</article-title><source>Annual Review of Neuroscience</source><volume>39</volume><fpage>217</fpage><lpage>236</lpage><pub-id pub-id-type="doi">10.1146/annurev-neuro-070815-013845</pub-id><pub-id pub-id-type="pmid">27090952</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fiorillo</surname> <given-names>CD</given-names></name><name><surname>Tobler</surname> <given-names>PN</given-names></name><name><surname>Schultz</surname> <given-names>W</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Discrete coding of reward probability and uncertainty by dopamine neurons</article-title><source>Science</source><volume>299</volume><fpage>1898</fpage><lpage>1902</lpage><pub-id pub-id-type="doi">10.1126/science.1077349</pub-id><pub-id pub-id-type="pmid">12649484</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Glimcher</surname> <given-names>PW</given-names></name><name><surname>Fehr</surname> <given-names>E</given-names></name></person-group><year iso-8601-date="2013">2013</year><source>Neuroeconomics: Decision Making and the Brain</source><edition>2nd ed</edition><publisher-loc>Amsterdam : Boston</publisher-loc><publisher-name>Academic Press</publisher-name></element-citation></ref><ref id="bib13"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Goldschmidt</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2019">2019a</year><data-title>optoPAD-software</data-title><source>GitHub</source><version designator="94c5b72">94c5b72</version><ext-link ext-link-type="uri" xlink:href="https://github.com/ribeiro-lab/optoPAD-software">https://github.com/ribeiro-lab/optoPAD-software</ext-link></element-citation></ref><ref id="bib14"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Goldschmidt</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2019">2019b</year><data-title>optoPAD-hardware</data-title><source>GitHub</source><version designator="94c5b72">94c5b72</version><ext-link ext-link-type="uri" xlink:href="https://github.com/ribeiro-lab/optoPAD-hardware">https://github.com/ribeiro-lab/optoPAD-hardware</ext-link></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Itskov</surname> <given-names>PM</given-names></name><name><surname>Moreira</surname> <given-names>JM</given-names></name><name><surname>Vinnik</surname> <given-names>E</given-names></name><name><surname>Lopes</surname> <given-names>G</given-names></name><name><surname>Safarik</surname> <given-names>S</given-names></name><name><surname>Dickinson</surname> <given-names>MH</given-names></name><name><surname>Ribeiro</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Automated monitoring and quantitative analysis of feeding behaviour in <italic>Drosophila</italic></article-title><source>Nature Communications</source><volume>5</volume><elocation-id>4560</elocation-id><pub-id pub-id-type="doi">10.1038/ncomms5560</pub-id><pub-id pub-id-type="pmid">25087594</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jaeger</surname> <given-names>AH</given-names></name><name><surname>Stanley</surname> <given-names>M</given-names></name><name><surname>Weiss</surname> <given-names>ZF</given-names></name><name><surname>Musso</surname> <given-names>PY</given-names></name><name><surname>Chan</surname> <given-names>RC</given-names></name><name><surname>Zhang</surname> <given-names>H</given-names></name><name><surname>Feldman-Kiss</surname> <given-names>D</given-names></name><name><surname>Gordon</surname> <given-names>MD</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>A complex peripheral code for salt taste in <italic>Drosophila</italic></article-title><source>eLife</source><volume>7</volume><elocation-id>e37167</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.37167</pub-id><pub-id pub-id-type="pmid">30307393</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jiao</surname> <given-names>Y</given-names></name><name><surname>Moon</surname> <given-names>SJ</given-names></name><name><surname>Wang</surname> <given-names>X</given-names></name><name><surname>Ren</surname> <given-names>Q</given-names></name><name><surname>Montell</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Gr64f is required in combination with other gustatory receptors for sugar detection in Drosophila</article-title><source>Current Biology</source><volume>18</volume><fpage>1797</fpage><lpage>1801</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2008.10.009</pub-id><pub-id pub-id-type="pmid">19026541</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Klapoetke</surname> <given-names>NC</given-names></name><name><surname>Murata</surname> <given-names>Y</given-names></name><name><surname>Kim</surname> <given-names>SS</given-names></name><name><surname>Pulver</surname> <given-names>SR</given-names></name><name><surname>Birdsey-Benson</surname> <given-names>A</given-names></name><name><surname>Cho</surname> <given-names>YK</given-names></name><name><surname>Morimoto</surname> <given-names>TK</given-names></name><name><surname>Chuong</surname> <given-names>AS</given-names></name><name><surname>Carpenter</surname> <given-names>EJ</given-names></name><name><surname>Tian</surname> <given-names>Z</given-names></name><name><surname>Wang</surname> <given-names>J</given-names></name><name><surname>Xie</surname> <given-names>Y</given-names></name><name><surname>Yan</surname> <given-names>Z</given-names></name><name><surname>Zhang</surname> <given-names>Y</given-names></name><name><surname>Chow</surname> <given-names>BY</given-names></name><name><surname>Surek</surname> <given-names>B</given-names></name><name><surname>Melkonian</surname> <given-names>M</given-names></name><name><surname>Jayaraman</surname> <given-names>V</given-names></name><name><surname>Constantine-Paton</surname> <given-names>M</given-names></name><name><surname>Wong</surname> <given-names>GK</given-names></name><name><surname>Boyden</surname> <given-names>ES</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Independent optical excitation of distinct neural populations</article-title><source>Nature Methods</source><volume>11</volume><fpage>338</fpage><lpage>346</lpage><pub-id pub-id-type="doi">10.1038/nmeth.2836</pub-id><pub-id pub-id-type="pmid">24509633</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lak</surname> <given-names>A</given-names></name><name><surname>Costa</surname> <given-names>GM</given-names></name><name><surname>Romberg</surname> <given-names>E</given-names></name><name><surname>Koulakov</surname> <given-names>AA</given-names></name><name><surname>Mainen</surname> <given-names>ZF</given-names></name><name><surname>Kepecs</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Orbitofrontal cortex is required for optimal waiting based on decision confidence</article-title><source>Neuron</source><volume>84</volume><fpage>190</fpage><lpage>201</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2014.08.039</pub-id><pub-id pub-id-type="pmid">25242219</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Leitão-Gonçalves</surname> <given-names>R</given-names></name><name><surname>Carvalho-Santos</surname> <given-names>Z</given-names></name><name><surname>Francisco</surname> <given-names>AP</given-names></name><name><surname>Fioreze</surname> <given-names>GT</given-names></name><name><surname>Anjos</surname> <given-names>M</given-names></name><name><surname>Baltazar</surname> <given-names>C</given-names></name><name><surname>Elias</surname> <given-names>AP</given-names></name><name><surname>Itskov</surname> <given-names>PM</given-names></name><name><surname>Piper</surname> <given-names>MDW</given-names></name><name><surname>Ribeiro</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Commensal bacteria and essential amino acids control food choice behavior and reproduction</article-title><source>PLOS Biology</source><volume>15</volume><elocation-id>e2000862</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pbio.2000862</pub-id><pub-id pub-id-type="pmid">28441450</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lopes</surname> <given-names>G</given-names></name><name><surname>Bonacchi</surname> <given-names>N</given-names></name><name><surname>Frazão</surname> <given-names>J</given-names></name><name><surname>Neto</surname> <given-names>JP</given-names></name><name><surname>Atallah</surname> <given-names>BV</given-names></name><name><surname>Soares</surname> <given-names>S</given-names></name><name><surname>Moreira</surname> <given-names>L</given-names></name><name><surname>Matias</surname> <given-names>S</given-names></name><name><surname>Itskov</surname> <given-names>PM</given-names></name><name><surname>Correia</surname> <given-names>PA</given-names></name><name><surname>Medina</surname> <given-names>RE</given-names></name><name><surname>Calcaterra</surname> <given-names>L</given-names></name><name><surname>Dreosti</surname> <given-names>E</given-names></name><name><surname>Paton</surname> <given-names>JJ</given-names></name><name><surname>Kampff</surname> <given-names>AR</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Bonsai: an event-based framework for processing and controlling data streams</article-title><source>Frontiers in Neuroinformatics</source><volume>9</volume><elocation-id>7</elocation-id><pub-id pub-id-type="doi">10.3389/fninf.2015.00007</pub-id><pub-id pub-id-type="pmid">25904861</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lottem</surname> <given-names>E</given-names></name><name><surname>Banerjee</surname> <given-names>D</given-names></name><name><surname>Vertechi</surname> <given-names>P</given-names></name><name><surname>Sarra</surname> <given-names>D</given-names></name><name><surname>Lohuis</surname> <given-names>MO</given-names></name><name><surname>Mainen</surname> <given-names>ZF</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Activation of serotonin neurons promotes active persistence in a probabilistic foraging task</article-title><source>Nature Communications</source><volume>9</volume><elocation-id>1000</elocation-id><pub-id pub-id-type="doi">10.1038/s41467-018-03438-y</pub-id><pub-id pub-id-type="pmid">29520000</pub-id></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luo</surname> <given-names>L</given-names></name><name><surname>Callaway</surname> <given-names>EM</given-names></name><name><surname>Svoboda</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Genetic dissection of neural circuits: a decade of progress</article-title><source>Neuron</source><volume>98</volume><fpage>256</fpage><lpage>281</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2018.03.040</pub-id><pub-id pub-id-type="pmid">29673479</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Marella</surname> <given-names>S</given-names></name><name><surname>Fischler</surname> <given-names>W</given-names></name><name><surname>Kong</surname> <given-names>P</given-names></name><name><surname>Asgarian</surname> <given-names>S</given-names></name><name><surname>Rueckert</surname> <given-names>E</given-names></name><name><surname>Scott</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>Imaging taste responses in the fly brain reveals a functional map of taste category and behavior</article-title><source>Neuron</source><volume>49</volume><fpage>285</fpage><lpage>295</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2005.11.037</pub-id><pub-id pub-id-type="pmid">16423701</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mathis</surname> <given-names>A</given-names></name><name><surname>Mamidanna</surname> <given-names>P</given-names></name><name><surname>Cury</surname> <given-names>KM</given-names></name><name><surname>Abe</surname> <given-names>T</given-names></name><name><surname>Murthy</surname> <given-names>VN</given-names></name><name><surname>Mathis</surname> <given-names>MW</given-names></name><name><surname>Bethge</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>DeepLabCut: markerless pose estimation of user-defined body parts with deep learning</article-title><source>Nature Neuroscience</source><volume>21</volume><fpage>1281</fpage><lpage>1289</lpage><pub-id pub-id-type="doi">10.1038/s41593-018-0209-y</pub-id><pub-id pub-id-type="pmid">30127430</pub-id></element-citation></ref><ref id="bib26"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McLean</surname> <given-names>DL</given-names></name><name><surname>Kinsey</surname> <given-names>MG</given-names></name></person-group><year iso-8601-date="1964">1964</year><article-title>A technique for electronically recording aphid feeding and salivation</article-title><source>Nature</source><volume>202</volume><fpage>1358</fpage><lpage>1359</lpage><pub-id pub-id-type="doi">10.1038/2021358a0</pub-id></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mohammad</surname> <given-names>F</given-names></name><name><surname>Stewart</surname> <given-names>JC</given-names></name><name><surname>Ott</surname> <given-names>S</given-names></name><name><surname>Chlebikova</surname> <given-names>K</given-names></name><name><surname>Chua</surname> <given-names>JY</given-names></name><name><surname>Koh</surname> <given-names>TW</given-names></name><name><surname>Ho</surname> <given-names>J</given-names></name><name><surname>Claridge-Chang</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Optogenetic inhibition of behavior with anion channelrhodopsins</article-title><source>Nature Methods</source><volume>14</volume><fpage>271</fpage><lpage>274</lpage><pub-id pub-id-type="doi">10.1038/nmeth.4148</pub-id><pub-id pub-id-type="pmid">28114289</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Murphy</surname> <given-names>KR</given-names></name><name><surname>Park</surname> <given-names>JH</given-names></name><name><surname>Huber</surname> <given-names>R</given-names></name><name><surname>Ja</surname> <given-names>WW</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Simultaneous measurement of sleep and feeding in individual Drosophila</article-title><source>Nature Protocols</source><volume>12</volume><fpage>2355</fpage><lpage>2359</lpage><pub-id pub-id-type="doi">10.1038/nprot.2017.096</pub-id><pub-id pub-id-type="pmid">29022943</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Namiki</surname> <given-names>S</given-names></name><name><surname>Dickinson</surname> <given-names>MH</given-names></name><name><surname>Wong</surname> <given-names>AM</given-names></name><name><surname>Korff</surname> <given-names>W</given-names></name><name><surname>Card</surname> <given-names>GM</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>The functional organization of descending sensory-motor pathways in <italic>Drosophila</italic></article-title><source>eLife</source><volume>7</volume><elocation-id>e34272</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.34272</pub-id><pub-id pub-id-type="pmid">29943730</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ribeiro</surname> <given-names>C</given-names></name><name><surname>Dickson</surname> <given-names>BJ</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Sex peptide receptor and neuronal TOR/S6K signaling modulate nutrient balancing in Drosophila</article-title><source>Current Biology</source><volume>20</volume><fpage>1000</fpage><lpage>1005</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2010.03.061</pub-id><pub-id pub-id-type="pmid">20471268</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ro</surname> <given-names>J</given-names></name><name><surname>Harvanek</surname> <given-names>ZM</given-names></name><name><surname>Pletcher</surname> <given-names>SD</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>FLIC: high-throughput, continuous analysis of feeding behaviors in Drosophila</article-title><source>PLOS ONE</source><volume>9</volume><elocation-id>e101107</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0101107</pub-id><pub-id pub-id-type="pmid">24978054</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Scott</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Gustatory processing in Drosophila melanogaster</article-title><source>Annual Review of Entomology</source><volume>63</volume><fpage>15</fpage><lpage>30</lpage><pub-id pub-id-type="doi">10.1146/annurev-ento-020117-043331</pub-id><pub-id pub-id-type="pmid">29324046</pub-id></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Steck</surname> <given-names>K</given-names></name><name><surname>Walker</surname> <given-names>SJ</given-names></name><name><surname>Itskov</surname> <given-names>PM</given-names></name><name><surname>Baltazar</surname> <given-names>C</given-names></name><name><surname>Moreira</surname> <given-names>JM</given-names></name><name><surname>Ribeiro</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Internal amino acid state modulates yeast taste neurons to support protein homeostasis in <italic>Drosophila</italic></article-title><source>eLife</source><volume>7</volume><elocation-id>e31625</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.31625</pub-id><pub-id pub-id-type="pmid">29393045</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Thorne</surname> <given-names>N</given-names></name><name><surname>Chromey</surname> <given-names>C</given-names></name><name><surname>Bray</surname> <given-names>S</given-names></name><name><surname>Amrein</surname> <given-names>H</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>Taste perception and coding in Drosophila</article-title><source>Current Biology</source><volume>14</volume><fpage>1065</fpage><lpage>1079</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2004.05.019</pub-id><pub-id pub-id-type="pmid">15202999</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Walker</surname> <given-names>SJ</given-names></name><name><surname>Corrales-Carvajal</surname> <given-names>VM</given-names></name><name><surname>Ribeiro</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Postmating Circuitry Modulates Salt Taste Processing to Increase Reproductive Output in Drosophila</article-title><source>Current Biology</source><volume>25</volume><fpage>2621</fpage><lpage>2630</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2015.08.043</pub-id><pub-id pub-id-type="pmid">26412135</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wiltschko</surname> <given-names>AB</given-names></name><name><surname>Johnson</surname> <given-names>MJ</given-names></name><name><surname>Iurilli</surname> <given-names>G</given-names></name><name><surname>Peterson</surname> <given-names>RE</given-names></name><name><surname>Katon</surname> <given-names>JM</given-names></name><name><surname>Pashkovski</surname> <given-names>SL</given-names></name><name><surname>Abraira</surname> <given-names>VE</given-names></name><name><surname>Adams</surname> <given-names>RP</given-names></name><name><surname>Datta</surname> <given-names>SR</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Mapping Sub-Second Structure in Mouse Behavior</article-title><source>Neuron</source><volume>88</volume><fpage>1121</fpage><lpage>1135</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2015.11.031</pub-id><pub-id pub-id-type="pmid">26687221</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yapici</surname> <given-names>N</given-names></name><name><surname>Cohn</surname> <given-names>R</given-names></name><name><surname>Schusterreiter</surname> <given-names>C</given-names></name><name><surname>Ruta</surname> <given-names>V</given-names></name><name><surname>Vosshall</surname> <given-names>LB</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>A taste circuit that regulates ingestion by integrating food and hunger signals</article-title><source>Cell</source><volume>165</volume><fpage>715</fpage><lpage>729</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2016.02.061</pub-id><pub-id pub-id-type="pmid">27040496</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yarmolinsky</surname> <given-names>DA</given-names></name><name><surname>Zuker</surname> <given-names>CS</given-names></name><name><surname>Ryba</surname> <given-names>NJ</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Common sense about taste: from mammals to insects</article-title><source>Cell</source><volume>139</volume><fpage>234</fpage><lpage>244</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2009.10.001</pub-id><pub-id pub-id-type="pmid">19837029</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname> <given-names>W</given-names></name><name><surname>Ge</surname> <given-names>W</given-names></name><name><surname>Wang</surname> <given-names>Z</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>A toolbox for light control of Drosophila behaviors through channelrhodopsin 2-mediated photoactivation of targeted neurons</article-title><source>European Journal of Neuroscience</source><volume>26</volume><fpage>2405</fpage><lpage>2416</lpage><pub-id pub-id-type="doi">10.1111/j.1460-9568.2007.05862.x</pub-id><pub-id pub-id-type="pmid">17970730</pub-id></element-citation></ref></ref-list></back><sub-article article-type="decision-letter" id="SA1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.43924.031</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group><contrib contrib-type="editor"><name><surname>Ramaswami</surname><given-names>Mani</given-names></name><role>Reviewing Editor</role><aff><institution>Trinity College Dublin</institution><country>Ireland</country></aff></contrib></contrib-group></front-stub><body><boxed-text><p>In the interests of transparency, eLife includes the editorial decision letter and accompanying author responses. A lightly edited version of the letter sent to the authors after peer review is shown, indicating the most substantive concerns; minor comments are not usually included.</p></boxed-text><p>Thank you for submitting your article &quot;optoPAD: a closed-loop optogenetics system to study the circuit basis of feeding behaviors&quot; for consideration by <italic>eLife</italic>. Your article has been reviewed by K VijayRaghavan as the Senior Editor, Mani Ramaswami as the Reviewing Editor, and three reviewers. The reviewers have opted to remain anonymous.</p><p>The reviewers have discussed the reviews with one another and the Reviewing Editor has drafted this decision to help you prepare a revised submission.</p><p>Summary:</p><p>The authors recently published a paper describing the use of an automated food choice assay flyPAD to study yeast taste neurons and their effects on yeast feeding. The current manuscript serves as a technical follow-up in which Moreira et al. develop and validate a closed-loop optogenetics system, optoPAD, built on top of the previously described flyPAD. OptoPAD produces light stimulation time-locked to the feeding onset detected by flyPAD, allowing for temporally precise and dynamic manipulation of targeted neuron populations. Using Bonsai data stream processing, they first extract active periods when fly is interacting with the food source. This information is then used to control high power LEDs in different wavelengths at precise time points and durations to optogenetically activate specific classes of neurons. The authors demonstrate the efficacy of their system by stimulating sugar feeding by activating sugar taste neurons or reducing yeast feeding by inhibiting taste peg neurons. Next, they also perform a dynamic task to change the acceptance of a food source in a two-choice assay by pairing one source with bitter taste neuron activation. These experiments show that close loop optoPAD system can change the value of a food source in real time by means of optogenetic activation of the avoidance pathways in the periphery. Thus, this system is shown to be useful and effective in creating virtual taste realities while individual flies are freely feeding on a define food medium. Overall, the work establishes that optoPAD system has a potential to contribute to the understanding of sensory responses and reinforcement learning in flies.</p><p>In general, the manuscript is well organized and clearly explained. However, the authors do not fully exploit the system to demonstrate its potential utility for a broad range of <italic>Drosophila</italic> applications that would greatly expand the interest and impact of this paper.</p><p>Essential revisions:</p><p>To be acceptable for publication, the manuscript must be revised with new data to: (a) show that optoPAD's utility is not limited to peripheral neurons and that can be useful for identifying/manipulating central neurons, and (b) include options that allow optoPAD to be flexible enough to allow optogenetic stimulations at times other than the onset of feeding.</p><p>1) In Figure 1, authors describe the real-time detection of food interactions in flyPAD. What is the false positive and false negative rate of this real-time data analysis? How reliable is the thresholding to detect food interactions? It would be good to show confidence rates of the system by annotating files by a human observer and comparing it with the machine annotations.</p><p>2) Authors measure the latency of the optoPAD to trigger the LED illumination and found this delay is 50-120ms. Could they mention why the delay has a 70ms range? What causes the variability? They also mention average sip duration is 130ms. Would this mean if the bout length is lower than 50-120ms, there will be a chance LED would not be activated before the sip ends? How would this impact fly's behavior? Although 10ms delay probably would not directly impact behavior, it may influence the action potentials in neurons that regulate the behavior in time periods smaller than 10ms. Could authors discuss these possibilities in their Discussion rather than claiming the delay will not impact behavior without actually testing it?</p><p>3) All of the transgenic fly strains tested in the optoPAD experiments mainly label taste sensory neurons that stimulate or inhibit feeding. Does optoPAD work for central feeding circuits to modulate feeding behavior? Testing activation of NPF or sNPF neurons that are shown to regulate food responses can demonstrate functionality of this system in neurons of the central nervous system rather than periphery. Would optoPAD work with a restricted driver that label few neurons? What are the limits of this system?</p><p>4) On the same lines, a potential advantage of the optoPAD system is to allow the design of operant conditioning experiments to study &quot;pleasure circuits&quot;, which is challenging in flies. To do this, it would be ideal to be able to trigger optogenetic stimulation in response to touching the food or licking the food. It has previously been shown that activation of NPF neurons is in itself rewarding (Shohat-Ophir et al., 2012). Thus, it would be interesting to test whether manipulating NPF neuron activity can support operant conditioning paradigms using the optoPAD system.</p><p>5) In addition to showing that the system can modulate central neurons, can the authors determine if the system is suited for the dynamic regulation of more complex neural modules that control the microstructures of fly feeding responses to various food?</p><p>6) In Figure 4, authors try an elegant experiment to change the value of a food source by activating bitter taste neurons in a two-choice assay. They see no difference between two sides in the first 10 minutes of the experiment even though one side is paired with punishment (bitter neuron activation). Can authors explain the 10-minute delay in the results further? In this period of time are the flies interacting with the food at all?</p><p>7) To expand the versatility of optoPAD, it would be useful to add an &quot;open-loop&quot; mode in the setup, where light stimulation can be controlled at will and does not need to follow feeding onset. This will allow users to take full advantage of the high temporal resolution of both flyPAD and optogenetics to study feeding related modalities before ingestion happens, such as tasting and feeding initiation.</p><p>8) To allow for more diverse experimental designs, it would be useful if one could choose to deliver the stimulations at the end of a feeding bout. For example, a researcher might be particularly interested in the inter-meal interval. In this case, stimulation placed at the end of an activity bout will help to evaluate whether circuit manipulation affects the latency to start next feeding bout since the cessation of the last one.</p><p>9) It would also be useful to be able to control the number of optogenetic stimuli delivered to the fly, for example, if one wanted to have a maximum number of activations for the targeted neural circuit.</p></body></sub-article><sub-article article-type="reply" id="SA2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.43924.032</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><disp-quote content-type="editor-comment"><p>Essential revisions:</p><p>To be acceptable for publication, the manuscript must be revised with new data to: (a) show that optoPAD's utility is not limited to peripheral neurons and that can be useful for identifying/ manipulating central neurons, and (b) include options that allow optoPAD to be flexible enough to allow optogenetic stimulations at times other than the onset of feeding.</p></disp-quote><p>We have significantly expanded the software used to control the contingency of the optogenetic activation and added new experiments showing that we can manipulate central neurons. We describe in detail how we addressed these requested revisions in our point by point answer to the reviewers. But we would like to give an overview of how we addressed these already here.</p><p>Regarding point (a): We now include data in which we use the optoPAD system to manipulate escape neurons leading to alterations in feeding. These are a small set (2) of centrally located neurons deep within the brain of the fly. We chose them as we wanted a set of neurons which are (a) very sparse, (b) very deep within the brain, (c) have a clear behavioral phenotype which can be seen independently from the flyPAD readout, and (d) should lead to a reliable termination of feeding when activated. Indeed, activating these neurons using CsChrimson after the fly initiates feeding led to a strong reduction in feeding behavior on the food source paired with light. These new data clearly show that our system is not limited to inducing changes in feeding behavior upon manipulation of peripheral neurons but can also be used to induce changes in feeding behavior upon optogenetic manipulation of sparse and centrally located neurons.</p><p>Regarding point (b): We have now modified the scripts controlling the light stimulus to significantly expand the conditions upon which the light stimulus can be delivered. More specifically it is now possible to: (i) trigger light activation in an open loop fashion, meaning in a predefined pattern, not contingent on the behavior of the animal; (ii) trigger light activation when the fly stops interacting with the food, and; (iii) we have included a counter which allows the user to predefine the number of times the light stimulus is triggered, therefore limiting the number of stimulations the animal experiences.</p><disp-quote content-type="editor-comment"><p>1) In Figure 1, authors describe the real-time detection of food interactions in flyPAD. What is the false positive and false negative rate of this real-time data analysis? How reliable is the thresholding to detect food interactions? It would be good to show confidence rates of the system by annotating files by a human observer and comparing it with the machine annotations.</p></disp-quote><p>In our paper describing the development of the flyPAD system (Itskov et al., 2014) we performed a thorough comparison of the behavioral classification of feeding behavior by our post-hoc offline algorithms with that of a manual annotator. This comparison allowed us to show that the offline algorithm had very low false positive and false negative rates. As suggested by the reviewer we now tested the reliability of the real-time data analysis performed by the optoPAD system. To do so we compared the performance of the new online algorithm with the previously validated offline algorithm. This analysis revealed that our online algorithm misses to classify 8.5% of capacitance samples as activity bouts (false negatives) and only misclassifies 1.6% of samples as activity bouts (false positives). These data are within the accuracy obtained for similar state-of-the-art methods. We describe the approach and the obtained data in subsection “The optoPAD system” of the revised manuscript.</p><disp-quote content-type="editor-comment"><p>2) Authors measure the latency of the optoPAD to trigger the LED illumination and found this delay is 50-120ms. Could they mention why the delay has a 70ms range? What causes the variability? They also mention average sip duration is 130ms. Would this mean if the bout length is lower than 50-120ms, there will be a chance LED would not be activated before the sip ends? How would this impact fly's behavior? Although 10ms delay probably would not directly impact behavior, it may influence the action potentials in neurons that regulate the behavior in time periods smaller than 10ms. Could authors discuss these possibilities in their Discussion rather than claiming the delay will not impact behavior without actually testing it?</p></disp-quote><p>We were indeed surprised to see that the delay in light activation had a range of 70 ms. We do not know the exact reason for this range. There is however a straight-forward possible explanation when one considers the hardware design of the flyPAD system. As explained in the text the observed range can be easily explained by the size of the buffer of the FPGA. The FPGA receives the data from the capacitance to digital converters and stores them temporarily before sending the data to the computer. When the data which will trigger the light activation reach the FPGA they will be either sent to the computer earlier, if the buffer already contains data, or later, if the buffer is relatively empty. Therefore, the buffer size of the FPGA could explain the observed range in the onset of the LED illumination. Given that the FPGA is not an essential part of the flyPAD design one can imagine designing a special flyPAD version which does not use an FPGA, therefore eliminating this possible source of delay.</p><p>We are sorry that we did not explain well why we think that even if the system has a delay in light onset, this should not lead to the fly feeding without receiving light stimulation. The main argument is that there is a delay between the fly touching the food (onset of an activity bout) and when the fly starts feeding (onset of a feeding burst). As you can see in the plot in Figure 1—figure supplement 1 this delay is quite reproducibly in the 400 ms bin. Therefore if the delay between detection of the activity bout and the light onset is set to 0 ms and if one assumes the worst case scenario in which the light onset is delayed by 120 ms after the detection of the activity bout, then light activation would still occur 280 ms before the animal starts feeding. It is therefore highly unlikely that the delay in the system leads to the fly feeding without experiencing the optogenetic stimulation. Furthermore, given that the timing between onset of feeding and contact with the food is so reproducible, by setting the delay between the detection of the behavior and light onset to 250 ms one can even time the light onset even more precisely to the onset of feeding. This is only possible because the optoPAD allows the user to define the delay between the detection of the activity bout and light onset.</p><disp-quote content-type="editor-comment"><p>3) All of the transgenic fly strains tested in the optoPAD experiments mainly label taste sensory neurons that stimulate or inhibit feeding. Does optoPAD work for central feeding circuits to modulate feeding behavior? Testing activation of NPF or sNPF neurons that are shown to regulate food responses can demonstrate functionality of this system in neurons of the central nervous system rather than periphery. Would optoPAD work with a restricted driver that label few neurons? What are the limits of this system?</p></disp-quote><p>We agree with the reviewers that formally showing that the optoPAD can be used to manipulate centrally located neurons to study their impact on feeding would make an important point. As suggested, we have performed experiments in which we used CsChrimson to stimulate neurons labeled by <italic>NPF-Gal4</italic> and <italic>sNPF-Gal4</italic>. Unfortunately, we could not detect an increase in feeding or other feeding related parameters using <italic>NPF-Gal4</italic>. When using <italic>sNPF-Gal4</italic> we could detect an increase in the time during which the flies interacted with the food, but we could also not observe a clear increase in feeding. Furthermore, the observed change in behavior was not limited to the food source triggering the light stimulation but was also visible on the control food source. This indicates that the simulation of <italic>sNPF</italic> neurons leads to the release of a factor (likely sNPF) which increases the interaction with food over longer time-scales, therefore making the stimulation effect nonspecific to the food source triggering the activation of the neurons. Finally, the effect of stimulation of sNPF neurons was not fully penetrant. We performed the experiment in 4 separate cohorts and failed to see it in one cohort.</p><p>To clearly show that we can induce changes in behavior by manipulating a very small set of centrally located neurons we therefore decided to manipulate the giant fiber neurons in the fly brain, which trigger escape behavior. These are a small set (2) of centrally located neurons deep within the brain of the fly. We chose them as we wanted a set of neurons which are (a) very sparse, (b) very deep within the brain, (c) have a clear behavioral phenotype which can be scored independently from the flyPAD readout, and (d) should lead to a reliable termination of feeding when activated. Indeed, activating these neurons using CsChrimson after the fly initiates feeding led to a strong reduction in feeding behavior on the food source paired with light. We now show these data in Figure 2—figure supplement 2 and discuss them in subsection “Optogenetic gustatory virtual realities”. These new data clearly show that our system is not limited to inducing changes in feeding behavior upon manipulation of peripheral neurons but can also be used to induce changes in feeding behavior upon optogenetic manipulation of sparse and centrally located neurons.</p><disp-quote content-type="editor-comment"><p>4) On the same lines, a potential advantage of the optoPAD system is to allow the design of operant conditioning experiments to study &quot;pleasure circuits&quot;, which is challenging in flies. To do this, it would be ideal to be able to trigger optogenetic stimulation in response to touching the food or licking the food. It has previously been shown that activation of NPF neurons is in itself rewarding (Shohat-Ophir et al., 2012). Thus, it would be interesting to test whether manipulating NPF neuron activity can support operant conditioning paradigms using the optoPAD system.</p></disp-quote><p>We agree with the reviewers that the prospect of performing experiments to study the impact of “pleasure circuits” using operant conditioning experiments is an exciting future avenue of research using the optoPAD. As suggested, we have performed experiments in which we used CsChrimson to stimulate neurons labeled by <italic>NPF-Gal4</italic> and <italic>sNPF-Gal4</italic>. As mentioned above, unfortunately we could not detect an increase in feeding using <italic>NPF-Gal4</italic>. When using <italic>sNPF-Gal4</italic> we could detect an increase in the length during which the flies interacted with the food, but we could also not observe a clear increase in feeding. Furthermore, the observed change in behavior was not limited to the food source triggering light stimulation but was also visible on the control food source. This indicates that the simulation of sNPF neurons leads to changes over longer time scales therefore making the stimulation effect nonspecific to the precise action one would try to reinforce. While we therefore believe that it should be possible to reinforce specific behaviors (especially feeding) using the optoPAD, such experiments will need to be very carefully planned and include many different controls to ensure that it was possible to indeed operantly reinforce a specific behavior. Unfortunately, such experiments will require considerably more time than available to revise the manuscript and would also go beyond the scope of the current manuscript.</p><disp-quote content-type="editor-comment"><p>5) In addition to showing that the system can modulate central neurons, can the authors determine if the system is suited for the dynamic regulation of more complex neural modules that control the microstructures of fly feeding responses to various food?</p></disp-quote><p>We agree with the reviewers that the prospect of modulating neuronal populations controlling specific aspects of the feeding microstructure is a further exciting avenue for the use of the optoPAD system. Given our interest in that topic it was actually a key motivation for its development. Our use of the optoPAD to show that the taste peg neurons specifically control the length of the feeding bursts on yeast is in our opinion a powerful demonstration of this strategy (Steck et al., 2018). Unfortunately, at this stage there are to our knowledge no published central neurons which control specific aspects of the microstructure of feeding to various foods. This precludes us from performing the experiments suggested by the reviewers. We are however currently using the optoPAD system to successfully characterize neurons for feeding microstrucuture-specific phenotypes in ongoing projects in the laboratory.</p><disp-quote content-type="editor-comment"><p>6) In Figure 4, authors try an elegant experiment to change the value of a food source by activating bitter taste neurons in a two-choice assay. They see no difference between two sides in the first 10 minutes of the experiment even though one side is paired with punishment (bitter neuron activation). Can authors explain the 10-minute delay in the results further? In this period of time are the flies interacting with the food at all?</p></disp-quote><p>We agree with the reviewers that this was an intriguing observation. We therefore discussed that in the original version of the manuscript and speculated that this could be due to the flies having to acclimatize to the chamber and not showing a high level of interaction with the food during that time. This is something we had observed earlier using video tracking (Corrales-Carvajal et al., 2016).</p><p>To support this hypothesis we generated a raster plot of the behavior of every fly in the dynamic assay and quantified the average time every fly interacts with food over the whole period of the assay (Figure 4—figure supplement 1). While flies interact with the food during the first two 5-minute blocks, most flies show few and short bouts of interaction. However, importantly in all experimental blocks the flies always interact for longer periods of time with the non-stimulated (not virtual bitter) side of the food. It is also interesting to see that, except for the first block and the fourth block, in the first bin after the inversion the flies interact more with the previously inert food which now however leads to bitter neuron stimulation. Finally, these data indicate that in contrary to what we normally observe when deprived flies eat on yeast, flies undergoing the dynamic protocol hardly interact with the food after 25 minutes indicating that the dynamic feature of the environment “discourages” the flies from continuing to exploit this environment.</p><p>This analysis clearly indicates that the population of flies adapts their feeding preference to the current optogenetic contingency. The reason that the effect in the main figure is not significant for the first two experimental blocks is most likely due to the lack in statistical power to validate these observed effects.</p><disp-quote content-type="editor-comment"><p>7) To expand the versatility of optoPAD, it would be useful to add an &quot;open-loop&quot; mode in the setup, where light stimulation can be controlled at will and does not need to follow feeding onset. This will allow users to take full advantage of the high temporal resolution of both flyPAD and optogenetics to study feeding related modalities before ingestion happens, such as tasting and feeding initiation.</p></disp-quote><p>We thank the reviewer for this suggestion. We now include a script which the optoPAD to run in an “open-loop” mode. We also provide data in which we show that silencing taste-pegs neurons using the “open-loop” mode leads to the decrease in the length of the feeding burst on yeast (Figure 2—figure supplement 1). We describe these experiments in subsection “Optogenetic gustatory virtual realities”.</p><disp-quote content-type="editor-comment"><p>8) To allow for more diverse experimental designs, it would be useful if one could choose to deliver the stimulations at the end of a feeding bout. For example, a researcher might be particularly interested in the inter-meal interval. In this case, stimulation placed at the end of an activity bout will help to evaluate whether circuit manipulation affects the latency to start next feeding bout since the cessation of the last one.</p></disp-quote><p>We thank the reviewers for this suggestion. We have now integrated the ability to deliver the light stimulation after the termination of an activity bout in the newest release of the optoPAD software. We mention this extra capability in the Discussion section.</p><disp-quote content-type="editor-comment"><p>9) It would also be useful to be able to control the number of optogenetic stimuli delivered to the fly, for example, if one wanted to have a maximum number of activations for the targeted neural circuit.</p></disp-quote><p>We thank the reviewers for these suggestions. We have now integrated the requested counter in the newest release of the optoPAD software. We mention this extra capability in the Discussion section.</p></body></sub-article></article>