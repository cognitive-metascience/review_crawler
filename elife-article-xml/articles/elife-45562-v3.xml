<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1 20151215//EN"  "JATS-archivearticle1.dtd"><article article-type="research-article" dtd-version="1.1" xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn pub-type="epub" publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">45562</article-id><article-id pub-id-type="doi">10.7554/eLife.45562</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Research Article</subject></subj-group><subj-group subj-group-type="heading"><subject>Evolutionary Biology</subject></subj-group></article-categories><title-group><article-title>Coupling adaptive molecular evolution to phylodynamics using fitness-dependent birth-death models</article-title></title-group><contrib-group><contrib contrib-type="author" corresp="yes" id="author-30991"><name><surname>Rasmussen</surname><given-names>David A</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0001-9457-7561</contrib-id><email>drasmus@ncsu.edu</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-53628"><name><surname>Stadler</surname><given-names>Tanja</given-names></name><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="aff" rid="aff4">4</xref><xref ref-type="other" rid="fund1"/><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/></contrib><aff id="aff1"><label>1</label><institution content-type="dept">Department of Entomology and Plant Pathology</institution><institution>North Carolina State University</institution><addr-line><named-content content-type="city">Raleigh</named-content></addr-line><country>United States</country></aff><aff id="aff2"><label>2</label><institution content-type="dept">Bioinformatics Research Center</institution><institution>North Carolina State University</institution><addr-line><named-content content-type="city">Raleigh</named-content></addr-line><country>United States</country></aff><aff id="aff3"><label>3</label><institution content-type="dept">Department of Biosystems Science and Engineering</institution><institution>ETH Zürich</institution><addr-line><named-content content-type="city">Basel</named-content></addr-line><country>Switzerland</country></aff><aff id="aff4"><label>4</label><institution>Swiss Institute of Bioinformatics</institution><addr-line><named-content content-type="city">Lausanne</named-content></addr-line><country>Switzerland</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Walczak</surname><given-names>Aleksandra M</given-names></name><role>Reviewing Editor</role><aff><institution>École Normale Supérieure</institution><country>France</country></aff></contrib><contrib contrib-type="senior_editor"><name><surname>Tautz</surname><given-names>Diethard</given-names></name><role>Senior Editor</role><aff><institution>Max-Planck Institute for Evolutionary Biology</institution><country>Germany</country></aff></contrib></contrib-group><pub-date date-type="publication" publication-format="electronic"><day>15</day><month>08</month><year>2019</year></pub-date><pub-date pub-type="collection"><year>2019</year></pub-date><volume>8</volume><elocation-id>e45562</elocation-id><history><date date-type="received" iso-8601-date="2019-01-27"><day>27</day><month>01</month><year>2019</year></date><date date-type="accepted" iso-8601-date="2019-07-26"><day>26</day><month>07</month><year>2019</year></date></history><permissions><copyright-statement>© 2019, Rasmussen and Stadler</copyright-statement><copyright-year>2019</copyright-year><copyright-holder>Rasmussen and Stadler</copyright-holder><ali:free_to_read/><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><ali:license_ref>http://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-45562-v3.pdf"/><abstract><object-id pub-id-type="doi">10.7554/eLife.45562.001</object-id><p>Beneficial and deleterious mutations cause the fitness of lineages to vary across a phylogeny and thereby shape its branching structure. While standard phylogenetic models do not allow mutations to feedback and shape trees, birth-death models can account for this feedback by letting the fitness of lineages depend on their type. To date, these multi-type birth-death models have only been applied to cases where a lineage’s fitness is determined by a single character state. We extend these models to track sequence evolution at multiple sites. This approach remains computationally tractable by tracking the genotype and fitness of lineages probabilistically in an approximate manner. Although approximate, we show that we can accurately estimate the fitness of lineages and site-specific mutational fitness effects from phylogenies. We apply this approach to estimate the population-level fitness effects of mutations in Ebola and influenza virus, and compare our estimates with in vitro fitness measurements for these mutations.</p></abstract><kwd-group kwd-group-type="author-keywords"><kwd>phylogenetics</kwd><kwd>molecular evolution</kwd><kwd>birth-death models</kwd><kwd>fitness inference</kwd><kwd>ebola virus</kwd><kwd>influenza</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd>Virus</kwd></kwd-group><funding-group><award-group id="fund1"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100004963</institution-id><institution>Seventh Framework Programme</institution></institution-wrap></funding-source><award-id>European Research Commission</award-id><principal-award-recipient><name><surname>Stadler</surname><given-names>Tanja</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>A new model describes how adaptive molecular evolution shapes phylogenetic trees and can be used to estimate the fitness effects of mutations from phylogenies.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>The fitness effects of new mutations is a key determinant of a population’s evolutionary potential to adapt over time. Studies exploring the distribution of fitness effects (DFE) in a wide range of organisms have revealed that, while many mutations are neutral, a smaller but significant fraction have substantial effects on fitness (<xref ref-type="bibr" rid="bib40">Sanjuán et al., 2004</xref>; <xref ref-type="bibr" rid="bib8">Eyre-Walker and Keightley, 2007</xref>; <xref ref-type="bibr" rid="bib49">Visher et al., 2016</xref>). These findings have spurred interest in molecular evolutionary models that consider how non-neutral mutations shape sequence evolution and patterns of genetic diversity. Such models range in complexity from simple models assuming that selection operates uniformly across all sites (<xref ref-type="bibr" rid="bib28">Muse and Gaut, 1994</xref>; <xref ref-type="bibr" rid="bib13">Goldman and Yang, 1994</xref>; <xref ref-type="bibr" rid="bib51">Yang and Nielsen, 2008</xref>) to parameter rich models with site-specific fitness effects (<xref ref-type="bibr" rid="bib15">Halpern and Bruno, 1998</xref>; <xref ref-type="bibr" rid="bib23">Lartillot and Philippe, 2004</xref>; <xref ref-type="bibr" rid="bib39">Rodrigue et al., 2010</xref>; <xref ref-type="bibr" rid="bib16">Hilton and Bloom, 2018</xref>). While all of these models assume sequences evolve along an underlying phylogenetic tree representing their shared common ancestry, all also assume that the mutation process driving sequence evolution is independent of the other evolutionary processes giving rise to the tree. This independence assumption implies that mutations do not feedback and affect the fitness of lineages in the tree, such that lineages carrying highly beneficial mutations are just as likely to survive and produce sampled descendants as lineages riddled with deleterious mutations (<xref ref-type="fig" rid="fig1">Figure 1A</xref>).</p><fig id="fig1" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.002</object-id><label>Figure 1.</label><caption><title>Schematic overview of birth-death models.</title><p>(<bold>A</bold>) Standard phylogenetic models assume that there is an underlying process by which individuals replicate and give rise to a phylogeny. Mutations occur along the lineages of the tree, generating the sequence data observed at the tips. The mutation process is assumed to be independent of tree generating process, such that mutations do not impact the branching structure of the tree. (<bold>B</bold>) The MFBD allows us to relax this assumption, such that mutations at multiple sites feedback and shape both the tree and sequence data. (<bold>C</bold>) Under the original multi-type birth-death model we track <inline-formula><mml:math id="inf1"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>, the probability density that a lineage <inline-formula><mml:math id="inf2"><mml:mi>n</mml:mi></mml:math></inline-formula> at time <inline-formula><mml:math id="inf3"><mml:mi>t</mml:mi></mml:math></inline-formula> in state <inline-formula><mml:math id="inf4"><mml:mi>i</mml:mi></mml:math></inline-formula> produces the subtree descending from <inline-formula><mml:math id="inf5"><mml:mi>n</mml:mi></mml:math></inline-formula> and the observed tip states. We also track <inline-formula><mml:math id="inf6"><mml:msub><mml:mi>E</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></inline-formula>, the probability that a lineage produces no sampled descendants and is therefore unobserved. (<bold>D</bold>) In the MFBD model we instead track <inline-formula><mml:math id="inf7"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>, the probability that a lineage <inline-formula><mml:math id="inf8"><mml:mi>n</mml:mi></mml:math></inline-formula> in state <inline-formula><mml:math id="inf9"><mml:mi>i</mml:mi></mml:math></inline-formula> at site <inline-formula><mml:math id="inf10"><mml:mi>k</mml:mi></mml:math></inline-formula> produces the subtree and the observed tip states at site <inline-formula><mml:math id="inf11"><mml:mi>k</mml:mi></mml:math></inline-formula>. Because the fitness of a lineage <inline-formula><mml:math id="inf12"><mml:msub><mml:mi>f</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> will depend on its genotype at all sites, we use the marginal site probabilities <inline-formula><mml:math id="inf13"><mml:mi>ω</mml:mi></mml:math></inline-formula> to compute the probability that a lineage has a certain genotype, such as ACT (Approximation 1). We can then marginalize over the fitness of each genotype weighted by its approximate genotype probability to compute the fitness <inline-formula><mml:math id="inf14"><mml:msub><mml:mi>f</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> of a lineage (Approximation 2). Finally, we need to know the probability <inline-formula><mml:math id="inf15"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> that a lineage left no other sampled descendants, which we approximate using the probability <inline-formula><mml:math id="inf16"><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:math></inline-formula> that a lineage with same expected fitness <inline-formula><mml:math id="inf17"><mml:mi>u</mml:mi></mml:math></inline-formula> leaves no sampled descendants (Approximation 3). The schematic in A was reproduced from the original figure by Louis du Plessis (<ext-link ext-link-type="uri" xlink:href="https://github.com/Taming-the-BEAST/TechnicalLectureSources/tree/master/BeastIntro2018">https://github.com/Taming-the-BEAST/TechnicalLectureSources/tree/master/BeastIntro2018</ext-link>) with permission under a Creative Commons license.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-45562-fig1-v3.tif"/></fig><p>While questionable in terms of biological realism, independence between the tree generating process and the mutation process allows for tractable statistical models. Assuming independence, the joint likelihood of a phylogenetic tree <inline-formula><mml:math id="inf18"><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi></mml:math></inline-formula> and the sequence data <inline-formula><mml:math id="inf19"><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi></mml:math></inline-formula> at the tips of the tree having evolved as observed can be factored into two distinct components:<disp-formula id="equ1"><label>(1)</label><mml:math id="m1"><mml:mrow><mml:mrow><mml:mrow><mml:mi>L</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mi>L</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mi>μ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>⁢</mml:mo><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mi>θ</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>The likelihood of the sequence data <inline-formula><mml:math id="inf20"><mml:mrow><mml:mi>L</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mi>μ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> conditional on the tree and the mutational parameters <inline-formula><mml:math id="inf21"><mml:mi>μ</mml:mi></mml:math></inline-formula> can be computed efficiently for most continuous-time Markov models of sequence evolution (<xref ref-type="bibr" rid="bib9">Felsenstein, 1981</xref>). The probability density <inline-formula><mml:math id="inf22"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mi>θ</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> of the tree <inline-formula><mml:math id="inf23"><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi></mml:math></inline-formula> given the parameters generating the tree <inline-formula><mml:math id="inf24"><mml:mi>θ</mml:mi></mml:math></inline-formula> can likewise be computed under widely used coalescent (<xref ref-type="bibr" rid="bib14">Griffiths and Tavaré, 1994</xref>; <xref ref-type="bibr" rid="bib32">Pybus et al., 2000</xref>) or birth-death models (<xref ref-type="bibr" rid="bib37">Rannala and Yang, 1996</xref>; <xref ref-type="bibr" rid="bib41">Stadler, 2009</xref>). In Bayesian phylogenetics, <inline-formula><mml:math id="inf25"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mi>θ</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> is normally thought of as the prior distribution over trees rather than a likelihood, because the tree itself is inferred from the sequence data.</p><p>The assumption of independence between the mutation and tree generating processes may be unproblematic in certain scenarios, such as if mutations are truly neutral or do not contribute to substantial fitness differences among lineages. A common argument invoked in defense of ignoring non-neutral mutations is that macroevolutionary tree generating processes like speciation and extinction play out on longer timescales than the substitution process fixing or removing mutations within a population (<xref ref-type="bibr" rid="bib4">Bustamante, 2005</xref>). In this case, fitness variation drives the substitution process within a population but does not ultimately drive the formation of a phylogeny at the species level. But such separation-of-timescales arguments do not hold when segregating mutations contribute to substantial fitness variation between lineages in a phylogeny, such as for rapidly evolving microbes where several different mutant strains can co-circulate. In these cases, the tree generating and mutation processes occur on the same timescale, and the fitness effects of mutations can feedback and shape the branching structure of a phylogeny (<xref ref-type="bibr" rid="bib18">Kaplan et al., 1988</xref>; <xref ref-type="bibr" rid="bib31">Nicolaisen and Desai, 2012</xref>; <xref ref-type="bibr" rid="bib30">Neher and Hallatschek, 2013</xref>). Ignoring non-neutral evolution in this case may introduce biases into phylogenetic inference. But perhaps more importantly, fitness differences among lineages can be correlated with ancestral genotypes, providing information about the molecular basis of adaptive evolution we would otherwise ignore.</p><p>We therefore explore an approach that couples molecular sequence evolution to the tree-generating process using multi-type birth-death (MTBD) models. Under this approach, mutations can directly impact the fitness of a lineage in the phylogeny by altering its birth or death rate (<xref ref-type="fig" rid="fig1">Figure 1B</xref>). For a single evolving site or other character state, the joint likelihood of the phylogeny together with the observed tip states can be computed exactly under the MTBD model (<xref ref-type="bibr" rid="bib27">Maddison et al., 2007</xref>; <xref ref-type="bibr" rid="bib43">Stadler and Bonhoeffer, 2013</xref>; <xref ref-type="bibr" rid="bib22">Kühnert et al., 2016</xref>). However, this approach is impractical for more than a few non-neutrally evolving sites due to the need to track all possible genotypes as separate types in the state space of the model. We therefore explore an approximate birth-death model that considers how mutations at multiple sites contribute to a lineage’s overall fitness, without the need to track all possible genotypes in sequence space. This approach allows us to infer the fitness effects of individual mutations and the fitness of any particular lineage at any time (based on its inferred ancestral genotype) from the branching structure of a phylogeny. Because our approach is particularly relevant to rapidly adapting microbial pathogens, we apply it to Ebola and influenza virus sequence data in order to quantify the fitness effects of naturally occurring amino acid substitutions.</p></sec><sec id="s2" sec-type="materials|methods"><title>Materials and methods</title><sec id="s2-1"><title>The MTBD at a single evolving site</title><p>At a single evolving site, the multi-type birth-death (MTBD) model of <xref ref-type="bibr" rid="bib43">Stadler and Bonhoeffer (2013)</xref> can be used to compute the joint likelihood <inline-formula><mml:math id="inf26"><mml:mrow><mml:mi>L</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>S</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> of the sequence or character state data <inline-formula><mml:math id="inf27"><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi></mml:math></inline-formula> and phylogenetic tree <inline-formula><mml:math id="inf28"><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi></mml:math></inline-formula> in a way that couples the mutation process with changes in fitness along a lineage. Let <inline-formula><mml:math id="inf29"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> represent the probability density (i.e. the likelihood) that the subtree descending from lineage <inline-formula><mml:math id="inf30"><mml:mi>n</mml:mi></mml:math></inline-formula> evolved between time <inline-formula><mml:math id="inf31"><mml:mi>t</mml:mi></mml:math></inline-formula> and the present exactly as observed (<xref ref-type="fig" rid="fig1">Figure 1C</xref>). Further, let <inline-formula><mml:math id="inf32"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> represent this probability density conditional on lineage <inline-formula><mml:math id="inf33"><mml:mi>n</mml:mi></mml:math></inline-formula> being in state <inline-formula><mml:math id="inf34"><mml:mi>i</mml:mi></mml:math></inline-formula> out of <inline-formula><mml:math id="inf35"><mml:mi>M</mml:mi></mml:math></inline-formula> possible states at time <inline-formula><mml:math id="inf36"><mml:mi>t</mml:mi></mml:math></inline-formula>. Here the state of a lineage refers to a particular allele or character state (e.g. nucleotide or amino acid) at a single site. We reserve the term genotype to refer to a particular configuration of states across multiple sites in a sequence.</p><p>The density <inline-formula><mml:math id="inf37"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> can be computed going backwards in time from the present (<inline-formula><mml:math id="inf38"><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula>) to time <inline-formula><mml:math id="inf39"><mml:mi>t</mml:mi></mml:math></inline-formula> along a lineage by numerically solving a system of ordinary differential equations:<disp-formula id="equ2"><label>(2)</label><mml:math id="m2"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnalign="left left left" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mfrac><mml:mi>d</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:mtd><mml:mtd><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>d</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:mtd><mml:mtd><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">a</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">o</mml:mi><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">v</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mspace width="2em"/><mml:mspace width="2em"/><mml:mspace width="2em"/><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd><mml:mtd><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">b</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">b</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">r</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">h</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">o</mml:mi><mml:mi mathvariant="normal">f</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">l</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">g</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mrow><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">w</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">h</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">o</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">p</mml:mi><mml:mi mathvariant="normal">l</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">d</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">c</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">d</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">s</mml:mi></mml:mrow></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mspace width="2em"/><mml:mspace width="2em"/><mml:mspace width="2em"/><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:mtd><mml:mtd><mml:mstyle displaystyle="false" scriptlevel="0"><mml:mtext>(c) mutation from </mml:mtext></mml:mstyle><mml:mi>i</mml:mi><mml:mstyle displaystyle="false" scriptlevel="0"><mml:mtext> to </mml:mtext></mml:mstyle><mml:mi>j</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Here, <inline-formula><mml:math id="inf40"><mml:msub><mml:mi>λ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></inline-formula> is the birth rate and <inline-formula><mml:math id="inf41"><mml:msub><mml:mi>d</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></inline-formula> is the death rate of lineages in state <inline-formula><mml:math id="inf42"><mml:mi>i</mml:mi></mml:math></inline-formula>, and thus reflect a lineage’s fitness. Mutations between states <inline-formula><mml:math id="inf43"><mml:mi>i</mml:mi></mml:math></inline-formula> and <inline-formula><mml:math id="inf44"><mml:mi>j</mml:mi></mml:math></inline-formula> occur at a rate <inline-formula><mml:math id="inf45"><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, independently of birth events. Each term in (<xref ref-type="disp-formula" rid="equ2">Equation 2</xref>) describes how <inline-formula><mml:math id="inf46"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> changes through time by accounting for all of the different events that could have occurred along the lineage. The first term (a) considers the change in probability density given that no birth, death or mutation event occurred. The second term (b) considers the probability of a birth event that went unobserved because one of the child lineages produced no sampled descendants (this event has probability <inline-formula><mml:math id="inf47"><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>, see below). The third term (c) reflects the probability that the lineage mutated from state <inline-formula><mml:math id="inf48"><mml:mi>i</mml:mi></mml:math></inline-formula> to <inline-formula><mml:math id="inf49"><mml:mi>j</mml:mi></mml:math></inline-formula>.</p><p><inline-formula><mml:math id="inf50"><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> represents the probability that a lineage in state <inline-formula><mml:math id="inf51"><mml:mi>i</mml:mi></mml:math></inline-formula> is not sampled and has no sampled descendants. This probability can be computed at any time <inline-formula><mml:math id="inf52"><mml:mi>t</mml:mi></mml:math></inline-formula> by solving a second set of ODEs:<disp-formula id="equ3"><label>(3)</label><mml:math id="m3"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnalign="left left" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mfrac><mml:mi>d</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>d</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:mtd><mml:mtd><mml:mspace width="2em"/><mml:mspace width="2em"/><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">a</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">d</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">h</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">w</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">h</mml:mi><mml:mi mathvariant="normal">o</mml:mi><mml:mi mathvariant="normal">u</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">p</mml:mi><mml:mi mathvariant="normal">l</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">g</mml:mi></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>−</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>d</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd><mml:mtd><mml:mspace width="2em"/><mml:mspace width="2em"/><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">b</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">o</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">v</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:mtd><mml:mtd><mml:mrow><mml:mspace width="2em"/><mml:mspace width="2em"/><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">c</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">b</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">r</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">h</mml:mi><mml:mo>,</mml:mo><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">h</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">r</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">c</mml:mi><mml:mi mathvariant="normal">h</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">l</mml:mi><mml:mi mathvariant="normal">d</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">h</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">s</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">p</mml:mi><mml:mi mathvariant="normal">l</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">l</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">d</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">d</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">c</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">d</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">s</mml:mi></mml:mrow></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mtd><mml:mtd><mml:mspace width="2em"/><mml:mspace width="2em"/><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">d</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">u</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">o</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">f</mml:mi><mml:mi mathvariant="normal">r</mml:mi><mml:mi mathvariant="normal">o</mml:mi><mml:mi mathvariant="normal">m</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mrow><mml:mi mathvariant="italic">i</mml:mi></mml:mrow><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mi mathvariant="normal">t</mml:mi><mml:mi mathvariant="normal">o</mml:mi><mml:mspace width="thinmathspace"/><mml:mspace width="thinmathspace"/><mml:mrow><mml:mi mathvariant="italic">j</mml:mi></mml:mrow></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>The first term (a) reflects the probability that a lineage dies and is not sampled, where <inline-formula><mml:math id="inf53"><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></inline-formula> is the probability that a lineage in state <inline-formula><mml:math id="inf54"><mml:mi>i</mml:mi></mml:math></inline-formula> is sampled upon dying. Terms b-d have similar interpretations as in (<xref ref-type="disp-formula" rid="equ2">Equation 2</xref>).</p><p>At a tip lineage <inline-formula><mml:math id="inf55"><mml:mi>n</mml:mi></mml:math></inline-formula>, we initialize <inline-formula><mml:math id="inf56"><mml:mrow><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mrow></mml:math></inline-formula> if the lineage was sampled upon death at time <inline-formula><mml:math id="inf57"><mml:mi>t</mml:mi></mml:math></inline-formula>. Alternatively, if <inline-formula><mml:math id="inf58"><mml:mi>n</mml:mi></mml:math></inline-formula> was sampled at the present time <inline-formula><mml:math id="inf59"><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula> before dying, then <inline-formula><mml:math id="inf60"><mml:mrow><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>ρ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, where <inline-formula><mml:math id="inf61"><mml:msub><mml:mi>ρ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></inline-formula> is the probability that an individual in state <inline-formula><mml:math id="inf62"><mml:mi>i</mml:mi></mml:math></inline-formula> was sampled at present. At a branching event, the probability density <inline-formula><mml:math id="inf63"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>a</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> of the parent lineage <inline-formula><mml:math id="inf64"><mml:mi>a</mml:mi></mml:math></inline-formula> in state <inline-formula><mml:math id="inf65"><mml:mi>i</mml:mi></mml:math></inline-formula> giving rise to two descendent lineages <inline-formula><mml:math id="inf66"><mml:mi>n</mml:mi></mml:math></inline-formula> and <inline-formula><mml:math id="inf67"><mml:mi>m</mml:mi></mml:math></inline-formula> is updated as:<disp-formula id="equ4"><label>(4)</label><mml:math id="m4"><mml:mrow><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>a</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mn>2</mml:mn><mml:mo>⁢</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>m</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>⁢</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>The factor of two enters because either lineage <inline-formula><mml:math id="inf68"><mml:mi>m</mml:mi></mml:math></inline-formula> or <inline-formula><mml:math id="inf69"><mml:mi>n</mml:mi></mml:math></inline-formula> could have given birth and we must consider both possible events.</p><p>At the root, we can compute the probability density of the entire tree by summing over all possible root states:<disp-formula id="equ5"><label>(5)</label><mml:math id="m5"><mml:mrow><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:munderover><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:munderover><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mrow></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf70"><mml:msub><mml:mi>q</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></inline-formula> is the prior probability that the root is in state <inline-formula><mml:math id="inf71"><mml:mi>i</mml:mi></mml:math></inline-formula> at time <inline-formula><mml:math id="inf72"><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. Including the term <inline-formula><mml:math id="inf73"><mml:mrow><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:math></inline-formula> in the denominator conditions the birth-death process on giving rise to at least one sampled individual. <inline-formula><mml:math id="inf74"><mml:msub><mml:mi>D</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> represents the probability that the entire tree and the tip states <inline-formula><mml:math id="inf75"><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi></mml:math></inline-formula> evolved as exactly as observed. It is therefore equivalent to the joint likelihood <inline-formula><mml:math id="inf76"><mml:mrow><mml:mi>L</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> we seek where <inline-formula><mml:math id="inf77"><mml:mrow><mml:mi>μ</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mi>γ</mml:mi><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> and <inline-formula><mml:math id="inf78"><mml:mrow><mml:mi>θ</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mi>λ</mml:mi><mml:mo>,</mml:mo><mml:mi>d</mml:mi><mml:mo>,</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>.</p><p>In theory, this approach could be extended to evolution at any number of sites as long as we track <inline-formula><mml:math id="inf79"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> for all possible genotypes <inline-formula><mml:math id="inf80"><mml:mi>i</mml:mi></mml:math></inline-formula>. Unfortunately, this approach has limited utility because the number of possible genotypes in sequence space scales exponentially with the number of sites <inline-formula><mml:math id="inf81"><mml:mi>L</mml:mi></mml:math></inline-formula> (i.e. <inline-formula><mml:math id="inf82"><mml:msup><mml:mn>4</mml:mn><mml:mi>L</mml:mi></mml:msup></mml:math></inline-formula> possible genotypes for nucleotide sequences), making the MTBD model impractical for modeling evolution at more than a few sites.</p></sec><sec id="s2-2"><title>The marginal fitness birth-death model</title><p>While the fitness of a lineage will generally depend on its genotype across multiple sites, tracking evolution in the space of all possible genotypes is, as just discussed, computationally infeasible. We therefore seek an approach that considers how mutations at multiple sites determine the fitness of a lineage without the need to track <inline-formula><mml:math id="inf83"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> for all possible genotypes. In the approach described below and outlined in <xref ref-type="fig" rid="fig1">Figure 1D</xref>, we therefore track molecular evolution at each site, computing the probability that each site occupies each state, and then approximate the probability of a lineage being in any particular genotype based on these site probabilities. To compute the expected fitness of a lineage, we can then sum, or marginalize, over the fitness of each genotype weighted by its approximate probability. We therefore refer to this approach as the marginal fitness birth-death (MFBD) model.</p><p>First, in order to couple a lineage’s fitness with the birth-death process, we will assume that the birth rate <inline-formula><mml:math id="inf84"><mml:msub><mml:mi>λ</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> of any lineage <inline-formula><mml:math id="inf85"><mml:mi>n</mml:mi></mml:math></inline-formula> scales according to the fitness <inline-formula><mml:math id="inf86"><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub></mml:math></inline-formula> of its genotype:<disp-formula id="equ6"><label>(6)</label><mml:math id="m6"><mml:mrow><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf87"><mml:msub><mml:mi>λ</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:math></inline-formula> is the base birth rate assigned to a particular reference genotype (e.g. the wildtype). A lineage’s death rate can also be coupled to its fitness, but for simplicity we will assume a lineage’s fitness is reflected only in its birth rate <inline-formula><mml:math id="inf88"><mml:msub><mml:mi>λ</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula>.</p><p>Let <inline-formula><mml:math id="inf89"><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:math></inline-formula> be the set of all possible genotypes in sequence space and <inline-formula><mml:math id="inf90"><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:math></inline-formula> be the state of genotype <inline-formula><mml:math id="inf91"><mml:mi>g</mml:mi></mml:math></inline-formula> at site <inline-formula><mml:math id="inf92"><mml:mi>k</mml:mi></mml:math></inline-formula>. To make it clear when we are considering evolution in genotype space rather than at a particular site, we will write the probability density <inline-formula><mml:math id="inf93"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> as <inline-formula><mml:math id="inf94"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> when <inline-formula><mml:math id="inf95"><mml:mi>i</mml:mi></mml:math></inline-formula> refers to a particular genotype. Furthermore, let <inline-formula><mml:math id="inf96"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> be the probability density of the subtree descending from lineage <inline-formula><mml:math id="inf97"><mml:mi>n</mml:mi></mml:math></inline-formula> given that site <inline-formula><mml:math id="inf98"><mml:mi>k</mml:mi></mml:math></inline-formula> is in state <inline-formula><mml:math id="inf99"><mml:mi>i</mml:mi></mml:math></inline-formula>. By definition,<disp-formula id="equ7"><label>(7)</label><mml:math id="m7"><mml:mrow><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:munder><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mrow><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where the sum is over all genotypes in <inline-formula><mml:math id="inf100"><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:math></inline-formula> with site <inline-formula><mml:math id="inf101"><mml:mi>k</mml:mi></mml:math></inline-formula> in state <inline-formula><mml:math id="inf102"><mml:mi>i</mml:mi></mml:math></inline-formula>.</p><p>We can derive a difference equation for <inline-formula><mml:math id="inf103"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> from <inline-formula><mml:math id="inf104"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> in a straightforward manner:<disp-formula id="equ8"><label>(8)</label><mml:math id="m8"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnalign="left left" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo>+</mml:mo><mml:mi mathvariant="normal">Δ</mml:mi><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd><mml:mtd><mml:mo>=</mml:mo><mml:mstyle displaystyle="true" scriptlevel="0"><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo>+</mml:mo><mml:mi mathvariant="normal">Δ</mml:mi><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mo>=</mml:mo><mml:mstyle displaystyle="true" scriptlevel="0"><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:mrow><mml:mo maxsize="1.623em" minsize="1.623em">[</mml:mo></mml:mrow><mml:mrow><mml:mo maxsize="1.2em" minsize="1.2em">(</mml:mo></mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msubsup><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>d</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:mo maxsize="1.2em" minsize="1.2em">)</mml:mo></mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi mathvariant="normal">Δ</mml:mi><mml:mi>t</mml:mi></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mo>=</mml:mo><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi mathvariant="normal">Δ</mml:mi><mml:mi>t</mml:mi></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mo>=</mml:mo><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msubsup><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi mathvariant="normal">Δ</mml:mi><mml:mi>t</mml:mi><mml:mrow><mml:mo maxsize="1.623em" minsize="1.623em">]</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Taking the limit as <inline-formula><mml:math id="inf105"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow><mml:mo>→</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula>, we get a new system of differential equations for <inline-formula><mml:math id="inf106"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>:<disp-formula id="equ9"><label>(9)</label><mml:math id="m9"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnalign="left left" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mfrac><mml:mi>d</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mtd><mml:mtd><mml:mo>=</mml:mo><mml:mstyle displaystyle="true" scriptlevel="0"><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:mrow><mml:mo maxsize="1.623em" minsize="1.623em">[</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msubsup><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>d</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msubsup><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:mo maxsize="1.623em" minsize="1.623em">]</mml:mo></mml:mrow></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Unfortunately, (<xref ref-type="disp-formula" rid="equ9">Equation 9</xref>) would still require us to track <inline-formula><mml:math id="inf107"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> for all possible genotypes, precisely what we wish not to do. We show below that, if we can approximate <inline-formula><mml:math id="inf108"><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf109"><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> for any given lineage, we can write (<xref ref-type="disp-formula" rid="equ9">Equation 9</xref>) in terms of only <inline-formula><mml:math id="inf110"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> (see (<xref ref-type="disp-formula" rid="equ19">Equation 19</xref>)) and therefore do not need to track each genotype.</p></sec><sec id="s2-3"><title>Approximating the fitness of a lineage</title><p>We begin by approximating the fitness <inline-formula><mml:math id="inf111"><mml:msub><mml:mi>f</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> of a lineage <inline-formula><mml:math id="inf112"><mml:mi>n</mml:mi></mml:math></inline-formula>. Even if we do not know the exact genotype of a lineage at a particular time, we can compute the lineage’s expected fitness by summing over the fitness of each genotype <inline-formula><mml:math id="inf113"><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub></mml:math></inline-formula> weighted by the probability <inline-formula><mml:math id="inf114"><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> that lineage <inline-formula><mml:math id="inf115"><mml:mi>n</mml:mi></mml:math></inline-formula> is in genotype <inline-formula><mml:math id="inf116"><mml:mi>g</mml:mi></mml:math></inline-formula>:<disp-formula id="equ10"><label>(10)</label><mml:math id="m10"><mml:mrow><mml:mrow><mml:mrow><mml:mi>𝔼</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:munder><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow></mml:munder><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>The same logic can be extended to compute the expected marginal fitness <inline-formula><mml:math id="inf117"><mml:mrow><mml:mi>𝔼</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> of a lineage <inline-formula><mml:math id="inf118"><mml:mi>n</mml:mi></mml:math></inline-formula> that at site <inline-formula><mml:math id="inf119"><mml:mi>k</mml:mi></mml:math></inline-formula> is in state <inline-formula><mml:math id="inf120"><mml:mi>i</mml:mi></mml:math></inline-formula>:<disp-formula id="equ11"><label>(11)</label><mml:math id="m11"><mml:mrow><mml:mrow><mml:mrow><mml:mi>𝔼</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:munder><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mrow><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>Computing <inline-formula><mml:math id="inf121"><mml:mrow><mml:mi>𝔼</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> using (<xref ref-type="disp-formula" rid="equ11">Equation 11</xref>) requires knowledge of the genotype probabilities <inline-formula><mml:math id="inf122"><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, which would again require us to track evolution in genotype space. We therefore introduce our major assumption: that we can approximate genotype probabilities using only the marginal site probabilities <inline-formula><mml:math id="inf123"><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> that site <inline-formula><mml:math id="inf124"><mml:mi>k</mml:mi></mml:math></inline-formula> is in state <inline-formula><mml:math id="inf125"><mml:mi>i</mml:mi></mml:math></inline-formula>. We describe how we compute <inline-formula><mml:math id="inf126"><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> below. For now, we make the approximation that<disp-formula id="equ12"><label>(12)</label><mml:math id="m12"><mml:mrow><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>ω</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msubsup><mml:mo largeop="true" symmetric="true">∏</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>L</mml:mi></mml:msubsup><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msubsup><mml:mo largeop="true" symmetric="true">∏</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>L</mml:mi></mml:msubsup><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mfrac></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>This approximation assumes that all sites evolve independently of one another, which is not generally true because mutations at different sites are linked together in genotypes with shared ancestral histories, creating correlations among sites that we ignore.</p><p>Using the approximate genotype probabilities <inline-formula><mml:math id="inf127"><mml:msub><mml:mover accent="true"><mml:mi>ω</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, we can in turn approximate the expected marginal fitness of a lineage:<disp-formula id="equ13"><label>(13)</label><mml:math id="m13"><mml:mrow><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:munder><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mrow><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>ω</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>If the fitness effects of each site act multiplicatively to determine the overall fitness of a lineage, we can compute <inline-formula><mml:math id="inf128"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> as:<disp-formula id="equ14"><label>(14)</label><mml:math id="m14"><mml:mrow><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>⁢</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:munderover><mml:mo largeop="true" movablelimits="false" symmetric="true">∏</mml:mo><mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>,</mml:mo><mml:mrow><mml:mi>l</mml:mi><mml:mo>≠</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:mrow><mml:mi>L</mml:mi></mml:munderover><mml:mrow><mml:munderover><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:munderover><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi>l</mml:mi><mml:mo>⁢</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>l</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow></mml:mrow></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf129"><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>⁢</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the fitness effect of site <inline-formula><mml:math id="inf130"><mml:mi>k</mml:mi></mml:math></inline-formula> being in state <inline-formula><mml:math id="inf131"><mml:mi>i</mml:mi></mml:math></inline-formula>. This formulation of <inline-formula><mml:math id="inf132"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is useful if the number of sites <inline-formula><mml:math id="inf133"><mml:mi>L</mml:mi></mml:math></inline-formula> is large and the number of genotypes we need to sum over in (<xref ref-type="disp-formula" rid="equ13">Equation 13</xref>) is therefore also extremely large.</p></sec><sec id="s2-4"><title>Approximating the probability of no sampled descendants</title><p>The <inline-formula><mml:math id="inf134"><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> term in (<xref ref-type="disp-formula" rid="equ9">Equation 9</xref>) represents the probability that a lineage <inline-formula><mml:math id="inf135"><mml:mi>n</mml:mi></mml:math></inline-formula> alive at time <inline-formula><mml:math id="inf136"><mml:mi>t</mml:mi></mml:math></inline-formula> in the past is not sampled and leaves behind no sampled descendants. <inline-formula><mml:math id="inf137"><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> therefore necessarily depends on the fitness of unobserved lineages descending from <inline-formula><mml:math id="inf138"><mml:mi>n</mml:mi></mml:math></inline-formula> and how fitness along these lineages evolves through changes in their genotype. Because it is often easier track evolution in one dimensional fitness space rather than high-dimensional sequence space (<xref ref-type="bibr" rid="bib19">Kepler and Perelson, 1993</xref>; <xref ref-type="bibr" rid="bib47">Tsimring et al., 1996</xref>), we simplify this problem by tracking a proxy for <inline-formula><mml:math id="inf139"><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> though fitness space.</p><p>Let <inline-formula><mml:math id="inf140"><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:math></inline-formula> be the probability that a lineage with expected fitness <inline-formula><mml:math id="inf141"><mml:mi>u</mml:mi></mml:math></inline-formula> leaves no sampled descendants. While fitness can take on a continuous range of values, we track these probabilities only for a discrete set of points <inline-formula><mml:math id="inf142"><mml:mi class="ltx_font_mathcaligraphic">𝒱</mml:mi></mml:math></inline-formula> in fitness space. We can track <inline-formula><mml:math id="inf143"><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:math></inline-formula> for <inline-formula><mml:math id="inf144"><mml:mrow><mml:mi>u</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒱</mml:mi></mml:mrow></mml:math></inline-formula> by modifying (<xref ref-type="disp-formula" rid="equ3">Equation 3</xref>) to obtain:<disp-formula id="equ15"><label>(15)</label><mml:math id="m15"><mml:mrow><mml:mrow><mml:mrow><mml:mfrac><mml:mi>d</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:mo>⁢</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>⁢</mml:mo><mml:msub><mml:mi>d</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:mrow><mml:mo>-</mml:mo><mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>u</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:mrow><mml:munder><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>v</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒱</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>+</mml:mo><mml:msub><mml:mi>d</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>⁢</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:mi>u</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:munder><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>v</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒱</mml:mi></mml:mrow></mml:munder><mml:mrow><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mi>v</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mrow></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>We can then substitute <inline-formula><mml:math id="inf145"><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> in (<xref ref-type="disp-formula" rid="equ9">Equation 9</xref>) with <inline-formula><mml:math id="inf146"><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:math></inline-formula> for the fitness value <inline-formula><mml:math id="inf147"><mml:mi>u</mml:mi></mml:math></inline-formula> closest to <inline-formula><mml:math id="inf148"><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub></mml:math></inline-formula> or <inline-formula><mml:math id="inf149"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> in fitness space.</p><p>Tracking evolution in fitness space requires us to specify rates <inline-formula><mml:math id="inf150"><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> for how lineages transition between fitness classes <inline-formula><mml:math id="inf151"><mml:mi>u</mml:mi></mml:math></inline-formula> and <inline-formula><mml:math id="inf152"><mml:mi>v</mml:mi></mml:math></inline-formula>. Let <inline-formula><mml:math id="inf153"><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:math></inline-formula> be the set of genotypes with expected fitness closest to <inline-formula><mml:math id="inf154"><mml:mi>u</mml:mi></mml:math></inline-formula> out of all fitness values in <inline-formula><mml:math id="inf155"><mml:mi class="ltx_font_mathcaligraphic">𝒱</mml:mi></mml:math></inline-formula>. We approximate <inline-formula><mml:math id="inf156"><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> as:<disp-formula id="equ16"><label>(16)</label><mml:math id="m16"><mml:mrow><mml:mrow><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi><mml:mi>u</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo></mml:mrow></mml:mfrac><mml:mo>⁢</mml:mo><mml:mrow><mml:munder><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:mrow></mml:munder><mml:mrow><mml:munder><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi><mml:mi>v</mml:mi></mml:msub></mml:mrow></mml:munder><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>⁢</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf157"><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>⁢</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the mutation rate between genotypes <inline-formula><mml:math id="inf158"><mml:mi>i</mml:mi></mml:math></inline-formula> and <inline-formula><mml:math id="inf159"><mml:mi>j</mml:mi></mml:math></inline-formula>. In other words, we compute the average rate of transitions out of fitness class <inline-formula><mml:math id="inf160"><mml:mi>u</mml:mi></mml:math></inline-formula> into <inline-formula><mml:math id="inf161"><mml:mi>v</mml:mi></mml:math></inline-formula> by summing over all possible transitions between genotypes contained within each fitness class. Note that if each genotype falls in a unique fitness class such that <inline-formula><mml:math id="inf162"><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi><mml:mi>u</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math></inline-formula> for all <inline-formula><mml:math id="inf163"><mml:mrow><mml:mi>u</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒱</mml:mi></mml:mrow></mml:math></inline-formula>, then <inline-formula><mml:math id="inf164"><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:math></inline-formula> is computed exactly. In the Results, we compare using the approximate transition rates above to compute <inline-formula><mml:math id="inf165"><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:math></inline-formula> versus an even simpler approximation where we assume no transitions between fitness classes along unobserved lineages, which has been assumed in earlier multi-type birth-death models (<xref ref-type="bibr" rid="bib34">Rabosky et al., 2014</xref>; <xref ref-type="bibr" rid="bib2">Barido-Sottani et al., 2018</xref>).</p></sec><sec id="s2-5"><title>Computing the marginal site densities <inline-formula><mml:math id="inf166"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula></title><p>Recall that (<xref ref-type="disp-formula" rid="equ9">Equation 9</xref>) provided an exact way to track the marginal site densities <inline-formula><mml:math id="inf167"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> based on the genotype densities <inline-formula><mml:math id="inf168"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. To efficiently evaluate <inline-formula><mml:math id="inf169"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> without the need to track <inline-formula><mml:math id="inf170"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> for all genotypes, we apply the three approximations made above. First, we approximate the genotype probabilities <inline-formula><mml:math id="inf171"><mml:msub><mml:mover accent="true"><mml:mi>ω</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> based on the marginal site probabilities. Second, we marginalize over the fitness of each genotype (weighted by its genotype probability) to compute <inline-formula><mml:math id="inf172"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and then substitute <inline-formula><mml:math id="inf173"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> for <inline-formula><mml:math id="inf174"><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub></mml:math></inline-formula> for all genotypes where <inline-formula><mml:math id="inf175"><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:math></inline-formula> below. Third, we approximate <inline-formula><mml:math id="inf176"><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> by <inline-formula><mml:math id="inf177"><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub></mml:math></inline-formula> for a single fitness value <inline-formula><mml:math id="inf178"><mml:mi>u</mml:mi></mml:math></inline-formula> closest to <inline-formula><mml:math id="inf179"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. Making these approximations in (<xref ref-type="disp-formula" rid="equ9">Equation 9</xref>) leads to:<disp-formula id="equ17"><label>(17)</label><mml:math id="m17"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnalign="left left" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mfrac><mml:mi>d</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mstyle></mml:mtd><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:mrow><mml:mo maxsize="1.623em" minsize="1.623em">[</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mover><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msubsup><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>d</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mrow><mml:mover><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>u</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msubsup><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:mo maxsize="1.623em" minsize="1.623em">]</mml:mo></mml:mrow></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Assuming that the mutation rate from <inline-formula><mml:math id="inf180"><mml:mi>i</mml:mi></mml:math></inline-formula> to <inline-formula><mml:math id="inf181"><mml:mi>j</mml:mi></mml:math></inline-formula> at site <inline-formula><mml:math id="inf182"><mml:mi>k</mml:mi></mml:math></inline-formula> does not depend on the genetic background, we can substitute <inline-formula><mml:math id="inf183"><mml:mrow><mml:msubsup><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:msubsup><mml:mrow><mml:msub><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mrow><mml:msup><mml:mi>g</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:mrow><mml:msubsup><mml:mi>g</mml:mi><mml:mi>k</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:msub><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mo>′</mml:mo></mml:msup></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></inline-formula> with <inline-formula><mml:math id="inf184"><mml:mrow><mml:msubsup><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:msubsup><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>, where <inline-formula><mml:math id="inf185"><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the per site mutation rate. We can likewise substitute <inline-formula><mml:math id="inf186"><mml:mrow><mml:msubsup><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:msubsup><mml:mrow><mml:msub><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mrow><mml:msup><mml:mi>g</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:mrow><mml:msubsup><mml:mi>g</mml:mi><mml:mi>k</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mo>′</mml:mo></mml:msup></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mo>′</mml:mo></mml:msup></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mrow></mml:math></inline-formula> with <inline-formula><mml:math id="inf187"><mml:mrow><mml:msubsup><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:msubsup><mml:mrow><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:msub><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mrow><mml:msup><mml:mi>g</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:mrow><mml:msubsup><mml:mi>g</mml:mi><mml:mi>k</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mo>′</mml:mo></mml:msup></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mrow></mml:mrow></mml:math></inline-formula>. Making these substitutions and rearranging the sums in (<xref ref-type="disp-formula" rid="equ17">Equation 17</xref>), we have:<disp-formula id="equ18"><label>(18)</label><mml:math id="m18"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnalign="left left" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mfrac><mml:mi>d</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mtd><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>−</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mover><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>d</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mrow><mml:mover><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>u</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mo fence="false" stretchy="false">{</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="script">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:msubsup><mml:mi>g</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo fence="false" stretchy="false">}</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mi mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:msub></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Recalling that <inline-formula><mml:math id="inf188"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:msub><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mrow><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:msub><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></inline-formula> (and by extension <inline-formula><mml:math id="inf189"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:msub><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mrow><mml:mi>g</mml:mi><mml:mo>∈</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi></mml:mrow><mml:mo>:</mml:mo><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:msub><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></inline-formula>), we have:<disp-formula id="equ19"><label>(19)</label><mml:math id="m19"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnalign="left left" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mfrac><mml:mi>d</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mtd><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>−</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mover><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>d</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mrow><mml:mover><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>u</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>+</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>The significance of (<xref ref-type="disp-formula" rid="equ19">Equation 19</xref>) is twofold. First, we can track sequence evolution at each site individually without tracking all genotypes. Second, given <inline-formula><mml:math id="inf190"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, we can track the overall fitness of a lineage by marginalizing over the fitness effects of all possible mutations at other sites. We can therefore track sequence evolution at each site while simultaneously taking into account the coupled fitness effects of mutations at all other sites on a lineage’s fitness.</p><p>Computing <inline-formula><mml:math id="inf191"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> still requires us to approximate the genotype probabilities using (<xref ref-type="disp-formula" rid="equ12">Equation 12</xref>), which in turn requires the marginal site probabilities <inline-formula><mml:math id="inf192"><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. In our notation, <inline-formula><mml:math id="inf193"><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> represents the conditional probability <inline-formula><mml:math id="inf194"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> that lineage <inline-formula><mml:math id="inf195"><mml:mi>n</mml:mi></mml:math></inline-formula> is in particular state <inline-formula><mml:math id="inf196"><mml:mi>i</mml:mi></mml:math></inline-formula>, where <inline-formula><mml:math id="inf197"><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> represents the subtree descending from <inline-formula><mml:math id="inf198"><mml:mi>n</mml:mi></mml:math></inline-formula> with tip sequences <inline-formula><mml:math id="inf199"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">𝒮</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> represents the inverse conditional probability density <inline-formula><mml:math id="inf200"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>. We can therefore apply Bayes theorem to compute <inline-formula><mml:math id="inf201"><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> given <inline-formula><mml:math id="inf202"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>:<disp-formula id="equ20"><label>(20)</label><mml:math id="m20"><mml:mrow><mml:mrow><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>⁢</mml:mo><mml:mi>q</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:msubsup><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mi>i</mml:mi><mml:mi>M</mml:mi></mml:msubsup><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>⁢</mml:mo><mml:mi>q</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mi>q</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:msubsup><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mi>i</mml:mi><mml:mi>M</mml:mi></mml:msubsup><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mi>q</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mfrac></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>The <inline-formula><mml:math id="inf203"><mml:mrow><mml:mi>q</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> terms represent the prior probability that the lineage is in state <inline-formula><mml:math id="inf204"><mml:mi>i</mml:mi></mml:math></inline-formula>. Here we make a simplification in assuming that the tree ancestral and sister to lineage <inline-formula><mml:math id="inf205"><mml:mi>n</mml:mi></mml:math></inline-formula> has no information regarding <inline-formula><mml:math id="inf206"><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, and thus assume a uniform prior on <inline-formula><mml:math id="inf207"><mml:mrow><mml:mrow><mml:mi>q</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>/</mml:mo><mml:mi>M</mml:mi></mml:mrow></mml:mrow></mml:math></inline-formula>. The <inline-formula><mml:math id="inf208"><mml:mrow><mml:mi>q</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> terms therefore cancel above.</p><p>Because the fitness of a lineage depends on the state of all sites, we must solve (<xref ref-type="disp-formula" rid="equ19">Equation 19</xref>) for all sites simultaneously as one coupled system of differential equations. This requires updating <inline-formula><mml:math id="inf209"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> at each time step, which suggests the following iterative procedure.</p><p>At a tip <inline-formula><mml:math id="inf210"><mml:mi>n</mml:mi></mml:math></inline-formula> observed to be in genotype <inline-formula><mml:math id="inf211"><mml:mi>g</mml:mi></mml:math></inline-formula>, we initialize <inline-formula><mml:math id="inf212"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> as <inline-formula><mml:math id="inf213"><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub></mml:math></inline-formula> if <inline-formula><mml:math id="inf214"><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:math></inline-formula> or else <inline-formula><mml:math id="inf215"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula>, <inline-formula><mml:math id="inf216"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>D</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mi>d</mml:mi><mml:mo>⁢</mml:mo><mml:mi>s</mml:mi></mml:mrow></mml:mrow></mml:math></inline-formula> or <inline-formula><mml:math id="inf217"><mml:mi>ρ</mml:mi></mml:math></inline-formula>, and <inline-formula><mml:math id="inf218"><mml:mrow><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math></inline-formula> if <inline-formula><mml:math id="inf219"><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:math></inline-formula>, else <inline-formula><mml:math id="inf220"><mml:mrow><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula>. Then at each time step backwards through time from time <inline-formula><mml:math id="inf221"><mml:mi>t</mml:mi></mml:math></inline-formula> to time <inline-formula><mml:math id="inf222"><mml:mrow><mml:mi>t</mml:mi><mml:mo>+</mml:mo><mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:mrow></mml:math></inline-formula>, for each site and state we:</p><list id="Sx3.I1" list-type="order"><list-item><p>Update <inline-formula><mml:math id="inf223"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> by numerically integrating (<xref ref-type="disp-formula" rid="equ19">Equation 19</xref>) over time step <inline-formula><mml:math id="inf224"><mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:math></inline-formula>.</p></list-item> <list-item><p>Update the marginal site probabilities <inline-formula><mml:math id="inf225"><mml:msub><mml:mi>ω</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> using (<xref ref-type="disp-formula" rid="equ20">Equation 20</xref>)</p></list-item> <list-item><p>Update the expected marginal fitness values <inline-formula><mml:math id="inf226"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> using (<xref ref-type="disp-formula" rid="equ13">Equation 13</xref>) or (<xref ref-type="disp-formula" rid="equ14">Equation 14</xref>).</p></list-item></list></sec><sec id="s2-6"><title>Computing the full joint likelihood</title><p>We can now compute the joint likelihood of the tree and sequence data if we track <inline-formula><mml:math id="inf227"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> at each site back to the root. At the root, <inline-formula><mml:math id="inf228"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> represents <inline-formula><mml:math id="inf229"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>, the probability density of the entire tree <inline-formula><mml:math id="inf230"><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi></mml:math></inline-formula> and the observed sequence data <inline-formula><mml:math id="inf231"><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:math></inline-formula> as site <inline-formula><mml:math id="inf232"><mml:mi>k</mml:mi></mml:math></inline-formula>, conditional on site <inline-formula><mml:math id="inf233"><mml:mi>k</mml:mi></mml:math></inline-formula> being in state <inline-formula><mml:math id="inf234"><mml:mi>i</mml:mi></mml:math></inline-formula> at the root. To be precise, <inline-formula><mml:math id="inf235"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> only approximates <inline-formula><mml:math id="inf236"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> because we computed <inline-formula><mml:math id="inf237"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> using the expected marginal fitness of a lineage <inline-formula><mml:math id="inf238"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> based on approximate genotype probabilities. We therefore introduce an additional auxiliary variable <inline-formula><mml:math id="inf239"><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:math></inline-formula> representing the entire set of expected fitness values <inline-formula><mml:math id="inf240"><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> computed over all lineages, sites and states. Using this notation, <inline-formula><mml:math id="inf241"><mml:mrow><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:math></inline-formula>. By summing over all possible root states at site <inline-formula><mml:math id="inf242"><mml:mi>k</mml:mi></mml:math></inline-formula> (and conditioning on survival), we can then compute:<disp-formula id="equ21"><label>(21)</label><mml:math id="m21"><mml:mrow><mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:munderover><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:munderover><mml:mrow><mml:mi>q</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>⁢</mml:mo><mml:mfrac><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mi>u</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:munderover><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:munderover><mml:mrow><mml:mi>q</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>⁢</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mrow></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>Likewise, we can compute the conditional probability density <inline-formula><mml:math id="inf243"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> of the sequence data at site <inline-formula><mml:math id="inf244"><mml:mi>k</mml:mi></mml:math></inline-formula> given the tree:<disp-formula id="equ22"><label>(22)</label><mml:math id="m22"><mml:mrow><mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>We already know <inline-formula><mml:math id="inf245"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> from above but now need the tree density <inline-formula><mml:math id="inf246"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>. This can easily be computed using a birth-death process where the birth rate of each lineage at any time <inline-formula><mml:math id="inf247"><mml:mi>t</mml:mi></mml:math></inline-formula> is always rescaled by its expected fitness <inline-formula><mml:math id="inf248"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> contained within <inline-formula><mml:math id="inf249"><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:math></inline-formula>.</p><p>We can now compute the joint density <inline-formula><mml:math id="inf250"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> for all sites. Because each site is conditionally independent of all other sites given <inline-formula><mml:math id="inf251"><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:math></inline-formula>, we can factor <inline-formula><mml:math id="inf252"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> into a product of densities for <inline-formula><mml:math id="inf253"><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:math></inline-formula> at each site and the density of the entire tree <inline-formula><mml:math id="inf254"><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi></mml:math></inline-formula>:<disp-formula id="equ23"><label>(23)</label><mml:math id="m23"><mml:mrow><mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>⁢</mml:mo><mml:mrow><mml:munderover><mml:mo largeop="true" movablelimits="false" symmetric="true">∏</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>L</mml:mi></mml:munderover><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mrow></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>We can thus approximate the joint likelihood of the sequence data and the phylogeny <inline-formula><mml:math id="inf255"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> as <inline-formula><mml:math id="inf256"><mml:mrow><mml:mi>p</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi class="ltx_font_mathcaligraphic">𝒯</mml:mi><mml:mo>,</mml:mo><mml:mrow><mml:msub><mml:mi class="ltx_font_mathcaligraphic">𝒮</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo lspace="2.5pt" rspace="2.5pt" stretchy="false">|</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>,</mml:mo><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>. This allows us to consider how selection shapes sequence evolution at each site while simultaneously considering how the fitness effects of mutations at multiple sites act together to shape the phylogeny. As (<xref ref-type="disp-formula" rid="equ23">Equation 23</xref>) makes clear though, the goodness of our approximation depends on how well the fitness values in <inline-formula><mml:math id="inf257"><mml:mi class="ltx_font_mathcaligraphic">ℱ</mml:mi></mml:math></inline-formula> are approximated, which in turn depends on how well we can approximate genotypes based on the marginal site probabilities. We explore the goodness of these approximations in the Results section.</p></sec><sec id="s2-7"><title>Implementation</title><p>We first implemented the marginal fitness birth-death (MFBD) model in Matlab version R2017b. The Matlab implementation was used to test how well the MFBD model can approximate likelihoods and genotype probabilities relative to the exact multi-type birth death model tracking all possible genotypes for a simple model with only four genotypes. For statistical inference, the MFBD was implemented as an add-on package for BEAST 2 (<xref ref-type="bibr" rid="bib3">Bouckaert et al., 2014</xref>) named Lumière, which extends the existing BDMM package for multi-type birth-death models (<xref ref-type="bibr" rid="bib22">Kühnert et al., 2016</xref>). BEAST two is a general software platform that allows a wide range of evolutionary models including birth-death models to be fit to phylogenetic trees while jointly inferring the phylogeny using Bayesian MCMC sampling. The BEAST 2 implementation of Lumière therefore allows the joint posterior distribution of all parameters in the MFBD model and the phylogeny to be estimated from sequence data. Source code for Lumière and the Matlab implementation are freely available at <ext-link ext-link-type="uri" xlink:href="https://github.com/davidrasm/Lumiere">https://github.com/davidrasm/Lumiere</ext-link>.</p></sec><sec id="s2-8"><title>Simulations</title><p>To test the statistical performance of our approach, mock phylogenies and sequence data were simulated under a birth-death-mutation-sampling process using a variant of the Gillespie stochastic simulation algorithm (<xref ref-type="bibr" rid="bib11">Gillespie, 2007</xref>) that recorded the ancestry of all individuals in the population. A binary sequence was associated with each lineage and allowed to mutate with a constant per-site mutation rate <inline-formula><mml:math id="inf258"><mml:mi>γ</mml:mi></mml:math></inline-formula>. Mutations could alter the fitness of a lineage by either increasing or decreasing its birth rate according to site-specific fitness effects. At death events, lineages were sampled with probability <inline-formula><mml:math id="inf259"><mml:mi>s</mml:mi></mml:math></inline-formula>, in which case they were included in the mock phylogeny. Code for these simulations is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/davidrasm/Lumiere/tree/master/sim">https://github.com/davidrasm/Lumiere/tree/master/sim</ext-link> (<xref ref-type="bibr" rid="bib38">Rasmussen, 2019</xref>; copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/Lumiere">https://github.com/elifesciences-publications/Lumiere</ext-link>).</p></sec><sec id="s2-9"><title>Ebola analysis</title><p>We used the Lumière implementation of the MFBD model to estimate the fitness effects of amino acid mutations previously identified to increase the infectivity of Ebola virus in human cell lines (<xref ref-type="bibr" rid="bib5">Diehl et al., 2016</xref>; <xref ref-type="bibr" rid="bib48">Urbanowicz et al., 2016</xref>). We reanalyzed a set of 1610 whole genome EBOV sequences sampled from Guinea, Sierra Leone and Liberia in 2014 to 2016. The sequence alignment along with the time-calibrated molecular phylogeny we used for our analysis were downloaded from <ext-link ext-link-type="uri" xlink:href="https://github.com/ebov/space-time/tree/master/Data">https://github.com/ebov/space-time/tree/master/Data</ext-link>.</p><p>(<xref ref-type="bibr" rid="bib48">Urbanowicz et al., 2016</xref>) measured the fitness effects of 17 viral genotypes carrying 18 different amino acid mutations in either single, double or triple mutant backgrounds relative to the Makona genotype first sampled at the beginning of the epidemic. Because our methods cannot estimate fitness effects of mutations at very low frequencies, we only analyzed 9 of these mutations that were present in at least 10 of the 1610 viral samples. Preliminary analysis revealed that these mutations fall within eight unique genetic backgrounds because of the way mutations are nested within other single or double mutant lineages in the phylogeny. Because the data of <xref ref-type="bibr" rid="bib48">Urbanowicz et al. (2016)</xref> strongly suggest that epistatic interactions between mutations affect viral fitness, we estimated the genotypic fitness <inline-formula><mml:math id="inf260"><mml:msub><mml:mi>f</mml:mi><mml:mi>g</mml:mi></mml:msub></mml:math></inline-formula> of these eight major genotypes rather than site-specific fitness effects <inline-formula><mml:math id="inf261"><mml:mi>σ</mml:mi></mml:math></inline-formula>. We therefore used the MFBD to track sequence evolution at each site, but used (<xref ref-type="disp-formula" rid="equ13">Equation 13</xref>) to marginalize over these genotypes when approximating the fitness of a lineage.</p><p>We estimated the fitness of each genotype relative to the Makona genotype, assuming a uniform <inline-formula><mml:math id="inf262"><mml:mrow><mml:mo stretchy="false">[</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>2</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:math></inline-formula> prior distribution on these fitness values. For the other parameters in the model, we assumed a fixed death or removal rate <inline-formula><mml:math id="inf263"><mml:mi>d</mml:mi></mml:math></inline-formula> of 0.1667 per day based on earlier estimates (<xref ref-type="bibr" rid="bib12">Gire et al., 2014</xref>; <xref ref-type="bibr" rid="bib42">Stadler et al., 2014</xref>). Sampling was modeled as occurring upon removal, with the sampling proportion <inline-formula><mml:math id="inf264"><mml:mi>s</mml:mi></mml:math></inline-formula> set to zero before March 2014, when the first sample was collected. After March 2014, we assumed a fixed sampling proportion of 0.056, reflecting the fact that the dataset included samples from 1610 individuals out of the 28,652 probable cases reported by the WHO (<xref ref-type="bibr" rid="bib50">WHO, 2016</xref>). Lastly, we assumed a constant amino acid mutation rate over all sites with an exponential prior on both the forward and backward mutation rate with a mean rate of 2 × 10<sup><bold>−</bold>3</sup> per site per year. We also ran a second analysis where we included the geographic locations of lineages (Guinea, Sierra Leone and Liberia) as an additional evolving character state in our model. In this analysis, we estimated the effect of geographic location on transmission rates in Sierra Leone and Liberia relative to the base transmission rate in Guinea. Both analyses can be reproduced in Lumière with the XML input files available at <ext-link ext-link-type="uri" xlink:href="https://github.com/davidrasm/Lumiere/tree/master/ebola">https://github.com/davidrasm/Lumiere/tree/master/ebola</ext-link>.</p></sec><sec id="s2-10"><title>Influenza H3N2 analysis</title><p>We used the Lumière implementation of the MFBD model to estimate the fitness effects of amino acid mutations in the hemagglutinin (HA) protein of human influenza virus subtype H3N2. In order to ensure our fitness estimates were directly comparable to the mutational fitness effects previously estimated by <xref ref-type="bibr" rid="bib24">Lee et al. (2018)</xref>, we focused our analysis on viral samples in the same antigenic cluster as the A/Perth/16/2009 strain studied by Lee et al. for two reasons. First, <xref ref-type="bibr" rid="bib24">Lee et al. (2018)</xref> showed that the fitness effects of amino acid mutations in HA vary depending on the genetic background, with greater fitness differences between more divergent strains. We therefore only considered strains with low genetic divergence from A/Perth/16/2009. Second, the deep mutational scanning experiments were performed in cell culture, and therefore do not reflect the antigenic component of viral fitness in the human population. Only considering a single antigenic cluster therefore minimizes the effect of antigenic mutations.</p><p>To further minimize additional background variation in fitness due to geography, we only considered samples collected in the United States from January 2009 to the end of 2012. Overall, we downloaded 2150 sequences from the Influenza Research Database (<ext-link ext-link-type="uri" xlink:href="https://www.fludb.org/">https://www.fludb.org/</ext-link>) that met these criteria. Nucleotide sequences of the HA segment were aligned in Muscle (<xref ref-type="bibr" rid="bib6">Edgar, 2004</xref>) and a maximum likelihood phylogenetic tree was estimated in RAxML (<xref ref-type="bibr" rid="bib44">Stamatakis, 2014</xref>) using a GTR + Gamma substitution model. To get a time-calibrated phylogeny, branch lengths in the ML tree were converted into units of real calendar time with Least Squares Dating v0.3 (<xref ref-type="bibr" rid="bib46">To et al., 2016</xref>) using a previously estimated molecular clock rate for the HA segment of H3N2 of 5.72 x 10<sup>−3</sup> substitutions per site per year (<xref ref-type="bibr" rid="bib36">Rambaut et al., 2008</xref>).</p><p>In our first analysis, we estimated mutational fitness effects from the H3N2 phylogeny under the MFBD model assuming that fitness effects are multiplicative across sites, as in (<xref ref-type="disp-formula" rid="equ14">Equation 14</xref>). Because of the large number of naturally occurring mutations in the HA sequences, we limited our analyses to the 17 most abundant amino acid mutations that were present in more than 10% of the sampled sequences. To compare our estimates of population-level fitness effects to fitness effects measured in vitro, we converted the relative amino acid preferences at each site from the deep mutational scanning experiments to mutational fitness effects:<disp-formula id="equ24"><label>(24)</label><mml:math id="m24"><mml:mrow><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mi>l</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>⁢</mml:mo><mml:mfrac><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf265"><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the relative preference for amino acid <inline-formula><mml:math id="inf266"><mml:mi>i</mml:mi></mml:math></inline-formula> at site <inline-formula><mml:math id="inf267"><mml:mi>k</mml:mi></mml:math></inline-formula>. To compute these fitness effects, we used the averaged relative amino acid preferences reported in Dataset S3 of <xref ref-type="bibr" rid="bib24">Lee et al. (2018)</xref>.</p><p>In our second analysis, we used the relative preference data from the deep mutational scanning experiments to predict the population-level fitness of viral lineages. For this analysis, we considered all naturally occurring mutations in the HA protein that were present in at least 10 samples. In all, the fitness effects of 67 mutations distributed across 56 sites were included. To map relative amino acid preferences across multiple sites to population-level fitness, we assume that the mutational fitness effects computed from the relative amino acid preferences are additive on a log<sub>2</sub> scale, such that the fitness <inline-formula><mml:math id="inf268"><mml:msub><mml:mi>f</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> of a lineage is:<disp-formula id="equ25"><label>(25)</label><mml:math id="m25"><mml:mrow><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo maxsize="120%" minsize="120%">(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mrow><mml:mi>α</mml:mi><mml:mo>⁢</mml:mo><mml:mrow><mml:munderover><mml:mo largeop="true" movablelimits="false" symmetric="true">∑</mml:mo><mml:mi>k</mml:mi><mml:mi>L</mml:mi></mml:munderover><mml:mrow><mml:mi>l</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>⁢</mml:mo><mml:mfrac><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow></mml:mrow></mml:mrow></mml:mrow><mml:mo maxsize="120%" minsize="120%">)</mml:mo></mml:mrow><mml:mi>κ</mml:mi></mml:msup></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>Here, <inline-formula><mml:math id="inf269"><mml:mi>α</mml:mi></mml:math></inline-formula> is a linear scaling term that allows us to calibrate population-level fitness in terms of the sum of the site-specific fitness effects. We also include the scaling exponent <inline-formula><mml:math id="inf270"><mml:mi>κ</mml:mi></mml:math></inline-formula> to account for curvature in the fitness landscape, as might be expected to arise if mutations interact globally through synergistic (<inline-formula><mml:math id="inf271"><mml:mrow><mml:mi>κ</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math></inline-formula>) or antagonistic (<inline-formula><mml:math id="inf272"><mml:mrow><mml:mi>κ</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math></inline-formula>) epistatic effects across sites (<xref ref-type="bibr" rid="bib7">Elena et al., 2010</xref>). A complete list of the HA mutations considered, their fitness effects predicted by DMS and the XML input file needed to reproduce our analysis are available at <ext-link ext-link-type="uri" xlink:href="https://github.com/davidrasm/Lumiere/tree/master/influenzaH3N2">https://github.com/davidrasm/Lumiere/tree/master/influenzaH3N2</ext-link>.</p></sec></sec><sec id="s3" sec-type="results"><title>Results</title><sec id="s3-1"><title>The four genotype model</title><p>We first consider a simple model of molecular evolution in order to compare the marginal fitness birth-death (MFBD) model against the exact multi-type birth-death (MTBD) model tracking all genotypes. Specifically, we consider a binary evolving sequence of length <inline-formula><mml:math id="inf273"><mml:mrow><mml:mi>L</mml:mi><mml:mo>=</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:math></inline-formula> where all mutations are deleterious and carry a selective fitness cost <inline-formula><mml:math id="inf274"><mml:mi>σ</mml:mi></mml:math></inline-formula>. Fitness effects of individual mutations act multiplicatively, such that the double mutant has fitness <inline-formula><mml:math id="inf275"><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:mi>σ</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:math></inline-formula>. With this simple model, it is therefore possible to track the evolutionary dynamics of all four genotypes (<inline-formula><mml:math id="inf276"><mml:mrow><mml:mi class="ltx_font_mathcaligraphic">𝒢</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mn>00</mml:mn><mml:mo>,</mml:mo><mml:mn>01</mml:mn><mml:mo>,</mml:mo><mml:mn>10</mml:mn><mml:mo>,</mml:mo><mml:mn>11</mml:mn><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula>) under both models.</p><p><xref ref-type="fig" rid="fig2">Figure 2A</xref> shows a phylogeny simulated under the four genotype model, colored according to the genotype of each lineage. We computed the joint likelihood that this tree and observed tip genotypes evolved under a range of different fitness values <inline-formula><mml:math id="inf277"><mml:mi>σ</mml:mi></mml:math></inline-formula> for both the exact MTBD and approximate MFBD models (<xref ref-type="fig" rid="fig2">Figure 2B</xref>). The likelihood profiles under both models peak around the true value of <inline-formula><mml:math id="inf278"><mml:mi>σ</mml:mi></mml:math></inline-formula> and closely match at lower values of <inline-formula><mml:math id="inf279"><mml:mi>σ</mml:mi></mml:math></inline-formula>, but begin to diverge at higher values. The probability of a single hypothetical lineage being in each genotype approximated under the MFBD model is also shown against the exact genotype probabilities computed under the MTBD in (<xref ref-type="fig" rid="fig2">Figure 2C</xref>).</p><fig id="fig2" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.003</object-id><label>Figure 2.</label><caption><title>Performance of the MFBD approximation under the four genotype model.</title><p>(<bold>A</bold>) Simulated phylogeny showing the genotype of each lineage through time. (<bold>B</bold>) Joint likelihood of the phylogeny and tip genotypes under different values of <inline-formula><mml:math id="inf280"><mml:mi>σ</mml:mi></mml:math></inline-formula> using the the approximate MFBD (solid line) or the exact MTBD model (dotted line). The vertical blue line marks the true parameter value. (<bold>C</bold>) The normalized probability of a single hypothetical lineage being in each genotype back through time based on the MFBD approximation (solid line) versus the exact MTBD model (dotted line) with <inline-formula><mml:math id="inf281"><mml:mrow><mml:mi>σ</mml:mi><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn></mml:mrow></mml:math></inline-formula>. Note that the probabilities for genotypes 10 and 01 are identical. All parameters besides <inline-formula><mml:math id="inf282"><mml:mi>σ</mml:mi></mml:math></inline-formula> were fixed at <inline-formula><mml:math id="inf283"><mml:mrow><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mn>0.25</mml:mn></mml:mrow></mml:math></inline-formula>, <inline-formula><mml:math id="inf284"><mml:mrow><mml:mi>d</mml:mi><mml:mo>=</mml:mo><mml:mn>0.05</mml:mn></mml:mrow></mml:math></inline-formula>, <inline-formula><mml:math id="inf285"><mml:mrow><mml:mi>s</mml:mi><mml:mo>=</mml:mo><mml:mn>0.05</mml:mn></mml:mrow></mml:math></inline-formula>. The mutation rate <inline-formula><mml:math id="inf286"><mml:mi>γ</mml:mi></mml:math></inline-formula> was symmetric between forward and backwards mutations and fixed at 0.05.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-45562-fig2-v3.tif"/></fig><p>Because the MFBD approximates the probability of a lineage being in each genotype based on the marginal sites probabilities, we also compared how well the MFBD model approximates the genotype probability densities <inline-formula><mml:math id="inf287"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> relative to the exact multi-type birth-death model. Recall that <inline-formula><mml:math id="inf288"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> provides the probability that the subtree descending from a lineage <inline-formula><mml:math id="inf289"><mml:mi>n</mml:mi></mml:math></inline-formula> has evolved exactly as observed, and therefore forms the foundation of all likelihood calculations under our model. Averaged over all genotypes, the error introduced by approximating <inline-formula><mml:math id="inf290"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> under the MFBD model is greatest at intermediate mutation rates (<xref ref-type="fig" rid="fig3">Figure 3A</xref>). When there is no selection (<inline-formula><mml:math id="inf291"><mml:mrow><mml:mi>σ</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula>), the MFBD introduces no error, but the error increases as the strength of selection increases (<xref ref-type="fig" rid="fig3">Figure 3B</xref>). We can also consider a variant of the four genotype model where each of the single mutant genotypes is neutral with <inline-formula><mml:math id="inf292"><mml:mrow><mml:mi>σ</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula> but an epistatic interaction between the two sites causes the double mutant to be deleterious with some fitness cost <inline-formula><mml:math id="inf293"><mml:mi>ϵ</mml:mi></mml:math></inline-formula>. Again, the error introduced by the MFBD grows as the strength of the epistatic fitness effect increases (<xref ref-type="fig" rid="fig3">Figure 3C</xref>).</p><fig id="fig3" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.004</object-id><label>Figure 3.</label><caption><title>The error introduced by approximating genotype probabilities under the MFBD model.</title><p>(<bold>A–C</bold>) The error introduced by approximating the genotype probability densities <inline-formula><mml:math id="inf294"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> based on the marginal sites probabilities under the MFBD model for different mutation rates (<bold>A</bold>), strengths of selection (<bold>B</bold>), and epistatic fitness effects (<bold>C</bold>). The solid line represents the MFBD approximation with fitness effects coupled across sites whereas the dashed line represents a more naive approximation that ignores the fitness effects of other sites entirely. The mean error represents the time-integrated average over all genotypes. (<bold>D–F</bold>) Normalized <inline-formula><mml:math id="inf295"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> probabilities for a single hypothetical lineage being in each genotype back through time based on the MFBD approximation (solid line) versus the exact MTBD model (dotted line). Each plot shows the dynamics of <inline-formula><mml:math id="inf296"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> for the parameter values marked by asterisks in the plots immediately above. Other parameters are fixed at <inline-formula><mml:math id="inf297"><mml:mrow><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mn>0.25</mml:mn></mml:mrow></mml:math></inline-formula>, <inline-formula><mml:math id="inf298"><mml:mrow><mml:mi>d</mml:mi><mml:mo>=</mml:mo><mml:mn>0.05</mml:mn></mml:mrow></mml:math></inline-formula>, <inline-formula><mml:math id="inf299"><mml:mrow><mml:mi>s</mml:mi><mml:mo>=</mml:mo><mml:mn>0.05</mml:mn></mml:mrow></mml:math></inline-formula>.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-45562-fig3-v3.tif"/></fig><p>Taken together, these results suggest that the MFBD model introduces error in <inline-formula><mml:math id="inf300"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> by ignoring correlations among sites due to the fact that selection acts at the level of genotypes, especially when epistasis is strong. The additional correlations between sites induced by selection then causes the genotype probabilities to deviate from those expected based on the marginal site probabilities. Conversely, at very high mutation rates, correlations between sites quickly break down so that sites evolve effectively independently of one another, such that the error introduced by the MFBD also decreases as the mutation rate becomes very high.</p><p>Overall, the magnitude of the error introduced by approximating the genotype probabilities is small, especially when we can compare the MFBD model against a more naive approximation that tracks sequence evolution at each site completely independent of all other sites by setting the expected marginal fitness <inline-formula><mml:math id="inf301"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>σ</mml:mi></mml:mrow></mml:math></inline-formula> instead of using (<xref ref-type="disp-formula" rid="equ14">Equation 14</xref>). This approximation completely ignores how the fitness of a lineage depends on mutations at other sites, and the error in <inline-formula><mml:math id="inf302"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is generally considerably greater than under the MFBD model (<xref ref-type="fig" rid="fig3">Figure 3A–C</xref>; dashed lines). Moreover, even when the error introduced by the MFBD model is relatively large, the model still tracks the dynamics of <inline-formula><mml:math id="inf303"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> backwards through time along a lineage well (<xref ref-type="fig" rid="fig3">Figure 3D–F</xref>; for parameter values marked by the black asterisks in A-C).</p><p>The MFBD model also approximates <inline-formula><mml:math id="inf304"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula>, the probability that a lineage has no sampled descendants, using a discretized fitness space and is therefore another source of potential error. Mirroring the results for <inline-formula><mml:math id="inf305"><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, the error introduced by this approximation peaks at intermediate mutation rates while it increases monotonically with the strength of selection and epistatic fitness effects (<xref ref-type="fig" rid="fig4">Figure 4A–C</xref>). Interestingly, tracking how lineages transition between fitness classes in fitness space does not improve the approximation relative to simply ignoring changes in fitness along unobserved lineages (<xref ref-type="fig" rid="fig4">Figure 4A–C</xref>; dashed lines). The overall magnitude of error introduced by approximating <inline-formula><mml:math id="inf306"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> is also small, although using a discretized fitness space does lead to some jaggedness in the dynamics of <inline-formula><mml:math id="inf307"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> (<xref ref-type="fig" rid="fig4">Figure 4D–F</xref>). However, only when selection is very strong (<inline-formula><mml:math id="inf308"><mml:mrow><mml:mi>σ</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>0.8</mml:mn></mml:mrow></mml:math></inline-formula>) does tracking <inline-formula><mml:math id="inf309"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> in fitness space result in significant errors, and then only in the more distant past (<xref ref-type="fig" rid="fig4">Figure 4E</xref>). In this case, a lineage’s fitness in the distant past may be a poor predictor of its probability of leaving sampled descendants at a time point in the distant future because the fitness of the lineage and its descendants may greatly change over time in a way that is difficult to predict without considering the exact mutational pathways through which a lineage can move in sequence space.</p><fig id="fig4" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.005</object-id><label>Figure 4.</label><caption><title>The error introduced by approximating the probability of no sampled descendants.</title><p>(<bold>A–C</bold>) The error introduced by approximating <inline-formula><mml:math id="inf310"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> in a discretized fitness space under the MFBD model for different mutation rates (<bold>A</bold>), strengths of selection (<bold>B</bold>), and epistatic fitness effects (<bold>C</bold>). The solid line represents the approximation where lineages are allowed to transition between fitness classes whereas the dashed line represents the assumption that fitness does not change along unobserved lineages. To obtain a single <inline-formula><mml:math id="inf311"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> value comparable across both models, we summed <inline-formula><mml:math id="inf312"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> over all genotypes weighted by the exact probability of the lineage being in each genotype and then took the time-integrated average to compute the mean error. (<bold>D–F</bold>) The dynamics of <inline-formula><mml:math id="inf313"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> for a single hypothetical lineage back through time based on the MFBD approximation (solid line) versus the exact MTBD model (dotted line). Each plot shows the dynamics of <inline-formula><mml:math id="inf314"><mml:msub><mml:mi>E</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:math></inline-formula> for the parameter values marked by asterisks in the plots immediately above.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-45562-fig4-v3.tif"/></fig></sec><sec id="s3-2"><title>Estimating site-specific fitness effects</title><p>Next, we simulated phylogenies under a model where the fitness effect of the mutant allele at each site is drawn independently from a distribution of fitness effects (DFE) in order to test how well we can estimate site-specific fitness effects. Because there can be considerable uncertainty surrounding these fitness effects, we now estimate the posterior distribution of fitness effects using Bayesian MCMC. The accuracy and precision of the estimated fitness effects varies considerably across sites, as shown for a representative phylogeny with five evolving sites in <xref ref-type="fig" rid="fig5">Figure 5</xref>.</p><fig id="fig5" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.006</object-id><label>Figure 5.</label><caption><title>Estimating site-specific fitness effects.</title><p>(<bold>A</bold>) A phylogeny simulated under a model with five evolving sites each with a random fitness effect. The lineages are colored according to the number of mutations they carry (blue = 0; yellow = 5). The distribution of fitness effects was assumed to be LogNormal with a mean of 0.85 and a standard deviation of 0.32. (<bold>B</bold>) Site-specific fitness effects estimated using the marginal fitness BD model. Red lines indicate the posterior median and 95% credible intervals. Blue lines mark the true fitness effect at each site.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-45562-fig5-v3.tif"/></fig><p>In order to better understand this variability, we simulated 100 phylogenies with randomly drawn fitness effects at either 2, 5 or 10 evolving sites. Overall, the estimated posterior median fitness effects are well correlated with their true values, although the strength of this correlation decreases as the number of sites increases (<xref ref-type="fig" rid="fig6">Figure 6A–C</xref>). Coverage of the 95% credible intervals on the other hand increased from 71.0 to 72.8% to 77.4%.</p><fig id="fig6" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.007</object-id><label>Figure 6.</label><caption><title>Inference of site-specific fitness effects from simulated phylogenies.</title><p>(<bold>A–C</bold>) Correlation between the true and estimated posterior median fitness effects for phylogenies simulated with 2, 5 or 10 evolving sites. Results are aggregated over 100 simulated phylogenies, with each point representing an estimate for a single site and phylogeny. The points are colored according to the frequency of the mutant allele among sampled individuals in the phylogeny. (<bold>D</bold>) Fitness effects estimated under the exact MTBD model tracking all four possible genotypes for the same two site simulations as in A. (<bold>E</bold>) Correlation between the site-specific fitness effects estimated under the approximate MFBD and exact MTBD for the two site simulations. (<bold>F</bold>) Error and uncertainty in estimated site-specific fitness effects across all 2, 5, and 10 site simulations. Error was calculated as the posterior median estimate minus the true fitness effect. Uncertainty was calculated as the standard deviation of the posterior values sampled via MCMC. In all simulations, sites where the Effective Sample Size of the MCMC samples was below 100 (less than 5% of all sites across simulations) were discarded. The death rate was fixed at <inline-formula><mml:math id="inf315"><mml:mrow><mml:mi>d</mml:mi><mml:mo>=</mml:mo><mml:mn>0.05</mml:mn></mml:mrow></mml:math></inline-formula> but the birth, mutation and sampling rates were randomly drawn for each simulation from a prior distribution: <inline-formula><mml:math id="inf316"><mml:mrow><mml:mi>λ</mml:mi><mml:mo>∽</mml:mo><mml:mi/></mml:mrow></mml:math></inline-formula> Uniform(0.1,0.2); <inline-formula><mml:math id="inf317"><mml:mrow><mml:mi>γ</mml:mi><mml:mo>∽</mml:mo><mml:mi/></mml:mrow></mml:math></inline-formula> Exponential(0.01); <inline-formula><mml:math id="inf318"><mml:mrow><mml:mi>s</mml:mi><mml:mo>∽</mml:mo><mml:mi/></mml:mrow></mml:math></inline-formula> Uniform(0,1). Only the birth rate was jointly inferred with the site-specific fitness effects.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-45562-fig6-v3.tif"/></fig><p>While there is no systematic directional bias, fitness effects are underestimated for sites at which the mutant allele is at low frequency among sampled individuals and overestimated for sites where the mutant allele is at high frequencies. This however appears to be an intrinsic feature of estimating fitness effects from the branching structure of a phylogeny, as the same phenomena is observed under the exact MTBD model with two sites and four genotypes (<xref ref-type="fig" rid="fig6">Figure 6D</xref>), and the estimates made under the approximate MFBD model are highly correlated with estimates made under the exact MTBD model (<xref ref-type="fig" rid="fig6">Figure 6E</xref>).</p><p>Across all sites and simulations, accuracy decreased when the mutant allele at a given site was at low or high frequencies, and there was considerably more uncertainty for sites where the mutant allele was at very low frequencies (<xref ref-type="fig" rid="fig6">Figure 6F</xref>). Thus, while the MFBD model generally performs well at estimating site-specific fitness effects, the accuracy and precision of these estimates varies greatly depending on the frequency of a given mutation in a phylogeny.</p></sec><sec id="s3-3"><title>Ebola virus adaptation to humans</title><p>The Ebola virus glycoprotein (GP) binds to cells during viral cell entry and is therefore thought to be a key determinant of viral fitness in different hosts. Previously, (<xref ref-type="bibr" rid="bib48">Urbanowicz et al., 2016</xref>) analyzed a large set of naturally occurring amino acid mutations in the GP isolated from patients during the 2013–16 epidemic in Western Africa. The effect of these GP mutations on fitness were then experimentally determined using infectivity assays in cell culture. Several mutant genotypes dramatically increased viral infectivity relative to the Makona genotype isolated during the earliest stages of the epidemic. However, the effect of these mutations on viral transmission and fitness at the host population level have not yet been determined. We therefore applied the MFBD model to a large dataset of 1610 Ebola virus (EBOV) genomes sampled during the 2013–16 epidemic to infer the population-level fitness effects of these GP mutations.</p><p>We analyzed 9 out of the 18 amino acid mutations analyzed by <xref ref-type="bibr" rid="bib48">Urbanowicz et al. (2016)</xref> that were present in at least 10 of the 1610 viral samples. These nine mutations fall in eight different genetic backgrounds or genotypes (<xref ref-type="fig" rid="fig7">Figure 7</xref>). Because <xref ref-type="bibr" rid="bib48">Urbanowicz et al. (2016)</xref> found evidence for epistatic interactions between several of these mutations, we estimated the fitness of these eight genotypes rather than site-specific mutational fitness effects. <xref ref-type="table" rid="table1">Table 1</xref> shows the relative fitness of these genotypes estimated at the population-level versus their fitness in cell culture.</p><table-wrap id="table1" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.008</object-id><label>Table 1.</label><caption><title>Estimated posterior median fitness and 95% CI for the Ebola GP mutants relative to the Makona genotype</title></caption><table frame="hsides" rules="groups"><thead><tr><th>Genotype</th><th>Sample freq</th><th>Base model</th><th>Model + geo effects</th><th>Effect in cell culture</th></tr></thead><tbody><tr><td>Makona</td><td>0.036</td><td>1.00</td><td>1.00</td><td>Reference genotype</td></tr><tr><td>A82V</td><td>0.720</td><td>1.05 (1.04–1.07)</td><td>1.26 (1.19–1.35)</td><td>Increases infectivity 2X</td></tr><tr><td>P330S</td><td>0.002</td><td>0.98 (0.82–1.14)</td><td>1.11 (0.96–1.24)</td><td>Decreases infectivity</td></tr><tr><td>P330S+N107D+G480D</td><td>0.037</td><td>1.04 (0.98–1.12)</td><td>1.27 (1.16–1.39)</td><td>Increases infectivity &gt; 2X</td></tr><tr><td>A82V+R410S</td><td>0.044</td><td>1.09 (1.00–1.18)</td><td>1.31 (1.17–1.45)</td><td>No or small effect</td></tr><tr><td>A82V+R410S+K439E</td><td>0.035</td><td>1.14 (1.01–1.26)</td><td>1.36 (1.20–1.54)</td><td>Increases infectivity 2-3X</td></tr><tr><td>A82V+R29K</td><td>0.019</td><td>1.06 (0.93–1.19)</td><td>1.27 (1.10–1.45)</td><td>Increases infectivity 2-3X</td></tr><tr><td>A82V+T230A</td><td>0.026</td><td>1.03 (0.93–1.11)</td><td>1.23 (1.10–1.37)</td><td>Increases infectivity 2-3X</td></tr><tr><td>A82V+I371V</td><td>0.067</td><td>1.03 (0.98–1.09)</td><td>1.24 (1.14–1.35)</td><td>Increases infectivity 2-3X</td></tr></tbody></table></table-wrap><fig id="fig7" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.009</object-id><label>Figure 7.</label><caption><title>Relative fitness of Ebola virus genotypes circulating during the 2013–16 epidemic in Western Africa.</title><p>Ancestral fitness values were reconstructed by first finding the probability of a lineage being in each possible genotype based on the marginal site probabilities computed using (<xref ref-type="disp-formula" rid="equ20">Equation 20</xref>). Ancestral fitness values were then computed by averaging the posterior median fitness of each genotype, weighted by the probability that the lineage was in each genotype. Fitness values are given relative to the Makona genotype isolated at the start of the epidemic. Clades are labeled according to their most probable genotype.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-45562-fig7-v3.tif"/></fig><p>Mapping the genotypes and fitness of lineages inferred under the MFBD model onto the phylogeny allows us to reconstruct the series of events by which EBOV adapted to humans (<xref ref-type="fig" rid="fig7">Figure 7</xref>). Shortly after the epidemic started in 2013, the A82V mutation occurred and gave rise to lineage B, which then spread to Sierra Leone, Liberia and Mali. (<xref ref-type="bibr" rid="bib48">Urbanowicz et al., 2016</xref>) found that the A82V mutation increases infectivity by 2–3 fold in cell culture. At the population-level, this mutation appears to have a less dramatic effect, increasing transmissibility by only 5% relative to the Makona genotype. The P330S mutation appears to have temporarily decreased the fitness of the main surviving clade in lineage A, although mutations N107D and G480D later rescue the fitness of this lineage, consistent with the findings of <xref ref-type="bibr" rid="bib48">Urbanowicz et al. (2016)</xref>. Meanwhile, the R410S mutation occurred within lineage B but did not have an immediate effect on fitness. However, R410S appears to epistatically interact with mutation K439E, which occurs twice along the same lineage carrying the R410S mutation and in this genetic background increases infectivity 2–3 fold in cell culture. We estimate that the A82V+R410S+K439E genotype had the highest population-level fitness, but only increased fitness by 14% relative to the Makona genotype. Three other mutations, R29K, T230A and I371V, also occurred in the A82V genetic background, but were not estimated to have further increased the fitness of the A82V genotype.</p><p>Because the A82V mutation occurred along a lineage that spread from Guinea to Sierra Leone and several of the genotypes we considered were also geographically restricted, we performed a second analysis to check whether our estimates of genotype fitness were confounded by geographic differences in transmission rates. In this model, we accounted for geographic effects by including location (Guinea, Sierra Leone or Liberia) as an additional evolving character state or ‘site’ in the model. We found no evidence that transmission rates differed by location; relative transmission rates were 1.01 (95% CI: 0.97–1.05) in Sierra Leone and 0.99 (95% CI: 0.94–1.04) in Liberia compared with Guinea. All mutant genotypes had higher estimated fitness relative to the Makona genotype under the model with geographic effects due to a lower estimated fitness of the Makona genotype. However, the rank order of genotypic fitness values is consistent across models (<xref ref-type="table" rid="table1">Table 1</xref>). Overall, the population level fitness of all eight genotypes agree with their fitness in cell culture in terms of the sign or direction of their effects, but these genotypes had much greater fitness relative to the Makona genotype in cell culture than at the population level.</p></sec><sec id="s3-4"><title>Influenza H3N2 fitness variation</title><p>We also applied the MFBD model to estimate the fitness effects of mutations in the hemagglutinin (HA) protein of human influenza virus subtype H3N2. <xref ref-type="bibr" rid="bib24">Lee et al. (2018)</xref> recently estimated the relative preference for each amino acid residue at all sites in the HA protein in cell culture using a reverse genetics approach known as deep mutational scanning (DMS). The fitness effect of mutating one amino acid to another is expected to correlate strongly with the relative preference for each amino acid in these experiments. We therefore sought to compare the population-level fitness effects of naturally occurring mutations estimated under the MFBD model with their fitness measured in vitro by DMS.</p><p>To minimize the effect of antigenic mutations, which would not be reflected in the DMS experiments, we limited our analysis to viral lineages in the same antigenic cluster as the A/Perth/16/2009 strain studied by <xref ref-type="bibr" rid="bib24">Lee et al. (2018)</xref>. We first estimated the fitness effects of the 17 most abundant mutations that reached a frequency of 10% or greater among viruses sampled in the United States between 2009 and 2012. We found no apparent relationship between the estimated population-level fitness effects of these mutations and their in vitro effects, although there is agreement that most of these mutations are nearly neutral (<xref ref-type="fig" rid="fig8">Figure 8A</xref>). Although the 95% credible intervals on our estimates are narrow, these results need to be interpreted with extreme caution because our MCMC algorithm never converged on a stable posterior distribution for several mutations (Effective Sample Size &lt; 10) due to strong correlations between mutations in their estimated fitness effects. This is likely due to the fact that many of these mutations occur only once in the phylogeny and share the same ancestry and therefore genetic background as other mutations in the phylogeny (<xref ref-type="fig" rid="fig8">Figure 8B</xref>).</p><fig id="fig8" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.010</object-id><label>Figure 8.</label><caption><title>Influenza H3N2 mutational fitness effects.</title><p>(<bold>A</bold>) The fitness effects of mutations estimated in vitro using deep mutational scanning versus their estimated population-level effects. In vitro fitness effects were quantified as the relative preference for the mutant versus the consensus amino acid residue in the deep mutational scanning experiments, given on a log<sub>2</sub> scale. Population-level fitness effects were estimated using the MFBD model assuming multiplicative effects across sites. Error bars show the 95% credible intervals on the estimated population-level fitness effects. (<bold>B</bold>) Coancestry matrix showing the fraction of ancestry shared between each pair of mutations in the H3N2 phylogeny. The coancestry value represents the fraction of branches in the phylogeny that share both mutations based on a maximum parsimony reconstruction. The diagonal gives the fraction of all branches in the phylogeny with each individual mutation.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-45562-fig8-v3.tif"/></fig><p>While our population-level estimates did not correlate with the in vitro data, the fitness effects predicted by DMS correlate strongly with the maximum frequency that naturally occurring mutations reach in the human population (<xref ref-type="bibr" rid="bib24">Lee et al., 2018</xref>). We therefore sought to test whether using the DMS experimental data to inform the MFBD model about the fitness effects of mutations, rather than estimating them independently from the phylogeny, would result in a better fit of the model to the H3N2 phylogeny and sequence data. Doing so requires a fitness model that aggregates mutational fitness effects across sites and then maps this combined fitness to the population-level fitness of a lineage. In our model, we sum the mutational fitness effects predicted by the relative amino acid preferences across all sites to get a composite predictor of fitness: <inline-formula><mml:math id="inf319"><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>D</mml:mi><mml:mo>⁢</mml:mo><mml:mi>M</mml:mi><mml:mo>⁢</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:msubsup><mml:mo largeop="true" symmetric="true">∑</mml:mo><mml:mi>k</mml:mi><mml:mi>L</mml:mi></mml:msubsup><mml:mrow><mml:mi>l</mml:mi><mml:mo>⁢</mml:mo><mml:mi>o</mml:mi><mml:mo>⁢</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>⁢</mml:mo><mml:mfrac><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow></mml:mrow></mml:mrow></mml:math></inline-formula>. We then use (<xref ref-type="disp-formula" rid="equ25">Equation 25</xref>) to map <inline-formula><mml:math id="inf320"><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>D</mml:mi><mml:mo>⁢</mml:mo><mml:mi>M</mml:mi><mml:mo>⁢</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> to overall population-level fitness.</p><p>Fitting our model to the H3N2 phylogeny allows us to calibrate how the mutational fitness effects based on relative preferences scale to population-level fitness. Overall, large changes in <inline-formula><mml:math id="inf321"><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>D</mml:mi><mml:mo>⁢</mml:mo><mml:mi>M</mml:mi><mml:mo>⁢</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, resulting from mutations to more or less preferred amino acid residues, have a relatively small impact on population-level fitness. Population-level fitness grows slowly and roughly linearly with mutations to more preferred amino acids (<xref ref-type="fig" rid="fig9">Figure 9</xref>; inset). Nevertheless, when mutational fitness effects are aggregated across all sites, there are substantial fitness differences between lineages (<xref ref-type="fig" rid="fig9">Figure 9</xref>). Relative to a hypothetical lineage bearing the consensus sequence, fitness ranges from 0.84 to 1.04 across lineages with many lineages having a relative fitness less than one, indicating a slightly deleterious mutation load. Accounting for these fitness differences results in the MFBD model informed by the DMS data fitting the H3N2 phylogeny substantially better (Log likelihood: −4184) than a model assuming all mutations are neutral (Log likelihood: −7510). As would be expected, lineages predicted to be more fit also tend to persist between influenza seasons. Most notably, a lineage with higher than average fitness circulates in 2009 and 2010 during the H1N1 pandemic. This lineages carries the T228A mutation, which is predicted to have a large beneficial effect in the DMS experiments. It is therefore tempting to speculate that this mutation may have conferred an advantage that helped seasonal H3N2 compete with the pandemic H1N1 virus.</p><fig id="fig9" position="float"><object-id pub-id-type="doi">10.7554/eLife.45562.011</object-id><label>Figure 9.</label><caption><title>Relative fitness of influenza H3N2 lineages circulating in the United States between 2009 and 2012.</title><p>Fitness values were reconstructed based on a fitness model that maps mutational fitness effects predicted based on deep mutational scanning experiments to population level fitness. The inset shows this fitness mapping for the model parameters with the highest posterior probability: <inline-formula><mml:math id="inf322"><mml:mrow><mml:mi>α</mml:mi><mml:mo>=</mml:mo><mml:mn>0.0098</mml:mn></mml:mrow></mml:math></inline-formula> and <inline-formula><mml:math id="inf323"><mml:mrow><mml:mi>κ</mml:mi><mml:mo>=</mml:mo><mml:mn>0.964</mml:mn></mml:mrow></mml:math></inline-formula>. Uncertainty in ancestral amino acid sequences was taken into account by first computing the marginal site probability at each site. Ancestral fitness values were then reconstructed by marginalizing over all possible ancestral sequences using the marginal site probabilities.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-45562-fig9-v3.tif"/></fig></sec></sec><sec id="s4" sec-type="discussion"><title>Discussion</title><p>Many assumptions are made in phylogenetics to model molecular evolution in a statistically tractable way. Historically, one of the most pervasive yet biologically questionable of these assumptions has been that sequences evolve neutrally along lineages, such the mutations do not feedback and alter the branching process shaping the phylogeny. Our marginal fitness birth-death (MFBD) model allows us to relax this core assumption in order to consider how non-neutral evolution at multiple sites affects sequence evolution, the fitness of lineages, and the overall branching structure of a phylogeny. While our approach is not exact in that it approximates genotype probabilities by assuming sites evolve independently when computing the marginal fitness of a lineage, we have shown that this approximation generally works well and only produces significant errors in rather extreme situations, such as the four genotype model with very strong selection or epistasis. While an earlier approach based on birth-death models allowed for lineage-specific fitness values to be inferred from the branching pattern of a phylogeny (<xref ref-type="bibr" rid="bib29">Neher et al., 2014</xref>), this approach did not connect fitness back to the mutational process nor allow for the fitness effects of individual mutations or genotypes to be estimated. Using our approach, we demonstrated that the fitness effects of specific mutations can be estimated from simulated phylogenies under the MFBD with accuracy comparable to an exact multi-type birth death model. The MFBD model therefore provides a new, statistically powerful way of incorporating adaptive molecular evolution into phylodynamics.</p><p>The MFBD model allows us to exploit phylogenetic information about adaptive evolution that most methods for inferring selection from patterns in sequence data ignore. Currently, codon-substation models (<xref ref-type="bibr" rid="bib13">Goldman and Yang, 1994</xref>; <xref ref-type="bibr" rid="bib28">Muse and Gaut, 1994</xref>) and the related class of mutation-selection models (<xref ref-type="bibr" rid="bib51">Yang and Nielsen, 2008</xref>) are by far the most widely used approach for inferring selection. These approaches rely on comparing sequence substitution patterns such as the dN/dS ratio of non-synonymous to synonymous substitutions across sites. These approaches can be very powerful when sequences from highly divergent taxa are compared, such that enough time has elapsed for multiple substitutions at a single site to have accumulated between lineages. But on the shorter timescales relevant to evolution within a population, substitution patterns like the dN/dS ratio are relatively insensitive to selection pressures and may produce misleading inferences of selection (<xref ref-type="bibr" rid="bib21">Kryazhimskiy and Plotkin, 2008</xref>). For example, a highly beneficial non-synonymous mutation that occurs in a single lineage and then spreads through a population may produce a very low dN/dS ratio, indicative of purifying selection rather than adaptive evolution. In contrast, comparing the evolutionary dynamics of lineages with and without the mutation allows us to infer if that mutation confers a competitive advantage. Thus, considering the branching pattern of phylogenies provides additional information about molecular evolution not visible from substitution patterns in sequence data alone.</p><p>While new technologies increasingly allow researchers to quantify mutational fitness effects in vitro or even in vivo (<xref ref-type="bibr" rid="bib52">Zanini and Neher, 2013</xref>; <xref ref-type="bibr" rid="bib45">Thyagarajan and Bloom, 2014</xref>), how fitness measured in the lab translates to fitness in nature is largely unknown. This is especially pertinent for emerging pathogens whose epidemic potential often depends on new adaptive mutations (<xref ref-type="bibr" rid="bib1">Antia et al., 2003</xref>; <xref ref-type="bibr" rid="bib25">Longdon et al., 2014</xref>). Phylodynamic approaches like the MFBD model that can quantify fitness at the host population level are therefore greatly needed, as they offer a means to assess the epidemiological significance of mutant lineages. Extrapolating from our experience with Ebola, where the population-level fitness effects of each mutant genotype we considered matched the sign of their effect in cell culture, we suspect that fitness measured in the lab will generally agree with fitness in nature. This seems reasonable, as mutations that increase replication or cellular infectivity within hosts should generally promote transmissibility between hosts (e.g. <xref ref-type="bibr" rid="bib33">Quinn et al., 2000</xref>; <xref ref-type="bibr" rid="bib10">Fraser et al., 2007</xref>). But at the same time, there is no reason to believe that transmission rates will increase linearly or even monotonically with increasing within-host growth rates. We therefore expect that the magnitude of fitness effects might often greatly differ across scales, as we found for the A82V glycoprotein mutation in Ebola. While A82V doubles infectivity in cell culture, we estimated that it only increases transmissibility at the population level by 5% (95% CI: 4–7%). Interestingly, (<xref ref-type="bibr" rid="bib5">Diehl et al., 2016</xref>) found that A82V only slightly increases viral titers in Ebola patients, which is likely a much better proxy for transmissibility than cellular infectivity, lending support to our more moderate estimates at the population level.</p><p>For influenza, we were unable to reliably estimate the fitness effects of individual mutations from the H3N2 phylogeny. We believe that these inference problems likely stem from the fact that many of these mutations occur only once in the phylogeny and in the same genetic background as other mutations in the HA protein. The shared phylogenetic ancestry of mutations creates an identifiability problem akin to the problem of collinearity in more standard regression-type models. In either case, the individual effects of highly correlated variables are difficult or impossible to infer. Nevertheless, including the mutational fitness effects predicted by deep mutational scanning experiments improved the fit of the MFBD model to the H3N2 phylogeny by thousands of log likelihood units. Accounting for these fitness effects in the MFBD model also revealed substantial variation in population-level fitness among viral lineages within a single antigenic cluster. Most lineages were reconstructed to have a slightly deleterious mutation load, consistent with earlier reports that background variation in fitness arising from deleterious mutations, not just antigenic mutations, plays a large role in determining which H3N2 lineages ultimately persist (<xref ref-type="bibr" rid="bib17">Illingworth and Mustonen, 2012</xref>; <xref ref-type="bibr" rid="bib26">Luksza and Lässig, 2014</xref>; <xref ref-type="bibr" rid="bib20">Koelle and Rasmussen, 2015</xref>). Moreover, the fitness variation uncovered by our analysis likely represents only the ‘tip of the iceberg’, since there are likely mutations in other genomic segments besides HA with large fitness effects (<xref ref-type="bibr" rid="bib35">Raghwani et al., 2017</xref>), which we did not consider.</p><p>The influenza analysis highlights some of the inevitable difficulties encountered when inferring mutational fitness effects from phylogenies. Increasing the number of sites under consideration also increases the complexity of the genetic background in which mutations occur due to the increased probability of mutations being linked to other mutations rather than occurring in isolation. This leads to strong correlations between the fitness effects of different sites in an increasingly high dimensional parameter space, making statistical inference challenging, especially using MCMC methods. Spurious correlations may also arise due to additional, unmodeled sources of fitness variation. For example, if a mutation occurs coincidently with another beneficial mutation or the mutation occurs by chance along a lineage spreading through a higher fitness environment, it will likely be inferred to increase fitness even if it is actually neutral. In the future, the MFBD should therefore be extended to account for unmodeled sources of fitness variation. For example, each lineage could be assigned a random fitness effect representing the unmodeled components of fitness variation. These random effects could then be modeled as a continuous trait evolving along lineages, such that more closely related lineages would be expected to have similar fitness and overly large changes between closely related lineages would be penalized. Such a model would then allow us to say whether a fitness effect attributed to a particular mutation could be equally well explained by random effects arising from unmodeled fitness variation. Until such a principled approach is implemented, the fitness effects of individual mutations need to be interpreted carefully unless they occur in multiple genetic backgrounds and confounding sources of fitness variation can be accounted for, as we tried to do for Ebola by including potentially confounding geographic fitness effects.</p><p>In spite of these shortcomings, we believe the MFBD model offers a powerful means to explore many questions not previously possible with strictly neutral phylodynamic models. Even if the fitness effects of individual mutations are not identifiable, it may still be possible to infer the distribution of fitness effects across sites, a key determinant of adaptive evolution that has only been explored in a few systems (<xref ref-type="bibr" rid="bib8">Eyre-Walker and Keightley, 2007</xref>). The MFBD model can also be used to compare the fitness of a mutation or lineage across different environments, such as in different hosts of a pathogen. Finally, the MFBD is not limited to exploring sequence evolution, as the model is generalizable to any discrete character state, including phenotypic, geographic or environmental characters. Thus, more generally, our model can be thought of as a multi-trait, multi-type birth-death model that can be used to explore how different molecular and non-molecular characters interact to shape the overall fitness of lineages in a phylogeny.</p></sec></body><back><ack id="ack"><title>Acknowledgements</title><p>We would like to thank Denise Kühnert for helpful advice on how to implement the MFBD model in BEAST 2, Katia Koelle for advice on the influenza H3N2 analysis, and Louis du Plessis for permission to reproduce the model schematic shown in <xref ref-type="fig" rid="fig1">Figure 1A</xref>.</p></ack><sec id="s5" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="COI-statement" id="conf1"><p>No competing interests declared</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>Conceptualization, Software, Formal analysis, Validation, Visualization, Methodology, Writing—original draft, Writing—review and editing</p></fn><fn fn-type="con" id="con2"><p>Formal analysis, Supervision, Methodology, Writing—review and editing</p></fn></fn-group></sec><sec id="s6" sec-type="data-availability"><title>Data availability</title><p>All data and code required to reproduce our Ebola analysis in its entirety is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/davidrasm/Lumiere/tree/master/ebola">https://github.com/davidrasm/Lumiere/tree/master/ebola</ext-link> (copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/Lumiere">https://github.com/elifesciences-publications/Lumiere</ext-link>). The sequence alignment along with the timecalibrated molecular phylogeny we used for our analysis were downloaded from <ext-link ext-link-type="uri" xlink:href="https://github.com/">https://github.com/</ext-link> ebov/space-time/tree/master/Data. Dataset S3 of Lee et al. 2018 was downloaded from <ext-link ext-link-type="uri" xlink:href="https://www.pnas.org/highwire/filestream/822898/field_highwire_adjunct_files/3/pnas.1806133115.sd03.xlsx">https://www.pnas.org/highwire/filestream/822898/field_highwire_adjunct_files/3/pnas.1806133115.sd03.xlsx</ext-link>.</p></sec><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Antia</surname> <given-names>R</given-names></name><name><surname>Regoes</surname> <given-names>RR</given-names></name><name><surname>Koella</surname> <given-names>JC</given-names></name><name><surname>Bergstrom</surname> <given-names>CT</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>The role of evolution in the emergence of infectious diseases</article-title><source>Nature</source><volume>426</volume><fpage>658</fpage><lpage>661</lpage><pub-id pub-id-type="doi">10.1038/nature02104</pub-id><pub-id pub-id-type="pmid">14668863</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Barido-Sottani</surname> <given-names>J</given-names></name><name><surname>Vaughan</surname> <given-names>TG</given-names></name><name><surname>Stadler</surname> <given-names>T</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Detection of HIV transmission clusters from phylogenetic trees using a multi-state birth–death model</article-title><source>Journal of the Royal Society Interface</source><volume>15</volume><elocation-id>20180512</elocation-id><pub-id pub-id-type="doi">10.1098/rsif.2018.0512</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bouckaert</surname> <given-names>R</given-names></name><name><surname>Heled</surname> <given-names>J</given-names></name><name><surname>Kühnert</surname> <given-names>D</given-names></name><name><surname>Vaughan</surname> <given-names>T</given-names></name><name><surname>Wu</surname> <given-names>C-H</given-names></name><name><surname>Xie</surname> <given-names>D</given-names></name><name><surname>Suchard</surname> <given-names>MA</given-names></name><name><surname>Rambaut</surname> <given-names>A</given-names></name><name><surname>Drummond</surname> <given-names>AJ</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>BEAST 2: a software platform for bayesian evolutionary analysis</article-title><source>PLOS Computational Biology</source><volume>10</volume><elocation-id>e1003537</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.1003537</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Bustamante</surname> <given-names>CD</given-names></name></person-group><year iso-8601-date="2005">2005</year><source>Population Genetics of Molecular Evolution</source><publisher-name>Springer</publisher-name></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Diehl</surname> <given-names>WE</given-names></name><name><surname>Lin</surname> <given-names>AE</given-names></name><name><surname>Grubaugh</surname> <given-names>ND</given-names></name><name><surname>Carvalho</surname> <given-names>LM</given-names></name><name><surname>Kim</surname> <given-names>K</given-names></name><name><surname>Kyawe</surname> <given-names>PP</given-names></name><name><surname>McCauley</surname> <given-names>SM</given-names></name><name><surname>Donnard</surname> <given-names>E</given-names></name><name><surname>Kucukural</surname> <given-names>A</given-names></name><name><surname>McDonel</surname> <given-names>P</given-names></name><name><surname>Schaffner</surname> <given-names>SF</given-names></name><name><surname>Garber</surname> <given-names>M</given-names></name><name><surname>Rambaut</surname> <given-names>A</given-names></name><name><surname>Andersen</surname> <given-names>KG</given-names></name><name><surname>Sabeti</surname> <given-names>PC</given-names></name><name><surname>Luban</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Ebola virus glycoprotein with increased infectivity dominated the 2013-2016 epidemic</article-title><source>Cell</source><volume>167</volume><fpage>1088</fpage><lpage>1098</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2016.10.014</pub-id><pub-id pub-id-type="pmid">27814506</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Edgar</surname> <given-names>RC</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>MUSCLE: multiple sequence alignment with high accuracy and high throughput</article-title><source>Nucleic Acids Research</source><volume>32</volume><fpage>1792</fpage><lpage>1797</lpage><pub-id pub-id-type="doi">10.1093/nar/gkh340</pub-id><pub-id pub-id-type="pmid">15034147</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Elena</surname> <given-names>SF</given-names></name><name><surname>Solé</surname> <given-names>RV</given-names></name><name><surname>Sardanyés</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Simple genomes, complex interactions: epistasis in RNA virus</article-title><source>Chaos: An Interdisciplinary Journal of Nonlinear Science</source><volume>20</volume><elocation-id>026106</elocation-id><pub-id pub-id-type="doi">10.1063/1.3449300</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Eyre-Walker</surname> <given-names>A</given-names></name><name><surname>Keightley</surname> <given-names>PD</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>The distribution of fitness effects of new mutations</article-title><source>Nature Reviews Genetics</source><volume>8</volume><fpage>610</fpage><lpage>618</lpage><pub-id pub-id-type="doi">10.1038/nrg2146</pub-id><pub-id pub-id-type="pmid">17637733</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Felsenstein</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="1981">1981</year><article-title>Evolutionary trees from DNA sequences: a maximum likelihood approach</article-title><source>Journal of Molecular Evolution</source><volume>17</volume><fpage>368</fpage><lpage>376</lpage><pub-id pub-id-type="doi">10.1007/BF01734359</pub-id><pub-id pub-id-type="pmid">7288891</pub-id></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fraser</surname> <given-names>C</given-names></name><name><surname>Hollingsworth</surname> <given-names>TD</given-names></name><name><surname>Chapman</surname> <given-names>R</given-names></name><name><surname>de Wolf</surname> <given-names>F</given-names></name><name><surname>Hanage</surname> <given-names>WP</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>Variation in HIV-1 set-point viral load: epidemiological analysis and an evolutionary hypothesis</article-title><source>PNAS</source><volume>104</volume><fpage>17441</fpage><lpage>17446</lpage><pub-id pub-id-type="doi">10.1073/pnas.0708559104</pub-id><pub-id pub-id-type="pmid">17954909</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gillespie</surname> <given-names>DT</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>Stochastic simulation of chemical kinetics</article-title><source>Annual Review of Physical Chemistry</source><volume>58</volume><fpage>35</fpage><lpage>55</lpage><pub-id pub-id-type="doi">10.1146/annurev.physchem.58.032806.104637</pub-id><pub-id pub-id-type="pmid">17037977</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gire</surname> <given-names>SK</given-names></name><name><surname>Goba</surname> <given-names>A</given-names></name><name><surname>Andersen</surname> <given-names>KG</given-names></name><name><surname>Sealfon</surname> <given-names>RS</given-names></name><name><surname>Park</surname> <given-names>DJ</given-names></name><name><surname>Kanneh</surname> <given-names>L</given-names></name><name><surname>Jalloh</surname> <given-names>S</given-names></name><name><surname>Momoh</surname> <given-names>M</given-names></name><name><surname>Fullah</surname> <given-names>M</given-names></name><name><surname>Dudas</surname> <given-names>G</given-names></name><name><surname>Wohl</surname> <given-names>S</given-names></name><name><surname>Moses</surname> <given-names>LM</given-names></name><name><surname>Yozwiak</surname> <given-names>NL</given-names></name><name><surname>Winnicki</surname> <given-names>S</given-names></name><name><surname>Matranga</surname> <given-names>CB</given-names></name><name><surname>Malboeuf</surname> <given-names>CM</given-names></name><name><surname>Qu</surname> <given-names>J</given-names></name><name><surname>Gladden</surname> <given-names>AD</given-names></name><name><surname>Schaffner</surname> <given-names>SF</given-names></name><name><surname>Yang</surname> <given-names>X</given-names></name><name><surname>Jiang</surname> <given-names>PP</given-names></name><name><surname>Nekoui</surname> <given-names>M</given-names></name><name><surname>Colubri</surname> <given-names>A</given-names></name><name><surname>Coomber</surname> <given-names>MR</given-names></name><name><surname>Fonnie</surname> <given-names>M</given-names></name><name><surname>Moigboi</surname> <given-names>A</given-names></name><name><surname>Gbakie</surname> <given-names>M</given-names></name><name><surname>Kamara</surname> <given-names>FK</given-names></name><name><surname>Tucker</surname> <given-names>V</given-names></name><name><surname>Konuwa</surname> <given-names>E</given-names></name><name><surname>Saffa</surname> <given-names>S</given-names></name><name><surname>Sellu</surname> <given-names>J</given-names></name><name><surname>Jalloh</surname> <given-names>AA</given-names></name><name><surname>Kovoma</surname> <given-names>A</given-names></name><name><surname>Koninga</surname> <given-names>J</given-names></name><name><surname>Mustapha</surname> <given-names>I</given-names></name><name><surname>Kargbo</surname> <given-names>K</given-names></name><name><surname>Foday</surname> <given-names>M</given-names></name><name><surname>Yillah</surname> <given-names>M</given-names></name><name><surname>Kanneh</surname> <given-names>F</given-names></name><name><surname>Robert</surname> <given-names>W</given-names></name><name><surname>Massally</surname> <given-names>JL</given-names></name><name><surname>Chapman</surname> <given-names>SB</given-names></name><name><surname>Bochicchio</surname> <given-names>J</given-names></name><name><surname>Murphy</surname> <given-names>C</given-names></name><name><surname>Nusbaum</surname> <given-names>C</given-names></name><name><surname>Young</surname> <given-names>S</given-names></name><name><surname>Birren</surname> <given-names>BW</given-names></name><name><surname>Grant</surname> <given-names>DS</given-names></name><name><surname>Scheiffelin</surname> <given-names>JS</given-names></name><name><surname>Lander</surname> <given-names>ES</given-names></name><name><surname>Happi</surname> <given-names>C</given-names></name><name><surname>Gevao</surname> <given-names>SM</given-names></name><name><surname>Gnirke</surname> <given-names>A</given-names></name><name><surname>Rambaut</surname> <given-names>A</given-names></name><name><surname>Garry</surname> <given-names>RF</given-names></name><name><surname>Khan</surname> <given-names>SH</given-names></name><name><surname>Sabeti</surname> <given-names>PC</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Genomic surveillance elucidates ebola virus origin and transmission during the 2014 outbreak</article-title><source>Science</source><volume>345</volume><fpage>1369</fpage><lpage>1372</lpage><pub-id pub-id-type="doi">10.1126/science.1259657</pub-id><pub-id pub-id-type="pmid">25214632</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Goldman</surname> <given-names>N</given-names></name><name><surname>Yang</surname> <given-names>Z</given-names></name></person-group><year iso-8601-date="1994">1994</year><article-title>A codon-based model of nucleotide substitution for protein-coding DNA sequences</article-title><source>Molecular Biology and Evolution</source><volume>11</volume><fpage>725</fpage><lpage>736</lpage><pub-id pub-id-type="doi">10.1093/oxfordjournals.molbev.a040153</pub-id><pub-id pub-id-type="pmid">7968486</pub-id></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Griffiths</surname> <given-names>RC</given-names></name><name><surname>Tavaré</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="1994">1994</year><article-title>Sampling theory for neutral alleles in a varying environment</article-title><source>Philosophical Transactions of the Royal Soceity B Biological Sciences</source><volume>344</volume><fpage>403</fpage><lpage>410</lpage><pub-id pub-id-type="doi">10.1098/rstb.1994.0079</pub-id></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Halpern</surname> <given-names>AL</given-names></name><name><surname>Bruno</surname> <given-names>WJ</given-names></name></person-group><year iso-8601-date="1998">1998</year><article-title>Evolutionary distances for protein-coding sequences: modeling site- specific residue frequencies</article-title><source>Molecular Biology and Evolution</source><volume>15</volume><fpage>910</fpage><lpage>917</lpage><pub-id pub-id-type="doi">10.1093/oxfordjournals.molbev.a025995</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hilton</surname> <given-names>SK</given-names></name><name><surname>Bloom</surname> <given-names>JD</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Modeling site-specific amino-acid preferences deepens phylogenetic estimates of viral sequence divergence</article-title><source>Virus Evolution</source><volume>4</volume><elocation-id>vey033</elocation-id><pub-id pub-id-type="doi">10.1093/ve/vey033</pub-id><pub-id pub-id-type="pmid">30425841</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Illingworth</surname> <given-names>CJ</given-names></name><name><surname>Mustonen</surname> <given-names>V</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Components of selection in the evolution of the influenza virus: linkage effects beat inherent selection</article-title><source>PLOS Pathogens</source><volume>8</volume><elocation-id>e1003091</elocation-id><pub-id pub-id-type="doi">10.1371/journal.ppat.1003091</pub-id><pub-id pub-id-type="pmid">23300444</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kaplan</surname> <given-names>NL</given-names></name><name><surname>Darden</surname> <given-names>T</given-names></name><name><surname>Hudson</surname> <given-names>RR</given-names></name></person-group><year iso-8601-date="1988">1988</year><article-title>The coalescent process in models with selection</article-title><source>Genetics</source><volume>120</volume><fpage>819</fpage><lpage>829</lpage><pub-id pub-id-type="pmid">3066685</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kepler</surname> <given-names>TB</given-names></name><name><surname>Perelson</surname> <given-names>AS</given-names></name></person-group><year iso-8601-date="1993">1993</year><article-title>Cyclic re-entry of germinal center B cells and the efficiency of affinity maturation</article-title><source>Immunology Today</source><volume>14</volume><fpage>412</fpage><lpage>415</lpage><pub-id pub-id-type="doi">10.1016/0167-5699(93)90145-B</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Koelle</surname> <given-names>K</given-names></name><name><surname>Rasmussen</surname> <given-names>DA</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>The effects of a deleterious mutation load on patterns of influenza A/H3N2's antigenic evolution in humans</article-title><source>eLife</source><volume>4</volume><elocation-id>e07361</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.07361</pub-id><pub-id pub-id-type="pmid">26371556</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kryazhimskiy</surname> <given-names>S</given-names></name><name><surname>Plotkin</surname> <given-names>JB</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>The population genetics of dN/dS</article-title><source>PLOS Genetics</source><volume>4</volume><elocation-id>e1000304</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pgen.1000304</pub-id><pub-id pub-id-type="pmid">19081788</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kühnert</surname> <given-names>D</given-names></name><name><surname>Stadler</surname> <given-names>T</given-names></name><name><surname>Vaughan</surname> <given-names>TG</given-names></name><name><surname>Drummond</surname> <given-names>AJ</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Phylodynamics with migration: a computational framework to quantify population structure from genomic data</article-title><source>Molecular Biology and Evolution</source><volume>33</volume><fpage>2102</fpage><lpage>2116</lpage><pub-id pub-id-type="doi">10.1093/molbev/msw064</pub-id><pub-id pub-id-type="pmid">27189573</pub-id></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lartillot</surname> <given-names>N</given-names></name><name><surname>Philippe</surname> <given-names>H</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>A bayesian mixture model for across-site heterogeneities in the amino-acid replacement process</article-title><source>Molecular Biology and Evolution</source><volume>21</volume><fpage>1095</fpage><lpage>1109</lpage><pub-id pub-id-type="doi">10.1093/molbev/msh112</pub-id><pub-id pub-id-type="pmid">15014145</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lee</surname> <given-names>JM</given-names></name><name><surname>Huddleston</surname> <given-names>J</given-names></name><name><surname>Doud</surname> <given-names>MB</given-names></name><name><surname>Hooper</surname> <given-names>KA</given-names></name><name><surname>Wu</surname> <given-names>NC</given-names></name><name><surname>Bedford</surname> <given-names>T</given-names></name><name><surname>Bloom</surname> <given-names>JD</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Deep mutational scanning of hemagglutinin helps predict evolutionary fates of human H3N2 influenza variants</article-title><source>PNAS</source><volume>115</volume><fpage>E8276</fpage><lpage>E8285</lpage><pub-id pub-id-type="doi">10.1073/pnas.1806133115</pub-id><pub-id pub-id-type="pmid">30104379</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Longdon</surname> <given-names>B</given-names></name><name><surname>Brockhurst</surname> <given-names>MA</given-names></name><name><surname>Russell</surname> <given-names>CA</given-names></name><name><surname>Welch</surname> <given-names>JJ</given-names></name><name><surname>Jiggins</surname> <given-names>FM</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>The evolution and genetics of virus host shifts</article-title><source>PLOS Pathogens</source><volume>10</volume><elocation-id>e1004395</elocation-id><pub-id pub-id-type="doi">10.1371/journal.ppat.1004395</pub-id><pub-id pub-id-type="pmid">25375777</pub-id></element-citation></ref><ref id="bib26"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luksza</surname> <given-names>M</given-names></name><name><surname>Lässig</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>A predictive fitness model for influenza</article-title><source>Nature</source><volume>507</volume><fpage>57</fpage><lpage>61</lpage><pub-id pub-id-type="doi">10.1038/nature13087</pub-id><pub-id pub-id-type="pmid">24572367</pub-id></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Maddison</surname> <given-names>WP</given-names></name><name><surname>Midford</surname> <given-names>PE</given-names></name><name><surname>Otto</surname> <given-names>SP</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>Estimating a binary character's effect on speciation and extinction</article-title><source>Systematic Biology</source><volume>56</volume><fpage>701</fpage><lpage>710</lpage><pub-id pub-id-type="doi">10.1080/10635150701607033</pub-id><pub-id pub-id-type="pmid">17849325</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Muse</surname> <given-names>SV</given-names></name><name><surname>Gaut</surname> <given-names>BS</given-names></name></person-group><year iso-8601-date="1994">1994</year><article-title>A likelihood approach for comparing synonymous and nonsynonymous nucleotide substitution rates, with application to the chloroplast genome</article-title><source>Molecular Biology and Evolution</source><volume>11</volume><fpage>715</fpage><lpage>724</lpage><pub-id pub-id-type="doi">10.1093/oxfordjournals.molbev.a040152</pub-id><pub-id pub-id-type="pmid">7968485</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Neher</surname> <given-names>RA</given-names></name><name><surname>Russell</surname> <given-names>CA</given-names></name><name><surname>Shraiman</surname> <given-names>BI</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Predicting evolution from the shape of genealogical trees</article-title><source>eLife</source><volume>3</volume><elocation-id>e03568</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.03568</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Neher</surname> <given-names>RA</given-names></name><name><surname>Hallatschek</surname> <given-names>O</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Genealogies of rapidly adapting populations</article-title><source>PNAS</source><volume>110</volume><fpage>437</fpage><lpage>442</lpage><pub-id pub-id-type="doi">10.1073/pnas.1213113110</pub-id><pub-id pub-id-type="pmid">23269838</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nicolaisen</surname> <given-names>LE</given-names></name><name><surname>Desai</surname> <given-names>MM</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Distortions in genealogies due to purifying selection</article-title><source>Molecular Biology and Evolution</source><volume>29</volume><fpage>3589</fpage><lpage>3600</lpage><pub-id pub-id-type="doi">10.1093/molbev/mss170</pub-id><pub-id pub-id-type="pmid">22729750</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pybus</surname> <given-names>OG</given-names></name><name><surname>Rambaut</surname> <given-names>A</given-names></name><name><surname>Harvey</surname> <given-names>PH</given-names></name></person-group><year iso-8601-date="2000">2000</year><article-title>An integrated framework for the inference of viral population history from reconstructed genealogies</article-title><source>Genetics</source><volume>155</volume><fpage>1429</fpage><lpage>1437</lpage></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Quinn</surname> <given-names>TC</given-names></name><name><surname>Wawer</surname> <given-names>MJ</given-names></name><name><surname>Sewankambo</surname> <given-names>N</given-names></name><name><surname>Serwadda</surname> <given-names>D</given-names></name><name><surname>Li</surname> <given-names>C</given-names></name><name><surname>Wabwire-Mangen</surname> <given-names>F</given-names></name><name><surname>Meehan</surname> <given-names>MO</given-names></name><name><surname>Lutalo</surname> <given-names>T</given-names></name><name><surname>Gray</surname> <given-names>RH</given-names></name></person-group><year iso-8601-date="2000">2000</year><article-title>Viral load and heterosexual transmission of human immunodeficiency virus type 1</article-title><source>New England Journal of Medicine</source><volume>342</volume><fpage>921</fpage><lpage>929</lpage><pub-id pub-id-type="doi">10.1056/NEJM200003303421303</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rabosky</surname> <given-names>DL</given-names></name><name><surname>Grundler</surname> <given-names>M</given-names></name><name><surname>Anderson</surname> <given-names>C</given-names></name><name><surname>Title</surname> <given-names>P</given-names></name><name><surname>Shi</surname> <given-names>JJ</given-names></name><name><surname>Brown</surname> <given-names>JW</given-names></name><name><surname>Huang</surname> <given-names>H</given-names></name><name><surname>Larson</surname> <given-names>JG</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>BAMMtools: an R package for the analysis of evolutionary dynamics on phylogenetic trees</article-title><source>Methods in Ecology and Evolution</source><volume>5</volume><fpage>701</fpage><lpage>707</lpage><pub-id pub-id-type="doi">10.1111/2041-210X.12199</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Raghwani</surname> <given-names>J</given-names></name><name><surname>Thompson</surname> <given-names>RN</given-names></name><name><surname>Koelle</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Selection on non-antigenic gene segments of seasonal influenza A virus and its impact on adaptive evolution</article-title><source>Virus Evolution</source><volume>3</volume><elocation-id>vex034</elocation-id><pub-id pub-id-type="doi">10.1093/ve/vex034</pub-id><pub-id pub-id-type="pmid">29250432</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rambaut</surname> <given-names>A</given-names></name><name><surname>Pybus</surname> <given-names>OG</given-names></name><name><surname>Nelson</surname> <given-names>MI</given-names></name><name><surname>Viboud</surname> <given-names>C</given-names></name><name><surname>Taubenberger</surname> <given-names>JK</given-names></name><name><surname>Holmes</surname> <given-names>EC</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>The genomic and epidemiological dynamics of human influenza A virus</article-title><source>Nature</source><volume>453</volume><fpage>615</fpage><lpage>619</lpage><pub-id pub-id-type="doi">10.1038/nature06945</pub-id><pub-id pub-id-type="pmid">18418375</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rannala</surname> <given-names>B</given-names></name><name><surname>Yang</surname> <given-names>Z</given-names></name></person-group><year iso-8601-date="1996">1996</year><article-title>Probability distribution of molecular evolutionary trees: a new method of phylogenetic inference</article-title><source>Journal of Molecular Evolution</source><volume>43</volume><fpage>304</fpage><lpage>311</lpage><pub-id pub-id-type="doi">10.1007/BF02338839</pub-id><pub-id pub-id-type="pmid">8703097</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Rasmussen</surname> <given-names>DA</given-names></name></person-group><year iso-8601-date="2019">2019</year><data-title>Lumiere</data-title><version designator="090bae1">090bae1</version><publisher-name>Github</publisher-name><ext-link ext-link-type="uri" xlink:href="https://github.com/davidrasm/Lumiere">https://github.com/davidrasm/Lumiere</ext-link></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rodrigue</surname> <given-names>N</given-names></name><name><surname>Philippe</surname> <given-names>H</given-names></name><name><surname>Lartillot</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Mutation-selection models of coding sequence evolution with site-heterogeneous amino acid fitness profiles</article-title><source>PNAS</source><volume>107</volume><fpage>4629</fpage><lpage>4634</lpage><pub-id pub-id-type="doi">10.1073/pnas.0910915107</pub-id><pub-id pub-id-type="pmid">20176949</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sanjuán</surname> <given-names>R</given-names></name><name><surname>Moya</surname> <given-names>A</given-names></name><name><surname>Elena</surname> <given-names>SF</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>The distribution of fitness effects caused by single-nucleotide substitutions in an RNA virus</article-title><source>PNAS</source><volume>101</volume><fpage>8396</fpage><lpage>8401</lpage><pub-id pub-id-type="doi">10.1073/pnas.0400146101</pub-id><pub-id pub-id-type="pmid">15159545</pub-id></element-citation></ref><ref id="bib41"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stadler</surname> <given-names>T</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>On incomplete sampling under birth–death models and connections to the sampling-based coalescent</article-title><source>Journal of Theoretical Biology</source><volume>261</volume><fpage>58</fpage><lpage>66</lpage><pub-id pub-id-type="doi">10.1016/j.jtbi.2009.07.018</pub-id></element-citation></ref><ref id="bib42"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stadler</surname> <given-names>T</given-names></name><name><surname>Kühnert</surname> <given-names>D</given-names></name><name><surname>Rasmussen</surname> <given-names>DA</given-names></name><name><surname>du Plessis</surname> <given-names>L</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Insights into the early epidemic spread of ebola in sierra Leone provided by viral sequence data</article-title><source>PLOS Currents</source><volume>6</volume><pub-id pub-id-type="doi">10.1371/currents.outbreaks.02bc6d927ecee7bbd33532ec8ba6a25f</pub-id><pub-id pub-id-type="pmid">25642370</pub-id></element-citation></ref><ref id="bib43"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stadler</surname> <given-names>T</given-names></name><name><surname>Bonhoeffer</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Uncovering epidemiological dynamics in heterogeneous host populations using phylogenetic methods</article-title><source>Philosophical Transactions of the Royal Society B: Biological Sciences</source><volume>368</volume><elocation-id>20120198</elocation-id><pub-id pub-id-type="doi">10.1098/rstb.2012.0198</pub-id></element-citation></ref><ref id="bib44"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stamatakis</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>RAxML version 8: a tool for phylogenetic analysis and post-analysis of large phylogenies</article-title><source>Bioinformatics</source><volume>30</volume><fpage>1312</fpage><lpage>1313</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btu033</pub-id><pub-id pub-id-type="pmid">24451623</pub-id></element-citation></ref><ref id="bib45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Thyagarajan</surname> <given-names>B</given-names></name><name><surname>Bloom</surname> <given-names>JD</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>The inherent mutational tolerance and antigenic evolvability of influenza hemagglutinin</article-title><source>eLife</source><volume>3</volume><elocation-id>e03300</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.03300</pub-id></element-citation></ref><ref id="bib46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>To</surname> <given-names>TH</given-names></name><name><surname>Jung</surname> <given-names>M</given-names></name><name><surname>Lycett</surname> <given-names>S</given-names></name><name><surname>Gascuel</surname> <given-names>O</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Fast dating using least-squares criteria and algorithms</article-title><source>Systematic Biology</source><volume>65</volume><fpage>82</fpage><lpage>97</lpage><pub-id pub-id-type="doi">10.1093/sysbio/syv068</pub-id><pub-id pub-id-type="pmid">26424727</pub-id></element-citation></ref><ref id="bib47"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tsimring</surname> <given-names>LS</given-names></name><name><surname>Levine</surname> <given-names>H</given-names></name><name><surname>Kessler</surname> <given-names>DA</given-names></name></person-group><year iso-8601-date="1996">1996</year><article-title>RNA virus evolution via a fitness-space model</article-title><source>Physical Review Letters</source><volume>76</volume><fpage>4440</fpage><lpage>4443</lpage><pub-id pub-id-type="doi">10.1103/PhysRevLett.76.4440</pub-id><pub-id pub-id-type="pmid">10061290</pub-id></element-citation></ref><ref id="bib48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Urbanowicz</surname> <given-names>RA</given-names></name><name><surname>McClure</surname> <given-names>CP</given-names></name><name><surname>Sakuntabhai</surname> <given-names>A</given-names></name><name><surname>Sall</surname> <given-names>AA</given-names></name><name><surname>Kobinger</surname> <given-names>G</given-names></name><name><surname>Müller</surname> <given-names>MA</given-names></name><name><surname>Holmes</surname> <given-names>EC</given-names></name><name><surname>Rey</surname> <given-names>FA</given-names></name><name><surname>Simon-Loriere</surname> <given-names>E</given-names></name><name><surname>Ball</surname> <given-names>JK</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Human adaptation of ebola virus during the west african outbreak</article-title><source>Cell</source><volume>167</volume><fpage>1079</fpage><lpage>1087</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2016.10.013</pub-id><pub-id pub-id-type="pmid">27814505</pub-id></element-citation></ref><ref id="bib49"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Visher</surname> <given-names>E</given-names></name><name><surname>Whitefield</surname> <given-names>SE</given-names></name><name><surname>McCrone</surname> <given-names>JT</given-names></name><name><surname>Fitzsimmons</surname> <given-names>W</given-names></name><name><surname>Lauring</surname> <given-names>AS</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>The mutational robustness of influenza A virus</article-title><source>PLOS Pathogens</source><volume>12</volume><elocation-id>e1005856</elocation-id><pub-id pub-id-type="doi">10.1371/journal.ppat.1005856</pub-id><pub-id pub-id-type="pmid">27571422</pub-id></element-citation></ref><ref id="bib50"><element-citation publication-type="software"><person-group person-group-type="author"><collab>WHO</collab></person-group><year iso-8601-date="2016">2016</year><data-title>Ebola situation reports</data-title><ext-link ext-link-type="uri" xlink:href="http://apps.who.int/ebola/ebola-situation-reports">http://apps.who.int/ebola/ebola-situation-reports</ext-link></element-citation></ref><ref id="bib51"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yang</surname> <given-names>Z</given-names></name><name><surname>Nielsen</surname> <given-names>R</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Mutation-Selection models of Codon substitution and their use to estimate selective strengths on Codon usage</article-title><source>Molecular Biology and Evolution</source><volume>25</volume><fpage>568</fpage><lpage>579</lpage><pub-id pub-id-type="doi">10.1093/molbev/msm284</pub-id></element-citation></ref><ref id="bib52"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zanini</surname> <given-names>F</given-names></name><name><surname>Neher</surname> <given-names>RA</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Quantifying selection against synonymous mutations in HIV-1 env evolution</article-title><source>Journal of Virology</source><volume>87</volume><fpage>11843</fpage><lpage>11850</lpage><pub-id pub-id-type="doi">10.1128/JVI.01529-13</pub-id><pub-id pub-id-type="pmid">23986591</pub-id></element-citation></ref></ref-list></back><sub-article article-type="decision-letter" id="SA1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.45562.013</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group><contrib contrib-type="editor"><name><surname>Walczak</surname><given-names>Aleksandra M</given-names></name><role>Reviewing Editor</role><aff><institution>École Normale Supérieure</institution><country>France</country></aff></contrib><contrib contrib-type="reviewer"><name><surname>Bedford</surname><given-names>Trevor</given-names> </name><role>Reviewer</role><aff><institution>Fred Hutchinson Cancer Research Center</institution><country>United States</country></aff></contrib></contrib-group></front-stub><body><boxed-text><p>In the interests of transparency, eLife includes the editorial decision letter and accompanying author responses. A lightly edited version of the letter sent to the authors after peer review is shown, indicating the most substantive concerns; minor comments are not usually included.</p></boxed-text><p>Thank you for submitting your article &quot;Coupling adaptive molecular evolution to phylodynamics using fitness-dependent birth-death models&quot; for consideration by <italic>eLife</italic>. Your article has been reviewed by three peer reviewers, and the evaluation has been overseen by a Reviewing Editor and Diethard Tautz as the Senior Editor. The following individuals involved in review of your submission have agreed to reveal their identity: Trevor Bedford (Reviewer #1).</p><p>The reviewers have discussed the reviews with one another and the Reviewing Editor has drafted this decision to help you prepare a revised submission.</p><p>The reviewers and editor agree that the subject of introducing selection and fitness into phylogenic inference is extremely important, neglected and very hard. For these reasons everyone is very enthusiastic about this effort. Nevertheless, all reviewers raise concerns both about presentation and about validation and applications. The reviewers should be understanding if not all their suggestions can be incorporated but we would urge you to try and satisfy them as much as possible, and very clearly explain instances where you cannot follow their suggestions. In our opinion, given the scope of <italic>eLife</italic> and that many readers will probably be less expert in probability theory than the reviewers, we think it is extremely important to be very clear about the assumptions and where the method works and where it falls short (see comments by reviewer 2). In light of this, reviewer 1 comments that testing different systems will provide such intuition for the less mathematically trained. You do not have to worry about selling the method – I think this is a point where we also learn from negative results.</p><p>We are including the reviewers' comments in full, since they are all instructive and each is very different.</p><p><italic>Reviewer #1:</italic> </p><p>I've been working in the field of phylodynamics for the last several years, and I can say that it's widely acknowledged how difficult it's been to bridge the more traditional craft of demographic inferences of population size and migration to more fundamental evolutionary insights of strain fitnesses. I applaud the efforts of Rasmussen and Stadler to tackle such an important issue in their manuscript &quot;Coupling adaptive molecular evolution to phylodynamics using fitness-dependent birth-death models&quot;. I believe this work represents an innovative modeling avenue to address fitness in phylodynamic inference and will eventually lead to many fruitful biological insights.</p><p>I found the model explication clear and well motivated. Although I admit difficulty with the full mathematical details, I could certainly follow the overall approach and was given a good sense of what approximations had been taken and why.</p><p>I believe the core modeling advance is completely sound and warrants publication. However, I believe that for <italic>eLife</italic> in particular, a manuscript should point the way towards biological insight. The application to Ebola in West Africa is not as biologically exciting as other systems; the method appears to work, but there's just little adaptive evolution going on. I believe the manuscript would find more traction with readers if it showed a clear example of elucidating impactful fitness differences in an evolving population.</p><p>Major suggestions:</p><p>1) My central suggestion would be to include a second biological example in which strain variation should be more apparent. Given David Rasmussen's expertise and the known biology of the system, I would suggest H3N2 influenza. Working with influenza phylogenies, there are often clear cut examples of new mutations emerging that rapidly increase in the population (such as HA1 F159Y, <ext-link ext-link-type="uri" xlink:href="https://nextstrain.org/flu/seasonal/h3n2/ha/12y?c=gt-HA1_159">https://nextstrain.org/flu/seasonal/h3n2/ha/12y?c=gt-HA1_159</ext-link>). If a few of these genotypes are selected (such as those dictated by the Koel 7, see Koel et al., 2013), are there fitness differences visible in the phylogeny?</p><p>I'm not suggesting to do any sort of formal prediction from these fitnesses. Just to see if H3N2 phylogenies give reasonable model outputs.</p><p>Alternatively, if flu doesn't work as a motivating example, this should be discussed, as it's so obvious. I don't know if the low sampling fraction would pose an issue to the model.</p><p>There were a couple issues I had with Ebola analysis. Nothing fundamental, but issues that should be addressed to get at the biology. These were:</p><p>2) I remain concerned about the conflation of epidemiological circumstance and evolutionary fitness in these inferences (Bedford and Malik, 2016, Cell). In particular, the GP A82V mutation corresponds cleanly to a transition from early circulation in Guinea to circulation in Sierra Leone. Could this be addressed technically by adding an additional &quot;site&quot; to the model distinguishing between Guinea, Sierra Leone and Liberia?</p><p>3) It seems funny to me to only look the subset of sites investigated by Urbanowicz et al. in the lab. There were other common mutations in GP that weren't looked at by Urbanowicz et al. For example, both R321K and E580G (<ext-link ext-link-type="uri" xlink:href="https://nextstrain.org/ebola?c=gt-GP_321,580">https://nextstrain.org/ebola?c=gt-GP_321,580</ext-link>) are significantly more common than R29K, I371V and K439E (<ext-link ext-link-type="uri" xlink:href="https://nextstrain.org/ebola?c=gt-GP_29,371,439">https://nextstrain.org/ebola?c=gt-GP_29,371,439</ext-link>). Thus, it's weird to me to present a table that lists fitness impacts of several mutations, when there are other mutations that are largely colinear with the presented mutations, that may have actually been the causal variants.</p><p>I have this same issue with genes outside of GP. There are highly successful mutations like NP R111C (<ext-link ext-link-type="uri" xlink:href="https://nextstrain.org/ebola?c=gt-NP_111">https://nextstrain.org/ebola?c=gt-NP_111</ext-link>) that are not accounted for. These may be driving the fitness differences observed. For example, L177A visually correlates better with the successful clade than GP E410V, which received a lot of model weight.</p><p>Is it possible to put forth a more systematic approach here? I don't think with what's been done that it's possible to conclude much about genetic variants driving transmission differences during the West African epidemic. I worry that handing out an approach as described will lead to people cherry picking what sites they use to define strains in subsequent analyses. There should be some guidance for how to approach this objectively.</p><p><italic>Reviewer #2:</italic> </p><p>The manuscript &quot;Coupling adaptive molecular evolution to phylodynamics using fitness-dependent birth-death model&quot; introduces a probabilistic framework to estimate the joint distribution of the sequence data and of the phylogenetic tree, in which the tree is affected by the mutational process. The authors first introduce a general set of coupled different equations for the backwards evolution of the probabilities of observed subtrees and non-observed lineages. As these equations are intractable, a series of approximations to reduce the size of the problem are considered, including projections onto low-dimensional subspaces, decorrelation between sites in the genome… These simplified equations are solved in three cases: two toy models (small number of sites), for which the ground truth is known, and Ebola glycoprotein (GP) data sampled during the 2013-16 epidemic. Based on their computational approach, the authors can quantitatively estimate the fitness effects of 8 GP mutants.</p><p>I fully agree with the authors that estimating the likelihood of sequence data and tree altogether, without any unrealistic separation between the tree dynamics and the mutation processes, is an important and very challenging goal. Despite the biological importance of this issue, few works have considered the coupling between the tree dynamics and fitness so far, see for instance Neher, Russel and Shraiman (2014). The present work by Rasmussen and Stadler is an interesting and sophisticated step in this direction. I have however several criticisms against the current version of the manuscript, both on form and content.</p><p>My first comment is about the accessibility of the paper, more precisely, whether it is self-contained or not. While some compromise has always to be made between a full, self-contained presentation and the necessity to have a reasonable length, I think the manuscript should be made more accessible. I had to go to Stadler and Bonhoeffer (2013) to understand clearly the meaning of the main quantities (D<sub>n,i</sub> and E<sub>i</sub>); inserting a figure similar to Figure 1 of that paper would be useful. Equations 2 and 3, which are identical to the ones of Stadler and Bonhoeffer (apart from the presence of mutations – γ<sub>i,j</sub> – instead of lineage – λ<sub>i,j</sub> – rates), are also better explained in that paper. Furthermore, the presence of the normalization factor including the probability of being observed in Equation 5 is not really explained here. Again, the 2013 paper was helpful to understand the origin of this denominator.</p><p>Secondly, I agree that the set of coupled equations over the D and E variables is intractable, as its solution would require to track an exponentially large (in the genome length) number of quantities. There is no doubt that simplifying approximations are needed, but I am worried that the range of validity of these approximations is not adequately studied here. My concerns are:</p><p>1) The dimensionality of the problem is reduced from exponential to linear (in the number of sites) for the D probabilities, while the E probabilities are restricted to a discrete set of points in the fitness space. The corresponding equations, respectively, 19 and 15, are obtained by ad hoc modifications from the original evolution equations, i.e. they are not derived by clear methods that would help the reader understand the magnitude of the terms neglected. It is far from being clear if and when these approximations are acceptable. Again, I understand that approximations are needed, I simply would like to see some justification or some conditions under which the approximations would not affect too much the outcome. The necessity of dimensional reduction is not specific to computational evolutionary biology. Chemical master equations are also virtually of infinite dimensions, and cannot be solved without simplifications, in particular finite-state projections, reminiscent of the procedures followed in the present manuscript. The accuracy of these simplifications is a subject of concern and is studied, see for instance Munsky and Kammash (2006, J. Chem. Phys.).</p><p>2) Another drastic hypothesis, besides dimensional reduction, is the decorrelation of sites in the fitness function, see Equation 12. Obviously, epistatic effects are present in reality, and it is therefore important to understand how they would bias the estimates of the fitness effects predicted by the algorithm. This point is studied with the simulated 2-site model (bottom panels in Figure 1), but I was unable to understand what the conclusion (the obvious fact that errors grow with the strength of selection against the double mutant) entails for more complex cases. What can we expect as the genome size grows, and epistatic effects accumulate? Even in the absence of coupling in the fitness, the quality of the prediction of site-fitness effects seems to deteriorate rapidly with the genome size, from 2 to 10 sites, see top panels in Figure 3. The latter size is comparable to the number (9) of mutations studied for GP, but how much could the results of Table 1 affected by the other, not studied mutations in this Ebola virus protein?</p><p>3) Across a large phylogenetic tree, it is expected that the relationship between the fitness and the sequences varies across lineages, e.g. owing to changes in the environmental conditions. I wonder how much such effects could influence the predictions for the fitness effects output by the algorithm. To be more specific, suppose that the fitness f changes by some epsilon (depending on the lineage n), how much would the D and E probabilities change? I expect that this could be studied numerically in the small size models, or even analytically with linear-response theory. Assessing the robustness of the predictions against slight variations in the sequence-to-fitness relation is an important issue.</p><p>As a conclusion, this work is interesting and can be appreciated as a valuable effort to solve an important problem in phylogeny/sequences estimation. A substantial number of further investigations is, however, required to assess the validity and robustness of the method, before one can fully trust its predictions.</p><p><italic>Reviewer #3:</italic> </p><p>This is an interesting paper that addresses the problem of jointly modeling mutation, selection, and sampling from a population, where the individuals are related through a phylogenetic tree. The idea is that selection can alter the expected shape of a tree, and therefore the tree shape is informative about both the genotypic state, and the selection coefficient.</p><p>The model builds upon an earlier work (Stadler and Bonhoeffer, 2013) in which a model for the evolution of a single site under selection was introduced. The current paper extends this model to multiple sites under selection. The authors achieve this by making additional assumptions, boiling down to assuming no linkage between these sites.</p><p>I am unsure about one aspect of the model – the initialisation of the variable D(t), which is initialized as the product of the probability a lineage is sampled upon death, s, and the rate that the lineage dies, d. I don't see why the death rate comes into this – if one state has a particularly low death rate, it seems that we should be likely to see it, rather than less likely – after all the pathogen does not need to die for the sample to be taken.</p><p>The authors show that they are able to infer the selection coefficient / fitness cost in a 4-genotype scenario, where the fitness cost is 0.5. In the application to actual data, the corresponding parameter is inferred to be in the range 5-15%, rather than 50%; and many of the inferences include 0 in their 95% confidence interval. As it stands it is hard to have strong confidence in these results, as there are no simulations to show that the model is sufficiently powered and provides reasonably unbiased estimates in this regime. It would be very helpful if the authors could provide a simulation with parameters in the regime appropriate for the real data.</p></body></sub-article><sub-article article-type="reply" id="SA2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.45562.014</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><disp-quote content-type="editor-comment"><p>Reviewer #1:</p><p>I've been working in the field of phylodynamics for the last several years, and I can say that it's widely acknowledged how difficult it's been to bridge the more traditional craft of demographic inferences of population size and migration to more fundamental evolutionary insights of strain fitnesses. I applaud the efforts of Rasmussen and Stadler to tackle such an important issue in their manuscript &quot;Coupling adaptive molecular evolution to phylodynamics using fitness-dependent birth-death models&quot;. I believe this work represents an innovative modeling avenue to address fitness in phylodynamic inference and will eventually lead to many fruitful biological insights.</p><p>I found the model explication clear and well motivated. Although I admit difficulty with the full mathematical details, I could certainly follow the overall approach and was given a good sense of what approximations had been taken and why.</p><p>I believe the core modeling advance is completely sound and warrants publication. However, I believe that for eLife in particular, a manuscript should point the way towards biological insight. The application to Ebola in West Africa is not as biologically exciting as other systems; the method appears to work, but there's just little adaptive evolution going on. I believe the manuscript would find more traction with readers if it showed a clear example of elucidating impactful fitness differences in an evolving population.</p></disp-quote><p>Thanks for your comments, Trevor. We acknowledge that Ebola virus has had limited time to adapt to the human population, and other rapidly evolving viruses like influenza exhibit more adaptation.</p><disp-quote content-type="editor-comment"><p>Major suggestions:</p><p>1) My central suggestion would be to include a second biological example in which strain variation should be more apparent. Given David Rasmussen's expertise and the known biology of the system, I would suggest H3N2 influenza. Working with influenza phylogenies, there are often clear cut examples of new mutations emerging that rapidly increase in the population (such as HA1 F159Y, https://nextstrain.org/flu/seasonal/h3n2/ha/12y?c=gt-HA1_159). If a few of these genotypes are selected (such as those dictated by the Koel 7, see Koel et al., 2013), are there fitness differences visible in the phylogeny?</p><p>I'm not suggesting to do any sort of formal prediction from these fitnesses. Just to see if H3N2 phylogenies give reasonable model outputs.</p><p>Alternatively, if flu doesn't work as a motivating example, this should be discussed, as it's so obvious. I don't know if the low sampling fraction would pose an issue to the model.</p></disp-quote><p>We have now also applied our method to influenza H3N2 as a second motivating example. In particular, we applied our method to look at fitness variation among strains in the Perth 2009 antigenic cluster. This allows for direct comparisons of population-level fitness effects estimated using our method with those estimated by Lee et al. (2018) in vitro using deep mutational scanning.</p><p>However, we found it very difficult to estimate site-specific mutational fitness effects for H3N2, even when we restricted our analysis to a small subset of naturally occurring mutations. We think that this is likely due to the fact that many of these mutations occur only once in the phylogeny and in the same genetic background as other mutations, and this shared common ancestry between mutations creates a problem with identifiability similar to the problem of co-linearity among highly correlated variables in regression-type models.</p><p>While this is disappointing, we also performed a second analysis where we let the deep mutational scanning data from Lee et al. inform our MFBD about the fitness effects of the naturally occurring mutations. This model fit the H3N2 phylogeny dramatically better than a model where mutations were assumed to be neutral. Moreover, reconstructing the ancestral fitness of lineages in the phylogeny under this model revealed substantial fitness variation among lineages within the Perth 2009 cluster, with most lineages carrying a mildly deleterious mutation load.</p><p>Given that previous work on H3N2 has argued for the importance of fitness variation within antigenic clusters in determining which lineages survive (Luska and Lässig, 2014; Koelle and Rasmussen, 2015), we believe this application to H3N2 provides another example of how our model can be applied to gain biological insights into the mechanisms of pathogen adaptation.</p><p>Looking at the F159Y mutation would have also been be interesting. But we only considered lineages circulating between 2009 and 2012 in our analysis and all lineages circulating before 2014 have the F allele.</p><disp-quote content-type="editor-comment"><p>There were a couple issues I had with Ebola analysis. Nothing fundamental, but issues that should be addressed to get at the biology. These were:</p><p>2) I remain concerned about the conflation of epidemiological circumstance and evolutionary fitness in these inferences (Bedford and Malik, 2016, Cell). In particular, the GP A82V mutation corresponds cleanly to a transition from early circulation in Guinea to circulation in Sierra Leone. Could this be addressed technically by adding an additional &quot;site&quot; to the model distinguishing between Guinea, Sierra Leone and Liberia?</p></disp-quote><p>This is an excellent point. We have now rerun the Ebola analysis with the geographic location as an additional “site” as suggested. However, we found no differences in transmission rates between locations. The A82V and other mutant genotypes are actually estimated to have slightly larger fitness effects when we account for geographic effects due to a lower estimated fitness for the Makona genotype. The rank order of the genotype fitness values is largely conserved. These results are now included in the main text.</p><disp-quote content-type="editor-comment"><p>3) It seems funny to me to only look the subset of sites investigated by Urbanowicz et al. in the lab. There were other common mutations in GP that weren't looked at by Urbanowicz et al. For example, both R321K and E580G (https://nextstrain.org/ebola?c=gt-GP_321,580) are significantly more common than R29K, I371V and K439E (https://nextstrain.org/ebola?c=gt-GP_29,371,439). Thus, it's weird to me to present a table that lists fitness impacts of several mutations, when there are other mutations that are largely colinear with the presented mutations, that may have actually been the causal variants.</p><p>I have this same issue with genes outside of GP. There are highly successful mutations like NP R111C (https://nextstrain.org/ebola?c=gt-NP_111) that are not accounted for. These may be driving the fitness differences observed. For example, L177A visually correlates better with the successful clade than GP E410V, which received a lot of model weight.</p></disp-quote><p>While we acknowledge that any of these additional mutations might be driving fitness differences between lineage, we don’t believe including these mutations in our analysis is as interesting as including geographic effects. There will likely always be additional unmodeled sites affecting fitness, but our method is not intended to provide a complete “genome scan” for sites under selection. Rather it is a way to formally test hypotheses about the fitness effects of particular mutations. Thus while our analysis is limited to the mutations studied by Urbanowicz et al., this is the intended use of our method and similar to what we imagine others will use the method for.</p><disp-quote content-type="editor-comment"><p>Is it possible to put forth a more systematic approach here? I don't think with what's been done that it's possible to conclude much about genetic variants driving transmission differences during the West African epidemic. I worry that handing out an approach as described will lead to people cherry picking what sites they use to define strains in subsequent analyses. There should be some guidance for how to approach this objectively.</p></disp-quote><p>We discuss issues with differentiating between the fitness effects of individual mutations versus unmodeled fitness variation in the Discussion. We also warn against over interpreting estimates of mutational fitness effects unless “they occur in multiple genetic backgrounds and confounding sources of fitness variation can be accounted for”. Furthermore, we think that including the additional Ebola analysis with geographic effects provides a good example of how conclusions about the fitness effects of particular mutations can and should be tested by including other potentially confounding sources of fitness variation in the analysis.</p><p>However, we agree with the reviewer that there is likely a more general way of accounting for unmodeled fitness effects. We now suggest one potential approach in the Discussion:</p><p>“In the future, the MFBD could be extended to account for unmodeled sources of fitness variation. For example, each lineage could be assigned a random fitness effect representing the unmodeled components of fitness variation. These random effects could then be modeled as a continuous trait evolving along lineages, such that more closely related lineages would be expected to have similar fitness due to shared genetic ancestry and overly large changes in fitness between closely related lineages would be penalized. Such a model would then allow us to say whether or not a mutational fitness effect could be equally well explained by random effects arising from unmodeled effects.”</p><disp-quote content-type="editor-comment"><p>Reviewer #2:</p><p>[…]</p><p>My first comment is about the accessibility of the paper, more precisely, whether it is self-contained or not. While some compromise has always to be made between a full, self-contained presentation and the necessity to have a reasonable length, I think the manuscript should be made more accessible. I had to go to Stadler and Bonhoeffer (2013) to understand clearly the meaning of the main quantities (D<sub>n,i</sub> and E<sub>i</sub>); inserting a figure similar to Figure 1 of that paper would be useful. Equations 2 and 3, which are identical to the ones of Stadler and Bonhoeffer (apart from the presence of mutations – γ<sub>i,j</sub> – instead of lineage – λ<sub>i,j</sub> – rates), are also better explained in that paper. Furthermore, the presence of the normalization factor including the probability of being observed in Equation 5 is not really explained here. Again, the 2013 paper was helpful to understand the origin of this denominator.</p></disp-quote><p>We have tried our best to make the model description as clear, precise and accessible as possible. But we envision our paper having two types of readers: those more interested in the biological applications and those more interested in the mathematical details. For the first type of reader, we have included a high-level summary of the model in Figure 1. For those interested in the mathematical details, we have chosen to devote more space to describing the new marginal fitness-birth-death model in detail than the original multi-type model. We agree with the reviewer that a reader interested in the full details of the original multi-type model may need to go back and consult Stadler and Bonhoeffer (2013).</p><p>We have made adjustments to improve accessibility as the reviewer suggested. Most notably, we have followed the reviewers suggestion and added a panel to Figure 1 illustrating the original multi-type birth-death model (including the D<sub>n,I</sub> and E<sub>i</sub> probabilities) and how this differs from the new marginal fitness birth-death model. We also now describe the normalization factor used in Equation 5 to condition the birth-death process on leaving at least on sampled descendent.</p><disp-quote content-type="editor-comment"><p>Secondly, I agree that the set of coupled equations over the D and E variables is intractable, as its solution would require to track an exponentially large (in the genome length) number of quantities. There is no doubt that simplifying approximations are needed, but I am worried that the range of validity of these approximations is not adequately studied here. My concerns are:</p><p>1) The dimensionality of the problem is reduced from exponential to linear (in the number of sites) for the D probabilities, while the E probabilities are restricted to a discrete set of points in the fitness space. The corresponding equations, respectively, 19 and 15, are obtained by ad hoc modifications from the original evolution equations, i.e. they are not derived by clear methods that would help the reader understand the magnitude of the terms neglected. It is far from being clear if and when these wild approximations are acceptable. Again, I understand that approximations are needed, I simply would like to see some justification or some conditions under which the approximations would not affect too much the outcome. The necessity of dimensional reduction is not specific to computational evolutionary biology. Chemical master equations are also virtually of infinite dimensions, and cannot be solved without simplifications, in particular finite-state projections, reminiscent of the procedures followed in the present manuscript. The accuracy of these simplifications is a subject of concern and is studied, see for instance Munsky and Kammash (2006, J. Chem. Phys.).</p></disp-quote><p>We agree with the reviewer that we gave too little attention to the validity of our approximations under different conditions in the original manuscript. Thus, instead of focusing our analysis of the four-genotype model on individual simulated phylogenies, we now more broadly explore how well the MFBD performs against the exact multi-type birth-death model under different evolutionary dynamics including over a wide range of mutation rates, selection coefficients and epistatic fitness effects. In particular, Figures 3 and 4 now compare the D and E probabilities along a lineage approximated under the MFBD model with the exact model. This new analysis shows that the MFBD approximates the D and E probabilities well under most conditions and that only under rather extreme conditions (very strong selection or epistatic interactions) do approximations introduce appreciable error. But even in these extreme cases the overall magnitude of error introduced is rather small.</p><p>In the revision, we also now give more attention to the approximation we used to track the E probabilities in discretized fitness space. While the reviewer sees our approximation as “wild”, we show that our approximation tracks the E probabilities well for a given lineage (see new Figure 4). In fact, using an even more dramatic approximation used in previous multi-type birth-death methods (Rabosky et al., 2014; Barido-Sottani et al., 2018), where transitions between states/fitness classes are ignored altogether along unobserved lineages, still provides accurate results. Thus, while neither approximation tracks the detailed dynamics of how unobserved lineages move through genotype space and thus fitness space, this does not seem necessary in order to capture the overall dynamics of how the E probabilities evolve backwards in time, which is all that is necessary for the MFBD model.</p><disp-quote content-type="editor-comment"><p>2) Another drastic hypothesis, besides dimensional reduction, is the decorrelation of sites in the fitness function, see Equation 12. Obviously, epistatic effects are present in reality, and it is therefore important to understand how they would bias the estimates of the fitness effects predicted by the algorithm. This point is studied with the simulated 2-site model (bottom panels in Figure 1), but I was unable to understand what the conclusion (the obvious fact that errors grow with the strength of selection against the double mutant) entails for more complex cases. What can we expect as the genome size grows, and epistatic effects accumulate? Even in the absence of coupling in the fitness, the quality of the prediction of site-fitness effects seems to deteriorate rapidly with the genome size, from 2 to 10 sites, see top panels in Figure 3. The latter size is comparable to the number (9) of mutations studied for GP, but how much could the results of Table 1 affected by the other, not studied mutations in this Ebola virus protein?</p></disp-quote><p>We expect that the between-site correlations we found for the two-site, four-genotype model would persist between any pair of sites, regardless of the total genome length, because we are assuming complete linkage between sites (no recombination). Thus, we always expect the correlations to become stronger as the strength of selection or epistatic fitness effects grows, regardless of genome length.</p><p>However, we do not believe these correlations cause the accuracy of our estimated site-specific fitness effects to decline with more sites. A far more likely reason for this decline is that the complexity of the genetic background in which mutations occur increases with more sites. Mutations therefore start to occur in the same genetic background as other mutations, making it difficult to estimate the effects of individual mutations. This leads to more uncertainty and variability in our estimates of site-specific effects, which explains the loss of accuracy with increasing numbers of sites.</p><disp-quote content-type="editor-comment"><p>3) Across a large phylogenetic tree, it is expected that the relationship between the fitness and the sequences varies across lineages, e.g. owing to changes in the environmental conditions. I wonder how much such effects could influence the predictions for the fitness effects output by the algorithm. To be more specific, suppose that the fitness f changes by some epsilon (depending on the lineage n), how much would the D and E probabilities change? I expect that this could be studied numerically in the small size models, or even analytically with linear-response theory. Assessing the robustness of the predictions against slight variations in the sequence-to-fitness relation is an important issue.</p></disp-quote><p>We also expect that the sequence-to-fitness relationship would vary across the phylogeny due to changes in environmental conditions or other unmodeled fitness effects, such as mutations at other sites. One way of assessing the impact of this background fitness variation on our fitness estimates is to directly incorporate potentially confounding variables into the model. Following the suggestion of reviewer #1, we now take this approach in our Ebola analysis by including the geographic location of lineages in our fitness model.</p><p>In the Discussion, we also now suggest a more principled approach to dealing with background variation in fitness due to unmodeled effects: random fitness effects could be assigned to individual lineages, allowing us to say whether a fitness effect ascribed to a particular mutation could equally well be explained by random effects representing unmodeled sources of fitness variation.</p><p>We could, as the reviewer suggests, also perform an analysis where we add background “noise” into the mapping between sequences and fitness, but it seems reasonable to expect that the quality of our estimates would depend entirely on the magnitude of this noise.</p><disp-quote content-type="editor-comment"><p>As a conclusion, this work is interesting and can be appreciated as a valuable effort to solve an important problem in phylogeny/sequences estimation. A substantial number of further investigations is, however, required to assess the validity and robustness of the method, before one can fully trust its predictions.</p><p>Reviewer #3:</p><p>This is an interesting paper that addresses the problem of jointly modeling mutation, selection, and sampling from a population, where the individuals are related through a phylogenetic tree. The idea is that selection can alter the expected shape of a tree, and therefore the tree shape is informative about both the genotypic state, and the selection coefficient.</p><p>The model builds upon an earlier work (Stadler and Bonhoeffer, 2013) in which a model for the evolution of a single site under selection was introduced. The current paper extends this model to multiple sites under selection. The authors achieve this by making additional assumptions, boiling down to assuming no linkage between these sites.</p></disp-quote><p>Yes, except to clarify we are actually assuming complete linkage between sites because we do not consider recombination. However, along an individual lineage, we are assuming correlations between the state of different sites can be ignored when calculating genotype probabilities. This is actually quite different from assuming no linkage in a standard population genetics model, where recombination would break up correlations between alleles at different sites at the population level. Our assumption is much more restricted: we are only assuming these correlations can be ignored at the level of an individual lineage.</p><disp-quote content-type="editor-comment"><p>I am unsure about one aspect of the model – the initialisation of the variable D(t), which is initialized as the product of the probability a lineage is sampled upon death, s, and the rate that the lineage dies, d. I don't see why the death rate comes into this – if one state has a particularly low death rate, it seems that we should be likely to see it, rather than less likely – after all the pathogen does not need to die for the sample to be taken.</p></disp-quote><p>In our version of the multi-type birth-death model, sampling is assumed to be coupled to death/removal events. A sampled individual must therefore have died to be sampled, and the D(t) probabilities need to reflect this. However, a lineage can die and not be sampled, and in this case the reviewer’s reasoning is correct: a lineage with a lower death rate will have a higher probability of surviving and therefore of being observed at a future sampling event.</p><p>The MTBD can be reformulated such that individuals can be sampled independently of death rates, but we would then need to take into account <italic>sampled ancestors</italic> where a sampled lineage can survive and produce other sampled lineages after the time of sampling. This can be done (see Kühnert et al., 2016), but we feel that this is beyond the scope of an already rather long paper.</p><disp-quote content-type="editor-comment"><p>The authors show that they are able to infer the selection coefficient / fitness cost in a 4-genotype scenario, where the fitness cost is 0.5. In the application to actual data, the corresponding parameter is inferred to be in the range 5-15%, rather than 50%; and many of the inferences include 0 in their 95% confidence interval. As it stands it is hard to have strong confidence in these results, as there are no simulations to show that the model is sufficiently powered and provides reasonably unbiased estimates in this regime. It would be very helpful if the authors could provide a simulation with parameters in the regime appropriate for the real data.</p></disp-quote><p>We do consider estimating site-specific fitness effects in the 5-15% range in Figure 6, where the mutational fitness effects in these simulations were chosen to randomly vary between ~0.4 and ~1.2. While these simulations were not exactly calibrated to the epidemiology of Ebola, they do show that our model can consistently estimate site-specific fitness effects over a wide range of birth rates, mutation rates, sampling fractions and even mutational fitness effects.</p></body></sub-article></article>