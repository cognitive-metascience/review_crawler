<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1 20151215//EN"  "JATS-archivearticle1.dtd"><article article-type="research-article" dtd-version="1.1" xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn pub-type="epub" publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">43803</article-id><article-id pub-id-type="doi">10.7554/eLife.43803</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Tools and Resources</subject></subj-group><subj-group subj-group-type="heading"><subject>Computational and Systems Biology</subject></subj-group><subj-group subj-group-type="heading"><subject>Genetics and Genomics</subject></subj-group></article-categories><title-group><article-title>Identifying gene expression programs of cell-type identity and cellular activity with single-cell RNA-Seq</article-title></title-group><contrib-group><contrib contrib-type="author" corresp="yes" equal-contrib="yes" id="author-125183"><name><surname>Kotliar</surname><given-names>Dylan</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-7968-645X</contrib-id><email>dylan_kotliar@hms.harvard.edu</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="fn" rid="equal-contrib1">†</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund3"/><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><contrib contrib-type="author" equal-contrib="yes" id="author-127404"><name><surname>Veres</surname><given-names>Adrian</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="aff" rid="aff4">4</xref><xref ref-type="fn" rid="equal-contrib1">†</xref><xref ref-type="other" rid="fund1"/><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><contrib contrib-type="author" id="author-141853"><name><surname>Nagy</surname><given-names>M Aurel</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0003-4608-1152</contrib-id><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="aff" rid="aff5">5</xref><xref ref-type="other" rid="fund1"/><xref ref-type="fn" rid="con3"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><contrib contrib-type="author" id="author-127406"><name><surname>Tabrizi</surname><given-names>Shervin</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0003-2780-8432</contrib-id><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="fn" rid="con4"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><contrib contrib-type="author" id="author-127407"><name><surname>Hodis</surname><given-names>Eran</given-names></name><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="aff" rid="aff6">6</xref><xref ref-type="other" rid="fund1"/><xref ref-type="fn" rid="con5"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><contrib contrib-type="author" id="author-9075"><name><surname>Melton</surname><given-names>Douglas A</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0002-1623-5504</contrib-id><xref ref-type="aff" rid="aff4">4</xref><xref ref-type="aff" rid="aff7">7</xref><xref ref-type="fn" rid="con6"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><contrib contrib-type="author" id="author-15499"><name><surname>Sabeti</surname><given-names>Pardis C</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="aff" rid="aff7">7</xref><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="fn" rid="con7"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><aff id="aff1"><label>1</label><institution content-type="dept">Department of Systems Biology</institution><institution>Harvard Medical School</institution><addr-line><named-content content-type="city">Boston</named-content></addr-line><country>United States</country></aff><aff id="aff2"><label>2</label><institution>Broad Institute of MIT and Harvard</institution><addr-line><named-content content-type="city">Cambridge</named-content></addr-line><country>United States</country></aff><aff id="aff3"><label>3</label><institution content-type="dept">Harvard-MIT Division of Health Sciences and Technology</institution><institution>Massachusetts Institute of Technology</institution><addr-line><named-content content-type="city">Cambridge</named-content></addr-line><country>United States</country></aff><aff id="aff4"><label>4</label><institution content-type="dept">Harvard Stem Cell Institute</institution><institution>Harvard University</institution><addr-line><named-content content-type="city">Cambridge</named-content></addr-line><country>United States</country></aff><aff id="aff5"><label>5</label><institution content-type="dept">Department of Neurobiology</institution><institution>Harvard Medical School</institution><addr-line><named-content content-type="city">Boston</named-content></addr-line><country>United States</country></aff><aff id="aff6"><label>6</label><institution content-type="dept">Biophysics Program</institution><institution>Harvard University</institution><addr-line><named-content content-type="city">Cambridge</named-content></addr-line><country>United States</country></aff><aff id="aff7"><label>7</label><institution>Howard Hughes Medical Institute</institution><addr-line><named-content content-type="city">Chevy Chase</named-content></addr-line><country>United States</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Valencia</surname><given-names>Alfonso</given-names></name><role>Reviewing Editor</role><aff><institution>Barcelona Supercomputing Center - BSC</institution><country>Spain</country></aff></contrib><contrib contrib-type="senior_editor"><name><surname>Barkai</surname><given-names>Naama</given-names></name><role>Senior Editor</role><aff><institution>Weizmann Institute of Science</institution><country>Israel</country></aff></contrib></contrib-group><author-notes><fn fn-type="con" id="equal-contrib1"><label>†</label><p>These authors contributed equally to this work</p></fn></author-notes><pub-date date-type="publication" publication-format="electronic"><day>08</day><month>07</month><year>2019</year></pub-date><pub-date pub-type="collection"><year>2019</year></pub-date><volume>8</volume><elocation-id>e43803</elocation-id><history><date date-type="received" iso-8601-date="2018-11-21"><day>21</day><month>11</month><year>2018</year></date><date date-type="accepted" iso-8601-date="2019-07-07"><day>07</day><month>07</month><year>2019</year></date></history><permissions><copyright-statement>© 2019, Kotliar et al</copyright-statement><copyright-year>2019</copyright-year><copyright-holder>Kotliar et al</copyright-holder><ali:free_to_read/><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><ali:license_ref>http://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-43803-v2.pdf"/><abstract><object-id pub-id-type="doi">10.7554/eLife.43803.001</object-id><p>Identifying gene expression programs underlying both cell-type identity and cellular activities (e.g. life-cycle processes, responses to environmental cues) is crucial for understanding the organization of cells and tissues. Although single-cell RNA-Seq (scRNA-Seq) can quantify transcripts in individual cells, each cell’s expression profile may be a mixture of both types of programs, making them difficult to disentangle. Here, we benchmark and enhance the use of matrix factorization to solve this problem. We show with simulations that a method we call consensus non-negative matrix factorization (cNMF) accurately infers identity and activity programs, including their relative contributions in each cell. To illustrate the insights this approach enables, we apply it to published brain organoid and visual cortex scRNA-Seq datasets; cNMF refines cell types and identifies both expected (e.g. cell cycle and hypoxia) and novel activity programs, including programs that may underlie a neurosecretory phenotype and synaptogenesis.</p></abstract><kwd-group kwd-group-type="author-keywords"><kwd>gene expression programs</kwd><kwd>single-cell Rna-Seq</kwd><kwd>matrix factorization</kwd><kwd>visual cortex</kwd><kwd>brain organoids</kwd><kwd>synaptogenesis</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd>Human</kwd><kwd>Mouse</kwd></kwd-group><funding-group><award-group id="fund1"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000057</institution-id><institution>National Institute of General Medical Sciences</institution></institution-wrap></funding-source><award-id>T32GM007753</award-id><principal-award-recipient><name><surname>Kotliar</surname><given-names>Dylan</given-names></name><name><surname>Veres</surname><given-names>Adrian</given-names></name><name><surname>Nagy</surname><given-names>M Aurel</given-names></name><name><surname>Hodis</surname><given-names>Eran</given-names></name></principal-award-recipient></award-group><award-group id="fund2"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000060</institution-id><institution>National Institute of Allergy and Infectious Diseases</institution></institution-wrap></funding-source><award-id>R01AI099210</award-id><principal-award-recipient><name><surname>Sabeti</surname><given-names>Pardis C</given-names></name></principal-award-recipient></award-group><award-group id="fund3"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000038</institution-id><institution>U.S. Food and Drug Administration</institution></institution-wrap></funding-source><award-id>HHSF223201810172C</award-id><principal-award-recipient><name><surname>Kotliar</surname><given-names>Dylan</given-names></name><name><surname>Sabeti</surname><given-names>Pardis C</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>A novel algorithm, consensus non-negative matrix factorization (cNMF), accurately identifies gene expression programs underlying cell-type identity and cellular activities from single-cell RNA-Seq data.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>Genes act in concert to maintain a cell’s identity as a specific cell type, to respond to external signals, and to carry out complex cellular activities such as replication and metabolism. Coordinating the necessary genes for these functions is frequently achieved through transcriptional co-regulation, where genes are induced together as a gene expression program (GEP) in response to the appropriate internal or external signal (<xref ref-type="bibr" rid="bib13">Eisen et al., 1998</xref>; <xref ref-type="bibr" rid="bib43">Segal et al., 2003</xref>). By enabling unbiased measurement of the whole transcriptome, profiling technologies such as RNA-Seq are paving the way for systematically discovering GEPs and shedding light on the biological mechanisms that they govern (<xref ref-type="bibr" rid="bib31">Liberzon et al., 2015</xref>).</p><p>Single-cell RNA-Seq (scRNA-Seq) has greatly enhanced our potential to resolve GEPs by making it possible to observe variation in gene expression over many individual cells. Even so, inferring GEPs remains challenging as scRNA-Seq data is noisy and high-dimensional, requiring computational approaches to uncover the underlying patterns. In addition, technical artifacts such as doublets (where two or more distinct cells are mistakenly collapsed into one) can confound analysis. Methodological advances in dimensionality reduction, clustering, lineage trajectory tracing, and differential expression analysis have helped overcome some of these issues (<xref ref-type="bibr" rid="bib3">Amir et al., 2013</xref>; <xref ref-type="bibr" rid="bib23">Kharchenko et al., 2014</xref>; <xref ref-type="bibr" rid="bib40">Satija et al., 2015</xref>; <xref ref-type="bibr" rid="bib52">Trapnell et al., 2014</xref>).</p><p>Here, we focus on a key challenge of inferring expression programs from scRNA-Seq data: the fact that individual cells may express multiple GEPs but we only detect cellular expression profiles that reflect their combination, rather than the GEPs themselves. A cell’s gene expression is shaped by many factors including its cell type, its state in time-dependent processes such as the cell cycle, and its response to varied environmental stimuli (<xref ref-type="bibr" rid="bib53">Wagner et al., 2016</xref>). We group these into two broad classes of expression programs that can be detectable in scRNA-Seq data: (1) GEPs that correspond to the identity of a specific cell type such as hepatocyte or melanocyte (identity programs) and (2) GEPs that are expressed independently of cell type, in any cell that is carrying out a specific activity such as cell division or immune cell activation (activity programs). In this formulation, identity programs are expressed uniquely in cells of a specific cell type, while activity programs may vary dynamically in cells of one or multiple types and may be continuous or discrete.</p><p>Thus far, the vast majority of scRNA-Seq studies have focused on systematically identifying and characterizing the expression programs of cell types composing a given tissue, that is identity GEPs. Substantially less progress has been made in identifying activity GEPs, primarily through direct manipulation of cells in controlled experiments, for example comparing stimulated and unstimulated neurons (<xref ref-type="bibr" rid="bib21">Hrvatin et al., 2018</xref>) or cells pre- and post-viral infection (<xref ref-type="bibr" rid="bib47">Steuerman et al., 2018</xref>).</p><p>If a subset of cells profiled by scRNA-Seq expresses a given activity GEP, there is a potential to directly infer the program from the data without the need for controlled experiments. However, this can be significantly more challenging than ascertaining identity GEPs; while some cells may have expression profiles that are predominantly the output of an identity program, activity programs will always be expressed alongside the identity programs of one or frequently many cell types. Thus, while finding the average expression of clusters of similar cells may often be sufficient for finding reasonably accurate identity GEPs, it will often fail for activity GEPs.</p><p>We hypothesized that we could infer activity GEPs directly from variation in single-cell expression profiles using matrix factorization. In this context, matrix factorization would model the gene expression data matrix as the product of two lower rank matrices, one encoding the relative contribution of each gene to each program, and a second specifying the proportions in which the programs are combined for each cell. We refer to the second matrix as a ‘usage’ matrix as it specifies how much each GEP is ‘used’ by each cell in the dataset (<xref ref-type="bibr" rid="bib46">Stein-O'Brien et al., 2018</xref>) (<xref ref-type="fig" rid="fig1">Figure 1A</xref>). Unlike hard clustering, which reduces all cells in a cluster to a single shared GEP, matrix factorization allows cells to express multiple GEPs. Thus, this computational approach would allow cells to express one or more activity GEPs in addition to their expected cell-type GEP, and could correctly model doublets as a combination of the identity GEPs for the combined cell types. To the best of our knowledge, no previously reported studies have benchmarked the ability of matrix factorization methods to accurately learn identity and activity GEPs from scRNA-Seq profiles.</p><fig id="fig1" position="float"><object-id pub-id-type="doi">10.7554/eLife.43803.002</object-id><label>Figure 1.</label><caption><title>Schematics of matrix factorization for single-cell RNA-Seq analysis and the consensus matrix factorization pipeline.</title><p>(<bold>a</bold>) Schematic representation of how cellular gene expression can be modeled with matrix factorization. The gene expression profiles of individual cells (left bar charts) are weighted mixtures of a set of global gene expression programs (right bar charts) with distinct weights reflecting the usage of each program (middle pie chart). Variable usage of the activity programs is represented by the number of blue circles and orange squares in each cell. (<bold>b</bold>) Schematic of the consensus matrix factorization pipeline.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig1-v2.tif"/></fig><p>We see three primary motivations for jointly inferring identity and activity GEPs in scRNA-Seq data. First, systematic discovery of GEPs could reveal unexpected or novel activity programs reflecting important biological processes (e.g. immune activation or hypoxia) in the context of the native biological tissue. Second, it could enable characterization of the prevalence of each activity GEP across cell types in the tissue. Finally, accounting for activity programs could improve inference of identity programs by avoiding spurious inclusion of activity program genes in the latter. GEPs corresponding to different phases of the cell cycle are examples of widespread activity programs and are well-known to confound identity (cell type) program inference in scRNA-Seq data (<xref ref-type="bibr" rid="bib10">Chen and Zhou, 2017</xref>; <xref ref-type="bibr" rid="bib42">Scialdone et al., 2015</xref>). However, cell-cycle is just one instance of the broader problem of confounding of identity and activity programs.</p><p>While matrix factorization is widely used as a preprocessing step in scRNA-Seq analysis, a priori it is unclear which, if any, factorization approaches would be most appropriate for inferring biologically meaningful GEPs. In particular, Principal Component Analysis (PCA), Independent Component Analysis (ICA), Latent Dirichlet Allocation (LDA) (<xref ref-type="bibr" rid="bib7">Blei et al., 2003</xref>) and Non-Negative Matrix Factorization (NMF)(<xref ref-type="bibr" rid="bib27">Lee and Seung, 1999</xref>) have been used for dimensionality reduction of data prior to downstream analysis or as an approach to cell clustering. However, while PCA (<xref ref-type="bibr" rid="bib44">Shalek et al., 2014</xref>; <xref ref-type="bibr" rid="bib47">Steuerman et al., 2018</xref>), NMF (<xref ref-type="bibr" rid="bib35">Puram et al., 2017</xref>) and ICA (<xref ref-type="bibr" rid="bib41">Saunders et al., 2018</xref>) components have been interpreted as activity programs, the dimensions inferred by these or other matrix factorization algorithms may not necessarily align with biologically meaningful gene expression programs and are frequently ignored in practice. This is because each method makes different simplifying assumptions that are potentially inappropriate for gene expression data. For example, NMF and LDA are non-negative and so cannot directly model repression. ICA components are statistically independent, PCA components are mutually orthogonal, and both allow gene expression to be negative. Furthermore, none of these methods, except LDA, explicitly accounts for the count distribution of expression data in their error models.</p><p>In this study, we motivate, validate, and enhance the use of matrix factorization for GEP inference. Using simulations, we show that despite their simplifying assumptions, ICA, LDA, and NMF—but not PCA—can accurately discover both activity and identity GEPs. However, due to inherent randomness in their algorithms, they give substantially varying results when repeated multiple times, which hinders their interpretability. We therefore implemented a meta-analysis approach (<xref ref-type="fig" rid="fig1">Figure 1B</xref>), which demonstrably increased robustness and accuracy. Overall, the meta-analysis of NMF, which we call Consensus NMF (cNMF), gave the best performance in these simulations.</p><p>Applied to three real datasets generated by three different scRNA-Seq platforms, cNMF inferred expected activity programs (cell-cycle programs in a brain organoid dataset and depolarization induced programs in visual cortex neurons), an unanticipated hypoxia program, and intriguing novel activity programs. It also enhanced cell type characterization and enabled estimation of rates of activity across cell types. These findings on real datasets further validate our approach as a useful analysis tool to understand complex signals within scRNA-Seq data.</p></sec><sec id="s2" sec-type="results"><title>Results</title><sec id="s2-1"><title>Evaluation of matrix factorization for GEP inference in simulated data</title><p>We sought to establish whether components inferred by simple matrix factorizations would align with GEPs in scRNA-seq data. We evaluated this in simulated data of 15,000 cells composed of 13 cell types, one cellular activity program that is active to varying extents in a subset of cells of four cell types, and a 6% doublet rate (<xref ref-type="fig" rid="fig2">Figure 2A</xref>). We generated 20 replicates of this simulation, each at three different ‘signal to noise’ ratios, in order to determine how matrix factorization accuracy varies with noise level (Materials and methods).</p><fig-group><fig id="fig2" position="float"><object-id pub-id-type="doi">10.7554/eLife.43803.003</object-id><label>Figure 2.</label><caption><title>cNMF infers identity and activity expression programs in simulated data.</title><p>(<bold>a</bold>) t-distributed stochastic neighbor embedding (tSNE) plot of an example simulation showing different cell types with marker colors, doublets as gray Xs, and cells expressing the activity gene expression program (GEP) with a black edge. (<bold>b</bold>) Pearson correlation between the true GEPs and the GEPs inferred by cNMF for the simulation in (<bold>a</bold>). (<bold>c</bold>) Same tSNE plot as (<bold>a</bold>) but colored by the simulated or the cNMF inferred usage of an example identity program (left) or the activity program (right). (<bold>d</bold>) Percentage of 20 simulation replicates where an inferred GEP had Pearson correlation greater than 0.80 with the true activity program for each signal to noise ratio (parameterized by the mean log2 fold-change for a differentially expressed gene). (<bold>e</bold>) Receiver Operator Characteristic (except with false discovery rate rather than false positive rate) showing prediction accuracy of genes associated with the activity GEP. (<bold>f</bold>) Scatter plot comparing the simulated activity GEP usage and the usage inferred by cNMF for the simulation in (<bold>a</bold>). For cells with a simulated usage of 0, the inferred usage is shown as a box and whisker plot with the box corresponding to interquartile range and the whiskers corresponding to 5th and 95th percentiles. (<bold>g</bold>) Contour plot of the true GEP usage on the Y-axis and the second true GEP usage for doublets or the second highest GEP usage inferred by cNMF for singletons for the simulation in (<bold>a</bold>). 1000 randomly selected cells are overlayed as a scatter plot for each group.</p><p><supplementary-material id="fig2sdata1"><object-id pub-id-type="doi">10.7554/eLife.43803.012</object-id><label>Figure 2—source data 1.</label><caption><title>Benchmarking of matrix factorizations on simulated data.</title></caption><media mime-subtype="zip" mimetype="application" xlink:href="elife-43803-fig2-data1-v2.zip"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig2-v2.tif"/></fig><fig id="fig2s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.004</object-id><label>Figure 2—figure supplement 1.</label><caption><title>Robustness of matrix factorization methods.</title><p>(<bold>a</bold>) Pairwise correlation coefficients for all components combined across 200 replicates for multiple simulations (rows) and multiple matrix factorization algorithms (columns). All 14 components for each replicate were assigned in a one-to-one fashion to a ground truth GEP in order from most correlated to least correlated. Components are ordered in each heatmap by the assigned ground truth GEP which is denoted by the outer color bars. The three simulations had different average signal strengths as parameterized by the mean log2 fold-change for differentially expressed genes in a GEP (Online Methods) and are ordered from least signal (top row) to most signal (bottom row). (<bold>b</bold>) Components from the 200 replicates were assigned to a ground truth GEP, as in (<bold>a</bold>), and were correlated with the median of their assigned group. Then, for each factorization replicate, the 14 components were ranked in order from most to least correlated. The plots shows the % of replicates where the kth most correlated component had a Pearson correlation &gt;0.9 with the median of the components assigned to the same ground truth GEP. We plot the mean and standard deviation of this percentage across the 20 replicates as bars around the mean, and plot individual dots for simulation replicates that exceeded one standard deviation of the mean.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig2-figsupp1-v2.tif"/></fig><fig id="fig2s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.005</object-id><label>Figure 2—figure supplement 2.</label><caption><title>Deconvolution accuracy of matrix factorization methods.</title><p>(<bold>a</bold>) Pearson correlation between ground truth GEP means (rows) and GEPs inferred by different iterations of NMF (left), cNMF, or PCA (right) for an example simulation. All correlations are computed considering only the 2000 most over-dispersed genes and on vectors normalized by the computed sample standard deviation of each gene. Arrows annotate cases where GEPs were merged into a single component or a GEP was split into two components. (<bold>b</bold>) Pearson correlation between inferred GEPs and true simulated GEPs for several matrix factorization methods across all 20 simulation replicates for each average signal level. (<bold>c</bold>) Percentage of simulation replicates for which GEPs of each type had a pearson correlation of R &gt; 0.8 with the true simulated GEP, as a function of the average signal level.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig2-figsupp2-v2.tif"/></fig><fig id="fig2s3" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.006</object-id><label>Figure 2—figure supplement 3.</label><caption><title>Diagnostic plot for cNMF on an example simulated dataset.</title><p>(<bold>a</bold>) Number of cNMF components (K) against solution stability (blue, left axis) measured by the euclidean distance silhouette score of the clustering, and Frobenius error of the consensus solution (red, right axis), with the K selection used in the manuscript indicated with a line. (<bold>b</bold>) Plot of the Log10 proportion of variance explained per principal component, with the K selection used in the manuscript indicated with a dotted line. (<bold>c</bold>) Clustergram showing the clustered NMF components for K = 14, combined across 200 replicates, before (left) and after filtering (right). In between is a histogram of the average distance of each component to its 60 nearest neighbors with a dashed line where we set the threshold for filtering outliers.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig2-figsupp3-v2.tif"/></fig><fig id="fig2s4" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.007</object-id><label>Figure 2—figure supplement 4.</label><caption><title>GEP usage inference.</title><p>(<bold>a</bold>) Comparison of GEP usage inference by cNMF, cLDA, and cICA for an example identity GEP (top row) and the activity GEP (bottom row). Each cell is represented as a point and its usage is represented by the marker color. (<bold>b</bold>) Comparison of the results of ground truth cluster assignment and Louvain clustering represented on a t-SNE plot. (Left) Reproduction of <xref ref-type="fig" rid="fig1">Figure 1b</xref> which shows cells colored based on their true identity program, doublets marked with an X, and cells that express the activity program with a black border. (Middle) Cells are colored based on Louvain clustering. (Right) Cells with activity GEP usage of greater than 40% are assigned to an activity cluster, and all other cells were assigned to their identity cluster. This shows how an optimal hard clustering might behave in the context of mixed membership.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig2-figsupp4-v2.tif"/></fig><fig id="fig2s5" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.008</object-id><label>Figure 2—figure supplement 5.</label><caption><title>Accuracy of identifying genes in each GEP.</title><p>(<bold>a</bold>) Receiver operating characteristics (ROCs) but showing false discovery rate (FDR) on the X-axis against sensitivity on the Y-axis for detection of genes in GEPs. Separate curves are shown for cNMF, cICA, cLDA, NMF, ICA, LDA, ground truth cluster assignment, Louvain clustering, or PCA. These show combined results for all 20 simulations with mean log2 fold-change = 1.00. Sensitivity is calculated considering genes with a differential expression fold-change of &gt;= 2 and FDR is calculated considering genes with no differential expression (fold change = 1) (<bold>b</bold>) Same as (<bold>a</bold>) but only showing the results for the activity GEP and plotted separately for each of the 20 simulations at the mean differential expression log2 fold-change of 1.00.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig2-figsupp5-v2.tif"/></fig><fig id="fig2s6" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.009</object-id><label>Figure 2—figure supplement 6.</label><caption><title>Comparison of run-times for different matrix factorization algorithms.</title><p>Run-time in seconds for NMF, ICA, and LDA for a simulated scRNA-Seq dataset down-sampled to 6250, 12,500, 25,000, or 50,000 cells, run either using eight CPUs or four CPUs. Estimates are the average of three independent replicates with different seeds.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig2-figsupp6-v2.tif"/></fig><fig id="fig2s7" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.010</object-id><label>Figure 2—figure supplement 7.</label><caption><title>cNMF demonstration on simulated datasets with 50% doublets.</title><p>(<bold>a</bold>) tSNE plot for a simulated dataset with 50% doublets with marker color and edge color representing the simulated cell types. (<bold>b</bold>) K selection diagnostic plot showing solution stability (measured by the silhouette distance) in blue and Frobenius error of the consensus solution in red. (<bold>c</bold>) Pairwise Pearson correlation between ground truth GEP means (rows) and GEPs inferred by cNMF (columns) for the 50% doublet simulation dataset.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig2-figsupp7-v2.tif"/></fig><fig id="fig2s8" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.011</object-id><label>Figure 2—figure supplement 8.</label><caption><title>Impact of variable cell-type proportions on GEP inference.</title><p>(<bold>a</bold>) Visualization and inference of simulated scRNA-Seq data with the same parameters presented in <xref ref-type="fig" rid="fig2">Figure 2a</xref> but with 15 cell-types at variable frequencies corresponding to the proportions of cell-type clusters in the Hrvatin Et. Al visual cortex dataset. (<bold>b</bold>) The same as (<bold>a</bold>) but using a differential expression location parameter of 2.0 instead of 1.0, corresponding to GEPs that are more divergent from each other. The leftmost panels show the t-distributed stochastic neighbor embedding (tSNE) plot for the simulations, representing cell types with distinct marker colors, doublets as gray Xs, and cells expressing the activity gene expression program (GEP) with a black edge. In the heatmaps to the right, we display the Pearson correlation of the ground truth GEPs with the programs inferred by cNMF, cICA, and Louvain clustering. All correlations are computed considering only the 2000 most over-dispersed genes and on vectors normalized by the computed sample standard deviation of each gene. The GEPs are labeled by the type of GEP (activity, I for identity only, and I + A for cell-types that express the activity GEP) and with the frequency of the cell-type in the data.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig2-figsupp8-v2.tif"/></fig></fig-group><p>We first analyzed the performance of ICA, LDA, and NMF and noticed that they yielded different solutions when run several times on the same input simulated data. We ran each method 200 times and assigned the components in each run to their most correlated ground-truth program. We saw that there was significant variability among the components assigned to the same program -- particularly for NMF and LDA (<xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>). Unlike PCA, which has an exact solution, these factorizations use stochastic optimization algorithms to obtain approximate solutions in a solution space including many local optima. We observed that such local optima frequently corresponded to solutions where a simulated GEP was split into multiple inferred components and/or multiple GEPs were merged into a single component (<xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2a</xref>). This variability reduces the interpretability of the solutions and may decrease the accuracy as well.</p><p>To overcome the issue of variability of solutions, we employed a meta-analysis approach, which we call consensus matrix factorization, that averages over multiple replicates to increase the robustness of the solution. The method which is adapted from a similar procedure in mutational signature discovery (<xref ref-type="bibr" rid="bib2">Alexandrov et al., 2013</xref>) proceeds as follows: we run the factorization multiple times, filter outlier components (which tend to represent noise or merges/splits of GEPs), cluster the components over all replicates combined, and take the cluster medians as our consensus estimates. With these estimates fixed, we are able to compute a final usage matrix specifying the contribution of each GEP in each cell and to transform our GEP estimates from normalized units to biologically meaningful ones such as transcripts per million (TPM). This approach also provides us with a guide for determining K, the number of components to use, by selecting a value that provides a reasonable trade-off between error and stability (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3a</xref>, see Materials and methods for details). We refer to this approach as consensus matrix factorization based on its analogy with consensus clustering (<xref ref-type="bibr" rid="bib33">Monti et al., 2003</xref>) and to its application to LDA, NMF, and ICA, as cLDA, cNMF, and cICA respectively. While consensus clustering has been previously applied to bulk gene expression analysis using hard-clustering derived by binarizing NMF factors (<xref ref-type="bibr" rid="bib9">Brunet et al., 2004</xref>), our approach does not require any hard cluster assignments.</p><p>Consensus matrix factorization inferred components underlying the GEPs as well as which cells expressed each GEP (<xref ref-type="fig" rid="fig2">Figure 2b–c</xref>, <xref ref-type="fig" rid="fig2s4">Figure 2—figure supplement 4a</xref>). By contrast, principal components were linear combinations of the true GEPs. Beyond increasing the robustness of the solution, the consensus approach also increased the ability of factorization to deconvolute the true GEPs - most dramatically for LDA and NMF which had the most stochastic variability. cNMF successfully deconvoluted the activity and identity GEPs more frequently than the other matrix factorizations considered (<xref ref-type="fig" rid="fig2">Figure 2d</xref>, <xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2</xref>).</p><p>We next sought to benchmark the sensitivity and specificity of each matrix factorization method for inferring which genes are associated with each GEP. We also evaluated the performance of hard clustering for this task because clustering is the most common way GEPs are identified in practice. We evaluated the commonly used Louvain community detection clustering algorithm (<xref ref-type="bibr" rid="bib8">Blondel et al., 2008</xref>; <xref ref-type="bibr" rid="bib28">Levine et al., 2015</xref>) but also considered an upper bound on how well any discrete clustering could perform by using ground-truth to assign cells to a cluster of its cell type or to an activity cluster if it had &gt;= 40% simulated contribution from the activity GEP (<xref ref-type="fig" rid="fig2s4">Figure 2—figure supplement 4b</xref>). We evaluated the association between genes and GEPs using linear regression and measured accuracy using a receiver operator characteristic (Materials and methods).</p><p>We found that cNMF was most accurate at inferring genes in the activity program, with a sensitivity of 61% at a false discovery rate (FDR) of 5% (<xref ref-type="fig" rid="fig2">Figure 2e</xref>). cICA and the ground-truth clustering were the next most accurate with 57% and 56% sensitivity at a 5% FDR, respectively. cNMF also performed the best at inferring identity GEPs of the 4 cell types that expressed the activity (<xref ref-type="fig" rid="fig2s5">Figure 2—figure supplement 5</xref>). As expected, the clustering approaches performed worse as they inappropriately assigned activity GEP genes to these identity programs, resulting in an elevated FDR. This illustrates how matrix factorization can outperform clustering for inference of the genes associated with activity and identity GEPs.</p><p>We decided to proceed with cNMF to analyze the real datasets due its accuracy, processing speed, and interpretability. First, it yielded the most accurate inferences in our simulated data. Second, NMF was the fastest of the basic factorization algorithms considered, which is especially useful given the need to run multiple replicates and given the growing sizes of scRNA-Seq datasets (<xref ref-type="fig" rid="fig2s6">Figure 2—figure supplement 6</xref>). Third, the non-negativity assumption of NMF naturally results in usage and component matrices that can be normalized and interpreted as probability distributions—that is, where the usage matrix reflects the probability of each GEP being used in each cell, and the component matrix reflects the probability of a specific transcript expressed in a GEP being a specific gene. The other high-performing factorization method, cICA, produced negative values in the components and usages which precludes this interpretation.</p><p>Beyond identifying the activity program itself, we found that cNMF could also accurately infer which cells expressed the activity program and what proportion of their expression was derived from the activity program (<xref ref-type="fig" rid="fig2">Figure 2f</xref>). With an expression usage threshold of 10%, cNMF accurately classified 91% of cells expressing the activity program and 94% of cells that did not express the program. Moreover, we observed a high Pearson correlation between the inferred and simulated usages in cells that expressed the program (R = 0.74 for all simulations combined, R = 0.68 for the example simulation in <xref ref-type="fig" rid="fig2">Figure 2a</xref>). Thus, cNMF can be used both to infer which cells express the activity program, as well as what proportion of their transcripts derive from that program.</p><p>We further demonstrated that cNMF was robust to the presence of doublets—instances where two cells are mistakenly labeled as a single cell. Due to limitations in the current tissue dissociation and single-cell sequencing technologies, some number of ‘cells’ in an scRNA-Seq dataset will actually correspond to doublets. Several computational methods have been developed to identify cells that correspond to doublets, but this is still an important artifact in scRNA-Seq data (<xref ref-type="bibr" rid="bib32">McGinnis et al., 2018</xref>; <xref ref-type="bibr" rid="bib56">Wolock et al., 2018</xref>). We found that cNMF correctly modeled doublets as a combination of the GEPs for the two combined cell types (<xref ref-type="fig" rid="fig2">Figure 2g</xref>). Moreover, we found that cNMF could accurately infer the GEPs even in a simulated dataset composed of 50% doublets (<xref ref-type="fig" rid="fig2s7">Figure 2—figure supplement 7</xref>). This illustrates another benefit of representing cells in scRNA-Seq data as a mixture of GEPs rather than classifying them into discrete clusters.</p><p>In all the simulations described above, the 13 cell-types occurred at uniform frequencies. This allowed us to treat all identity programs as replicates of each other for evaluating inference accuracy, rather than having to separately consider rare GEPs which should, all else equal, be harder to infer than common ones. However, this is an approximation of reality where cell-type proportions can vary over multiple orders of magnitude. We therefore also performed simulations containing biologically plausible cell-type proportions derived from the published clustering of a dataset analyzed later in this manuscript (<xref ref-type="bibr" rid="bib21">Hrvatin et al., 2018</xref>) (Materials and methods). When we kept all of the other simulation parameters identical to those of the initial simulations, some identity GEPs from rare cell-types were missed by cNMF, cICA, and Louvain clustering (<xref ref-type="fig" rid="fig2s8">Figure 2—figure supplement 8a</xref>). However, when we increased the distinctness of the identity GEPs of the cell types, they could still be inferred by both cICA and cNMF with similar relative performances to what we saw in the primary benchmarking analysis (<xref ref-type="fig" rid="fig2s8">Figure 2—figure supplement 8b</xref>). This suggests that the simplification of uniform cell-type frequencies does not significantly impact our conclusions.</p></sec><sec id="s2-2"><title>cNMF deconvolutes hypoxia and cell-cycle activity GEPs from identity GEPs in brain organoid data</title><p>Having demonstrated its performance and utility on simulated data, we then used cNMF to re-analyze a published scRNA-Seq dataset of 52,600 single cells isolated from human brain organoids (<xref ref-type="bibr" rid="bib36">Quadrato et al., 2017</xref>). The initial report of this data confirmed that organoids contain excitatory cell types homologous to those in the cerebral cortex and retina as well as unexpected cells of mesodermal lineage, but further resolution can be gained on the precise cell types and how they differentiate over time. As organoids contain many proliferating cell types, we sought to use this data to confirm that cNMF could detect activity programs—in this case, cell cycles programs—in real data, and to explore what biological insights could be gained from their identification.</p><p>We identified 31 distinct programs in this dataset that could be further parsed into identity and activity programs (<xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1</xref>). We distinguished between identity and activity programs by using the fact that activity programs can occur in multiple diverse cell types while identity programs represent a single-cell type. Most cells had high usage of just a single GEP, which is consistent with expressing just an identity program (<xref ref-type="fig" rid="fig3">Figure 3a</xref>). When cells expressed multiple GEPs, those typically had correlated expression profiles, suggesting that they correspond to identity programs of closely related cell types or cells transitioning between two developmental states, rather than activity programs (<xref ref-type="fig" rid="fig3s2">Figure 3—figure supplement 2</xref>). By contrast, three GEPs were co-expressed with many distinct and uncorrelated programs, suggesting that they represent activity programs that occur across diverse cell types (<xref ref-type="fig" rid="fig3">Figure 3a–b</xref>). Consistent with this, the 28 suspected identity programs were well separated by the cell-type clusters reported in <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref> while the three suspected activity programs were expressed by cells across multiple clusters (<xref ref-type="fig" rid="fig3s3">Figure 3—figure supplements 3</xref>–<xref ref-type="fig" rid="fig3s4">4</xref>). Except for a few specific cases discussed below, we used these published cluster labels to annotate our identity GEPs.</p><fig-group><fig id="fig3" position="float"><object-id pub-id-type="doi">10.7554/eLife.43803.013</object-id><label>Figure 3.</label><caption><title>Deconvolution of activity programs from cell identity in brain organoid data.</title><p>(<bold>a</bold>) Heatmap showing percent usage of all GEPs (rows) in all cells (columns). Identity GEPs are shown on top and activity GEPs are shown below. Cells are grouped by their maximum identity GEP and fit into columns of a fixed width for each identity GEP. (<bold>b</bold>) tSNE plot of the brain organoid dataset with cells colored by their maximally used identity GEP, and with a black edge for cells with &gt;10% usage of the G1/S or G2/M activity GEP or a maroon edge for cells with &gt;10% usage of the hypoxia GEP. (<bold>c</bold>) Table of P-values for the top six Gene Ontology geneset enrichments for the three activity GEPs. (<bold>d</bold>) Heatmap of z-scores of top genes associated with three mesodermal programs, in those programs (top), and in all other programs (bottom). (<bold>e</bold>) Heatmap of z-scores of top genes associated with three activity GEPs, in those programs (top), and in all other programs (bottom). (<bold>f</bold>) Proportion of cells assigned to each identity GEP that express the G1/S or G2/M program with a percent usage greater than 10%. (<bold>g</bold>) Proportion of cells assigned to each identity GEP that express the hypoxia program with a percent usage greater than 10%.</p><p><supplementary-material id="fig3sdata1"><object-id pub-id-type="doi">10.7554/eLife.43803.018</object-id><label>Figure 3—source data 1.</label><caption><title>Application of cNMF to brain organoid data.</title></caption><media mime-subtype="zip" mimetype="application" xlink:href="elife-43803-fig3-data1-v2.zip"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig3-v2.tif"/></fig><fig id="fig3s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.014</object-id><label>Figure 3—figure supplement 1.</label><caption><title>Diagnostic plot for cNMF on the <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref> brain organoid dataset.</title><p>(<bold>a</bold>) Number of cNMF components (K) against solution stability (blue, left axis) measured by the silhouette score of the clustering, and Frobenius error of consensus solution (red, right axis). (<bold>b</bold>) Plot of the Log10 proportion of variance explained per principal component, with the K selection used in the manuscript indicated with a dotted line. (<bold>c</bold>) Clustergram showing the clustered NMF components for K = 31, combined across 500 replicates, before (left) and after filtering (right). In between is a histogram ofthe average distance of each component to its 150 nearest neighbors with a dashed line where we set the threshold for filtering outliers.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig3-figsupp1-v2.tif"/></fig><fig id="fig3s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.015</object-id><label>Figure 3—figure supplement 2.</label><caption><title>Correlation between GEP spectra pairs and fraction of cells that use both programs.</title><p>Scatter plot of the pearson correlation between pairs of GEPs (X axis) and the fraction of cells that co-use the GEP pair (Y axis). Co-usage is defined as the number of cells with usage &gt;0.1 for both programs divided by the number of cells that use the less common of the programs with usage &gt;0.1. Dots are colored by whether or not the GEP pair is made up of identity or any of the three activity programs.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig3-figsupp2-v2.tif"/></fig><fig id="fig3s3" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.016</object-id><label>Figure 3—figure supplement 3.</label><caption><title>t-SNE plots of identity and activity GEPs in the <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref> brain organoid dataset.</title><p>t-SNE plots of cells colored by maximum identity GEP usage (left) or by absolute usage of each activity GEP (right).</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig3-figsupp3-v2.tif"/></fig><fig id="fig3s4" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.017</object-id><label>Figure 3—figure supplement 4.</label><caption><title>Comparison of cNMF usages with the cell-type clusters from <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref>.</title><p>Box and whisker plot of the usage of each GEP (column) in cells of the clusters from <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref> (rows). Boxes represent interquartile range, whiskers represent 5th and 95th percentiles.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig3-figsupp4-v2.tif"/></fig></fig-group><p>Our 28 identity programs further refined the 10 primary cell-type clusters originally reported for this dataset. For example, we noticed that cells previously annotated as mesodermal predominantly expressed one of three GEPs that were significantly enriched for genes in the ‘Muscle Contraction’ Gene Ontology (GO) set (p&lt;1×10<sup>−10</sup> vs. p&gt;0.19 for all other GEPs). They therefore likely represent muscle cells. Inspecting the genes associated with these three GEPs, we noticed that they include genes characteristic of different classes of skeletal muscle: (1) immature skeletal muscle (e.g. <italic>MYOG</italic>, <italic>TNNT2</italic>, <italic>NES</italic>), (2) fast-twitch muscle (e.g. <italic>TNNT3</italic>, <italic>TNNC2</italic>, <italic>MYOZ1</italic>), and (3) slow-twitch muscle (e.g. <italic>TNNT1</italic>, <italic>TNNC1</italic>, <italic>TPM3</italic>) (<xref ref-type="fig" rid="fig3">Figure 3d</xref>, <xref ref-type="supplementary-material" rid="supp1">Supplementary file 1</xref>). This unexpected finding suggests that distinct populations of skeletal muscle cells -- excitatory cell types with many similarities to neurons -- are differentiating in these brain organoids.</p><p>Of the three activity programs identified, we found that two were strongly enriched for cell cycle Gene Ontology (GO) sets, suggesting that they correspond to separate phases of the cell cycle (<xref ref-type="fig" rid="fig3">Figure 3c</xref>). One showed stronger enrichment for genesets involved in DNA replication (e.g. DNA Replication p=3×10<sup>−52</sup> compared to p=2×10<sup>−3</sup>) while the other showed stronger enrichment for genesets involved in mitosis (e.g. Mitotic Nuclear Division, p=4×10<sup>−61</sup> compared to p=2×10<sup>−46</sup>). These enrichments and inspection of the genes most associated with these programs implied that one represents a G1/S checkpoint program and the other represents a G2/M checkpoint program (<xref ref-type="fig" rid="fig3">Figure 3e</xref>). Thus, cNMF discovered two activity programs corresponding to separate phases of the cell cycle directly from the data.</p><p>The third activity program is characterized by high levels of hypoxia related genes (e.g. <italic>VEGFA</italic>, <italic>PGK1</italic>, <italic>CA9</italic>, <italic>P4HA1</italic>, <italic>HILPDA</italic>) suggesting it represents a hypoxia program (<xref ref-type="fig" rid="fig3">Figure 3e</xref>). This is consistent with the lack of vasculature in organoids which makes hypoxia an important growth constraint (<xref ref-type="bibr" rid="bib22">Kelava and Lancaster, 2016</xref>). This GEP is most significantly enriched for genesets related to protein localization to the endoplasmic reticulum and nonsense mediated decay (p=3×10<sup>−37</sup>, p=5×10<sup>−31</sup>) (<xref ref-type="fig" rid="fig3">Figure 3c</xref>), consistent with reports that hypoxia post-transcriptionally increases expression of genes that are translated in the ER (<xref ref-type="bibr" rid="bib45">Staudacher et al., 2015</xref>) and modulates nonsense mediated decay activity (<xref ref-type="bibr" rid="bib16">Gardner, 2008</xref>). In the initial report of this data, staining for a single hypoxia gene, <italic>HIF1A</italic>, failed to detect significant levels of hypoxia. Indeed, <italic>HIF1A</italic> is not strongly associated with this GEP, at least not at the transcriptional level. This highlights the ability of our unbiased approach to detect unanticipated activity programs in scRNA-Seq data.</p><p>Having identified proliferation and hypoxia activity programs, we sought to quantify their relative rates across cell types in the data. We found that 3079 cells (5.9%) expressed the G1/S program and 2043 cells (3.9%) expressed the G2/M program (with usage &gt;= 10%). Classifying cells into cell types according to their most used identity program, we found that many distinct populations were replicating. For example, cNMF detected a rare population, included with the forebrain cluster in the original report, that we label as ‘stem-like’ based on high expression of pluripotency markers (e.g. <italic>LIN28A</italic>, <italic>L1TD1</italic>, <italic>MIR302B</italic>, <italic>DNMT3B</italic>) (<xref ref-type="supplementary-material" rid="supp1">Supplementary file 1</xref>). These cells showed the highest rates of proliferation with over 38% of them expressing a cell-cycle program in addition to the ‘stem-like’ identity GEP (<xref ref-type="fig" rid="fig3">Figure 3f</xref>).</p><p>cNMF was further able to refine cell types by disentangling the contributions of identity and activity programs to the gene expression of cells. For example, we found that a cell cluster labeled in <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref> as ‘proliferative precursors’, based on high expression of cell-cycle genes, is composed of multiple cell types including immature muscle and dopaminergic neurons (<xref ref-type="fig" rid="fig3s4">Figure 3—figure supplement 4</xref>). The predominant identity GEP of cells in this cluster is most strongly associated with the gene PAX7, a marker of self-renewing muscle stem cells (<xref ref-type="bibr" rid="bib34">Pawlikowski et al., 2009</xref>) (<xref ref-type="supplementary-material" rid="supp1">Supplementary file 1</xref>). Indeed, this GEP has high (&gt;10%) usage in 41% of cells who’s most used GEP is the immature muscle program, suggesting it may be a precursor of muscle cells. This relationship was not readily identifiable by clustering because the majority of genes associated with the cluster were cell cycle related.</p><p>We also saw a wide range of cell types expressing the hypoxia program, with the highest rates in C6-1, neuroepithelial-1, type 2 muscle, and dopaminergic-2 cell types. The lowest levels of hypoxia program usage occurred in forebrain, astroglial, retinal, and type 1 muscle cell types (<xref ref-type="fig" rid="fig3">Figure 3g</xref>). The hypoxia response program is widespread in this dataset with 5788 cells (11%) of all cells expressing it (usage &gt;10%). This illustrates how inferring activity programs in scRNA-Seq data using cNMF makes it possible to compare the rates of cellular activities across cell types.</p></sec><sec id="s2-3"><title>cNMF identifies depolarization induced and novel activity programs in scRNA-Seq of mouse visual cortex neurons</title><p>Next we turned to another published dataset to further validate cNMF and to illustrate how it can be combined with scRNA-Seq of experimentally manipulated cells to uncover more subtle activity programs. We re-analyzed scRNA-Seq data from 15,011 excitatory pyramidal neurons or inhibitory interneurons from the visual cortex of dark-reared mice that were suddenly exposed to 0 hr, 1 hr, or 4 hr of light (<xref ref-type="bibr" rid="bib21">Hrvatin et al., 2018</xref>). This allowed the authors to identify transcriptional changes induced by repeated depolarization, a phenomenon believed to be critical for proper cortical function. To increase our resolution to identify neuronal activity programs, we used the published clustering to exclude any non-neuronal cells that were also captured by the experiment from our dataset. We sought to determine whether cNMF would identify the relatively modest activity programs (~60 genes with fold-change &gt;= 2 and FDR &lt; 0.05) elicited by the experiment without knowledge of the experimental design labels. Furthermore, since the authors identified heterogeneity in stimulus-responsive genes between neuronal subtypes, we wondered if cNMF would identify a common activity program and whether it could tease out patterns in what is shared or divergent across neuron subtypes.</p><p>We ran cNMF on neurons combined from all three exposure conditions and identified 20 GEPs, interpreting 14 as identity and six as activity programs (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>). As we saw in the organoid data, the activity programs were co-expressed with many distinct and uncorrelated GEPs while the identity programs only overlapped in related cell types (<xref ref-type="fig" rid="fig4">Figure 4a–b</xref>). In addition, the identity programs were well separated by the published clusters while the activity programs were spread across multiple clusters (<xref ref-type="fig" rid="fig4s2">Figure 4—figure supplement 2</xref>). We thus used the published cluster annotations to label the identity GEPs.</p><fig-group><fig id="fig4" position="float"><object-id pub-id-type="doi">10.7554/eLife.43803.019</object-id><label>Figure 4.</label><caption><title>Identification of activity programs in neurons of the visual cortex.</title><p>(<bold>a</bold>) Heatmap showing percent usage of all GEPs (rows) in all cells (columns). Identity GEPs are shown on top and activity GEPs are shown below. Cells are grouped by their maximum identity GEP and fit into columns of a fixed width for each identity GEP. (<bold>b</bold>) t-SNE plots of cells colored by maximum identity GEP usage (left) or by absolute usage of each activity GEP (right). (<bold>c</bold>) Box and whisker plot showing the percent usage of activity programs (rows) in cells classified according to their maximum identity GEP (columns) and stratified by the stimulus condition of the cells (hue). The central line represents the median, boxes represent the interquartile range, and whiskers represent the 5th and 95th quantile. (<bold>d</bold>) Scatter plot of z-scores of the superficial late response GEP in the primary dataset against the corresponding GEP in the <xref ref-type="bibr" rid="bib49">Tasic et al. (2016)</xref> dataset. (<bold>e</bold>) Same as (<bold>d</bold>) but for the neurosecretory activity program.</p><p><supplementary-material id="fig4sdata1"><object-id pub-id-type="doi">10.7554/eLife.43803.023</object-id><label>Figure 4—source data 1.</label><caption><title>Application of cNMF to mouse visual cortex data.</title></caption><media mime-subtype="zip" mimetype="application" xlink:href="elife-43803-fig4-data1-v2.zip"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig4-v2.tif"/></fig><fig id="fig4s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.020</object-id><label>Figure 4—figure supplement 1.</label><caption><title>Diagnostic plot for cNMF on the <xref ref-type="bibr" rid="bib21">Hrvatin et al. (2018)</xref> visual cortex dataset.</title><p>(<bold>a</bold>) Number of cNMF components (K) against solution stability (blue, left axis) measured by the silhouette score and Frobenius error of consensus solution (red, right axis). (<bold>b</bold>) Plot of the Log10 proportion of variance explained per principal component, with the K selection used in the manuscript indicated with a dotted line. (<bold>c</bold>) Clustergram showing the clustered NMF components for K = 20, combined across 500 replicates, before (left) and after filtering (right). In between is a histogram of the average distance of each component to its 150 nearest neighbors with a dashed line showing the threshold for filtering outliers.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig4-figsupp1-v2.tif"/></fig><fig id="fig4s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.021</object-id><label>Figure 4—figure supplement 2.</label><caption><title>Comparison of cNMF usages with the visual cortex cell-type clusters from <xref ref-type="bibr" rid="bib21">Hrvatin et al. (2018)</xref>.</title><p>Box and whisker plot of the usage of each GEP (column) in cells of each cluster from <xref ref-type="bibr" rid="bib21">Hrvatin et al. (2018)</xref> (rows) stratified by the stimulus condition of those cells (hue). Boxes represent interquartile range, whiskers represent 5th and 95th percentiles.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig4-figsupp2-v2.tif"/></fig><fig id="fig4s3" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.022</object-id><label>Figure 4—figure supplement 3.</label><caption><title>Comparison of GEPs identified in the <xref ref-type="bibr" rid="bib21">Hrvatin et al. (2018)</xref> and <xref ref-type="bibr" rid="bib49">Tasic et al. (2016)</xref> visual cortex datasets.</title><p>(<bold>a</bold>) Heatmap showing the odds ratio for the intersection of top associated genes in each inferred GEP in the <xref ref-type="bibr" rid="bib21">Hrvatin et al. (2018)</xref> and <xref ref-type="bibr" rid="bib49">Tasic et al. (2016)</xref> datasets. Top associated genes were defined as those with an association score &gt;= 0.0015. Odds ratios above 100 were set to 100 for better visualization of pairs in the lower range. GEPs from the Tasic et al. dataset are labeled as ABA for Allen Brain Atlas. (<bold>b</bold>) Proportion of cells of each cell type that express the superficial LRP with greater than 10% usage in the Tasic et al. dataset. Cells were assigned to a cell type based on their most used identity GEP.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig4-figsupp3-v2.tif"/></fig></fig-group><p>Three activity programs were correlated with the stimulus, which indicates that they are induced by repeated depolarization (<xref ref-type="fig" rid="fig4">Figure 4c</xref>). One of these was induced at 1h and thus corresponds to an early response program (ERP). The others were primarily induced at 4h and thus correspond to late response programs (LRPs). These programs overlapped significantly with the sets of differentially expressed genes reported in <xref ref-type="bibr" rid="bib21">Hrvatin et al. (2018)</xref> (p=8×10<sup>−34</sup> for the ERP and genes induced at 1h; p=4×10<sup>−22</sup>, p=4×10<sup>−14</sup> for the LRPs and genes induced at 4hs, one-sided Mann Whitney test).</p><p>Intriguingly, one LRP was more induced in superficial cortical layers, while the other was more induced in deeper layers. This supports a recently proposed model where the ERP is predominantly shared across excitatory neurons, while LRPs vary more substantially across neuron subtypes (<xref ref-type="bibr" rid="bib21">Hrvatin et al., 2018</xref>). It also illustrates cNMF’s sensitivity: in the initial report, only 64 and 53 genes were identified as differentially expressed in at least one excitatory cell type at 1h and 4hs (FC ≥2, FDR &lt; 0.05). Nevertheless, cNMF was able to find this program in an unsupervised manner, without knowledge of the experimental design. cNMF was also able to identify a depolarization induced program in visual cortex neurons that were not experimentally manipulated to elicit them. We analyzed an additional scRNA-Seq dataset of 1573 neurons from the visual cortex of adult mice that, unlike in the primary dataset, were not reared in darkness or treated with a specific light stimulus (<xref ref-type="bibr" rid="bib49">Tasic et al., 2016</xref>). In this dataset, cNMF identified a matching GEP for all visual cortex cell types found in the primary dataset except for a single subtype of excitatory layer 5 (<xref ref-type="fig" rid="fig4s3">Figure 4—figure supplement 3a</xref>). Moreover, it identified a GEP that showed striking concordance with the superficial LRP found in the primary dataset (Fisher Exact Test of genes with association z-score &gt;0.0015, OR = 127, p=1×10<sup>−118</sup>, Pearson Correlation = 0.645) (<xref ref-type="fig" rid="fig4">Figure 4d</xref>). This program was predominantly expressed in excitatory cells of the more superficial layers of the cortex as would be expected based on the results in the primary dataset. For example, over 40% of the excitatory layer 2 (Exc. L2) type neurons expressed this activity program (<xref ref-type="fig" rid="fig4s3">Figure 4—figure supplement 3b</xref>). This demonstrates that cNMF could also find the depolarization induced activity program in scRNA-Seq of cells that had not been experimentally manipulated to elicit it.</p><p>Finally, cNMF identified three additional activity programs in the primary visual cortex dataset that were not well correlated with the light stimulus but were expressed broadly across multiple neuronal cell types (<xref ref-type="fig" rid="fig4">Figure 4b–c</xref>). We labeled one of these, that was specific to excitatory neurons, as Neurosecretory (NS) because it is characterized by high expression of several secreted neuropeptides including <italic>Vgf</italic>, <italic>Adcyap1</italic>, <italic>Scg2</italic>, <italic>Cck</italic>, <italic>Scg3</italic>, and <italic>Dkk3,</italic> and has high expression of genes that facilitate protein secretion such as <italic>Cpe, Cadps2</italic>, and <italic>Scamp5</italic> (<xref ref-type="supplementary-material" rid="supp2">Supplementary file 2</xref>). The top expressed gene—<italic>Vgf</italic> (VGF nerve growth factor inducible) is induced by nerve growth factor (<xref ref-type="bibr" rid="bib39">Salton et al., 1991</xref>), suggesting that this program may be regulated by external growth factor signals. Notably, we found a matching program in the Tasic Et, Al. dataset (Fisher Exact Test of genes with association z-score &gt;0.0015, OR = 53.8, p=8×10<sup>−21</sup>, Pearson Correlation = 0.356) (<xref ref-type="fig" rid="fig4">Figure 4e</xref>). Thus, this neurosecretory activity program is reproducible across multiple single-cell datasets.</p><p>An additional activity program which we labeled Synaptogenesis (Syn) was characterized by expression of genes that play a crucial role in synapse formation, including the transcriptional regulator <italic>Mef2c </italic>(<xref ref-type="bibr" rid="bib4">Barbosa et al., 2008</xref>; <xref ref-type="bibr" rid="bib14">Flavell et al., 2008</xref>; <xref ref-type="bibr" rid="bib19">Harrington et al., 2016</xref>), synaptic adhesion molecules <italic>Ncam1 </italic>(<xref ref-type="bibr" rid="bib20">Hata et al., 2018</xref>) and <italic>Cadm1 </italic>(<xref ref-type="bibr" rid="bib6">Biederer et al., 2002</xref>; <xref ref-type="bibr" rid="bib38">Robbins et al., 2010</xref>), membrane vesicle traffickers <italic>Syt1</italic> and <italic>Syt4</italic>, <italic>Actb</italic> which constitutes the predominant synapse cytoskeletal protein, and others with a strong connection to synapse biology such as <italic>Ywhaz </italic>(<xref ref-type="bibr" rid="bib15">Foote et al., 2015</xref>; <xref ref-type="bibr" rid="bib37">Ramser et al., 2010</xref>; <xref ref-type="bibr" rid="bib57">Xu et al., 2015</xref>), <italic>Bicd1 </italic>(<xref ref-type="bibr" rid="bib1">Aguirre-Chen et al., 2011</xref>; <xref ref-type="bibr" rid="bib30">Li et al., 2010</xref>). It was also significantly enriched for relevant Gene Ontology sets including postsynapse, glutamatergic synapse, postsynaptic density, and dendrite morphogenesis (p&lt;=3.25×10<sup>−6</sup>, <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3</xref>) which further suggests its interpretation as a program involved in the formation or regulation of synapses. The last activity program (labeled Other) was characterized by high expression of the maternally expressed long non-coding RNA <italic>Meg3 </italic>(<xref ref-type="bibr" rid="bib58">Yan et al., 2016</xref>) and other genes that are associated with cerebral ischemic injury (e.g. <italic>Glg1</italic> [<xref ref-type="bibr" rid="bib60">Zhang et al., 1996</xref>]<italic>, Rtn1 </italic>[<xref ref-type="bibr" rid="bib17">Gong et al., 2017</xref>]). Our functional interpretations of the novel activity programs are speculative, but they highlight the ability of cNMF to identify intriguing GEPs in an unbiased fashion.</p></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>In this study, we distinguished between cell type (identity) and cell type independent (activity) gene expression programs (GEPs) to motivate our use of matrix factorization, which represents cells as linear combinations of multiple GEPs. However, we note that some biological programs are not neatly classified as either identity or activity GEPs. For example, cell states reflecting oncogenic transformation, or a cell’s position along a morphological gradient blur the distinction between identity and activity. In addition, stochastic fluctuations in individual transcription factors could result in coordinated gene expression changes (<xref ref-type="bibr" rid="bib51">Thattai and van Oudenaarden, 2001</xref>) and might be better described as a third program category, rather than as an identity or activity GEP. While the identity/activity distinction might not be appropriate in every case, matrix factorization should, in principle, be appropriate for representing all gene expression states that can be reasonably approximated as a linear mixture of programs.</p><p>Furthermore, in this study, we have provided an empirical foundation for the use of matrix factorization to simultaneously infer identity and activity programs from scRNA-Seq data. We first show with simulations that despite their simplifying assumptions, ICA, LDA, and NMF (but not PCA) can infer components that align well with GEPs. However, due to the stochastic nature of these algorithms, the interpretability and accuracy of individual solutions can be low. This led us to develop a consensus approach that empirically increased the accuracy and robustness of the solutions. cNMF inferred the most accurate identity and activity programs of all the methods we tested. Moreover, it yielded results in interpretable units of gene expression (transcripts per million) and could accurately infer the percentage of each cell’s expression that was derived from each GEP. These properties made it the most promising approach for GEP inference on real datasets.</p><p>We then explored the utility of cNMF on real data, recapitulating known GEPs, identifying novel ones, and further characterizing their usage. We first validated cNMF with several expected activity programs serving as positive controls. We then identified several unexpected but highly plausible programs, a hypoxia program in brain organoids and a depolarization-induced activity program in untreated neurons. Finally, we identified three novel programs in visual cortex neurons that we speculate may correspond to a neurosecratory phenotype, new synapse formation, and a stress response program. Beyond simply discovering activity programs, cNMF clarified the underlying cell types in these datasets by disentangling activity and identity programs from the mixed single-cell profiles. For example, we found that a brain organoid subpopulation that was initially annotated as proliferative precursors actually includes replicating cells of several cell types such as an immature skeletal muscle cell that is differentiating into slow-twitch and fast-twitch muscle populations. Furthermore, joint analysis of identity and activity GEPs allowed us to quantify the relative prevalence of activities across cell types. For example, we found in the visual cortex data that one depolarization-induced late response program was predominantly expressed in neurons of superficial cortical layers, while the other was mainly expressed in deeper layers. This suggests that an anatomical or developmental factor may underlie variability in the response. While commonly used approaches based on clustering or pseudotemporal ordering of cells are poorly suited to achieve such insights from single-cell data, these findings emerge naturally from our matrix factorization approach.</p><p>We have made our tools and analyses easily accessible so that researchers can readily use cNMF and further develop on the approach. We have deposited all the cNMF code on Github <ext-link ext-link-type="uri" xlink:href="https://github.com/dylkot/cNMF/">https://github.com/dylkot/cNMF/</ext-link> (<xref ref-type="bibr" rid="bib25">Kotliar, 2019</xref>; copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/cNMF">https://github.com/elifesciences-publications/cNMF</ext-link>) and have made available all of the analysis scripts for figures contained in this manuscript on Code Ocean (<ext-link ext-link-type="uri" xlink:href="https://doi.org/10.24433/CO.9044782e-cb96-4733-8a4f-bf42c21399e6">https://doi.org/10.24433/CO.9044782e-cb96-4733-8a4f-bf42c21399e6</ext-link>) for easy exploration and re-execution.</p><p>As others apply this approach, one key consideration will be the choice of the three input parameters required by cNMF: the number of components to be found (K), the percentage of replicates to use as nearest neighbors for outlier-detection, and a distance threshold for defining outliers. While the choice of K must ultimately reflect the resolution desired by the analyst, we propose two simple decision aids based on (1) considering the trade-off between factorization stability and reconstruction error and (2) looking at the proportion of variance explained by K principal components to estimate the dimensionality of the data (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>, <xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1</xref>, <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>). In addition, we noticed that choosing consecutive values of K primarily influenced individual components at the margin, suggesting that cNMF may be robust to this choice within a reasonable range of options (<xref ref-type="fig" rid="fig5">Figure 5</xref> and ‘Choosing the number of components’ section of the Materials and methods).</p><fig-group><fig id="fig5" position="float"><object-id pub-id-type="doi">10.7554/eLife.43803.024</object-id><label>Figure 5.</label><caption><title>Robustness of cNMF to the number of components (K).</title><p>Line plots of the maximum Pearson correlation between each of the cNMF components presented in the main analysis, and the cNMF components that result from multiple choices of K. For the simulated data, for which we have access to ground truth, we plot the correlation between the inferred components for each choice of K and the ground truth 14 components. We highlight components corresponding to activity GEPs with distinct colors and denote the number of identity GEPs contained on the same plot in parenthesis in the legend. A dashed line indicates the K choice that was presented in the main analysis. Pearson correlations are computed considering only the 2000 most over-dispersed genes and on vectors normalized by the computed sample standard deviation of each gene.</p><p><supplementary-material id="fig5sdata1"><object-id pub-id-type="doi">10.7554/eLife.43803.027</object-id><label>Figure 5—source data 1.</label><caption><title>Application of cNMF to pancreas data and analysis of robusness to the choice of K.</title></caption><media mime-subtype="zip" mimetype="application" xlink:href="elife-43803-fig5-data1-v2.zip"/></supplementary-material></p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig5-v2.tif"/></fig><fig id="fig5s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.025</object-id><label>Figure 5—figure supplement 1.</label><caption><title>Characterization of GEP usage across biological replicates.</title><p>(<bold>a</bold>) Heatmaps of aggregated GEP profiles for each biological replicate of the <xref ref-type="bibr" rid="bib21">Hrvatin et al. (2018)</xref> data, derived by summing the GEP usage vectors for all cells from a replicate. We plot the GEP profiles normalized to sum to one for each replicate (row) in the left panel or to sum to one for each GEP (column) in the right panel. The left panel contrasts the composition of the replicates while the right panels visualizes which replicates contributed most to each GEP. We use yellow arrows to highlight the usage of the depolarization-induced GEPs (ERP, LRP-S, and LRP-D) in replicates of mice treated with the stimulus condition (replicate names ending in _1 hr or _4 hr denoting the 1 hr or 4 hr treatments, respectively). For all heatmaps, rows are ordered by hierarchical clustering of the row-normalized matrix using the cosine metric and average linkage method. (<bold>b</bold>) The same as (<bold>a</bold>) but for the <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref> organoid data. We use yellow arrows to highlight the variability corresponding to the bioreactor from which the organoids derived (indicated in the beginning of the name).</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig5-figsupp1-v2.tif"/></fig><fig id="fig5s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.43803.026</object-id><label>Figure 5—figure supplement 2.</label><caption><title>Comparison of cNMF usages with the published cell-type clusters from <xref ref-type="bibr" rid="bib5">Baron et al. (2016)</xref>.</title><p>Box and whisker plot of the usage of each GEP (column) in cells of each cluster from <xref ref-type="bibr" rid="bib5">Baron et al. (2016)</xref> (rows) stratified by the donor of origin of each cell (hue). Boxes represent interquartile range, whiskers represent 5th and 95th percentiles.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-fig5-figsupp2-v2.tif"/></fig></fig-group><p>The additional two parameters allow users to optionally identify outlier replicates to filter before averaging across replicates. This improves overall accuracy by removing infrequent solutions that often represent merges or splits of the true GEPs. Using 30% of the number of replicates as nearest neighbors worked well for all datasets we analyzed, and an appropriate outlier distance threshold was clear in our applications based on the long tail in the distance distribution (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>, <xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1</xref>, <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>).</p><p>Our approach is an initial step toward disentangling identity and activity GEPs, and will benefit from subsequent development. For example, cNMF does not specifically address the count nature of gene expression. Recently developed statistical frameworks that address these aspects of scRNA-Seq data such as Hierarchical Poisson Factorization (<xref ref-type="bibr" rid="bib29">Levitin et al., 2018</xref>) may therefore increase the accuracy of GEP inference. In addition, NMF often yields low but non-zero usages for many GEPs even though we expect most cells to express a small number of identity and activity GEPs. This lack of sparsity is likely due to over-fitting and could be addressed by adding regularization to the model (<xref ref-type="bibr" rid="bib50">Taslaman and Nilsson, 2012</xref>). Such refinements and any new matrix factorization that relies on stochastic optimization can be readily combined with our consensus approach to potentially improve accuracy and interpretability.</p><p>A more fundamental limitation of matrix factorizations, including cNMF, is the built-in assumption that cells can be modeled as linear combinations of GEPs. Notably, this precludes modeling of transcriptional repression, where one or more genes that would be induced by one GEP are significantly reduced in expression when a second repressing GEP is active in the same cell. To our knowledge, such relationships have not been represented in a matrix factorization framework, but they may be easier to incorporate in new classes of latent variable models such as variational autoencoders (VAEs) (<xref ref-type="bibr" rid="bib11">Ding et al., 2018</xref>; <xref ref-type="bibr" rid="bib18">Grønbech et al., 2018</xref>). VAEs represent cells in a highly flexible latent space that can capture non-linearities and interactions between latent variables. However, while the latent variables are designed to facilitate accurate reconstruction of the input gene expression data, it remains to be shown whether they can be directly or indirectly interpreted as distinct GEPs and GEP usages. For the foreseeable future, there may be a trade-off between the flexibility of these models and the difficulty in training them and interpreting their output.</p><p>With ongoing technological progress in RNA capture efficiency and throughput, scRNA-Seq data is likely to become richer and more expansive. This will make it possible to detect increasingly subtle GEPs, reflecting biological variability in cell types, cell states, and activities. Here, we have demonstrated a computational framework that can be used to infer such GEPs directly from the scRNA-Seq data without the need for experimental manipulations, providing key insights into the behavior of cells and tissues.</p></sec><sec id="s4" sec-type="materials|methods"><title>Materials and methods</title><sec id="s4-1"><title>Simulations</title><p>Our simulation framework is based on Splatter (<xref ref-type="bibr" rid="bib59">Zappia et al., 2017</xref>) but is re-implemented in Python and adapted to allow simulation of doublets and activity programs. 14 gene-expression programs <inline-formula><mml:math id="inf1"><mml:mi>Z</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">N</mml:mi></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:msup></mml:math></inline-formula> (13 identity programs <inline-formula><mml:math id="inf2"><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub> <mml:mi/><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo> <mml:mi/><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:mn>13</mml:mn></mml:mrow></mml:msub></mml:math></inline-formula> and 1 activity program <inline-formula><mml:math id="inf3"><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, each a vector of M genes) were simulated as in Splatter. Cells were then randomly assigned to an identity program with equal probability for each class. 30% of cells of four cell types were randomly selected to express the activity program at a usage <inline-formula><mml:math id="inf4"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, uniformly distributed between 10% and 70%. In the Splatter notation, the pre-trended mean gene-expression profile <inline-formula><mml:math id="inf5"><mml:msubsup><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>'</mml:mi></mml:mrow></mml:msubsup></mml:math></inline-formula> for each cell i=1… 15,000 was computed as the weighted sum of the identity and the activity program:<disp-formula id="equ1"><mml:math id="m1"><mml:msubsup><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>'</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mo>(</mml:mo><mml:msub><mml:mrow><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:mi>I</mml:mi><mml:mo>(</mml:mo><mml:mi>i</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:math></disp-formula>where <inline-formula><mml:math id="inf6"><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the simulated library size for a cell, <inline-formula><mml:math id="inf7"><mml:mi>I</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> is the identity program assignment for cell i, and <inline-formula><mml:math id="inf8"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:math></inline-formula> for cells that do not express the activity GEP and <inline-formula><mml:math id="inf9"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo><mml:mi>U</mml:mi><mml:mi>n</mml:mi><mml:mi>i</mml:mi><mml:mi>f</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>m</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mn>0.1,0.7</mml:mn></mml:mrow></mml:mfenced></mml:math></inline-formula> for cells that do.</p><p>Doublets were constructed by randomly sampling pairs of cells, summing their simulated count vectors, and randomly down-sampling the counts until the total number of counts equaled the maximum of the library sizes of the original two cells. We simulated 25,000 genes, 1000 of which were associated with the activity program. The probability of a gene being differentially expressed in a cell identity program was set to 2.5%. The differential expression scale parameter was 1.0 for all simulations and the location parameter was either 1.0, 0.75, or 0.5 to simulate different signal to noise levels. Other splatter parameters were: lib.loc = 7.64, libscale = 0.78, mean_rate = 7.68, mean_shape = 0.34, expoutprob = 0.00286, expoutloc = 6.15, expoutscale = 0.49, diffexpdownprob = 0, bcv_dispersion = 0.448, bcv_dof = 22.087. These values were inferred from 8000 randomly sampled cells of the <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref> organoid dataset using Splatter. A differential expression location parameter of 1.0 were used for the 50% doublet simulation and all other parameters were kept the same (<xref ref-type="fig" rid="fig2s7">Figure 2—figure supplement 7</xref>). Differential expression location parameters of 1.0 and 2.0 were used for the two variable cell-type proportion simulations, and cell-type assignments were sampled from a multinomial with parameters (0.215, 0.210, 0.195, 0.130, 0.0924, 0.0328, 0.028, 0.0269, 0.0149, 0.0119, 0.0114, 0.009, 0.009, 0.008, 0.006) based on the proportions of neuronal cell-type clusters in <xref ref-type="bibr" rid="bib21">Hrvatin et al. (2018)</xref> (<xref ref-type="fig" rid="fig2s8">Figure 2—figure supplement 8</xref>). All other parameters were as described above.</p></sec><sec id="s4-2"><title>Data preprocessing</title><p>For each dataset, we removed cells with fewer than 1000 unique molecular identifiers (UMIs) detected. We also filtered out genes that were not detected in at least 1 out of 500 cells. We denote this filtered count matrix as <inline-formula><mml:math id="inf10"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">C</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mi mathvariant="bold-italic">j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> (i=1 … N cells, j=1 … M genes). We denote matrices in bold.</p><p>We then selected the H most over-dispersed genes as determined by the v-score (<xref ref-type="bibr" rid="bib24">Klein et al., 2015</xref>) for input to cNMF. H was set to 2000 for all datasets analyzed in this manuscript. It is essential to select a subset of over-dispersed genes prior to normalization because afterwards, variation in lower-variance genes due to noise will be on the same scale as biologically meaningful variation. 2000 reflects a trade-off between including enough genes to detect subtle biological signals, and speeding up computation by not including too many extraneous genes.</p><p>Each of the H over-dispersed genes was then scaled to unit variance before running cNMF resulting in a normalized matrix:<disp-formula id="equ2"><mml:math id="m2"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mtable columnalign="center center center" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mtext> </mml:mtext></mml:mtd><mml:mtd><mml:mtext> </mml:mtext></mml:mtd><mml:mtd><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:mfrac><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mtext> </mml:mtext></mml:mrow></mml:msub><mml:mrow><mml:mi>σ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mtext> </mml:mtext><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mtext> </mml:mtext></mml:mtd><mml:mtd><mml:mtext> </mml:mtext></mml:mtd><mml:mtd><mml:mtext> </mml:mtext></mml:mtd></mml:mtr></mml:mtable><mml:mo>]</mml:mo></mml:mrow><mml:mtext> </mml:mtext><mml:mi>f</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mtext> </mml:mtext><mml:mi>g</mml:mi><mml:mi>e</mml:mi><mml:mi>n</mml:mi><mml:mi>e</mml:mi><mml:mi>s</mml:mi><mml:mtext> </mml:mtext><mml:mi>j</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mi>H</mml:mi><mml:mtext> </mml:mtext><mml:mi>o</mml:mi><mml:mi>v</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>p</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi><mml:mi>s</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi><mml:mtext> </mml:mtext><mml:mi>g</mml:mi><mml:mi>e</mml:mi><mml:mi>n</mml:mi><mml:mi>e</mml:mi><mml:mi>s</mml:mi></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf11"><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> denotes the jth column of <bold>C</bold>, <inline-formula><mml:math id="inf12"><mml:mi>σ</mml:mi><mml:mo>(</mml:mo><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow> <mml:mi/><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo> <mml:mi/> <mml:mi/></mml:math></inline-formula> denotes the sample standard deviation of <inline-formula><mml:math id="inf13"><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, and <inline-formula><mml:math id="inf14"><mml:mfenced close="}" open="{" separators="|"><mml:mrow><mml:mi>H</mml:mi> <mml:mi/><mml:mi>o</mml:mi><mml:mi>v</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>p</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi><mml:mi>s</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi> <mml:mi/><mml:mi>g</mml:mi><mml:mi>e</mml:mi><mml:mi>n</mml:mi><mml:mi>e</mml:mi><mml:mi>s</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> denotes the previously selected set of over-dispersed genes. This variance-scaling is similar to the log transformation that is commonly applied to scRNA-Seq data in that it ensures genes on different expression scales contribute comparable amounts of information to the GEP inference. However, we prefer variance scaling because log transformation requires addition of an arbitrary pseudo-count which can substantially impact downstream analysis (<xref ref-type="bibr" rid="bib54">William Townes et al., 2019</xref>). In addition log-transformation renders fold-changes of 0.1 to 1, and 100 to 1000 equivalent in absolute terms. This is undesirable given the current resolution of scRNA-Seq data because the former change can frequently be attributable to noise while we have much greater confidence in the biological significance of the latter. Variance scaling the data avoids the need for any modulation to the shape of a gene’s distribution and avoids the need for addition of an arbitrary pseudocount. Finally, addition of components in log expression space corresponds to multiplication in raw expression space. We believe additivity to be a more appropriate model than multiplicativity for most GEPs, and therefore do not log-transform the data prior to running cNMF. We do not mean center the genes so as to preserve the non-negativity of the expression data which is a requirement for NMF.</p><p>Note that we do not perform any cell count normalization (I.e. normalization of the rows of <bold>C</bold> prior to cNMF). This is because cells with more counts can contribute more information to the model. Technical variation in transcript abundances across cells are captured in the usage matrix rather than the component matrix. However, for the <xref ref-type="bibr" rid="bib49">Tasic et al. (2016)</xref> dataset, which is based on full-transcript sequencing rather than digital UMI counting, we variance-normalized high-variance genes from the TPM matrix directly rather than from the raw count matrix as in the other datasets.</p><p>As a final step in cNMF, the consensus programs can be re-fit in physically meaningful (non-normalized) biological units of the user’s choice, such as transcripts per million and including all genes (not just the H over-dispersed ones). See below for details.</p></sec><sec id="s4-3"><title>Consensus non-negative matrix factorization (cNMF)</title><p>We use non-negative matrix factorization implemented in scikit-learn version 20.0 (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/SCR_002577">SCR_002577</ext-link>) with the default parameters except for random initialization, tolerance for the stopping condition of 10<sup>−4</sup>, and a maximum number of iterations of 400.</p><p>R replicates of NMF are run on the same normalized dataset with the same number of components K but with different randomly selected seeds, resulting in R instances of usage matrices <inline-formula><mml:math id="inf15"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">U</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> (N cells x K programs) and program matrices <inline-formula><mml:math id="inf16"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> (K programs x H genes):<disp-formula id="equ3"><mml:math id="m3"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">U</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup><mml:mi>x</mml:mi> <mml:mi/><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">C</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover> <mml:mi/> <mml:mi/> <mml:mi/> <mml:mi/><mml:mi>f</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi> <mml:mi/><mml:mi>r</mml:mi> <mml:mi/><mml:mo>=</mml:mo> <mml:mi/><mml:mn>1</mml:mn> <mml:mi/><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo> <mml:mi/><mml:mi>R</mml:mi></mml:math></disp-formula></p><p>For each replicate r, the rows of <inline-formula><mml:math id="inf17"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">r</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> are normalized to have l2 norm of 1:<disp-formula id="equ4"><mml:math id="m4"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msup><mml:mover><mml:mi mathvariant="bold-italic">G</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mfrac><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mfrac><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mfrac><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mi>K</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mi>K</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mtd></mml:mtr></mml:mtable><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf18"><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:math></inline-formula> is the kth row of the programs matrix for the rth NMF replicate <inline-formula><mml:math id="inf19"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> and <inline-formula><mml:math id="inf20"><mml:msub><mml:mrow><mml:mo>|</mml:mo><mml:mo>|</mml:mo> <mml:mi/><mml:mo>|</mml:mo><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:math></inline-formula> denotes the l2 norm.</p><p>The component matrices from each replicate are then concatenated vertically into a single RK x H dimensional matrix, <bold>G</bold>, where each row is a component from one replicate:<disp-formula id="equ5"><mml:math id="m5"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:msup><mml:mover><mml:mi mathvariant="bold-italic">G</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msup><mml:mover><mml:mi mathvariant="bold-italic">G</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msup><mml:mover><mml:mi mathvariant="bold-italic">G</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">R</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup></mml:mtd></mml:mtr></mml:mtable><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Components with high mean Euclidean distance from their L nearest neighbors are then filtered out as below:<disp-formula id="equ6"><mml:math id="m6"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="normal">L</mml:mi><mml:mo>=</mml:mo><mml:mi>ρ</mml:mi><mml:mi mathvariant="normal">R</mml:mi></mml:mrow></mml:mstyle></mml:math></disp-formula><disp-formula id="equ7"><mml:math id="m7"><mml:mi>D</mml:mi><mml:mo>(</mml:mo><mml:msub><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo> <mml:mi/><mml:mi mathvariant="normal">L</mml:mi><mml:mo>)</mml:mo> <mml:mi/><mml:mo>=</mml:mo> <mml:mi/><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:mfrac><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:msub><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow></mml:munder><mml:mrow><mml:msub><mml:mrow><mml:mo>|</mml:mo><mml:mo>|</mml:mo><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:mo>|</mml:mo><mml:msub><mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></disp-formula><disp-formula id="equ8"><mml:math id="m8"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msup><mml:mi mathvariant="bold-italic">G</mml:mi><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">f</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mtable columnalign="center center center" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mtext> </mml:mtext></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mtext> </mml:mtext></mml:mtd><mml:mtd><mml:msub><mml:mi>G</mml:mi><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mtd><mml:mtd><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mtext> </mml:mtext></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:mtext> </mml:mtext></mml:mtd></mml:mtr></mml:mtable><mml:mo>]</mml:mo></mml:mrow><mml:mtext> </mml:mtext><mml:mi>f</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mtext> </mml:mtext><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mtext> </mml:mtext><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mtext> </mml:mtext><mml:mi>R</mml:mi><mml:mi>k</mml:mi><mml:mtext> </mml:mtext><mml:mi>i</mml:mi><mml:mi>f</mml:mi><mml:mtext> </mml:mtext><mml:mi>D</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>G</mml:mi><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:mrow><mml:mi mathvariant="normal">L</mml:mi></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mtext> </mml:mtext><mml:mo>&lt;</mml:mo><mml:mi>τ</mml:mi></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf21"><mml:msub><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the <italic>lth</italic> row of <bold>G</bold>, <inline-formula><mml:math id="inf22"><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:msub><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:math></inline-formula> is the set of L nearest neighbors of <inline-formula><mml:math id="inf23"><mml:msub><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf24"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">f</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> is the matrix of rows that passed the L nearest neighbors distance threshold filter.</p><p>Two user-specified parameters, ρ and <inline-formula><mml:math id="inf25"><mml:mi>τ</mml:mi></mml:math></inline-formula>, determine which replicate components are filtered out and which are kept. ρ denotes the fraction of NMF replicates to be used as nearest neighbors. Intuitively, ρ can be thought of as the fraction of replicates that must yield a component approximately matching a program in order for that program to be kept by cNMF. <inline-formula><mml:math id="inf26"><mml:mi>τ</mml:mi></mml:math></inline-formula> is a distance threshold that determines how close a component must be to its nearest neighbors in Euclidean space to be considered ‘approximately matching’.</p><p>Our choice of ρ and <inline-formula><mml:math id="inf27"><mml:mi>τ</mml:mi></mml:math></inline-formula> were guided by inspection of the clustergram and histogram output by cNMF with the goal of filtering out outlier components and yielding clean correlation blocks on the clustergrams (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>, <xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1</xref>, <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>). We set ρ=0.3 for all datasets analyzed in this manuscript which reflects a tolerance to identify components that occur approximately in 30% or more replicates. We find this to be an appropriate default setting. We set <inline-formula><mml:math id="inf28"><mml:mi>τ</mml:mi></mml:math></inline-formula> = 0.03, 0.10, 0.08, 0.10, and 0.04 for the simulation, organoid, main visual cortex (<xref ref-type="bibr" rid="bib21">Hrvatin et al., 2018</xref>), secondary visual cortex (<xref ref-type="bibr" rid="bib49">Tasic et al., 2016</xref>), and the Pancreatic islets datasets (discussed in the supplementary note on between-sample variability) based on truncating the long tail of the distance to KNN histogram.</p><p>Next, the rows of <inline-formula><mml:math id="inf29"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">f</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> are clustered using KMeans with the Euclidean distance metric and the same number of clusters (K) as the number of components for the NMF runs. This defines sets <inline-formula><mml:math id="inf30"><mml:msub><mml:mrow><mml:mi>A</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfenced close="}" open="{" separators="|"><mml:mrow><mml:mi>r</mml:mi><mml:mi>o</mml:mi><mml:mi>w</mml:mi><mml:mi>s</mml:mi> <mml:mi/><mml:mi>l</mml:mi> <mml:mi/><mml:mi>a</mml:mi><mml:mi>s</mml:mi><mml:mi>s</mml:mi><mml:mi>i</mml:mi><mml:mi>g</mml:mi><mml:mi>n</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi> <mml:mi/><mml:mi>t</mml:mi><mml:mi>o</mml:mi> <mml:mi/><mml:mi>c</mml:mi><mml:mi>l</mml:mi><mml:mi>u</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi> <mml:mi/><mml:mi>k</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> containing the indices of the rows of <inline-formula><mml:math id="inf31"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">f</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> that are assigned to the kth cluster.</p><p>Each cluster of replicate components is then collapsed down to a single consensus vector by taking the median value for each gene across components in a cluster:<disp-formula id="equ9"><mml:math id="m9"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msup><mml:mrow><mml:msub><mml:mi mathvariant="bold-italic">G</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>c</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mi>m</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi><mml:mi>i</mml:mi><mml:mi>a</mml:mi><mml:mi>n</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mi>l</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>f</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msubsup><mml:mspace width="thinmathspace"/><mml:mi>f</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mspace width="thinmathspace"/><mml:mi>l</mml:mi><mml:mo>∈</mml:mo><mml:mspace width="thinmathspace"/><mml:msub><mml:mi>A</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow><mml:mo>}</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>for <italic>l</italic> indexing over rows of <inline-formula><mml:math id="inf32"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">f</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> and j indexing over columns (genes), and with the median taken separately for each gene j. This defines a KxH consensus programs matrix <inline-formula><mml:math id="inf33"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> where the (c) superscript denotes consensus. The merged GEP components are then l1 normalized:<disp-formula id="equ10"><mml:math id="m10"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msup><mml:mover><mml:mi mathvariant="bold-italic">G</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mfrac><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mo>⋮</mml:mo><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mfrac><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mfrac><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mi>K</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msubsup><mml:mi>G</mml:mi><mml:mrow><mml:mi>K</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mtd></mml:mtr></mml:mtable><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf34"><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:math></inline-formula> is the kth row of <inline-formula><mml:math id="inf35"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> and <inline-formula><mml:math id="inf36"><mml:mo>|</mml:mo><mml:mo>|</mml:mo> <mml:mi/><mml:mo>|</mml:mo><mml:msub><mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:math></inline-formula> denotes the l1 norm. A consensus usage matrix is then fit by running one last iteration of NMF with the component matrix fixed to <inline-formula><mml:math id="inf37"><mml:msup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula>. This amounts to fitting non-negative least squares regressions of each cell’s normalized expression profile <inline-formula><mml:math id="inf38"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> against <inline-formula><mml:math id="inf39"><mml:msup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> by solving the following optimization:<disp-formula id="equ11"><mml:math id="m11"><mml:mrow><mml:mrow><mml:munder><mml:mrow><mml:mi mathvariant="normal">min</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>…</mml:mo><mml:msub><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="italic">iK</mml:mi></mml:mrow></mml:msub><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:munder></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow> <mml:mi/> <mml:mi/><mml:mo>|</mml:mo><mml:mo>|</mml:mo> <mml:mi/><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:mrow><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover><mml:mrow><mml:msub><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub> <mml:mi/><mml:msubsup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:mrow></mml:mrow> <mml:mi/><mml:mo>|</mml:mo><mml:msub><mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf40"><mml:msubsup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:math></inline-formula> is the H-dimensional normalized consensus program vector for the kth GEP, i indexes over cells, and we are maximizing with respect to GEP usage values <inline-formula><mml:math id="inf41"><mml:msub><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>…</mml:mo><mml:msub><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>K</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> which are constrained to be non-negative. We concatenate all these coefficients into a consensus usage matrix <inline-formula><mml:math id="inf42"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">U</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula>:<disp-formula id="equ12"><mml:math id="m12"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">U</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mfenced close="]" open="[" separators="|"><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:msub><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mn>11</mml:mn></mml:mrow></mml:msub></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:msub><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>K</mml:mi></mml:mrow></mml:msub></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd><mml:mtd><mml:mo>⋱</mml:mo></mml:mtd><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msub><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi>N</mml:mi><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:msub><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi>N</mml:mi><mml:mi>K</mml:mi></mml:mrow></mml:msub></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:math></disp-formula>and normalize it so that the usage values for each cell sum to 1:<disp-formula id="equ13"><mml:math id="m13"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msup><mml:mover><mml:mi mathvariant="bold-italic">U</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mfrac><mml:msubsup><mml:mi>U</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msubsup><mml:mi>U</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mo>⋮</mml:mo><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mfrac><mml:msubsup><mml:mi>U</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msubsup><mml:mi>U</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mfrac><mml:msubsup><mml:mi>U</mml:mi><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msubsup><mml:mi>U</mml:mi><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mtd></mml:mtr></mml:mtable><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf43"><mml:msubsup><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:math></inline-formula> is the ith row of the consensus usage matrix. With this normalized, consensus usage matrix fixed, final program estimates can be computed in desired units, and for all genes—including genes that were not initially included among the over-dispersed set. This is done by running a last iteration of NMF with the usage matrix fixed as <inline-formula><mml:math id="inf44"><mml:msup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">U</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:math></inline-formula> and the input data reflecting the desired final units. To convert the estimated programs to TPM units and to obtain program vectors spanning the full set of input genes, we refit against the matrix of TPM values, <bold>T</bold>:<disp-formula id="equ14"><mml:math id="m14"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="bold-italic">T</mml:mi><mml:mo>=</mml:mo><mml:mtext> </mml:mtext><mml:mrow><mml:mo>[</mml:mo><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mfrac><mml:mrow><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mn>6</mml:mn></mml:mrow></mml:msup><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mo>⋮</mml:mo><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:mfrac><mml:mrow><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mn>6</mml:mn></mml:mrow></mml:msup><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mtext> </mml:mtext></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mfrac><mml:mrow><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mn>6</mml:mn></mml:mrow></mml:msup><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mtd></mml:mtr></mml:mtable><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula><disp-formula id="equ15"><mml:math id="m15"><mml:mrow><mml:mrow><mml:munder><mml:mrow><mml:mi mathvariant="normal">min</mml:mi></mml:mrow><mml:mrow><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="italic">TPM</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>…</mml:mo><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="italic">jK</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="italic">TPM</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:munder></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow> <mml:mi/> <mml:mi/><mml:mo>|</mml:mo><mml:mo>|</mml:mo> <mml:mi/><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:mrow><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover><mml:mrow><mml:msubsup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>:</mml:mo><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup> <mml:mi/><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>T</mml:mi><mml:mi>P</mml:mi><mml:mi>M</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:mrow></mml:mrow> <mml:mi/><mml:mo>|</mml:mo><mml:msub><mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf45"><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the N-dimensional TPM profile for the jth gene, <inline-formula><mml:math id="inf46"><mml:msubsup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>:</mml:mo><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:math></inline-formula> is the N-dimensional normalized consensus profile for the kth GEP over all cells, and <inline-formula><mml:math id="inf47"><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>T</mml:mi><mml:mi>P</mml:mi><mml:mi>M</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:math></inline-formula> is an estimated coefficient reflecting how much the TPM of gene j is expected to increase per a unit increase in usage of GEP k, if all other usages were held constant. Note that the TPM matrix <bold>T</bold> is calculated using a raw count matrix <bold>C</bold> that includes all genes, even those that were filtered out for falling below the count threshold. We repeat this for all M genes in the filtered count matrix and combine allthese coefficients into a consensus program matrix:<disp-formula id="equ16"><mml:math id="m16"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">G</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">T</mml:mi><mml:mi mathvariant="bold-italic">P</mml:mi><mml:mi mathvariant="bold-italic">M</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mfenced close="]" open="[" separators="|"><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mn>11</mml:mn></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>T</mml:mi><mml:mi>P</mml:mi><mml:mi>M</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>M</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>T</mml:mi><mml:mi>P</mml:mi><mml:mi>M</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd><mml:mtd><mml:mo>⋱</mml:mo></mml:mtd><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>K</mml:mi><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>T</mml:mi><mml:mi>P</mml:mi><mml:mi>M</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:msubsup><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mrow><mml:mi>K</mml:mi><mml:mi>M</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>T</mml:mi><mml:mi>P</mml:mi><mml:mi>M</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:math></disp-formula></p></sec><sec id="s4-4"><title>Identification of marker genes</title><p>We identify marker genes (genes that are statistically associated with each GEP) using multiple least squares regression of normalized (z-scored) gene expression against the consensus GEP usage matrix. This amounts to finding the genes that have higher than average expression for cells that use a specific GEP. We compute the z-score of the TPM profile like so:<disp-formula id="equ17"><mml:math id="m17"><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub> <mml:mi/><mml:mo>=</mml:mo> <mml:mi/><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:math></disp-formula>where <inline-formula><mml:math id="inf48"><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the TPM profile of the jth gene, <inline-formula><mml:math id="inf49"><mml:msub><mml:mrow><mml:mi>μ</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi> <mml:mi/></mml:mrow></mml:msub></mml:math></inline-formula> is the sample mean, and <inline-formula><mml:math id="inf50"><mml:msub><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the sample standard deviation of <inline-formula><mml:math id="inf51"><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. Then we fit <inline-formula><mml:math id="inf52"><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo> <mml:mi/><mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub> <mml:mi/><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mi>K</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, coefficients reflecting the association between GEP k and gene j using ordinary least squares regression by solving the minimization:<disp-formula id="equ18"><mml:math id="m18"><mml:mrow><mml:mrow><mml:munder><mml:mrow><mml:mi mathvariant="normal">min</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo> <mml:mi/><mml:mo>…</mml:mo><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="italic">Kj</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow> <mml:mi/> <mml:mi/><mml:mo>|</mml:mo><mml:mo>|</mml:mo> <mml:mi/><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:mrow><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover><mml:mrow><mml:msubsup><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup> <mml:mi/><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow> <mml:mi/><mml:mo>|</mml:mo><mml:msup><mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf53"><mml:msubsup><mml:mrow><mml:mi>U</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>c</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:math></inline-formula> is the kth column of the un-normalized consensus usage matrix. The regression coefficients <inline-formula><mml:math id="inf54"><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> can then be interpreted as by how many standard deviations the expression of gene j should increase for an additional count of usage being attributed to GEP k. We regress against z-scored expression values rather than the un-normalized expression values so that the coefficients will be comparable between genes expressed on different scales. For discrete clustering methods, the usage matrix is a binary indicator matrix containing a 1 for the cluster (column) each cell is assigned to, and a 0 for all other columns. In the discrete clustering context, <inline-formula><mml:math id="inf55"><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> can be interpreted as the average expression of gene j in cells assigned to cluster k. Identifying marker genes through multivariate regression in this fashion, rather than through separate tests for each GEP, reduces the risk of confounding that can occur when GEPs tend to be expressed in the same cells. For example, if an activity GEP is predominantly expressed in cells of a specific cell-type, it avoids misattributing activity genes to the identity program of that cell-type and vice versa.</p><p>We note that because gene-expression data is not normally distributed, the residuals of the regression will not be normal, which violates an assumption of OLS regression. However, the coefficient estimates will still be unbiased even if normality is violated. In practice, we do not use the p-values of the regressions at an any point in our analysis as those can be inaccurate due to non-normality. We recommend testing for gene-set enrichment on regression coefficients directly (as we discuss below) rather than setting thresholds on regression P-values.</p></sec><sec id="s4-5"><title>Choosing the number of components</title><p>Determining the number of components (K) to use for cNMF is an important but challenging step without a simple approach that can work for all datasets and applications. We use two diagnostic plots to help guide this decision. The first plot shows the stability of the solution (as captured by the silhouette score) and the Frobenius reconstruction error as a function of K as described previously in <xref ref-type="bibr" rid="bib2">Alexandrov et al. (2013)</xref>. However, unlike in <xref ref-type="bibr" rid="bib2">Alexandrov et al. (2013)</xref>, we run NMF on normalized data matrices rather than count matrices and therefore do not resample counts but simply repeat NMF with different randomly selected seeds. We compute the Frobenius error using the consensus NMF solution but without any outlier filtering. We also use the Euclidean distance on l2 normalized components as the metric for the silhouette score rather than Cosine distance. Silhouette score is calculated using the Scikit-learn version 20.0 silhouette_score function. We parallelized the individual factorization steps over cores on a multi-core virtual machine using GNU Parallel (<xref ref-type="bibr" rid="bib48">Tange, 2011</xref>).</p><p>As another approach to confirm the appropriateness of our choice of K, we use scree plots which depict the proportion of variance explained per principal component (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>, <xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1</xref>, <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>). This is motivated by the fact that choosing the optimal number of principal components and choosing the number of NMF components can both be framed as estimating the rank for a low-dimensional representation of the input data. As a consequence of the Eckart Young Mirsky theorem, PCA necessarily provides the matrix factorization with minimum Frobenius reconstruction error for any choice of K (<xref ref-type="bibr" rid="bib12">Eckart and Young, 1936</xref>) and we also use the Frobenius error in our NMF model. Because principal components are orthogonal to each other, and loadings of NMF components can never be negative, K principal components will always span a larger sub-space than K NMF components. This suggests that the optimal number of NMF components will likely not be smaller than the optimal number of PCs. The scree plot is a commonly used tool to estimate the number of principal components and we use it to help guide the number of NMF components as well.</p><p>We note that these two plots merely provide a general aid for the choice of K and we considered the biological interpretability of factors found from several choices of K before proceeding. We do not recommend necessarily using the maximum stability solution of the error vs. stability plot as this can frequently miss true biological signal and, indeed would have led to the incorrect choice for the simulated data (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>).</p><p>Given the uncertainty of the choice of K, we confirmed that the conclusions of this manuscript are robust to this decision. When we varied K within a range of ±four around the choice used in the manuscript, we found approximately the same core set of GEPs with a single new GEP being discerned with each consecutive step in K. For each step below the selected K, approximately a single GEP was lost, but for choices above the selected K, components approximately matching the original K programs (I.e. with Pearson correlation &gt;0.7) were found (<xref ref-type="fig" rid="fig5">Figure 5</xref>). This suggests that cNMF yields relatively stable solutions for a moderate range of K values.</p></sec><sec id="s4-6"><title>Comparison of cNMF with other methods</title><p>We compared cNMF with consensus and standard versions of LDA and ICA as well as with PCA, Louvain clustering and a hard clustering based on assignment of cells to their ground-truth labels. We used the implementations of LDA, ICA, and PCA in scikit-learn and the implementation of Louvain clustering in scanpy (<xref ref-type="bibr" rid="bib55">Wolf et al., 2018</xref>). For ICA, we used the FastICA implementation with default options for all the parameters. For LDA, we used the batch algorithm and all other parameters as defaults. We defined the consensus estimates across 200 replicates in the same way as for cNMF but with a slight modification for ICA. Because ICA is under-determined with respect to the signs of the solutions, some iterations will yield a given component pointed in one direction while others produce approximately the same component but pointed in the opposite direction (multiplied by −1). Therefore, we aligned the orientation of components from across replicates by identifying any components whose median usage across all cells was positive and scaled those and the corresponding usages by −1.</p><p>For Louvain clustering, we used 14 principal components to compute distances between cells and used 200 nearest neighbors to define the KNN graph. We chose 14 principal components based on the fact that the data was simulated based on a 14-dimensional basis and, therefore, the biological variation in the data can be captured by 14 PCs and subsequent components correspond to noise. This choice is also justified by choosing the elbow on scree plot in <xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>. We used 200 nearest neighbors for the clustering as this is a relatively large number to minimize variance but it is still smaller than the smallest discrete population (0.3*15,000*(1/13)=346 cells from a specific cell-type that expresses the activity program).</p><p>For ground-truth assignment clustering, we assigned each cell to a cluster defined by its true identity program, except for cells which had greater that 40% usage of the activity program, which we assigned to an activity program cluster. Then we determined a GEP corresponding to each cluster as the mean TPM value for each gene over cells in the cluster.</p><p>To evaluate the accuracy of these various methods, we first calculated the z-score coefficient for associating each gene with each program as described above. We then calculated sensitivity and false discovery rate (FDR) for each threshold on those coefficients and plotted those as an ROC-curve, except with FDR on the X-axis instead of false positive rate. For this evaluation, we considered a gene as truly associated with a GEP if it had a ground-truth fold-change of &gt;= 2 and truly unassociated with a GEP if the ground-truth fold-change was 1. Genes with a fold-change between 1 and 2 were ignored for this evaluation.</p></sec><sec id="s4-7"><title>Testing enrichment of genesets in programs</title><p>We used the z-score regression coefficients identified as above as input for a one-sided Mann Whitney U Test (with tie correction) comparing the median of genes in each geneset to those of genes not in the geneset. We first floored all negative coefficients to equal zero prior to the test. Coefficients less than 0 indicate genes that are expressed at higher levels in cells that do not use the GEP (all other things equal) than in cells that do. We floor these values so that variation in genes that are not directly part of a GEP (which can make up the majority of genes) do not substantially impact the Mann-Whitney statistic for that GEP.</p></sec><sec id="s4-8"><title>Data availability</title><p>The organoid data described in the manuscript is accessible at NCBI GEO accession number GSE86153. However, we obtained the clustering and unnormalized data by request from the authors. The visual cortex datasets used for <xref ref-type="fig" rid="fig3">Figure 3</xref> are accessible at NCBI GEO, accession numbers GSE102827 and GSE71585.</p></sec><sec id="s4-9"><title>Code availability</title><p>Code for running cNMF is available on Github <ext-link ext-link-type="uri" xlink:href="https://github.com/dylkot/cNMF">https://github.com/dylkot/cNMF</ext-link>, as is code for simulating data with doublets and activity programs <ext-link ext-link-type="uri" xlink:href="https://github.com/dylkot/scsim">https://github.com/dylkot/scsim</ext-link> (<xref ref-type="bibr" rid="bib26">Kotliar and Eraslan, 2019</xref>; copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/scsim">https://github.com/elifesciences-publications/scsim</ext-link>). </p><p>All datasets and analysis used in this manuscript are available for download, exploration and re-execution on Code Ocean: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.24433/CO.9044782e-cb96-4733-8a4f-bf42c21399e6">https://doi.org/10.24433/CO.9044782e-cb96-4733-8a4f-bf42c21399e6</ext-link>.</p></sec><sec id="s4-10"><title>Supplementary note - Analysis of between-sample variability</title><p>We sought to understand how variability between sample replicates and batches would impact the results of cNMF. We therefore considered how GEP usage varies across replicates in the primary datasets analyzed in this manuscript, as well as in a previously published scRNA-Seq dataset of human pancreatic islets with noted batch-effect (<xref ref-type="bibr" rid="bib5">Baron et al., 2016</xref>).</p><p>First, we analyzed the aggregate GEP usage of cells in organoid replicates in the <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref> data, and mouse replicates in the <xref ref-type="bibr" rid="bib21">Hrvatin et al. (2018)</xref> visual cortex data. For this purpose, we defined the aggregate GEP profile of a replicate as the sum of the GEP usage of all cells derived from that replicate. The visual cortex data showed relative uniformity of GEP usage across mouse replicates, with the only clear pattern being the expected association between depolarization-induced GEPs and mice treated with the stimulus (<xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1a</xref> - left). By contrast, there was significant variability between organoids in the <xref ref-type="bibr" rid="bib36">Quadrato et al. (2017)</xref> data that was primarily associated with the bioreactors in which the organoids were grown (<xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1b</xref> - left). This variability was discussed in the original manuscript and validated using immunohistochemistry, and thus represents true biological signal that we would hope for cNMF to discern.</p><p>We also considered whether any GEPs could be attributed to just one or a small number of replicates which could suggest that they are not reproducible within the experiment. We therefore looked at what percentage of the aggregate usage of a GEP derived from cells in each replicate. We found that each GEP contributed to cells from multiple independent replicates in both datasets (<xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1</xref>, right panels). No GEP derived more than 15% of its usage from a single replicate in the visual cortex data or more than 45% of its usage from a single replicate in the organoid data. Furthermore, each organoid GEP was the maximum contributing GEP for a cell in at least six distinct organoid replicates, and each visual cortex GEP was the maximum contributor for a cell in at least 10 distinct mouse replicates. This supports our conclusion that the inferred GEPs represent reproducible signals within the primary organoid and visual cortex datasets.</p><p>We also analyzed a human pancreatic islet scRNA-Seq dataset where variability between four donors resulted in more substantial batch-effects to see how that would impact the behavior of cNMF (<xref ref-type="bibr" rid="bib5">Baron et al., 2016</xref>). Applied to this dataset of 10,939 cells, cNMF identified 16 GEPs that corresponded well with the cell-type clusters described in the initial publication (<xref ref-type="fig" rid="fig5s2">Figure 5—figure supplement 2</xref>). Our application of cNMF failed to identify GEPs corresponding to a few cell-types described in <xref ref-type="bibr" rid="bib5">Baron et al. (2016)</xref> (e.g. cells distinguished as delta and gamma cell-types were assigned the same GEP). However, many of the cell types that were missed by cNMF were only distinguished through iterative sub-clustering in the initial publication, which we did not attempt.</p><p>Notably, we identified multiple GEPs for many cell-type clusters that corresponded to ‘donor of origin.’ For example, we identified separate GEPs corresponding to acinar cells derived from donors 1 and 3, and acinar cells derived from donors 2 and 4, and similarly for alpha, ductal, and stellate cells. One potential contributor to the batch-effect could be that donors 1 and 3 were male and donors 2 and 4 were female. Consistent with this, we noticed that among the genes that were most differentially expressed between donors 1 and 3 compared to donors 2 and 4 in alpha, beta, and acinar cells were XIST on the X chromosome and RPSY1 on the Y chromosome (linear regression F-test p-values&lt;5×10<sup>−243</sup> for for XIST and p-values&lt;4×10<sup>−145</sup> for RPSY1 for all 3 cell-types tested). But in general, the fact that cNMF is discerning multiple GEPs for the same cell-types suggests that technical sources of variation such as batch-effect can confound the identification of identity and activity GEPs.</p><p>In this instance, cNMF did not learn a single GEP for each donor (I.e. batch) but rather identified multiple hybrid identity-donor GEPs corresponding to individual cell-types derived from distinct sets of donors. This is likely due to the fact that the batch effect modulated the expression of different sets of genes in different cell-types, and therefore, no single shared ‘batch-effect’ GEP could capture the impact on each cell-type. To avoid incorporating variation between batches into the inferred GEPs for datasets containing significant batch-effect, batch-effect correction can be performed prior to running cNMF.</p></sec></sec></body><back><ack id="ack"><title>Acknowledgements</title><p>We thank Allon Klein, Samuel Wolock, Aubrey Faust, Chris Edwards, Stephen Schaffner, Eric Lander, the CGTA discussion group, and members of the Sabeti Laboratory for useful discussions and feedback on the manuscript. We thank the Arlotta, Greenberg, and Zeng laboratories for generating the primary datasets we analyze in this manuscript. The project described was supported by award Number R01AI099210 from the National Institute of Allergy and Infectious Disease, HHSF223201810172C from the U.S. Food and Drug Administration, and T32GM007753 from the National Institute of General Medical Sciences. The content is solely the responsibility of the authors and does not necessarily represent the official views of the National Institute of General Medical Sciences, Food and Drug Administration, or the National Institutes of Health.</p></ack><sec id="s5" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="COI-statement" id="conf1"><p>No competing interests declared</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>Conceptualization, Resources, Data curation, Software, Formal analysis, Investigation, Methodology</p></fn><fn fn-type="con" id="con2"><p>Conceptualization, Software, Formal analysis, Investigation, Methodology</p></fn><fn fn-type="con" id="con3"><p>Resources, Formal analysis</p></fn><fn fn-type="con" id="con4"><p>Investigation, Helped analyze data during an early version of the project that shaped the specifics of the methodology and analysis</p></fn><fn fn-type="con" id="con5"><p>Investigation, Helped analyze data during an early version of the project that shaped the specifics of the methodology and analysis</p></fn><fn fn-type="con" id="con6"><p>Supervision, Funding acquisition, Writing—original draft</p></fn><fn fn-type="con" id="con7"><p>Supervision, Funding acquisition, Writing—original draft</p></fn></fn-group></sec><sec id="s6" sec-type="supplementary-material"><title>Additional files</title><supplementary-material id="supp1"><object-id pub-id-type="doi">10.7554/eLife.43803.028</object-id><label>Supplementary file 1.</label><caption><title>Brain organoid GEP genescores.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43803-supp1-v2.csv"/></supplementary-material><supplementary-material id="supp2"><object-id pub-id-type="doi">10.7554/eLife.43803.029</object-id><label>Supplementary file 2.</label><caption><title>Visual cortex GEP genescores.</title></caption><media mime-subtype="octet-stream" mimetype="application" xlink:href="elife-43803-supp2-v2.csv"/></supplementary-material><supplementary-material id="supp3"><object-id pub-id-type="doi">10.7554/eLife.43803.030</object-id><label>Supplementary file 3.</label><caption><title>Novel activity GEP enrichments.</title></caption><media mime-subtype="xlsx" mimetype="application" xlink:href="elife-43803-supp3-v2.xlsx"/></supplementary-material><supplementary-material id="transrepform"><object-id pub-id-type="doi">10.7554/eLife.43803.031</object-id><label>Transparent reporting form</label><media mime-subtype="docx" mimetype="application" xlink:href="elife-43803-transrepform-v2.docx"/></supplementary-material></sec><sec id="s7" sec-type="data-availability"><title>Data availability</title><p>All of the analyzed real datasets are publicly available and the relevant GEO accession codes are included in the manuscript. All of the simulated and real data can be accessed through Code Ocean at the following URL: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.24433/CO.9044782e-cb96-4733-8a4f-bf42c21399e6">https://doi.org/10.24433/CO.9044782e-cb96-4733-8a4f-bf42c21399e6</ext-link>. cNMF code is available on Github <ext-link ext-link-type="uri" xlink:href="https://github.com/dylkot/cNMF/">https://github.com/dylkot/cNMF/</ext-link> (copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/cNMF">https://github.com/elifesciences-publications/cNMF</ext-link>).</p><p>The following dataset was generated:</p><p><element-citation id="dataset1" publication-type="data" specific-use="isSupplementedBy"><person-group person-group-type="author"><name><surname>Kotliar</surname><given-names>D</given-names></name><name><surname>Veres</surname><given-names>A</given-names></name><name><surname>Nagy</surname><given-names>MA</given-names></name><name><surname>Tabrizi</surname><given-names>S</given-names></name><name><surname>Hodis</surname><given-names>E</given-names></name><name><surname>Melton</surname><given-names>DA</given-names></name><name><surname>Sabeti</surname><given-names>PC</given-names></name></person-group><year iso-8601-date="2019">2019</year><data-title>Identifying Gene Expression Programs of Cell-type Identity and Cellular Activity with Single-Cell RNA-Seq</data-title><source>Code Ocean</source><pub-id assigning-authority="other" pub-id-type="doi">10.24433/CO.9044782e-cb96-4733-8a4f-bf42c21399e6</pub-id></element-citation></p><p>The following previously published datasets were used:</p><p><element-citation id="dataset2" publication-type="data" specific-use="references"><person-group person-group-type="author"><name><surname>Quadrato</surname><given-names>G</given-names></name><name><surname>Nguyen</surname><given-names>T</given-names></name><name><surname>Macosko</surname><given-names>EZ</given-names></name><name><surname>Sherwood</surname><given-names>JL</given-names></name><name><surname>Berger</surname><given-names>D</given-names></name><name><surname>Maria</surname><given-names>N</given-names></name><name><surname>Scholvin</surname><given-names>J</given-names></name><name><surname>Goldman</surname><given-names>M</given-names></name><name><surname>Kinney</surname><given-names>J</given-names></name><name><surname>Boyden</surname><given-names>E</given-names></name><name><surname>Lichtman</surname><given-names>J</given-names></name><name><surname>Williams</surname><given-names>ZM</given-names></name><name><surname>McCarroll</surname><given-names>SA</given-names></name><name><surname>Arlotta</surname><given-names>P</given-names></name></person-group><year iso-8601-date="2017">2017</year><data-title>Cell diversity and network dynamics in photosensitive human brain organoids.</data-title><source>Gene Expression Omnibus</source><pub-id assigning-authority="NCBI" pub-id-type="accession" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE86153">GSE86153</pub-id></element-citation></p><p><element-citation id="dataset3" publication-type="data" specific-use="references"><person-group person-group-type="author"><name><surname>Hrvatin</surname><given-names>S</given-names></name><name><surname>Hochbaum</surname><given-names>DR</given-names></name><name><surname>Nagy</surname><given-names>MA</given-names></name><name><surname>Sabatini</surname><given-names>BL</given-names></name><name><surname>Greenberg</surname><given-names>ME</given-names></name></person-group><year iso-8601-date="2018">2018</year><data-title>Single-cell analysis of experience-dependent transcriptomic states in the mouse visual cortex</data-title><source>Gene Expression Omnibus</source><pub-id assigning-authority="NCBI" pub-id-type="accession" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE102827">GSE102827</pub-id></element-citation></p><p><element-citation id="dataset4" publication-type="data" specific-use="references"><person-group person-group-type="author"><name><surname>Tasic</surname><given-names>B</given-names></name><name><surname>Menon</surname><given-names>V</given-names></name><name><surname>Nguyen</surname><given-names>TN</given-names></name><name><surname>Kim</surname><given-names>TK</given-names></name><name><surname>Yao</surname><given-names>Z</given-names></name><name><surname>Gray</surname><given-names>LT</given-names></name><name><surname>Hawrylycz</surname><given-names>M</given-names></name><name><surname>Koch</surname><given-names>C</given-names></name><name><surname>Zeng</surname><given-names>H</given-names></name></person-group><year iso-8601-date="2016">2016</year><data-title>Adult mouse cortical cell taxonomy by single cell transcriptomics</data-title><source>Gene Expression Omnibus</source><pub-id assigning-authority="NCBI" pub-id-type="accession" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE71585">GSE71585</pub-id></element-citation></p><p><element-citation id="dataset5" publication-type="data" specific-use="references"><person-group person-group-type="author"><name><surname>Baron</surname><given-names>M</given-names></name><name><surname>Veres</surname><given-names>A</given-names></name><name><surname>Wolock</surname><given-names>SL</given-names></name><name><surname>Faust</surname><given-names>AL</given-names></name><name><surname>Gaujoux</surname><given-names>R</given-names></name><name><surname>Vetere</surname><given-names>A</given-names></name><name><surname>Ryu</surname><given-names>JH</given-names></name><name><surname>Wagner</surname><given-names>BK</given-names></name><name><surname>Shen-Orr</surname><given-names>SS</given-names></name><name><surname>Klein</surname><given-names>AM</given-names></name><name><surname>Melton</surname><given-names>DA</given-names></name><name><surname>Yanai</surname><given-names>I</given-names></name></person-group><year iso-8601-date="2016">2016</year><data-title>A Single-Cell Transcriptomic Map of the Human and Mouse Pancreas Reveals Inter- and Intra-cell Population Structure</data-title><source>Gene Expression Omnibus</source><pub-id assigning-authority="NCBI" pub-id-type="accession" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE50244">GSE50244</pub-id></element-citation></p></sec><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Aguirre-Chen</surname> <given-names>C</given-names></name><name><surname>Bülow</surname> <given-names>HE</given-names></name><name><surname>Kaprielian</surname> <given-names>Z</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>C. elegans bicd-1, homolog of the Drosophila dynein accessory factor bicaudal D, regulates the branching of PVD sensory neuron dendrites</article-title><source>Development</source><volume>138</volume><fpage>507</fpage><lpage>518</lpage><pub-id pub-id-type="doi">10.1242/dev.060939</pub-id><pub-id pub-id-type="pmid">21205795</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Alexandrov</surname> <given-names>LB</given-names></name><name><surname>Nik-Zainal</surname> <given-names>S</given-names></name><name><surname>Wedge</surname> <given-names>DC</given-names></name><name><surname>Campbell</surname> <given-names>PJ</given-names></name><name><surname>Stratton</surname> <given-names>MR</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Deciphering signatures of mutational processes operative in human Cancer</article-title><source>Cell Reports</source><volume>3</volume><fpage>246</fpage><lpage>259</lpage><pub-id pub-id-type="doi">10.1016/j.celrep.2012.12.008</pub-id><pub-id pub-id-type="pmid">23318258</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Amir</surname> <given-names>el-AD</given-names></name><name><surname>Davis</surname> <given-names>KL</given-names></name><name><surname>Tadmor</surname> <given-names>MD</given-names></name><name><surname>Simonds</surname> <given-names>EF</given-names></name><name><surname>Levine</surname> <given-names>JH</given-names></name><name><surname>Bendall</surname> <given-names>SC</given-names></name><name><surname>Shenfeld</surname> <given-names>DK</given-names></name><name><surname>Krishnaswamy</surname> <given-names>S</given-names></name><name><surname>Nolan</surname> <given-names>GP</given-names></name><name><surname>Pe'er</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>viSNE enables visualization of high dimensional single-cell data and reveals phenotypic heterogeneity of leukemia</article-title><source>Nature Biotechnology</source><volume>31</volume><fpage>545</fpage><lpage>552</lpage><pub-id pub-id-type="doi">10.1038/nbt.2594</pub-id><pub-id pub-id-type="pmid">23685480</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Barbosa</surname> <given-names>AC</given-names></name><name><surname>Kim</surname> <given-names>MS</given-names></name><name><surname>Ertunc</surname> <given-names>M</given-names></name><name><surname>Adachi</surname> <given-names>M</given-names></name><name><surname>Nelson</surname> <given-names>ED</given-names></name><name><surname>McAnally</surname> <given-names>J</given-names></name><name><surname>Richardson</surname> <given-names>JA</given-names></name><name><surname>Kavalali</surname> <given-names>ET</given-names></name><name><surname>Monteggia</surname> <given-names>LM</given-names></name><name><surname>Bassel-Duby</surname> <given-names>R</given-names></name><name><surname>Olson</surname> <given-names>EN</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>MEF2C, a transcription factor that facilitates learning and memory by negative regulation of synapse numbers and function</article-title><source>PNAS</source><volume>105</volume><fpage>9391</fpage><lpage>9396</lpage><pub-id pub-id-type="doi">10.1073/pnas.0802679105</pub-id><pub-id pub-id-type="pmid">18599438</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Baron</surname> <given-names>M</given-names></name><name><surname>Veres</surname> <given-names>A</given-names></name><name><surname>Wolock</surname> <given-names>SL</given-names></name><name><surname>Faust</surname> <given-names>AL</given-names></name><name><surname>Gaujoux</surname> <given-names>R</given-names></name><name><surname>Vetere</surname> <given-names>A</given-names></name><name><surname>Ryu</surname> <given-names>JH</given-names></name><name><surname>Wagner</surname> <given-names>BK</given-names></name><name><surname>Shen-Orr</surname> <given-names>SS</given-names></name><name><surname>Klein</surname> <given-names>AM</given-names></name><name><surname>Melton</surname> <given-names>DA</given-names></name><name><surname>Yanai</surname> <given-names>I</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>A Single-Cell transcriptomic map of the human and mouse pancreas reveals inter- and Intra-cell population structure</article-title><source>Cell Systems</source><volume>3</volume><fpage>346</fpage><lpage>360</lpage><pub-id pub-id-type="doi">10.1016/j.cels.2016.08.011</pub-id><pub-id pub-id-type="pmid">27667365</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Biederer</surname> <given-names>T</given-names></name><name><surname>Sara</surname> <given-names>Y</given-names></name><name><surname>Mozhayeva</surname> <given-names>M</given-names></name><name><surname>Atasoy</surname> <given-names>D</given-names></name><name><surname>Liu</surname> <given-names>X</given-names></name><name><surname>Kavalali</surname> <given-names>ET</given-names></name><name><surname>Südhof</surname> <given-names>TC</given-names></name></person-group><year iso-8601-date="2002">2002</year><article-title>SynCAM, a synaptic adhesion molecule that drives synapse assembly</article-title><source>Science</source><volume>297</volume><fpage>1525</fpage><lpage>1531</lpage><pub-id pub-id-type="doi">10.1126/science.1072356</pub-id><pub-id pub-id-type="pmid">12202822</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Blei</surname> <given-names>DM</given-names></name><name><surname>Ay</surname> <given-names>N</given-names></name><name><surname>Jordan</surname> <given-names>MI</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Latent Dirichlet Allocation</article-title><source>Journal of Machine Learning Research : JMLR</source><volume>3</volume><fpage>993</fpage><lpage>1022</lpage></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Blondel</surname> <given-names>VD</given-names></name><name><surname>Guillaume</surname> <given-names>J-L</given-names></name><name><surname>Lambiotte</surname> <given-names>R</given-names></name><name><surname>Lefebvre</surname> <given-names>E</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Fast unfolding of communities in large networks</article-title><source>Journal of Statistical Mechanics: Theory and Experiment</source><volume>2008</volume><fpage>P10008</fpage><pub-id pub-id-type="doi">10.1088/1742-5468/2008/10/P10008</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Brunet</surname> <given-names>J-P</given-names></name><name><surname>Tamayo</surname> <given-names>P</given-names></name><name><surname>Golub</surname> <given-names>TR</given-names></name><name><surname>Mesirov</surname> <given-names>JP</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>Metagenes and molecular pattern discovery using matrix factorization</article-title><source>PNAS</source><volume>101</volume><fpage>4164</fpage><lpage>4169</lpage><pub-id pub-id-type="doi">10.1073/pnas.0308531101</pub-id></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname> <given-names>M</given-names></name><name><surname>Zhou</surname> <given-names>X</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Controlling for confounding effects in single cell RNA sequencing studies using both control and target genes</article-title><source>Scientific Reports</source><volume>7</volume><elocation-id>13587</elocation-id><pub-id pub-id-type="doi">10.1038/s41598-017-13665-w</pub-id><pub-id pub-id-type="pmid">29051597</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ding</surname> <given-names>J</given-names></name><name><surname>Condon</surname> <given-names>A</given-names></name><name><surname>Shah</surname> <given-names>SP</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Interpretable dimensionality reduction of single cell transcriptome data with deep generative models</article-title><source>Nature Communications</source><volume>9</volume><elocation-id>2002</elocation-id><pub-id pub-id-type="doi">10.1038/s41467-018-04368-5</pub-id><pub-id pub-id-type="pmid">29784946</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Eckart</surname> <given-names>C</given-names></name><name><surname>Young</surname> <given-names>G</given-names></name></person-group><year iso-8601-date="1936">1936</year><article-title>The approximation of one matrix by another of lower rank</article-title><source>Psychometrika</source><volume>1</volume><fpage>211</fpage><lpage>218</lpage><pub-id pub-id-type="doi">10.1007/BF02288367</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Eisen</surname> <given-names>MB</given-names></name><name><surname>Spellman</surname> <given-names>PT</given-names></name><name><surname>Brown</surname> <given-names>PO</given-names></name><name><surname>Botstein</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="1998">1998</year><article-title>Cluster analysis and display of genome-wide expression patterns</article-title><source>PNAS</source><volume>95</volume><fpage>14863</fpage><lpage>14868</lpage><pub-id pub-id-type="doi">10.1073/pnas.95.25.14863</pub-id><pub-id pub-id-type="pmid">9843981</pub-id></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Flavell</surname> <given-names>SW</given-names></name><name><surname>Kim</surname> <given-names>TK</given-names></name><name><surname>Gray</surname> <given-names>JM</given-names></name><name><surname>Harmin</surname> <given-names>DA</given-names></name><name><surname>Hemberg</surname> <given-names>M</given-names></name><name><surname>Hong</surname> <given-names>EJ</given-names></name><name><surname>Markenscoff-Papadimitriou</surname> <given-names>E</given-names></name><name><surname>Bear</surname> <given-names>DM</given-names></name><name><surname>Greenberg</surname> <given-names>ME</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Genome-wide analysis of MEF2 transcriptional program reveals synaptic target genes and neuronal activity-dependent polyadenylation site selection</article-title><source>Neuron</source><volume>60</volume><fpage>1022</fpage><lpage>1038</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2008.11.029</pub-id><pub-id pub-id-type="pmid">19109909</pub-id></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Foote</surname> <given-names>M</given-names></name><name><surname>Qiao</surname> <given-names>H</given-names></name><name><surname>Graham</surname> <given-names>K</given-names></name><name><surname>Wu</surname> <given-names>Y</given-names></name><name><surname>Zhou</surname> <given-names>Y</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Inhibition of 14-3-3 proteins leads to Schizophrenia-Related behavioral phenotypes and synaptic defects in mice</article-title><source>Biological Psychiatry</source><volume>78</volume><fpage>386</fpage><lpage>395</lpage><pub-id pub-id-type="doi">10.1016/j.biopsych.2015.02.015</pub-id><pub-id pub-id-type="pmid">25863357</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gardner</surname> <given-names>LB</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Hypoxic inhibition of nonsense-mediated RNA decay regulates gene expression and the integrated stress response</article-title><source>Molecular and Cellular Biology</source><volume>28</volume><fpage>3729</fpage><lpage>3741</lpage><pub-id pub-id-type="doi">10.1128/MCB.02284-07</pub-id><pub-id pub-id-type="pmid">18362164</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gong</surname> <given-names>L</given-names></name><name><surname>Tang</surname> <given-names>Y</given-names></name><name><surname>An</surname> <given-names>R</given-names></name><name><surname>Lin</surname> <given-names>M</given-names></name><name><surname>Chen</surname> <given-names>L</given-names></name><name><surname>Du</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>RTN1-C mediates cerebral ischemia/reperfusion injury via ER stress and mitochondria-associated apoptosis pathways</article-title><source>Cell Death &amp; Disease</source><volume>8</volume><elocation-id>e3080</elocation-id><pub-id pub-id-type="doi">10.1038/cddis.2017.465</pub-id><pub-id pub-id-type="pmid">28981095</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="preprint"><person-group person-group-type="author"><name><surname>Grønbech</surname> <given-names>CH</given-names></name><name><surname>Vording</surname> <given-names>MF</given-names></name><name><surname>Timshel</surname> <given-names>PN</given-names></name><name><surname>Sønderby</surname> <given-names>CK</given-names></name><name><surname>Pers</surname> <given-names>TH</given-names></name><name><surname>Winther</surname> <given-names>O</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>scVAE: variational auto-encoders for single-cell gene expression data</article-title><source>bioRxiv</source><pub-id pub-id-type="doi">10.1101/318295</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Harrington</surname> <given-names>AJ</given-names></name><name><surname>Raissi</surname> <given-names>A</given-names></name><name><surname>Rajkovich</surname> <given-names>K</given-names></name><name><surname>Berto</surname> <given-names>S</given-names></name><name><surname>Kumar</surname> <given-names>J</given-names></name><name><surname>Molinaro</surname> <given-names>G</given-names></name><name><surname>Raduazzo</surname> <given-names>J</given-names></name><name><surname>Guo</surname> <given-names>Y</given-names></name><name><surname>Loerwald</surname> <given-names>K</given-names></name><name><surname>Konopka</surname> <given-names>G</given-names></name><name><surname>Huber</surname> <given-names>KM</given-names></name><name><surname>Cowan</surname> <given-names>CW</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>MEF2C regulates cortical inhibitory and excitatory synapses and behaviors relevant to neurodevelopmental disorders</article-title><source>eLife</source><volume>5</volume><elocation-id>e20059</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.20059</pub-id><pub-id pub-id-type="pmid">27779093</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hata</surname> <given-names>K</given-names></name><name><surname>Maeno-Hikichi</surname> <given-names>Y</given-names></name><name><surname>Yumoto</surname> <given-names>N</given-names></name><name><surname>Burden</surname> <given-names>SJ</given-names></name><name><surname>Landmesser</surname> <given-names>LT</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Distinct roles of different presynaptic and postsynaptic NCAM isoforms in early Motoneuron-Myotube interactions required for functional synapse formation</article-title><source>The Journal of Neuroscience</source><volume>38</volume><fpage>498</fpage><lpage>510</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.1014-17.2017</pub-id><pub-id pub-id-type="pmid">29175953</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hrvatin</surname> <given-names>S</given-names></name><name><surname>Hochbaum</surname> <given-names>DR</given-names></name><name><surname>Nagy</surname> <given-names>MA</given-names></name><name><surname>Cicconet</surname> <given-names>M</given-names></name><name><surname>Robertson</surname> <given-names>K</given-names></name><name><surname>Cheadle</surname> <given-names>L</given-names></name><name><surname>Zilionis</surname> <given-names>R</given-names></name><name><surname>Ratner</surname> <given-names>A</given-names></name><name><surname>Borges-Monroy</surname> <given-names>R</given-names></name><name><surname>Klein</surname> <given-names>AM</given-names></name><name><surname>Sabatini</surname> <given-names>BL</given-names></name><name><surname>Greenberg</surname> <given-names>ME</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Single-cell analysis of experience-dependent transcriptomic states in the mouse visual cortex</article-title><source>Nature Neuroscience</source><volume>21</volume><fpage>120</fpage><lpage>129</lpage><pub-id pub-id-type="doi">10.1038/s41593-017-0029-5</pub-id><pub-id pub-id-type="pmid">29230054</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kelava</surname> <given-names>I</given-names></name><name><surname>Lancaster</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Dishing out mini-brains: current progress and future prospects in brain organoid research</article-title><source>Developmental Biology</source><volume>420</volume><fpage>199</fpage><lpage>209</lpage><pub-id pub-id-type="doi">10.1016/j.ydbio.2016.06.037</pub-id><pub-id pub-id-type="pmid">27402594</pub-id></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kharchenko</surname> <given-names>PV</given-names></name><name><surname>Silberstein</surname> <given-names>L</given-names></name><name><surname>Scadden</surname> <given-names>DT</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Bayesian approach to single-cell differential expression analysis</article-title><source>Nature Methods</source><volume>11</volume><fpage>740</fpage><lpage>742</lpage><pub-id pub-id-type="doi">10.1038/nmeth.2967</pub-id><pub-id pub-id-type="pmid">24836921</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Klein</surname> <given-names>AM</given-names></name><name><surname>Mazutis</surname> <given-names>L</given-names></name><name><surname>Akartuna</surname> <given-names>I</given-names></name><name><surname>Tallapragada</surname> <given-names>N</given-names></name><name><surname>Veres</surname> <given-names>A</given-names></name><name><surname>Li</surname> <given-names>V</given-names></name><name><surname>Peshkin</surname> <given-names>L</given-names></name><name><surname>Weitz</surname> <given-names>DA</given-names></name><name><surname>Kirschner</surname> <given-names>MW</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Droplet barcoding for single-cell transcriptomics applied to embryonic stem cells</article-title><source>Cell</source><volume>161</volume><fpage>1187</fpage><lpage>1201</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2015.04.044</pub-id><pub-id pub-id-type="pmid">26000487</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Kotliar</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2019">2019</year><data-title>Code and example data for running Consensus Non-negative Matrix Factorization on single-cell RNA-Seq data</data-title><source>GitHub</source><version designator="4888104">4888104</version><ext-link ext-link-type="uri" xlink:href="https://github.com/dylkot/cNMF/">https://github.com/dylkot/cNMF/</ext-link></element-citation></ref><ref id="bib26"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Kotliar</surname> <given-names>D</given-names></name><name><surname>Eraslan</surname> <given-names>G</given-names></name></person-group><year iso-8601-date="2019">2019</year><data-title>scsim</data-title><version designator="4b460e5">4b460e5</version><publisher-name>Github</publisher-name><ext-link ext-link-type="uri" xlink:href="https://github.com/dylkot/scsim">https://github.com/dylkot/scsim</ext-link></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lee</surname> <given-names>DD</given-names></name><name><surname>Seung</surname> <given-names>HS</given-names></name></person-group><year iso-8601-date="1999">1999</year><article-title>Learning the parts of objects by non-negative matrix factorization</article-title><source>Nature</source><volume>401</volume><fpage>788</fpage><lpage>791</lpage><pub-id pub-id-type="doi">10.1038/44565</pub-id><pub-id pub-id-type="pmid">10548103</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Levine</surname> <given-names>JH</given-names></name><name><surname>Simonds</surname> <given-names>EF</given-names></name><name><surname>Bendall</surname> <given-names>SC</given-names></name><name><surname>Davis</surname> <given-names>KL</given-names></name><name><surname>Amir</surname> <given-names>el-AD</given-names></name><name><surname>Tadmor</surname> <given-names>MD</given-names></name><name><surname>Litvin</surname> <given-names>O</given-names></name><name><surname>Fienberg</surname> <given-names>HG</given-names></name><name><surname>Jager</surname> <given-names>A</given-names></name><name><surname>Zunder</surname> <given-names>ER</given-names></name><name><surname>Finck</surname> <given-names>R</given-names></name><name><surname>Gedman</surname> <given-names>AL</given-names></name><name><surname>Radtke</surname> <given-names>I</given-names></name><name><surname>Downing</surname> <given-names>JR</given-names></name><name><surname>Pe'er</surname> <given-names>D</given-names></name><name><surname>Nolan</surname> <given-names>GP</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Data-Driven phenotypic dissection of AML reveals Progenitor-like cells that correlate with prognosis</article-title><source>Cell</source><volume>162</volume><fpage>184</fpage><lpage>197</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2015.05.047</pub-id><pub-id pub-id-type="pmid">26095251</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="preprint"><person-group person-group-type="author"><name><surname>Levitin</surname> <given-names>HM</given-names></name><name><surname>Yuan</surname> <given-names>J</given-names></name><name><surname>Cheng</surname> <given-names>YL</given-names></name><name><surname>Ruiz</surname> <given-names>FJR</given-names></name><name><surname>Bush</surname> <given-names>EC</given-names></name><name><surname>Bruce</surname> <given-names>JN</given-names></name><name><surname>Canoll</surname> <given-names>P</given-names></name><name><surname>Iavarone</surname> <given-names>A</given-names></name><name><surname>Lasorella</surname> <given-names>A</given-names></name><name><surname>Blei</surname> <given-names>DM</given-names></name><name><surname>Sims</surname> <given-names>PA</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>De novo gene signature identification from Single-Cell RNA-Seq with hierarchical poisson factorization</article-title><source>bioRxiv</source><pub-id pub-id-type="doi">10.1101/367003</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname> <given-names>X</given-names></name><name><surname>Kuromi</surname> <given-names>H</given-names></name><name><surname>Briggs</surname> <given-names>L</given-names></name><name><surname>Green</surname> <given-names>DB</given-names></name><name><surname>Rocha</surname> <given-names>JJ</given-names></name><name><surname>Sweeney</surname> <given-names>ST</given-names></name><name><surname>Bullock</surname> <given-names>SL</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Bicaudal-D binds clathrin heavy chain to promote its transport and augments synaptic vesicle recycling</article-title><source>The EMBO Journal</source><volume>29</volume><fpage>992</fpage><lpage>1006</lpage><pub-id pub-id-type="doi">10.1038/emboj.2009.410</pub-id><pub-id pub-id-type="pmid">20111007</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Liberzon</surname> <given-names>A</given-names></name><name><surname>Birger</surname> <given-names>C</given-names></name><name><surname>Thorvaldsdóttir</surname> <given-names>H</given-names></name><name><surname>Ghandi</surname> <given-names>M</given-names></name><name><surname>Mesirov</surname> <given-names>JP</given-names></name><name><surname>Tamayo</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>The molecular signatures database (MSigDB) hallmark gene set collection</article-title><source>Cell Systems</source><volume>1</volume><fpage>417</fpage><lpage>425</lpage><pub-id pub-id-type="doi">10.1016/j.cels.2015.12.004</pub-id><pub-id pub-id-type="pmid">26771021</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="preprint"><person-group person-group-type="author"><name><surname>McGinnis</surname> <given-names>CS</given-names></name><name><surname>Murrow</surname> <given-names>LM</given-names></name><name><surname>Gartner</surname> <given-names>ZJ</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>DoubletFinder: doublet detection in single-cell RNA sequencing data using artificial nearest neighbors</article-title><source>bioRxiv</source><pub-id pub-id-type="doi">10.1101/352484</pub-id></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Monti</surname> <given-names>S</given-names></name><name><surname>Tamayo</surname> <given-names>P</given-names></name><name><surname>Mesirov</surname> <given-names>J</given-names></name><name><surname>Golub</surname> <given-names>T</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Consensus clustering: a Resampling-Based method for class discovery and visualization of gene expression microarray data</article-title><source>Machine Learning</source><volume>52</volume><fpage>91</fpage><lpage>118</lpage></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pawlikowski</surname> <given-names>B</given-names></name><name><surname>Lee</surname> <given-names>L</given-names></name><name><surname>Zuo</surname> <given-names>J</given-names></name><name><surname>Kramer</surname> <given-names>RH</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Analysis of human muscle stem cells reveals a differentiation-resistant progenitor cell population expressing Pax7 capable of self-renewal</article-title><source>Developmental Dynamics</source><volume>238</volume><fpage>138</fpage><lpage>149</lpage><pub-id pub-id-type="doi">10.1002/dvdy.21833</pub-id><pub-id pub-id-type="pmid">19097049</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Puram</surname> <given-names>SV</given-names></name><name><surname>Tirosh</surname> <given-names>I</given-names></name><name><surname>Parikh</surname> <given-names>AS</given-names></name><name><surname>Patel</surname> <given-names>AP</given-names></name><name><surname>Yizhak</surname> <given-names>K</given-names></name><name><surname>Gillespie</surname> <given-names>S</given-names></name><name><surname>Rodman</surname> <given-names>C</given-names></name><name><surname>Luo</surname> <given-names>CL</given-names></name><name><surname>Mroz</surname> <given-names>EA</given-names></name><name><surname>Emerick</surname> <given-names>KS</given-names></name><name><surname>Deschler</surname> <given-names>DG</given-names></name><name><surname>Varvares</surname> <given-names>MA</given-names></name><name><surname>Mylvaganam</surname> <given-names>R</given-names></name><name><surname>Rozenblatt-Rosen</surname> <given-names>O</given-names></name><name><surname>Rocco</surname> <given-names>JW</given-names></name><name><surname>Faquin</surname> <given-names>WC</given-names></name><name><surname>Lin</surname> <given-names>DT</given-names></name><name><surname>Regev</surname> <given-names>A</given-names></name><name><surname>Bernstein</surname> <given-names>BE</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Single-Cell transcriptomic analysis of primary and metastatic tumor ecosystems in head and neck Cancer</article-title><source>Cell</source><volume>171</volume><fpage>1611</fpage><lpage>1624</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2017.10.044</pub-id><pub-id pub-id-type="pmid">29198524</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Quadrato</surname> <given-names>G</given-names></name><name><surname>Nguyen</surname> <given-names>T</given-names></name><name><surname>Macosko</surname> <given-names>EZ</given-names></name><name><surname>Sherwood</surname> <given-names>JL</given-names></name><name><surname>Min Yang</surname> <given-names>S</given-names></name><name><surname>Berger</surname> <given-names>DR</given-names></name><name><surname>Maria</surname> <given-names>N</given-names></name><name><surname>Scholvin</surname> <given-names>J</given-names></name><name><surname>Goldman</surname> <given-names>M</given-names></name><name><surname>Kinney</surname> <given-names>JP</given-names></name><name><surname>Boyden</surname> <given-names>ES</given-names></name><name><surname>Lichtman</surname> <given-names>JW</given-names></name><name><surname>Williams</surname> <given-names>ZM</given-names></name><name><surname>McCarroll</surname> <given-names>SA</given-names></name><name><surname>Arlotta</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Cell diversity and network dynamics in photosensitive human brain organoids</article-title><source>Nature</source><volume>545</volume><fpage>48</fpage><lpage>53</lpage><pub-id pub-id-type="doi">10.1038/nature22047</pub-id><pub-id pub-id-type="pmid">28445462</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ramser</surname> <given-names>EM</given-names></name><name><surname>Wolters</surname> <given-names>G</given-names></name><name><surname>Dityateva</surname> <given-names>G</given-names></name><name><surname>Dityatev</surname> <given-names>A</given-names></name><name><surname>Schachner</surname> <given-names>M</given-names></name><name><surname>Tilling</surname> <given-names>T</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>The 14-3-3ζ protein binds to the cell adhesion molecule L1, promotes L1 phosphorylation by CKII and influences L1-dependent neurite outgrowth</article-title><source>PLOS ONE</source><volume>5</volume><elocation-id>e13462</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0013462</pub-id><pub-id pub-id-type="pmid">20976158</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Robbins</surname> <given-names>EM</given-names></name><name><surname>Krupp</surname> <given-names>AJ</given-names></name><name><surname>Perez de Arce</surname> <given-names>K</given-names></name><name><surname>Ghosh</surname> <given-names>AK</given-names></name><name><surname>Fogel</surname> <given-names>AI</given-names></name><name><surname>Boucard</surname> <given-names>A</given-names></name><name><surname>Südhof</surname> <given-names>TC</given-names></name><name><surname>Stein</surname> <given-names>V</given-names></name><name><surname>Biederer</surname> <given-names>T</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>SynCAM 1 adhesion dynamically regulates synapse number and impacts plasticity and learning</article-title><source>Neuron</source><volume>68</volume><fpage>894</fpage><lpage>906</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2010.11.003</pub-id><pub-id pub-id-type="pmid">21145003</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Salton</surname> <given-names>SR</given-names></name><name><surname>Fischberg</surname> <given-names>DJ</given-names></name><name><surname>Dong</surname> <given-names>KW</given-names></name></person-group><year iso-8601-date="1991">1991</year><article-title>Structure of the gene encoding VGF, a nervous system-specific mRNA that is rapidly and selectively induced by nerve growth factor in PC12 cells</article-title><source>Molecular and Cellular Biology</source><volume>11</volume><fpage>2335</fpage><lpage>2349</lpage><pub-id pub-id-type="doi">10.1128/MCB.11.5.2335</pub-id><pub-id pub-id-type="pmid">2017159</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Satija</surname> <given-names>R</given-names></name><name><surname>Farrell</surname> <given-names>JA</given-names></name><name><surname>Gennert</surname> <given-names>D</given-names></name><name><surname>Schier</surname> <given-names>AF</given-names></name><name><surname>Regev</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Spatial reconstruction of single-cell gene expression data</article-title><source>Nature Biotechnology</source><volume>33</volume><fpage>495</fpage><lpage>502</lpage><pub-id pub-id-type="doi">10.1038/nbt.3192</pub-id><pub-id pub-id-type="pmid">25867923</pub-id></element-citation></ref><ref id="bib41"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Saunders</surname> <given-names>A</given-names></name><name><surname>Macosko</surname> <given-names>EZ</given-names></name><name><surname>Wysoker</surname> <given-names>A</given-names></name><name><surname>Goldman</surname> <given-names>M</given-names></name><name><surname>Krienen</surname> <given-names>FM</given-names></name><name><surname>de Rivera</surname> <given-names>H</given-names></name><name><surname>Bien</surname> <given-names>E</given-names></name><name><surname>Baum</surname> <given-names>M</given-names></name><name><surname>Bortolin</surname> <given-names>L</given-names></name><name><surname>Wang</surname> <given-names>S</given-names></name><name><surname>Goeva</surname> <given-names>A</given-names></name><name><surname>Nemesh</surname> <given-names>J</given-names></name><name><surname>Kamitaki</surname> <given-names>N</given-names></name><name><surname>Brumbaugh</surname> <given-names>S</given-names></name><name><surname>Kulp</surname> <given-names>D</given-names></name><name><surname>McCarroll</surname> <given-names>SA</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Molecular diversity and specializations among the cells of the adult mouse brain</article-title><source>Cell</source><volume>174</volume><fpage>1015</fpage><lpage>1030</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2018.07.028</pub-id><pub-id pub-id-type="pmid">30096299</pub-id></element-citation></ref><ref id="bib42"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Scialdone</surname> <given-names>A</given-names></name><name><surname>Natarajan</surname> <given-names>KN</given-names></name><name><surname>Saraiva</surname> <given-names>LR</given-names></name><name><surname>Proserpio</surname> <given-names>V</given-names></name><name><surname>Teichmann</surname> <given-names>SA</given-names></name><name><surname>Stegle</surname> <given-names>O</given-names></name><name><surname>Marioni</surname> <given-names>JC</given-names></name><name><surname>Buettner</surname> <given-names>F</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Computational assignment of cell-cycle stage from single-cell transcriptome data</article-title><source>Methods</source><volume>85</volume><fpage>54</fpage><lpage>61</lpage><pub-id pub-id-type="doi">10.1016/j.ymeth.2015.06.021</pub-id><pub-id pub-id-type="pmid">26142758</pub-id></element-citation></ref><ref id="bib43"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Segal</surname> <given-names>E</given-names></name><name><surname>Shapira</surname> <given-names>M</given-names></name><name><surname>Regev</surname> <given-names>A</given-names></name><name><surname>Pe'er</surname> <given-names>D</given-names></name><name><surname>Botstein</surname> <given-names>D</given-names></name><name><surname>Koller</surname> <given-names>D</given-names></name><name><surname>Friedman</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Module networks: identifying regulatory modules and their condition-specific regulators from gene expression data</article-title><source>Nature Genetics</source><volume>34</volume><fpage>166</fpage><lpage>176</lpage><pub-id pub-id-type="doi">10.1038/ng1165</pub-id><pub-id pub-id-type="pmid">12740579</pub-id></element-citation></ref><ref id="bib44"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shalek</surname> <given-names>AK</given-names></name><name><surname>Satija</surname> <given-names>R</given-names></name><name><surname>Shuga</surname> <given-names>J</given-names></name><name><surname>Trombetta</surname> <given-names>JJ</given-names></name><name><surname>Gennert</surname> <given-names>D</given-names></name><name><surname>Lu</surname> <given-names>D</given-names></name><name><surname>Chen</surname> <given-names>P</given-names></name><name><surname>Gertner</surname> <given-names>RS</given-names></name><name><surname>Gaublomme</surname> <given-names>JT</given-names></name><name><surname>Yosef</surname> <given-names>N</given-names></name><name><surname>Schwartz</surname> <given-names>S</given-names></name><name><surname>Fowler</surname> <given-names>B</given-names></name><name><surname>Weaver</surname> <given-names>S</given-names></name><name><surname>Wang</surname> <given-names>J</given-names></name><name><surname>Wang</surname> <given-names>X</given-names></name><name><surname>Ding</surname> <given-names>R</given-names></name><name><surname>Raychowdhury</surname> <given-names>R</given-names></name><name><surname>Friedman</surname> <given-names>N</given-names></name><name><surname>Hacohen</surname> <given-names>N</given-names></name><name><surname>Park</surname> <given-names>H</given-names></name><name><surname>May</surname> <given-names>AP</given-names></name><name><surname>Regev</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Single-cell RNA-seq reveals dynamic paracrine control of cellular variation</article-title><source>Nature</source><volume>510</volume><fpage>363</fpage><lpage>369</lpage><pub-id pub-id-type="doi">10.1038/nature13437</pub-id><pub-id pub-id-type="pmid">24919153</pub-id></element-citation></ref><ref id="bib45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Staudacher</surname> <given-names>JJ</given-names></name><name><surname>Naarmann-de Vries</surname> <given-names>IS</given-names></name><name><surname>Ujvari</surname> <given-names>SJ</given-names></name><name><surname>Klinger</surname> <given-names>B</given-names></name><name><surname>Kasim</surname> <given-names>M</given-names></name><name><surname>Benko</surname> <given-names>E</given-names></name><name><surname>Ostareck-Lederer</surname> <given-names>A</given-names></name><name><surname>Ostareck</surname> <given-names>DH</given-names></name><name><surname>Bondke Persson</surname> <given-names>A</given-names></name><name><surname>Lorenzen</surname> <given-names>S</given-names></name><name><surname>Meier</surname> <given-names>JC</given-names></name><name><surname>Blüthgen</surname> <given-names>N</given-names></name><name><surname>Persson</surname> <given-names>PB</given-names></name><name><surname>Henrion-Caude</surname> <given-names>A</given-names></name><name><surname>Mrowka</surname> <given-names>R</given-names></name><name><surname>Fähling</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Hypoxia-induced gene expression results from selective mRNA partitioning to the endoplasmic reticulum</article-title><source>Nucleic Acids Research</source><volume>43</volume><fpage>3219</fpage><lpage>3236</lpage><pub-id pub-id-type="doi">10.1093/nar/gkv167</pub-id><pub-id pub-id-type="pmid">25753659</pub-id></element-citation></ref><ref id="bib46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stein-O'Brien</surname> <given-names>GL</given-names></name><name><surname>Arora</surname> <given-names>R</given-names></name><name><surname>Culhane</surname> <given-names>AC</given-names></name><name><surname>Favorov</surname> <given-names>AV</given-names></name><name><surname>Garmire</surname> <given-names>LX</given-names></name><name><surname>Greene</surname> <given-names>CS</given-names></name><name><surname>Goff</surname> <given-names>LA</given-names></name><name><surname>Li</surname> <given-names>Y</given-names></name><name><surname>Ngom</surname> <given-names>A</given-names></name><name><surname>Ochs</surname> <given-names>MF</given-names></name><name><surname>Xu</surname> <given-names>Y</given-names></name><name><surname>Fertig</surname> <given-names>EJ</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Enter the matrix: factorization uncovers knowledge from omics</article-title><source>Trends in Genetics</source><volume>34</volume><fpage>790</fpage><lpage>805</lpage><pub-id pub-id-type="doi">10.1016/j.tig.2018.07.003</pub-id><pub-id pub-id-type="pmid">30143323</pub-id></element-citation></ref><ref id="bib47"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Steuerman</surname> <given-names>Y</given-names></name><name><surname>Cohen</surname> <given-names>M</given-names></name><name><surname>Peshes-Yaloz</surname> <given-names>N</given-names></name><name><surname>Valadarsky</surname> <given-names>L</given-names></name><name><surname>Cohn</surname> <given-names>O</given-names></name><name><surname>David</surname> <given-names>E</given-names></name><name><surname>Frishberg</surname> <given-names>A</given-names></name><name><surname>Mayo</surname> <given-names>L</given-names></name><name><surname>Bacharach</surname> <given-names>E</given-names></name><name><surname>Amit</surname> <given-names>I</given-names></name><name><surname>Gat-Viks</surname> <given-names>I</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Dissection of influenza infection in Vivo by Single-Cell RNA Sequencing</article-title><source>Cell Systems</source><volume>6</volume><fpage>679</fpage><lpage>691</lpage><pub-id pub-id-type="doi">10.1016/j.cels.2018.05.008</pub-id><pub-id pub-id-type="pmid">29886109</pub-id></element-citation></ref><ref id="bib48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tange</surname> <given-names>O</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Gnu parallel-the command-line power tool</article-title><source>The USENIX Magazine</source><volume>36</volume><fpage>42</fpage><lpage>47</lpage></element-citation></ref><ref id="bib49"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tasic</surname> <given-names>B</given-names></name><name><surname>Menon</surname> <given-names>V</given-names></name><name><surname>Nguyen</surname> <given-names>TN</given-names></name><name><surname>Kim</surname> <given-names>TK</given-names></name><name><surname>Jarsky</surname> <given-names>T</given-names></name><name><surname>Yao</surname> <given-names>Z</given-names></name><name><surname>Levi</surname> <given-names>B</given-names></name><name><surname>Gray</surname> <given-names>LT</given-names></name><name><surname>Sorensen</surname> <given-names>SA</given-names></name><name><surname>Dolbeare</surname> <given-names>T</given-names></name><name><surname>Bertagnolli</surname> <given-names>D</given-names></name><name><surname>Goldy</surname> <given-names>J</given-names></name><name><surname>Shapovalova</surname> <given-names>N</given-names></name><name><surname>Parry</surname> <given-names>S</given-names></name><name><surname>Lee</surname> <given-names>C</given-names></name><name><surname>Smith</surname> <given-names>K</given-names></name><name><surname>Bernard</surname> <given-names>A</given-names></name><name><surname>Madisen</surname> <given-names>L</given-names></name><name><surname>Sunkin</surname> <given-names>SM</given-names></name><name><surname>Hawrylycz</surname> <given-names>M</given-names></name><name><surname>Koch</surname> <given-names>C</given-names></name><name><surname>Zeng</surname> <given-names>H</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Adult mouse cortical cell taxonomy revealed by single cell transcriptomics</article-title><source>Nature Neuroscience</source><volume>19</volume><fpage>335</fpage><lpage>346</lpage><pub-id pub-id-type="doi">10.1038/nn.4216</pub-id><pub-id pub-id-type="pmid">26727548</pub-id></element-citation></ref><ref id="bib50"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Taslaman</surname> <given-names>L</given-names></name><name><surname>Nilsson</surname> <given-names>B</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>A framework for regularized non-negative matrix factorization, with application to the analysis of gene expression data</article-title><source>PLOS ONE</source><volume>7</volume><elocation-id>e46331</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0046331</pub-id><pub-id pub-id-type="pmid">23133590</pub-id></element-citation></ref><ref id="bib51"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Thattai</surname> <given-names>M</given-names></name><name><surname>van Oudenaarden</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2001">2001</year><article-title>Intrinsic noise in gene regulatory networks</article-title><source>PNAS</source><volume>98</volume><fpage>8614</fpage><lpage>8619</lpage><pub-id pub-id-type="doi">10.1073/pnas.151588598</pub-id><pub-id pub-id-type="pmid">11438714</pub-id></element-citation></ref><ref id="bib52"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Trapnell</surname> <given-names>C</given-names></name><name><surname>Cacchiarelli</surname> <given-names>D</given-names></name><name><surname>Grimsby</surname> <given-names>J</given-names></name><name><surname>Pokharel</surname> <given-names>P</given-names></name><name><surname>Li</surname> <given-names>S</given-names></name><name><surname>Morse</surname> <given-names>M</given-names></name><name><surname>Lennon</surname> <given-names>NJ</given-names></name><name><surname>Livak</surname> <given-names>KJ</given-names></name><name><surname>Mikkelsen</surname> <given-names>TS</given-names></name><name><surname>Rinn</surname> <given-names>JL</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>The dynamics and regulators of cell fate decisions are revealed by pseudotemporal ordering of single cells</article-title><source>Nature Biotechnology</source><volume>32</volume><fpage>381</fpage><lpage>386</lpage><pub-id pub-id-type="doi">10.1038/nbt.2859</pub-id><pub-id pub-id-type="pmid">24658644</pub-id></element-citation></ref><ref id="bib53"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wagner</surname> <given-names>A</given-names></name><name><surname>Regev</surname> <given-names>A</given-names></name><name><surname>Yosef</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Revealing the vectors of cellular identity with single-cell genomics</article-title><source>Nature Biotechnology</source><volume>34</volume><fpage>1145</fpage><lpage>1160</lpage><pub-id pub-id-type="doi">10.1038/nbt.3711</pub-id><pub-id pub-id-type="pmid">27824854</pub-id></element-citation></ref><ref id="bib54"><element-citation publication-type="preprint"><person-group person-group-type="author"><name><surname>William Townes</surname> <given-names>F</given-names></name><name><surname>Hicks</surname> <given-names>SC</given-names></name><name><surname>Aryee</surname> <given-names>MJ</given-names></name><name><surname>Irizarry</surname> <given-names>RA</given-names></name></person-group><year iso-8601-date="2019">2019</year><article-title>Feature selection and dimension reduction for single cell RNA-Seq based on a multinomial model</article-title><source>bioRxiv</source><pub-id pub-id-type="doi">10.1101/574574</pub-id></element-citation></ref><ref id="bib55"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wolf</surname> <given-names>FA</given-names></name><name><surname>Angerer</surname> <given-names>P</given-names></name><name><surname>Theis</surname> <given-names>FJ</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title><source>Genome Biology</source><volume>19</volume><elocation-id>15</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id><pub-id pub-id-type="pmid">29409532</pub-id></element-citation></ref><ref id="bib56"><element-citation publication-type="preprint"><person-group person-group-type="author"><name><surname>Wolock</surname> <given-names>SL</given-names></name><name><surname>Lopez</surname> <given-names>R</given-names></name><name><surname>Klein</surname> <given-names>AM</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Scrublet: computational identification of cell doublets in single-cell transcriptomic data</article-title><source>bioRxiv</source><pub-id pub-id-type="doi">10.1101/357368</pub-id></element-citation></ref><ref id="bib57"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Xu</surname> <given-names>X</given-names></name><name><surname>Jaehne</surname> <given-names>EJ</given-names></name><name><surname>Greenberg</surname> <given-names>Z</given-names></name><name><surname>McCarthy</surname> <given-names>P</given-names></name><name><surname>Saleh</surname> <given-names>E</given-names></name><name><surname>Parish</surname> <given-names>CL</given-names></name><name><surname>Camera</surname> <given-names>D</given-names></name><name><surname>Heng</surname> <given-names>J</given-names></name><name><surname>Haas</surname> <given-names>M</given-names></name><name><surname>Baune</surname> <given-names>BT</given-names></name><name><surname>Ratnayake</surname> <given-names>U</given-names></name><name><surname>van den Buuse</surname> <given-names>M</given-names></name><name><surname>Lopez</surname> <given-names>AF</given-names></name><name><surname>Ramshaw</surname> <given-names>HS</given-names></name><name><surname>Schwarz</surname> <given-names>Q</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>14-3-3ζ deficient mice in the BALB/c background display behavioural and anatomical defects associated with neurodevelopmental disorders</article-title><source>Scientific Reports</source><volume>5</volume><elocation-id>12434</elocation-id><pub-id pub-id-type="doi">10.1038/srep12434</pub-id><pub-id pub-id-type="pmid">26207352</pub-id></element-citation></ref><ref id="bib58"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yan</surname> <given-names>H</given-names></name><name><surname>Yuan</surname> <given-names>J</given-names></name><name><surname>Gao</surname> <given-names>L</given-names></name><name><surname>Rao</surname> <given-names>J</given-names></name><name><surname>Hu</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Long noncoding RNA MEG3 activation of p53 mediates ischemic neuronal death in stroke</article-title><source>Neuroscience</source><volume>337</volume><fpage>191</fpage><lpage>199</lpage><pub-id pub-id-type="doi">10.1016/j.neuroscience.2016.09.017</pub-id><pub-id pub-id-type="pmid">27651151</pub-id></element-citation></ref><ref id="bib59"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zappia</surname> <given-names>L</given-names></name><name><surname>Phipson</surname> <given-names>B</given-names></name><name><surname>Oshlack</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Splatter: simulation of single-cell RNA sequencing data</article-title><source>Genome Biology</source><volume>18</volume><elocation-id>174</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-017-1305-0</pub-id><pub-id pub-id-type="pmid">28899397</pub-id></element-citation></ref><ref id="bib60"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname> <given-names>RL</given-names></name><name><surname>Chopp</surname> <given-names>M</given-names></name><name><surname>Zhang</surname> <given-names>ZG</given-names></name><name><surname>Phillips</surname> <given-names>ML</given-names></name><name><surname>Rosenbloom</surname> <given-names>CL</given-names></name><name><surname>Cruz</surname> <given-names>R</given-names></name><name><surname>Manning</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="1996">1996</year><article-title>E-selectin in focal cerebral ischemia and reperfusion in the rat</article-title><source>Journal of Cerebral Blood Flow &amp; Metabolism</source><volume>16</volume><fpage>1126</fpage><lpage>1136</lpage><pub-id pub-id-type="doi">10.1097/00004647-199611000-00006</pub-id><pub-id pub-id-type="pmid">8898684</pub-id></element-citation></ref></ref-list></back><sub-article article-type="decision-letter" id="SA1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.43803.043</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group><contrib contrib-type="editor"><name><surname>Valencia</surname><given-names>Alfonso</given-names></name><role>Reviewing Editor</role><aff><institution>Barcelona Supercomputing Center - BSC</institution><country>Spain</country></aff></contrib><contrib contrib-type="reviewer"><name><surname>Mereu</surname><given-names>Elisabetta</given-names> </name><role>Reviewer</role><aff><institution>CRG</institution><country>Spain</country></aff></contrib><contrib contrib-type="reviewer"><name><surname>Göttgens</surname><given-names>Berthold</given-names> </name><role>Reviewer</role><aff><institution>University of Cambridge</institution><country>United Kingdom</country></aff></contrib></contrib-group></front-stub><body><boxed-text><p>In the interests of transparency, eLife includes the editorial decision letter and accompanying author responses. A lightly edited version of the letter sent to the authors after peer review is shown, indicating the most substantive concerns; minor comments are not usually included.</p></boxed-text><p>Thank you for submitting your article &quot;Identifying Gene Expression Programs of Cell-type Identity and Cellular Activity with Single-Cell RNA-Seq&quot; for consideration by <italic>eLife</italic>. Your article has been reviewed by three peer reviewers, and the evaluation has been overseen by a Reviewing Editor and Naama Barkai as the Senior Editor. The following individuals involved in review of your submission have agreed to reveal their identity: Elisabetta Mereu (Reviewer #1); Berthold Göttgens (Reviewer #3).</p><p>The reviewers have discussed the reviews with one another and the Reviewing Editor has drafted this decision to help you prepare a revised submission.</p><p>Summary:</p><p>The non-negative matrix factorization method for the analysis of RNA-seq data presented in this paper, consensus-NMF (cNMF), addresses the identification cell types in the context of other non-cell type specific activities. and gene expression activity. A strength of the study is that results are not only compared with other methods, but also applied to both synthetic and real datasets.</p><p>Essential revisions:</p><p>A number of key elements of the algorithm are not described in sufficient detail to make it clear and reproducible, namely:</p><p>1) Clarify the comparison with alternative clustering approaches applied to the same problem, including the analysis of how it differs of other methods in the identification of genes that are part of cell activity programs, given the definition of cluster-specific marker is often done by a differentially expression analysis.</p><p>2) Provide an accurate description of the math of the method. Add equations to explain how to achieve the results and explain how parameters were selected.</p><p>2a) There is a large number of parameters used in simulation, data processing, running the method and methods comparison, many of which are not adequately explained or sufficiently justified (including but not limited to: uniform proportions of cell types in simulation, scaling non-log-transformed expression value in pre-processing, the choice of the number nearest neighbour for filtering outlier components, using 14 PCs for calculating cell distance for louvain clustering).</p><p>2b) The selection parameter K is non-trivial. It is a balance between stability and error. Currently, the choice of the number of factors, K, when applying the method to the simulated and the real datasets were not convincing. For example, k=13 seems more appropriate than k=14 for the simulated data judging from Figure 2—figure supplement 2A It's not clear which k should be chosen from Figure 3—figure supplement 1A. Showing how derived GEPs look under different choices of K would be essential. In addition, it is also unfair to compare with other unsupervised methods (such as PCA) if the K cannot be automatically selected. The authors can suggest an automatic solution to the K.</p><p>3) Pay more attention to performance according to the balance between cell types and samples.</p><p>3a) Because batch effects strongly affect RNAseq analysis, it is crucial the identification of a good set of highly variable genes before clustering for example or the application of a batch correction. How authors can be sure that one or more GEPs that come out from cNMF are not reflecting batch effects? How the method controls batch effects?</p><p>3b) There is not guarantee that one can find factors correlating with cell identity and activity in every dataset. It would be highly desirable to test the method in datasets with moderate batch effects and also in other tissues as currently tested real datasets are all in brain/neuronal tissues. It would be informative to show the variance explained by the overall model and each factor in both simulated and other real datasets preferably with a larger K to put the activity GEPs into perspective.</p></body></sub-article><sub-article article-type="reply" id="SA2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.43803.044</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><disp-quote content-type="editor-comment"><p>Essential revisions:</p><p>A number of key elements of the algorithm are not described in sufficient detail to make it clear and reproducible, namely:</p><p>1) Clarify the comparison with alternative clustering approaches applied to the same problem, including the analysis of how it differs of other methods in the identification of genes that are part of cell activity programs, given the definition of cluster-specific marker is often done by a differentially expression analysis.</p></disp-quote><p>We have significantly expanded our discussion of how cNMF allows marker gene identification and how this compares to differential expression approaches that follow hard-clustering. We describe this in a new section in our revised “Materials and methods” titled “Identification of marker genes”, and further explain our reasoning below.</p><p>State-of-the-art software packages for single-cell RNA seq analysis such as SEURAT (Butler et al., 2018) and Scanpy (Wolf, Angerer, and Theis, 2018) compare gene expression of cells in a cluster to the expression of all other cells not in the cluster (or to cells in another cluster) using group-comparison hypothesis tests such as unpaired T-test and Wilcoxon Ranksum test. Given that cNMF does not assign cells to discrete groups, we cannot use a standard differential expression approach for identifying marker genes, and therefore adapted a solution to our setting.</p><p>We identify marker genes by fitting multivariate linear regression models of (z-scored) gene expression profiles against GEP usage. This approach generalizes the commonly-used T-test to settings where cells have continuous weights for each GEP, rather than binary assignments. This is now described in explicit mathematical notation as per essential revision #2 below.</p><p>Our decision to identify marker genes with multivariate linear regression as specified above is motivated by several key considerations:</p><p>1) This framework allows us to compare hard and soft-clustering approaches within the same testing framework, e.g., in Figure 2E.</p><p>2) Regressing z-score normalized expression profiles rather than raw expression values makes the coefficients comparable across all genes, even between genes that are expressed at very different magnitudes. The coefficients all represent changes relative to the average expression across all cells.</p><p>3) While in principle we could detect marker genes with separate tests for each GEP (e.g. by identifying genes with high Pearson correlation between the GEP usage and gene expression), this could suffer from confounding if GEPs are not independent. For example, if a gene is a marker of a cell-type that frequently expresses an activity program, there could be positive correlation between the activity usage and the gene’s expression, even if the gene isn’t directly associated with the activity. Including both the identity and activity GEP as covariates avoids this confounding and strengthens our testing approach.</p><p>4) The regression coefficients are unbiased estimators of the association between GEP usage and gene expression, even though gene expression data is not normally distributed. We do not use the P-values of the regressions at any point in our analysis as those can be inaccurate due to non-normality.</p><disp-quote content-type="editor-comment"><p>2) Provide an accurate description of the math of the method. Add equations to explain how to achieve the results and explain how parameters were selected.</p></disp-quote><p>In the revised manuscript, we have formalized the presentation of the method using detailed mathematical notation intertwined with the text description of the method. We agree that this will increase the precision of the method description and will provide a clearer description for mathematically inclined readers. In our response to 2a, we describe the changes we made to clarify our parameter selection approach and, where applicable, we have added corresponding equations in the “Materials and methods”.</p><disp-quote content-type="editor-comment"><p>2a) There is a large number of parameters used in simulation, data processing, running the method and methods comparison, many of which are not adequately explained or sufficiently justified (including but not limited to: uniform proportions of cell types in simulation, scaling non-log-transformed expression value in pre-processing, the choice of the number nearest neighbour for filtering outlier components, using 14 PCs for calculating cell distance for louvain clustering).</p></disp-quote><p>We have added clarifying text, primarily in the relevant sections of the “Materials and methods”, explaining the motivation and procedures behind non-trivial technical decisions and parameter choices, including all those raised by the reviewer and others. In the sections below, we expand on these additions and describe where they can be found in the main text.</p><p>Uniform proportions of cell-types in simulations:</p><p>We acknowledge that our simulation of cell-types at uniform proportions is a simplification of the biological reality, where cell-type frequencies can vary over multiple orders of magnitude. We did so to simplify our benchmarking analysis, as it allows us to treat all identity programs as replicates of each other for evaluating inference accuracy. If we had alternatively simulated cell-types with variable proportions, this simplification would not have been possible because GEPs of rare cell-types would (everything else equal) be harder to infer than those of common cell-types.</p><p>It is important to ensure that the simplification of simulating cell-types at uniform proportions does not change our overall conclusions about the applicability or comparative performance of the methods. Therefore, in the revised text, we describe additional simulations where cell-type proportions matched those of a representative real biological dataset (the Hrvatin et al. visual cortex data), where cell-type proportions ranged from 0.6% to 21.5% with four cell-types below 1%. This analysis is described in the last paragraph of the simulation section of the Results (Figure 2—figure supplement 8). We found that cNMF, cICA, and Louvain clustering all failed to identify two or more rare cell types when the effect-size parameters (which control how distinct the GEPs are from each other) were kept the same as in the primary simulation. However, both cNMF and cICA identified all of the GEPs when the effect-size was increased from 1.0 to 2.0 for differential expression mean. We did not test cLDA because it is prohibitively slow to run.</p><p>Our findings are consistent with an intuitive explanation: rarer cell types will be harder to identify unless their identity GEPs are more distinct from those of other cell types in the data. cNMF performed at least as well (or better) relative to the other methods in these simulations, compared to the simulations where cell type proportions were uniform. It identified 13/15 identity GEPs in the small effect-size simulation, compared to 12/15 for cICA and Louvain clustering, and better deconvoluted the activity GEP than the other methods in the large effect-size simulation. Thus, we conclude that the simplification of using uniform cell-type proportions does not change the conclusions of our analysis.</p><p>Scaling non log-transformed expression values in pre-processing</p><p>We have added additional text in the preprocessing section of the “Materials and methods” and a citation for a recent preprint by Townes et al., 20 to justify our decision to variance-normalize non log-transformed expression data. We briefly expand on this decision below.</p><p>It is helpful to transform gene expression data to move genes on different expression magnitudes to the same scale so that a few very highly expressed genes do not dominate the signal. This is typically accomplished by log-transforming the data, but the same function can be accomplished by normalizing the data so that all genes have a variance of 1.</p><p>Log-transforming gene-expression data is commonly used, but has several drawbacks. First, it requires the addition of a pseudocount to the data, the precise value of which is arbitrary but yet can have a large impact on the clustering. Second, for genes whose expression varies over multiple orders of magnitude, log-transformation makes a fold-change of 10 to 100 and 0.1 to 1 equivalent in absolute terms. Given the resolution of current single-cell data, we feel that this is undesirable because the change from 0.1 to 1 can easily be due to noise while we would have much higher confidence in the 10 to 100 fold change.</p><p>By variance normalizing non log-transformed data, we still ensure that genes on different expression-level scales contribute equivalent variance to the cNMF model. However, this approach does not require the addition of an arbitrary pseudo-count nor any transformation of the shape of the distribution of gene expression.</p><p>To further justify this decision, we now cite a recent preprint by Townes et al. that empirically demonstrates the downsides of log transforming scRNA-Seq data. It also describes an alternative pre-processing approach, termed multinomial deviance residuals, which is the equivalent of Z-scoring normally-distributed data under a multinomial probabilistic model. They demonstrate that their preprocessing performs better than log-transforming data for an unsupervised clustering task (Townes et al., 2019). Variance normalization serves an analogous function to Z-scoring gene expression prior to PCA, but omits the mean-centering step (which would make the data negative and thus incompatible with NMF). This preprint supports our premise that variance normalization preprocessing approaches can outperform log-transformation for unsupervised analysis of scRNA-Seq data.</p><p>Using 14 PCs for calculating cell distances for Louvain clustering</p><p>We have clarified this logic in the “Comparison of cNMF with other methods” part of the “Materials and methods” section and further elaborate below.</p><p>Typically, scRNA-Seq data undergoes linear dimensionality reduction (Principal Component Analysis, PCA) and only a subset of the PCs are used for cell clustering. This speeds up computations by decreasing the dimensionality of the data, and also denoises the data, as PCs beyond a certain number are assumed to correspond to noise rather than true biological signal. In this case, because we have simulated the data based on a true latent dimensionality of 14, we can be confident that all PCs beyond 14 correspond to noise and that the optimal number of PCs for this task is not greater than 14. In real biological cases without ground truth, the number of PCs is often selected by choosing an elbow in the ‘Scree plot’ (or related methods) which shows the variance explained per PC (see e.g. Consortium et al., 2018; Ordovas-Montanes et al., 2018). We confirmed that the choice of 14 is supported by the elbow in the Scree plot, which we have added to Figure 2—figure supplement 3.</p><p>Using 200 nearest neighbors for Louvain clustering</p><p>In the first draft of the manuscript we used 15 nearest neighbors (the Scanpy default in the version we were using at the time) for Louvain clustering. In the revised manuscript, we have increased this number, in keeping with the idea that the number should be as large as possible (in order to minimize variance), but only up to the minimum number of cells you expect to belong to the smallest distinct population in the data. If the number of neighbors exceeds the size of the smallest population, the clustering will obscure that population by smoothing over cells of other populations as well. For the simulations, the smallest population in the data would be the 30% of cells of a distinct cell-type that express the activity program. This should be approximately 0.3*15000*(1/13)=346. In reality, one does not know the true sizes of the populations in the data and would instead choose a number corresponding to the a priori belief of what this smallest distinct population in the data might be. 200 is a reasonable choice for such analyses and performs well in practice on the simulated datasets to which we applied it. This logic is described in the “Comparison of cNMF with other methods” section of the “Materials and methods”.</p><p>Use of 2000 overdispersed genes for cNMF on all datasets</p><p>We added the following text to the relevant part of the ‘Materials and methods’ section to clarify the decision to use 2000 over-dispersed genes:</p><p>“We then selected the H most over-dispersed genes as determined by the v-score for input to cNMF. […] 2000 reflects a trade-off between including enough genes to detect subtle biological signals, and speeding up computation by not including too many extraneous genes.”</p><p>We further note that 2000 is a commonly used choice (e.g. Lake et al., 2018; Rodda et al., 2018; Knier et al., 2018) and is the default for the SEURAT version 3 FindVariableFeatures as of April 03, 2019).</p><p>Number of nearest neighbors for outlier filtering</p><p>We have clarified this point in the “Consensus Non-negative Matrix Factorization” section of the “Materials and methods” and summarize the discussion below.</p><p>We frame the decision of choosing the number of nearest neighbors for outlier filtering as one of choosing a fraction of simulation replicates (ρ) that must yield a component approximately matching a GEP in order for that GEP to be retained by cNMF. The K nearest neighbor distance threshold (τ) determines what constitutes how similar the components must be to constitute approximately matching.</p><p>While we originally set ρ=0.3 for all analyses of real data in this manuscript and ρ=0.35 for all simulations, for consistency, we went back and re-ran all simulation analyses with ρ=0.3. This did not change the results so now we use ρ=0.3 for all analyses.</p><p>A choice of ρ=0.3 implies that we would consider components that arise approximately in 30% of simulation replicates to constitute consensus GEPs. The fact that we can use the same parameter for 4 very different real datasets from 3 sequencing technologies and several distinct simulations demonstrates that this is an appropriate default setting for the method. In general, we recommend consulting the consensus clustergram for the data (shown in Figure 2—figure supplement 3, Figure 3—figure supplement 1, and Figure 4—figure supplement 1) to determine which correlation blocks seem robust, and selecting the number of nearest neighbors to be bigger than the largest correlation block that should be filtered out (e.g. because it appears as a small sub-block of a larger correlation block). However, we believe that, in practice, ρ=0.3 is an appropriate default choice for most applications.</p><disp-quote content-type="editor-comment"><p>2b) The selection parameter K is non-trivial. It is a balance between stability and error. Currently, the choice of the number of factors, K, when applying the method to the simulated and the real datasets were not convincing. For example, k=13 seems more appropriate than k=14 for the simulated data judging from Figure 2—figure supplement 2A. It's not clear which k should be chosen from Figure 3—figure supplement 1A. Showing how derived GEPs look under different choices of K would be essential. In addition, it is also unfair to compare with other unsupervised methods (such as PCA) if the K cannot be automatically selected. The authors can suggest an automatic solution to the K.</p></disp-quote><p>Thank you for this comment which led us to make the following key additions to the revised manuscript:</p><p>1) Expanding the discussion of the considerations for choosing K in the “Choosing the number of components” section of the “Materials and methods”;</p><p>2) Adding a robustness analysis demonstrating that our findings are consistent across multiple choices of K (Figure 5);</p><p>3) Using scree plots as an additional graphical aid in the selection of K (Figure 2—figure supplement 3, Figure 3—figure supplement 1, and Figure 4—figure supplement 1).</p><p>We discuss each of these additions below. However, first we must respectfully disagree with the reviewer’s claim that it is unfair to compare with other unsupervised methods such as PCA if the K cannot be automatically selected. Even for PCA, K selection remains a decision that must be weighed carefully, and although tools such as scree plots can guide its selection, no general approach can be trusted to be applied blindly. The challenge of selecting the number of PCs for scRNA-Seq analysis is well described in the SEURAT guided clustering tutorial (https://satijalab.org/seurat/pbmc3k_tutorial.html, Compiled: April 5, 2019) which provides 3 different approaches to this task:</p><p>“Identifying the true dimensionality of a dataset – can be challenging/uncertain for the user. […] We advise users to err on the higher side when choosing this parameter. For example, performing downstream analyses with only 5 PCs does significantly and adversely affect results.”</p><p>All 3 discussed approaches, in this tutorial for a widely used scRNA-Seq analysis package, require an element of human input in the decision.</p><p>We further believe that finding an optimal K may be a biologically ill-defined problem. The intrinsic dimensionality of gene expression is potentially very high, with a long tail of dimensions that explain an increasingly small, but non-negligible, amount of the data. The optimal choice of K may reflect a trade-off between sensitivity to detect true dimensions, and tolerance for identification of spurious dimensions, which should be specified by the user based on the downstream application. Furthermore, biological systems frequently have a hierarchical organization – e.g. in immunology, there are high-level myeloid and lymphoid lineages, which encompass specific cell-types (e.g. T-cells) which in turn encompass sub-cell-types (e.g. helper T-cells) and sub-sub-cell-types (e.g. Th1 or Th17 cells), etc. While there may eventually be a bottom of this hierarchy, in practice, our datasets are too small and lack sufficient resolution to discern all of it. In the meantime, there are potentially multiple appropriate choices of K depending on the level in the hierarchy at which you stop. In this context, the most resolved choice of K should depend on what can be robustly inferred from the data before too much noise begins to contaminate the results. Ultimately, this decision requires human input and reasoning.</p><p>The above thought process as well as the previously published procedure in the context of identifying mutational signatures(Alexandrov et al., 2013), motivated the graphical aid we described in the manuscript. However, based on this helpful reviewer comment, it is now clear that we omitted a key aspect of the overall decision process which we have tried to clarify in the “Choosing the number of components K” section of the revised “Materials and methods”. The stability vs. error plots shown in figure supplements are just a starting point and a guide in the K selection process, and it is not the case that one should necessarily choose the maximum stability solution. In analyzing the data, we considered multiple Ks in the vicinity of the maximum stability solution, and chose a solution based on the biological interpretability of the factors we found. To our knowledge, this is advisable for the choice of PCs (as is stated in the paragraph from the SEURAT tutorial quoted above) as well as for the resolution parameter in Louvain community detection (which determines the number of clusters).</p><p>Given this ambiguity in the choice of K, we agree with the reviewer that it is very important to show that varying the choice of K will not significantly change our conclusions. Therefore, we have added robustness analyses of the primary datasets analyzed in the manuscript, comparing what we find when a range of K values are chosen to the results presented in the manuscript. We have added Figure 5 which shows that, empirically, the same core set of GEPs are found for a range of K values with essentially a single new GEP being discerned with each step in K. For each step below the selected K, approximately a single GEP is lost, but for choices above the selected K, components approximately matching the original K programs (I.e. with Pearson correlation &gt;.7) are typically found.</p><p>To further address the reviewer’s concern about the utility of the stability-vs.-error plots, we now include Scree plots as figure supplements to aid in the selection of K. The idea is that choosing the number of principal components and choosing the number of NMF components are very related problems, as they can both be framed as estimating the rank for a low-dimensional representation of the data. The Eckart Young Mirsky theorem implies that PCA will provide the matrix factorization with minimum Frobenius reconstruction error for any choice of K (Eckart and Young, 1936), and we also use the Frobenius error in our NMF model. Because principal components are orthogonal to each other while NMF components in general are not, and NMF usages can never be negative, K principal components will always span a larger sub-space than K NMF components. This suggests that the optimal number of NMF components will likely not be smaller than the optimal number of PCs. We now include scree plots in the main figure supplements showing the proportion of variance explained per principal component and indicating where the choice of K used in the analysis falls. In each case, it appears at a reasonable “elbow” on the plot. Although this still isn’t an automatic choice of K, we believe that it is the current standard in the field.</p><disp-quote content-type="editor-comment"><p>3) Pay more attention to performance according to the balance between cell types and samples.</p></disp-quote><p>To address this reviewer comment and the sub-comments 3a and 3, we have added a supplementary note titled “Analysis of between-sample variability<bold>”</bold> to the revised manuscript. In this note, we discuss the impact of variability between samples within the results presented in the main text and describe the analysis of a new dataset we analyzed where batch effect was a significant concern (described further in the response to essential revision 3b). This note clarifies how cNMF functions in the context of variation between samples and provides reassurance that GEPs discussed in the manuscript reflect real biological signal and are not technical artifacts due to batch-effect. See 3a and 3b below for a discussion of the new analysis that has been added to the supplemental note.</p><disp-quote content-type="editor-comment"><p>3a) Becaue batch effects strongly affect RNAseq analysis, it is crucial the identification of a good set of highly variable genes before clustering for example or the application of a batch correction. How authors can be sure that one or more GEPs that come out from cNMF are not reflecting batch effects? How the method controls batch effects?</p></disp-quote><p>cNMF does not directly control for batch effects. If there is signal reflecting batch-to-batch variation in the data, cNMF will incorporate that signal into one of more of the inferred GEPs. If batch-effect is a significant artifact of the data, we recommend applying one of the recently published batch-effect correction approaches (Haghverdi et al., 2018; Butler et al., 2018; Johnson, Li, and Rabinovic, 2007) prior to running cNMF. However, we note that batch effect correction risks removing real signal from the data and thus should be used with caution.</p><p>In this manuscript, we focused on 2 real datasets that each contained data aggregated from dozens of biological replicates. We don’t necessarily expect the relative compositions of GEPs to be identical across replicates. Quadrato et al., 2017 described significant variability between organoid replicates that were primarily attributable to organoids grown in some bioreactors being more differentiated than those grown in others. In their manuscript, they performed immunohistochemistry validation experiments to confirm that this reflected true biological differences between samples. The fact that we identify more differentiated cell-types in organoids from those bioreactors represents a batch-effect but also represents true biological signal that we would hope for cNMF to discover.</p><p>To explore between-sample variability, we have added a new supplementary figure to the revision that compares the GEP profile of each replicate (left panels of Figure 5—figure supplement 1), and the proportion of signal derived per replicate for each GEP (right panels) for the visual cortex and organoid datasets. The first approach lets us identify between-sample variation in the data, which could either be technical or biological in nature. The second approach allows us to identify GEPs that occur predominantly in one or two replicates and thus may not be reproducible within the experiment.</p><p>In the Hrvatin et al. data, the GEP patterns of the different mouse replicates were very homogeneous, except for the expected pattern that the depolarization-induced GEPs (ERP, LRP-S, and LRP-D) primarily occur in mice treated with the 1h and 4h stimuli respectively. Every GEP arose in multiple mouse replicates suggesting that they are reproducible.</p><p>By contrast, in the organoid data, there were several clusters of organoids that had distinct GEP profiles. The predominant pattern matched what was described in the Quadrato et al., 2017 manuscript where forebrain GEPs were predominantly represented in organoids from bioreactor 3, and organoids in bioreactor 4 had a greater representation of undifferentiated precursors (e.g. proliferative precursors and neuroepithelial cells). These differences between bioreactors and organoids represent validated biological differences and are unlikely to reflect technical artifacts. Again, every GEP arose in multiple organoid replicates with none deriving more than 45% of their total usage from a single replicate. Each GEP was the maximum contributor for ≥1 cell in at least 6 distinct organoid replicates. This provides support that the inferred GEPs represent reproducible biologically meaningful signals within the dataset.</p><disp-quote content-type="editor-comment"><p>3b) There is not guarantee that one can find factors correlating with cell identity and activity in every dataset. It would be highly desirable to test the method in datasets with moderate batch effects and also in other tissues as currently tested real datasets are all in brain/neuronal tissues. It would be informative to show the variance explained by the overall model and each factor in both simulated and other real datasets preferably with a larger K to put the activity GEPs into perspective.</p></disp-quote><p>To simultaneously address the suggestions to analyze both non-neuronal tissue and data containing moderate batch effects, we re-analyzed a published dataset of human pancreatic islets with noted variability between the four donor-derived samples that constituted the data (Baron et al., 2016).</p><p>This data does not have a larger K than the organoid dataset we analyzed previously (which had K=31). However, we do not recommend using cNMF for datasets with K larger than that. For data containing many divergent cell-types, there is less resolution to pick up more subtle differences within cell-types in the data. For example, in our analysis of the Hrvatin et al. visual cortex data, we ran cNMF only on the neuronal cells which were defined based on the published clustering of the data. We excluded the many non-neuronal cells that made up a significant portion of the Discussion in the original publication. This is because our goal was to identify activity programs, which can be relatively more subtle than cell-type programs. The activity programs would have been swamped out by the much greater variation that exists between a neuron and glia, or a neuron and an endothelial cell, had we kept glia and endothelial cells in the data.</p><p>For datasets containing many highly divergent cell-types, it can be beneficial to cluster the data first and run cNMF separately on the distinct clusters. This is analogous to the 2-stage clustering performed in the Hrvatin et al. publication where they first clustered to identify broad cell-lineages like neuronal and glial, then sub-clustered those clusters to identify specific cell-types within those lineages. We have now highlighted the benefit of analyzing clusters of related cell populations in the revised manuscript where we introduce the visual cortex dataset.</p><p>In our analysis of the pancreatic islet data, we found multiple identity programs for many cell-type clusters that corresponded to “donor of origin” (Figure 5—figure supplement 2). Importantly, in this analysis, cNMF did not learn a single GEP for each donor but rather identified multiple hybrid identity-donor GEPs corresponding to individual cell-types derived from distinct sets of donors. This is likely due to the fact that the batch effect had different impacts on gene expression in different cell-types. Therefore, no single shared “batch-effect” GEP could capture the impact of batch on each cell-type. This is illustrated in “<xref ref-type="fig" rid="respfig1">Author response image 1</xref>” which shows a heatmap of average expression levels of many genes that were differentially expressed across donors in at least one of 3 cell-type clusters.</p><fig id="respfig1"><label>Author response image 1.</label><caption><title>Genes that are differentially expressed between donors in Baron et al., 2016.</title><p>We performed differential expression analysis comparing gene expression between cells derived from each donor using ordinary least squares regression of donor dummy variables on log10 TPM expression values. We did this separately for cells assigned to the acinar, α, and β cells clusters from Baron et al., 2016. Shown above are the regression coefficients for the 20 genes with the most significant batch-effect for each cell-type, as ranked by the F-test P-value. While some signals are common across cell-types, others show marked variation between cell-types.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-resp-fig1-v2.tif"/></fig><p>These results illustrate the reviewer’s point that it is important to consider batch effects in the analysis of single-cell RNA-Seq data. They suggest that in the context of moderate batch-effect, cNMF will likely not learn distinct technical components corresponding to batch alone but will instead learn hybrid batch-identity GEPs which must be interpreted correctly. Batch effect correction prior to cNMF can help address this challenge.</p><p>As was suggested in this reviewer comment, we have also computed the variance explained by cNMF for the simulated dataset and the real datasets analyzed in the manuscript (<xref ref-type="fig" rid="respfig2">Author response image 2</xref>).</p><fig id="respfig2"><label>Author response image 2.</label><caption><title>Variance explained by cNMF and PCA.</title><p>Variance explained by the cNMF solutions presented in the manuscript and Principal Components with the same K as was used for cNMF. Explained variance is calculated for the input matrix used for cNMF (2000 most over-dispersed genes, variance normalized).</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-43803-resp-fig2-v2.tif"/></fig><p>We compare this to the overall variance explained by the same number of principal components, which, as a consequence of the Eckart Young Mirsky theorem cited previously, will necessarily be greater than the variance explained by cNMF. We note that the proportion of variance explained by both cNMF and PCA is low: less than 40% for the datasets analyzed. This is a consequence of the extensive transcriptional noise in single-cell RNA-Seq data. We note that unlike for PCA, the cNMF components are not orthogonal to each other. As a result, the variance explained by all of the NMF components together is not equal to the sum of the variance explained by each NMF component individually. Treating each NMF component as an independent predictor and computing the reconstructed matrix, we find that the residual sum of squares is greater than the total sum of squares, making the explained variance negative. As a result, it doesn’t make sense to compute the variance explained by each factor for NMF like one would for PCA.</p></body></sub-article></article>