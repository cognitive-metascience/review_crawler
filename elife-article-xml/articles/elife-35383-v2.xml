<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1 20151215//EN"  "JATS-archivearticle1.dtd"><article article-type="research-article" dtd-version="1.1" xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn pub-type="epub" publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">35383</article-id><article-id pub-id-type="doi">10.7554/eLife.35383</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Tools and Resources</subject></subj-group><subj-group subj-group-type="heading"><subject>Structural Biology and Molecular Biophysics</subject></subj-group></article-categories><title-group><article-title><italic>cis</italic>TEM, user-friendly software for single-particle image processing</article-title></title-group><contrib-group><contrib contrib-type="author" corresp="yes" id="author-76286"><name><surname>Grant</surname><given-names>Timothy</given-names></name><email>tim@tgrant.co.uk</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="fund1"/><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" corresp="yes" id="author-106082"><name><surname>Rohou</surname><given-names>Alexis</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-3343-9621</contrib-id><email>a.rohou@gmail.com</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="fund1"/><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/><xref ref-type="fn" rid="pa1">†</xref></contrib><contrib contrib-type="author" corresp="yes" id="author-6967"><name><surname>Grigorieff</surname><given-names>Nikolaus</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-1506-909X</contrib-id><email>niko@grigorieff.org</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="fund1"/><xref ref-type="fn" rid="con3"/><xref ref-type="fn" rid="conf2"/></contrib><aff id="aff1"><label>1</label><institution content-type="dept">Janelia Research Campus</institution><institution>Howard Hughes Medical Institute</institution><addr-line><named-content content-type="city">Ashburn</named-content></addr-line><country>United States</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor" id="author-14573"><name><surname>Egelman</surname><given-names>Edward H</given-names></name><role>Reviewing Editor</role><aff id="aff2"><institution>University of Virginia</institution><country>United States</country></aff></contrib></contrib-group><author-notes><fn fn-type="present-address" id="pa1"><label>†</label><p>Department of Structural Biology, Genentech, South San Francisco, United States</p></fn></author-notes><pub-date date-type="publication" publication-format="electronic"><day>07</day><month>03</month><year>2018</year></pub-date><pub-date pub-type="collection"><year>2018</year></pub-date><volume>7</volume><elocation-id>e35383</elocation-id><history><date date-type="received" iso-8601-date="2018-01-24"><day>24</day><month>01</month><year>2018</year></date><date date-type="accepted" iso-8601-date="2018-03-02"><day>02</day><month>03</month><year>2018</year></date></history><permissions><copyright-statement>© 2018, Grant et al</copyright-statement><copyright-year>2018</copyright-year><copyright-holder>Grant et al</copyright-holder><ali:free_to_read/><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><ali:license_ref>http://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-35383-v2.pdf"/><abstract><object-id pub-id-type="doi">10.7554/eLife.35383.001</object-id><p>We have developed new open-source software called <italic>cis</italic>TEM (computational imaging system for transmission electron microscopy) for the processing of data for high-resolution electron cryo-microscopy and single-particle averaging. <italic>cis</italic>TEM features a graphical user interface that is used to submit jobs, monitor their progress, and display results. It implements a full processing pipeline including movie processing, image defocus determination, automatic particle picking, 2D classification, ab-initio 3D map generation from random parameters, 3D classification, and high-resolution refinement and reconstruction. Some of these steps implement newly-developed algorithms; others were adapted from previously published algorithms. The software is optimized to enable processing of typical datasets (2000 micrographs, 200 k – 300 k particles) on a high-end, CPU-based workstation in half a day or less, comparable to GPU-accelerated processing. Jobs can also be scheduled on large computer clusters using flexible run profiles that can be adapted for most computing environments. <italic>cis</italic>TEM is available for download from cistem.org.</p></abstract><kwd-group kwd-group-type="author-keywords"><kwd>cryo-EM</kwd><kwd>image analysis</kwd><kwd>software</kwd><kwd>electron microscopy</kwd><kwd>cistem</kwd><kwd>single-particle analysis</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd>None</kwd></kwd-group><funding-group><award-group id="fund1"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000011</institution-id><institution>Howard Hughes Medical Institute</institution></institution-wrap></funding-source><principal-award-recipient><name><surname>Grant</surname><given-names>Timothy</given-names></name><name><surname>Rohou</surname><given-names>Alexis</given-names></name><name><surname>Grigorieff</surname><given-names>Nikolaus</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value><italic>cis</italic>TEM enables fast processing of single-particle cryo-EM data on CPU-based workstations and is easily accessible to new users.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>The three-dimensional (3D) visualization of biological macromolecules and their assemblies by single-particle electron cryo-microscopy (cryo-EM) has become a prominent approach in the study of molecular mechanisms (<xref ref-type="bibr" rid="bib6">Cheng et al., 2015</xref>; <xref ref-type="bibr" rid="bib46">Subramaniam et al., 2016</xref>). Recent advances have been primarily due to the introduction of direct electron detectors (<xref ref-type="bibr" rid="bib27">McMullan et al., 2016</xref>). With the improved data quality, there is increasing demand for advanced computational algorithms to extract signal from the noisy image data and reconstruct 3D density maps from them at the highest possible resolution. The promise of near-atomic resolution (3–4 Å), where densities can be interpreted reliably with atomic models, has been realized by many software tools and suites (<xref ref-type="bibr" rid="bib10">Frank et al., 1996</xref>; <xref ref-type="bibr" rid="bib18">Hohn et al., 2007</xref>; <xref ref-type="bibr" rid="bib23">Lyumkis et al., 2013</xref>; <xref ref-type="bibr" rid="bib33">Punjani et al., 2017</xref>; <xref ref-type="bibr" rid="bib40">Scheres, 2012</xref>; <xref ref-type="bibr" rid="bib48">Tang et al., 2007</xref>; <xref ref-type="bibr" rid="bib50">van Heel et al., 1996</xref>). Many of these tools implement a standard set of image processing steps that are now routinely performed in a single particle project. These typically include movie frame alignment, contrast transfer function (CTF) determination, particle picking, two-dimensional (2D) classification, 3D reconstruction, refinement and classification, and sharpening of the final reconstructions.</p><p>We have written new software called <italic>cis</italic>TEM to implement a complete image processing pipeline for single-particle cryo-EM, including all these steps, accessible through an easy-to-use graphical user interface (GUI). Some of these steps implement newly-developed algorithms described below; others were adapted from previously published algorithms. <italic>cis</italic>TEM consists of a set of compiled programs and tools, as well as a wxWidgets-based GUI. The GUI launches programs and controls them by sending specific commands and receiving results via TCP/IP sockets. Each program can also be run manually, in which case it solicits user input on the command line. The design of <italic>cis</italic>TEM, therefore, allows users who would like to have more control over the different processing steps to design their own procedures outside the GUI. To adopt this new architecture, a number of previously existing Fortran-based programs were rewritten in C++, including Unblur and Summovie (<xref ref-type="bibr" rid="bib12">Grant and Grigorieff, 2015b</xref>), mag_distortion_correct (<xref ref-type="bibr" rid="bib11">Grant and Grigorieff, 2015a</xref>), CTFFIND4 (<xref ref-type="bibr" rid="bib35">Rohou and Grigorieff, 2015</xref>), and Frealign (<xref ref-type="bibr" rid="bib23">Lyumkis et al., 2013</xref>). Additionally, algorithms described previously were added for particle picking (<xref ref-type="bibr" rid="bib43">Sigworth, 2004</xref>), 2D classification (<xref ref-type="bibr" rid="bib39">Scheres et al., 2005</xref>) and ab-initio 3D reconstruction (<xref ref-type="bibr" rid="bib15">Grigorieff, 2016</xref>), sometimes with modifications to optimize their performance. <italic>cis</italic>TEM is open-source and distributed under the Janelia Research Campus Software License (<ext-link ext-link-type="uri" xlink:href="http://license.janelia.org/license/janelia_license_1_2.html">http://license.janelia.org/license/janelia_license_1_2.html</ext-link>).</p><p><italic>cis</italic>TEM currently does not support computation on graphical processing units (GPUs). Benchmarking of a hotspot identified in the global orientational search to determine particle alignment parameters showed that an NVIDIA K40 GPU performs approximately as well as 16 Xeon E5-2687W CPU cores after the code was carefully optimized for the respective hardware in both cases. Since CPU code is more easily maintained and more generally compatible with existing computer hardware, the potential benefit of GPU-adapted code is primarily the lower cost of a high-end GPU compared with a high-end CPU. We chose to focus on optimizing our code for CPUs.</p></sec><sec id="s2" sec-type="results"><title>Results</title><sec id="s2-1"><title>Movie alignment and CTF determination</title><p>Movie alignment and CTF determination are based on published algorithms previously implemented in Unblur and Summovie (<xref ref-type="bibr" rid="bib12">Grant and Grigorieff, 2015b</xref>), and CTFFIND4 (<xref ref-type="bibr" rid="bib35">Rohou and Grigorieff, 2015</xref>), respectively, and these are therefore only briefly described here. Unblur determines the translations of individual movie frames necessary to bring features (particles) visible in the frames into register. Each frame is aligned against a sum of all other frames that is iteratively updated until there is no further change in the translations. The trajectories along the x- and y-axes are smoothed using a Savitzky–Golay filter to reduce the possibility of spurious translations. Summovie uses the translations to calculate a final frame average with optional exposure filtering to take into account radiation damage of protein and maximize its signal in the final average. <italic>cis</italic>TEM combines the functionality of Unblur and Summovie into a single panel and exposes all relevant parameters to the user (<xref ref-type="fig" rid="fig1">Figure 1</xref>). Both programs were originally written in Fortran and have been rewritten entirely in C++.</p><fig id="fig1" position="float"><object-id pub-id-type="doi">10.7554/eLife.35383.002</object-id><label>Figure 1.</label><caption><title>Movie alignment panel of the <italic>cis</italic>TEM GUI.</title><p>All Action panels provide background information on the operation they control, as well as a section with detailed explanations of all user-accessible parameters. All Action panels also have an Expert Options section that exposes additional parameters.</p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-35383-fig1-v2"/></fig><p>CTFFIND4 fits a calculated two-dimensional CTF to Thon rings (<xref ref-type="bibr" rid="bib49">Thon, 1966</xref>) visible in the power spectrum calculated from either images or movies. The fitted parameters include astigmatism and, optionally, phase shifts generated by phase plates. When computed from movies, the Thon rings are often more clearly visible compared to Thon rings calculated from images (<xref ref-type="fig" rid="fig2">Figure 2</xref>; [<xref ref-type="bibr" rid="bib2">Bartesaghi et al., 2014</xref>]). When selecting movies as inputs, the user can specify how many frames should be summed to calculate power spectra. An optimal value to amplify Thon rings would be to sum the number of frames that correspond to an exposure of about four electrons/Å<sup>2</sup> (<xref ref-type="bibr" rid="bib28">McMullan et al., 2015</xref>).</p><fig id="fig2" position="float"><object-id pub-id-type="doi">10.7554/eLife.35383.003</object-id><label>Figure 2.</label><caption><title>Thon ring pattern calculated for micrograph ‘0000’ of the high-resolution dataset of β-galactosidase (<xref ref-type="bibr" rid="bib3">Bartesaghi et al., 2015</xref>) used to benchmark <italic>cis</italic>TEM.</title><p>The left pattern was calculated from the average of non-exposure filtered and aligned frames while the right pattern was calculated using the original movie with 3-frame sub-averages. The pattern calculated using the movie shows significantly stronger rings compared to the other pattern.</p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-35383-fig2-v2"/></fig><p>Since our original description of the CTFFFIND4 algorithm (<xref ref-type="bibr" rid="bib35">Rohou and Grigorieff, 2015</xref>), several significant changes were introduced. (1) The initial exhaustive search over defocus values can now be performed using a one-dimensional version of the CTF (i.e. with only two parameters: defocus and phase shift) against a radial average of the amplitude spectrum. This search is much faster than the equivalent search over the 2D CTF parameters (i.e., four parameters: two for defocus, one for astigmatism angle and one for phase shift) and can be expected to perform well except in cases of very large astigmatism (<xref ref-type="bibr" rid="bib54">Zhang, 2016</xref>). Once an initial estimate of the defocus parameter has been obtained, it is refined by a conjugate gradient minimizer against the 2D amplitude spectrum, as done previously. In <italic>cis</italic>TEM, the default behavior is to perform the initial search over the 1D amplitude spectrum, but the user can revert to previous behavior by setting a flag in the ‘Expert Options’ of the ‘Find CTF’ Action panel. (2) If the input micrograph’s pixel size is smaller than 1.4 Å, the resampling and clipping of its 2D amplitude spectrum will be adjusted so as to give a final spectrum for fitting with an edge corresponding to 1/2.8 Å<sup>−1</sup>, to avoid all of the Thon rings being located near the origin of the spectrum, where they can be very poorly sampled. (3) The computation of the quality of fit (<inline-formula><mml:math id="inf1"><mml:msub><mml:mrow><mml:mi>C</mml:mi><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mi>i</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> in [<xref ref-type="bibr" rid="bib35">Rohou and Grigorieff, 2015</xref>]) is now computed over a moving window, similar to (<xref ref-type="bibr" rid="bib42">Sheth et al., 2015</xref>), rather than at intervals delimited by nodes in the CTF. (4) Following background subtraction as described in <xref ref-type="bibr" rid="bib29">Mindell and Grigorieff (2003)</xref>, a radial, sine-edged mask is applied to the spectrum, and this masked version is used during search and refinement of defocus, astigmatism and phase shift parameters. The sine is 0.0 at the Fourier space origin, and 1.0 at a radius corresponding to 1/4 Å<sup>−1</sup>, and serves to emphasize high-resolution Thon rings, which are less susceptible to artefacts caused by imperfect background subtraction. For all outputs from the program (diagnostic image of the amplitude spectrum, 1D plots, etc.), the background-subtracted, but non-masked, version of the amplitude spectrum is used. (5) Users receive a warning if the box size of the amplitude spectrum and the estimated defocus parameters suggest that significant CTF aliasing occurred (<xref ref-type="bibr" rid="bib32">Penczek et al., 2014</xref>).</p></sec><sec id="s2-2"><title>Particle picking</title><p>Putative particles are found by matching to a soft-edged disk template, which is related to a convolution with Gaussians (<xref ref-type="bibr" rid="bib53">Voss et al., 2009</xref>) but uses additional statistics based on an algorithm originally described by <xref ref-type="bibr" rid="bib43">Sigworth (2004)</xref>. The use of a soft-edged disk template as opposed to structured templates has two main advantages. It greatly speeds up calculation, enabling picking in ‘real time’, and alleviates the problem of templates biasing the result of all subsequent processing towards those templates (<xref ref-type="bibr" rid="bib17">Henderson, 2013</xref>; <xref ref-type="bibr" rid="bib47">Subramaniam, 2013</xref>; <xref ref-type="bibr" rid="bib52">van Heel, 2013</xref>). Any bias that is introduced will be towards a featureless ‘blob’ and will likely be obvious if present.</p><p>Rather than fully describing the original algorithm by (<xref ref-type="bibr" rid="bib43">Sigworth, 2004</xref>), we will emphasize here where we deviated from it. The user must specify three parameters: the radius of the template disk, the maximum radius of the particle, which sets the minimum distance between picks, and the detection threshold value, given as a number of standard deviations of the (Gaussian) distribution of scores expected if no particles were present in the input micrograph. Values of 1.0 to 6.0 for this threshold generally give acceptable results. All other parameters mentioned below can usually remain set to their default values.</p><p>Prior to matched filtering, micrographs are resampled by Fourier cropping to a pixel size of 15 Å (the user can override this by changing the ‘Highest resolution used in picking’ value from its default 30 Å), and then filtered with a high-pass cosine-edged aperture to remove very low-frequency density ramps caused by variations in ice thickness or uneven illumination.</p><p>The background noise spectrum of the micrograph is estimated by computing the average rotational power spectrum of 50 areas devoid of particles, and is then used to ‘whiten’ the background (shot +solvent) noise of the micrograph. Normalization, including CTF effects, and matched filtering are then performed as described (<xref ref-type="bibr" rid="bib43">Sigworth, 2004</xref>), except using a single reference image and no principal components’ decomposition. When particles are very densely packed on micrographs, this approach can significantly over-estimate the background noise power so that users may find they have to use lower thresholds for picking. It might also be expected that under those circumstances, micrographs with much lower particle density will suffer from a higher rate of false-positive picks.</p><p>One difficulty in estimating the background noise spectrum of the micrograph is to locate areas devoid of particles without a priori knowledge of their locations. Our algorithm first computes a map of the local variance and local mean in the micrograph (computed over the area defined by the maximum radius given by the user [<xref ref-type="bibr" rid="bib36">Roseman, 2004</xref>; <xref ref-type="bibr" rid="bib51">Van Heel, 1982</xref>]) and the distribution of values of these mean and variance maps. The average radial power spectrum of the 50 areas of the micrograph with the lowest local variance is then used as an estimate of the background noise spectrum. Optionally, the user can set a different number of areas to be used for this estimate (for example if the density of particles is very high or very low) or use areas with local variances closest to the mode of the distribution of variances, which may also be expected to be devoid of particles.</p><p>Matched-filter methods are susceptible to picking high-contrast features such as contaminating ice crystals or carbon films. (<xref ref-type="bibr" rid="bib43">Sigworth, 2004</xref>) suggests subtracting matched references from the extracted boxes and examining the remainder in order to discriminate between real particles and false positives. In the interest of performance, we decided instead to pick using a single artificial reference (disk) and to forgo such subtraction approaches. To avoid picking these kinds of artifacts, the user can choose to ignore areas with abnormal local variance or local mean. We find that ignoring high-variance areas often helps avoid edges of problematic objects, e.g. ice crystals or carbon foils, and that avoiding high- and low-mean areas helps avoid picking from areas within them, e.g. the carbon foil itself or within an ice crystal (<xref ref-type="fig" rid="fig3">Figure 3</xref>). The thresholds used are set to <inline-formula><mml:math id="inf2"><mml:mi>M</mml:mi><mml:mi>o</mml:mi><mml:mo>+</mml:mo><mml:mn>2</mml:mn> <mml:mi/><mml:mi>F</mml:mi><mml:mi>W</mml:mi><mml:mi>H</mml:mi><mml:mi>M</mml:mi></mml:math></inline-formula> for the variance and <inline-formula><mml:math id="inf3"><mml:mi>M</mml:mi><mml:mi>o</mml:mi><mml:mo>±</mml:mo><mml:mn>2</mml:mn> <mml:mi/><mml:mi>F</mml:mi><mml:mi>W</mml:mi><mml:mi>H</mml:mi><mml:mi>M</mml:mi> <mml:mi/></mml:math></inline-formula>for the mean, where <inline-formula><mml:math id="inf4"><mml:mi>M</mml:mi><mml:mi>o</mml:mi></mml:math></inline-formula> is the mode (i.e. the most-commonly-occurring value) and <inline-formula><mml:math id="inf5"><mml:mi>F</mml:mi><mml:mi>W</mml:mi><mml:mi>H</mml:mi><mml:mi>M</mml:mi></mml:math></inline-formula> the full width at half-maximum of the distribution of the relevant statistic. For micrographs with additional phase plate phase shifts between 0.1 and 0.9 π, where much higher contrast is expected, the variance threshold is increased to <inline-formula><mml:math id="inf6"><mml:mi>M</mml:mi><mml:mi>o</mml:mi><mml:mo>+</mml:mo><mml:mn>8</mml:mn> <mml:mi/><mml:mi>F</mml:mi><mml:mi>W</mml:mi><mml:mi>H</mml:mi><mml:mi>M</mml:mi></mml:math></inline-formula>. We have found that in favorable cases many erroneous picks can be avoided. Remaining false-positive picks are removed later during 2D classification.</p><fig id="fig3" position="float"><object-id pub-id-type="doi">10.7554/eLife.35383.004</object-id><label>Figure 3.</label><caption><title>Particle picking panel of the <italic>cis</italic>TEM GUI.</title><p>The panel shows the preview mode, which allows interactive tuning of the picking parameters for optimal picking. The red circles overlaying the image of the sample indicate candidate particles. The picking algorithm avoids areas of high variance, such as the ice contamination visible in the image.</p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-35383-fig3-v2"/></fig><p>Because of our emphasis on performance, our algorithm can be run nearly instantaneously on a typical ~4K image, using a single processor. In the Action panel, the user is presented with an ‘Auto preview’ mode to enable interactive adjustment of the picking parameters (<xref ref-type="fig" rid="fig3">Figure 3</xref>). In this mode, the micrograph is displayed with optional and adjustable low-pass and high-pass filters, and the results of picking using the currently selected parameters are overlaid on top. Changing one or more of the parameters leads to a fast re-picking of the displayed micrograph, so that the parameters can be optimized in real-time. Once the three main parameters have been adjusted appropriately, the full complement of input micrographs can be picked, usually in a few seconds or minutes.</p><p>A possible disadvantage of using a single disk template exists when the particles to be picked are non-uniform in size or shape (e.g. in the case of an elongated particle). In this case, it may be expected that a single template would have difficulty in picking all the different types and views of particles present, and that in this case using a number of different templates would lead to a more accurate picking. In practice, we found that with careful optimization of the parameters, elongated particles and particles with size variation (<xref ref-type="fig" rid="fig3">Figure 3</xref>) were picked adequately.</p><p>The underlying implementation of the algorithm supports multiple references as well as reference rotation. These features may be exposed to the graphical user interface in future versions, for example enabling the use of 2D class averages as picking templates (<xref ref-type="bibr" rid="bib41">Scheres, 2015</xref>).</p></sec><sec id="s2-3"><title>2D classification</title><p>2D classification is a relatively quick and robust way to assess the quality of a single-particle dataset. <italic>cis</italic>TEM implements a maximum likelihood algorithm (<xref ref-type="bibr" rid="bib39">Scheres et al., 2005</xref>) and generates fully CTF-corrected class averages that typically display clear high-resolution detail, such as secondary structure. Integration of the likelihood function is done by evaluating the function at defined angular steps <inline-formula><mml:math id="inf7"><mml:mi>d</mml:mi><mml:mi>α</mml:mi></mml:math></inline-formula> that are calculated according to<disp-formula id="equ1"><label>(1)</label><mml:math id="m1"><mml:mi>d</mml:mi><mml:mi>α</mml:mi><mml:mo>=</mml:mo><mml:mi>R</mml:mi><mml:mo>/</mml:mo><mml:mi>D</mml:mi></mml:math></disp-formula>where <inline-formula><mml:math id="inf8"><mml:mi>R</mml:mi></mml:math></inline-formula> is the resolution limit of the data and <inline-formula><mml:math id="inf9"><mml:mi>D</mml:mi></mml:math></inline-formula> is the diameter of the particle (twice the mask radius that is applied to the iteratively-refined class averages). <italic>cis</italic>TEM runs a user-defined number of iterations <inline-formula><mml:math id="inf10"><mml:mi>n</mml:mi></mml:math></inline-formula> defaulting to 20. To speed up convergence, the resolution limit is adjusted as a function of iteration cycle <inline-formula><mml:math id="inf11"><mml:mi>l</mml:mi></mml:math></inline-formula> (<inline-formula><mml:math id="inf12"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mn>0</mml:mn><mml:mo>≤</mml:mo><mml:mtext> </mml:mtext><mml:mi>l</mml:mi><mml:mtext> </mml:mtext><mml:mo>&lt;</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula>):<disp-formula id="equ2"><label>(2)</label><mml:math id="m2"><mml:mi>R</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>h</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mi>n</mml:mi><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfenced></mml:mrow></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf13"><mml:msub><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf14"><mml:msub><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>h</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> are user-defined resolution limits at the first and last iteration, defaulting to 40 Å and 8 Å, respectively. The user also sets <inline-formula><mml:math id="inf15"><mml:mi>K</mml:mi></mml:math></inline-formula>, the number of classes to calculate. Depending on this number and the number of particles <inline-formula><mml:math id="inf16"><mml:mi>N</mml:mi></mml:math></inline-formula> in the dataset, only a percentage <inline-formula><mml:math id="inf17"><mml:mi>p</mml:mi></mml:math></inline-formula> of the particles are included in the calculation. These particles are randomly reselected for each iteration and <inline-formula><mml:math id="inf18"><mml:mi>p</mml:mi></mml:math></inline-formula> is typically small, for example 0.1, in the first 10 iterations (<inline-formula><mml:math id="inf19"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn><mml:mo>-</mml:mo><mml:mn>9</mml:mn></mml:mrow></mml:msub></mml:math></inline-formula>), then increases to 0.3 for iteration 10 to 14 (<inline-formula><mml:math id="inf20"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mn>10</mml:mn><mml:mo>-</mml:mo><mml:mn>14</mml:mn></mml:mrow></mml:msub></mml:math></inline-formula>) and finishes with five iterations including all data (<inline-formula><mml:math id="inf21"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mn>15</mml:mn><mml:mo>-</mml:mo><mml:mn>19</mml:mn></mml:mrow></mml:msub></mml:math></inline-formula>):<disp-formula id="equ3"><mml:math id="m3"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mn>0</mml:mn><mml:mo>−</mml:mo><mml:mn>9</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mtable columnalign="left left" columnspacing="1em" displaystyle="false" rowspacing=".2em"><mml:mtr><mml:mtd><mml:mn>300</mml:mn><mml:mi>K</mml:mi><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mi>N</mml:mi><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:mn>300</mml:mn><mml:mi>K</mml:mi><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mi>N</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>1</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mn>300</mml:mn><mml:mi>K</mml:mi><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mi>N</mml:mi><mml:mo>≥</mml:mo><mml:mn>1</mml:mn></mml:mtd></mml:mtr></mml:mtable><mml:mo fence="true" stretchy="true" symmetric="true"/></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula><disp-formula id="equ4"><label>(3)</label><mml:math id="m4"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mn>10</mml:mn><mml:mo>−</mml:mo><mml:mn>14</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mtable columnalign="left left" columnspacing="1em" displaystyle="false" rowspacing=".2em"><mml:mtr><mml:mtd><mml:mn>0.3</mml:mn><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mn>0</mml:mn><mml:mo>−</mml:mo><mml:mn>9</mml:mn></mml:mrow></mml:msub><mml:mo>&lt;</mml:mo><mml:mn>0.3</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mn>0</mml:mn><mml:mo>−</mml:mo><mml:mn>9</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mn>0</mml:mn><mml:mo>−</mml:mo><mml:mn>9</mml:mn></mml:mrow></mml:msub><mml:mo>≥</mml:mo><mml:mn>0.3</mml:mn></mml:mtd></mml:mtr></mml:mtable><mml:mo fence="true" stretchy="true" symmetric="true"/></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula><disp-formula id="equ5"><mml:math id="m5"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mn>15</mml:mn><mml:mo>−</mml:mo><mml:mn>19</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1.</mml:mn></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>For example, for a dataset containing <inline-formula><mml:math id="inf22"><mml:mi>N</mml:mi><mml:mo>=</mml:mo><mml:mn>100,000</mml:mn></mml:math></inline-formula> particles, <inline-formula><mml:math id="inf23"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn><mml:mo>-</mml:mo><mml:mn>9</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0.15</mml:mn></mml:math></inline-formula>, that is, 15% of the data will be used to obtain <inline-formula><mml:math id="inf24"><mml:mi>K</mml:mi><mml:mo>=</mml:mo><mml:mn>50</mml:mn></mml:math></inline-formula> classes. Apart from speeding up the calculation, the stepwise increase of the resolution limit and the random selection of subsets of the data also reduce the chance of overfitting (see also the calculation of ab-initio 3D reconstructions and 3D refinement below) and, therefore, increase the convergence radius of the 2D classification algorithm.</p><p>For the calculation of the likelihood function, the particle images <inline-formula><mml:math id="inf25"><mml:msub><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> are noise-whitened by dividing their Fourier transforms <inline-formula><mml:math id="inf26"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> by the square root of the radially average noise power spectrum, <inline-formula><mml:math id="inf27"><mml:mi>N</mml:mi><mml:mi>P</mml:mi><mml:mi>S</mml:mi></mml:math></inline-formula>:<disp-formula id="equ6"><label>(4)</label><mml:math id="m6"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mover><mml:mtext>X</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:msqrt><mml:mi>N</mml:mi><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>g</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msqrt></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf28"><mml:mi mathvariant="bold">g</mml:mi></mml:math></inline-formula> is the 2D reciprocal space coordinate and <inline-formula><mml:math id="inf29"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>g</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> its magnitude. The noise power spectrum is calculated from the boxed particle images using the area outside the circular mask set by the user according to the expected particle size. To increase accuracy, it is further averaged across 2000 randomly selected particles. The background (density outside the mask) is further normalized by adding a constant to each particle that yields a background average of zero.</p><p>Finally, at the beginning of each iteration, noise features in the class averages <inline-formula><mml:math id="inf30"><mml:msub><mml:mrow><mml:mtext>A</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> are suppressed by resetting negative values below a threshold <inline-formula><mml:math id="inf31"><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> to the threshold:<disp-formula id="equ7"><label>(5)</label><mml:math id="m7"><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mo>-</mml:mo><mml:mn>0.3</mml:mn><mml:mrow><mml:mrow><mml:munder><mml:mrow><mml:mi mathvariant="normal">max</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:munder></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>A</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf32"><mml:mi>j</mml:mi></mml:math></inline-formula> runs over all pixels in average <inline-formula><mml:math id="inf33"><mml:msub><mml:mrow><mml:mtext>A</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>.</p></sec><sec id="s2-4"><title>3D refinement (FrealignX)</title><p>The refinement of 3D reconstructions in <italic>cis</italic>TEM uses a version of Frealign (<xref ref-type="bibr" rid="bib23">Lyumkis et al., 2013</xref>) that was specifically designed to work with <italic>cis</italic>TEM. Most of Frealign’s control parameters are exposed to the user in the ‘Manual Refine’ Action panel (<xref ref-type="fig" rid="fig4">Figure 4</xref>). The ‘Auto Refine’ and ‘Ab-Initio’ panels also use Frealign but manage many of the parameters automatically (see below). Frealign’s algorithm was described previously (<xref ref-type="bibr" rid="bib14">Grigorieff, 2007</xref>; <xref ref-type="bibr" rid="bib23">Lyumkis et al., 2013</xref>) and this section will mostly cover important differences, including a new objective function used in the refinement, different particle weighting used in reconstructions, optional likelihood-based blurring, as well as new masking options.</p><fig id="fig4" position="float"><object-id pub-id-type="doi">10.7554/eLife.35383.005</object-id><label>Figure 4.</label><caption><title>Manual refinement panel with Expert Options exposed.</title><p>Most of the parameters needed to run FrealignX can be accessed on this panel. The panel also allows application of a 3D mask, which can be imported as a Volume Asset.</p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-35383-fig4-v2"/></fig><sec id="s2-4-1"><title>Matched filter</title><p>To make Frealign compatible with <italic>cis</italic>TEM’s GUI, the code was completely rewritten in C++, and it will be referred to here as Frealign v10, or FrealignX. The new version makes use of a matched filter (<xref ref-type="bibr" rid="bib26">McDonough and Whalen, 1995</xref>) to maximize the signal in cross correlation maps calculated between particle images and reference projections. This requires whitening of the noise present in the images and resolution-dependent scaling of the reference projections to match the signal in the noise-whitened images. Both can be achieved if the spectral signal-to-noise ratio (SSNR) of the data is known. As part of a 3D reconstruction, Frealign calculates the resolution-dependent <inline-formula><mml:math id="inf34"><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula>, the radially averaged SSNR present in the particle images before they are affected by the CTF (<xref ref-type="bibr" rid="bib44">Sindelar and Grigorieff, 2012</xref>). Using <inline-formula><mml:math id="inf35"><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula> and the CTF determined for a particle, the SSNR in the particle image can be calculated as<disp-formula id="equ8"><label>(6)</label><mml:math id="m8"><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:mfenced><mml:mo>×</mml:mo><mml:msup><mml:mrow><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mfenced separators="|"><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow></mml:mfenced></mml:math></disp-formula></p><p>(as before, <inline-formula><mml:math id="inf36"><mml:mi mathvariant="bold">g</mml:mi></mml:math></inline-formula> is the 2D reciprocal space coordinate and <inline-formula><mml:math id="inf37"><mml:mi>g</mml:mi><mml:mo>=</mml:mo><mml:mfenced close="|" open="|" separators="|"><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula>). Here, <inline-formula><mml:math id="inf38"><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula> is defined as the ratio of the variance of the signal and the noise. The Fourier transform <inline-formula><mml:math id="inf39"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mover><mml:mtext>X</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> of the noise-whitened particle image <inline-formula><mml:math id="inf40"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mo mathvariant="normal">~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> can then be calculated as<disp-formula id="equ9"><label>(7)</label><mml:math id="m9"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mover><mml:mtext>X</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:msqrt><mml:msubsup><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:mrow><mml:mo>(</mml:mo><mml:mi>g</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msqrt></mml:mfrac><mml:msqrt><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:msqrt></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf41"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> is the Fourier transform of the original image <inline-formula><mml:math id="inf42"><mml:msub><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, <inline-formula><mml:math id="inf43"><mml:mfenced close="|" open="|" separators="|"><mml:mrow> <mml:mi/><mml:mo>∙</mml:mo> <mml:mi/></mml:mrow></mml:mfenced></mml:math></inline-formula> is the absolute value, and <inline-formula><mml:math id="inf44"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mstyle></mml:math></inline-formula> is the radially averaged spectrum of the squared 2D Fourier transform amplitudes of image <inline-formula><mml:math id="inf45"><mml:msub><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. To implement <xref ref-type="disp-formula" rid="equ9">Equation (7)</xref>, a particle image is first divided by its amplitude spectrum, which includes power from both signal and noise, and then multiplied by a term that amplifies the image amplitudes according to the signal strength in the image. The reference projection <inline-formula><mml:math id="inf46"><mml:msub><mml:mrow><mml:mtext>A</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> can be matched by calculating<disp-formula id="equ10"><mml:math id="m10"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mover><mml:mtext>A</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mtext>A</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:msqrt><mml:msubsup><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mtext>A</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:mrow><mml:mo>(</mml:mo><mml:mi>g</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msqrt></mml:mfrac><mml:msqrt><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:msqrt></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p><xref ref-type="disp-formula" rid="equ10">Equation (8)</xref> scales the variance of the signal in the reference to be proportional to the measured signal-to-noise ratio in the noise-whitened images. The main term in the objective function <inline-formula><mml:math id="inf47"><mml:mi>O</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> maximized in FrealignX is therefore given by the cross-correlation function<disp-formula id="equ11"><label>(9a)</label><mml:math id="m11"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>C</mml:mi><mml:mi>C</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>R</mml:mi><mml:mi>e</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:msub><mml:mover><mml:mtext>A</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mover><mml:mtext>X</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mrow><mml:mo symmetric="true">‖</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:msub><mml:mover><mml:mtext>A</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo symmetric="true">‖</mml:mo></mml:mrow><mml:mrow><mml:mo symmetric="true">‖</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mover><mml:mtext>X</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo symmetric="true">‖</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf48"><mml:mi>ϕ</mml:mi></mml:math></inline-formula> is a set of parameters describing the particle view, x,y position, magnification and defocus, <inline-formula><mml:math id="inf49"><mml:mi>R</mml:mi><mml:mi>e</mml:mi><mml:mfenced separators="|"><mml:mrow> <mml:mi/><mml:mo>∙</mml:mo> <mml:mi/></mml:mrow></mml:mfenced></mml:math></inline-formula> is the real part of a complex number, <inline-formula><mml:math id="inf50"><mml:mfenced close="‖" open="‖" separators="|"><mml:mrow> <mml:mi/><mml:mo>∙</mml:mo> <mml:mi/></mml:mrow></mml:mfenced></mml:math></inline-formula> is the Euclidean norm, i.e. the square root of the sum of the squared pixel values, and <inline-formula><mml:math id="inf51"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtext> </mml:mtext><mml:mo>⋅</mml:mo><mml:mtext> </mml:mtext></mml:mrow><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mstyle></mml:math></inline-formula> is the conjugate complex value of the Fourier transform <inline-formula><mml:math id="inf52"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtext> </mml:mtext><mml:mo>⋅</mml:mo><mml:mtext> </mml:mtext></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula>. The subscripts <inline-formula><mml:math id="inf53"><mml:mi>R</mml:mi><mml:mn>1</mml:mn></mml:math></inline-formula> and <inline-formula><mml:math id="inf54"><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:math></inline-formula> specify the low- and high-resolution limits of the Fourier transforms included in the calculation of <xref ref-type="disp-formula" rid="equ11">Equation (9a)</xref>, as specified by the user. To reduce noise overfitting, the user has the option to specify also a resolution range in which the absolute value of the cross terms in the numerator of <xref ref-type="disp-formula" rid="equ11">Equation (9a)</xref> are used (<xref ref-type="bibr" rid="bib13">Grigorieff, 2000</xref>; <xref ref-type="bibr" rid="bib45">Stewart and Grigorieff, 2004</xref>), instead of the signed values (option ‘Signed CC Resolution Limit’ under ‘Expert Options’ in the ‘Manual Refine’ Action panel). In this case<disp-formula id="equ12"><label>(9b)</label><mml:math id="m12"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>C</mml:mi><mml:mi>C</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>R</mml:mi><mml:mi>e</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:msub><mml:mover><mml:mtext>A</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mover><mml:mtext>X</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mi>R</mml:mi><mml:mi>e</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>2</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:msub><mml:mover><mml:mtext>A</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>2</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mover><mml:mtext>X</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mrow><mml:mo symmetric="true">‖</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:msub><mml:mover><mml:mtext>A</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo symmetric="true">‖</mml:mo></mml:mrow><mml:mrow><mml:mo symmetric="true">‖</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>R</mml:mi><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mover><mml:mtext>X</mml:mtext><mml:mrow><mml:mo>∼</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo symmetric="true">‖</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf55"><mml:mi>R</mml:mi><mml:mn>2</mml:mn></mml:math></inline-formula> is specified by the ‘Signed CC Resolution Limit.’ The objective function also includes a term <inline-formula><mml:math id="inf56"><mml:mi>R</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Θ</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> to restrain alignment parameters (<xref ref-type="bibr" rid="bib4">Chen et al., 2009</xref>; <xref ref-type="bibr" rid="bib23">Lyumkis et al., 2013</xref>; <xref ref-type="bibr" rid="bib43">Sigworth, 2004</xref>), which currently only includes the x,y positions:<disp-formula id="equ13"><label>(10)</label><mml:math id="m13"><mml:mi>R</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Θ</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mo>-</mml:mo><mml:mfrac><mml:mrow><mml:msup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:mfrac><mml:mfenced separators="|"><mml:mrow><mml:mfrac><mml:mrow><mml:msup><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mi>x</mml:mi><mml:mo>-</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:msubsup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mfrac><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:msup><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mi>y</mml:mi><mml:mo>-</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:msubsup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:math></disp-formula>where <inline-formula><mml:math id="inf57"><mml:mi>σ</mml:mi></mml:math></inline-formula> is the standard deviation of the noise in the particle image and <inline-formula><mml:math id="inf58"><mml:mi mathvariant="normal">Θ</mml:mi></mml:math></inline-formula> represents a set of model parameters including the average particle positions in a dataset, <inline-formula><mml:math id="inf59"><mml:mover accent="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:math></inline-formula> and <inline-formula><mml:math id="inf60"><mml:mover accent="true"><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:math></inline-formula>, and the standard deviations of the x,y positions from the average values, <inline-formula><mml:math id="inf61"><mml:msub><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf62"><mml:msub><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, and <inline-formula><mml:math id="inf63"><mml:mi>M</mml:mi></mml:math></inline-formula> is the number of pixels in the mask applied to the particle before alignment. The complete objective function is therefore<disp-formula id="equ14"><mml:math id="m14"><mml:mi>O</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi>C</mml:mi><mml:mi>C</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow></mml:mfenced><mml:mo>+</mml:mo><mml:mi>R</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Θ</mml:mi></mml:mrow></mml:mfenced></mml:math></disp-formula></p><p>The maximized values determined in a refinement are converted to particle scores by multiplication with 100.</p></sec><sec id="s2-4-2"><title>CTF refinement</title><p>FrealignX can refine the defocus assigned to each particle. Given typical imaging conditions with current instrumentation (300 kV, direct electron detector), this may be useful when particles have a size of about 400 kDa or larger. Depending on the quality of the sample and images, these particles may generate sufficient signal to yield per-particle defocus values that are more accurate than the average defocus values determined for whole micrographs by CTFFIND4 (see above). Refinement is achieved by a simple one-dimensional grid search of a defocus offset applied to both defocus values determined in the 2D CTF fit obtained by CTFFIND4. FrealignX applies this offset to the starting values in a refinement, typically determined by CTFFIND4, and evaluates the objective function, <xref ref-type="disp-formula" rid="equ14">Equation (11)</xref>, for each offset. The offset yielding the maximum is then used to assign refined defocus values. In a typical refinement, the defocus offset is searched in steps of 50 Å, in a range of ±500 Å. In the case of β-galactosidase (see below), a single round of defocus refinement changed the defocus on average by 60 Å; the RMS change was 80 Å. For this refinement, the resolution for the signed cross terms equaled the overall refinement resolution limit (3.1 Å), i.e. no unsigned cross terms were used. The refinement produced a marginal improvement of 0.05 Å in the Fourier Shell Correlation (FSC) threshold of 0.143, suggesting that the defocus values determined by CTFFIND4 were already close to optimal. In a different dataset of rotavirus double-layer particles, a single round of defocus refinement changed the defocus on average by 160 Å; the RMS change was 220 Å. In this case, the refinement increased the resolution from ~3.0 Å to ~2.8 Å.</p></sec><sec id="s2-4-3"><title>Masking</title><p>FrealignX has a 3D masking function to help in the refinement of structures that contain significant disordered regions, such as micelles in detergent-solubilized membrane proteins. To apply a 3D mask, the user supplies a 3D volume that contains positive and negative values. <italic>cis</italic>TEM will binarize this volume by zeroing all voxels with values less than or equal to zero, and setting all other voxels to 1, indicating the region of the volume that is inside the mask. A soft cosine-shaped falloff of specified width (e.g. 10 Å) is then applied to soften the edge of the masked region and avoid sharp edges when the mask is applied to a 3D reconstruction. The region of the reconstruction outside the mask can be set to zero (simple multiplication of the mask volume), or to a low-pass filtered version of the original density, optionally downweighted by multiplication by a scaling factor set by the user. At the edge of the mask, the low-pass filtered density is blended with the unfiltered density inside the mask to produce a smooth transition. <xref ref-type="fig" rid="fig5">Figure 5</xref> shows the result of masking the reconstruction of an ABC transporter associated with antigen processing (TAP, [<xref ref-type="bibr" rid="bib31">Oldham et al., 2016</xref>]). The mask was designed to contain only density corresponding to protein and the outside density was low-pass filtered at 30 Å resolution and kept with a weight of 100% in the final masked reconstruction. The combination of masking and low-pass filtering in this case keeps a low-pass filtered version of the density outside the mask in the reconstruction, including the detergent micelle. Detergent micelles can be a source of noise in the particle images because the density represents disordered material. However, at low, 20 to 30 Å resolution, micelles generate features in the images that can help in the alignment of the particles. In the case of TAP, this masking prevented noise overfitting in the detergent micelle and helped obtain a reconstruction at 4 Å resolution (<xref ref-type="bibr" rid="bib31">Oldham et al., 2016</xref>).</p><fig id="fig5" position="float"><object-id pub-id-type="doi">10.7554/eLife.35383.006</object-id><label>Figure 5.</label><caption><title>3D masking with low-pass filtering outside the mask.</title><p>(<bold>A</bold>) Orthogonal sections through the 3D reconstruction of the transporter associated with antigen processing (TAP), an ABC transporter (<xref ref-type="bibr" rid="bib31">Oldham et al., 2016</xref>). Density corresponding to the protein, as well as the detergent micelle (n-Dodecyl b-D-maltoside; highlighted with arrows), is visible. (<bold>B</bold>) Orthogonal sections through a 3D mask corresponding to the sections shown in A). The sharp edges of this mask are smoothed before the mask is applied to the map. (<bold>C</bold>) Orthogonal sections through the masked 3D reconstruction. The regions outside the mask are low-pass filtered at 30 Å resolution to remove high-resolution noise from the disordered detergent micelle, but keeping its low-resolution signal to help particle alignment.</p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-35383-fig5-v2"/></fig></sec><sec id="s2-4-4"><title>3D reconstruction</title><p>In Frealign, a 3D reconstruction <inline-formula><mml:math id="inf64"><mml:msub><mml:mrow><mml:mtext>V</mml:mtext></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> of class average <inline-formula><mml:math id="inf65"><mml:mi>k</mml:mi></mml:math></inline-formula> and containing <inline-formula><mml:math id="inf66"><mml:mi>N</mml:mi></mml:math></inline-formula> images is calculated as (<xref ref-type="bibr" rid="bib23">Lyumkis et al., 2013</xref>; <xref ref-type="bibr" rid="bib44">Sindelar and Grigorieff, 2012</xref>)<disp-formula id="equ15"><label>(12)</label><mml:math id="m15"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mtext>V</mml:mtext><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:mo>{</mml:mo><mml:mfrac><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:msub><mml:mi>q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mi>σ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mfrac><mml:mrow><mml:mi mathvariant="script">ℛ</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:msub><mml:mi>w</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>⋅</mml:mo><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:msub><mml:mi>F</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⋅</mml:mo><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover><mml:mi mathvariant="normal">X</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:msub><mml:mi>q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mi>σ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mfrac><mml:mrow><mml:mi mathvariant="script">ℛ</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>⋅</mml:mo><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:msubsup><mml:mi>F</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:mtext> </mml:mtext></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:msub><mml:mi>R</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf67"><mml:msub><mml:mrow><mml:mi>q</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the probability of particle <inline-formula><mml:math id="inf68"><mml:mi>i</mml:mi></mml:math></inline-formula> belonging to class <inline-formula><mml:math id="inf69"><mml:mi>k</mml:mi></mml:math></inline-formula>, <inline-formula><mml:math id="inf70"><mml:msub><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the standard deviation of the noise in particle image <inline-formula><mml:math id="inf71"><mml:mi>i</mml:mi></mml:math></inline-formula>, <inline-formula><mml:math id="inf72"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> are its alignment parameters, <inline-formula><mml:math id="inf73"><mml:msub><mml:mrow><mml:mi>w</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> the score-based weights (<xref ref-type="disp-formula" rid="equ17">Equation (14)</xref>, see below), <inline-formula><mml:math id="inf74"><mml:msub><mml:mrow><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> the CTF of the particle image, <inline-formula><mml:math id="inf75"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℛ</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>⋅</mml:mo><mml:mtext> </mml:mtext></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> the reconstruction operator merging data into a 3D volume according to alignment parameters <inline-formula><mml:math id="inf76"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, <inline-formula><mml:math id="inf77"><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula> the radially averaged particle SSNR derived from the FSC between half-maps (<xref ref-type="bibr" rid="bib44">Sindelar and Grigorieff, 2012</xref>), <inline-formula><mml:math id="inf78"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mo mathvariant="normal">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> the noise-whitened image <inline-formula><mml:math id="inf79"><mml:mi>i</mml:mi></mml:math></inline-formula>, and <inline-formula><mml:math id="inf80"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtext> </mml:mtext><mml:mo>⋅</mml:mo><mml:mtext> </mml:mtext></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> the inverse Fourier transform. For the calculation of the 3D reconstructions, as well as 3D classification (see below) the particle images are not whitened according to <xref ref-type="disp-formula" rid="equ9">Equation (7)</xref>. Instead, they are whitened using the radially- and particle-averaged power spectrum of the background around the particles:<disp-formula id="equ16"><label>(13)</label><mml:math id="m16"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover><mml:mi mathvariant="normal">X</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>}</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">g</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:msqrt><mml:msubsup><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mrow><mml:mi mathvariant="script">ℱ</mml:mi></mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mi>B</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:mrow><mml:mo>(</mml:mo><mml:mi>g</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msqrt></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf81"><mml:mi>B</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math></inline-formula> is a masked version of image <inline-formula><mml:math id="inf82"><mml:msub><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> with the area inside a circular mask centered on the particle replaced with the average values at the edge of the mask, and scaled variance to produce an average pixel variance of 1 in the whitened image <inline-formula><mml:math id="inf83"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mo mathvariant="normal">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. Using the procedure in <xref ref-type="disp-formula" rid="equ16">Equation (13)</xref> has the advantage that whitening does not depend on the knowledge of the SSNR of the data, and reconstructions can therefore be calculated even when the SSNR is not known.</p></sec><sec id="s2-4-5"><title>Score-based weighting</title><p>In previous versions of Frealign, resolution-dependent weighting was applied to the particle images during reconstruction (the Frealign parameter was called ‘PBC’, (<xref ref-type="bibr" rid="bib14">Grigorieff, 2007</xref>)). The weighting function took the form of a B-factor dependent exponential that attenuates the image data at higher resolution. FrealignX still uses B-factor weighting but the weighting function is now derived from the particle scores (see above) as<disp-formula id="equ17"><label>(14)</label><mml:math id="m17"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>w</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>s</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mo>,</mml:mo><mml:mtext> g</mml:mtext></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mi>B</mml:mi><mml:mi>S</mml:mi><mml:mi>C</mml:mi></mml:mrow><mml:mn>4</mml:mn></mml:mfrac><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>s</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mo>−</mml:mo><mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi></mml:mrow><mml:mo>−</mml:mo></mml:mover></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:msup><mml:mi>g</mml:mi><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:msup><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p><inline-formula><mml:math id="inf84"><mml:mi>B</mml:mi><mml:mi>S</mml:mi><mml:mi>C</mml:mi></mml:math></inline-formula> converts the difference between a particle score and <inline-formula><mml:math id="inf85"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi></mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula>, the score average, into a B-factor. Setting <inline-formula><mml:math id="inf86"><mml:mi>B</mml:mi><mml:mi>S</mml:mi><mml:mi>C</mml:mi></mml:math></inline-formula> to zero will turn off score-based particle weighting. Scores typically vary by about 10, and values for <inline-formula><mml:math id="inf87"><mml:mi>B</mml:mi><mml:mi>S</mml:mi><mml:mi>C</mml:mi></mml:math></inline-formula> that produce reasonable discrimination between high-scoring and low-scoring particles are between 2 and 10 Å<sup>2</sup>, resulting in B-factor differences between particles of 20 to 100 Å<sup>2</sup>.</p></sec><sec id="s2-4-6"><title>3D classification </title><p>FrealignX uses a maximum-likelihood approach for 3D classification (<xref ref-type="bibr" rid="bib23">Lyumkis et al., 2013</xref>). Assuming that all images were noise-whitened according to <xref ref-type="disp-formula" rid="equ16">Equation (13)</xref>, which scales the variance of each image such that the average standard deviation of the noise in a pixel is 1, the probability density function (PDF) of observing image <inline-formula><mml:math id="inf88"><mml:msub><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, given alignment parameters <inline-formula><mml:math id="inf89"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and reconstruction <inline-formula><mml:math id="inf90"><mml:msub><mml:mrow><mml:mtext>V</mml:mtext></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, is calculated as (<xref ref-type="bibr" rid="bib23">Lyumkis et al., 2013</xref>)<disp-formula id="equ18"><label>(15)</label><mml:math id="m18"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">Γ</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mtext>V</mml:mtext><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi></mml:mrow></mml:mfrac><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mover><mml:mi>M</mml:mi><mml:mo>∼</mml:mo></mml:mover></mml:mrow></mml:msup><mml:mi>exp</mml:mi><mml:mo>⁡</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:msubsup><mml:mrow><mml:mo symmetric="true">‖</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover><mml:mi mathvariant="normal">X</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:msub><mml:mi>F</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⋅</mml:mo><mml:mi mathvariant="normal">℘</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mtext>V</mml:mtext><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo symmetric="true">‖</mml:mo></mml:mrow><mml:mrow><mml:mover><mml:mi>M</mml:mi><mml:mo>∼</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:mn>2</mml:mn></mml:mfrac></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mi>γ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">Θ</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>As before, <inline-formula><mml:math id="inf91"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> are the alignment parameters (usually just Euler angles and x,y shifts) determined for image <inline-formula><mml:math id="inf92"><mml:mi>i</mml:mi></mml:math></inline-formula> with respect to class average <inline-formula><mml:math id="inf93"><mml:mi>k</mml:mi></mml:math></inline-formula>, <inline-formula><mml:math id="inf94"><mml:mi>℘</mml:mi></mml:math></inline-formula> is the projection operator producing an aligned 2D projection of reconstruction <inline-formula><mml:math id="inf95"><mml:msub><mml:mrow><mml:mtext>V</mml:mtext></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> according to parameters <inline-formula><mml:math id="inf96"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, <inline-formula><mml:math id="inf97"><mml:msubsup><mml:mrow><mml:mfenced close="‖" open="‖" separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mo mathvariant="normal">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>∙</mml:mo><mml:mi>℘</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mtext>V</mml:mtext></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>M</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:math></inline-formula> is the sum of the squared pixel value differences between whitened image <inline-formula><mml:math id="inf98"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mo mathvariant="normal">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and the reference projection inside a circular mask defining the area of the particle with user-defined diameter, <inline-formula><mml:math id="inf99"><mml:mover accent="true"><mml:mrow><mml:mi>M</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:math></inline-formula> is the number of pixels inside this mask, and <inline-formula><mml:math id="inf100"><mml:mi>γ</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">Θ</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math></inline-formula> is a hierarchical prior describing the probability of observing alignment parameters <inline-formula><mml:math id="inf101"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> given model parameters <inline-formula><mml:math id="inf102"><mml:msub><mml:mrow><mml:mi mathvariant="normal">Θ</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> (see <xref ref-type="disp-formula" rid="equ13">Equation 10</xref>). <xref ref-type="disp-formula" rid="equ18">Equation (15)</xref> does not include marginalization over alignment parameters. Marginalization could be added to improve classification when particle alignments suffer from significant errors. However, this is currently not implemented in <italic>cis</italic>TEM. Given the joint probability, <xref ref-type="disp-formula" rid="equ18">Equation (15)</xref>, determined in a refinement, the probability <inline-formula><mml:math id="inf103"><mml:msub><mml:mrow><mml:mi>q</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> of particle <inline-formula><mml:math id="inf104"><mml:mi>i</mml:mi></mml:math></inline-formula> belonging to class <inline-formula><mml:math id="inf105"><mml:mi>k</mml:mi></mml:math></inline-formula> can be updated as (<xref ref-type="bibr" rid="bib23">Lyumkis et al., 2013</xref>)<disp-formula id="equ19"><label>(16)</label><mml:math id="m19"><mml:msub><mml:mrow><mml:mi>q</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">Γ</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">Θ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mtext>V</mml:mtext></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:msub><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:msubsup><mml:mrow><mml:mi mathvariant="normal">Γ</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">Θ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mtext>V</mml:mtext></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:msub><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow></mml:mfrac></mml:math></disp-formula>where the summation in the denominator is taken over all classes and the average probabilities <inline-formula><mml:math id="inf106"><mml:msub><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> for a particle to belong to class <inline-formula><mml:math id="inf107"><mml:mi>k</mml:mi></mml:math></inline-formula> are given by the average values of <inline-formula><mml:math id="inf108"><mml:msub><mml:mrow><mml:mi>q</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> determined in a prior iteration, calculated for the entire dataset of <inline-formula><mml:math id="inf109"><mml:mi>N</mml:mi></mml:math></inline-formula> particles:<disp-formula id="equ20"><label>(17)</label><mml:math id="m20"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mtext>1</mml:mtext><mml:mi>N</mml:mi></mml:mfrac><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mi>q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>An example of 3D classification is shown in <xref ref-type="fig" rid="fig6">Figure 6</xref> for F<sub>1</sub>F<sub>O</sub>-ATPase, revealing different conformational states of the γ subunit (<xref ref-type="bibr" rid="bib55">Zhou et al., 2015</xref>).</p><fig id="fig6" position="float"><object-id pub-id-type="doi">10.7554/eLife.35383.007</object-id><label>Figure 6.</label><caption><title>3D classification of a dataset of F<sub>1</sub>F<sub>O</sub>-ATPase, revealing different conformational states (reproduced from <xref ref-type="fig" rid="fig6">Figure 6A and B</xref> in <xref ref-type="bibr" rid="bib55">Zhou et al., 2015</xref>).</title><p>Sections through the F<sub>1</sub> domain showing the γ subunit (arrows) in three different states related by 120° rotations are shown on the left. A surface rendering of the map corresponding to State 1a is shown on the right. Scale bars, 25 Å.</p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-35383-fig6-v2"/></fig></sec><sec id="s2-4-7"><title>Focused classification</title><p>3D classification can be improved by focusing on conformationally- or compositionally-variable regions of the map. To achieve this, a mask is applied to the particle images and reference projections, the area of which is defined as the projection of a sphere with user-specified center (within the 3D reconstruction) and radius. This 2D mask is therefore defined independently for each particle, as a function of its orientation. When using focused classification, <inline-formula><mml:math id="inf110"><mml:mover accent="true"><mml:mrow><mml:mi>M</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:math></inline-formula> in <xref ref-type="disp-formula" rid="equ18">Equation (15)</xref> is adjusted to the number of pixels inside the projected mask and the sum of the squared pixel value differences in <xref ref-type="disp-formula" rid="equ18">Equation (15)</xref> is limited to the area of the 2D mask. By applying the same mask to image and reference, only variability inside the masked region is used for 3D classification. Other regions of the map are ignored, leading to a ‘focusing’ on the region of interest. The focused mask also excludes noise contained in the particle images outside the mask and therefore improves classification results that often depend on detecting small differences between particles and references. A typical application of a focused mask is in the classification of ribosome complexes that may exhibit localized conformational and/or compositional variability, for example the variable conformations of an IRES (<xref ref-type="bibr" rid="bib1">Abeyrathne et al., 2016</xref>) or different states of tRNA accommodation (<xref ref-type="bibr" rid="bib22">Loveland et al., 2017</xref>).</p></sec><sec id="s2-4-8"><title>Likelihood-based blurring</title><p>In some cases, the convergence radius of refinement can be improved by blurring the reconstruction according to a likelihood function. This procedure is similar to the maximization step in a maximum likelihood approach (<xref ref-type="bibr" rid="bib40">Scheres, 2012</xref>). The likelihood-blurred reconstruction is given by<disp-formula id="equ21"><label>(18)</label><mml:math id="m21"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msubsup><mml:mtext>V</mml:mtext><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:mn>1</mml:mn><mml:msubsup><mml:mi>σ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mfrac><mml:msubsup><mml:mo>∫</mml:mo><mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>α</mml:mi><mml:mi>x</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow/></mml:msubsup><mml:mrow><mml:mi mathvariant="normal">Γ</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msubsup><mml:mtext>V</mml:mtext><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="script">ℛ</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:msub><mml:mi>w</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⋅</mml:mo><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:msub><mml:mi>F</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⋅</mml:mo><mml:msub><mml:mtext>X</mml:mtext><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi>d</mml:mi><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>α</mml:mi><mml:mi>x</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:msub><mml:mi>q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mi>σ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mfrac><mml:mrow><mml:mi mathvariant="script">ℛ</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>ϕ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>⋅</mml:mo><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:msubsup><mml:mi>F</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:mtext> </mml:mtext></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:msub><mml:mi>R</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula>where, in the case of FrealignX, <inline-formula><mml:math id="inf111"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>α</mml:mi><mml:mi>x</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> only includes the x,y particle positions and in-plane rotation angle <inline-formula><mml:math id="inf112"><mml:mi>α</mml:mi></mml:math></inline-formula>, which are a subset of the alignment parameters <inline-formula><mml:math id="inf113"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, and <inline-formula><mml:math id="inf114"><mml:msubsup><mml:mrow><mml:mtext>V</mml:mtext></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup></mml:math></inline-formula> is the reconstruction from an earlier refinement iteration. As before, <inline-formula><mml:math id="inf115"><mml:mi mathvariant="normal">Γ</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mtext>X</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mtext>V</mml:mtext></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:math></inline-formula> is the probability of observing image <inline-formula><mml:math id="inf116"><mml:mi>i</mml:mi></mml:math></inline-formula>, given alignment parameters <inline-formula><mml:math id="inf117"><mml:msub><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and reconstruction <inline-formula><mml:math id="inf118"><mml:msubsup><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup></mml:math></inline-formula>. Integration over these three parameters can be efficiently implemented and, therefore, does not produce a significant additional computational burden.</p></sec><sec id="s2-4-9"><title>Resolution assessment</title><p>The resolution of reconstructions generated by FrealignX is assessed using the FSC criterion (<xref ref-type="bibr" rid="bib16">Harauz and van Heel, 1986</xref>) using the 0.143 threshold (<xref ref-type="bibr" rid="bib37">Rosenthal and Henderson, 2003</xref>). FSC curves in <italic>cis</italic>TEM are calculated using two reconstructions (‘half-maps’) calculated either from the even-numbered and odd-numbered particles, or by dividing the dataset into 100 equal subsets and using the even- and odd-numbered subsets to calculate the two reconstructions (in the <italic>cis</italic>TEM GUI, the latter is always used). The latter method has the advantage that accidental duplication of particles in a stack is less likely to affect the FSC calculation. All particles are refined against a single reference and, therefore, the calculated FSC values may be biased towards higher values (<xref ref-type="bibr" rid="bib13">Grigorieff, 2000</xref>; <xref ref-type="bibr" rid="bib45">Stewart and Grigorieff, 2004</xref>). This bias extends slightly beyond the resolution limit imposed during refinement, by approximately <inline-formula><mml:math id="inf119"><mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>s</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></inline-formula>, where <inline-formula><mml:math id="inf120"><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>s</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the mask radius used to mask the reconstructions (see above). During auto-refinement (see below), the resolution limit imposed during refinement is carefully adjusted to stay well below the estimated resolution of the reconstruction and the resolution estimate is therefore unbiased (<xref ref-type="bibr" rid="bib38">Scheres and Chen, 2012</xref>). However, users have full control over all parameters during manual refinement and will have to make sure that they do not bias the resolution estimate by choosing a resolution limit that is close to, or higher than, the estimated resolution of the final reconstruction. Calculated FSC curves are smoothed using a Savitzky–Golay cubic polynomial that reduces the noise often affecting FSC curves at the high-resolution end.</p><p>The FSC calculated between two density maps is dependent on the amount of solvent included inside the mask applied to the maps. A larger mask that includes more solvent background will yield lower FSC values than a tighter mask. To obtain an accurate resolution estimate in the region of the particle density, one possibility is to apply a tight mask that closely follows the boundary of the particle. This approach bears the risk of generating artifacts because the particle boundary is not always well defined, especially when the particle includes disordered domains that generate weak density in the reconstruction. The approach in Frealign avoids tight masking and instead calculates an FSC curve using generously masked density maps, corrected for the solvent content inside the mask (<xref ref-type="bibr" rid="bib44">Sindelar and Grigorieff, 2012</xref>). The corrected FSC curve is referred to as <inline-formula><mml:math id="inf121"><mml:mi>P</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi><mml:mo>_</mml:mo><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:mi>C</mml:mi></mml:math></inline-formula> and is calculated from the uncorrected <inline-formula><mml:math id="inf122"><mml:msub><mml:mrow><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>u</mml:mi><mml:mi>n</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> as (<xref ref-type="bibr" rid="bib31">Oldham et al., 2016</xref>)<disp-formula id="equ22"><label>(19)</label><mml:math id="m22"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>P</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi><mml:mi mathvariant="normal">_</mml:mi><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>l</mml:mi><mml:mi>f</mml:mi><mml:mo>−</mml:mo><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>p</mml:mi><mml:mi>s</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>f</mml:mi><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>u</mml:mi><mml:mi>n</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>f</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>u</mml:mi><mml:mi>n</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf123"><mml:mi>f</mml:mi></mml:math></inline-formula> is the ratio of mask volume to estimated particle volume. The particle volume can be estimated from its molecular mass <inline-formula><mml:math id="inf124"><mml:msub><mml:mrow><mml:mi>M</mml:mi></mml:mrow><mml:mrow><mml:mi>w</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> as <inline-formula><mml:math id="inf125"><mml:mfrac><mml:mrow><mml:msup><mml:mrow><mml:mi>Å</mml:mi></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mn>0.81</mml:mn><mml:mtext>Da</mml:mtext></mml:mrow></mml:mfrac><mml:msub><mml:mrow><mml:mi>M</mml:mi></mml:mrow><mml:mrow><mml:mi>w</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> (<xref ref-type="bibr" rid="bib25">Matthews, 1968</xref>). FSC curves obtained with the generous masking and subsequent solvent correction yield resolution estimates that are very close to those obtained with tight masking (<xref ref-type="fig" rid="fig7">Figure 7C</xref>). <xref ref-type="disp-formula" rid="equ22">Equation (19)</xref> assumes that both maps have similar SSNR values, as is normally the case for the two reconstructions calculated from two halves of the dataset, indicated by the subscript <inline-formula><mml:math id="inf126"><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>l</mml:mi><mml:mi>f</mml:mi><mml:mo>-</mml:mo><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>p</mml:mi><mml:mi>s</mml:mi></mml:math></inline-formula>. If one of the maps does not contain noise from solvent background, for example when calculating the FSC between a reconstruction and a map derived from an atomic model, the solvent-corrected FSC is given as<disp-formula id="equ23"><label>(20)</label><mml:math id="m23"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>P</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi><mml:mi mathvariant="normal">_</mml:mi><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>m</mml:mi><mml:mi>o</mml:mi><mml:mi>d</mml:mi><mml:mi>e</mml:mi><mml:mi>l</mml:mi><mml:mo>−</mml:mo><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msqrt><mml:mfrac><mml:mrow><mml:mi>f</mml:mi><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:msubsup><mml:mi>C</mml:mi><mml:mrow><mml:mi>u</mml:mi><mml:mi>n</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>f</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:msubsup><mml:mi>C</mml:mi><mml:mrow><mml:mi>u</mml:mi><mml:mi>n</mml:mi><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mfrac></mml:msqrt><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p></sec><sec id="s2-4-10"><title>Speed optimization</title><p>FrealignX has been optimized for execution on multiple CPU cores. Apart from using optimized library functions for FFT calculation and vector multiplication (Intel Math Kernel Library), the processing speed is also increased by on-the-fly cropping in real and reciprocal space of particle images and 3D reference maps. Real-space cropping reduces the interpolation accuracy in reciprocal space and is therefore limited to global parameter searches that do not require the highest accuracy in the calculation of search projections. Reciprocal-space cropping is used whenever a resolution limit is specified by the user or in an automated refinement (ab-initio 3D reconstruction and auto-refinement). For the calculation of in-plane rotated references, reciprocal-space padding is used to increase the image size four-fold, allowing fast nearest-neighbor resampling in real space with sufficient accuracy to produce rotated images with high fidelity.</p></sec></sec><sec id="s2-5"><title>Ab-initio 3D reconstruction</title><p>Ab-initio reconstruction offers a convenient way to proceed from single particle images to a 3D structure when a suitable reference is not available to initialize 3D reconstruction and refinement. Different ab-initio methods have been described (<xref ref-type="bibr" rid="bib18">Hohn et al., 2007</xref>; <xref ref-type="bibr" rid="bib33">Punjani et al., 2017</xref>; <xref ref-type="bibr" rid="bib34">Reboul et al., 2018</xref>) and <italic>cis</italic>TEM’s implementation follows a strategy published originally by (<xref ref-type="bibr" rid="bib15">Grigorieff, 2016</xref>). It is based on the premise that iterative refinement of a reconstruction initialized with random angular parameters is likely to converge on the correct structure if overfitting is avoided and the refinement proceeds in small steps to reduce the chance of premature convergence onto an incorrect structure. The procedure is implemented as part of <italic>cis</italic>TEM’s GUI and uses FrealignX to perform the refinements and reconstructions.</p><p>After initialization with random angles, <italic>cis</italic>TEM performs a user-specified number of global alignment parameter searches, recalculating the reconstruction after each search and applying an automatic masking procedure to it before the next global search. Similar to 2D classification (see above), only a randomly selected subset of the data is used in each iteration and the resolution limit applied during the search is increased with every iteration. The number of iterations <inline-formula><mml:math id="inf127"><mml:mi>n</mml:mi></mml:math></inline-formula> defaults to 40, the starting and final resolution limits <inline-formula><mml:math id="inf128"><mml:msub><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf129"><mml:msub><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>h</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> default to 20 Å and 8 Å, respectively, and the starting and final percentage of included particles in the reconstruction, <inline-formula><mml:math id="inf130"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf131"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>h</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> default to <inline-formula><mml:math id="inf132"><mml:mrow><mml:mrow><mml:mn>2500</mml:mn><mml:mi>K</mml:mi></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mrow></mml:math></inline-formula> and <inline-formula><mml:math id="inf133"><mml:mrow><mml:mrow><mml:mn>10,000</mml:mn><mml:mi>K</mml:mi></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mrow></mml:math></inline-formula>, respectively (results larger than one are reset to 1), with <inline-formula><mml:math id="inf134"><mml:mi>K</mml:mi></mml:math></inline-formula> the number of 3D classes to be calculated as specified by the user, and <inline-formula><mml:math id="inf135"><mml:mi>N</mml:mi></mml:math></inline-formula> the number of particles in the dataset. If symmetry is applied, <inline-formula><mml:math id="inf136"><mml:mi>N</mml:mi></mml:math></inline-formula> is replaced by <inline-formula><mml:math id="inf137"><mml:mi>N</mml:mi><mml:msub><mml:mrow><mml:mi>O</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>y</mml:mi><mml:mi>m</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> where <inline-formula><mml:math id="inf138"><mml:msub><mml:mrow><mml:mi>O</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>y</mml:mi><mml:mi>m</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the number of asymmetric units present in one particle. The resolution limit is then updated in each iteration <inline-formula><mml:math id="inf139"><mml:mi>l</mml:mi></mml:math></inline-formula> as in <xref ref-type="disp-formula" rid="equ2">Equation (2)</xref>, and the percentage is updated as<disp-formula id="equ24"><mml:math id="m24"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>l</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>f</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>h</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mi>t</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>again resetting results larger than 1 to 1. <italic>cis</italic>TEM actually performs a global search for a percentage <inline-formula><mml:math id="inf140"><mml:mn>3</mml:mn><mml:mi>p</mml:mi></mml:math></inline-formula> of the particle stack, that is, three times as many particles as are included in the reconstructions for each iteration. The particles included in the reconstructions are then chosen to be those with the highest scores as calculated by FrealignX.</p><p>The global alignment parameters are performed using the ‘general’ FrealignX procedure with the following changes. Firstly, the <inline-formula><mml:math id="inf141"><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula> is not directly estimated from the FSC calculated at each round. Instead, for the first three iterations, a default <inline-formula><mml:math id="inf142"><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula> is calculated based on the molecular weight. From the fourth iteration onwards, the <inline-formula><mml:math id="inf143"><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula> is calculated from the FSC, however if the calculated <inline-formula><mml:math id="inf144"><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula> is higher than the default <inline-formula><mml:math id="inf145"><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula>, the default <inline-formula><mml:math id="inf146"><mml:mi>P</mml:mi><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:mi>R</mml:mi></mml:math></inline-formula> is taken instead. This is done in order to avoid some of the overfitting that will occur during refinement. Secondly, during a normal global search the top <inline-formula><mml:math id="inf147"><mml:mi>h</mml:mi></mml:math></inline-formula> (where <inline-formula><mml:math id="inf148"><mml:mi>h</mml:mi></mml:math></inline-formula> defaults to 20) results of the grid search are locally refined, and the best locally refined result is taken. In the ab-initio procedure, however, the result of the global search for a given particle image is taken randomly from all results that have a score which lies in the top 15% of the difference between the worst score and the best score.</p><p>During the reconstruction steps, the calculated <inline-formula><mml:math id="inf149"><mml:mi>σ</mml:mi></mml:math></inline-formula> for each particle is reset to 1 prior to 3D reconstruction and score weighting is disabled. This is done because the <inline-formula><mml:math id="inf150"><mml:mi>σ</mml:mi></mml:math></inline-formula> and score values are not meaningful until an approximately correct solution is obtained.</p><p>The reconstructions are automatically masked before each new refinement iteration to suppress noise features that could otherwise be amplified in subsequent iterations. The same masking procedure is also applied during auto-refinement (see below). It starts by calculating the density average <inline-formula><mml:math id="inf151"><mml:mover accent="true"><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:math></inline-formula> of the reconstruction and resetting all voxel values below <inline-formula><mml:math id="inf152"><mml:mover accent="true"><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:math></inline-formula> to <inline-formula><mml:math id="inf153"><mml:mover accent="true"><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:math></inline-formula>. This thresholded reconstruction is then low-pass filtered at 50 Å resolution and turned into a binary mask by setting densities equal or below a given threshold <inline-formula><mml:math id="inf154"><mml:mi>t</mml:mi></mml:math></inline-formula> to zero and all others to 1. The threshold is calculated as<disp-formula id="equ25"><label>(22)</label><mml:math id="m25"><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mn>0.03</mml:mn><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">x</mml:mi><mml:mo>⁡</mml:mo><mml:mo>_</mml:mo><mml:mn>500</mml:mn></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math></disp-formula>where <inline-formula><mml:math id="inf155"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the density average of the low-pass filtered map and <inline-formula><mml:math id="inf156"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">x</mml:mi><mml:mo>⁡</mml:mo><mml:mo>_</mml:mo><mml:mn>500</mml:mn></mml:mrow></mml:msub></mml:math></inline-formula> is the average of the 500 highest values in the filtered map. The largest contiguous volume in this binarized map is then identified and used as a mask for the original thresholded reconstruction, such that all voxels outside of this mask will be set to <inline-formula><mml:math id="inf157"><mml:mover accent="true"><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:math></inline-formula>. Finally, a spherical mask, centered in the reconstruction box, is applied by resetting all densities outside the mask to zero.</p><p>The user has the option to repeat the ab-initio procedure multiple times using the result from the previous run as the starting map in each new run, to increase the convergence radius if necessary. In the case of symmetric particles, the default behavior is to perform the first 2/3<sup>rds</sup> of the iterations without applying symmetry. The non-symmetrized map is then aligned to the expected symmetry axes and the final 1/3<sup>rd</sup> of the iterations are carried out with the symmetry applied. This default behavior can be changed by the user such that symmetry is always applied, or is never applied.</p><p>Alignment of the model to the symmetry axes is achieved using the following process. A brute force grid search over rotations around the x, y and z axes is set up. At each position on the grid the 3D map is rotated using the current x, y and z parameters, and then its projection along Euler angle (0, 0, 0) is calculated. All of the symmetry-related projections are then also calculated, and for each one a cross-correlation map is calculated using the original projection as a reference, and the peak within this map is found. The sum of all peaks from all symmetry-related directions is taken and the x,y,z rotation that most closely aligns the original 3D map along the symmetry axes should provide the highest peak sum. To improve robustness, this process is repeated for two additional angles (−45,–45, −45 and 15, 70,–15) that were chosen with the aim of including different-looking areas when the map to be aligned is unusual in some way. The x,y,z rotation that results in the largest sum of all peaks, over all three angles, is taken as the final rotation result. Shifts for this rotation are then calculated based on the found 2D x,y shifts between the initial and symmetry-related projections, with the z shift being set to 0 for C symmetries. The symmetry alignment is also included as a command-line program, which can be used to align a volume to the symmetry axis when the ab-initio is carried out in C1 only, or when using a reference obtained by some other means.</p></sec><sec id="s2-6"><title>Automatic refinement</title><p>Like ab-initio 3D reconstruction, auto-refinement makes use of randomly selected subsets of the data and of an increasing resolution limit as refinement proceeds. However, unlike the ab-initio procedure, the percentage of particles <inline-formula><mml:math id="inf158"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and the resolution limit <inline-formula><mml:math id="inf159"><mml:msub><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> used in iteration <inline-formula><mml:math id="inf160"><mml:mi>l</mml:mi></mml:math></inline-formula> depend on the resolution of the reconstructions estimated in iteration <inline-formula><mml:math id="inf161"><mml:mi>l</mml:mi><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:math></inline-formula>. When the estimated resolution improved in the previous cycle,<disp-formula id="equ26"><label>(23)</label><mml:math id="m26"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mtext>max</mml:mtext><mml:mfenced close="]" open="[" separators="|"><mml:mrow><mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math></disp-formula>with<disp-formula id="equ27"><label>(24)</label><mml:math id="m27"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>R</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mn>8000</mml:mn><mml:msup><mml:mrow><mml:mi>K</mml:mi><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mrow><mml:mn>75</mml:mn></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:msubsup><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mrow></mml:mrow></mml:msup></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf162"><mml:mi>K</mml:mi></mml:math></inline-formula> is the number of 3D classes to be calculated and <inline-formula><mml:math id="inf163"><mml:mi>N</mml:mi></mml:math></inline-formula> the number of particles in the dataset. As before, if the particle has symmetry, <inline-formula><mml:math id="inf164"><mml:mi>N</mml:mi></mml:math></inline-formula> is replaced by <inline-formula><mml:math id="inf165"><mml:mi>N</mml:mi><mml:msub><mml:mrow><mml:mi>O</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>y</mml:mi><mml:mi>m</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> where <inline-formula><mml:math id="inf166"><mml:msub><mml:mrow><mml:mi>O</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>y</mml:mi><mml:mi>m</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the number of asymmetric units present in one particle. If the calculated <inline-formula><mml:math id="inf167"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> exceeds 1, it is reset to 1. The resolution limit is estimated as<disp-formula id="equ28"><label>(25)</label><mml:math id="m28"><mml:mi>R</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mn>0.5</mml:mn></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>s</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf168"><mml:msub><mml:mrow><mml:mi>F</mml:mi><mml:mi>S</mml:mi><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mn>0.5</mml:mn></mml:mrow></mml:msub></mml:math></inline-formula> is the point at which the FSC, unadjusted for the solvent within the mask (see above) crosses the 0.5 threshold and <inline-formula><mml:math id="inf169"><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>s</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the user-specified diameter of the spherical mask applied to the 3D reference at the beginning of each iteration, and to the half-maps used to calculate the FSC. The term <inline-formula><mml:math id="inf170"><mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>s</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></inline-formula> accounts for correlations between the two half-maps due to the masking (see above). When the resolution did not improve in the previous iteration,<disp-formula id="equ29"><label>(26)</label><mml:math id="m29"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mn>1.5</mml:mn><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:math></disp-formula></p><p>(reset to one if resulting in a value larger than 1). At least five refinement iterations are run and refinement stops when <inline-formula><mml:math id="inf171"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> reaches 1 (all particles are included) and there was no improvement in the estimated resolution for the last three iterations.</p><p>If multiple classes are refined, the resolution limit in <xref ref-type="disp-formula" rid="equ28">Equation (25)</xref> is set independently for each class, however the highest resolution used for classification is fixed at 8 Å. At least nine iterations are run and refinement stops when <inline-formula><mml:math id="inf172"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> reaches 1, the average change in the particle occupancy in the last cycle was 1% or less, and there was no improvement in the estimated resolution for the last three iterations.</p><p>In a similar manner to the ab-initio procedure, <inline-formula><mml:math id="inf173"><mml:mi>σ</mml:mi></mml:math></inline-formula> values for each particle are set to one and score weighting is turned off. This is done until the refinement resolution is better than 7 Å, at which point it is assumed the model is of a reasonable quality.</p></sec><sec id="s2-7"><title>Map sharpening</title><p>Most single-particle reconstructions require some degree of sharpening that is usually achieved by applying a negative B-factor to the map. <italic>cis</italic>TEM includes a map sharpening tool that allows the application of an arbitrary B-factor. Additionally, maps can be sharpened by whitening the power spectrum of the reconstruction beyond a user-specified resolution (the default is 8 Å). The whitening amplifies terms at higher resolution similar to a negative B-factor but avoids the over-amplification at the high-resolution end of the spectrum that sometimes occurs with the B-factor method due to its exponential behavior. Whitening is applied after masking of the map, either with a hollow spherical mask of defined inner and outer radius, or with a user-defined mask supplied as a separate 3D volume. The masking removes background noise and makes the whitening of the particle density more accurate. Both methods can be combined in <italic>cis</italic>TEM, together with a resolution limit imposed on the final reconstruction. The whitened and B-factor-sharpened map can optionally be filtered with a figure-of-merit curve calculated using the FSC determined for the reconstruction (<xref ref-type="bibr" rid="bib37">Rosenthal and Henderson, 2003</xref>; <xref ref-type="bibr" rid="bib44">Sindelar and Grigorieff, 2012</xref>).</p></sec><sec id="s2-8"><title>GUI design and workflow</title><p><italic>cis</italic>TEM’s GUI required extensive development because it is an integral part of the processing pipeline. GUIs have become more commonplace in cryo-EM software tools to make them more accessible to users (<xref ref-type="bibr" rid="bib7">Conesa Mingo et al., 2018</xref>; <xref ref-type="bibr" rid="bib9">Desfosses et al., 2014</xref>; <xref ref-type="bibr" rid="bib30">Moriya et al., 2017</xref>; <xref ref-type="bibr" rid="bib33">Punjani et al., 2017</xref>; <xref ref-type="bibr" rid="bib40">Scheres, 2012</xref>; <xref ref-type="bibr" rid="bib48">Tang et al., 2007</xref>). Many of the interfaces are designed as so-called wrappers of command-line driven tools, i.e. they take user input and translate it into a command line that launches the tool. Feedback to the user takes place by checking output files, which are also the main repository of processing results, such as movie frame alignments, image defocus measurements and particle alignment parameters. As processing strategies become more complex and the number of users new to cryo-EM grows, the demands on the GUI increase in the quest for obtaining the best possible results. Useful GUI functions include guided user input (so-called wizards) that adjust to specific situations, graphical presentation of relevant results, user interaction with running processes to allow early intervention and make adjustments, tools to manipulate data (e.g. masking), implementation of higher-level procedures that combine more primitive processing steps to achieve specific goals, and a global searchable database that keeps track of all processing steps and result. While some of these functions can be or have been implemented in wrapper GUIs, the lack of control of these GUIs over the data and processes makes a reliable implementation more difficult. For example, keeping track of results from multiple processing steps, some of them perhaps repeated with different parameters or run many times during an iterative refinement, can become challenging if each step produces a separate results file. Communicating with running processes via files can be slow and is sometimes unreliable due to file system caching. Communication via files may complicate the implementation of higher-level procedures, which rely on the parsing of results from the more primitive processing steps.</p><p>The <italic>cis</italic>TEM GUI is more than a wrapper as it implements some of the new algorithms in the processing pipeline directly, adjusting the input of running jobs as the refinement proceeds. It enables more complex data processing strategies by tracking all results in a single searchable database. All processing steps are run and controlled by the GUI, which communicates with master and slave processes through TCP/IP. <italic>cis</italic>TEM uses an SQL database, similar to Appion (<xref ref-type="bibr" rid="bib21">Lander et al., 2009</xref>), to store all results (except image files), offers input functions that guide the user or set appropriate defaults, and implements more complex procedures to automate processing where possible. <italic>cis</italic>TEM’s design is flexible to allow execution in many different environments, including single workstations, multiple networked workstations and large computer clusters.</p><p>User input and the display of results is organized into different panels that make up <italic>cis</italic>TEM’s GUI, each panel dedicated to specific processing steps (for examples, see <xref ref-type="fig" rid="fig1">Figures 1</xref>, <xref ref-type="fig" rid="fig3">3</xref> and <xref ref-type="fig" rid="fig4">4</xref>). This design guides users through a standard workflow that most single particle projects follow: movie alignment, CTF determination, particle picking, 2D classification, 3D reconstruction, refinement and classification, and sharpening of the final reconstructions. Three types of panels exist, dealing with Assets, Actions and Results. Assets are mostly data that can be used in processing steps called Actions. They include Movies, Images, Particle Positions and Volumes. One type of Asset, a Refinement Package, defines the data and parameters necessary to carry out refinement of a 3D structure (or a set of structures if 3D classification is done), it contains a particle stack, as well as information about the sample (e.g. particle size and molecular weight) along with parameters for each particle (e.g. orientations and defocus values). Actions comprise the above mentioned workflow steps, with additional options for ab-initio 3D reconstruction, as well as automatic and manual 3D refinement to enable users to obtain the best possible results from their data. The results of most of these Actions are stored in the database and can be viewed in the related Results panels, which display relevant data necessary to evaluate the success of each processing step. The option to sort and select results by a number of different metrics is available in the movie alignment and CTF estimation Results panels. For example images can be sorted/selected based on the CTF fit resolution (<xref ref-type="bibr" rid="bib35">Rohou and Grigorieff, 2015</xref>). Movie alignment, 3D refinement and reconstruction also produce new Image and Volume Assets, respectively.</p><p>Importing or generating new Assets is accomplished by wizards that solicit the necessary user input and perform checks were possible to avoid nonsensical input. In the more complex case of creating a new Refinement Package Asset, the wizard allows the specification of input data, for example based on particle picking results or the selection of 2D and 3D classes. Once an Action has been launched, results are displayed as soon as they become available, together with an overall progress bar, giving users an estimate of how long a processing step will take and of whether the results are as expected. If desired, an Action can be aborted and restarted with a different set of parameters, or the Action can be run again after regular termination to test different parameters. In the latter case, all prior results remain accessible and users can specify those to be used for the next step in the workflow. This provides users with the flexibility to pick and choose the best results in cases where different parts of a dataset require different settings to yield optimal results.</p></sec><sec id="s2-9"><title>Parallelization</title><p><italic>cis</italic>TEM uses a home-grown scheme to accelerate processing in parallel environments. Image processing of single-particle data is an embarrassingly parallel problem, i.e. the parallelization of most tasks can be achieved simply by dividing the data to be processed into smaller chunks that are each processed by a separate program thread, without the need for inter-process communication. Only certain steps require merging of data, such as the calculation of a 3D reconstruction from the entire dataset. <italic>cis</italic>TEM parallelizes processing steps by running multiple instances of the same program, each dealing with a subset of the data, then directly communicating with the launched processes over TCP/IP sockets. This enables the <italic>cis</italic>TEM GUI to distribute jobs and receive results in real time. Communication is directed through a ‘manager’ process, which enables jobs to be run on a cluster, while the GUI itself can run on a local workstation.</p><p>How each copy of the program is run is specified by the user by setting up a ‘Run Profile’. This profile is a user defined command, or script that will be run to launch the job, and is designed to be flexible to enable the user to set up parallelization in many different environments. For example, users can design profiles to run on multiple machines via SSH, or to submit to a cluster (e.g. using qsub) etc., or even merge the two in a single profile. One disadvantage of this system is that it may be difficult to create profiles for clusters that require many jobs to be submitted using one command.</p><p>Another advantage of using a home-grown scheme over existing schemes (e.g. MPI) occurs when jobs are run on a multi-node computing cluster. In this case, jobs will complete even if the full number of requested processors is not available. For example, if a user requests 300 CPUs for a processing step but only 100 are available, <italic>cis</italic>TEM launches 300 jobs of which 200 will remain in the job scheduler’s queue. Data processing starts immediately with the 100 jobs that are allowed to run and will complete even if the remaining jobs never run. In such a scenario, an MPI-based job could only run when 300 CPUs become available, potentially delaying execution. In the few cases were a step requires merging of an entire dataset, for example in a 3D reconstruction, parallelization is achieved by calculating multiple intermediate 3D reconstructions for subsets of the data, dumping the intermediate reconstructions to disk and merging them after all reconstruction jobs have finished. It can therefore help to designate a fast disk as a scratch disk to allow rapid dumping and reading of the relatively large files (200 MB – 5 GB).</p></sec><sec id="s2-10"><title>Benchmarking with β-galactosidase</title><p>A high-resolution dataset of β-galactosidase (<xref ref-type="bibr" rid="bib3">Bartesaghi et al., 2015</xref>) was used to benchmark Relion 2 (<xref ref-type="bibr" rid="bib20">Kimanius et al., 2016</xref>) and is also used here to illustrate the workflow of <italic>cis</italic>TEM and assess the time for the completion of different processing steps. The entire dataset was downloaded from the EMPIAR database (<xref ref-type="bibr" rid="bib19">Iudin et al., 2016</xref>) and consists of 1539 movies containing 38 frames, recorded at super-resolution on a K2 Summit camera (Gatan, Inc., Pleasanton, CA) and stored locally as tif files using LZW compression (the conversion to tiff and compression was performed by mrc2tif (<xref ref-type="bibr" rid="bib24">Mastronarde and Held, 2017</xref>)). The pixel size of the super-resolution frames was 0.3185 Å, and images were binned to a pixel size of 0.75 Å after movie processing. For 2D classification and ab-initio 3D reconstruction, particles were boxed using 384 × 384 pixel boxes. For auto- and manual refinement, the particles were re-boxed into 648 × 648 pixel boxes (boxing is part of the creation of Refinement Packages, see above). For all processing steps, a Dell Precision T7910 workstation containing two E5-2699 v4 Xeon processors with a total of 44 cores was used. Processing parameters were left on default settings except for CTF determination, which was performed at 3.5 Å resolution using the movie averages instead of the frames, and particle picking, which used optimized parameters based on previewing a few selected images (<xref ref-type="fig" rid="fig3">Figure 3</xref>). The resolution limit during refinement (auto, manual and CTF) never exceeded 3.1 Å. The data were stored on a local SSD Raid 0 disk for fast access. <xref ref-type="table" rid="table1">Table 1</xref> lists the timings of the different processing steps using all 44 CPU cores. Results obtained at different points in the workflow are shown in <xref ref-type="fig" rid="fig7">Figure 7</xref>.</p><fig id="fig7" position="float"><object-id pub-id-type="doi">10.7554/eLife.35383.008</object-id><label>Figure 7.</label><caption><title>Processing results of the β-galactosidase dataset (<xref ref-type="bibr" rid="bib3">Bartesaghi et al., 2015</xref>) used to benchmark <italic>cis</italic>TEM.</title><p>(<bold>A</bold>) Different stages of the ab-initio reconstruction procedure, starting from a reconstruction from randomly assigned Euler angles. The process takes less than an hour to complete on a high-end CPU-based workstation. (<bold>B</bold>) High-resolution detail of the refined β-galactosidase reconstruction with an average resolution of 2.2 Å, showing sidechain details for most amino acids. (<bold>C</bold>) FSC plots for the refined β-galactosidase reconstruction. The black curve was calculated using a tight mask applied to the half maps (Masked_FSC). A correction for potential masking artifacts (<xref ref-type="bibr" rid="bib5">Chen et al., 2013</xref>) did not lead to adjustments of this curve. The red curved was calculated with a more generous spherical mask and adjusted for the solvent background within that mask (Part_FSC, <xref ref-type="disp-formula" rid="equ22">Equation (19)</xref>). The resolution limit of 3.1 Å, which was not exceeded during refinement, as well as the FSC = 0.143 threshold are indicated by lines.</p><p><supplementary-material id="fig7sdata1"><object-id pub-id-type="doi">10.7554/eLife.35383.009</object-id><label>Figure 7—source data 1.</label><caption><title>Source data for the curves shown in <xref ref-type="fig" rid="fig7">Figure 7C</xref>.</title></caption><media mime-subtype="plain" mimetype="text" xlink:href="elife-35383-fig7-data1-v2.txt"/></supplementary-material></p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-35383-fig7-v2"/></fig><table-wrap id="table1" position="float"><object-id pub-id-type="doi">10.7554/eLife.35383.010</object-id><label>Table 1.</label><caption><title>Benchmarking of <italic>cis</italic>TEM using a high-resolution dataset of β-galactosidase (<xref ref-type="bibr" rid="bib3">Bartesaghi et al., 2015</xref>).</title></caption><table frame="hsides" rules="groups"><thead><tr><th>Processing step</th><th>Details</th><th>Time (hours)</th></tr></thead><tbody><tr><td>Movie processing</td><td>1539 movies, 38 frames, super-resolution</td><td>1.1</td></tr><tr><td>CTF determination</td><td>Using aligned movie average as input</td><td>0.1</td></tr><tr><td>Particle picking</td><td>131,298 particles</td><td>0.1</td></tr><tr><td>2D classification</td><td>50 classes, 28 selected with 119,523 particles</td><td>0.8</td></tr><tr><td>Ab initio 3D reconstruction</td><td>40 iterations</td><td>0.8</td></tr><tr><td>Auto refinement</td><td>8 iterations, final resolution 2.2 Å</td><td>1.4</td></tr><tr><td>Manual refinement</td><td>1 iteration (incl. defocus), final resolution 2.2 Å</td><td>0.4</td></tr><tr><td>Total</td><td/><td>4.7</td></tr></tbody></table></table-wrap></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>The implementation of a complete image processing workflow in <italic>cis</italic>TEM offers users a uniform experience and guarantees smooth transitions between processing steps. It also helps developers maintain the software as all the tools and algorithms are developed in-house.</p><p>The main focus of <italic>cis</italic>TEM is on the processing of single-particle cryo-EM data and high-resolution 3D reconstruction. Future releases of <italic>cis</italic>TEM may include on-the-fly processing of data as it is collected, particle-based movie alignment, support for helical particles, improved 3D masking tools, more reliable resolution and quality indicators, as well as miscellaneous tools such as the determination of the detective quantum efficiency of electron detectors.</p><p>Since <italic>cis</italic>TEM does not rely on third-party libraries, such as Python, MPI or CUDA, that usually have to be installed and compiled separately on the target system, ready-to-run binaries can be made available for download that are optimized for different architectures. Using the wxWidgets library also means that <italic>cis</italic>TEM can be compiled for different operating systems, including Linux, Windows and OSX. Using a configure script, different options for the fast Fourier transforms (FFTs) can be specified, including the FFTW (<ext-link ext-link-type="uri" xlink:href="http://www.fftw.org">http://www.fftw.org</ext-link>) and Intel MKL (<ext-link ext-link-type="uri" xlink:href="http://software.intel.com/en-us/mkl">http://software.intel.com/en-us/mkl</ext-link>) libraries. The downloadable binaries are statically linked against the MKL library as this exhibits superior speeds compared to the FFTW library on Intel-based CPUs.</p><p>While the lack of support for GPUs simplifies the installation and execution of <italic>cis</italic>TEM, it can also be a limitation on workstations that are optimized for GPU-accelerated code. These workstations often do not have many CPU cores and, therefore, <italic>cis</italic>TEM will run significantly more slowly than code that can take advantage of the GPU hardware. Users who would like to run both CPU and GPU-optimized software may therefore have to invest in both types of hardware.</p></sec><sec id="s4" sec-type="materials|methods"><title>Materials and methods</title><sec id="s4-1"><title>Development of <italic>cis</italic>TEM</title><p>The entire <italic>cis</italic>TEM image processing package was written in C++ using the wxWidgets toolkit (<ext-link ext-link-type="uri" xlink:href="http://wxwidgets.org">http://wxwidgets.org</ext-link>) to implement the GUI, as well as the libtiff library (<ext-link ext-link-type="uri" xlink:href="http://www.libtiff.org">http://www.libtiff.org</ext-link>) to support the tiff image format, the SQLite library (<ext-link ext-link-type="uri" xlink:href="https://sqlite.org">https://sqlite.org</ext-link>) to implement the SQL database, and Intel’s MKL library (<ext-link ext-link-type="uri" xlink:href="http://software.intel.com/en-us/mkl">http://software.intel.com/en-us/mkl</ext-link>) for the calculation of Fourier transforms and vector products. Optionally, <italic>cis</italic>TEM can also be linked against the FFTW library (<ext-link ext-link-type="uri" xlink:href="http://www.fftw.org">http://www.fftw.org</ext-link>) to replace the MKL library. The code was written and edited using Eclipse (<ext-link ext-link-type="uri" xlink:href="http://www.eclipse.org">http://www.eclipse.org</ext-link>), and GitHub (<ext-link ext-link-type="uri" xlink:href="http://github.com">http://github.com</ext-link>) was used for version control. This code is available in <xref ref-type="supplementary-material" rid="scode1">Source code 1</xref>.</p></sec><sec id="s4-2"><title>Benchmark dataset</title><p>The performance of <italic>cis</italic>TEM was benchmarked using a cryo-EM dataset of β-galactosidase (<xref ref-type="bibr" rid="bib3">Bartesaghi et al., 2015</xref>), entry EMPIAR-10061 in the EMPIAR database (<xref ref-type="bibr" rid="bib19">Iudin et al., 2016</xref>).</p></sec><sec id="s4-3"><title>Image and data formats</title><p><italic>cis</italic>TEM stores all image data using the MRC format (<xref ref-type="bibr" rid="bib8">Crowther et al., 1996</xref>). Additionally, particle parameters can be imported from, and exported to Frealign (<xref ref-type="bibr" rid="bib15">Grigorieff, 2016</xref>) and Relion (<xref ref-type="bibr" rid="bib40">Scheres, 2012</xref>).</p></sec></sec></body><back><ack id="ack"><title>Acknowledgements</title><p>The authors are grateful for feedback from early testers of <italic>cis</italic>TEM, including Ruben Diaz-Avalos, Sarah Loerch, Priyanka Abeyrathne, Peter Rickgauer, Ben Himes, Andrei Korostelev, Anna Loveland, Gabriel Demo, Jue Chen, Dmitry Lyumkis, Hiro Furukawa, Wei Lu and Juan Du.</p></ack><sec id="s5" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="COI-statement" id="conf2"><p>Reviewing editor, <italic>eLife</italic></p></fn><fn fn-type="COI-statement" id="conf1"><p>No competing interests declared</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>Conceptualization, Software, Formal analysis, Supervision, Validation, Investigation, Visualization, Methodology, Writing—original draft, Writing—review and editing</p></fn><fn fn-type="con" id="con2"><p>Conceptualization, Software, Formal analysis, Supervision, Validation, Investigation, Visualization, Methodology, Writing—original draft, Writing—review and editing</p></fn><fn fn-type="con" id="con3"><p>Conceptualization, Software, Formal analysis, Supervision, Funding acquisition, Validation, Investigation, Visualization, Methodology, Writing—original draft, Project administration, Writing—review and editing</p></fn></fn-group></sec><sec id="s6" sec-type="supplementary-material"><title>Additional files</title><supplementary-material id="scode1"><object-id pub-id-type="doi">10.7554/eLife.35383.011</object-id><label>Source code 1.</label><caption><title>Source code for <italic>cis</italic>TEM 1.0 beta.</title></caption><media mime-subtype="x-gzip" mimetype="application" xlink:href="elife-35383-code1-v2.gz"/></supplementary-material><supplementary-material id="transrepform"><object-id pub-id-type="doi">10.7554/eLife.35383.012</object-id><label>Transparent reporting form</label><media mime-subtype="docx" mimetype="application" xlink:href="elife-35383-transrepform-v2.docx"/></supplementary-material><sec id="s7" sec-type="datasets"><title>Major datasets</title><p>The following previously published dataset was used:</p><p><related-object content-type="generated-dataset" id="dataset1" source-id="https://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10061" source-id-type="uri"><collab collab-type="author">Bartesaghi A</collab><collab collab-type="author">Merk A</collab><collab collab-type="author">Banerjee S</collab><collab collab-type="author">Matthies D</collab><collab collab-type="author">Wu X</collab><collab collab-type="author">Milne JL</collab><collab collab-type="author">Subramaniam S</collab><year>2015</year><source>2.2 A resolution cryo-EM structure of beta-galactosidase in complex with a cell-permeant inhibitor</source><ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10061">https://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10061</ext-link><comment>Publicly available at the Electron Microscopy Public Image Archive (accession no. 10061)</comment></related-object></p></sec></sec><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Abeyrathne</surname> <given-names>PD</given-names></name><name><surname>Koh</surname> <given-names>CS</given-names></name><name><surname>Grant</surname> <given-names>T</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name><name><surname>Korostelev</surname> <given-names>AA</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Ensemble cryo-EM uncovers inchworm-like translocation of a viral IRES through the ribosome</article-title><source>eLife</source><volume>5</volume><elocation-id>e14874</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.14874</pub-id><pub-id pub-id-type="pmid">27159452</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bartesaghi</surname> <given-names>A</given-names></name><name><surname>Matthies</surname> <given-names>D</given-names></name><name><surname>Banerjee</surname> <given-names>S</given-names></name><name><surname>Merk</surname> <given-names>A</given-names></name><name><surname>Subramaniam</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Structure of β-galactosidase at 3.2-Å resolution obtained by cryo-electron microscopy</article-title><source>PNAS</source><volume>111</volume><fpage>11709</fpage><lpage>11714</lpage><pub-id pub-id-type="doi">10.1073/pnas.1402809111</pub-id><pub-id pub-id-type="pmid">25071206</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bartesaghi</surname> <given-names>A</given-names></name><name><surname>Merk</surname> <given-names>A</given-names></name><name><surname>Banerjee</surname> <given-names>S</given-names></name><name><surname>Matthies</surname> <given-names>D</given-names></name><name><surname>Wu</surname> <given-names>X</given-names></name><name><surname>Milne</surname> <given-names>JL</given-names></name><name><surname>Subramaniam</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>2.2 A resolution cryo-EM structure of β-galactosidase in complex with a cell-permeant inhibitor</article-title><source>Science</source><volume>348</volume><fpage>1147</fpage><lpage>1151</lpage><pub-id pub-id-type="doi">10.1126/science.aab1576</pub-id><pub-id pub-id-type="pmid">25953817</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname> <given-names>JZ</given-names></name><name><surname>Settembre</surname> <given-names>EC</given-names></name><name><surname>Aoki</surname> <given-names>ST</given-names></name><name><surname>Zhang</surname> <given-names>X</given-names></name><name><surname>Bellamy</surname> <given-names>AR</given-names></name><name><surname>Dormitzer</surname> <given-names>PR</given-names></name><name><surname>Harrison</surname> <given-names>SC</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Molecular interactions in rotavirus assembly and uncoating seen by high-resolution cryo-EM</article-title><source>PNAS</source><volume>106</volume><fpage>10644</fpage><lpage>10648</lpage><pub-id pub-id-type="doi">10.1073/pnas.0904024106</pub-id><pub-id pub-id-type="pmid">19487668</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname> <given-names>S</given-names></name><name><surname>McMullan</surname> <given-names>G</given-names></name><name><surname>Faruqi</surname> <given-names>AR</given-names></name><name><surname>Murshudov</surname> <given-names>GN</given-names></name><name><surname>Short</surname> <given-names>JM</given-names></name><name><surname>Scheres</surname> <given-names>SH</given-names></name><name><surname>Henderson</surname> <given-names>R</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>High-resolution noise substitution to measure overfitting and validate resolution in 3D structure determination by single particle electron cryomicroscopy</article-title><source>Ultramicroscopy</source><volume>135</volume><fpage>24</fpage><lpage>35</lpage><pub-id pub-id-type="doi">10.1016/j.ultramic.2013.06.004</pub-id><pub-id pub-id-type="pmid">23872039</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cheng</surname> <given-names>Y</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name><name><surname>Penczek</surname> <given-names>PA</given-names></name><name><surname>Walz</surname> <given-names>T</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>A primer to single-particle cryo-electron microscopy</article-title><source>Cell</source><volume>161</volume><fpage>438</fpage><lpage>449</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2015.03.050</pub-id><pub-id pub-id-type="pmid">25910204</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Conesa Mingo</surname> <given-names>P</given-names></name><name><surname>Gutierrez</surname> <given-names>J</given-names></name><name><surname>Quintana</surname> <given-names>A</given-names></name><name><surname>de la Rosa Trevín</surname> <given-names>JM</given-names></name><name><surname>Zaldívar-Peraza</surname> <given-names>A</given-names></name><name><surname>Cuenca Alba</surname> <given-names>J</given-names></name><name><surname>Kazemi</surname> <given-names>M</given-names></name><name><surname>Vargas</surname> <given-names>J</given-names></name><name><surname>Del Cano</surname> <given-names>L</given-names></name><name><surname>Segura</surname> <given-names>J</given-names></name><name><surname>Sorzano</surname> <given-names>COS</given-names></name><name><surname>Carazo</surname> <given-names>JM</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Scipion web tools: Easy to use cryo-EM image processing over the web</article-title><source>Protein Science</source><volume>27</volume><fpage>269</fpage><lpage>275</lpage><pub-id pub-id-type="doi">10.1002/pro.3315</pub-id><pub-id pub-id-type="pmid">28971542</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Crowther</surname> <given-names>RA</given-names></name><name><surname>Henderson</surname> <given-names>R</given-names></name><name><surname>Smith</surname> <given-names>JM</given-names></name></person-group><year iso-8601-date="1996">1996</year><article-title>MRC image processing programs</article-title><source>Journal of Structural Biology</source><volume>116</volume><fpage>9</fpage><lpage>16</lpage><pub-id pub-id-type="doi">10.1006/jsbi.1996.0003</pub-id><pub-id pub-id-type="pmid">8742717</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Desfosses</surname> <given-names>A</given-names></name><name><surname>Ciuffa</surname> <given-names>R</given-names></name><name><surname>Gutsche</surname> <given-names>I</given-names></name><name><surname>Sachse</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>SPRING - an image processing package for single-particle based helical reconstruction from electron cryomicrographs</article-title><source>Journal of Structural Biology</source><volume>185</volume><fpage>15</fpage><lpage>26</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2013.11.003</pub-id><pub-id pub-id-type="pmid">24269218</pub-id></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Frank</surname> <given-names>J</given-names></name><name><surname>Radermacher</surname> <given-names>M</given-names></name><name><surname>Penczek</surname> <given-names>P</given-names></name><name><surname>Zhu</surname> <given-names>J</given-names></name><name><surname>Li</surname> <given-names>Y</given-names></name><name><surname>Ladjadj</surname> <given-names>M</given-names></name><name><surname>Leith</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="1996">1996</year><article-title>SPIDER and WEB: processing and visualization of images in 3D electron microscopy and related fields</article-title><source>Journal of Structural Biology</source><volume>116</volume><fpage>190</fpage><lpage>199</lpage><pub-id pub-id-type="doi">10.1006/jsbi.1996.0030</pub-id><pub-id pub-id-type="pmid">8742743</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Grant</surname> <given-names>T</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2015">2015a</year><article-title>Automatic estimation and correction of anisotropic magnification distortion in electron microscopes</article-title><source>Journal of Structural Biology</source><volume>192</volume><fpage>204</fpage><lpage>208</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2015.08.006</pub-id><pub-id pub-id-type="pmid">26278979</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Grant</surname> <given-names>T</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2015">2015b</year><article-title>Measuring the optimal exposure for single particle cryo-EM using a 2.6 Å reconstruction of rotavirus VP6</article-title><source>eLife</source><volume>4</volume><elocation-id>e06980</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.06980</pub-id><pub-id pub-id-type="pmid">26023829</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2000">2000</year><article-title>Resolution measurement in structures derived from single particles</article-title><source>Acta Crystallographica Section D Biological Crystallography</source><volume>56</volume><fpage>1270</fpage><lpage>1277</lpage><pub-id pub-id-type="doi">10.1107/S0907444900009549</pub-id><pub-id pub-id-type="pmid">10998623</pub-id></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>FREALIGN: high-resolution refinement of single particle structures</article-title><source>Journal of Structural Biology</source><volume>157</volume><fpage>117</fpage><lpage>125</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2006.05.004</pub-id><pub-id pub-id-type="pmid">16828314</pub-id></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Frealign: An exploratory tool for single-particle Cryo-EM</article-title><source>Methods in enzymology</source><volume>579</volume><fpage>191</fpage><lpage>226</lpage><pub-id pub-id-type="doi">10.1016/bs.mie.2016.04.013</pub-id><pub-id pub-id-type="pmid">27572728</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Harauz</surname> <given-names>G</given-names></name><name><surname>van Heel</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="1986">1986</year><article-title>Exact filters for general geometry 3-dimensional reconstruction</article-title><source>Optik</source><volume>73</volume><fpage>146</fpage><lpage>156</lpage></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Henderson</surname> <given-names>R</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Avoiding the pitfalls of single particle cryo-electron microscopy: Einstein from noise</article-title><source>PNAS</source><volume>110</volume><fpage>18037</fpage><lpage>18041</lpage><pub-id pub-id-type="doi">10.1073/pnas.1314449110</pub-id><pub-id pub-id-type="pmid">24106306</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hohn</surname> <given-names>M</given-names></name><name><surname>Tang</surname> <given-names>G</given-names></name><name><surname>Goodyear</surname> <given-names>G</given-names></name><name><surname>Baldwin</surname> <given-names>PR</given-names></name><name><surname>Huang</surname> <given-names>Z</given-names></name><name><surname>Penczek</surname> <given-names>PA</given-names></name><name><surname>Yang</surname> <given-names>C</given-names></name><name><surname>Glaeser</surname> <given-names>RM</given-names></name><name><surname>Adams</surname> <given-names>PD</given-names></name><name><surname>Ludtke</surname> <given-names>SJ</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>SPARX, a new environment for Cryo-EM image processing</article-title><source>Journal of Structural Biology</source><volume>157</volume><fpage>47</fpage><lpage>55</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2006.07.003</pub-id><pub-id pub-id-type="pmid">16931051</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Iudin</surname> <given-names>A</given-names></name><name><surname>Korir</surname> <given-names>PK</given-names></name><name><surname>Salavert-Torres</surname> <given-names>J</given-names></name><name><surname>Kleywegt</surname> <given-names>GJ</given-names></name><name><surname>Patwardhan</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>EMPIAR: a public archive for raw electron microscopy image data</article-title><source>Nature Methods</source><volume>13</volume><fpage>387</fpage><lpage>388</lpage><pub-id pub-id-type="doi">10.1038/nmeth.3806</pub-id><pub-id pub-id-type="pmid">27067018</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kimanius</surname> <given-names>D</given-names></name><name><surname>Forsberg</surname> <given-names>BO</given-names></name><name><surname>Scheres</surname> <given-names>SH</given-names></name><name><surname>Lindahl</surname> <given-names>E</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Accelerated cryo-EM structure determination with parallelisation using GPUs in RELION-2</article-title><source>eLife</source><volume>5</volume><elocation-id>e18722</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.18722</pub-id><pub-id pub-id-type="pmid">27845625</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lander</surname> <given-names>GC</given-names></name><name><surname>Stagg</surname> <given-names>SM</given-names></name><name><surname>Voss</surname> <given-names>NR</given-names></name><name><surname>Cheng</surname> <given-names>A</given-names></name><name><surname>Fellmann</surname> <given-names>D</given-names></name><name><surname>Pulokas</surname> <given-names>J</given-names></name><name><surname>Yoshioka</surname> <given-names>C</given-names></name><name><surname>Irving</surname> <given-names>C</given-names></name><name><surname>Mulder</surname> <given-names>A</given-names></name><name><surname>Lau</surname> <given-names>PW</given-names></name><name><surname>Lyumkis</surname> <given-names>D</given-names></name><name><surname>Potter</surname> <given-names>CS</given-names></name><name><surname>Carragher</surname> <given-names>B</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Appion: an integrated, database-driven pipeline to facilitate EM image processing</article-title><source>Journal of Structural Biology</source><volume>166</volume><fpage>95</fpage><lpage>102</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2009.01.002</pub-id><pub-id pub-id-type="pmid">19263523</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Loveland</surname> <given-names>AB</given-names></name><name><surname>Demo</surname> <given-names>G</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name><name><surname>Korostelev</surname> <given-names>AA</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Ensemble cryo-EM elucidates the mechanism of translation fidelity</article-title><source>Nature</source><volume>546</volume><fpage>113</fpage><lpage>117</lpage><pub-id pub-id-type="doi">10.1038/nature22397</pub-id><pub-id pub-id-type="pmid">28538735</pub-id></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lyumkis</surname> <given-names>D</given-names></name><name><surname>Brilot</surname> <given-names>AF</given-names></name><name><surname>Theobald</surname> <given-names>DL</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Likelihood-based classification of cryo-EM images using FREALIGN</article-title><source>Journal of Structural Biology</source><volume>183</volume><fpage>377</fpage><lpage>388</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2013.07.005</pub-id><pub-id pub-id-type="pmid">23872434</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mastronarde</surname> <given-names>DN</given-names></name><name><surname>Held</surname> <given-names>SR</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Automated tilt series alignment and tomographic reconstruction in IMOD</article-title><source>Journal of Structural Biology</source><volume>197</volume><fpage>102</fpage><lpage>113</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2016.07.011</pub-id><pub-id pub-id-type="pmid">27444392</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Matthews</surname> <given-names>BW</given-names></name></person-group><year iso-8601-date="1968">1968</year><article-title>Solvent content of protein crystals</article-title><source>Journal of Molecular Biology</source><volume>33</volume><fpage>491</fpage><lpage>497</lpage><pub-id pub-id-type="doi">10.1016/0022-2836(68)90205-2</pub-id><pub-id pub-id-type="pmid">5700707</pub-id></element-citation></ref><ref id="bib26"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>McDonough</surname> <given-names>RN</given-names></name></person-group><person-group person-group-type="author"><name><surname>Whalen</surname> <given-names>AD</given-names></name></person-group><year iso-8601-date="1995">1995</year><source>Detection of Signals in Noise</source><edition>2nd edn</edition><publisher-loc>San Diego</publisher-loc><publisher-name>Academic Press</publisher-name></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McMullan</surname> <given-names>G</given-names></name><name><surname>Faruqi</surname> <given-names>AR</given-names></name><name><surname>Henderson</surname> <given-names>R</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Direct electron detectors</article-title><source>Methods in Enzymology</source><volume>579</volume><fpage>1</fpage><lpage>17</lpage><pub-id pub-id-type="doi">10.1016/bs.mie.2016.05.056</pub-id><pub-id pub-id-type="pmid">27572721</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>McMullan</surname> <given-names>G</given-names></name><name><surname>Vinothkumar</surname> <given-names>KR</given-names></name><name><surname>Henderson</surname> <given-names>R</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Thon rings from amorphous ice and implications of beam-induced Brownian motion in single particle electron cryo-microscopy</article-title><source>Ultramicroscopy</source><volume>158</volume><fpage>26</fpage><lpage>32</lpage><pub-id pub-id-type="doi">10.1016/j.ultramic.2015.05.017</pub-id><pub-id pub-id-type="pmid">26103047</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mindell</surname> <given-names>JA</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Accurate determination of local defocus and specimen tilt in electron microscopy</article-title><source>Journal of Structural Biology</source><volume>142</volume><fpage>334</fpage><lpage>347</lpage><pub-id pub-id-type="doi">10.1016/S1047-8477(03)00069-8</pub-id><pub-id pub-id-type="pmid">12781660</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Moriya</surname> <given-names>T</given-names></name><name><surname>Saur</surname> <given-names>M</given-names></name><name><surname>Stabrin</surname> <given-names>M</given-names></name><name><surname>Merino</surname> <given-names>F</given-names></name><name><surname>Voicu</surname> <given-names>H</given-names></name><name><surname>Huang</surname> <given-names>Z</given-names></name><name><surname>Penczek</surname> <given-names>PA</given-names></name><name><surname>Raunser</surname> <given-names>S</given-names></name><name><surname>Gatsogiannis</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>High-resolution single particle analysis from electron cryo-microscopy images using SPHIRE</article-title><source>Journal of Visualized Experiments</source><pub-id pub-id-type="doi">10.3791/55448</pub-id><pub-id pub-id-type="pmid">28570515</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Oldham</surname> <given-names>ML</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name><name><surname>Chen</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Structure of the transporter associated with antigen processing trapped by herpes simplex virus</article-title><source>eLife</source><volume>5</volume><elocation-id>e21829</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.21829</pub-id><pub-id pub-id-type="pmid">27935481</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Penczek</surname> <given-names>PA</given-names></name><name><surname>Fang</surname> <given-names>J</given-names></name><name><surname>Li</surname> <given-names>X</given-names></name><name><surname>Cheng</surname> <given-names>Y</given-names></name><name><surname>Loerke</surname> <given-names>J</given-names></name><name><surname>Spahn</surname> <given-names>CM</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>CTER-rapid estimation of CTF parameters with error assessment</article-title><source>Ultramicroscopy</source><volume>140</volume><fpage>9</fpage><lpage>19</lpage><pub-id pub-id-type="doi">10.1016/j.ultramic.2014.01.009</pub-id><pub-id pub-id-type="pmid">24562077</pub-id></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Punjani</surname> <given-names>A</given-names></name><name><surname>Rubinstein</surname> <given-names>JL</given-names></name><name><surname>Fleet</surname> <given-names>DJ</given-names></name><name><surname>Brubaker</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>cryoSPARC: algorithms for rapid unsupervised cryo-EM structure determination</article-title><source>Nature Methods</source><volume>14</volume><fpage>290</fpage><lpage>296</lpage><pub-id pub-id-type="doi">10.1038/nmeth.4169</pub-id><pub-id pub-id-type="pmid">28165473</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Reboul</surname> <given-names>CF</given-names></name><name><surname>Eager</surname> <given-names>M</given-names></name><name><surname>Elmlund</surname> <given-names>D</given-names></name><name><surname>Elmlund</surname> <given-names>H</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Single-particle cryo-EM-Improved ab initio 3D reconstruction with SIMPLE/PRIME</article-title><source>Protein Science</source><volume>27</volume><fpage>51</fpage><lpage>61</lpage><pub-id pub-id-type="doi">10.1002/pro.3266</pub-id><pub-id pub-id-type="pmid">28795512</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rohou</surname> <given-names>A</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>CTFFIND4: Fast and accurate defocus estimation from electron micrographs</article-title><source>Journal of Structural Biology</source><volume>192</volume><fpage>216</fpage><lpage>221</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2015.08.008</pub-id><pub-id pub-id-type="pmid">26278980</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Roseman</surname> <given-names>AM</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>FindEM--a fast, efficient program for automatic selection of particles from electron micrographs</article-title><source>Journal of Structural Biology</source><volume>145</volume><fpage>91</fpage><lpage>99</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2003.11.007</pub-id><pub-id pub-id-type="pmid">15065677</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rosenthal</surname> <given-names>PB</given-names></name><name><surname>Henderson</surname> <given-names>R</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Optimal determination of particle orientation, absolute hand, and contrast loss in single-particle electron cryomicroscopy</article-title><source>Journal of Molecular Biology</source><volume>333</volume><fpage>721</fpage><lpage>745</lpage><pub-id pub-id-type="doi">10.1016/j.jmb.2003.07.013</pub-id><pub-id pub-id-type="pmid">14568533</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Scheres</surname> <given-names>SH</given-names></name><name><surname>Chen</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Prevention of overfitting in cryo-EM structure determination</article-title><source>Nature Methods</source><volume>9</volume><fpage>853</fpage><lpage>854</lpage><pub-id pub-id-type="doi">10.1038/nmeth.2115</pub-id><pub-id pub-id-type="pmid">22842542</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Scheres</surname> <given-names>SH</given-names></name><name><surname>Valle</surname> <given-names>M</given-names></name><name><surname>Nuñez</surname> <given-names>R</given-names></name><name><surname>Sorzano</surname> <given-names>CO</given-names></name><name><surname>Marabini</surname> <given-names>R</given-names></name><name><surname>Herman</surname> <given-names>GT</given-names></name><name><surname>Carazo</surname> <given-names>JM</given-names></name></person-group><year iso-8601-date="2005">2005</year><article-title>Maximum-likelihood multi-reference refinement for electron microscopy images</article-title><source>Journal of Molecular Biology</source><volume>348</volume><fpage>139</fpage><lpage>149</lpage><pub-id pub-id-type="doi">10.1016/j.jmb.2005.02.031</pub-id><pub-id pub-id-type="pmid">15808859</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Scheres</surname> <given-names>SH</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>RELION: implementation of a Bayesian approach to cryo-EM structure determination</article-title><source>Journal of Structural Biology</source><volume>180</volume><fpage>519</fpage><lpage>530</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2012.09.006</pub-id><pub-id pub-id-type="pmid">23000701</pub-id></element-citation></ref><ref id="bib41"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Scheres</surname> <given-names>SH</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Semi-automated selection of cryo-EM particles in RELION-1.3</article-title><source>Journal of Structural Biology</source><volume>189</volume><fpage>114</fpage><lpage>122</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2014.11.010</pub-id><pub-id pub-id-type="pmid">25486611</pub-id></element-citation></ref><ref id="bib42"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sheth</surname> <given-names>LK</given-names></name><name><surname>Piotrowski</surname> <given-names>AL</given-names></name><name><surname>Voss</surname> <given-names>NR</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Visualization and quality assessment of the contrast transfer function estimation</article-title><source>Journal of Structural Biology</source><volume>192</volume><fpage>222</fpage><lpage>234</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2015.06.012</pub-id><pub-id pub-id-type="pmid">26080023</pub-id></element-citation></ref><ref id="bib43"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sigworth</surname> <given-names>FJ</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>Classical detection theory and the cryo-EM particle selection problem</article-title><source>Journal of Structural Biology</source><volume>145</volume><fpage>111</fpage><lpage>122</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2003.10.025</pub-id><pub-id pub-id-type="pmid">15065679</pub-id></element-citation></ref><ref id="bib44"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sindelar</surname> <given-names>CV</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Optimal noise reduction in 3D reconstructions of single particles using a volume-normalized filter</article-title><source>Journal of Structural Biology</source><volume>180</volume><fpage>26</fpage><lpage>38</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2012.05.005</pub-id><pub-id pub-id-type="pmid">22613568</pub-id></element-citation></ref><ref id="bib45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stewart</surname> <given-names>A</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>Noise bias in the refinement of structures derived from single particles</article-title><source>Ultramicroscopy</source><volume>102</volume><fpage>67</fpage><lpage>84</lpage><pub-id pub-id-type="doi">10.1016/j.ultramic.2004.08.008</pub-id><pub-id pub-id-type="pmid">15556702</pub-id></element-citation></ref><ref id="bib46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Subramaniam</surname> <given-names>S</given-names></name><name><surname>Earl</surname> <given-names>LA</given-names></name><name><surname>Falconieri</surname> <given-names>V</given-names></name><name><surname>Milne</surname> <given-names>JL</given-names></name><name><surname>Egelman</surname> <given-names>EH</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Resolution advances in cryo-EM enable application to drug discovery</article-title><source>Current Opinion in Structural Biology</source><volume>41</volume><fpage>194</fpage><lpage>202</lpage><pub-id pub-id-type="doi">10.1016/j.sbi.2016.07.009</pub-id><pub-id pub-id-type="pmid">27552081</pub-id></element-citation></ref><ref id="bib47"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Subramaniam</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Structure of trimeric HIV-1 envelope glycoproteins</article-title><source>PNAS</source><volume>110</volume><fpage>E4172</fpage><lpage>E4174</lpage><pub-id pub-id-type="doi">10.1073/pnas.1313802110</pub-id><pub-id pub-id-type="pmid">24106302</pub-id></element-citation></ref><ref id="bib48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tang</surname> <given-names>G</given-names></name><name><surname>Peng</surname> <given-names>L</given-names></name><name><surname>Baldwin</surname> <given-names>PR</given-names></name><name><surname>Mann</surname> <given-names>DS</given-names></name><name><surname>Jiang</surname> <given-names>W</given-names></name><name><surname>Rees</surname> <given-names>I</given-names></name><name><surname>Ludtke</surname> <given-names>SJ</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>EMAN2: an extensible image processing suite for electron microscopy</article-title><source>Journal of Structural Biology</source><volume>157</volume><fpage>38</fpage><lpage>46</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2006.05.009</pub-id><pub-id pub-id-type="pmid">16859925</pub-id></element-citation></ref><ref id="bib49"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Thon</surname> <given-names>F</given-names></name></person-group><year iso-8601-date="1966">1966</year><article-title>Zur Defokussierungsabhängigkeit des Phasenkontrastes bei der elektronenmikroskopischen Abbildung</article-title><source>Zeitschrift für Naturforschung A</source><volume>21a</volume><fpage>476</fpage><lpage>478</lpage><pub-id pub-id-type="doi">10.1515/zna-1966-0417</pub-id></element-citation></ref><ref id="bib50"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>van Heel</surname> <given-names>M</given-names></name><name><surname>Harauz</surname> <given-names>G</given-names></name><name><surname>Orlova</surname> <given-names>EV</given-names></name><name><surname>Schmidt</surname> <given-names>R</given-names></name><name><surname>Schatz</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="1996">1996</year><article-title>A new generation of the IMAGIC image processing system</article-title><source>Journal of Structural Biology</source><volume>116</volume><fpage>17</fpage><lpage>24</lpage><pub-id pub-id-type="doi">10.1006/jsbi.1996.0004</pub-id><pub-id pub-id-type="pmid">8742718</pub-id></element-citation></ref><ref id="bib51"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Van Heel</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="1982">1982</year><article-title>Detection of objects in quantum-noise-limited images</article-title><source>Ultramicroscopy</source><volume>7</volume><fpage>331</fpage><lpage>341</lpage><pub-id pub-id-type="doi">10.1016/0304-3991(82)90258-3</pub-id></element-citation></ref><ref id="bib52"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>van Heel</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Finding trimeric HIV-1 envelope glycoproteins in random noise</article-title><source>PNAS</source><volume>110</volume><fpage>E4175</fpage><lpage>E4177</lpage><pub-id pub-id-type="doi">10.1073/pnas.1314353110</pub-id><pub-id pub-id-type="pmid">24106301</pub-id></element-citation></ref><ref id="bib53"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Voss</surname> <given-names>NR</given-names></name><name><surname>Yoshioka</surname> <given-names>CK</given-names></name><name><surname>Radermacher</surname> <given-names>M</given-names></name><name><surname>Potter</surname> <given-names>CS</given-names></name><name><surname>Carragher</surname> <given-names>B</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>DoG Picker and TiltPicker: software tools to facilitate particle selection in single particle electron microscopy</article-title><source>Journal of Structural Biology</source><volume>166</volume><fpage>205</fpage><lpage>213</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2009.01.004</pub-id><pub-id pub-id-type="pmid">19374019</pub-id></element-citation></ref><ref id="bib54"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Gctf: Real-time CTF determination and correction</article-title><source>Journal of Structural Biology</source><volume>193</volume><fpage>1</fpage><lpage>12</lpage><pub-id pub-id-type="doi">10.1016/j.jsb.2015.11.003</pub-id><pub-id pub-id-type="pmid">26592709</pub-id></element-citation></ref><ref id="bib55"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhou</surname> <given-names>A</given-names></name><name><surname>Rohou</surname> <given-names>A</given-names></name><name><surname>Schep</surname> <given-names>DG</given-names></name><name><surname>Bason</surname> <given-names>JV</given-names></name><name><surname>Montgomery</surname> <given-names>MG</given-names></name><name><surname>Walker</surname> <given-names>JE</given-names></name><name><surname>Grigorieff</surname> <given-names>N</given-names></name><name><surname>Rubinstein</surname> <given-names>JL</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Structure and conformational states of the bovine mitochondrial ATP synthase by cryo-EM</article-title><source>eLife</source><volume>4</volume><elocation-id>e10180</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.10180</pub-id><pub-id pub-id-type="pmid">26439008</pub-id></element-citation></ref></ref-list></back><sub-article article-type="decision-letter" id="SA1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.35383.016</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group><contrib contrib-type="editor"><name><surname>Egelman</surname><given-names>Edward H</given-names></name><role>Reviewing Editor</role><aff id="aff3"><institution>University of Virginia</institution><country>United States</country></aff></contrib></contrib-group></front-stub><body><boxed-text><p>In the interests of transparency, eLife includes the editorial decision letter and accompanying author responses. A lightly edited version of the letter sent to the authors after peer review is shown, indicating the most substantive concerns; minor comments are not usually included.</p></boxed-text><p>Thank you for submitting your article &quot;<italic>cis</italic>TEM: User-friendly software for single-particle image processing&quot; for consideration by <italic>eLife</italic>. Your article has been reviewed by three peer reviewers, and the evaluation has been overseen by a Reviewing Editor (Ed Egelman) and John Kuriyan as the Senior Editor. The following individuals involved in review of your submission have agreed to reveal their identity: Sjors HW Scheres (Reviewer #2); Henning Stahlberg (Reviewer #3); Bridget Carragher (Reviewer #4).</p><p>The reviewers have discussed the reviews with one another and the Reviewing Editor has drafted this decision to help you prepare a revised submission.</p><p>Summary</p><p>This paper describes a new image processing software solution for cryo-EM single-particle analysis called <italic>cis</italic>TEM. <italic>cis</italic>TEM combines many existing and very popular tools from the Grigorieff lab (CTFFIND, UNBLUR, FREALIGN) with several new functionalities, such as auto-picking, 2D classification and ab initio model calculation. The existing tools were all very popular solutions in the field, and their inclusion into <italic>cis</italic>TEM has motivated a complete re-write in C++. By careful code optimisation, the new programs now run at speeds that are comparable with (or even surpass) implementations by others on GPUs (e.g. RELION or cryoSPARC). In line with their excellent track-record, the authors release the code as open-source, which is laudable in a time where many new software implementations have moved towards licensing solutions for non-academic users. Modifications to existing methods and new methods are described in sufficient detail to be useful for potential users, and in many cases even for those programmers eager to implement their own versions. The GUI described appears to be well thought-through and thereby a good help for less experienced users. This is particularly relevant for access to the 3D classification and refinement approaches, which were less accessible in previous versions of FREALIGN. The results presented for β-gal are impressive: a 2.2A reconstruction is state-of-the-art, and the execution time below 5 hours is extremely fast! Therefore, this tool will undoubtedly be extremely useful for the field. The performance of <italic>cis</italic>TEM is amazing, in terms of resolution and speed. The authors are to be congratulated for making such a wonderful package available as open-source.</p><p>Essential revisions:</p><p>1) Eq 15 does not have a CTF_i component. Is that part of the projection operator (with the funny P)? If so, that would be good to spell out. Otherwise, CTF_i should be added to the equation.</p><p>2) It was unclear whether the 3D classification approach only marginalises over classes, or whether the marginalisation over the 3 in-plane orientations can also be performed. Perhaps an extra sentence would help.</p><p>3) Is <italic>cis</italic>TEM capable of on-the-fly processing? If so, it might be worth spelling that out, as many EM centres in the world are moving towards automated processing of images while they are being acquired.</p><p>4) In subsection “Parallelization”, the authors describe a flexible home-made solution to queueing many little sub-jobs, which could provide additional flexibility on busy clusters. However, it might very well be that many clusters require a given number of free nodes to be specified in their own queueing system in order to use the cluster. Perhaps an additional sentence about this could be added?</p><p>5) <italic>cis</italic>TEM is available under the GNU General Public License. This is not stated in this manuscript but should be.</p><p>6) Introduction: Use &quot;direct electron detectors&quot;, not &quot;direct detectors&quot;.</p><p>7) Subsection “Particle picking”: Please define &quot;mode&quot; in this context.</p><p>8) Subsection “Particle picking”: It is obvious that the &quot;need&quot; is there now for external users. This statement could be rephrased.</p><p>9) Subsection “3D refinement (FrealignX)”: The size threshold of 400kDa, up to which individual particle defocus refinement might be helpful, will depend on various other parameters, such as kV, defocus, ice thickness, electron detector, etc. This statement could be extended to state that this threshold applies to current typical hardware and sample preparation methods.</p><p>10) Subsection “3D refinement (FrealignX)”: For the description of applications of particle-wise CTF refinements, it would be helpful to specify, if this was done using the absolute values of the CCterms in Equation (9b), and if so, which Resolution R2 was used as transition from signed to unsigned CC values.</p><p>Also, how much does the particle-wise CTF refinement improve the final resolution, if the signed versus the unsigned CC calculation is used?</p><p>11) Subsection “3D refinement (FrealignX)”: FSC calculation is done for particles aligned against a single reference, which is resolution limited to a value well below the current resolution estimate minus 2/Dmask. However, here the authors also state that the users can set the resolution limit of the reference to arbitrary values, at their own risk. This sounds like a dangerous option for unexperienced users. Does <italic>cis</italic>TEM in such cases print out a big fat warning somewhere?</p><p>12) Subsection “Ab-initio 3D reconstruction”: &quot;3 direction are chosen&quot;. (&quot;s&quot; is missing in &quot;directions&quot;).</p><p>13) Subsection “Ab-initio 3D reconstruction”: What are the 3 directions that are chosen here? Are those random, linearly independent directions? Or are these related to symmetry axes? Please specify or explain better.</p><p>14) Discussion section: GPU hardware doesn't have to be noisier that CPU hardware. Water-cooled housings and water-cooled GPU cards are available, even though at higher costs. Several high-end GPU systems are absolutely silent, even under load. This statement is only valid under very specific settings. I would remove or rephrase it.</p><p>15) It would be helpful to know how projects are tracked in a multi user facility. In some facilities there are 100's of different projects, many of which must be well separated for confidentiality reasons. How does <italic>cis</italic>TEM handle this?</p><p>16) Can new programs easily be incorporated into <italic>cis</italic>TEM? For example, on one of the few features lacking right now is per particle unblurring and I suspect that many people will want to go with motioncorr2. While the authors discuss the intimate link between the GUI and the code as a positive, it would also be good if there were some options to &quot;wrap&quot; other programs as needed. If not, I suspect users will continue to leap in and out of a multitude of packages.</p><p>17) Does the package provide a way for sorting particles or images based on confidence values or outputs. E.g. reject all images where the CTF fit is poor etc.</p><p>18) While I accept that the DoG algorithm can be modified to select β-gal I would like to know if it really can be optimized on something much more stick like. If not, then I suspect users will have to exit the program to use a template picker until one becomes available. Again, pointing to the value of wrapping one of the many very good available template pickers.</p><p>19) It has been discussed by Gabe Lander (and other groups, too) that there is an advantage in packing particles very closely together across holes (e.g. see the Aldolase images in https://www.biorxiv.org/content/early/2017/05/25/141994). How will this affect programs that need to select background regions for determining optimal particle picking parameters or for noise whitening etc.</p><p>20) Per particles defocus is also likely to be very useful for images that are tilted relative to the electron beam or that are in two layers (see for example: https://www.biorxiv.org/content/early/2017/12/11/230276). Could the per particle be done in patches? How do the <italic>cis</italic>TEM results compare to those of gCTF for small particles? Is it possible that the lack of improvement for β-gal compared to the virus is because the method just failed due to the lower signal? How would a user know this? One way might be to plot the defocus values as z-heights which if particles really do all adhere to an air water interface will be in a plane. This might also help smooth out outliers.</p><p>21) Should cryoSparc be part of the initial set of software referenced in the Introduction.</p><p>22) What FSC is reported, 0.143?</p><p>23) Masking instructions are a bit confusing (Subsection “3D refinement (FrealignX)”).</p><p>24) Subsection “3D refinement (FrealignX)”: What happened without the mask?</p><p>25) BSC scoring (Subsection “3D refinement (FrealignX)”) description is a bit vague.</p><p>26) How does the masking affect the FSC exactly – does it come out the same?</p><p>27) Subsection “Map sharpening” calculate should be calculated (and this was the only typo I noticed!)</p><p>28) Database is interesting, but it is not clear if is it useful to the end user or just the programmers. It might be polite to reference Appion which has been using a very effective database as a tool for delivering results to users and wrapping disparate software packages for over a decade.</p><p>29) Can <italic>cis</italic>TEM be run remotely? Does your computer have to stay awake during a long action?</p></body></sub-article><sub-article article-type="reply" id="SA2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.35383.017</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><disp-quote content-type="editor-comment"><p>Essential revisions:</p><p>1) Eq 15 does not have a CTF_i component. Is that part of the projection operator (with the funny P)? If so, that would be good to spell out. Otherwise, CTF_i should be added to the equation.</p></disp-quote><p>Done.</p><disp-quote content-type="editor-comment"><p>2) It was unclear whether the 3D classification approach only marginalises over classes, or whether the marginalisation over the 3 in-plane orientations can also be performed. Perhaps an extra sentence would help.</p></disp-quote><p>Done (see added text, Subsection “3D refinement (FrealignX)).</p><disp-quote content-type="editor-comment"><p>3) Is <italic>cis</italic>TEM capable of on-the-fly processing? If so, it might be worth spelling that out, as many EM centres in the world are moving towards automated processing of images while they are being acquired.</p></disp-quote><p>This is currently not implemented but on our to-do list (see added text, Discussion section).</p><disp-quote content-type="editor-comment"><p>4) In subsection “Parallelization”, the authors describe a flexible home-made solution to queueing many little sub-jobs, which could provide additional flexibility on busy clusters. However, it might very well be that many clusters require a given number of free nodes to be specified in their own queueing system in order to use the cluster. Perhaps an additional sentence about this could be added?</p></disp-quote><p>The current run profiles are designed to be flexible in that the user can provide any command or script they choose to run the command. In some cases, the user may prefer to have one command to run many processes, e.g. using mpirun. This is not easily achievable in the current setup, although this ability will likely be added in a future version. We have added a paragraph (subsection “Parallelization”) that discusses the job submission and this limitation in more detail.</p><disp-quote content-type="editor-comment"><p>5) <italic>cis</italic>TEM is available under the GNU General Public License. This is not stated in this manuscript but should be.</p></disp-quote><p><italic>cis</italic>TEM is distributed under the Janelia Research Campus Software License (<ext-link ext-link-type="uri" xlink:href="http://license.janelia.org/license/janelia_license_1_2.html">http://license.janelia.org/license/janelia_license_1_2.html</ext-link>) (see added text, Introduction).</p><disp-quote content-type="editor-comment"><p>6) Introduction: Use &quot;direct electron detectors&quot;, not &quot;direct detectors&quot;.</p></disp-quote><p>Done.</p><disp-quote content-type="editor-comment"><p>7) Subsection “Particle picking”: Please define &quot;mode&quot; in this context.</p></disp-quote><p>The mode of a distribution is the location of the peak of that distribution. Text has been modified (subsection “Particle picking”).</p><disp-quote content-type="editor-comment"><p>8) Subsection “Particle picking”: It is obvious that the &quot;need&quot; is there now for external users. This statement could be rephrased.</p></disp-quote><p>Done (see text, subsection “Particle picking”).</p><disp-quote content-type="editor-comment"><p>9) Subsection “3D refinement (FrealignX)”: The size threshold of 400kDa, up to which individual particle defocus refinement might be helpful, will depend on various other parameters, such as kV, defocus, ice thickness, electron detector, etc. This statement could be extended to state that this threshold applies to current typical hardware and sample preparation methods.</p></disp-quote><p>Done (see text, subsection “3D refinement (FrealignX)”).</p><disp-quote content-type="editor-comment"><p>10) Subsection “3D refinement (FrealignX)”: For the description of applications of particle-wise CTF refinements, it would be helpful to specify, if this was done using the absolute values of the CCterms in Equation (9b), and if so, which Resolution R2 was used as transition from signed to unsigned CC values.</p><p>Also, how much does the particle-wise CTF refinement improve the final resolution, if the signed versus the unsigned CC calculation is used?</p></disp-quote><p>Absolute CC terms were not used (see added text, subsection “3D refinement (FrealignX)”).</p><disp-quote content-type="editor-comment"><p>11) Subsection “3D refinement (FrealignX)”: FSC calculation is done for particles aligned against a single reference, which is resolution limited to a value well below the current resolution estimate minus 2/Dmask. However, here the authors also state that the users can set the resolution limit of the reference to arbitrary values, at their own risk. This sounds like a dangerous option for unexperienced users. Does <italic>cis</italic>TEM in such cases print out a big fat warning somewhere?</p></disp-quote><p>We will consider adding a general warning to the Manual Refinement panel in the next release. The risk of biased FSC is only one of several that an inexperienced user is exposed to on this panel.</p><disp-quote content-type="editor-comment"><p>12) Subsection “Ab-initio 3D reconstruction”: &quot;3 direction are chosen&quot;. (&quot;s&quot; is missing in &quot;directions&quot;).</p></disp-quote><p>Done.</p><disp-quote content-type="editor-comment"><p>13) Subsection “Ab-initio 3D reconstruction”: What are the 3 directions that are chosen here? Are those random, linearly independent directions? Or are these related to symmetry axes? Please specify or explain better.</p></disp-quote><p>The three sets of Euler angles used in the format (psi, theta, phi) are (0, 0, 0), (-45, -45, -45) and (15, 70, -15), which were chosen to be sufficiently different to improve robustness of the algorithm. In theory the method should work with any angle, and only one should be needed. In our method we use three and average over the results, decreasing the chance of failure due to a pathologically oriented map, however we have not tested this to determine whether it is needed. We have changed the text to add more detail (subsection “Ab-initio 3D reconstruction”).</p><disp-quote content-type="editor-comment"><p>14) Discussion section: GPU hardware doesn't have to be noisier that CPU hardware. Water-cooled housings and water-cooled GPU cards are available, even though at higher costs. Several high-end GPU systems are absolutely silent, even under load. This statement is only valid under very specific settings. I would remove or rephrase it.</p></disp-quote><p>Removed.</p><disp-quote content-type="editor-comment"><p>15) It would be helpful to know how projects are tracked in a multi user facility. In some facilities there are 100's of different projects, many of which must be well separated for confidentiality reasons. How does <italic>cis</italic>TEM handle this?</p></disp-quote><p><italic>cis</italic>TEM keeps all results of a project in its project directory. In a multi-user facility where confidentiality is important, users can limit read access to this directory to prevent unauthorized access.</p><disp-quote content-type="editor-comment"><p>16) Can new programs easily be incorporated into <italic>cis</italic>TEM? For example, on one of the few features lacking right now is per particle unblurring and I suspect that many people will want to go with motioncorr2. While the authors discuss the intimate link between the GUI and the code as a positive, it would also be good if there were some options to &quot;wrap&quot; other programs as needed. If not, I suspect users will continue to leap in and out of a multitude of packages.</p></disp-quote><p>Unfortunately, <italic>cis</italic>TEM’s current design does not allow easy incorporation of other software. cisTEM enables data import and export at all stages, and it should be easy for users to perform motion correction in MotionCorr2, and then import the aligned sums for further processing in <italic>cis</italic>TEM.</p><disp-quote content-type="editor-comment"><p>17) Does the package provide a way for sorting particles or images based on confidence values or outputs. E.g. reject all images where the CTF fit is poor etc.</p></disp-quote><p>The option to sort results is available in some panels, most notably in the CTF estimation Results panel, where the images can be sorted / selected based on the CTF fit. Due to the fact the results are stored in a database, sorting / selecting is relatively easy to implement, and future versions will have more sorting facilities. We have added a brief description of this in subsection “GUI design and workflow”.</p><disp-quote content-type="editor-comment"><p>18) While I accept that the DoG algorithm can be modified to select β-gal I would like to know if it really can be optimized on something much more stick like. If not, then I suspect users will have to exit the program to use a template picker until one becomes available. Again, pointing to the value of wrapping one of the many very good available template pickers.</p></disp-quote><p>A simple disk as a template will perform increasingly worse as the shape of the particle becomes more stick-like. As indicated in the manuscript, a template-based picker is in the planning. In the meantime, particle coordinates found by a different picker can be imported into <italic>cis</italic>TEM. We have added a reference to the DoG algorithm (subsection “Particle picking”).</p><disp-quote content-type="editor-comment"><p>19) It has been discussed by Gabe Lander (and other groups, too) that there is an advantage in packing particles very closely together across holes (e.g. see the Aldolase images in <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/early/2017/05/25/141994">https://www.biorxiv.org/content/early/2017/05/25/141994</ext-link>). How will this affect programs that need to select background regions for determining optimal particle picking parameters or for noise whitening etc.</p></disp-quote><p>Our particle picking algorithm will indeed be susceptible to misestimating the background noise spectrum under such circumstances. Picking will still work, but a higher false-positive rate might be expected. This is now spelt out in the text (subsection “Particle picking”).</p><disp-quote content-type="editor-comment"><p>20) Per particles defocus is also likely to be very useful for images that are tilted relative to the electron beam or that are in two layers (see for example: <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/early/2017/12/11/230276">https://www.biorxiv.org/content/early/2017/12/11/230276</ext-link>). Could the per particle be done in patches? How do the <italic>cis</italic>TEM results compare to those of gCTF for small particles? Is it possible that the lack of improvement for β-gal compared to the virus is because the method just failed due to the lower signal? How would a user know this? One way might be to plot the defocus values as z-heights which if particles really do all adhere to an air water interface will be in a plane. This might also help smooth out outliers.</p></disp-quote><p>The lack of improvement in the case of β-galactosidase could certainly be due to inaccuracies in the defocus refinement. CTF refinement in patches, as it is already implemented in gCTF, is an excellent idea. A simplified patch-based refinement was implemented in Frealign 9 (a “patch” consisted of a whole micrograph). We will add such a feature in a future release of <italic>cis</italic>TEM.</p><disp-quote content-type="editor-comment"><p>21) Should cryoSparc be part of the initial set of software referenced in the Introduction.</p></disp-quote><p>Done.</p><disp-quote content-type="editor-comment"><p>22) What FSC is reported, 0.143?</p></disp-quote><p>Yes (see added text, subsection “3D refinement (FrealignX)”).</p><disp-quote content-type="editor-comment"><p>23) Masking instructions are a bit confusing (Subsection “3D refinement (FrealignX)”).</p></disp-quote><p>We rewrote the description of the masking procedure (see changed text, Subsection “3D refinement (FrealignX)”).</p><disp-quote content-type="editor-comment"><p>24) Subsection “3D refinement (FrealignX)”: What happened without the mask?</p></disp-quote><p>Without masking, the detergent micelle showed typical signs of noise overfitting (see added text, Subsection “3D refinement (FrealignX)”).</p><disp-quote content-type="editor-comment"><p>25) BSC scoring (Subsection “3D refinement (FrealignX)”) description is a bit vague.</p></disp-quote><p>We added an explanation of how much the effective B-factors used for weighting vary in a typical case (see added text, Subsection “3D refinement (FrealignX)”)).</p><disp-quote content-type="editor-comment"><p>26) How does the masking affect the FSC exactly – does it come out the same?</p><p>Yes, the more generous masking and subsequent solvent correction yields FSC curves that are very close to curves obtained with tightly masked half volumes (see added text, Subsection “3D refinement (FrealignX)”, caption and added curve, <xref ref-type="fig" rid="fig7">Figure 7C</xref>).</p><p>27) Subsection “Map sharpening” calculate should be calculated (and this was the only typo I noticed!).</p></disp-quote><p>Done.</p><disp-quote content-type="editor-comment"><p>28) Database is interesting, but it is not clear if is it useful to the end user or just the programmers. It might be polite to reference Appion which has been using a very effective database as a tool for delivering results to users and wrapping disparate software packages for over a decade.</p></disp-quote><p>Some of the sorting functions (see above) depend on the database. Also, results keep a record of which input data were used to generate them. These functions are useful to both programmers and users. We have added a reference to Appion (Subsection “GUI design and workflow”).</p><disp-quote content-type="editor-comment"><p>29) Can <italic>cis</italic>TEM be run remotely? Does your computer have to stay awake during a long action?</p></disp-quote><p>Since <italic>cis</italic>TEM is part of the processing software, it must remain running during processing. Protocols such as NX, VNC or RDP can be used to start <italic>cis</italic>TEM locally, then log off and connect again remotely.</p></body></sub-article></article>