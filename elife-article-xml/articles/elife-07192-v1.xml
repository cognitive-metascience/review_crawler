<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1d3 20150301//EN"  "JATS-archivearticle1.dtd"><article article-type="research-article" dtd-version="1.1d3" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="hwp">eLife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">07192</article-id><article-id pub-id-type="doi">10.7554/eLife.07192</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Research Article</subject></subj-group><subj-group subj-group-type="heading"><subject>Neuroscience</subject></subj-group></article-categories><title-group><article-title>Optogenetic feedback control of neural activity</article-title></title-group><contrib-group><contrib contrib-type="author" corresp="yes" id="author-29683"><name><surname>Newman</surname><given-names>Jonathan P</given-names></name><contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-5425-3340</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="corresp" rid="cor1">*</xref><xref ref-type="other" rid="par-1"/><xref ref-type="other" rid="par-8"/><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-30007"><name><surname>Fong</surname><given-names>Ming-fai</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="aff" rid="aff4">4</xref><xref ref-type="other" rid="par-1"/><xref ref-type="other" rid="par-8"/><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-30008"><name><surname>Millard</surname><given-names>Daniel C</given-names></name><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="other" rid="par-8"/><xref ref-type="fn" rid="con3"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-30009"><name><surname>Whitmire</surname><given-names>Clarissa J</given-names></name><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="par-2"/><xref ref-type="other" rid="par-9"/><xref ref-type="fn" rid="con4"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-30010"><name><surname>Stanley</surname><given-names>Garrett B</given-names></name><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="par-3"/><xref ref-type="other" rid="par-4"/><xref ref-type="other" rid="par-5"/><xref ref-type="fn" rid="con5"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" corresp="yes" id="author-30011"><name><surname>Potter</surname><given-names>Steve M</given-names></name><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="corresp" rid="cor2">*</xref><xref ref-type="other" rid="par-6"/><xref ref-type="other" rid="par-7"/><xref ref-type="fn" rid="con6"/><xref ref-type="fn" rid="conf1"/></contrib><aff id="aff1"><label>1</label><institution content-type="dept">Picower Institute for Learning and Memory, Department of Brain and Cognitive Sciences</institution>, <institution>Massachusetts Institute of Technology</institution>, <addr-line><named-content content-type="city">Cambridge</named-content></addr-line>, <country>United States</country></aff><aff id="aff2"><label>2</label><institution content-type="dept">Laboratory for Neuroengineering, Department of Biomedical Engineering</institution>, <institution>Georgia Institute of Technology</institution>, <addr-line><named-content content-type="city">Atlanta</named-content></addr-line>, <country>United States</country></aff><aff id="aff3"><label>3</label><institution>Axion Biosystems</institution>, <addr-line><named-content content-type="city">Atlanta</named-content></addr-line>, <country>United States</country></aff><aff id="aff4"><label>4</label><institution content-type="dept">Department of Physiology</institution>, <institution>Emory University School of Medicine</institution>, <addr-line><named-content content-type="city">Atlanta</named-content></addr-line>, <country>United States</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor" id="author-16672"><name><surname>Bartos</surname><given-names>Marlene</given-names></name><role>Reviewing editor</role><aff><institution>Albert-Ludwigs-Universität Freiburg</institution>, <country>Germany</country></aff></contrib></contrib-group><author-notes><corresp id="cor1"><label>*</label>For correspondence: <email>jpnewman@mit.edu</email> (JPN);</corresp><corresp id="cor2"><email>steve.potter@bme.gatech.edu</email> (SMP)</corresp></author-notes><pub-date date-type="pub" publication-format="electronic"><day>03</day><month>07</month><year>2015</year></pub-date><pub-date pub-type="collection"><year>2015</year></pub-date><volume>4</volume><elocation-id>e07192</elocation-id><history><date date-type="received"><day>26</day><month>02</month><year>2015</year></date><date date-type="accepted"><day>28</day><month>05</month><year>2015</year></date></history><permissions><copyright-statement>© 2015, Newman et al</copyright-statement><copyright-year>2015</copyright-year><copyright-holder>Newman et al</copyright-holder><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-07192-v1.pdf"/><abstract><object-id pub-id-type="doi">10.7554/eLife.07192.001</object-id><p>Optogenetic techniques enable precise excitation and inhibition of firing in specified neuronal populations and artifact-free recording of firing activity. Several studies have suggested that optical stimulation provides the precision and dynamic range requisite for closed-loop neuronal control, but no approach yet permits feedback control of neuronal firing. Here we present the ‘optoclamp’, a feedback control technology that provides continuous, real-time adjustments of bidirectional optical stimulation in order to lock spiking activity at specified targets over timescales ranging from seconds to days. We demonstrate how this system can be used to decouple neuronal firing levels from ongoing changes in network excitability due to multi-hour periods of glutamatergic or GABAergic neurotransmission blockade in vitro as well as impinging vibrissal sensory drive in vivo. This technology enables continuous, precise optical control of firing in neuronal populations in order to disentangle causally related variables of circuit activation in a physiologically and ethologically relevant manner.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.001">http://dx.doi.org/10.7554/eLife.07192.001</ext-link></p></abstract><abstract abstract-type="executive-summary"><object-id pub-id-type="doi">10.7554/eLife.07192.002</object-id><title>eLife digest</title><p>Cells called neurons use electrical signals to rapidly carry information around the body. When a neuron is activated, it generates (or ‘fires’) a short electrical impulse that travels along the cell to relay a message to other neurons, muscles or organs. Optogenetics is a technique that allows scientists to genetically modify neurons to produce proteins that make them light sensitive.</p><p>One of the most commonly used light-sensitive proteins is called channelrhodopsin-2. It is activated by blue light and increases the electrical activity of neurons. Another protein is called halorhodopsin, which responds to yellow light and inhibits the firing of neurons. By shining light of particular colors onto neurons that produce these and other light-sensitive proteins, it is possible to manipulate the activity of large populations of neurons.</p><p>Most previous optogenetic experiments have involved altering the activity of neurons and then observing the outcome at a later point in time. However, it would be very useful to be able to alter the amount of optical stimulation to achieve particular levels of neuron activity in real time. To achieve this, the level of neuron activity at any point in time would need to be quickly compared to the desired level, so that optogenetics could be used to increase or decrease the firing of neurons as appropriate.</p><p>Newman et al. have now developed an optogenetic system called ‘optoclamp’ that can control the activity of neurons in real time. In neurons grown in cell culture, the optoclamp is able to hold the level of neuron activity at particular values for periods of time ranging from 60 seconds to 24 hours. It can be used to restore and maintain the baseline level of neuron activity in the presence of drugs that would otherwise produce large increases or decreases in the firing of neurons. Moreover, in anaesthetized rats, the optoclamp can prevent some neurons from being activated even when the rats' whiskers move, which would normally change their firing level.</p><p>Newman et al.'s findings open the door to a new type of neuroscience experiment where it is possible to manipulate activity patterns as they are produced by the brain. This will help researchers to understand how particular patterns of brain activity are linked to learning, memory, and behavior.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.002">http://dx.doi.org/10.7554/eLife.07192.002</ext-link></p></abstract><kwd-group kwd-group-type="author-keywords"><title>Author keywords</title><kwd>optoclamp</kwd><kwd>real-time</kwd><kwd>optogenetics</kwd><kwd>cultured cortical network</kwd><kwd>sensory thalamus</kwd><kwd>closed loop</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd>Rat</kwd></kwd-group><funding-group><award-group id="par-1"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000001</institution-id><institution>National Science Foundation (NSF)</institution></institution-wrap></funding-source><award-id>Integrative Graduate Education and Research Traineeship</award-id><principal-award-recipient><name><surname>Newman</surname><given-names>Jonathan P</given-names></name><name><surname>Fong</surname><given-names>Ming-fai</given-names></name></principal-award-recipient></award-group><award-group id="par-2"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000065</institution-id><institution>National Institute of Neurological Disorders and Stroke (NINDS)</institution></institution-wrap></funding-source><award-id>Kirschstein National Research Service Award</award-id><principal-award-recipient><name><surname>Whitmire</surname><given-names>Clarissa J</given-names></name></principal-award-recipient></award-group><award-group id="par-3"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000001</institution-id><institution>National Science Foundation (NSF)</institution></institution-wrap></funding-source><award-id>Collaborative Research in Com- putational Neuroscience grant IOS-1131948</award-id><principal-award-recipient><name><surname>Stanley</surname><given-names>Garrett B</given-names></name></principal-award-recipient></award-group><award-group id="par-4"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000065</institution-id><institution>National Institute of Neurological Disorders and Stroke (NINDS)</institution></institution-wrap></funding-source><award-id>2R01NS048285</award-id><principal-award-recipient><name><surname>Stanley</surname><given-names>Garrett B</given-names></name></principal-award-recipient></award-group><award-group id="par-5"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000065</institution-id><institution>National Institute of Neurological Disorders and Stroke (NINDS)</institution></institution-wrap></funding-source><award-id>R01NS085447</award-id><principal-award-recipient><name><surname>Stanley</surname><given-names>Garrett B</given-names></name></principal-award-recipient></award-group><award-group id="par-6"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000001</institution-id><institution>National Science Foundation (NSF)</institution></institution-wrap></funding-source><award-id>Emerging Frontiers in Research and Innovation grant 1238097</award-id><principal-award-recipient><name><surname>Potter</surname><given-names>Steve M</given-names></name></principal-award-recipient></award-group><award-group id="par-7"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000065</institution-id><institution>National Institute of Neurological Disorders and Stroke (NINDS)</institution></institution-wrap></funding-source><award-id>1R01NS079757-01</award-id><principal-award-recipient><name><surname>Potter</surname><given-names>Steve M</given-names></name></principal-award-recipient></award-group><award-group id="par-8"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000001</institution-id><institution>National Science Foundation (NSF)</institution></institution-wrap></funding-source><award-id>Graduate Research Fellowship</award-id><principal-award-recipient><name><surname>Newman</surname><given-names>Jonathan P</given-names></name><name><surname>Fong</surname><given-names>Ming-fai</given-names></name><name><surname>Millard</surname><given-names>Daniel C</given-names></name></principal-award-recipient></award-group><award-group id="par-9"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000002</institution-id><institution>National Institutes of Health (NIH)</institution></institution-wrap></funding-source><award-id>Computational Neuroscience Training Grant (1T90DA032466)</award-id><principal-award-recipient><name><surname>Whitmire</surname><given-names>Clarissa J</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta><meta-name>elife-xml-version</meta-name><meta-value>2.3</meta-value></custom-meta><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>The 'Optoclamp' is a feedback control technology that enables precise, continuously updated, closed-loop optical control of neural firing both in vitro and in vivo.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>Feedback is essential for controlling complicated systems. It can be used to define system dynamics and decouple causal interactions. Recently, a diverse set of specialized techniques that employ elements of feedback control have emerged for studying adaptation in neuronal micro-circuits (<xref ref-type="bibr" rid="bib1">Ahrens et al., 2012</xref>), using electrical stimulation to control spike latency (<xref ref-type="bibr" rid="bib52">Wallach et al., 2011</xref>) and firing levels (<xref ref-type="bibr" rid="bib50">Wagenaar et al., 2005</xref>; <xref ref-type="bibr" rid="bib31">Newman et al., 2013</xref>), improving brain-computer interfaces (<xref ref-type="bibr" rid="bib49">Velliste et al., 2008</xref>; <xref ref-type="bibr" rid="bib7">Cunningham et al., 2011</xref>), inducing motor plasticity (<xref ref-type="bibr" rid="bib20">Jackson et al., 2006</xref>), and controlling intracellular firing rate (<xref ref-type="bibr" rid="bib28">Miranda-Domínguez et al., 2010</xref>). True feedback control has been most broadly applied in neuroscience research using the voltage clamp, which is used to decouple the membrane potential from causally related voltage-dependent conductances. This approach has provided the foundation for our understanding intracellular electrochemical signaling and demands extension to other features of neural activity.</p><p>The neuronal firing rate is a basic feature of codes for motor action (<xref ref-type="bibr" rid="bib14">Georgopoulos et al., 1988</xref>), vision (<xref ref-type="bibr" rid="bib43">Steinmetz et al., 1987</xref>), and place (<xref ref-type="bibr" rid="bib55">Zhang et al., 1998</xref>). Changes in thalamic firing tone can alter cortical receptive fields (<xref ref-type="bibr" rid="bib45">Stoelzel et al., 2009</xref>) and the nature of temporal coding within the thalamocortical pathways (<xref ref-type="bibr" rid="bib53">Wang et al., 2010</xref>). Long-term changes in network firing levels can trigger a multitude of homeostatic processes that regulate circuit excitability and stability (<xref ref-type="bibr" rid="bib47">Turrigiano et al., 1998</xref>; <xref ref-type="bibr" rid="bib6">Corner et al., 2002</xref>; <xref ref-type="bibr" rid="bib48">Turrigiano, 2011</xref>). A system analogous to the voltage clamp, but capable of precise, bidirectional control of circuit firing levels could be used to identify the independent role of firing rate in downstream processes in spite of changes to causally-related variables. For instance, long-term changes in population firing have long been thought to initiate compensatory homeostatic mechanisms, but a causal link has remained elusive. Direct bidirectional control over population firing rates would allow us to test this hypothesis directly. Optogenetic tools are routinely used to provide genetically specified, millisecond time-scale stimulation or suppression of neural activity with light (<xref ref-type="bibr" rid="bib25">Mattis et al., 2011</xref>) during simultaneous, artifact-free electrical recording. The ability to simultaneously perturb and measure neural activity form the basic elements of a feedback loop, which can be exploited to control firing. Although several studies have presented closed-loop optogenetic stimulation techniques (<xref ref-type="bibr" rid="bib24">Leifer et al., 2011</xref>; <xref ref-type="bibr" rid="bib44">Stirman et al., 2011</xref>; <xref ref-type="bibr" rid="bib35">Paz et al., 2012</xref>; <xref ref-type="bibr" rid="bib23">Krook-Magnuson et al., 2013</xref>; <xref ref-type="bibr" rid="bib32">O'Connor et al., 2013</xref>; <xref ref-type="bibr" rid="bib40">Siegle and Wilson, 2014</xref>), no approach yet permits feedback control of neuronal firing levels.</p><p>Here we describe and quantify optogenetic feedback control (‘optoclamping’), a method enabling continuous, bi-directional, closed-loop firing rate control both in vitro and in vivo. We show that the optoclamp allows precise control of population firing levels in dissociated cortical networks over timescales ranging from seconds to days. We characterize the effects of different control schemes, algorithm parameters, and optical waveforms on the precision of feedback control and higher-order statistics of population activity. We show that firing rate control can be achieved over many hours and used to restore pre-drug firing levels during chronic blockade of excitatory or inhibitory synaptic transmission. Using this approach, we decouple the effects of suppressed neurotransmission from the indirect effects on network firing, and find that changes in firing levels are not required to induce homeostatic alterations in network excitability. Finally, we show how optogenetic feedback can be used to control firing activity in vibrissal somatosensory thalamus of rats. We find that background thalamic activity levels can be controlled during ongoing sensory input without corrupting the fine-scale temporal structure of whisker-evoked spike trains. Together, our results demonstrate that the optoclamp is an effective general tool for decoupling neural firing from other variables that would normally affect network excitability.</p></sec><sec id="s2" sec-type="results"><title>Results</title><sec id="s2-1"><title>Characterizing bidirectional optical control signals</title><p>To characterize the range of evoked firing levels that could be achieved using multimodal optical stimulation in dissociated cortical networks, we stimulated excitatory cells expressing channelrhodopsin-2(H134R) (ChR2<sub>R</sub>) (<xref ref-type="bibr" rid="bib29">Nagel et al., 2005</xref>) and enhanced halorhodopsin-3.0 (eNpHR3.0) (<xref ref-type="bibr" rid="bib15">Gradinaru et al., 2008</xref>) while recording spiking activity using a 59-channel microelectrode array (MEA; <xref ref-type="fig" rid="fig1">Figure 1A</xref>) (<xref ref-type="bibr" rid="bib31">Newman et al., 2013</xref>). For ChR2<sub>R</sub> activation, a single dimensionless excitatory control variable, <italic>U</italic><sub>C</sub>, simultaneously modulated the pulse width, frequency, and intensity of homogeneous 465 nm stimuli (<xref ref-type="disp-formula" rid="equ7 equ8 equ9">Equations 7–9</xref>, ‘Materials and methods’; <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1</xref> and <xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2</xref>). For eNpHR3.0 activation, we defined a second control variable, <italic>U</italic><sub>H</sub>, proportional to the continuous intensity of a 590 nm LED (<xref ref-type="disp-formula" rid="equ10">Equation 10</xref>). We applied <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub> ranging from 0 to 1, for randomly interleaved, 60-s stimulation epochs (2 cultures, 50 trials/culture). Evoked population firing rates were positively correlated with <italic>U</italic><sub>C</sub> and negatively correlated with <italic>U</italic><sub>H</sub> (<xref ref-type="fig" rid="fig1">Figure 1B</xref>). <italic>U</italic><sub>C</sub>-evoked firing levels saturated at approximately 12.5 Hz/unit corresponding to <italic>U</italic><sub>C</sub> = 0.47 (freq. = 14.7 Hz, pulse-width: 2.4 ms, power at 465 nm: 6.9 mW·mm<sup>−2</sup>). Firing rate suppression saturated at 0.04 Hz/unit corresponding to <italic>U</italic><sub>H</sub> = 0.15 (power at 590 nm: 1.8 mW mm<sup>−2</sup>). The monotonic relationships between <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub> and network firing levels indicated their applicability as closed-loop control signals.<fig-group><fig id="fig1" position="float"><object-id pub-id-type="doi">10.7554/eLife.07192.003</object-id><label>Figure 1.</label><caption><title>Optogenetic modulation of network activity in vitro.</title><p>(<bold>A</bold>) Multichannel recording, processing, and stimulation system. A 59-channel amplifier detects spiking activity produced by cells close to electrodes (white outline). Neurons express ChR2<sub>R</sub>-mCherry (red) and eNpHR3.0 under the CaMKll<italic>α</italic> promoter (green: immunoreactivity for CaMKll<italic>α</italic>; scalebar: 20 μm). Electrode voltages are processed in real-time and can be used to update an LED stimulator feeding a homogeneous Köhler illuminator below the MEA. An optical feedback circuit (blue line) ensures distortion free blue stimulus waveforms. (<bold>B</bold>) Time-averaged firing rates of two cultures (△ and ○) in response to 60-s applications of randomly valued <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub> during different forms of synaptic blockade. Black horizontal bars indicate the cultures' spontaneous firing levels. Blue and yellow symbols indicate the mean firing level over a single trial at the corresponding value of <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub>, respectively. The dotted lines are least-squares fits used to estimate the <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub> saturation points provided in the text. (<bold>C</bold>) PSTH of individual units (grey scale) and the unit-averaged PTSH in response to 1 millisecond 5 mW mm<sup>−2</sup> blue light pulses for each drug condition. Scale bars, 50 Hz/unit. (<bold>D</bold>) Raster plots for 87 detected units during 60-s applications of <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub>. The firing rate evoked by stimulation using a particular value of <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub> decays over the course of the protocol. (<bold>E</bold>) The trial-averaged firing rate profiles for the stimulus levels presented in (<bold>D</bold>) across drug conditions. Black horizontal lines indicate the 60 s stimulation period. Dotted lines indicate spontaneous firing levels. Note the log scale. In (<bold>C</bold>) and (<bold>E</bold>), line colors indicate the drug conditions above each panel in (<bold>B</bold>).</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.003">http://dx.doi.org/10.7554/eLife.07192.003</ext-link></p></caption><graphic xlink:href="elife-07192-fig1-v1.tif"/></fig><fig id="fig1s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.004</object-id><label>Figure 1—figure supplement 1.</label><caption><title>Optical characteristics of the in vitro stimulator and in vivo fiber.</title><p>(<bold>A</bold>, <bold>B</bold>) Optical power density at the culture as a function of the reference voltage sent to the LED driver from NeuroRighter's digital to analog converters for the in vitro stimulator. (<bold>A</bold>) For the blue (465 nm) LED, we used optical feedback to completely linearize the relationship between the reference voltage and optical power (<xref ref-type="fig" rid="fig1">Figure 1A</xref> in the main text; <ext-link ext-link-type="uri" xlink:href="https://github.com/jonnew/cyclops">https://github.com/jonnew/cyclops</ext-link>; ‘Materials and methods’). This enabled the delivery of complex, distortion-free stimulus waveforms, such as sinusoidal and triangle waves (<xref ref-type="fig" rid="fig4">Figure 4</xref>). (<bold>B</bold>) For the yellow LEDs (590 nm) we used current regulation mode to control optical intensity. (<bold>C</bold>) Colormap indicating the uniform spatial light intensity profile projected onto the MEA surface using a Köhler illuminator (<xref ref-type="fig" rid="fig1">Figure 1A</xref> in the main text). The black lines show cross sectional intensity profiles through the horizontal and vertical center of the illuminated region (white lines). The MEA image is superimposed on the profile to provide an indication of scale. (<bold>D</bold>) Power density at the tip of the three 125 μm diameter fibers used for in vivo stimulation as a function of a reference voltage provided by the real-time controller. Differences in power across fibers are due to disparities in fiber coupling efficiency along with circuit tuning that was performed to ensure linearity over the reference voltage range prior to each experiment.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.004">http://dx.doi.org/10.7554/eLife.07192.004</ext-link></p></caption><graphic xlink:href="elife-07192-fig1-figsupp1-v1.tif"/></fig><fig id="fig1s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.005</object-id><label>Figure 1—figure supplement 2.</label><caption><title>Expression time course of AAV2-CaMKIIα-ChR2(H134R)-mCherry.</title><p>(<bold>A</bold>) Phase-contrast and confocal imaging of a single region of interest (ROI), containing 4 microelectrodes, performed over the first 26 days in vitro (DIV). Cultures were transduced at 1 DIV. (<bold>B</bold>) To quantify the expression time course, three or four ROIs were imaged in three cultures over the first 26 DIV. For each ROI and DIV, the integrated intensity of 600–690 nm light through the emission filter was calculated and then normalized by the maximal integrated intensity over the 26 day imaging period (black dots). A sigmoid of the form <inline-formula><mml:math id="inf3"><mml:mrow><mml:mfrac><mml:mi>a</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>e</mml:mi><mml:mi>x</mml:mi><mml:mi>p</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>b</mml:mi><mml:mi>x</mml:mi><mml:mo>+</mml:mo><mml:mi>c</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:math></inline-formula>was fit to the resulting data using nonlinear regression (r<sup>2</sup> = 0.98; MATLAB curve-fit toolbox). The half maximal expression point occurred at ∼12 DIV. (<bold>C</bold>) The time-course of ChR2<sub>R</sub> function was measured by recording the evoked network spiking response in three networks over the first 16 DIV. Each experiment applied 140 trains of 30 s stimulation periods, each consisting of a random combination of pulse frequency (1, 5, 10, 20, 30, 40, and 50 Hz), pulse width (0.1, 0.5, 1.0, and 5.0 ms), and 465 nm LED intensity (0.2, 0.4, 0.6, 0.8, and 1.0 Amps; current regulation was used because these experiments were performed prior to the creation of the linear LED driver shown in <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1</xref>). Stimulus bouts were separated by 30 s and were applied in random order. Colored lines show the average neuronal firing rate, across all three networks, at a set value for particular stimulation parameters. For example, the average network firing rate, <inline-formula><mml:math id="inf4"><mml:mrow><mml:mo>〈</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>〉</mml:mo></mml:mrow></mml:math></inline-formula>, for a stimulus frequency of 20 Hz is.<disp-formula id="equ16"><mml:math id="m16"><mml:mrow><mml:mrow><mml:mo>〈</mml:mo><mml:mrow><mml:mi>f</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>〉</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mo>〈</mml:mo><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mtext>Firing Rate</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>Stim</mml:mtext><mml:mo>.</mml:mo><mml:mtext> Freq</mml:mtext><mml:mo>,</mml:mo><mml:mtext>Pulse Width</mml:mtext><mml:mo>,</mml:mo><mml:msub><mml:mtext>I</mml:mtext><mml:mrow><mml:mtext>LED</mml:mtext></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>|</mml:mo><mml:mtext>Stim</mml:mtext><mml:mo>.</mml:mo><mml:mtext> Freq</mml:mtext><mml:mo>=</mml:mo><mml:mn>20</mml:mn><mml:mtext>Hz</mml:mtext></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>〉</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf2"><mml:mrow><mml:mo>〈</mml:mo><mml:mo>·</mml:mo><mml:mo>〉</mml:mo></mml:mrow></mml:math></inline-formula>indicates the average over time and units. The legend indicates the number of units used to produce each line for each DIV. The monotonicity of these functions across development (except for high stimulus frequencies) indicates the achievable evoked firing levels at different developmental points and the potential of each of the stimulus parameters to be effective control inputs.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.005">http://dx.doi.org/10.7554/eLife.07192.005</ext-link></p></caption><graphic xlink:href="elife-07192-fig1-figsupp2-v1.tif"/></fig></fig-group></p><p>We also tested the robustness of <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub> for modulating firing levels during blockade of AMPAergic, NMDAergic, or GABAergic transmission using CNQX, AP5, or bicuculline, respectively (‘Materials and methods’). Synaptic blockade strongly affected mean spontaneous firing levels (CNQX: −74.2%, AP5: −66.6%, bicuculine: +357%) and network-level signal propagation (<xref ref-type="fig" rid="fig1">Figure 1C</xref>). In spite of this, firing in CNQX- and AP5-treated networks could be driven over the same dynamic range as the drug free condition (<xref ref-type="fig" rid="fig1">Figure 1B</xref>; CNQX: 0.057 to 13.3 Hz/unit, AP5: 0.088 to 12.6 Hz/unit), indicating that optogenetic input could compensate for depressed excitatory transmission. Bicuculline greatly reduced the dynamic range of evoked network activity indicating a loss of reliable activity modulation (<xref ref-type="fig" rid="fig1">Figure 1B</xref>; 0.095 to 5.1 Hz/unit).</p><p>Although time-averaged firing levels were monotonically related to <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub> (<xref ref-type="fig" rid="fig1">Figure 1B</xref>), open-loop stimuli lost effectiveness throughout each 60-s trial causing significant second-to-second drift in evoked activity levels (<xref ref-type="fig" rid="fig1">Figure 1D,E</xref>). This effect was consistent across synaptic blocker conditions. Decreases in stimulus efficacy using ChR2<sub>R</sub> were likely due to network adaptation, rather than changes in ChR2<sub>R</sub>-mediated photocurrents (<xref ref-type="bibr" rid="bib25">Mattis et al., 2011</xref>). Aside from network adaptation, deceased efficacy of eNpHR3.0-mediated firing suppression likely resulted from a loss of synaptic inhibition due to intracellular Cl<sup>−</sup> accumulation (<xref ref-type="bibr" rid="bib38">Raimondo et al., 2012</xref>) and decreased outward photocurrents due to pump desensitization (<xref ref-type="bibr" rid="bib25">Mattis et al., 2011</xref>).</p></sec><sec id="s2-2"><title>Proportional-integral control of network firing</title><p>We developed a proportional-integral (PI) feedback controller to clamp network population activity in dissociated cortical networks in the face of uncontrolled fluctuations in neuronal excitability and opsin dynamics (<xref ref-type="disp-formula" rid="equ1 equ2 equ3 equ4 equ5 equ6">Equations 1–6</xref>). The PI algorithm updated <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub> in real-time in order to minimize the difference (‘error’) between the measured network firing rate and a target level (‘Materials and methods’). We tested the controller using 60-s, randomly-ordered targets ranging from 0–10 Hz/unit (<xref ref-type="fig" rid="fig2">Figure 2A</xref>; 7 cultures, 11 trials/culture), and successful control was achieved in over 90% of trials (<xref ref-type="fig" rid="fig2">Figure 2B</xref>; 71/77 trials; mean RMS tracking error 0.14 ± 0.091 Hz/unit). Tracking error increased with target rate, and occasionally the stimulator saturated before the trial was complete (e.g., <xref ref-type="fig" rid="fig2">Figure 2A</xref>, grey line). Control settling time varied across preparations and was not correlated with the target firing rate (mean ± SD, 7.83 ± 6.07 s; <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>). Although we generally used discrete steps in the target firing rate, the controller was also capable of tracking continuously varying targets (<xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2</xref>).<fig-group><fig id="fig2" position="float"><object-id pub-id-type="doi">10.7554/eLife.07192.006</object-id><label>Figure 2.</label><caption><title>PI optical feedback allows precise control of network firing levels over 1-min epochs.</title><p>(<bold>A</bold>) (<italic>Top</italic>) Network firing rate during different trials (colors). Target firing levels (black lines) ranged from 0 to 10 Hz and were applied in random order. (<italic>Bottom</italic>) Control signals, <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub>, required during closed-loop control. For this network, the controller saturated while attempting to clamp network firing at 10 Hz/unit, resulting in a control failure (grey trace). (<bold>B</bold>) Time-averaged firing rates for seven different networks during PI control (left axis, colors). The dotted line is identity representing perfect closed-loop control. The spontaneous firing rates of each network are indicated by black arrows. The RMS error between the measured and target firing for each network is shown as a function of the target rate (right axis, black markers). A trial was considered successful if the RMS error between the target and achieved firing rate was less than 0.5 Hz/unit (red line). (<bold>C</bold>) Time- and culture-averaged successful control signals vs target firing rates. The shaded areas indicate the minimum and maximum value across networks. All temporal averages in this figure were taken over the final 30 s of the control epoch.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.006">http://dx.doi.org/10.7554/eLife.07192.006</ext-link></p></caption><graphic xlink:href="elife-07192-fig2-v1.tif"/></fig><fig id="fig2s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.007</object-id><label>Figure 2—figure supplement 1.</label><caption><title>PI settling time in vitro.</title><p>(<bold>A</bold>) The settling time was defined as the time-point at which the smoothed firing rate (grey line; LOWESS with a 2.5 s smoothing window and a tri-cube weight function) entered and stayed within the boundaries defined by the target rate ± 0.25 Hz/unit (dotted red lines). (<bold>B</bold>) The settling time did not have a strong relationship with the target firing rate and was variable across cultures (mean ± SD: 7.8 ± 6.0 s, 7 cultures). Colors denote different cultures and the dotted black line indicates the mean across cultures for each target rate.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.007">http://dx.doi.org/10.7554/eLife.07192.007</ext-link></p></caption><graphic xlink:href="elife-07192-fig2-figsupp1-v1.tif"/></fig><fig id="fig2s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.008</object-id><label>Figure 2—figure supplement 2.</label><caption><title>PI feedback permits control during a continuously changing target rate.</title><p>(<bold>A</bold>) Firing rate of detected units. Each row displays the firing rate of a particular unit, encoded by the grey-scale to the right (1 s bins). (<bold>B</bold>) The average firing rate of the network (black) and the target firing rate (red) and the error signal during different control periods. The target firing rate was moved up and down manually by the experimenter via mouse clicks on NeuroRighter's graphical interface for the duration of the 5-min control epoch. (<bold>C</bold>) Optical control signals delivered by the PI controller during the control epoch.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.008">http://dx.doi.org/10.7554/eLife.07192.008</ext-link></p></caption><graphic xlink:href="elife-07192-fig2-figsupp2-v1.tif"/></fig><fig id="fig2s3" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.009</object-id><label>Figure 2—figure supplement 3.</label><caption><title>Effects of proportional gain (<italic>K</italic>) on closed-loop stability of PI control in vitro.</title><p>(<bold>A</bold>) The network firing rate is shown during control using different values of <italic>K</italic> (<italic>T</italic><sub><italic>i</italic></sub> = 1.0 s and <italic>τ</italic> = 2.5 s). Different values of <italic>K</italic> were used in random order and correspond to the colors shown in (<bold>C</bold>). Firing rates were calculated using a bin size of 1 s instead of the exponential moving average used by controller (<xref ref-type="disp-formula" rid="equ1">Equation 1</xref>) to facilitate comparison with <xref ref-type="fig" rid="fig2s5">Figure 2—figure supplement 5</xref> since the firing-rate filter time constant is manipulated in that experiment. (<bold>B</bold>) The median network firing rate (black lines) is shown with the interquartile range (colored bars) taken over each firing rate time series. Values of <italic>K</italic> greater than ∼1 cause the controller to become unstable, leading to large firing rate variance. (<bold>C</bold>) Firing rasters for individual units along with corresponding control signals for all values of <italic>K</italic> tested. Ineffective values of <italic>K</italic> are printed in red. (<bold>D</bold>) Mean control signals ± standard deviation over time.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.009">http://dx.doi.org/10.7554/eLife.07192.009</ext-link></p></caption><graphic xlink:href="elife-07192-fig2-figsupp3-v1.tif"/></fig><fig id="fig2s4" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.010</object-id><label>Figure 2—figure supplement 4.</label><caption><title>Effects of integral time-constant (<italic>T</italic><sub><italic>i</italic></sub>) on closed-loop stability and accuracy of PI control in vitro.</title><p>(<bold>A</bold>) The network firing rate is shown during control using different values of <italic>T</italic><sub><italic>i</italic></sub> (<italic>K</italic> = 0.1 and <italic>τ</italic> = 2.5 s). Different values of <italic>T</italic><sub><italic>i</italic></sub> were used in random order and correspond to the colors shown in (<bold>C</bold>). Firing rates were calculated using a bin size of 1 s instead of the exponential moving average used by controller (<xref ref-type="disp-formula" rid="equ1">Equation 1</xref>) to facilitate comparison with <xref ref-type="fig" rid="fig2s5">Figure 2—figure supplement 5</xref> since the firing-rate filter time constant is manipulated in that experiment. (<bold>B</bold>) The median network firing rate (black lines) is shown with the interquartile range (colored bars) taken over each firing rate time series. Values of <italic>T</italic><sub><italic>i</italic></sub> less than ∼1 s caused the controller to become unstable, leading to large firing rate variance. Values of <italic>T</italic><sub><italic>i</italic></sub> greater than ∼25 s introduced an offset. (<bold>C</bold>) Firing rasters for individual units along with corresponding control signals for all values of <italic>T</italic><sub><italic>i</italic></sub> tested. Non-functional values of <italic>T</italic><sub><italic>i</italic></sub> are printed in red. (<bold>D</bold>) Mean control signals ± standard deviation over time.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.010">http://dx.doi.org/10.7554/eLife.07192.010</ext-link></p></caption><graphic xlink:href="elife-07192-fig2-figsupp4-v1.tif"/></fig><fig id="fig2s5" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.011</object-id><label>Figure 2—figure supplement 5.</label><caption><title>Effects of the firing-rate estimation time-constant (<italic>τ</italic>) on closed-loop stability of PI control in vitro.</title><p>(<bold>A</bold>) The network firing rate is shown during control using different values of <italic>τ</italic> (<italic>K</italic> = 0.1 and <italic>T</italic><sub><italic>i</italic></sub> = 1.0 s). Different values of <italic>τ</italic> were used in random order and correspond to the colors shown in (<bold>C</bold>). Firing rates were calculated using a bin size of 1 s so that different firing rate time-constants could be compared using a common time-scale. (<bold>B</bold>) The median network firing rate (black lines) is shown with the interquartile range (colored bars) taken over each firing rate time series. Values of <italic>τ</italic> less than ∼0.5 s caused the controller to become unstable, leading to large firing rate variance. Values of <italic>T</italic><sub><italic>i</italic></sub> greater than ∼10 s introduced large, slow oscillations that caused significant target overshoot. (<bold>C</bold>) Firing rasters for individual units along with corresponding control signals for all values of <italic>τ</italic> tested. Non-functional values of <italic>τ</italic> are printed in red. (<bold>D</bold>) Mean control signals ± standard deviation over time.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.011">http://dx.doi.org/10.7554/eLife.07192.011</ext-link></p></caption><graphic xlink:href="elife-07192-fig2-figsupp5-v1.tif"/></fig><fig id="fig2s6" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.012</object-id><label>Figure 2—figure supplement 6.</label><caption><title>PI control of firing levels during synaptic blockade in vitro.</title><p>(<bold>A</bold>) Network firing rate for different trials (colors) in the presence of various competitive neurotransmitter receptor antagonists (○ no drug, △20 μM CNQX, □50 μM AP5, ▽20 μM bicuculline). Trials were presented in a random sequence that was repeated across drug conditions. (<bold>B</bold>) Time-averaged network firing rates during PI control, for each drug tested. Spontaneous firing rates of the network during each pharmacological condition are represented by black symbols to the left of the ordinate axis. The dotted line represents perfect clamping of mean activity to the target rate. (<bold>C</bold>) RMS tracking error between the measured and target firing for each pharmacological condition as a function of the target rate. Control failure occurred for each point above the red line, which was defined as RMS tracking error &gt; 0.5 Hz/unit. CNQX, which blocks AMPARs, destabilized the network somewhat, likely though the removal of recurrent inhibition, and resulted in a control failure for the 2 Hz/unit target. AP5, which blocks NMDARs, reduced the dynamic range of evoked activity and slowed the rise-time of the population response (compare to control onset in (<bold>A</bold>)). Bicuculline, which blocks GABAARs, strongly destabilized network activity and resulted in control failure for all but two target rates: 0 and 2 Hz/unit. In the presence of bicuculline, average network firing levels could not be pushed higher than ∼2 Hz/unit. Interestingly, the only successful non-zero target rate was the one closest to the spontaneous network firing rate in the presence of bicuculline. (<bold>D</bold>) Time-averaged control signals and (<bold>E</bold>) settling times (<xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>) vs target rate for each pharmacological condition. All data in this figure are from a single culture. All temporal averages in this figure were taken over the final 30 s of the control epoch.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.012">http://dx.doi.org/10.7554/eLife.07192.012</ext-link></p></caption><graphic xlink:href="elife-07192-fig2-figsupp6-v1.tif"/></fig></fig-group></p><p>We explored the parametic sensitivity of the controller by changing the value of either the proportional gain (<italic>K</italic>), the integral-error time constant (<italic>T</italic><sub><italic>i</italic></sub>), or the firing rate filter time constant (<italic>τ</italic>), while the remaining two parameters were held at their nominal values (<italic>K</italic> = 0.1, <italic>T</italic><sub><italic>i</italic></sub> = 1 s, <italic>τ</italic> = 2.5 s). Functional control was achieved at <italic>K</italic> &lt; 1.0, 1.0 s &lt; <italic>T</italic><sub><italic>i</italic></sub> &lt;10 s, and 0.5 s &lt;<italic>τ</italic> &lt;10 s. Outside of these bounds, closed-loop dynamics were unstable and/or firing levels exhibited significant target offsets (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref> through <xref ref-type="fig" rid="fig2s5">Figure 2—figure supplement 5</xref>).</p><p>The control signals, <italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub>, were highly variable across networks, even for the same target rate (<xref ref-type="fig" rid="fig2">Figure 2C</xref>). This variability likely reflects heterogeneous network excitability, opsin expression, synaptic connectivity, and developmental processes (<xref ref-type="bibr" rid="bib51">Wagenaar et al., 2006</xref>) and suggests that the controller continuously adapts to ongoing changes in network excitability in order to precisely clamp firing levels. To test this possibility, we delivered open-loop replay of successful closed-loop control signals and found they were incapable of controlling firing (Figure 4, <xref ref-type="fig" rid="fig2">Figure 2</xref> cultures). This demonstrates the necessity of real-time feedback to achieve precise control of neural firing, even for same target rate within single preparations.</p><p>Next, we used the PI controller to clamp network firing levels to targets between 0 and 10 Hz/unit during blockade of AMPAergic and NMDAergic transmission (<xref ref-type="fig" rid="fig2s6">Figure 2—figure supplement 6A</xref>; ‘Materials and methods’). Control performance was equivalent to the drug-free case and control failure was isolated to high target rates (9–10 Hz/unit) due to stimulus saturation (<xref ref-type="fig" rid="fig2s6">Figure 2—figure supplement 6B–E</xref>). We also tested PI control during blockade of GABAergic transmission and found that reliable control was not possible (<xref ref-type="fig" rid="fig2s6">Figure 2—figure supplement 6</xref>). This is likely due to the destabilizing effects of bicuculline, which caused the controller to oscillate. This result is consistent with studies indicating a general role of reduced inhibition in diseases of circuit instability such as temporal lobe epilepsy (<xref ref-type="bibr" rid="bib22">Kobayashi and Buckmaster, 2003</xref>) and Dravet syndrome (<xref ref-type="bibr" rid="bib9">Dutton et al., 2013</xref>).</p><p>To demonstrate PI control over more extended time periods, we clamped firing at a set of randomly selected, 5-min long target firing levels which switched without downtime (50 min. total clamp time; <xref ref-type="fig" rid="fig3">Figure 3</xref>). During each 5-min step, the controller made rapid, second-to-second adjustments in stimulus intensity to maintain the instantaneous target rate, while slower changes in stimulus intensity occurred over minutes. Minute-to-minute changes in the control signal intensity likely reflect short-term synaptic depression and changes in cellular excitability that accrued over each control epoch. Therefore, the control signal can be used as a readout of network excitability, analogous to how injected current from a voltage clamp amplifier can be used to asses cellular excitability.<fig id="fig3" position="float"><object-id pub-id-type="doi">10.7554/eLife.07192.013</object-id><label>Figure 3.</label><caption><title>PI feedback control to track a changing target rate.</title><p>(<bold>A</bold>) Firing rate of detected units. Each row displays the firing rate of a particular unit, encoded by the grey-scale to the right (1 s bins). (<bold>B</bold>) The average firing rate of the network (black), the target firing rate (red), and the error signal during different control periods. The pre-control firing rate is indicated by a dotted line. (<bold>C</bold>) Optical control signals delivered by the PI controller during the control epoch.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.013">http://dx.doi.org/10.7554/eLife.07192.013</ext-link></p></caption><graphic xlink:href="elife-07192-fig3-v1.tif"/></fig></p><p>To test how different stimulus waveforms affected network response correlations during PI control, we mapped <italic>U</italic><sub>C</sub> onto triangular, sinusoidal, pseudorandom binary sequence (PRBS), and direct intensity modulation inputs (<xref ref-type="bibr" rid="bib46">Tchumatchenko et al., 2013</xref>). Each permitted successful closed-loop control, but notably, the choice of stimulus waveform significantly affected the peak firing correlation (<italic>P</italic> = 6.5 × 10<sup>−24</sup>) and synchrony (<italic>P</italic> = 10<sup>−22</sup>) of the population response (<xref ref-type="fig" rid="fig4">Figure 4</xref>). The square pulse trains typically used for ChR2-based stimulation (<xref ref-type="bibr" rid="bib25">Mattis et al., 2011</xref>) resulted in periodic, highly correlated population firing (<xref ref-type="fig" rid="fig4">Figure 4A</xref>). Compared to square pulses, sinusoidal stimuli decreased peak unit-to-unit firing correlations (−10.6%, p = 0.028), but did not affect synchrony. PRBS stimuli reduced peak correlations (−24.0%, p = 6.8 × 10<sup>−13</sup>) and firing synchrony (−17.9%, p = 4.6 × 10<sup>−8</sup>). Continuous light modulation increased both correlations (+21.3%, p = 4.3 × 10<sup>−5</sup>) and synchrony (+41.4%, p = 2.5 × 10<sup>−9</sup>). Triangular pulses did not affect correlation or synchrony. Importantly, while periodic input signals produced a periodic response, PBRS input and continuous intensity modulation resulted in non-periodic firing. Therefore, altering the temporal characteristics of excitatory stimulus waveforms resulted in remarkably different higher-order firing statistics while still enabling successful PI control. This emphasizes the fact that, in its current form, the optoclamp only controls population firing levels and leaves more complex features of neural activity unconstrained and subject to the influence of network connectivity, network dynamics, and the nature of the stimulus signal.<fig id="fig4" position="float"><object-id pub-id-type="doi">10.7554/eLife.07192.014</object-id><label>Figure 4.</label><caption><title>A diverse set of optical input signals can be used to clamp network firing rate, and accurate firing rate control requires closed-loop stimulation.</title><p>(<bold>A</bold>) <italic>Left</italic>, network firing rates during closed-loop control (black) and during replay of closed-loop control signals in open-loop (grey), along with corresponding control inputs <italic>U</italic><sub><italic>C</italic></sub> (blue) and <italic>U</italic><sub><italic>H</italic></sub> (yellow). These time series data were derived from culture 1. Note that in all instances, open-loop replay of input signals recorded from previous successful closed-loop control failed to clamp firing levels and resulted in erratic activity levels over the control epoch. <italic>Middle</italic>, time-averaged firing rates for both cultures during closed-loop control (black) and during subsequent replay of control signals in open-loop (grey). <italic>Right</italic>, average unit-to-unit cross-correlogram for both cultures (top, bin = 5 ms) and unit-to-unit synchronization structure for culture 1 (bottom) during optogenetic feedback control. Synchronization was defined as,<disp-formula id="equ17"><mml:math id="m17"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Sync</mml:mtext></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>N</mml:mi><mml:mrow><mml:mi>c</mml:mi><mml:mi>c</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msqrt><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msubsup><mml:mi>N</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>+</mml:mo><mml:msubsup><mml:mi>N</mml:mi><mml:mi>j</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>/</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:msqrt></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <italic>N</italic><sub><italic>cc</italic></sub> is number of correlated events within ± 10 ms, and <italic>N</italic><sub><italic>i</italic></sub> and <italic>N</italic><sub><italic>j</italic></sub> are the number of spikes from units <italic>i</italic> and <italic>j</italic> used to calculated the cross-correlogram.</p><p>(<bold>B</bold>) Same as (<bold>A</bold>) for triangle optical stimuli modulated according to.<disp-formula id="equ18"><mml:math id="m18"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Pulse freq</mml:mtext><mml:mo>.</mml:mo></mml:mrow><mml:mrow><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>10</mml:mn><mml:mtext> Hz</mml:mtext><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula><disp-formula id="equ19"><mml:math id="m19"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Rising slope</mml:mtext><mml:mo>.</mml:mo></mml:mrow><mml:mrow><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>.</mml:mo><mml:mn>22</mml:mn><mml:mtext> </mml:mtext><mml:mfrac><mml:mrow><mml:mtext>mW</mml:mtext></mml:mrow><mml:mrow><mml:mtext>ms</mml:mtext><mml:mo>·</mml:mo><mml:msup><mml:mrow><mml:mtext>mm</mml:mtext></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula><disp-formula id="equ20"><mml:math id="m20"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Peak power</mml:mtext></mml:mrow><mml:mrow><mml:mtext> </mml:mtext><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>13</mml:mn><mml:mo>.</mml:mo><mml:mn>4</mml:mn><mml:msub><mml:mi>U</mml:mi><mml:mtext>C</mml:mtext></mml:msub><mml:mtext> </mml:mtext><mml:mfrac><mml:mrow><mml:mtext>mW</mml:mtext></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mtext>mm</mml:mtext></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>(<bold>C</bold>) Same as (<bold>A</bold>) for sinusoidal optical stimuli modulated according to.<disp-formula id="equ21"><mml:math id="m21"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Optical power</mml:mtext></mml:mrow><mml:mrow><mml:mtext> </mml:mtext><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>13</mml:mn><mml:mo>.</mml:mo><mml:mn>4</mml:mn><mml:msub><mml:mi>U</mml:mi><mml:mtext>C</mml:mtext></mml:msub><mml:mtext>sin</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:mn>10</mml:mn><mml:mi>t</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mtext> </mml:mtext><mml:mfrac><mml:mrow><mml:mtext>mW</mml:mtext></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mtext>mm</mml:mtext></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>(<bold>D</bold>) Same as (<bold>A</bold>) for pseudo-random binary sequence of optical pulses modulated according to.<disp-formula id="equ22"><mml:math id="m22"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Update freq</mml:mtext><mml:mo>.</mml:mo></mml:mrow><mml:mrow><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>150</mml:mn><mml:mtext> Hz</mml:mtext><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula><disp-formula id="equ23"><mml:math id="m23"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Peak power</mml:mtext></mml:mrow><mml:mrow><mml:mtext> </mml:mtext><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>13</mml:mn><mml:mo>.</mml:mo><mml:mn>4</mml:mn><mml:msub><mml:mi>U</mml:mi><mml:mtext>C</mml:mtext></mml:msub><mml:mtext> </mml:mtext><mml:mfrac><mml:mrow><mml:mtext>mW</mml:mtext></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mtext>mm</mml:mtext></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>(<bold>E</bold>) Same as (<bold>A</bold>) for continuous optical stimuli modulated according to.<disp-formula id="equ24"><mml:math id="m24"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Optical power</mml:mtext></mml:mrow><mml:mrow><mml:mtext> </mml:mtext><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>13</mml:mn><mml:mo>.</mml:mo><mml:mn>4</mml:mn><mml:msub><mml:mi>U</mml:mi><mml:mtext>C</mml:mtext></mml:msub><mml:mtext> </mml:mtext><mml:mfrac><mml:mrow><mml:mtext>mW</mml:mtext></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mtext>mm</mml:mtext></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>Each protocol was performed in the same culture.</p><p>Periodic stimuli (panels <bold>A</bold>–<bold>C</bold>) were applied at 10 Hz so that the periodicity of evoked activity would be apparent in the correlation functions. In all cases, the 590 nm light was modulated according the standard control scheme (<xref ref-type="disp-formula" rid="equ10">Equation 10</xref> of ‘Materials and methods’). Note that each input type evokes a unique correlation and synchronization structure while still achieving accurate firing rate control.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.014">http://dx.doi.org/10.7554/eLife.07192.014</ext-link></p></caption><graphic xlink:href="elife-07192-fig4-v1.tif"/></fig></p></sec><sec id="s2-3"><title>Multi-hour control of firing rates</title><p>Planar MEAs allow stable extracellular recordings over long timescales. Previous studies have used MEAs to monitor spiking activity over many hours and correlated recorded activity with homeostatic or developmental changes in network properties (<xref ref-type="bibr" rid="bib51">Wagenaar et al., 2006</xref>; <xref ref-type="bibr" rid="bib27">Minerbi et al., 2009</xref>). Compared to simply measuring spiking activity, controlling mean firing rates over long timescales would enable investigations of causal, rather than correlative, relationships between spiking and long-term, activity-dependent processes.</p><p>To this end, we developed an ‘on-off’ controller to clamp network activity across many hours. To clamp firing rates above spontaneous levels, this controller delivered a blue light pulse (5 ms, 13.4 mW mm<sup>−2</sup>, 465 nm) when the integral error exceeded zero (<xref ref-type="disp-formula" rid="equ12">Equation 12</xref>). We tested on-off control by clamping network firing rates within a single culture to seven elevated setpoints (ranging from 0.75 to 6 Hz/unit) for 12-hr epochs (<xref ref-type="fig" rid="fig5">Figure 5</xref>). The on-off controller successfully held firing rates at six of these targets, saturating only at 6 Hz/unit after ∼7 hr (<xref ref-type="fig" rid="fig5">Figure 5A,B</xref>). Notably, the stimulation frequency required to maintain each target firing rate was better correlated to the difference between the target and the pre-clamp firing rate than the target rate alone (R<sup>2</sup> = 0.63 vs 0.52; <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1</xref>). This indicates that alterations in network excitability across different experimental days were reflected in the intensity of the control inputs (<xref ref-type="fig" rid="fig5">Figure 5C,D</xref>; <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1A</xref>) and suggests that optogenetic feedback control can be used to study changes in neuronal network dynamics over developmental timescales.<fig-group><fig id="fig5" position="float"><object-id pub-id-type="doi">10.7554/eLife.07192.015</object-id><label>Figure 5.</label><caption><title>On-off feedback control of population firing rate over 12-hr epochs.</title><p>(All data presented in this figure were obtained from a single culture over the course of ∼3 weeks.) (<bold>A</bold>) Firing rates of detected units during 12-hr control periods are represented using the grey-scale to the right. At time 0, the on-off controller was engaged and the average network rate was clamped firing to the target rate indicated to the left of each chart. The day and hour of each protocol, relative to the first experiment, is shown to the right. Units are sorted by their mean firing rate during the 3-hr period prior to closed-loop control. (<bold>B</bold>) The network firing rate during each control epoch (5-min bins). The color map corresponds to the target rates shown in (<bold>A</bold>). (<bold>C</bold>) Closed-loop stimulation frequency over the course of the 12-hr clamp. For a target rate of 6 Hz/unit, the controller saturated at the maximal frequency of 10 Hz at around 7 hr into the control epoch, and target tracking failed as a result. (<bold>D</bold>) Time- and unit-averaged firing rates (colors, left axis) and control signal (black, right axis) across each 12-hr clamping period. The dotted line is identity. (<bold>E</bold>) The average cross-correlation function between 30 randomly selected units during on-off or PI control are plotted for each target rate. The correlation function for spontaneous activity is shown in black. When low stimulation frequencies were required, the unimodal correlation structure of spontaneous activity was preserved using on-off control.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.015">http://dx.doi.org/10.7554/eLife.07192.015</ext-link></p></caption><graphic xlink:href="elife-07192-fig5-v1.tif"/></fig><fig id="fig5s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.016</object-id><label>Figure 5—figure supplement 1.</label><caption><title>Characteristics of on-off control over weeks in vitro.</title><p>(<bold>A</bold>) Spontaneous, pre-stimulation firing rates over the course of 7 long-term excitatory on-off control experiments with a single culture. Spontaneous excitability changes smoothly across the ∼20 days during which 12-hr firing rate control experiments were conducted. (<bold>B</bold>) The average stimulation frequency required to achieve firing rate control is plotted against the target rate (○) and the difference between the target rate the pre-stimulation spontaneous firing level (●). A linear fit is improved when the spontaneous excitability is taken into account, indicating that ongoing changes in network excitability influence the intensity of stimulation required to achieve firing rate control. (<bold>C</bold>) The spontaneous firing rate before each 12-hr protocol vs the spontaneous firing rate following each protocol exhibits a strong linear relationship (black line) that is not significantly different from identity (dashed line). This indicates the <italic>absence</italic> of a homeostatic decrease in network activity that might have resulted from chronically elevated firing levels in the absence of pharmacological agents.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.016">http://dx.doi.org/10.7554/eLife.07192.016</ext-link></p></caption><graphic xlink:href="elife-07192-fig5-figsupp1-v1.tif"/></fig><fig id="fig5s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.017</object-id><label>Figure 5—figure supplement 2.</label><caption><title>In vitro inhibitory on-off control using Arch3.0.</title><p>(<bold>A</bold>) Summary of unit spiking activity. (<italic>Top</italic>) Rastergrams show zoomed portions of spiking activity taken from the pre-clamp, clamp, and post-clamp periods of the experiment. Arrows indicate the time during the experiment that each reastergram was derived from. (<italic>Bottom</italic>) Firing rate histogram for the duration of the 7-hr recording for each unit, using 5-min bins. Firing levels are indicated by the grey-scale to the right. (<bold>B</bold>) Summary of network firing rates and the corresponding control signal. (<bold>B.i</bold>) Network firing rate calculated using 1 s bins and (<bold>B.ii</bold>) 5-min bins. The red line indicates the 0.75 Hz/unit target rate. (<bold>B.iii</bold>) Raw on-off control waveform. (<bold>B.iv</bold>) On-to-off transition frequency histogram calculated using 5-min bins. (<bold>C</bold>) Time-averaged firing rates for each epoch of the experiment with numerical values written above the bars. Note that post-clamp firing levels did not show a homeostatic increase due to 3-hr of firing rate suppression. (<bold>D</bold>) Average unit-to-unit spike correlogram during the pre-clamp and clamp period. Note that the correlation time and structure were very similar in both conditions. The correlogram derived from the clamp period appears to be a scaled version of the pre-clamp correlogram due to decreased firing levels.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.017">http://dx.doi.org/10.7554/eLife.07192.017</ext-link></p></caption><graphic xlink:href="elife-07192-fig5-figsupp2-v1.tif"/></fig></fig-group></p><p>To clamp firing rates below spontaneous levels, the on-off controller delivered continuous yellow light (∼11 mW mm<sup>−2</sup>, 590 nm) when the integral error signal fell below zero (<xref ref-type="disp-formula" rid="equ13">Equation 13</xref>; ‘Materials and methods’). Because chronic activation of eNpHR-3.0 produced relatively weak photocurrents and induced a depolarizing shift in the chloride reversal potential (<xref ref-type="bibr" rid="bib38">Raimondo et al., 2012</xref>), we found that it was inadequate for long-term control. For this reason, archaerhodopsin-3.0 (Arch-3.0) was used for multi-hour firing rate suppression (<xref ref-type="bibr" rid="bib4">Chow et al., 2010</xref>; <xref ref-type="bibr" rid="bib25">Mattis et al., 2011</xref>) (‘Materials and methods’). To validate this strategy, we clamped a culture's spiking activity to ∼60% of its spontaneous firing rate (from 1.23 to 0.75 Hz/unit) over a 3-hr epoch (<xref ref-type="fig" rid="fig5s2">Figure 5—figure supplement 2</xref>).</p><p>The on-off and PI control schemes have distinct advantages and disadvantages. PI control provided rapid response times and low RMS error over small time windows, but imposed strong, short timescale (∼50 ms) response correlations between units (<xref ref-type="fig" rid="fig5">Figure 5C</xref>; <xref ref-type="fig" rid="fig4">Figure 4</xref>). This correlation structure contrasts the aperiodic, network bursting activity that is a common feature of developing neural circuits in vivo and in vitro (<xref ref-type="bibr" rid="bib33">O'Donovan et al., 1998</xref>; <xref ref-type="bibr" rid="bib10">Feller, 1999</xref>; <xref ref-type="bibr" rid="bib51">Wagenaar et al., 2006</xref>). We found that both excitatory and inhibitory on-off control were better able to preserve spontaneous activity correlations than PI control (<xref ref-type="fig" rid="fig5">Figure 5E</xref>; <xref ref-type="fig" rid="fig5s2">Figure 5—figure supplement 2C</xref>). However, for targets that required higher excitatory stimulation rates during on-off control, a periodic correlation structure emerged (<xref ref-type="fig" rid="fig5">Figure 5E</xref>).</p></sec><sec id="s2-4"><title>Using on-off control to reveal the direct role of neurotransmission in regulation of network excitability</title><p>Previous in vitro studies have shown that chronic elevation in network activity using GABAergic transmission blockers leads to a homeostatic reduction in firing rate following relief from blockade (<xref ref-type="bibr" rid="bib47">Turrigiano et al., 1998</xref>). Conversely, chronic reductions in activity using glutamatergic blockers elicit homeostatic increases in firing rate (<xref ref-type="bibr" rid="bib6">Corner et al., 2002</xref>). Interestingly, we did not observe homeostatic changes in firing rate following prolonged increases or decreases in network spiking activity during on-off feedback control (<xref ref-type="fig" rid="fig5">Figure 5</xref>; <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1C</xref> and <xref ref-type="fig" rid="fig5s2">Figure 5—figure supplement 2B</xref>). This suggests that altered synaptic transmission and altered spiking activity may have distinct effects on homeostatic regulation of network excitability.</p><p>To test this possibility, we used on-off control to decouple the effects of prolonged glutamatergic or GABAergic blockade from changes in firing rate. We treated networks with CNQX (2 cultures), AP5 (2 cultures), or bicuculline (1 culture), and then used on-off control to restore pre-drug firing rates during 24-hr (CNQX or AP5) or 3-hr (bicuculline) periods. In all cases, the controller effectively clamped firing rates to pre-drug levels (<xref ref-type="fig" rid="fig6">Figure 6A.v,B.v,C.v</xref>). 10 min of activity were recorded in the presence of each drug just before and after each clamp period. As expected, application of CNQX or AP5 caused marked reductions in network spiking activity compared to the pre-drug levels and these reduced activity levels were sustained upon relief from on-off control (<xref ref-type="fig" rid="fig6">Figure 6A.v,B.v)</xref>. Meanwhile, bicuculline greatly increased firing rate, both before and after the clamp period (<xref ref-type="fig" rid="fig6">Figure 6C.v</xref>).<fig id="fig6" position="float"><object-id pub-id-type="doi">10.7554/eLife.07192.018</object-id><label>Figure 6.</label><caption><title>Decoupling spiking and neurotransmission using on-off feedback control.</title><p>(<bold>A</bold>) Summary of a 24-hr AMPAergic neuortransmission/spiking decoupling protocol. (<bold>A.i</bold>) Rastergrams show zoomed portions of spiking activity taken from discrete times during the experiment. Top color bars indicates recording epoch. Blue bars beneath indicate stimulus times. Horizontal scale bar, 1 s (<bold>A.ii</bold>) Firing rate histogram for the duration of the 33-hr recording for each unit, using 5-min bins. Firing levels are indicated by the grey-scale to the right. CNQX (AMPAergic receptor antagonist) was added at time 0 and removed 24 hr and 10 min later. Closed-loop stimulation began 5 min after CNQX addition and lasted 24 hr. Colored boxes indicate the location of the data used in the zoomed rastergrams, crosscorrelograms, and burst profiles. (<bold>A.iii</bold>) The average unit firing rate using 1-s bins and 5-min bins. The red line indicates the target rate. (<bold>A.iv</bold>) Closed-loop stimulation frequency. (<bold>A.v</bold>) Time- and unit-averaged firing rates for each epoch, normalized to the pre-drug firing level. The ‘post’ firing rate was evaluated over 6 hr following the drug wash. (<bold>A.vi</bold>) The average unit to unit crosscorrelogram for each control epoch. (<bold>A.vii</bold>) Example burst ratergrams, average burst profiles, and burst-triggered stimulus optical intensity for each control epoch. The location of the data used to calculate (<bold>A.vi</bold>) and (<bold>A.vii</bold>) is indicated by the matching colored boxes in (<bold>A.ii</bold>). (<bold>B</bold>, <bold>C</bold>) Same as (<bold>A</bold>) but using AP5 (<bold>B</bold>) or bicuculline (<bold>C</bold>) to block NMDAergic and GABAergic neurotransmission, respectively. For bicuculline, the firing rate was clamped over a 3 hr period. The changes in spontaneous firing levels before on-off control for each culture were: CNQX, −93.8 and −56.3%; AP5, −87.3 and −84.5%; bicuculline, +116.2%, and upon relief from on-off control: CNQX, −78.7 and −80.0%; AP5, −73.0 and −80.4%; bicuculline: +81.3%.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.018">http://dx.doi.org/10.7554/eLife.07192.018</ext-link></p></caption><graphic xlink:href="elife-07192-fig6-v1.tif"/></fig></p><p>The mean stimulation frequency remained low during excitatory on-off control in the presence of CNQX or AP5 (<xref ref-type="fig" rid="fig6">Figure 6A.iv,B.iv</xref>); CNQX: 0.72 and 0.19 Hz, AP5: 0.21 and 0.71 Hz). For CNQX, pre-drug network activity correlations and burst shape were largely maintained during on-off control (<xref ref-type="fig" rid="fig6">Figure 6A.vi–vii</xref>). For AP5, the unit-to-unit correlation time and burst duration were shorter than pre-drug levels (<xref ref-type="fig" rid="fig6">Figure 6B.vi–vii</xref>). This is likely due to the prominent role of NMDA receptors in signal propagation in dissociated cortical networks (<xref ref-type="bibr" rid="bib30">Nakanishi and Kukita, 1998</xref>). Following drug removal, spontaneous firing was elevated compared to pre-drug levels (CNQX: +86.4 and +21.1%, AP5: +157.4 and +273.3%).</p><p>Inhibitory on-off control using Arch3.0 was used to clamp firing to pre-drug levels during bicuculline treatment (‘Materials and methods’). Bicuculline greatly increased network firing correlations and burst duration compared to spontaneous activity levels. During the clamp epoch, ‘on’ to ‘off’ control transitions reliably triggered large rebound bursts. A rapid closed-loop response truncated rebound bursts via reactivation of Arch-3.0 (<xref ref-type="fig" rid="fig6">Figure 6C.vi–vii</xref>). After washing bicuculline, firing was reduced by 47.2% compared to pre-drug levels.</p><p>Notably, homeostatic changes in spiking levels were observed following prolonged glutamatergic or GABAergic blockade even though network firing rates were maintained at pre-drug levels during the treatment windows. This indicates that changes in firing rate were not required to drive compensatory alterations in network excitability. Instead, homeostatic alterations of network excitability were triggered directly by suppressed synaptic activity. In line with this result, on-off control has recently been used to show that upward synaptic scaling, the most widely studied form of homeostatic plasticity, is directly induced via reductions in AMPA receptor activation (<xref ref-type="bibr" rid="bib12">Fong et al., 2015</xref>).</p></sec><sec id="s2-5"><title>Control of single unit activity during ongoing sensory perturbations, in vivo</title><p>We next evaluated the functionality of optogenetic feedback control in the intact rodent brain. The rat vibrissal pathway is a widely studied model of sensory information transduction due to its well defined discrete feed-forward anatomy. Recent findings have revealed the importance of network activity state for gating sensory information in thalamic networks (<xref ref-type="bibr" rid="bib17">Halassa et al., 2014</xref>). We used optogenetic feedback to control background firing state in single units of the ventral posteromedial nucleus (VPm) in anesthetized rats during ongoing vibrissa stimulation. Extracellular recordings of ChR2-expressing thalamocortical units (TCUs) were used to update an integral controller (<xref ref-type="disp-formula" rid="equ15">Equation 15</xref>) (parameters: <italic>T</italic><sub><italic>i</italic></sub> = 1 s, <italic>τ</italic> = 0.8 s), which determined the continuous intensity of 470 nm light delivered to VPm using an optical fiber (<xref ref-type="fig" rid="fig7">Figure 7A</xref>; ‘Materials and methods’).<fig-group><fig id="fig7" position="float"><object-id pub-id-type="doi">10.7554/eLife.07192.019</object-id><label>Figure 7.</label><caption><title>Firing rate control of isolated thalamic units, in vivo.</title><p>(<bold>A</bold>) Single unit extracellular recordings were performed in thalamic VPm and used to update the optical power of the LED stimulator. The primary vibrissa could be deflected along the rostral–caudal plane using a galvanometer-based scanning motor to provide sensory perturbations during closed-loop control. A representative TCU waveform is shown (black line is the mean and the shaded region is ± 1 SD). Vertical and horizontal scale bars represent 100 μV and 1 ms, respectively. (<bold>B</bold>) Single-trial closed-loop firing rate control in the absence of sensory input. Traces show the target firing rate (red), measured firing rate (black), and light power (blue). Inset spike trains display 1 s of activity for each target rate. (<bold>C</bold>) Time-averaged firing rates vs target rates for 10 TCUs (symbols). Data points are color coded according to the target rate. Black symbols at left indicate spontaneous firing levels prior of closed-loop control. Grey symbols indicate control failure. Data points derived from a single TCU are connected with a line. Shaded areas are peak-normalized histograms of spontaneous firing rates (black) and successfully controlled firing rates (blue) across units. (<bold>D</bold>) RMS tracking error for each target rate. (<bold>E</bold>) Average light power required for each target rate. (<bold>F</bold>) Mean vs standard deviation of the ISI distribution for each target rate. The dotted identity line indicates Poisson firing statistics. Inset bar chart shows the mean CV<sub>ISI</sub> across units during spontaneous and clamped firing. *p = 0.043; <italic>t</italic>-test.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.019">http://dx.doi.org/10.7554/eLife.07192.019</ext-link></p></caption><graphic xlink:href="elife-07192-fig7-v1.tif"/></fig><fig id="fig7s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.020</object-id><label>Figure 7—figure supplement 1.</label><caption><title>Open-loop application of precisely defined optical stimuli results in highly variable, non-stationary evoked firing levels in the intact rat vibrissa system.</title><p>(<bold>A</bold>) Continuous, 30-s optical stimuli (blue bar) of linearly increasing intensity across trials (scale bar at right) were applied to 13 TCUs. Although evoked firing, as measured by the optrode in VPm thalamus, tended to increase monontonically with light power (as indicated by the preservation of color ordering in the time-series overlay), evoked firing was non-stationary and highly variable during each 30-s stimulation epoch. (<bold>B</bold>) Time-averaged evoked firing rates were highly variable for a given light intensity across TCUs, reflecting differences in channel expression, depth of anesthesia, and other uncontrolled variables affecting neuronal excitability.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.020">http://dx.doi.org/10.7554/eLife.07192.020</ext-link></p></caption><graphic xlink:href="elife-07192-fig7-figsupp1-v1.tif"/></fig><fig id="fig7s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.021</object-id><label>Figure 7—figure supplement 2.</label><caption><title>Continuous real-time update of optical intensity is required for accurate firing rate control in the intact rat vibrissa system.</title><p>(<bold>A</bold>) 15 s into each 30-s control epoch, the control signal (blue) was locked at its most recent value. (<italic>Top</italic>) The firing rate of a single TCU, encoded by the scalebar at right, is shown for 10 control trials (columns). (<italic>Middle</italic>) The trial-averaged firing rate (black) line, and target rate (red line). Dotted lines indicate ± standard deviation. Bin size, 1 s (<italic>Bottom</italic>) Trial-averaged optical control signal. Shading indicates ± standard deviation. (<italic>Right</italic>) The RMS tracking error during functional integral control and during the locking period are shown for 6 TCUs (symbols). Black symbols represent individual trials and red symbols are trial-averages. Red lines connect means derived from the same unit. The rightmost column indicates the percent change in RMS tracking error during the control lock compared to the functioning integral control for each trial. The mean RMS error increased 204 ± 227% during the locking period compared to integral control (*** p = 1.07 × 10<sup>−15</sup>, Wilcoxon signed-rank test). (<bold>B</bold>) Same as (<bold>A</bold>) except that the control signal was locked at the average value taken during the first 15 s of control. The mean RMS tracking error increased 240 ± 145% during the locking period compared to integral control (*** p = 1.25 × 10<sup>−17</sup>, Wilcoxon signed–rank test).</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.021">http://dx.doi.org/10.7554/eLife.07192.021</ext-link></p></caption><graphic xlink:href="elife-07192-fig7-figsupp2-v1.tif"/></fig><fig id="fig7s3" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.022</object-id><label>Figure 7—figure supplement 3.</label><caption><title>Effects of firing-rate filter time-constant (<italic>τ</italic>) and integral time-constant (<italic>T</italic><sub><italic>i</italic></sub>) on performance of integral control in vivo.</title><p>(<bold>A</bold>) The firing rate was controlled in three TCUs using 3 different values of <italic>τ</italic>: 0.16 s, 0.8 s (nominal), and 1.6 s (<italic>Top</italic>) The firing rate of a single unit, encoded by the scalebar at right, is shown for 10 optoclamp trials (rows). (<italic>Middle</italic>) The trial-averaged firing rate (black) line, and target rate (red line). Dotted lines indicate ± standard deviation. Bin size, 1 s (<italic>Bottom</italic>) Trial-averaged optical control signal. Shading indicates ± standard deviation. (<italic>Right</italic>) The RMS tracking error during integral control for each value of <italic>τ</italic> is shown for each unit (symbols). Black symbols represent individual trials and red symbols are trial-averages. Red lines connect means derived from the same unit. *p = 0.010, **p = 1.4 × 10<sup>−6</sup>, and ***p = 1.2 × 10<sup>−10</sup>. (<bold>B</bold>) Same as (<bold>A</bold>) except that firing rate was controlled in two TCUs using 3 different values of <italic>T</italic><sub><italic>i</italic></sub>: 0.1 s, 1.0 s (nominal), and 10 s. *p = 0.019. For both (<bold>A</bold>) and (<bold>B</bold>), a Kruskal–Wallis one-way analysis of variance was followed by post-hoc Mann–Whitney U tests, using a Bonferroni correction to control the familywise error rate. Adjusted p values are reported.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.022">http://dx.doi.org/10.7554/eLife.07192.022</ext-link></p></caption><graphic xlink:href="elife-07192-fig7-figsupp3-v1.tif"/></fig></fig-group></p><p>We used optogenetic feedback to clamp firing rates in TCUs at increasing target levels for 30-s epochs (<xref ref-type="fig" rid="fig7">Figure 7B</xref>). For &gt; 75% of TCUs, the controller effectively clamped firing over a range of target rates, which varied across cells (e.g., 4–40 Hz vs 18–22 Hz; <xref ref-type="fig" rid="fig7">Figure 7C</xref>). As in our in vitro PI experiments, the RMS tracking error trended upward with increasing target rates (<xref ref-type="fig" rid="fig7">Figure 7D</xref>). Because firing rate estimates were derived from single cells instead of population activity, the RMS tracking error was larger than for in vitro control (mean ± SD, 2.0 ± 0.8 Hz). Controller settling time was not correlated to the target firing rate and was shorter than for in vitro control (mean ± SD, 3.3 ± 3.2 s).</p><p>The optical power required for successful control varied greatly from cell to cell (<xref ref-type="fig" rid="fig7">Figure 7E</xref>). For instance, the mean optical intensity required for successful control at 16 Hz, the most widely achieved target in our sample, spanned nearly two orders of magnitude (0.66–22.92 mW mm<sup>−2</sup>; <xref ref-type="fig" rid="fig7">Figure 7E</xref>). This suggests that open-loop optical stimuli would not result in consistent firing rates. Indeed, we found that linear increases in optical intensity resulted in extremely variable and temporally non-stationary firing over trials and units (<xref ref-type="fig" rid="fig7s1">Figure 7—figure supplement 1</xref>). Further, we examined whether successful control could be achieved by locking the stimulator at a static optical power once the controller stabilized. Halfway through each 30-s trial we locked the light signal either at the last output taken by the controller or the average control signal during first half of the trial (6 TCUs; <xref ref-type="fig" rid="fig7s2">Figure 7—figure supplement 2</xref>). Locking optical power at the mid-trial or trial-averaged level significantly increased RMS tracking error (+204 ± 227% and +238 ± 145%, respectively, p &lt; 10<sup>−14</sup> for both). This indicates that continuous stimulus updates are required to exert precise control over neural activity in vivo.</p><p>Next we examined how changes to the firing rate filter time-constant, <italic>τ</italic>, or the integral time-constant, T<sub><italic>i</italic></sub> affected control performance (<xref ref-type="fig" rid="fig7s3">Figure 7—figure supplement 3</xref>). Increasing <italic>τ</italic> (from 0.8 to 1.6 s) introduced lag into the control loop, causing overshoot, decreased stability, and a significant increase in RMS tracking error (+57%, p = 1.4 × 10<sup>−6</sup>). Conversely, lowering <italic>τ</italic> (from 0.8 to 0.16 s) decreased overshoot and significantly reduced RMS tracking error (−46.9%, p = 1.2 × 10<sup>−10</sup>). Increasing T<sub><italic>i</italic></sub> (from 1 to 10 s) did not significantly affect RMS tracking error (p = 0.088), but caused over-damping and increased controller settling time. Reducing T<sub><italic>i</italic></sub> (from 1 to 0.1 s) significantly decreased RMS tracking error (−18%, p = 0.011) and introduced overshoot during control onset. Together, these results indicate that low-latency feedback and a short integral time constant improve the performance of firing rate control in vivo. In this experiment, <italic>τ</italic> = 0.16 s and T<sub>i</sub> = 1 s gave the best performance in terms of RMS error.</p><p>In the awake animal, sensory thalamic spike trains tend to exhibit irregular firing with interval statistics close to those of a Poisson process (<xref ref-type="bibr" rid="bib36">Poggio and Viernstein, 1964</xref>). Drugs used for anesthesia have profound effects on evoked and background firing (<xref ref-type="bibr" rid="bib41">Simons et al., 1992</xref>), receptive field properties (<xref ref-type="bibr" rid="bib13">Friedberg et al., 1999</xref>), and subthreshold voltage statistics (<xref ref-type="bibr" rid="bib5">Constantinople and Bruno, 2011</xref>) in the vibrissal pathway. We calculated the coefficient of variation of the interspike interval (ISI) distribution (CV<sub>ISI</sub>) for each TCU. Across target rates and units, we found a CV<sub>ISI</sub> close to 1, indicating a Poisson-like spiking process (mean ± SD, 1.31 ± 0.33 across targets and units; <xref ref-type="fig" rid="fig7">Figure 7F</xref>). In comparison, the CV<sub>ISI</sub> of spontaneous unit activity was significantly elevated (<xref ref-type="fig" rid="fig7">Figure 7F</xref>, inset) mean ± SD, 1.72 ± 0.43; p = 0.043), likely due to an increased propensity for burst firing in sensory thalamus during anesthesia and non-alert states (<xref ref-type="bibr" rid="bib45">Stoelzel et al., 2009</xref>). This suggests that optogenetic feedback control using continuously modulated input can be used to mimic alert, Poisson-like spiking statistics in anesthetized animals.</p><p>Finally, we tested whether the controller could clamp firing during ongoing sensory drive. We recorded from TCUs that were responsive to punctate deflections of the corresponding primary vibrissa (5 TCUs, 8° at ∼1600 deg. s<sup>−1</sup>, 10 Hz; <xref ref-type="fig" rid="fig8s1">Figure 8—figure supplement 1</xref>; ‘Materials and methods’). Vibrissa deflections evoked stimulus-locked spike trains both in the presence and absence of closed-loop control (<xref ref-type="fig" rid="fig8">Figure 8</xref>, <xref ref-type="fig" rid="fig8s1">Figure 8—figure supplement 1</xref>). However, whisker stimuli resulted in little or no performance degradation of firing rate control in terms of mean TCU firing rate (<xref ref-type="fig" rid="fig8">Figure 8B</xref>; p = 0.09) or RMS tracking error (<xref ref-type="fig" rid="fig8">Figure 8C</xref>; p = 0.73) compared to control without whisker input. To maintain control during sensory stimulation, the controller automatically decreased LED stimulus intensity to accommodate sensory drive (<xref ref-type="fig" rid="fig8">Figure 8D</xref>; mean ± SD, 8.4 ± 5.34 to 4.9 ± 4.8 mW mm<sup>−2</sup>, p = 0.024).<fig-group><fig id="fig8" position="float"><object-id pub-id-type="doi">10.7554/eLife.07192.023</object-id><label>Figure 8.</label><caption><title>Using optogenetic feedback to control thalamic activity state during ongoing sensory input.</title><p>(<bold>A</bold>) Real-time control of thalamic firing levels during external sensory drive. The firing rate of a single TCU cell (grey lines: single trials; black lines, average) is shown for three interleaved protocol types: 15-s trains of whisker stimuli (yellow), 45-s closed-loop control periods in the absence of whisker input (grey), and closed-loop control during concurrent whisker stimulation (green). (<italic>Top</italic>) 10 Hz whisker deflections occurred from 15–30 s within each trial (black triangles). Inset raster plot shows spikes times for 4 trials at the onset of whisker stimulation. (<italic>Middle</italic>) TCU firing was clamped at 30 Hz (red line) for the duration of each trial. Blue lines show the optical control signal (light blue: single trials; dark blue: average). (<italic>Bottom</italic>) TCU firing was clamped at 30 Hz (red line) for the duration of each trial and whisker stimuli were delivered from 15–30 s within each trial. Horizontal scale bars on the firing rasters indicate 100 ms. (<bold>B</bold>) mean relative (measured/target) firing rates, (<bold>C</bold>) mean RMS tracking errors, and (<bold>D</bold>) mean optical power across trials and units. Values are shown for each of the 5 trial epochs indicated on the abscissa axis of each time series in (<bold>A</bold>). Error bars indicate ± SEM. (<bold>E</bold>) Spike-triggered average (STA) optical power and (<bold>F</bold>) STA whisker position for the TCU shown in (<bold>A</bold>). Note the difference in time scales between (<bold>E</bold>) and (<bold>F</bold>). (<bold>G</bold>) FWHM of the STA for each TCU across trial types. Sample sizes: 5 TCUs, 3 to 5 applications of each protocol type per unit. *p = 0.024, **p = 0.0079; Mann–Whitney U Test.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.023">http://dx.doi.org/10.7554/eLife.07192.023</ext-link></p></caption><graphic xlink:href="elife-07192-fig8-v1.tif"/></fig><fig id="fig8s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.07192.024</object-id><label>Figure 8—figure supplement 1.</label><caption><title>Spike waveforms and autocorrelograms of TCUs used for concurrent optogenetic feedback control and whisker stimulation in intact rats.</title><p>Shown for each of the 5 TCUs are the spike waveform and autocorrelogram of spiking activity during different portions of the control epoch. For the spike waveform, the thick black line represents the mean and shading is ± 1 standard deviation. The bin size used to calculate the autocorrelogram was 5 ms. The autocorrelogram histogram was normalized by the bin size and number of spikes to arrive at a firing rate.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.024">http://dx.doi.org/10.7554/eLife.07192.024</ext-link></p></caption><graphic xlink:href="elife-07192-fig8-figsupp1-v1.tif"/></fig></fig-group></p><p>Precise temporal spiking patterns carry information in the vibrissal sensory pathway (<xref ref-type="bibr" rid="bib8">Curtis and Kleinfeld, 2009</xref>; <xref ref-type="bibr" rid="bib53">Wang et al., 2010</xref>; <xref ref-type="bibr" rid="bib3">Bruno, 2011</xref>). To characterize the timescales over which the optical controller and whisker stimuli affected firing, we calculated the spike-triggered average (STA) of optical power and whisker position (<xref ref-type="fig" rid="fig8">Figure 8E,F</xref>). During concurrent whisker stimulation and closed-loop control, the full-width at half-maximum (FWHM) of the STA for optical power and whisker position differed by more than an order of magnitude, indicating that sensory input and optical control signals affected firing on distinct timescales (<xref ref-type="fig" rid="fig8">Figure 8G</xref>; mean ± SD FWHM of STA: optical power, 0.46 ± 0.2 s vs whisker position, 18.3 ± 5.5 ms, p = 0.0079). Therefore, optogenetic feedback control using continuously modulated input provides a means to control baseline firing state without distorting the fine-scale temporal structure of sensory-evoked spike trains. Punctate vibrissa stimuli rearrange spike times instead of introducing additional spikes, allowing the temporal correlations in the firing rate to dictate the downstream response rather than the magnitude of the firing rate. This effect is reminiscent of firing modulation by free air whisking in vibrissa primary sensory cortex (<xref ref-type="bibr" rid="bib8">Curtis and Kleinfeld, 2009</xref>) and contrasts the effect of pulsed optogenetic stimulation, which transiently overrides the influence of sensory input on the temporal structure of spike trains.</p></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>All previous methods involving closed-loop or activity-guided optogenetic stimulation have used a physiological measurement to trigger static optical stimuli without corrective action or modification of stimulus parameters following stimulus onset (<xref ref-type="bibr" rid="bib24">Leifer et al., 2011</xref>; <xref ref-type="bibr" rid="bib44">Stirman et al., 2011</xref>; <xref ref-type="bibr" rid="bib35">Paz et al., 2012</xref>; <xref ref-type="bibr" rid="bib23">Krook-Magnuson et al., 2013</xref>; <xref ref-type="bibr" rid="bib32">O'Connor et al., 2013</xref>; <xref ref-type="bibr" rid="bib40">Siegle and Wilson, 2014</xref>). In contrast, the optoclamp continuously updates stimulus intensity and frequency in real-time to enable precise control of neural firing in cultured networks and single cells in vivo and therefore provides a foundation for techniques aiming to achieved true closed-loop optical control of neural activity (<xref ref-type="bibr" rid="bib16">Grosenick et al., 2015</xref>). We have shown that this form of optogenetic feedback control is capable of clamping network firing rates using different stimulation protocols (<xref ref-type="fig" rid="fig4">Figure 4</xref>) and control algorithms (<xref ref-type="disp-formula" rid="equ4 equ12 equ13 equ14">Equations 4, 12, 13, 14</xref>) over a wide range of controller parameters (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref> through <xref ref-type="fig" rid="fig2s5">Figure 2—figure supplement 5</xref>, <xref ref-type="fig" rid="fig7s3">Figure 7—figure supplement 3</xref>) and timescales (<xref ref-type="fig" rid="fig2">Figure 2</xref> vs <xref ref-type="fig" rid="fig5">Figure 5</xref> through <xref ref-type="fig" rid="fig6">Figure 6</xref>). The optoclamp's ability to control firing levels even during various synaptic (<xref ref-type="fig" rid="fig6">Figure 6</xref>; <xref ref-type="fig" rid="fig2s6">Figure 2—figure supplement 6</xref>) and sensory (<xref ref-type="fig" rid="fig8">Figure 8</xref>) perturbations demonstrates its robustness and provides evidence of the method's suitability in a range of experiments. Finally, we found that even when using the same controller and target firing rate, successful control often required vastly different intensities of optical stimulation across experiments and experimental preperations (<xref ref-type="fig" rid="fig9">Figure 9</xref>). This suggests that closed-loop regulation of optical stimulation intensity may be a requirment, rather than a benefit, for evoking consistent activity levels across experiments.<fig id="fig9" position="float"><object-id pub-id-type="doi">10.7554/eLife.07192.025</object-id><label>Figure 9.</label><caption><title>A wide range of optical power was required during successful closed-loop control in vitro and in vivo.</title><p>The time-averaged power density of blue (left plot) and yellow (right plot) light vs the corresponding target firing rate is shown for all control algorithms and experimental preparations used in the paper. Lines connect data points derived from the same culture (in-vitro data) or unit (in-vivo data; note the log scales). Only successful control trials are shown. The light intensity required during closed-loop control varied across orders of magnitude and depended on the target rate, control algorithm, stimulus waveform, type of neural preparation being controlled, and variability in cell-to-cell and culture-to-culture excitability. This highlights the ability of closed-loop control to compensate for the experimental variability across preparations, equipment, and algorithms, as well as the intrinsic variability in neural circuits, to achieve a target activity level.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.07192.025">http://dx.doi.org/10.7554/eLife.07192.025</ext-link></p></caption><graphic xlink:href="elife-07192-fig9-v1.tif"/></fig></p><p>Like the optoclamp, the voltage clamp relies on a continuously updated feedback loop to control neural activity. Although the scale of neural activity controlled by these two methods differs greatly (population firing rate vs membrane potential), comparing the optoclamp to the voltage clamp is useful for illustrating the power, potential uses, and shortcomings of optogenetic feedback control in its current form, and to highlight how the technique might be extended to allow control over features of neural activity other than firing levels.</p><p>Two capabilities of the voltage clamp technique have made it a ubiquitous tool for characterizing neuronal excitability and synaptic dynamics. First, by continuously servoing the current injected into a cell in order to maintain a target membrane potential, the injected current mirrors underlying synaptic or intrinsic conductances that are difficult to measure directly. Second, because the voltage clamp can precisely control the membrane potential, it can decouple strong causal relationships that exist between the membrane voltage and other variables. For example, measuring the open-loop relationship between the membrane voltage and voltage-dependent conductances is impossible in the unclamped cell since these variables feed back onto one another. The voltage clamp breaks this circular dependence in order to systematically examine the strength of conductances at fixed voltage levels.</p><p>The optoclamp affords analogous capabilities for examining network dynamics. For instance, population-level excitability in an unclamped network must be inferred through measures of firing activity, which in turn affects network excitability. By continuously updating the intensity of optical stimulation to clamp network firing at set levels, information about network excitability and afferent input can be read directly from optical control signals (<xref ref-type="fig" rid="fig3">Figure 3C</xref>). One shortcoming of this feature is that it is difficult to identify the origin of changes in network excitability that appear in optical control signals since they result from the aggregate effect of many different processes. However, parallel limitations also exist for the voltage clamp. For example, when using voltage clamp, it can be difficult to distinguish contributions from different neurotransmitter systems and intrinsic conductances or to deduce the relationship between synaptic currents measured at the recording site vs at the site of receptor binding. Another issue with both optical clamping and the voltage clamp is that the control signal can be contaminated by non-ideal aspects of the recording or stimulation setup. For instance, opsin desensitization could affect the intensity of light required for the optoclamp to maintain firing levels. Likewise, space clamp and seal stability issues that arise during voltage clamp influence the amount of current required to hold a target membrane potential.</p><p>In the case of the voltage clamp, these issues are partially compensated for by using secondary measurements of seal quality and by employing the voltage clamp in concert with drugs or genetic manipulations that help to isolate particular synaptic and intrinsic conductances. Different neural circuits have distinct population-level dynamics, connectivity, neurotransmitter systems, cellular constituents, and opsin expression properties. Therefore, analogous to the voltage clamp, the optoclamp should be used in combination with auxiliary techniques that can compensate for imperfections in the control system and allow the mechanistic underpinnings of changes in excitability that occur during clamping to be isolated. For instance, the effects of opsin desensitization and bandwidth can be factored out of optical control signals such that the control signals accurately reflect changes in network excitability during clamping (<xref ref-type="bibr" rid="bib46">Tchumatchenko et al., 2013</xref>). Further, the optoclamp can be combined with existing pharmacological, genetic, or electrophysiological tools to isolate specific mechanisms that influence network excitability following clamping (<xref ref-type="bibr" rid="bib12">Fong et al., 2015</xref>).</p><p>In addition to providing a means to quantify network excitability, like the voltage clamp, optogenetic feedback control is capable of decoupling causally related variables of circuit activation. Using two case studies, operating on very different time-scales, we have demonstrated that the optoclamp is capable of decoupling thalamocortical cell baseline state from fine-scale sensory-evoked firing patterns in vivo (<xref ref-type="fig" rid="fig8">Figure 8</xref>) and decoupling network firing levels from various forms of neurotransmission (<xref ref-type="fig" rid="fig6">Figure 6</xref>). The former is especially relevant given recent focus on the state-dependent nature of thalamic coding (<xref ref-type="bibr" rid="bib17">Halassa et al., 2014</xref>), and the need for stimulation technologies capable of controlling non-stationary neural dynamics in order to inject meaningful sensory information into damaged circuits (<xref ref-type="bibr" rid="bib42">Stanley, 2013</xref>). Decoupling firing levels from variables to which they are normally causally intertwined can also help clarify causal relationships between firing and other factors that influence network excitability. For instance, determining the independent roles of neurotransmission and spiking on various forms of plasticity has proven challenging since manipulation of neurotransmission invariably affects spiking levels, and vice versa. To overcome this, Fong et al. recently used the optoclamp to decouple network firing levels from long-term AMPAergic neurotransmission blockade to show that upward synaptic scaling is directly triggered by reduced AMPAergic transmission without relying on changes in spiking activity (<xref ref-type="bibr" rid="bib12">Fong et al., 2015</xref>). This provides a plasticity mechanism to explain the increases in network firing levels we witnessed following long-term CNQX treatment even when firing was clamped to pre-drug levels for the duration of drug application (<xref ref-type="fig" rid="fig6">Figure 6A</xref>).</p><p>The control algorithms and technologies presented here are simple, straightforward, and widely available. Our implementations of the optoclamp are quite reliable for controlling neural activity in cultured networks and thalamic cells in vivo and the technique's simplicity lowers the barrier for its adoption. However, there are several avenues for further development of the method we have presented. For instance, we used a pre-sorting procedure to identify neurons used for real-time firing rate estimation in subsequent clamping periods. During periods of optical stimulation, neurons that were silent during the pre-sorting routine may be activated. If these cells had systematically different firing characteristics the sorted units used for firing rate estimation, then our procedure would lead to a biased estimate of network firing levels. Although we found no evidence that this was the case in our networks, the situation might differ for other neural preparations or brain regions. If this issue were to arise, spike sorting could be removed entirely and firing could be normalized by the number of recording channels, provided that the channel count is sufficiently high.</p><p>Further, the incorporation of more sophisticated activity measurement techniques, stimulation technologies, and control algorithms will enable improvements in control performance and broaden the applicability of optogenetic feedback control to different experimental contexts (<xref ref-type="bibr" rid="bib16">Grosenick et al., 2015</xref>). For example, the incorporation of spatial light modulation would allow optical inputs to be steered towards the spike initiation zones of individual cells in order to minimize light exposure (<xref ref-type="fig" rid="fig9">Figure 9</xref>) and abnormal conductances, and potentially enable complex system identification alogrithms to be introduced into the feedback loop (<xref ref-type="bibr" rid="bib16">Grosenick et al., 2015</xref>). Additionally, decreased feedback latency or the addition of predictive elements to the feedback loop may enable control over rapid sensory or motor events. There are two options to obtain accurate firing rate measures over very short timescales (e.g., that of individual whisker perturbations). The first option is to sample a very large population of neurons such that small time bins will have an adequate number of spikes for accurate estimation of population firing levels. This large population measure would need to be combined with a sub-millisecond feedback loop and opsins with extremely fast kinetics. Alternatively, if an accurate model of feedforward network dynamics could be incorporated into the controller, reliable control over fast events might be possible with a modestly sized population of cells, a slower feedback loop, and standard opsin variants. This is a viable approach in circuits for which predictive models of feedforward network dynamics are available, such as early visual, auditory, and vibrissal pathways (<xref ref-type="bibr" rid="bib54">Wu et al., 2006</xref>; <xref ref-type="bibr" rid="bib26">Millard et al., 2013</xref>), or, for which accurate input/output relationships can be deduced in situ using real-time system identification (<xref ref-type="bibr" rid="bib16">Grosenick et al., 2015</xref>). Additionally, control algorithms that incorporate models of feed-forward neural dynamics will be more capable of stabilizing firing in unstable circuits, such as epileptic networks, without total cessation of ongoing activity.</p><p>We demonstrated that optical waveforms with very different temporal characteristics could be used to successfully control population firing rate in vitro while having markedly different effects on spiking correlation and synchrony across individual units (<xref ref-type="fig" rid="fig4">Figure 4</xref>). However, in the optoclamp's current form, higher-order temporal characteristics, such as the unit-to-unit firing correlation, are not actively controlled features of neural activity. Therefore, during clamping periods, these features of population firing will be dependent on network architecture, the identity and percentage the cells expressing opsins, and opsin dynamics. Improvements on our technique might treat higher order features of network activity, such as unit-to-unit correlation and synchrony, as secondary control targets. In this case, the controller would use real-time measures of higher order firing statistics to adjust the spatial and temporal characteristics of optical stimuli in order to enforce a particular firing structure, such as the heterogeneity of activity levels across cells and/or temporal variance of firing activity (e.g., regular firing vs bursting). Optogenetic feedback control could also be incorporated into more complex experimental contexts. For example, firing rate control could be made contingent on specific behaviors or complex spatiotemporal activity patterns associated with specific behaviors (<xref ref-type="bibr" rid="bib55">Zhang et al., 1998</xref>), in order to introduce fictive reward or neuromodulatory signals to influence learning or alleviate pathological activity. In particular, optoclamping cortical activity to replace lost neuromodulatory tone is a potentially exciting future avenue for treating Parkinson's disease (<xref ref-type="bibr" rid="bib2">Beuter et al., 2014</xref>).</p><p>Recently, several ‘all-optical’ electrophysiology techniques have been introduced to simultaneously measure neural activity via genetically encoded calcium sensors and optogenetically inject currents at single cell resolution (<xref ref-type="bibr" rid="bib34">Packer et al., 2014</xref>; <xref ref-type="bibr" rid="bib39">Rickgauer et al., 2014</xref>). If combined with real-time control, these techniques could offer the ability to optically clamp activity levels in specified subnetworks with far greater specificity than is afforded using electrodes. Perhaps most exciting, recent improvements in microbial rhodopsins for simultaneous voltage indication and optogenetic stimulation provide a means for all-optical measurement and perturbation of the membrane voltage at subcellular resolution and millisecond timescales (<xref ref-type="bibr" rid="bib11">Flytzanis et al., 2014</xref>; <xref ref-type="bibr" rid="bib19">Hochbaum et al., 2014</xref>). These tools even allow simultaneous sensing and actuation using a single opsin. Using opsins to both measure and actuate voltage within a feedback control loop will open the possibility of voltage clamping arbitrary populations of cells without puncturing their cell bodies. This would enable an unprecedented improvement of fine-scale control and measurement of neural circuit activation in vitro and, with specialized optics, in vivo.</p><p>In summary, we have performed a systematic and extensive investigation of how optogenetic feedback control can be used to precisely control neuronal firing levels during perturbations that strongly affect network excitability, across time scales ranging from seconds to days, both in vitro and in vivo. The functionality of our technique across control parameters, algorithms, preparations, and firing rate measures (network vs single units) indicates the robustness and general applicability of the technique to different experimental contexts. When combined with secondary genetic, pharmacological, or behavioral manipulations and tailored to particular experimental contexts using suitable control algorithms, we envision the use of optogenetic feedback control in a multitude of experimental and clinical contexts requiring precise control of neuronal activity. For these reasons, we believe that the optoclamp is a powerful addition to the expanding optogenetic toolbox and will improve and accelerate the study of neural control of motor action, sensory encoding and adaptation, neuromodulation, and activity homeostasis.</p></sec><sec id="s4" sec-type="materials|methods"><title>Materials and methods</title><sec id="s4-1"><title>Statistics</title><p>All statistical analyses were performed using MATLAB (MathWorks, Natick, MA). For tests between two groups, we first used a Lilliefors test (<italic>α</italic> = 0.05) to determine if sample distributions were normally distributed. If the null hypothesis of normality was rejected for one or both sample distribution(s), we performed a Wilcoxon signed-rank test (<italic>α</italic> = 0.05). Otherwise we used a paired t-test (<italic>α</italic> = 0.05). We used paired tests because our samples were ‘matched’ (i.e., the same culture or cell was examined in two different experimental conditions).</p><p>For tests involving multiple comparisons across three or more groups, we first used a Lilliefors test (<italic>α</italic> = 0.05) to determine if the sample distributions were normally distributed. If the null hypothesis of normality was rejected for one or more sample distribution(s), we performed a Kruskal–Wallis one-way analysis of variance. Otherwise, we performed standard one-way ANOVA. Post-hoc hypothesis testing was performed using the Bonferroni correction to control the familywise error rate in order to determine which pairs were significantly different. We used <italic>t</italic>-tests if sample distributions were Gaussian and Mann–Whitney U tests otherwise. Adjusted p-values are reported in figure captions and the text.</p></sec><sec id="s4-2"><title>In vitro procedures</title><sec id="s4-2-1"><title>Cell culture</title><p>Whole neocortex was isolated from embryonic day 18 (E18) rats in accordance with the National Research Council's Guide for the care and use of laboratory animals using a protocol approved by the Georgia Tech IACUC. Cortical tissue was digested in 20 U ml<sup>−1</sup> papain (Sigma-Aldrich, St. Louis, MO) diluted in a culturing medium described in (<xref ref-type="bibr" rid="bib21">Jimbo et al., 1999</xref>), but without antibiotics or antimycotics. Following enzymatic digestion, cells were dissociated mechanically using 3 to 5 passes through a 1 ml conical pipette tip, and diluted to 2500 cells μl<sup>−1</sup>. MEAs with 200 μm electrode spacing, 30 μm electrode diameter (Multichannel Systems, Reutlingen, Germany) were sterilized using 70% ethanol and exposure to UV light, and precoated with laminin. Approximately 50,000 cells in a 20 μl drop were plated onto a ∼2 mm diameter area over the array, resulting in ∼2500 cells mm<sup>−2</sup> on the culturing surface. The culturing well of each MEA was sealed with a fluorinated ethylene-propylene membrane (<xref ref-type="bibr" rid="bib37">Potter and DeMarse, 2001</xref>). Experiments and culture storage were carried out in an incubator regulated to 35°C, 5% CO<sub>2</sub>, 65% relative humidity. The details of our culturing methods are described in (<xref ref-type="bibr" rid="bib18">Hales et al., 2010</xref>). All experiments were carried out on cultures that were 3–4 weeks old.</p></sec><sec id="s4-2-2"><title>Viral transfections</title><p>Concentrated aliquots of AAV2-CaMKll<italic>α</italic>-hChR2(H134R)-mCherry, AAV2-CaMKll<italic>α</italic>-eNpHR3.0-eYFP, and AAV2-hSyn-eArch3.0-eYFP were produced by the University of Carolina Chapel Hill Vector Core using DNA provided by Karl Deisseroth (Stanford University). When cultures reached 1 to 5 days in vitro (DIV), viral aliquots were diluted to 1×10<sup>12</sup> c.f.u. ml<sup>−1</sup> and 1 μl was added to 1 ml culturing medium. Infected cultures were incubated for 3 days with the viral solution before the culturing medium was exchanged. To evaluate this protocol, we monitored the fluorescent signal of hChR2(H134R)-mCherry's reporter protein in 3 sister cultures over the days post infection using an LSM510 confocal microscope (Carl Zeiss AG, Oberkochen, Germany). Identical laser power and imaging settings were used for each imaging session. The fluorescent signal increased monotonically before plateauing at ∼3 weeks in vitro (<xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2A,B</xref>). Additionally, the functional reactivity of the cultures to 465 nm and 590 nm optical stimuli was probed in the weeks following infection (<xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2C</xref>). The ability of ChR2<sub>R</sub>, eNpHR3.0, and Arch3.0 to affect network firing levels mirrored the expression time course of the marker proteins.</p></sec><sec id="s4-2-3"><title>Multichannel electrophysiology</title><p>Microelectrode voltages were amplified and bandpass filtered between 1 Hz and 5 kHz using a 60 channel MEA60 analog amplifier (Multichannel Systems, Reutlingen, Germany). When stored in a 35°C incubator, the temperature of the amplifier exceeded 37°C. Therefore, the culture was regulated to 35°C using a servo-controlled (Modular One Technology, Parker, TX) custom solid state Peltier cooler mounted below the recording amplifier (<xref ref-type="fig" rid="fig1">Figure 1A</xref>). Analog signals were digitized and processed by the NeuroRighter multichannel electrophysiology platform (<ext-link ext-link-type="uri" xlink:href="https://sites.google.com/site/neurorighter/">https://sites.google.com/site/neurorighter/</ext-link>) (<xref ref-type="bibr" rid="bib31">Newman et al., 2013</xref>). Amplified electrode voltages were digitally filtered using a third order Butterworth filter with a passband of 300–5000 Hz. Extracellular action potentials were detected using a voltage threshold of 5 times the RMS noise on each electrode. A spike classifier was trained for each channel by collecting a set of spike waveforms, projecting them into their first two principal components, and fitting a mixture of <italic>K</italic> Gaussians to the resulting 2D sample distribution using expectation maximization. <italic>K</italic> was deduced automatically using a minimum description length cost function. Following training, spikes were classified online with a maximal latency of ∼5 ms. The details of NeuroRighter's spike detection/sorting algorithms are presented elsewhere (<xref ref-type="bibr" rid="bib31">Newman et al., 2013</xref>). We note that, given the simplicity of our controllers, they could be easily implemented on any multichannel electrophysiology system capable of rapid, real-time feedback (e.g., open-ephys, <ext-link ext-link-type="uri" xlink:href="http://open-ephys.org/">http://open-ephys.org/</ext-link> or Tucker–Davis Technologies bioprocessors, <ext-link ext-link-type="uri" xlink:href="http://www.tdt.com/">http://www.tdt.com/</ext-link>).</p></sec><sec id="s4-2-4"><title>Optical stimulator</title><p>To deliver optical stimuli, we used a custom LED driver (<ext-link ext-link-type="uri" xlink:href="http://www.open-ephys.org/cyclops/">http://www.open-ephys.org/cyclops/</ext-link>) to control a single blue LED (LZ4-00B200, LEDEngin, San Jose, CA) and 3 amber LEDs wired in series (LZ4-00A100, LEDEngin). LEDs were butt-coupled to a 4-to-1 randomized fiber bundle (Schott AG, Mainz, Germany), which then fed light into a custom Köhler illumination train mounted beneath the MEA amplifier (<xref ref-type="fig" rid="fig1">Figure 1A</xref> and <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1</xref>). We confirmed the spatial homogeneity of light at the culturing surface using a BC106-VIS CCD-based beam profiler (Thorlabs, Newton, NJ; <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1B</xref>). Because the blue LED was used to deliver complex temporal waveforms (<xref ref-type="fig" rid="fig4">Figure 4</xref>), we used optical feedback to completely linearize the relationship between the control signal and the LED's radiant intensity (<xref ref-type="bibr" rid="bib46">Tchumatchenko et al., 2013</xref>). Scattered 465 nm light was sampled using a PDA36 amplified photodiode (Thorlabs) fitted with a FB450-40 450 ± 22 nm FWHM optical bandpass filter (Thorlabs) mounted on the Kohler illuminator optical cage (<xref ref-type="fig" rid="fig1">Figure 1A</xref>). Amplified light power measurements were fed back to the LED driver to linearize the relationship between the control voltage, provided by NeuroRighter, and optical power. Yellow LEDs were driven using a second driver in a constant-current configuration. The static control signal to irradiance relationship for both light sources are shown in <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1A,B</xref>. A full design specification for the LED driver is available online (<ext-link ext-link-type="uri" xlink:href="https://github.com/jonnew/cyclops">https://github.com/jonnew/cyclops</ext-link>).</p></sec><sec id="s4-2-5"><title>Pharmacology</title><p>Each MEA culturing well contained 1.5 ml of culturing medium. To administer synaptic blockers, 100 μl of culturing medium was transferred from the well to a 0.5 ml centrifuge tube and mixed with either 3 μl of 10 mM CNQX (6-cyano-7-nitroquinoxaline-2,3-dione), 3 μl of 25 mM AP5 (amino-5-phosphonovaleric acid), or 3 μl of 10 mM bicuculline. The resulting mixture was returned to the culturing well and pipetted up and down 5 times to arrive at a final concentration of 20 μM CNQX, 50 μM AP5, or 20 μM bicuculline.</p></sec><sec id="s4-2-6"><title>Functional expression</title><p>To characterize the ability of ChR2<sub>R</sub> to increase population activity, we scanned three parameters of ChR2<sub>R</sub> excitation in open-loop: 0.1–5 ms pulse width, 1–40 Hz stimulation frequency, and 0.1–1.5 Amps through a 465 ± 11 nm FWHM LED, which corresponds to 1.6–13.4 mW mm<sup>−2</sup> at the culturing surface in our configuration (<xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1A</xref>). We found that all three parameters provided smooth, positive, monotonic relationship with the average population firing rate at any point approximately 1 week after viral transduction, and that the functional ability of ChR2<sub>R</sub> co-varied with its expression time-course (<xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2C</xref>). Therefore, we used a single control variable, called <italic>U</italic><sub>C</sub>, to simultaneously modulate the pulse-width, stimulation frequency, and optical power of 465 nm stimulation (<xref ref-type="disp-formula" rid="equ7 equ8 equ9">Equations 7–9</xref>).</p><p>To characterize the ability of eNpHR3.0 to decrease population firing, we delivered 30 s long stimulus pulses ranging from 0 to 1 Amp to three 590 ± 10 nm FWHM LEDs wired in series, throughout development. These LED currents corresponded to ∼1.3–10.8 mW mm<sup>−2</sup> in our configuration (<xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1B</xref>). We observed a negative, monotonic relationship between the optical power of the LED and population firing throughout development. Therefore, we defined a control input <italic>U</italic><sub>eNpHR</sub> as the forward diode current of the 590 nm LED (<xref ref-type="disp-formula" rid="equ10">Equation 10</xref>).</p></sec><sec id="s4-2-7"><title>Feedback controllers</title><p>Optogenetic feedback control was implemented using the NeuroRighter plug-in interface, which allows on-the-fly access to NeuroRighter's data streams to user written plug-in code (<xref ref-type="bibr" rid="bib31">Newman et al., 2013</xref>). Every <italic>dt</italic> = 4 ms, the average network firing rate, <italic>f</italic>[<italic>t</italic>] was calculated using action potentials produced by sorted units and passed through a first-order averaging filter,<disp-formula id="equ1"><label>(1)</label><mml:math id="m1"><mml:mrow><mml:mi>f</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>α</mml:mi><mml:mi>r</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>α</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi>f</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>−</mml:mo><mml:mi>d</mml:mi><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf1"><mml:mrow><mml:mi>r</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mtext>no</mml:mtext><mml:mo>.</mml:mo><mml:mtext> spikes</mml:mtext></mml:mrow><mml:mo>/</mml:mo><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>no</mml:mtext><mml:mo>.</mml:mo><mml:mtext> units</mml:mtext><mml:mo>·</mml:mo><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mrow></mml:mrow></mml:math></inline-formula> is the instantaneous firing rate during the 4 ms bin, averaged across all detected units and the weighting factor,<disp-formula id="equ2"><label>(2)</label><mml:math id="m2"><mml:mrow><mml:mi>α</mml:mi><mml:mo>≈</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mtext>exp</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mo>−</mml:mo><mml:mi>d</mml:mi><mml:mi>t</mml:mi><mml:mo>/</mml:mo><mml:mi>τ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>is defined using a <italic>τ</italic> = 2.5 s time constant. The firing rate was then compared to a desired firing rate, <italic>f</italic><sup>*</sup> (setpoint), and the error between the two,<disp-formula id="equ3"><label>(3)</label><mml:math id="m3"><mml:mrow><mml:msub><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mi>f</mml:mi><mml:mtext>*</mml:mtext></mml:msup><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>was used to generate stimulus signals using either a PI or on-off control scheme. The PI controller was defined in a recursive form as,<disp-formula id="equ4"><label>(4)</label><mml:math id="m4"><mml:mrow><mml:mi>u</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>u</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>]</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mi>K</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>]</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>T</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>T</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:msub><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula></p><p>where <italic>K</italic> = 0.1 is the proportional gain, <italic>T</italic><sub><italic>i</italic></sub> = 1 s is the integral time constant, and <italic>T</italic><sub><italic>s</italic></sub> = 0.01 s is the period of the control loop. <italic>u</italic>[<italic>t</italic>] was then transformed into optical stimulus signals according to,<disp-formula id="equ5"><label>(5)</label><mml:math id="m5"><mml:mrow><mml:msub><mml:mi>U</mml:mi><mml:mtext>C</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mi>u</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:msub><mml:mtext>Δ</mml:mtext><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula><disp-formula id="equ6"><label>(6)</label><mml:math id="m6"><mml:mrow><mml:msub><mml:mi>U</mml:mi><mml:mtext>H</mml:mtext></mml:msub><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:mi>u</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:msub><mml:mtext>Δ</mml:mtext><mml:mn>2</mml:mn></mml:msub><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p>Δ<sub>1,2</sub> = 0.25 determine the degree of overlap in ChR2<sub>R</sub> and eNpHR3.0 activation, respectively. <italic>U</italic><sub>C</sub>, the control variable for ChR2<sub>R</sub>, was transformed into pulses of blue light according to,<disp-formula id="equ7"><label>(7)</label><mml:math id="m7"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Pulse freq</mml:mtext><mml:mo>.</mml:mo></mml:mrow><mml:mrow><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>10</mml:mn><mml:mo>·</mml:mo><mml:msub><mml:mi>U</mml:mi><mml:mtext>C</mml:mtext></mml:msub><mml:mo>+</mml:mo><mml:mn>10</mml:mn><mml:mtext> </mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>Hz</mml:mtext></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula><disp-formula id="equ8"><label>(8)</label><mml:math id="m8"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Pulse width</mml:mtext></mml:mrow><mml:mrow><mml:mtext> </mml:mtext><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>5</mml:mn><mml:mo>·</mml:mo><mml:msub><mml:mi>U</mml:mi><mml:mtext>C</mml:mtext></mml:msub><mml:mtext> </mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>ms</mml:mtext></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula><disp-formula id="equ9"><label>(9)</label><mml:math id="m9"><mml:mrow><mml:msub><mml:mrow><mml:mtext>Power</mml:mtext></mml:mrow><mml:mrow><mml:mtext> </mml:mtext><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>13.2</mml:mn><mml:mo>·</mml:mo><mml:msub><mml:mi>U</mml:mi><mml:mtext>C</mml:mtext></mml:msub><mml:mtext> </mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>mW</mml:mtext><mml:mo>·</mml:mo><mml:msup><mml:mrow><mml:mtext>mm</mml:mtext></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p><italic>U</italic><sub>H</sub>, the control variable for eNpHR3.0, was transformed into continuously modulated yellow light according to,<disp-formula id="equ10"><label>(10)</label><mml:math id="m10"><mml:mrow><mml:msub><mml:mrow><mml:mtext>LED current</mml:mtext></mml:mrow><mml:mrow><mml:mtext> </mml:mtext><mml:mn>590</mml:mn><mml:mtext> nm</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>U</mml:mi><mml:mtext>H</mml:mtext></mml:msub><mml:mtext> </mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>Amps</mml:mtext></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p><p><italic>U</italic><sub>C</sub> and <italic>U</italic><sub>H</sub> were bounded between 0 and 1 to prevent integral windup and unreasonably high stimulation intensities. 20 s prior to the start of each 60-s control epoch a 10-s train of <italic>U</italic><sub>C</sub> = 1.0 stimuli was applied, which we found increased control stability by preventing oscillations at the start of the control epoch. This conditioning stimulus train is referred to as a ‘pre-pulse’ in <xref ref-type="fig" rid="fig3">Figure 3</xref>. If oscillations persisted, we increased <italic>T</italic><sub><italic>i</italic></sub> from its nominal value of 1 s until the controller stabilized (<xref ref-type="fig" rid="fig2s4">Figure 2—figure supplement 4</xref>). The largest value of <italic>T</italic><sub><italic>i</italic></sub> required for to achieve stable control was 10 s.</p><p>The excitatory on-off controller was defined as,<disp-formula id="equ11"><label>(11)</label><mml:math id="m11"><mml:mrow><mml:msub><mml:mi>I</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:munderover><mml:mstyle displaystyle="true"><mml:mo>∑</mml:mo></mml:mstyle><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow><mml:mi>t</mml:mi></mml:munderover></mml:mrow><mml:msub><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>k</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula><disp-formula id="equ12"><label>(12)</label><mml:math id="m12"><mml:mrow><mml:mtext>Stim</mml:mtext><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtable columnalign="right"><mml:mtr><mml:mtd><mml:mrow><mml:mn>5</mml:mn><mml:mtext> ms</mml:mtext><mml:mo>,</mml:mo><mml:mtext>  </mml:mtext><mml:mn>465</mml:mn><mml:mtext> nm</mml:mtext><mml:mo>,</mml:mo><mml:mtext>  </mml:mtext><mml:mn>13.2</mml:mn><mml:mtext> mW</mml:mtext><mml:mo>·</mml:mo><mml:msup><mml:mrow><mml:mtext>mm</mml:mtext></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mtext> pulse</mml:mtext></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mtext> if </mml:mtext><mml:msub><mml:mi>I</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>&gt;</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mtext>Off</mml:mtext></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mtext> Otherwise</mml:mtext></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where and <italic>I</italic><sub><italic>f</italic></sub>[<italic>t</italic>] is the integrated error signal and a maximal stimulation frequency of 10 Hz was enforced. The inhibitory on-off controller was defined as,<disp-formula id="equ13"><label>(13)</label><mml:math id="m13"><mml:mrow><mml:mtext>Stim</mml:mtext><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:mrow><mml:mtext>On</mml:mtext></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mtext> if </mml:mtext><mml:msub><mml:mi>I</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>&lt;</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mtext>Off</mml:mtext></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mtext> Otherwise</mml:mtext></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where 1.0 A was delivered to the 590 nm LEDs during the ‘on’ phase, producing ∼11.8 mW mm<sup>−2</sup> at the MEA.</p></sec></sec><sec id="s4-3"><title>In vivo procedures</title><sec id="s4-3-1"><title>Experimental preparation</title><p>All procedures were approved by the Georgia Institute of Technology Institutional Animal Care and Use Committee and followed guidelines established by the National Institutes of Health. Female sprague-dawley rats (250–300 g) underwent an initial survival surgery, during which the viral vector (AAV2-CaMKll<italic>α</italic>-hChR2(H134R)-mCherry, UNC Viral Vector Core, Chapel Hill, NC) was delivered to the left thalamus using stereotactic coordinates targeting the ventral posteriomedial nucleus. The viral syringe (Neuros Syringe, Hamilton Laboratory Products, Reno, NV) was slowly lowered to depth (approximately 2 mm/min) where 1 μl of viral vector solution was delivered at 0.2 μl/min. The injection was allowed to sit for 5 min before slowly retracting the syringe to prevent movement of the virus away from the target location. The animals recovered for 3–4 weeks, providing time for ChR2<sub>R</sub> expression to reach functional levels.</p><p>In a second acute surgery, the rodents were initially anesthetized with 4% isoflurane before transitioning to intravenous administration of fentanyl cocktail (5 μg/kg fentanyl, 150 μg/kg dexmedotodomine, 2 mg/kg midazolam) through the tail vein. Throughout the experiment, measurements of the heart rate, respiratory rate, oxygen saturation, and response to toe pinch stimuli were used to monitor and titrate the depth of anesthesia. Body temperature was maintained at 37°C by a servo-controlled heating blanket (FHC, Bowdoinham, ME). Animals were mounted in a stereotactic frame and a craniotomy was performed over the left parietal cortex to allow access to the ventral postero-medial (VPm) region of the thalamus (coordinates: 2–4 mm posterior to bregma, 2.5–3.5 mm lateral to midline, 4.5–5.5 mm below cortical surface).</p></sec><sec id="s4-3-2"><title>Electrophysiology</title><p>The ‘optrode’ consisted of a multimode optical fiber (105 μm core diameter, 125 μm coating diameter, 0.22 NA, Thorlabs, Newton, NJ) and one tungsten microelectrode (75 μm diameter, FHC). The microelectrodes had an impedance of 1–2 MΩ at 1 kHz. The optical fiber was ground to a fine point, producing a spherical, rather than conical, pattern of light delivery. The optrode was advanced to the ventral posterio-medial (VPm) region of the thalamus using a precision microdrive (Knopf Instruments, Tujunga, CA). Single and multi-unit activity were band-pass filtered between 300 and 5000 Hz and digitized at 24.414 kHz using an RZ2 multichannel bioacquisition system (Tucker Davis Technologies, Alachua, FL). The principal vibrissa was determined by manually deflecting individual whiskers and observing resultant multi-unit activity.</p></sec><sec id="s4-3-3"><title>Whisker stimulation</title><p>Whiskers were trimmed at approximately 12 mm from the face, and were inserted into a custom attachment of a feedback-controlled galvo motor (range of motion, ± 20°; bandwidth, 250 Hz; Cambridge Technology) positioned 10 mm from the vibrissa pad. Vibrissae were always deflected in the rostral–caudal plane. Punctate deflections consisted of exponential rising and falling phases (total excursion, 8°; 99% rise and fall times, 5 ms; average angular velocity, 1600° s<sup>−1</sup>).</p></sec><sec id="s4-3-4"><title>Closed-loop optical stimulation</title><p>We drove a 470 nm high power LED (LBW5SN, OSRAM Opto Semiconductors GmbH, Regensburg, Germany) using our custom LED driver in optical feedback mode. The LED was butt-coupled to a 125 μM diameter optical fiber (Thorlabs) which was used to deliver light to the VPm thalamus and stimulate the ChR2<sub>R</sub>-expressing cells. Because we used optical feedback to drive the LED, the control output, <italic>u</italic>[<italic>t</italic>], was converted directly into a continuously varying light intensity,<disp-formula id="equ14"><label>(14)</label><mml:math id="m14"><mml:mrow><mml:mtext>Light power</mml:mtext><mml:mo>=</mml:mo><mml:mi>G</mml:mi><mml:mo>·</mml:mo><mml:mi>u</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <italic>G</italic> is a gain parameter that accounts for loss in the coupling from the LED die to the fiber and tuning of the driver circuit. <italic>G</italic> was measured for each fiber used (<xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1D</xref>). The controller was implemented on the Tucker–Davis RZ2's digital signal processors using the RPvdsEx graphical programming language. The in-vivo control loop was equivalent to <xref ref-type="disp-formula" rid="equ1 equ2 equ3 equ4">Equations 1–4</xref> with the exception that <italic>τ</italic> = 0.8 s and the proportional component was set to zero,<disp-formula id="equ15"><label>(15)</label><mml:math id="m15"><mml:mrow><mml:mi>u</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>u</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>T</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>T</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:msub><mml:mi>e</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula></p></sec></sec></sec></body><back><ack id="ack"><title>Acknowledgements</title><p>We thank M LaPlaca for providing tissue and JT Shoemaker for performing tissue harvests. JPN, MF, and DCM were each supported by a US National Science Foundation Graduate Research Fellowship. JPN and MF were supported by a US National Science Foundation Integrative Graduate Education and Research Traineeship. CJW is supported by the National Institutes of Health Ruth L Kirschstein National Research Service Award (F31NS089412) and was supported by the National Institute of Health computational neuroscience training grant (1T90DA032466). GBS was supported by US National Science Foundation Collaborative Research in Computational Neuroscience grant IOS-1131948 and US National Institutes of Health National Institute of Neurological Disorders and Stroke grant 2R01NS048285. SMP was supported by US National Science Foundation Emerging Frontiers in Research and Innovation grant 1238097 and US National Institutes of Health National Institute of Neurological Disorders grant 1R01NS079757-01.</p></ack><sec id="s5" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="conflict" id="conf1"><p>The authors declare that no competing interests exist.</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>JPN, Conception and design, Acquisition of data, Analysis and interpretation of data, Drafting or revising the article</p></fn><fn fn-type="con" id="con2"><p>M-F, Conception and design, Acquisition of data, Drafting or revising the article</p></fn><fn fn-type="con" id="con3"><p>DCM, Acquisition of data, Drafting or revising the article</p></fn><fn fn-type="con" id="con4"><p>CJW, Acquisition of data, Drafting or revising the article</p></fn><fn fn-type="con" id="con5"><p>GBS, Conception and design, Drafting or revising the article</p></fn><fn fn-type="con" id="con6"><p>SMP, Conception and design, Drafting or revising the article</p></fn></fn-group><fn-group content-type="ethics-information"><title>Ethics</title><fn fn-type="other"><p>Animal experimentation: This study was performed in strict accordance with the National Research Council's Guide for the care and use of laboratory animals using protocol A12012 approved by the Georgia Tech IACUC.</p></fn></fn-group></sec><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ahrens</surname><given-names>MB</given-names></name><name><surname>Li</surname><given-names>JM</given-names></name><name><surname>Orger</surname><given-names>MB</given-names></name><name><surname>Robson</surname><given-names>DN</given-names></name><name><surname>Schier</surname><given-names>AF</given-names></name><name><surname>Engert</surname><given-names>F</given-names></name><name><surname>Portugues</surname><given-names>R</given-names></name></person-group><year>2012</year><article-title>Brain-wide neuronal dynamics during motor adaptation in zebrafish</article-title><source>Nature</source><volume>485</volume><fpage>471</fpage><lpage>477</lpage><pub-id pub-id-type="doi">10.1038/nature11057</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Beuter</surname><given-names>A</given-names></name><name><surname>Lefaucheur</surname><given-names>JP</given-names></name><name><surname>Modolo</surname><given-names>J</given-names></name></person-group><year>2014</year><article-title>Closed-loop cortical neuromodulation in Parkinson's disease: an alternative to deep brain stimulation?</article-title><source>Clinical Neurophysiology</source><volume>125</volume><fpage>874</fpage><lpage>885</lpage><pub-id pub-id-type="doi">10.1016/j.clinph.2014.01.006</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bruno</surname><given-names>RM</given-names></name></person-group><year>2011</year><article-title>Synchrony in sensation</article-title><source>Current Opinion in Neurobiology</source><volume>21</volume><fpage>701</fpage><lpage>708</lpage><pub-id pub-id-type="doi">10.1016/j.conb.2011.06.003</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chow</surname><given-names>BY</given-names></name><name><surname>Han</surname><given-names>X</given-names></name><name><surname>Dobry</surname><given-names>AS</given-names></name><name><surname>Qian</surname><given-names>X</given-names></name><name><surname>Chuong</surname><given-names>AS</given-names></name><name><surname>Li</surname><given-names>M</given-names></name><name><surname>Henninger</surname><given-names>MA</given-names></name><name><surname>Belfort</surname><given-names>GM</given-names></name><name><surname>Lin</surname><given-names>Y</given-names></name><name><surname>Monahan</surname><given-names>PE</given-names></name><name><surname>Boyden</surname><given-names>ES</given-names></name></person-group><year>2010</year><article-title>High-performance genetically targetable optical neural silencing by light-driven proton pumps</article-title><source>Nature</source><volume>463</volume><fpage>98</fpage><lpage>102</lpage><pub-id pub-id-type="doi">10.1038/nature08652</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Constantinople</surname><given-names>CM</given-names></name><name><surname>Bruno</surname><given-names>RM</given-names></name></person-group><year>2011</year><article-title>Effects and mechanisms of wakefulness on local cortical networks</article-title><source>Neuron</source><volume>69</volume><fpage>1061</fpage><lpage>1068</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2011.02.040</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Corner</surname><given-names>MA</given-names></name><name><surname>van Pelt</surname><given-names>J</given-names></name><name><surname>Wolters</surname><given-names>PS</given-names></name><name><surname>Baker</surname><given-names>RE</given-names></name><name><surname>Nuytinck</surname><given-names>RH</given-names></name></person-group><year>2002</year><article-title>Physiological effects of sustained blockade of excitatory synaptic transmission on spontaneously active developing neuronal networks—an inquiry into the reciprocal linkage between intrinsic biorhythms and neuroplasticity in early ontogeny</article-title><source>Neuroscience and Biobehavioral Reviews</source><volume>26</volume><fpage>127</fpage><lpage>185</lpage><pub-id pub-id-type="doi">10.1016/S0149-7634(01)00062-8</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cunningham</surname><given-names>JP</given-names></name><name><surname>Nuyujukian</surname><given-names>P</given-names></name><name><surname>Gilja</surname><given-names>V</given-names></name><name><surname>Chestek</surname><given-names>CA</given-names></name><name><surname>Ryu</surname><given-names>SI</given-names></name><name><surname>Shenoy</surname><given-names>KV</given-names></name></person-group><year>2011</year><article-title>A closed-loop human simulator for investigating the role of feedback control in brain-machine interfaces</article-title><source>Journal of Neurophysiology</source><volume>105</volume><fpage>1932</fpage><lpage>1949</lpage><pub-id pub-id-type="doi">10.1152/jn.00503.2010</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Curtis</surname><given-names>JC</given-names></name><name><surname>Kleinfeld</surname><given-names>D</given-names></name></person-group><year>2009</year><article-title>Phase-to-rate transformations encode touch in cortical neurons of a scanning sensorimotor system</article-title><source>Nature Neuroscience</source><volume>12</volume><fpage>492</fpage><lpage>501</lpage><pub-id pub-id-type="doi">10.1038/nn.2283</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dutton</surname><given-names>SB</given-names></name><name><surname>Makinson</surname><given-names>CD</given-names></name><name><surname>Papale</surname><given-names>LA</given-names></name><name><surname>Shankar</surname><given-names>A</given-names></name><name><surname>Balakrishnan</surname><given-names>B</given-names></name><name><surname>Nakazawa</surname><given-names>K</given-names></name><name><surname>Escayg</surname><given-names>A</given-names></name></person-group><year>2013</year><article-title>Preferential inactivation of Scn1a in parvalbumin interneurons increases seizure susceptibility</article-title><source>Neurobiology of Disease</source><volume>49</volume><fpage>211</fpage><lpage>220</lpage><pub-id pub-id-type="doi">10.1016/j.nbd.2012.08.012</pub-id></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Feller</surname><given-names>M</given-names></name></person-group><year>1999</year><article-title>Spontaneous correlated activity in developing neural circuits</article-title><source>Neuron</source><volume>22</volume><fpage>653</fpage><lpage>656</lpage><pub-id pub-id-type="doi">10.1016/S0896-6273(00)80724-2</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Flytzanis</surname><given-names>NC</given-names></name><name><surname>Bedbrook</surname><given-names>CN</given-names></name><name><surname>Chiu</surname><given-names>H</given-names></name><name><surname>Engqvist</surname><given-names>MK</given-names></name><name><surname>Xiao</surname><given-names>C</given-names></name><name><surname>Chan</surname><given-names>KY</given-names></name><name><surname>Sternberg</surname><given-names>PW</given-names></name><name><surname>Arnold</surname><given-names>FH</given-names></name><name><surname>Gradinaru</surname><given-names>V</given-names></name></person-group><year>2014</year><article-title>Archaerhodopsin variants with enhanced voltage-sensitive fluorescence in mammalian and <italic>Caenorhabditis elegans</italic> neurons</article-title><source>Nature Communications</source><volume>5</volume><fpage>4894</fpage><pub-id pub-id-type="doi">10.1038/ncomms5894</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fong</surname><given-names>Mf</given-names></name><name><surname>Newman</surname><given-names>J</given-names></name><name><surname>Potter</surname><given-names>S</given-names></name><name><surname>Wenner</surname><given-names>P</given-names></name></person-group><year>2015</year><article-title>Upward synaptic scaling is dependent on neurotransmission rather than spiking</article-title><source>Nature Communications</source><volume>6</volume><fpage>6339</fpage><pub-id pub-id-type="doi">10.1038/ncomms7339</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Friedberg</surname><given-names>M</given-names></name><name><surname>Lee</surname><given-names>S</given-names></name><name><surname>Ebner</surname><given-names>F</given-names></name></person-group><year>1999</year><article-title>Modulation of receptive field properties of thalamic somatosensory neurons by the depth of anesthesia</article-title><source>Journal of Neurophysiology</source><volume>81</volume><fpage>2243</fpage><lpage>2252</lpage></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Georgopoulos</surname><given-names>A</given-names></name><name><surname>Kettner</surname><given-names>RE</given-names></name><name><surname>Schwartz</surname><given-names>A</given-names></name></person-group><year>1988</year><article-title>Primate motor cortex and free arm movements to visual targets in three-dimensional space. II. Coding of the direction of movement by a neuronal population</article-title><source>The Journal of Neuroscience</source><volume>8</volume><fpage>2928</fpage><lpage>2937</lpage></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gradinaru</surname><given-names>V</given-names></name><name><surname>Thompson</surname><given-names>K</given-names></name><name><surname>Deisseroth</surname><given-names>K</given-names></name></person-group><year>2008</year><article-title>eNpHR: a Natronomonas halorhodopsin enhanced for optogenetic applications</article-title><source>Brain Cell Biology</source><volume>36</volume><fpage>129</fpage><lpage>139</lpage><pub-id pub-id-type="doi">10.1007/s11068-008-9027-6</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Grosenick</surname><given-names>L</given-names></name><name><surname>Marshel</surname><given-names>JH</given-names></name><name><surname>Deisseroth</surname><given-names>K</given-names></name></person-group><year>2015</year><article-title>Closed-loop and activity-guided optogenetic control</article-title><source>Neuron</source><volume>86</volume><fpage>106</fpage><lpage>139</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2015.03.034</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Halassa</surname><given-names>MM</given-names></name><name><surname>Chen</surname><given-names>Z</given-names></name><name><surname>Wimmer</surname><given-names>RD</given-names></name><name><surname>Brunetti</surname><given-names>PM</given-names></name><name><surname>Zhao</surname><given-names>S</given-names></name><name><surname>Zikopoulos</surname><given-names>B</given-names></name><name><surname>Wang</surname><given-names>F</given-names></name><name><surname>Brown</surname><given-names>EN</given-names></name><name><surname>Wilson</surname><given-names>MA</given-names></name></person-group><year>2014</year><article-title>State-dependent architecture of thalamic reticular subnetworks</article-title><source>Cell</source><volume>158</volume><fpage>808</fpage><lpage>821</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2014.06.025</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hales</surname><given-names>CM</given-names></name><name><surname>Rolston</surname><given-names>JD</given-names></name><name><surname>Potter</surname><given-names>SM</given-names></name></person-group><year>2010</year><article-title>How to culture, record and stimulate neuronal networks on micro-electrode arrays</article-title><source>Journal of Visualized Experiments</source><volume>39</volume><fpage>e2056</fpage><pub-id pub-id-type="doi">10.3791/2056</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hochbaum</surname><given-names>DR</given-names></name><name><surname>Zhao</surname><given-names>Y</given-names></name><name><surname>Farhi</surname><given-names>SL</given-names></name><name><surname>Klapoetke</surname><given-names>N</given-names></name><name><surname>Werley</surname><given-names>CA</given-names></name><name><surname>Kapoor</surname><given-names>V</given-names></name><name><surname>Zou</surname><given-names>P</given-names></name><name><surname>Kralj</surname><given-names>JM</given-names></name><name><surname>Maclaurin</surname><given-names>D</given-names></name><name><surname>Smedemark-Margulies</surname><given-names>N</given-names></name><name><surname>Saulnier</surname><given-names>JL</given-names></name><name><surname>Boulting</surname><given-names>GL</given-names></name><name><surname>Straub</surname><given-names>C</given-names></name><name><surname>Cho</surname><given-names>YK</given-names></name><name><surname>Melkonian</surname><given-names>M</given-names></name><name><surname>Wong</surname><given-names>GK</given-names></name><name><surname>Harrison</surname><given-names>DJ</given-names></name><name><surname>Murthy</surname><given-names>VN</given-names></name><name><surname>Sabatini</surname><given-names>BL</given-names></name><name><surname>Boyden</surname><given-names>ES</given-names></name><name><surname>Campbell</surname><given-names>RE</given-names></name><name><surname>Cohen</surname><given-names>AE</given-names></name></person-group><year>2014</year><article-title>All-optical electrophysiology in mammalian neurons using engineered microbial rhodopsins</article-title><source>Nature Methods</source><volume>11</volume><fpage>1</fpage><lpage>34</lpage><pub-id pub-id-type="doi">10.1038/nmeth.3000</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jackson</surname><given-names>A</given-names></name><name><surname>Mavoori</surname><given-names>J</given-names></name><name><surname>Fetz</surname><given-names>EE</given-names></name></person-group><year>2006</year><article-title>Long-term motor cortex plasticity induced by an electronic neural implant</article-title><source>Nature</source><volume>444</volume><fpage>56</fpage><lpage>60</lpage><pub-id pub-id-type="doi">10.1038/nature05226</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jimbo</surname><given-names>Y</given-names></name><name><surname>Tateno</surname><given-names>T</given-names></name><name><surname>Robinson</surname><given-names>HP</given-names></name></person-group><year>1999</year><article-title>Simultaneous induction of pathway-specific potentiation and depression in networks of cortical neurons</article-title><source>Biophysical Journal</source><volume>76</volume><fpage>670</fpage><lpage>678</lpage><pub-id pub-id-type="doi">10.1016/S0006-3495(99)77234-6</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kobayashi</surname><given-names>M</given-names></name><name><surname>Buckmaster</surname><given-names>PS</given-names></name></person-group><year>2003</year><article-title>Reduced inhibition of dentate granule cells in a model of temporal lobe epilepsy</article-title><source>The Journal of Neuroscience</source><volume>23</volume><fpage>2440</fpage><lpage>2452</lpage></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Krook-Magnuson</surname><given-names>E</given-names></name><name><surname>Armstrong</surname><given-names>C</given-names></name><name><surname>Oijala</surname><given-names>M</given-names></name><name><surname>Soltesz</surname><given-names>I</given-names></name></person-group><year>2013</year><article-title>On-demand optogenetic control of spontaneous seizures in temporal lobe epilepsy</article-title><source>Nature Communications</source><volume>4</volume><fpage>1376</fpage><pub-id pub-id-type="doi">10.1038/ncomms2376</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Leifer</surname><given-names>AM</given-names></name><name><surname>Fang-Yen</surname><given-names>C</given-names></name><name><surname>Gershow</surname><given-names>M</given-names></name><name><surname>Alkema</surname><given-names>MJ</given-names></name><name><surname>Samuel</surname><given-names>AD</given-names></name></person-group><year>2011</year><article-title>Optogenetic manipulation of neural activity in freely moving <italic>Caenorhabditis elegans</italic></article-title><source>Nature Methods</source><volume>8</volume><fpage>147</fpage><lpage>152</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1554</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mattis</surname><given-names>J</given-names></name><name><surname>Tye</surname><given-names>KM</given-names></name><name><surname>Ferenczi</surname><given-names>EA</given-names></name><name><surname>Ramakrishnan</surname><given-names>C</given-names></name><name><surname>O'Shea</surname><given-names>DJ</given-names></name><name><surname>Prakash</surname><given-names>R</given-names></name><name><surname>Gunaydin</surname><given-names>LA</given-names></name><name><surname>Hyun</surname><given-names>M</given-names></name><name><surname>Fenno</surname><given-names>LE</given-names></name><name><surname>Gradinaru</surname><given-names>V</given-names></name><name><surname>Yizhar</surname><given-names>O</given-names></name><name><surname>Deisseroth</surname><given-names>K</given-names></name></person-group><year>2011</year><article-title>Principles for applying optogenetic tools derived from direct comparative analysis of microbial opsins</article-title><source>Nature Methods</source><volume>99</volume><fpage>159</fpage><lpage>172</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1808</pub-id></element-citation></ref><ref id="bib26"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Millard</surname><given-names>DC</given-names></name><name><surname>Wang</surname><given-names>Q</given-names></name><name><surname>Gollnick</surname><given-names>CA</given-names></name><name><surname>Stanley</surname><given-names>GB</given-names></name></person-group><year>2013</year><article-title>System identification of the nonlinear dynamics in the thalamocortical circuit in response to patterned thalamic microstimulation in vivo</article-title><source>Journal of Neural Engineering</source><volume>10</volume><fpage>066011</fpage><pub-id pub-id-type="doi">10.1088/1741-2560/10/6/066011</pub-id></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Minerbi</surname><given-names>A</given-names></name><name><surname>Kahana</surname><given-names>R</given-names></name><name><surname>Goldfeld</surname><given-names>L</given-names></name><name><surname>Kaufman</surname><given-names>M</given-names></name><name><surname>Marom</surname><given-names>S</given-names></name><name><surname>Ziv</surname><given-names>NE</given-names></name></person-group><year>2009</year><article-title>Long-term relationships between synaptic tenacity, synaptic remodeling, and network activity</article-title><source>PLOS Biology</source><volume>7</volume><fpage>e1000136</fpage><pub-id pub-id-type="doi">10.1371/journal.pbio.1000136</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Miranda-Domínguez</surname><given-names>O</given-names></name><name><surname>Gonia</surname><given-names>J</given-names></name><name><surname>Netoff</surname><given-names>TI</given-names></name></person-group><year>2010</year><article-title>Firing rate control of a neuron using a linear proportional-integral controller</article-title><source>Journal of Neural Engineering</source><volume>7</volume><fpage>066004</fpage><pub-id pub-id-type="doi">10.1088/1741-2560/7/6/066004</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nagel</surname><given-names>G</given-names></name><name><surname>Brauner</surname><given-names>M</given-names></name><name><surname>Liewald</surname><given-names>JF</given-names></name><name><surname>Adeishvili</surname><given-names>N</given-names></name><name><surname>Bamberg</surname><given-names>E</given-names></name><name><surname>Gottschalk</surname><given-names>A</given-names></name></person-group><year>2005</year><article-title>Light activation of channelrhodopsin-2 in excitable cells of <italic>Caenorhabditis elegans</italic> triggers rapid behavioral responses</article-title><source>Current Biology</source><volume>15</volume><fpage>2279</fpage><lpage>2284</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2005.11.032</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nakanishi</surname><given-names>K</given-names></name><name><surname>Kukita</surname><given-names>F</given-names></name></person-group><year>1998</year><article-title>Functional synapses in synchronized bursting of neocortical neurons in culture</article-title><source>Brain Research</source><volume>795</volume><fpage>137</fpage><lpage>146</lpage><pub-id pub-id-type="doi">10.1016/S0006-8993(98)00283-2</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Newman</surname><given-names>JP</given-names></name><name><surname>Zeller-Townson</surname><given-names>R</given-names></name><name><surname>Fong</surname><given-names>Mf</given-names></name><name><surname>Desai</surname><given-names>SA</given-names></name><name><surname>Potter</surname><given-names>SM</given-names></name></person-group><year>2013</year><article-title>Closed-loop, multichannel experimentation using the open-source NeuroRighter electrophysiology platform</article-title><source>Frontiers in Neural Circuits</source><volume>6</volume><fpage>98</fpage><pub-id pub-id-type="doi">10.3389/fncir.2012.00098</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>O'Connor</surname><given-names>DH</given-names></name><name><surname>Hires</surname><given-names>SA</given-names></name><name><surname>Guo</surname><given-names>ZV</given-names></name><name><surname>Li</surname><given-names>N</given-names></name><name><surname>Yu</surname><given-names>J</given-names></name><name><surname>Sun</surname><given-names>QQ</given-names></name><name><surname>Huber</surname><given-names>D</given-names></name><name><surname>Svoboda</surname><given-names>K</given-names></name></person-group><year>2013</year><article-title>Neural coding during active somatosensation revealed using illusory touch</article-title><source>Nature Neuroscience</source><volume>16</volume><fpage>958</fpage><lpage>965</lpage><pub-id pub-id-type="doi">10.1038/nn.3419</pub-id></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>O'Donovan</surname><given-names>MJ</given-names></name><name><surname>Chub</surname><given-names>N</given-names></name><name><surname>Wenner</surname><given-names>P</given-names></name></person-group><year>1998</year><article-title>Mechanisms of spontaneous activity in developing spinal networks</article-title><source>Journal of Neurobiology</source><volume>37</volume><fpage>131</fpage><lpage>145</lpage><pub-id pub-id-type="doi">10.1002/(SICI)1097-4695(199810)37:1&lt;131::AID-NEU10&gt;3.0.CO;2-H</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Packer</surname><given-names>AM</given-names></name><name><surname>Russell</surname><given-names>LE</given-names></name><name><surname>Dalgleish</surname><given-names>HWP</given-names></name><name><surname>Häusser</surname><given-names>M</given-names></name></person-group><year>2014</year><article-title>Simultaneous all-optical manipulation and recording of neural circuit activity with cellular resolution in vivo</article-title><source>Nature Methods</source><volume>12</volume><fpage>140</fpage><lpage>146</lpage><pub-id pub-id-type="doi">10.1038/nmeth.3217</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Paz</surname><given-names>JT</given-names></name><name><surname>Davidson</surname><given-names>TJ</given-names></name><name><surname>Frechette</surname><given-names>ES</given-names></name><name><surname>Delord</surname><given-names>B</given-names></name><name><surname>Parada</surname><given-names>I</given-names></name><name><surname>Peng</surname><given-names>K</given-names></name><name><surname>Deisseroth</surname><given-names>K</given-names></name><name><surname>Huguenard</surname><given-names>JR</given-names></name></person-group><year>2012</year><article-title>Closed-loop optogenetic control of thalamus as a tool for interrupting seizures after cortical injury</article-title><source>Nature Neuroscience</source><volume>16</volume><fpage>64</fpage><lpage>70</lpage><pub-id pub-id-type="doi">10.1038/nn.3269</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Poggio</surname><given-names>G</given-names></name><name><surname>Viernstein</surname><given-names>L</given-names></name></person-group><year>1964</year><article-title>Time series analysis of impulse sequences of thalamic somatic sensory neurons</article-title><source>Journal of Neurophysiology</source><volume>27</volume><fpage>517</fpage><lpage>545</lpage></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Potter</surname><given-names>SM</given-names></name><name><surname>DeMarse</surname><given-names>TB</given-names></name></person-group><year>2001</year><article-title>A new approach to neural cell culture for long-term studies</article-title><source>Journal of Neuroscience Methods</source><volume>110</volume><fpage>17</fpage><lpage>24</lpage><pub-id pub-id-type="doi">10.1016/S0165-0270(01)00412-5</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Raimondo</surname><given-names>J</given-names></name><name><surname>Kay</surname><given-names>L</given-names></name><name><surname>Ellender</surname><given-names>T</given-names></name><name><surname>Akerman</surname><given-names>C</given-names></name></person-group><year>2012</year><article-title>Optogenetic silencing strategies differ in their effects on inhibitory synaptic transmission</article-title><source>Nature Neuroscience</source><volume>15</volume><fpage>1102</fpage><lpage>1104</lpage><pub-id pub-id-type="doi">10.1038/nn.3143</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rickgauer</surname><given-names>JP</given-names></name><name><surname>Deisseroth</surname><given-names>K</given-names></name><name><surname>Tank</surname><given-names>DW</given-names></name></person-group><year>2014</year><article-title>Simultaneous cellular-resolution optical perturbation and imaging of place cell firing fields</article-title><source>Nature Neuroscience</source><volume>17</volume><fpage>1816</fpage><lpage>1824</lpage><pub-id pub-id-type="doi">10.1038/nn.3866</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Siegle</surname><given-names>JH</given-names></name><name><surname>Wilson</surname><given-names>MA</given-names></name></person-group><year>2014</year><article-title>Enhancement of encoding and retrieval functions through theta phase-specific manipulation of hippocampus</article-title><source>eLife</source><volume>3</volume><fpage>e03061</fpage><pub-id pub-id-type="doi">10.7554/eLife.03061</pub-id></element-citation></ref><ref id="bib41"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Simons</surname><given-names>D</given-names></name><name><surname>Carvell</surname><given-names>G</given-names></name><name><surname>Hershey</surname><given-names>A</given-names></name><name><surname>Bryant</surname><given-names>D</given-names></name></person-group><year>1992</year><article-title>Responses of barrel cortex neurons in awake rats and effects of urethane anesthesia</article-title><source>Experimental Brain Research</source><volume>91</volume><fpage>259</fpage><lpage>272</lpage><pub-id pub-id-type="doi">10.1007/BF00231659</pub-id></element-citation></ref><ref id="bib42"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stanley</surname><given-names>GB</given-names></name></person-group><year>2013</year><article-title>Reading and writing the neural code</article-title><source>Nature Neuroscience</source><volume>16</volume><fpage>259</fpage><lpage>263</lpage><pub-id pub-id-type="doi">10.1038/nn.3330</pub-id></element-citation></ref><ref id="bib43"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Steinmetz</surname><given-names>M</given-names></name><name><surname>Motter</surname><given-names>B</given-names></name><name><surname>Duffy</surname><given-names>C</given-names></name><name><surname>Mountcastle</surname><given-names>V</given-names></name></person-group><year>1987</year><article-title>Functional properties of parietal visual neurons: radial organization of directionalities within the visual field</article-title><source>The Journal of Neuroscience</source><volume>7</volume><fpage>177</fpage><lpage>191</lpage></element-citation></ref><ref id="bib44"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stirman</surname><given-names>JN</given-names></name><name><surname>Crane</surname><given-names>MM</given-names></name><name><surname>Husson</surname><given-names>SJ</given-names></name><name><surname>Wabnig</surname><given-names>S</given-names></name><name><surname>Schultheis</surname><given-names>C</given-names></name><name><surname>Gottschalk</surname><given-names>A</given-names></name><name><surname>Lu</surname><given-names>H</given-names></name></person-group><year>2011</year><article-title>Real-time multimodal optical control of neurons and muscles in freely behaving <italic>Caenorhabditis elegans</italic></article-title><source>Nature Methods</source><volume>8</volume><fpage>153</fpage><lpage>158</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1555</pub-id></element-citation></ref><ref id="bib45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stoelzel</surname><given-names>CR</given-names></name><name><surname>Bereshpolova</surname><given-names>Y</given-names></name><name><surname>Swadlow</surname><given-names>HA</given-names></name></person-group><year>2009</year><article-title>Stability of thalamocortical synaptic transmission across awake brain states</article-title><source>The Journal of Neuroscience</source><volume>29</volume><fpage>6851</fpage><lpage>6859</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.5983-08.2009</pub-id></element-citation></ref><ref id="bib46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tchumatchenko</surname><given-names>T</given-names></name><name><surname>Newman</surname><given-names>JP</given-names></name><name><surname>Fong</surname><given-names>Mf</given-names></name><name><surname>Potter</surname><given-names>SM</given-names></name></person-group><year>2013</year><article-title>Delivery of continuously-varying stimuli using ChR2</article-title><source>Frontiers in Neural Circuits</source><volume>7</volume><fpage>184</fpage><pub-id pub-id-type="doi">10.3389/fncir.2013.00184</pub-id></element-citation></ref><ref id="bib47"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Turrigiano</surname><given-names>GG</given-names></name><name><surname>Leslie</surname><given-names>KR</given-names></name><name><surname>Desai</surname><given-names>NS</given-names></name><name><surname>Rutherford</surname><given-names>LC</given-names></name><name><surname>Nelson</surname><given-names>SB</given-names></name></person-group><year>1998</year><article-title>Activity-dependent scaling of quantal amplitude in neocortical neurons</article-title><source>Nature</source><volume>391</volume><fpage>892</fpage><lpage>896</lpage><pub-id pub-id-type="doi">10.1038/36103</pub-id></element-citation></ref><ref id="bib48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Turrigiano</surname><given-names>G</given-names></name></person-group><year>2011</year><article-title>Too many cooks? Intrinsic and synaptic homeostatic mechanisms in cortical circuit refinement</article-title><source>Annual Review of Neuroscience</source><volume>34</volume><fpage>89</fpage><lpage>103</lpage><pub-id pub-id-type="doi">10.1146/annurev-neuro-060909-153238</pub-id></element-citation></ref><ref id="bib49"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Velliste</surname><given-names>M</given-names></name><name><surname>Perel</surname><given-names>S</given-names></name><name><surname>Spalding</surname><given-names>MC</given-names></name><name><surname>Whitford</surname><given-names>AS</given-names></name><name><surname>Schwartz</surname><given-names>AB</given-names></name></person-group><year>2008</year><article-title>Cortical control of a prosthetic arm for self-feeding</article-title><source>Nature</source><volume>453</volume><fpage>1098</fpage><lpage>1101</lpage><pub-id pub-id-type="doi">10.1038/nature06996</pub-id></element-citation></ref><ref id="bib50"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wagenaar</surname><given-names>DA</given-names></name><name><surname>Madhavan</surname><given-names>R</given-names></name><name><surname>Pine</surname><given-names>J</given-names></name><name><surname>Potter</surname><given-names>SM</given-names></name></person-group><year>2005</year><article-title>Controlling bursting in cortical cultures with closed-loop multi-electrode stimulation</article-title><source>The Journal of Neuroscience</source><volume>25</volume><fpage>680</fpage><lpage>688</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.4209-04.2005</pub-id></element-citation></ref><ref id="bib51"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wagenaar</surname><given-names>DA</given-names></name><name><surname>Pine</surname><given-names>J</given-names></name><name><surname>Potter</surname><given-names>SM</given-names></name></person-group><year>2006</year><article-title>An extremely rich repertoire of bursting patterns during the development of cortical cultures</article-title><source>BMC Neuroscience</source><volume>7</volume><fpage>11</fpage><pub-id pub-id-type="doi">10.1186/1471-2202-7-11</pub-id></element-citation></ref><ref id="bib52"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wallach</surname><given-names>A</given-names></name><name><surname>Eytan</surname><given-names>D</given-names></name><name><surname>Gal</surname><given-names>A</given-names></name><name><surname>Zrenner</surname><given-names>C</given-names></name><name><surname>Marom</surname><given-names>S</given-names></name></person-group><year>2011</year><article-title>Neuronal response clamp</article-title><source>Frontiers in Neuroengineering</source><volume>4</volume><fpage>3</fpage><pub-id pub-id-type="doi">10.3389/fneng.2011.00003</pub-id></element-citation></ref><ref id="bib53"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname><given-names>Q</given-names></name><name><surname>Webber</surname><given-names>RM</given-names></name><name><surname>Stanley</surname><given-names>GB</given-names></name></person-group><year>2010</year><article-title>Thalamic synchrony and the adaptive gating of information flow to cortex</article-title><source>Nature Neuroscience</source><volume>13</volume><fpage>1534</fpage><lpage>1541</lpage><pub-id pub-id-type="doi">10.1038/nn.2670</pub-id></element-citation></ref><ref id="bib54"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wu</surname><given-names>MCK</given-names></name><name><surname>David</surname><given-names>SV</given-names></name><name><surname>Gallant</surname><given-names>JL</given-names></name></person-group><year>2006</year><article-title>Complete functional characterization of sensory neurons by system identification</article-title><source>Annual Review of Neuroscience</source><volume>29</volume><fpage>477</fpage><lpage>505</lpage><pub-id pub-id-type="doi">10.1146/annurev.neuro.29.051605.113024</pub-id></element-citation></ref><ref id="bib55"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>K</given-names></name><name><surname>Ginzburg</surname><given-names>I</given-names></name><name><surname>Mcnaughton</surname><given-names>BL</given-names></name><name><surname>Sejnowski</surname><given-names>TJ</given-names></name></person-group><year>1998</year><article-title>Interpreting neuronal population activity by reconstruction: unified framework with application to hippocampal place cells</article-title><source>Journal of Neurophysiology</source><volume>1044</volume><fpage>1017</fpage><lpage>1044</lpage></element-citation></ref></ref-list></back><sub-article article-type="article-commentary" id="SA1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.07192.026</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Bartos</surname><given-names>Marlene</given-names></name><role>Reviewing editor</role><aff><institution>Albert-Ludwigs-Universität Freiburg</institution>, <country>Germany</country></aff></contrib></contrib-group></front-stub><body><boxed-text><p>eLife posts the editorial decision letter and author response on a selection of the published articles (subject to the approval of the authors). An edited version of the letter sent to the authors after peer review is shown, indicating the substantive concerns or comments; minor concerns are not usually shown. Reviewers have the opportunity to discuss the decision before the letter is sent (see <ext-link ext-link-type="uri" xlink:href="http://elifesciences.org/review-process">review process</ext-link>). Similarly, the author response typically shows only responses to the major concerns raised by the reviewers.</p></boxed-text><p>Thank you for sending your work entitled “Optogenetic feedback control of neural activity” for consideration at <italic>eLife</italic>. Your article has been favorably evaluated by Eve Marder (Senior editor) and two reviewers, one of whom is a member of our Board of Reviewing Editors.</p><p>The Reviewing editor and the other reviewer discussed their comments before we reached this decision, and the Reviewing editor has assembled the following comments to help you prepare a revised submission.</p><p>The overall statements of both reviewers were positive. Indeed, the novelty of the technique for reading out and controlling the activity of neuronal networks, was positively valued. However, both reviewers formulated several main concerns, of which two are most salient.</p><p>1) The mechanisms underlying the light-mediated alternation or clamp of neuron excitability are highly dependent on various factors including neuron types expressing ChR2, their cellular and synaptic properties and interconnectivity. It was unclear how these factors may influence the speed and quality of clamping neuronal excitability.</p><p>2) One reviewer pointed out that it is unclear how the activity spreads through the network and how it may change the input. Finally, the reviewer pointed out that the speed of the system is a limiting factor in a fast control of network excitability. The question is whether the speed can be improved. In general, a more thorough discussion of the limitations of the techniques should be discussed. Below you will find the major and minor criticism of the two reviewers.</p><p><italic>Reviewer #1</italic>:</p><p>Major criticism:</p><p>By comparing sinusoidal light application to ChR2 expressing cell populations in comparison to rectangular or triangular light application, the authors observed differences in spike correlations and synchrony in some of the applied light protocols. The problem with this approach is that the resonance behavior of neurons is highly diverse and depends on the intrinsic membrane properties. Thus, any interpretations on the population behavior will depend on the nature of the cells expressing ChR2 and the percent of the contributing neuron types expressing CR2. Thus, the mentioned 'systematic modulation' of neuronal networks at the end of the subsection headed “Proportional-integral control of network firing” is very much dependent on various factors such as cell types, percent of neuron types expressing Chr2, brain area under investigation. This should be discussed in the manuscript.</p><p>Minor criticism:</p><p>At the end of the first paragraph of the subsection headed “Multi-hour control of firing rates” I would propose to replace the wording 'network plasticity' by 'changes in neuronal network dynamics'.</p><p><italic>Reviewer #2</italic>:</p><p>In this manuscript the authors propose a way to measure the input into a neuronal population by quantifying the optogenetic current which is required to keep those cells at a constant firing rate level. They use eNpHR3.0 to balance the lack of inhibition and ChR2 to counteract the lack of excitation in vitro and in vivo. With this method, the authors approximate the input to the neuronal population by the power of the yellow light minus the power of the blue light. Since the study controls for the neuronal firing, the clamp can be used to cancel slow components for several seconds. This was used to keep the neuronal firing rate constant in order to show that the synaptic homeostasis is not dependent on neuronal firing rate. This is a nice application of the method. Overall the paper is well written and the figures are clear. What is missing is a discussion and data about how this method differs from classic patch clamp and how one can deal with the differences. The patch clamp is an important reference since it is relatively easy to understand its advantages and disadvantages.</p><p>While it is tempting to find a network correspondence with a single cell patch clamp, it might be difficult for at least two reasons: indirect network effects and speed. First, the advantage with single cell patch clamp is that there is a minimal impact on the remaining network since only one cell is modified. Here a whole population is modulated. Therefore a crucial question is how this modulation spreads through the network, how this spread changes the processing, and how this spread even will change the input that should be measured in the first place. Second, the main output of the classic voltage clamping is the amount of current that is required to compensate for various currents into a neuron. It is important that the compensation is complete, otherwise the injected current cannot be interpreted easily. This requires the regulator to be very fast. This is relatively easy with the membrane potential and currents for a patched cell, but not for a population of heterogeneously firing cells. It would be even more difficult to control for the firing of an individual neuron. This might explain why the controller needs some time to accumulate the spikes (tau=0.16s). This will unfortunately not be fast enough to follow the very fast transients caused by vibrissa stimulation (see <xref ref-type="fig" rid="fig8">Figure 8A</xref>). Since the control feedback speed probably depends on the temporal resolution of the neuronal signal, it would be interesting to study what happens when the temporal resolution is increased by taking more and more neurons into account. In this case it may be possible to decrease the time constant such that fast network dynamics can be studied.</p></body></sub-article><sub-article article-type="reply" id="SA2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.07192.027</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><p><italic>1) The mechanisms underlying the light-mediated alternation or clamp of neuron excitability are highly dependent on various factors including neuron types expressing ChR2, their cellular and synaptic properties and interconnectivity. It was unclear how these factors may influence the speed and quality of clamping neuronal excitability</italic>.</p><p>To address the concern about how variability of neural circuits and opsin expression profiles might affect features of activity other than the mean firing rate, we have clarified the Results section “Proportional-integral control of network firing” and the Discussion. Specifically, we make it clear that currently our method only controls the mean network firing level. We point out that even during successful control, higher-order characteristics of network activity, such as how the activity spreads through the network following stimulus application, unit-to-unit firing correlations, and firing synchrony remain uncontrolled. We point out that these characteristics are promising candidates for future extensions of our technique. Further, we emphasize that the optoclamp will almost certainly need to be used in combination with other methods in order to isolate mechanisms driving changes in network excitability or information processing that occur during the clamping period.</p><p><italic>2) One reviewer pointed out that it is unclear how the activity spreads through the network and how it may change the input. Finally, the reviewer pointed out that the speed of the system is a limiting factor in a fast control of network excitability. The question is whether the speed can be improved. In general, a more thorough discussion of the limitations of the techniques should be discussed. Below you will find the major and minor criticism of the two reviewers</italic>.</p><p>We have made several changes to improve the clarity and thoroughness of our discussion of the technique’s general limitations. We also address the second reviewers’ concern of loop speed with an additional paragraph in the Discussion.</p><p><italic>Reviewer #1</italic>:</p><p><italic>Major criticism</italic>:</p><p><italic>By comparing sinusoidal light application to ChR2 expressing cell populations in comparison to rectangular or triangular light application, the authors observed differences in spike correlations and synchrony in some of the applied light protocols. The problem with this approach is that the resonance behavior of neurons is highly diverse and depends on the intrinsic membrane properties. Thus, any interpretations on the population behavior will depend on the nature of the cells expressing ChR2 and the percent of the contributing neuron types expressing CR2. Thus, the mentioned 'systematic modulation' of neuronal networks at the end of the subsection headed “Proportional-integral control of network firing” is very much dependent on various factors such as cell types, percent of neuron types expressing Chr2, brain area under investigation. This should be discussed in the manuscript</italic>.</p><p>We thank the reviewer for making this point. Indeed, in its current form, the optoclamp is only capable of controlling the population firing rate. Higher order features of neural activity are not under active control and therefore are likely to be affected by the architecture and resonant dynamics of the circuit whose firing is being controlled. We were aware of this issue in the initial submission and attempted to address it in the Discussion:</p><p>Original: “Further, improved control algorithms might allow control over the heterogeneity of activity levels across cells, and temporal variance of firing activity (regular firing vs. bursting).”</p><p>We agree that this limitation needed a stronger explanation. To address this, we have changed the sentence:</p><p>Original: “Therefore, altering the temporal characteristics of excitatory stimulus waveforms permits systematic modulation of higher-order firing statistics during PI control of firing rate.”</p><p>to:</p><p>“Therefore, altering the temporal characteristics of excitatory stimulus waveforms resulted in remarkably different higher-order firing statistics while still enabling successful PI control of the mean firing rate. This emphasizes the fact that, in its current form, the optoclamp only controls population firing levels and leaves more complex features of neural activity unconstrained and subject to the influence of network connectivity, network dynamics, and the nature of the stimulus signal.” (This appears at the end of the subsection “Proportional-integral control of network firing.”)</p><p>Additionally, in the Discussion, we expand our explanation of this limitation using the following new paragraph:</p><p>“We demonstrated that optical waveforms with very different temporal characteristics could be used to successfully control population firing rate in-vitro […] such as the heterogeneity of activity levels across cells and/or temporal variance of firing activity (e.g. regular firing vs. bursting).”</p><p><italic>Minor criticism</italic>:</p><p><italic>At the end of the first paragraph of the subsection headed “Multi-hour control of firing rates” I would propose to replace the wording 'network plasticity' by 'changes in neuronal network dynamics'</italic>.</p><p>We agree that ‘network plasticity’ was too specific in this context and have made the requested change.</p><p><italic>Reviewer #2</italic>:</p><p><italic>In this manuscript the authors propose a way to measure the input into a neuronal population by quantifying the optogenetic current which is required to keep those cells at a constant firing rate level. They use eNpHR3.0 to balance the lack of inhibition and ChR2 to counteract the lack of excitation in vitro and in vivo. With this method, the authors approximate the input to the neuronal population by the power of the yellow light minus the power of the blue light. Since the study controls for the neuronal firing, the clamp can be used to cancel slow components for several seconds. This was used to keep the neuronal firing rate constant in order to show that the synaptic homeostasis is not dependent on neuronal firing rate. This is a nice application of the method. Overall the paper is well written and the figures are clear. What is missing is a discussion and data about how this method differs from classic patch clamp and how one can deal with the differences. The patch clamp is an important reference since it is relatively easy to understand its advantages and disadvantages</italic>.</p><p>We agree that the voltage clamp offers a nice point for comparison since it is the most widely applied use of feedback control in electrophysiology. Indeed, the Discussion provides a detailed comparison of our method with the voltage clamp to show their analogous features, and to highlight advantages and shortcomings of our technique<bold>.</bold> However, we see how the organization of these paragraphs was unclear, and have made changes to deal with this. In paragraph 4 of the Discussion, we compare the relative abilities of the voltage clamp and optoclamp to provide real-time readout of population and neural excitability, and detail the shortcomings of using voltage and optoclamping to perform these measurements. In paragraph 5, which has been expanded considerably, we state how experimentalists have dealt with imperfections in the voltage clamp technique to make it so powerful and reliable, and state how analogous compensating factors will be needed in to optoclamp to achieve the same result. In paragraph 6, we compare the analogous capabilities of voltage clamp and optoclamp for decoupling the membrane voltage or population firing rate, respectively, from other processes to which it would normally be causally dependent on.</p><p>However, we do stress that our technique and the voltage clamp serve entirely different purposes. Just as the reviewer states in the following paragraph, the voltage clamp is not capable of enforcing control over network dynamics. This is precisely what the optoclamp is designed to do. The firing activity measure obtained through electrical recording serves as a proxy for the firing of a much larger population of cells which are affected by optical input. So, while we agree that it is instructive to compare analogous properties of the two techniques, direct comparison is not meaningful since they are designed for completely different experimental needs.</p><p><italic>While it is tempting to find a network correspondence with a single cell patch clamp, it might be difficult for at least two reasons: indirect network effects and speed. First, the advantage with single cell patch clamp is that there is a minimal impact on the remaining network since only one cell is modified. Here a whole population is modulated. Therefore a crucial question is how this modulation spreads through the network, how this spread changes the processing, and how this spread even will change the input that should be measured in the first place</italic>.</p><p>We agree with the reviewer’s point. We feel that we address this legitimate concern fairly extensively in <xref ref-type="fig" rid="fig4 fig6">Figures 4 and 6</xref> as well as the Discussion. However, we agree that this explanation could have been made clearer. In <xref ref-type="fig" rid="fig4">Figure 4</xref>, we show how using different waveforms during closed loop PI control permits successful clamping of mean firing rates while producing very different correlation and synchrony structures in population activity (we have expanded our discussion of this limitation per the suggestion of Reviewer 1; see above). In <xref ref-type="fig" rid="fig6">Figure 6</xref>, we show how mean firing rate clamping can be achieved even during gross manipulation of network connectivity using different synaptic blockers, but unsurprisingly, the short time-scale features of population firing activity are greatly affected by these perturbations (<xref ref-type="fig" rid="fig6">Figure 6 Avii, Bvii, Cvii</xref>) even though mean firing levels are maintained. In the Discussion, we describe how the presence of uncontrolled features of network activity are analogous to uncontrolled variables during voltage clamping:</p><p>“One shortcoming [of the optoclamp] is that it is difficult to identify the origin of changes in network excitability that appear in optical control signals since they result from the aggregate effect of many different processes. However, parallel limitations also exist for the voltage clamp. For example, when using voltage clamp, it can be difficult to distinguish contributions from different neurotransmitter systems and intrinsic conductances or to deduce the relationship between synaptic currents measured at the recording site versus at the site of receptor binding.”</p><p>“Another issue with both optical clamping and the voltage clamp is that the control signal can be contaminated by non-ideal aspects of the recording or stimulation setup. For instance, opsin desensitization could affect the intensity of light required for the optoclamp to maintain firing levels. Likewise, space clamp and seal stability issues that arise during voltage clamp influence the amount of current required to hold a target membrane potential.”</p><p>In the original Discussion, we then went on to describe how these issues were tackled in the case of the voltage clamp and emphasize that any practical use of our technique will require analogous treatment. However, this section could have been clearer and more direct. To address this issue, we have modified the Discussion to emphasize that the optoclamp will almost certainly need to be used in combination with other methods in order to isolate mechanisms driving changes in network excitability or information processing that occur during the clamping period. Specifically, we added the following paragraph in the Discussion:</p><p>“In the case of the voltage clamp, these issues are partially compensated for by using secondary measurements of seal quality […] the optoclamp can be combined with existing pharmacological, genetic, or electrophysiological tools to isolate specific mechanisms that influence network excitability following clamping (Fong 2015).”</p><p><italic>Second, the main output of the classic voltage clamping is the amount of current that is required to compensate for various currents into a neuron. It is important that the compensation is complete, otherwise the injected current cannot be interpreted easily. This requires the regulator to be very fast. This is relatively easy with the membrane potential and currents for a patched cell, but not for a population of heterogeneously firing cells. It would be even more difficult to control for the firing of an individual neuron. This might explain why the controller needs some time to accumulate the spikes (tau=0.16s). This will unfortunately not be fast enough to follow the very fast transients caused by vibrissa stimulation (see</italic> <xref ref-type="fig" rid="fig8"><italic>Figure 8A</italic></xref><italic>). Since the control feedback speed probably depends on the temporal resolution of the neuronal signal, it would be interesting to study what happens when the temporal resolution is increased by taking more and more neurons into account. In this case it may be possible to decrease the time constant such that fast network dynamics can be studied</italic>.</p><p>We agree with the reviewer. To address this concern, we have added the following text to the Discussion:</p><p>“Additionally, decreased feedback latency or the addition of predictive elements to the feedback loop may enable control over rapid sensory or motor events […] for which accurate input/output relationships can be deduced in situ using real-time system identification (Grosenick 2015).”</p></body></sub-article></article>