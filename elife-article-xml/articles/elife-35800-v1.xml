<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1 20151215//EN"  "JATS-archivearticle1.dtd"><article article-type="research-article" dtd-version="1.1" xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn pub-type="epub" publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">35800</article-id><article-id pub-id-type="doi">10.7554/eLife.35800</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Tools and Resources</subject></subj-group><subj-group subj-group-type="heading"><subject>Cell Biology</subject></subj-group><subj-group subj-group-type="heading"><subject>Computational and Systems Biology</subject></subj-group></article-categories><title-group><article-title>Removing physiological motion from intravital and clinical functional imaging data</article-title></title-group><contrib-group><contrib contrib-type="author" corresp="yes" id="author-75299"><name><surname>Warren</surname><given-names>Sean C</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0002-5253-7147</contrib-id><email>s.warren@garvan.org.au</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="other" rid="fund4"/><xref ref-type="other" rid="fund5"/><xref ref-type="other" rid="fund6"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106788"><name><surname>Nobis</surname><given-names>Max</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0002-1861-1390</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="other" rid="fund4"/><xref ref-type="other" rid="fund5"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="other" rid="fund11"/><xref ref-type="other" rid="fund12"/><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106789"><name><surname>Magenau</surname><given-names>Astrid</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="other" rid="fund4"/><xref ref-type="other" rid="fund5"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="fn" rid="con3"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106791"><name><surname>Mohammed</surname><given-names>Yousuf H</given-names></name><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="fn" rid="con4"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106792"><name><surname>Herrmann</surname><given-names>David</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0002-9514-7501</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="other" rid="fund4"/><xref ref-type="other" rid="fund5"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="other" rid="fund11"/><xref ref-type="other" rid="fund12"/><xref ref-type="other" rid="fund13"/><xref ref-type="other" rid="fund14"/><xref ref-type="fn" rid="con5"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106793"><name><surname>Moran</surname><given-names>Imogen</given-names></name><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="aff" rid="aff4">4</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="fn" rid="con6"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106794"><name><surname>Vennin</surname><given-names>Claire</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="other" rid="fund4"/><xref ref-type="other" rid="fund5"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="fn" rid="con7"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106795"><name><surname>Conway</surname><given-names>James RW</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="other" rid="fund4"/><xref ref-type="other" rid="fund5"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="fn" rid="con8"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106796"><name><surname>Mélénec</surname><given-names>Pauline</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="fn" rid="con9"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106797"><name><surname>Cox</surname><given-names>Thomas R</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-9294-1745</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund6"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="fn" rid="con10"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106798"><name><surname>Wang</surname><given-names>Yingxiao</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0003-0265-326X</contrib-id><xref ref-type="aff" rid="aff5">5</xref><xref ref-type="fn" rid="con11"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106799"><name><surname>Morton</surname><given-names>Jennifer P</given-names></name><xref ref-type="aff" rid="aff6">6</xref><xref ref-type="fn" rid="con12"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106800"><name><surname>Welch</surname><given-names>Heidi CE</given-names></name><xref ref-type="aff" rid="aff7">7</xref><xref ref-type="other" rid="fund15"/><xref ref-type="fn" rid="con13"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106801"><name><surname>Strathdee</surname><given-names>Douglas</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0003-2959-4327</contrib-id><xref ref-type="aff" rid="aff6">6</xref><xref ref-type="fn" rid="con14"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106802"><name><surname>Anderson</surname><given-names>Kurt I</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0002-9324-9598</contrib-id><xref ref-type="aff" rid="aff6">6</xref><xref ref-type="aff" rid="aff8">8</xref><xref ref-type="fn" rid="con15"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-28226"><name><surname>Phan</surname><given-names>Tri Giang</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-4909-2984</contrib-id><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="aff" rid="aff4">4</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="fn" rid="con16"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-106803"><name><surname>Roberts</surname><given-names>Michael S</given-names></name><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="aff" rid="aff9">9</xref><xref ref-type="fn" rid="con17"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" corresp="yes" id="author-97287"><name><surname>Timpson</surname><given-names>Paul</given-names></name><email>p.timpson@garvan.org.au</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="other" rid="fund4"/><xref ref-type="other" rid="fund5"/><xref ref-type="other" rid="fund6"/><xref ref-type="other" rid="fund7"/><xref ref-type="other" rid="fund8"/><xref ref-type="other" rid="fund9"/><xref ref-type="other" rid="fund10"/><xref ref-type="other" rid="fund13"/><xref ref-type="other" rid="fund14"/><xref ref-type="fn" rid="con18"/><xref ref-type="fn" rid="conf1"/></contrib><aff id="aff1"><label>1</label><institution content-type="dept">Kinghorn Cancer Centre, Garvan Institute of Medical Research</institution><institution>University of New South Wales</institution><addr-line><named-content content-type="city">Sydney</named-content></addr-line><country>Australia</country></aff><aff id="aff2"><label>2</label><institution content-type="dept">St Vincent's Clinical School, Faculty of Medicine</institution><institution>University of New South Wales</institution><addr-line><named-content content-type="city">Sydney</named-content></addr-line><country>Australia</country></aff><aff id="aff3"><label>3</label><institution content-type="dept">Therapeutics Research Centre, Diamantina Institute, Faculty of Medicine</institution><institution>University of Queensland</institution><addr-line><named-content content-type="city">Woolloongabba</named-content></addr-line><country>Australia</country></aff><aff id="aff4"><label>4</label><institution content-type="dept">Immunology Division</institution><institution>Garvan Institute of Medical Research</institution><addr-line><named-content content-type="city">Sydney</named-content></addr-line><country>Australia</country></aff><aff id="aff5"><label>5</label><institution content-type="dept">Department of Bioengineering, Institute of Engineering in Medicine</institution><institution>University of California, San Diego</institution><addr-line><named-content content-type="city">San Diego</named-content></addr-line><country>United States</country></aff><aff id="aff6"><label>6</label><institution>Cancer Research UK Beatson Institute</institution><addr-line><named-content content-type="city">Glasgow</named-content></addr-line><country>United Kingdom</country></aff><aff id="aff7"><label>7</label><institution content-type="dept">Signalling Programme</institution><institution>Babraham Institute</institution><addr-line><named-content content-type="city">Cambridge</named-content></addr-line><country>United Kingdom</country></aff><aff id="aff8"><label>8</label><institution>Francis Crick Institute</institution><addr-line><named-content content-type="city">London</named-content></addr-line><country>United Kingdom</country></aff><aff id="aff9"><label>9</label><institution content-type="dept">Therapeutics Research Centre, School of Pharmacy and Medical Sciences</institution><institution>University of South Australia</institution><addr-line><named-content content-type="city">Adelaide</named-content></addr-line><country>Australia</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor" id="author-8518"><name><surname>Akhmanova</surname><given-names>Anna</given-names></name><role>Reviewing Editor</role><aff id="aff10"><institution>Utrecht University</institution><country>Netherlands</country></aff></contrib></contrib-group><pub-date date-type="publication" publication-format="electronic"><day>09</day><month>07</month><year>2018</year></pub-date><pub-date pub-type="collection"><year>2018</year></pub-date><volume>7</volume><elocation-id>e35800</elocation-id><history><date date-type="received" iso-8601-date="2018-02-09"><day>09</day><month>02</month><year>2018</year></date><date date-type="accepted" iso-8601-date="2018-06-08"><day>08</day><month>06</month><year>2018</year></date></history><permissions><copyright-statement>© 2018, Warren et al</copyright-statement><copyright-year>2018</copyright-year><copyright-holder>Warren et al</copyright-holder><ali:free_to_read/><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><ali:license_ref>http://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-35800-v1.pdf"/><abstract><object-id pub-id-type="doi">10.7554/eLife.35800.001</object-id><p>Intravital microscopy can provide unique insights into the function of biological processes in a native context. However, physiological motion caused by peristalsis, respiration and the heartbeat can present a significant challenge, particularly for functional readouts such as fluorescence lifetime imaging (FLIM), which require longer acquisition times to obtain a quantitative readout. Here, we present and benchmark <italic>Galene</italic>, a versatile multi-platform software tool for image-based correction of sample motion blurring in both time resolved and conventional laser scanning fluorescence microscopy data in two and three dimensions. We show that <italic>Galene</italic> is able to resolve intravital FLIM-FRET images of intra-abdominal organs in murine models and NADH autofluorescence of human dermal tissue imaging subject to a wide range of physiological motions. Thus, <italic>Galene</italic> can enable FLIM imaging in situations where a stable imaging platform is not always possible and rescue previously discarded quantitative imaging data.</p></abstract><abstract abstract-type="executive-summary"><object-id pub-id-type="doi">10.7554/eLife.35800.002</object-id><title>eLife digest</title><p>Understanding how molecules and cells behave in living animals can give researchers key insights into what goes wrong in diseases such as cancer, and how well potential treatments for these diseases work. A number of tools help us to see these processes. For example, fluorescent ‘biosensors’ change colour to tell us how active a particular protein is. This can indicate how well a drug works in different parts of a tumour.</p><p>High resolution microscopy makes it possible to image events happening in single cells, or even specific parts of a cell. However, small movements like those due to the heartbeat or breathing can blur the images, making it difficult to study living animals. This is particularly problematic for images that take several minutes to capture.</p><p>Warren et al. have now developed a new open source software tool called Galene. The tool can correct for small movements in images collected by a technique called fluorescence lifetime imaging microscopy (FLIM). As a result, clear images can be captured in situations that were not previously possible. For example, Warren et al. watched cancer cells migrating to the liver of a mouse from the spleen over 24 hours, and, using a fluorescent biosensor, showed that a repurposed drug interferes with how well the cells can attach to the liver. In addition, Warren et al. used the software to take steady 3D images of human skin in a volunteer’s arm, which could be used to study drug penetration.</p><p>Galene could help researchers to study a wide range of biological processes in living animals. The software can also be applied to existing data to clean up blurred images. In the future Galene could be further developed to work with the imaging techniques used during surgery. For example, surgeons could use it to help them find the edges of tumours.</p></abstract><kwd-group kwd-group-type="author-keywords"><kwd>FLIM</kwd><kwd>FRET</kwd><kwd>motion correction</kwd><kwd>intravital microscopy</kwd><kwd>multiphoton</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd>Human</kwd><kwd>Mouse</kwd></kwd-group><funding-group><award-group id="fund1"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100000925</institution-id><institution>National Health and Medical Research Council</institution></institution-wrap></funding-source><award-id>1139865</award-id><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Magenau</surname><given-names>Astrid</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Moran</surname><given-names>Imogen</given-names></name><name><surname>Vennin</surname><given-names>Claire</given-names></name><name><surname>Conway</surname><given-names>James RW</given-names></name><name><surname>Mélénec</surname><given-names>Pauline</given-names></name><name><surname>Cox</surname><given-names>Thomas R</given-names></name><name><surname>Phan</surname><given-names>Tri Giang</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund2"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001102</institution-id><institution>Cancer Council NSW</institution></institution-wrap></funding-source><award-id>RG 14-08</award-id><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Magenau</surname><given-names>Astrid</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Vennin</surname><given-names>Claire</given-names></name><name><surname>Conway</surname><given-names>James RW</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund3"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001111</institution-id><institution>Cancer Australia</institution></institution-wrap></funding-source><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Magenau</surname><given-names>Astrid</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Vennin</surname><given-names>Claire</given-names></name><name><surname>Conway</surname><given-names>James RW</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund4"><funding-source><institution-wrap><institution>Tour de Cure, Australia</institution></institution-wrap></funding-source><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Magenau</surname><given-names>Astrid</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Vennin</surname><given-names>Claire</given-names></name><name><surname>Conway</surname><given-names>James RW</given-names></name><name><surname>Mélénec</surname><given-names>Pauline</given-names></name></principal-award-recipient></award-group><award-group id="fund5"><funding-source><institution-wrap><institution>Len Ainsworth Pancreatic Cancer Research Fellowship</institution></institution-wrap></funding-source><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Magenau</surname><given-names>Astrid</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Vennin</surname><given-names>Claire</given-names></name><name><surname>Conway</surname><given-names>James RW</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund6"><funding-source><institution-wrap><institution>Avner Pancreatic Cancer Foundation</institution></institution-wrap></funding-source><award-id>R3-PT</award-id><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Cox</surname><given-names>Thomas R</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund7"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100000925</institution-id><institution>National Health and Medical Research Council</institution></institution-wrap></funding-source><award-id>112468</award-id><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Magenau</surname><given-names>Astrid</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Moran</surname><given-names>Imogen</given-names></name><name><surname>Vennin</surname><given-names>Claire</given-names></name><name><surname>Conway</surname><given-names>James RW</given-names></name><name><surname>Mélénec</surname><given-names>Pauline</given-names></name><name><surname>Cox</surname><given-names>Thomas R</given-names></name><name><surname>Phan</surname><given-names>Tri Giang</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund8"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100000925</institution-id><institution>National Health and Medical Research Council</institution></institution-wrap></funding-source><award-id>1089497</award-id><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Magenau</surname><given-names>Astrid</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Moran</surname><given-names>Imogen</given-names></name><name><surname>Vennin</surname><given-names>Claire</given-names></name><name><surname>Conway</surname><given-names>James RW</given-names></name><name><surname>Mélénec</surname><given-names>Pauline</given-names></name><name><surname>Cox</surname><given-names>Thomas R</given-names></name><name><surname>Phan</surname><given-names>Tri Giang</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund9"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100000925</institution-id><institution>National Health and Medical Research Council</institution></institution-wrap></funding-source><award-id>1105640</award-id><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Magenau</surname><given-names>Astrid</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Moran</surname><given-names>Imogen</given-names></name><name><surname>Vennin</surname><given-names>Claire</given-names></name><name><surname>Conway</surname><given-names>James RW</given-names></name><name><surname>Mélénec</surname><given-names>Pauline</given-names></name><name><surname>Cox</surname><given-names>Thomas R</given-names></name><name><surname>Phan</surname><given-names>Tri Giang</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund10"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100000925</institution-id><institution>National Health and Medical Research Council</institution></institution-wrap></funding-source><award-id>1129401</award-id><principal-award-recipient><name><surname>Warren</surname><given-names>Sean C</given-names></name><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Magenau</surname><given-names>Astrid</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Moran</surname><given-names>Imogen</given-names></name><name><surname>Vennin</surname><given-names>Claire</given-names></name><name><surname>Conway</surname><given-names>James RW</given-names></name><name><surname>Mélénec</surname><given-names>Pauline</given-names></name><name><surname>Cox</surname><given-names>Thomas R</given-names></name><name><surname>Phan</surname><given-names>Tri Giang</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund11"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001171</institution-id><institution>Cancer Institute NSW</institution></institution-wrap></funding-source><award-id>31329475</award-id><principal-award-recipient><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name></principal-award-recipient></award-group><award-group id="fund12"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001171</institution-id><institution>Cancer Institute NSW</institution></institution-wrap></funding-source><award-id>31329983</award-id><principal-award-recipient><name><surname>Nobis</surname><given-names>Max</given-names></name><name><surname>Herrmann</surname><given-names>David</given-names></name></principal-award-recipient></award-group><award-group id="fund13"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001026</institution-id><institution>National Breast Cancer Foundation</institution></institution-wrap></funding-source><award-id>IN-17-070</award-id><principal-award-recipient><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund14"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100012187</institution-id><institution>St. Vincent's Clinic Foundation</institution></institution-wrap></funding-source><principal-award-recipient><name><surname>Herrmann</surname><given-names>David</given-names></name><name><surname>Timpson</surname><given-names>Paul</given-names></name></principal-award-recipient></award-group><award-group id="fund15"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100000268</institution-id><institution>Biotechnology and Biological Sciences Research Council</institution></institution-wrap></funding-source><award-id>Institute Strategic Programme Grant BB/P013384/1</award-id><principal-award-recipient><name><surname>Welch</surname><given-names>Heidi CE</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>Image-based motion correction enables the use of fluorescence lifetime and other functional imaging modalities in an intravital and clinical context in the presence of physiological motion.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>In recent years, a number of fluorescence imaging techniques such as fluorescence lifetime imaging microscopy (FLIM) have allowed researchers to visualize not only the structure but also the activity and function of molecules in living cells and tissues. Genetically-expressed Förster resonant energy transfer (FRET)-based biosensors enable researchers to probe signalling events in native tissues (<xref ref-type="bibr" rid="bib11">Conway et al., 2017</xref>; <xref ref-type="bibr" rid="bib16">Ellenbroek and van Rheenen, 2014</xref>; <xref ref-type="bibr" rid="bib49">Nobis et al., 2018</xref>) where they can provide spatio-temporal information about drug target response in a tumour (<xref ref-type="bibr" rid="bib10">Conway et al., 2018</xref>, <xref ref-type="bibr" rid="bib9">2014</xref>; <xref ref-type="bibr" rid="bib25">Hirata et al., 2015</xref>; <xref ref-type="bibr" rid="bib47">Nobis et al., 2017</xref>, <xref ref-type="bibr" rid="bib48">2013</xref>) or dynamic signalling events in migrating cells (<xref ref-type="bibr" rid="bib43">Mizuno et al., 2016</xref>). Time resolved imaging of NADH autofluorescence (<xref ref-type="bibr" rid="bib5">Blacker and Duchen, 2016</xref>; <xref ref-type="bibr" rid="bib62">Skala et al., 2007</xref>) can be used to probe the metabolic state of cells and multispectral imaging (<xref ref-type="bibr" rid="bib51">Patalay et al., 2012</xref>) has been investigated for the diagnosis of dermatitis and malignant melanoma (<xref ref-type="bibr" rid="bib35">König, 2012</xref>), among other applications. Hyperspectral imaging, time resolved imaging in multiple spectral channels, can be used to extract microenvironmental information from autofluorescence (<xref ref-type="bibr" rid="bib12">Cutrale et al., 2017</xref>). These techniques depend on measuring small changes in the fluorescence signal, such as a small change in lifetime or change in spectral properties. Consequently, more signal is required to determine the parameters of interest, often necessitating relatively long integration times. This requirement has proved to be a significant constraint to the uptake of FLIM in intravital microscopy, where physiological motion due to, for example peristalsis, respiration or the heartbeat can induce significant motion during the image acquisition. This motion can often be tolerated in intensity-based imaging where acquisition times are short. However, when an image must be integrated over tens or even hundreds of seconds, sample motion rapidly renders the image unintelligible. While physical restraints such as tissue clamping or the application of negative pressure, may be used to limit the sample motion to a degree, this approach is not always effective to the extent required for high resolution microscopy and, in some cases, can compromise the sample integrity. Given the increasingly wide application of both intravital and FLIM imaging, there is a growing need to enable the functional readouts provided by FLIM even in the presence of physiological motion (<xref ref-type="bibr" rid="bib9">Conway et al., 2014</xref>). Here, we describe a motion blurring compensation approach using image-based realignment that can be applied directly to data acquired on existing commercial and clinical FLIM and conventional fluorescence microscopy systems in two and three dimensions in post processing.</p><p>FLIM is most commonly implemented using laser scanning microscopy (LSM). To acquire sufficient number of photons, an image is constructed by integrating the photon signal over many frames (passes over the scan area). A typical FLIM image may take several minutes to acquire and so is susceptible to motion blurring from physiological motion. Several image-based approaches have been used to correct for sample motion in intensity-based time lapse data without additional measurements in the context of LSM time series acquisitions. (i) Where the motion is slow relative to the frame rate, (e.g. a slow drift), rigid body image registration (<xref ref-type="bibr" rid="bib69">Thévenaz et al., 1998</xref>) or feature-based registration such as Scale Invariant Feature Transform (SIFT)-based algorithms have been applied to correct for the motion, (ii) When the motion is intermittent, frames captured during the motion may be automatically detected and excluded from the time series (<xref ref-type="bibr" rid="bib64">Soulet et al., 2013</xref>), and (iii) When the motion is fast relative to the frame rate, each frame will appear distorted as the sample moves while the laser is scanned across the field of view. In this case, more advanced approaches that model the intra-frame motion using methods such as Hidden-Markov-Models (<xref ref-type="bibr" rid="bib15">Dombeck et al., 2007</xref>), the Lucas–Kanade framework (<xref ref-type="bibr" rid="bib23">Greenberg and Kerr, 2009</xref>), or algorithms based on Lie groups (<xref ref-type="bibr" rid="bib71">Vercauteren et al., 2006</xref>) have been employed. These techniques have not, to date, been applied to FLIM data. This is because during FLIM acquisition, histograms of photon arrival times are typically accumulated to produce a single image. In this approach, blurring due to sample motion is ‘baked into’ the data and thus cannot be compensated. More recently, however, improved device-computer bandwidth and storage have enabled the recording of individual photon arrival times and markers associated with the scan frame and line clocks (<xref ref-type="bibr" rid="bib3">Becker et al., 2006</xref>). Most modern commercial time-correlated single photon counting (TCSPC) FLIM systems support this mode, often by default.</p><p>Here, we describe an approach whereby we reconstruct each frame from this time-tagged FLIM data and determine the motion both between and within each frame using an approach based on the Lucas-Kanade framework (<xref ref-type="bibr" rid="bib1">Baker and Matthews, 2004</xref>). We have implemented these algorithms in a new open source package, <italic>Galene</italic>, which can be used to correct for motion in two- and three-dimensional FLIM data collected using widely deployed commercial systems. We first evaluate the range of motions that can be effectively compensated using simulated data and compare the performance of <italic>Galene’s</italic> core motion correction algorithms with open source and commercially available motion correction tools. We then validate our approach using intravital imaging of a number of FRET biosensors in vivo in a murine system and in clinical applications by imaging autofluorescence of human skin. While the main focus of this manuscript is motion correction of time resolved data, we show that <italic>Galene</italic> may also be used to correct conventional fluorescence microscopy data using intravital 3D multispectral imaging data of labelled immune cells in the murine lymph node highlighting its wider application for intravital imaging applications.</p></sec><sec id="s2" sec-type="results"><title>Results</title><sec id="s2-1"><title>Correction for motion in time-tagged, time-resolved FLIM data</title><p>The motion correction procedure is illustrated schematically in <xref ref-type="fig" rid="fig1">Figure 1</xref> and outlined in <xref ref-type="video" rid="video1">Video 1</xref>. We acquire FLIM data in a time-tagged time-resolved (TTTR) mode whereby each photon arrival time is recorded alongside frame and line markers, which allow us to locate each photon within the image. From these data, we first reconstruct the intensity of each constituent frame, or, in the 3D case, stack of frames (<xref ref-type="fig" rid="fig1">Figure 1A–C</xref>), that make up the image. We use these intensity data to determine the sample motion during the image acquisition relative to a reference stack (<xref ref-type="fig" rid="fig1">Figure 1D–H</xref>). For each stack, we first perform a fast, rigid realignment using a 3D generalisation of the phase correlation method (<xref ref-type="bibr" rid="bib20">Foroosh et al., 2002</xref>). This corrects for coarse sample displacements but cannot correct for sample motion during the stack, which leads to distortions, rather than simply displacement of the stack. To estimate the displacement of the sample during the stack acquisition, we use a fitting approach where we account explicitly for the raster scan pattern used to acquire the data following the approach of <xref ref-type="bibr" rid="bib23">Greenberg and Kerr (2009</xref>). The microscope takes a finite time to scan over the stack. We assume that the sample moves linearly between a series of initially unknown two- or three-dimensional displacements spaced equally through the scan duration. For a given set of displacements, we know where the sample was when the microscope acquired each pixel, and we can thus reconstruct the undistorted stack by three-dimensional interpolation and compare this reconstruction to the reference stack. By estimating the motion at a number of points across the image, we can account for motion in both the fast-axis, which appears as a ‘wave-like’ pattern in the data, and in the slow axis, which appears as compression or expansion of sections of the image. We can then determine the sample motion during the stack acquisition by finding the set of displacements which minimises the difference between the corrected stack and the reference stack using a trust-region non-linear optimisation algorithm. This approach requires that we compute the Jacobian of this error function, that is the gradient of the difference between the two stacks at each pixel with respect to the unknown displacement parameters. To perform this optimisation efficiently we use a variant of the inverse-compositional Lucas-Kanade algorithm (<xref ref-type="bibr" rid="bib41">Lucas and Kanade, 1981</xref>), used extensively in image registration applications (<xref ref-type="bibr" rid="bib1">Baker and Matthews, 2004</xref>); its key insight is that, rather than calculating the gradient of the interpolated stack at every iteration, a computationally expensive procedure, we can instead use the gradient of the reference stack, which is of course invariant (<xref ref-type="bibr" rid="bib1">Baker and Matthews, 2004</xref>). This optimisation yields an estimate of the sample motion during the scan. With this sample displacement information, the FLIM image can be reconstructed accounting for the motion, reassigning each photon arrival to the correct pixel producing a distortion-free image (<xref ref-type="fig" rid="fig1">Figure 1I–L</xref>). We use the displacement information to determine the effective dwell time in each pixel (which will vary across the image due to the sample motion). This information is stored alongside the corrected FLIM data and may be used when displaying intensity-merged FLIM data.</p><fig id="fig1" position="float"><object-id pub-id-type="doi">10.7554/eLife.35800.003</object-id><label>Figure 1.</label><caption><title>Illustration of motion correction procedure.</title><p>(<bold>A</bold>) Intensity merged FLIM image of intestinal crypt acquired in vivo using a titanium optical window from a Rac1 FRET biosensor mouse, composed of 443 separate frames. (<bold>B</bold>) As the data are acquired in a time-tagged mode, the arrival time and position of each photon in the dataset can be extracted. (<bold>C</bold>) Using these data, the intensity of each frame can be reconstructed. (<bold>D</bold>) One frame is selected as the reference (magenta). To realign subsequent frames (example shown in green), (<bold>E</bold>) a rigid realignment step is first performed, estimating the coarse offset between the images. (<bold>F</bold>) To estimate the motion during the frame leading the residual difference between the two images, we select a number of points equally spaced in time during the frame scan and estimate the displacement of the sample at each point (red arrows). (<bold>G</bold>) We use the rigid realignment as the initial estimate for the displacement. (<bold>H</bold>) As the fit progresses, the displacement estimates reduce the difference between the two images. The displacement of pixels between each point are computed using linear interpolation (grey arrows). The (<bold>I</bold>) displacement during each frame and (<bold>J</bold>) correlation between each frame and the reference is computed by repeating this process for each frame. (<bold>K</bold>) The FLIM image is reprocessed and each photon arrival is reassigned to its estimated origin point on the sample using the interpolated displacements. (<bold>L</bold>) The final intensity merged FLIM image can then be analyzed using conventional approaches. Mouse and intestine illustrations were adapted from Servier Medial Art, licensed under the Creative Commons Attribution 3.0 Unported license.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig1-v1"/></fig><media id="video1" mime-subtype="mp4" mimetype="video" xlink:href="elife-35800-video1.mp4"><object-id pub-id-type="doi">10.7554/eLife.35800.004</object-id><label>Video 1.</label><caption><title>Video abstract.</title><p>Overview of motion correction using <italic>Galene</italic>.</p></caption></media></sec><sec id="s2-2"><title>Evaluating performance limits using simulated FLIM data</title><p>To determine the range of amplitudes and frequencies of sample motion that can be reliably corrected, we used Monte Carlo simulations of FLIM data in the presence of sample motion (<xref ref-type="fig" rid="fig2">Figure 2A</xref>). We compare these results with reference to average values for physiological events known to impair image acquisition; the heartrate (red arrow, 350 bpm, ~6 Hz) and respiratory rate (blue arrow, 60 bpm, 1 Hz) of an adult mouse anaesthetized under ~1% isoflurane (<xref ref-type="bibr" rid="bib19">Ewald et al., 2011</xref>) are shown. <xref ref-type="fig" rid="fig2">Figure 2B</xref> shows the average correlation coefficient, a measure of how well the correction has performed, for a range of frequencies and amplitudes of motion relative to the field of view (FOV) size. We observed that the system could compensate for motion parallel to the fast axis (0°) more effectively than motion parallel to the slow axis (90°); this is unsurprising as motion in the slow axis will result in whole lines of the sample being sampled either twice or not at all. <xref ref-type="fig" rid="fig2">Figure 2C–G</xref> illustrate several example alignment results with different motion conditions; the red dots indicate the location on the frequency-magnitude plot shown in <xref ref-type="fig" rid="fig2">Figure 2B</xref> for each condition. <xref ref-type="fig" rid="fig2">Figure 2C and D</xref> show, respectively, slow (1.5 Hz) and fast (6 Hz) motion with the same magnitude of ~10% of the FOV aligned with scanner fast axis. Here, we can effectively correct for the motion as shown in the realigned images and estimated displacements plotted with the simulated displacements. <xref ref-type="fig" rid="fig2">Figure 2E</xref> shows fast motion at 45° to the fast axis; again, we can effectively compensate for this motion although the resultant realigned image is marginally degraded. <xref ref-type="fig" rid="fig2">Figure 2F</xref> shows a larger (higher magnitude) motion, approximately ~20% of the field of view at 45° to the fast axis. In this case, we are not able to effectively compensate for the motion, and the realigned image is significantly degraded. We note that a similar motion along the fast axis could be corrected (see matching point on <xref ref-type="fig" rid="fig2">Figure 2Bi</xref>). <xref ref-type="fig" rid="fig2">Figure 2G</xref> shows a very large (~30% of the field of view) motion along the slow axis, which we are unable to correct. We note that the range of amplitudes and frequencies that <italic>Galene</italic> is able to correct covers a broad range of physiologically relevant motions commonly observed during functional intravital imaging and will therefore be of use in a range of in vivo imaging applications.</p><fig-group><fig id="fig2" position="float"><object-id pub-id-type="doi">10.7554/eLife.35800.005</object-id><label>Figure 2.</label><caption><title>Evaluation of motion correction performance with simulated data.</title><p>(<bold>A</bold>) Illustration of generation of a frame in a simulated TTTR dataset. Main image shows high SNR intensity image used as the reference sample intensity. Red lines indicate the sample motion during the illustrated frame. Inset image shows the resultant simulated frame. (<bold>B</bold>) Average correlation coefficient over a range of magnitudes and frequencies of sinusoidal sample motion along an axis (i) 0°, (ii) 45° and (iii) 90°, respectively, from the fast axis. For comparison, indicative average values for the heart rate (<italic>red arrow</italic>, 350 bpm, 5.8 Hz) and respiration rate (<italic>blue arrow</italic>, 60 bpm, 1 Hz) of an adult mouse anaesthetized under ~1% isoflurane are shown. Black dots indicate results illustrated in the following panels. (<bold>C–G</bold>) Exemplar simulation results showing intensity merged lifetime images (i) without and (ii) with motion compensation. (iii) Estimated displacement traces in (<italic>blue</italic>) x and (<italic>red</italic>) y directions over time. In D-Giii, inset panels show expanded views of displacements between 1 and 3 s. (iv) Correlation between reference frame and (<italic>red</italic>) uncorrected and (<italic>blue</italic>) corrected images over time. Examples shown in C–E were corrected successfully, while the motion in examples F and G was too large to effectively compensate. (<bold>C</bold>) Motion parallel to fast axis with frequency 1.5 Hz and magnitude 10% of FOV. (<bold>D</bold>) Motion parallel to fast axis with frequency 6 Hz and magnitude 10% of FOV. (<bold>E</bold>) Motion at 45° to fast axis with frequency 6 Hz and magnitude 10% of FOV. (<bold>F</bold>) Motion at 45° to fast axis with frequency 6 Hz and magnitude 20% of FOV. (<bold>G</bold>) Motion at 90° to fast axis with frequency 6 Hz and magnitude 28% of FOV.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig2-v1"/></fig><fig id="fig2s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.35800.006</object-id><label>Figure 2—figure supplement 1.</label><caption><title>Benchmarking of intensity-only motion correction performance with simulated data.</title><p>Intensity time-series data were generated by temporal averaging of the simulated data with motion at 45° to the fast-axis used in <xref ref-type="fig" rid="fig2">Figure 2</xref>. The data were motion corrected using a panel of open source packages. (<bold>A</bold>) Average correlation coefficient over a range of magnitudes and frequencies of sinusoidal sample using (i) no correction, (ii) ImageJ plugin StackReg, (iii) ImageJ plugin ‘Linear Stack Alignment with SIFT,’ (iv) python package SIMA and (v) Galene. For comparison, indicative average values for the heart rate (<italic>red arrow</italic>, 350 bpm, 5.8 Hz) and respiration rate (<italic>blue arrow</italic>, 60 bpm, 1 Hz) of an adult mouse anaesthetized under ~1% isoflurane are shown. Red dots indicate results illustrated in the following panels (<bold>B-D</bold>) Exemplar simulation results showing frame-averaged motion correction results for a number of simulation conditions (marked by red dots in (<bold>A</bold>)). The examples represents approximately (<bold>B</bold>) a small motion due to respiration, (<bold>C</bold>) a small motion due to the heart beat and (<bold>D</bold>) a larger motion relative to the FOV due to the heartbeat (e.g. zoomed in on a small region or experiencing a large displacement).</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig2-figsupp1-v1"/></fig></fig-group></sec><sec id="s2-3"><title>Comparison with other software packages for intensity-based realignment</title><p>We compared the core motion correction algorithm used by <italic>Galene</italic> with three open source motion correction packages using intensity-only data. We used two ImageJ plugins, StackReg, implementing a rigid registration algorithm (<xref ref-type="bibr" rid="bib69">Thévenaz et al., 1998</xref>) and ‘Linear Stack Alignment with SIFT’, an approach based on the Scale Invariant Feature Transform (<xref ref-type="bibr" rid="bib40">Lowe, 2004</xref>). We also evaluated the python package SIMA (<xref ref-type="bibr" rid="bib29">Kaifosh et al., 2014</xref>), which uses a Hidden Markov Model (HMM)-based approach (<xref ref-type="bibr" rid="bib15">Dombeck et al., 2007</xref>). We generated simulated time lapse intensity data with sample motion at 45° to the fast axis over a range of amplitudes and frequencies. We performed motion correction of these data with each software package and plotted the average correlation between each motion corrected frame and the reference frame as a function of frequency and amplitude of motion (<xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>). StackReg and SIFT both correct for rigid transformations between each frame and so are unable to cope with the distortion produced by LSM with a moving sample; consequently, these packages are only able to correct for low frequency motion (as, for example, encountered during slow sample drifts where the observed motion artefact can be approximated by a linear transformation (for example, <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1B</xref>). SIMA uses a HMM model which uses information about the laser scan pattern and so is able to cope with a larger range of motion (for example, <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1C</xref>, equivalent to a small displacement caused by the heartbeat). However, <italic>Galene</italic> is able to correct for significantly larger sample motions than SIMA (compare <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1Aiv</xref>, SIMA and v, <italic>Galene</italic>), for example the larger motion shown in <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1D</xref>, corresponding to a larger motion induced by the heartbeat, and so will be useful in a broader range of intravital experimental conditions.</p></sec><sec id="s2-4"><title>Evaluation of the effect of image scan configuration on motion correction performance</title><p>We went on to evaluate the use of <italic>Galene</italic> in an intravital imaging setting. As demonstrated using the simulated data, the speed and direction of the motion has a significant effect on the extent to which we are able to correct the data. The critical parameter is, in fact, the relative speed of the motion with respect to the scan rate; a 5 Hz motion acquired with a frame rate of 1 Hz will appear to oscillate five times during each frame acquisition while the same speed acquired with a frame rate of 5 Hz will only appear to oscillate once per frame. Since the scan rate is generally a user controllable parameter, we imaged the same region at different scan rates to determine how this parameter affects the motion correction performance.</p><p>We acquired images through surgically implanted titanium windows (see schematic in <xref ref-type="fig" rid="fig3">Figure 3</xref>) that enable longitudinal imaging of abdominal organs (<xref ref-type="bibr" rid="bib54">Ritsma et al., 2014</xref>). Imaging abdominal organs through an optical window is challenging as they experience considerable motion as a result of physiological activity in nearby organs such as respiration and the heartbeat. Simply finding areas sufficiently stable to acquire FLIM images significantly limits the usable area of the window, and, in some cases, can render mice completely unusable. Using these windows, we imaged the pancreas in a genetically engineered mouse expressing a FRET biosensor for the small GTPase Rac1 (<xref ref-type="bibr" rid="bib27">Itoh et al., 2002</xref>; <xref ref-type="bibr" rid="bib28">Johnsson et al., 2014</xref>). We analyzed the FLIM data before and after motion correction by fitting each pixel to a single-exponential model as previously demonstrated (<xref ref-type="bibr" rid="bib28">Johnsson et al., 2014</xref>). We acquired FLIM-FRET images in two locations with different motion patterns, (i) where motion was dominated by the heartbeat and (ii) where motion is dominated by respiration and peristalsis (see displacement traces shown in <xref ref-type="fig" rid="fig3">Figure 3Ai,ii</xref>) at 700, 1000 and 1400 Hz line rates. We performed an amplitude-spectrum analysis on the estimated displacements (<xref ref-type="fig" rid="fig3">Figure 3B,C</xref>) and found motion of (i) a frequency of 5.4 Hz and peak-peak amplitude of 27 μm (approximately 10% of the FOV), corresponding to the heartbeat and (ii) slower motions with a range of frequencies from 0.2 to 2.2 Hz with an average peak-peak amplitude of 42 μm (approximately 15% of the field of view), corresponding to respiration. We found that for the faster but smaller motion due to the heartbeat we were able to correct for motion equally well at all scan rates (see <xref ref-type="fig" rid="fig3">Figure 3D</xref>, average correlation quantified in <xref ref-type="fig" rid="fig3">Figure 3Div</xref>). Note that for the same correction performance the correlation is reduced slightly at higher scan rates due to the lower signal to noise in each image. For the larger due to respiration and peristalsis, we found that we were only able to successfully correct for motion at 1400 Hz scan rates; partial correction was obtained at 1000 Hz and effectively no correction at 700 Hz (see <xref ref-type="fig" rid="fig3">Figure 3E</xref>). Underscoring the simulated data results, these data indicate that for larger motions it may be helpful to acquire at a faster frame rate where possible.</p><fig-group><fig id="fig3" position="float"><object-id pub-id-type="doi">10.7554/eLife.35800.007</object-id><label>Figure 3.</label><caption><title>Evaluation of effect of scan speed and angle on motion correction performance.</title><p>(<bold>A</bold>) Imaging of pancreatic tissue in vivo in a Rac1 FRET biosensor mouse using an abdominal titanium imaging window. (<bold>A</bold>) Estimated displacement for first 20 s of motion (i) dominated by heartbeat and (ii) dominated by respiration and peristalsis recorded at 1400 Hz. (<bold>B</bold>) Amplitude spectrum of displacements for two data series showing dominant contributions from the heartbeat (~5.6 Hz) and respiration and peristalsis (0.5–2.5 Hz). (<bold>C</bold>) Peak-to-peak displacements for the data series. Error bars show standard deviation over series. (<bold>D,E</bold>) Motion corrected FLIM images acquired in (<bold>D</bold>) heartbeat dominated regime and (E) respiration dominated regime at (i) 700 Hz, (ii) 1000 Hz and (iii) 1400 Hz, (iv) average correlation of corrected frames over series. (<bold>F,G</bold>) FLIM data were acquired with predominant motion occurring along the slow scan axis (<italic>red, top-bottom</italic>) and fast scan axis (<italic>blue, left-right</italic>) at (<bold>F</bold>) 700 Hz and (<bold>G</bold>) 1400 Hz. FLIM images are shown (i) before and (ii) after motion correction for motion along the slow axis and (iii) before and (iv) after motion correction for motion along the fast axis. (v) Angular histogram of displacements for data acquired along the slow and fast axis. (iv) Average correlation of data acquired with motion aligned along the slow and fast axis. White scale bars 100 μm. Mouse and pancreas illustrations were adapted from Servier Medial Art, licensed under the Creative Commons Attribution 3.0 Unported license.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig3-v1"/></fig><fig id="fig3s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.35800.008</object-id><label>Figure 3—figure supplement 1.</label><caption><title>Evaluating the effect of realignment parameters on motion correction performance.</title><p>FLIM images were acquired of the pancreas in a Rac1-FRET biosensor mouse through an optical window. (<bold>A</bold>) FLIM images without realignment, realignment using only translation information from phase-correlation and realignment with 3, 5, 10, 20 and 40 realignment points are shown alongside the reference frame. Red dots indicate the position of the realignment points within the frame. (<bold>B</bold>) Quantification of average correlation between each corrected frame and the reference frame for each realignment condition. (<bold>C</bold>) FLIM images without realignment and realignment with a smoothing kernel of width 0, 2, 4, 6, 8 and 10 pixels in the x-axis are shown alongside the reference frame. (<bold>D</bold>) Quantification of average correlation between each corrected frame and the reference frame for each realignment condition, computed without smoothing. Results show mean ± SEM, calculated per time point.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig3-figsupp1-v1"/></fig></fig-group><p>We went on to evaluate the effect of the relative alignment between the dominant direction of motion and the fast scanner axis. We imaged the pancreas with the motion aligned with the slow axis (red) and fast axis (blue) at 700 and 1400 Hz (see <xref ref-type="fig" rid="fig3">Figure 3F and G</xref> respectively) by rotating the microscope scan field. <xref ref-type="fig" rid="fig3">Figure 3F, Gv</xref> shows an angular histogram of the displacements showing the alignment with the scanner axes for the two cases and <xref ref-type="fig" rid="fig3">Figure 3F, Giv</xref> shows the average correlation between the realigned frames. At 700 Hz the realignment is significantly improved when the motion is aligned with the fast axis. At 1400 Hz, when the motion is slower relative to the scan rate, the motion is corrected equally well in either case. This highlights both the importance of using a fast scan rate where possible and, where there is a clear direction of motion, approximately aligning it with the scanner fast axis by rotating the scanner field of view.</p></sec><sec id="s2-5"><title>Evaluation of the effect of realignment parameters on motion correction performance</title><p>There are a number of user controllable options for performing the realignment. The first is the number of realignment points used across each frame of the image. The motion is interpolated linearly between these points across the image. In principle, using a larger number of points allows correction of higher frequency motions. We acquired 256 × 256 images of the pancreas and realigned the data using either coarse translation-only information determined using phase correlation or realignment with 3, 5, 10, 20 and 40 points per image (<xref ref-type="fig" rid="fig3">Figure 3A</xref>, quantified in <xref ref-type="fig" rid="fig3">Figure 3B</xref>). For images of this size, there was a slight improvement in the average correlation with increasing number of realignment points up to 20 points. Using 40 points, however, the correlation was slightly reduced. Using a very large number of realignment points can be detrimental; as the number of points increases, the number of pixels which constrain each point is reduced and eventually there is not enough information to accurately determine the motion at each point. In general, we found that using between 5–20 realignment points for 256 × 256 images and 10–20 points for 512 × 512 images was sufficient to obtain good correction over a broad range of conditions.</p><p>As the signal to noise level in each frame of a FLIM image is often low due to the restricted count rate requirements of TCSPC imaging, a Gaussian smoothing kernel may optionally be applied to each frame before realignment to improve the realignment. This smoothing is only applied in the x (fast-) axis so that pixels are only convolved with those acquired immediately before and after. To evaluate the effect of the degree of smoothing, we realigned an image with low signal to noise with a range of smoothing kernel widths between 0 and 10 pixels (<xref ref-type="fig" rid="fig3">Figure 3C</xref>, quantified in <xref ref-type="fig" rid="fig3">Figure 3D</xref>). We normally use the correlation between the smoothed images to reduce the effect of noise on the realignment result quantification. Here, however, we use the correlation between the unsmoothed images to allow us to compare the correlation between different smoothing kernels. We found a noticeable improvement in the realignment result using a kernel of with 2 or 4 pixels compared to no smoothing. At larger kernel sizes, the correlation gradually reduced; using excessively large smoothing kernels can reduce the quality of the realignment as the contrast in the image is reduced. We have found that using a smoothing kernel of 2–4 pixels works well over a broad range of conditions.</p></sec><sec id="s2-6"><title>Imaging intestinal crypts in vivo and ex vivo in a Rac1 FRET biosensor mouse</title><p>We went on to use <italic>Galene</italic> to image Rac1 activity in the intestinal crypts. Rac1 regulates a diverse array of cellular events including the cell cycle, cell-cell adhesion, motility and differentiation (<xref ref-type="bibr" rid="bib24">Heasman and Ridley, 2008</xref>) and has been shown to be a key driver of Wnt-induced stem cell activation within the intestinal crypt (<xref ref-type="bibr" rid="bib46">Myant et al., 2013</xref>). The Rac1 biosensor contains an ECFP donor, which has a complex decay profile, dominated by contributions from two conformations with similar spectral profiles. Here, we have fitted the data to a complex-donor FRET model previously described (<xref ref-type="bibr" rid="bib75">Warren et al., 2013</xref>) consisting of two contributions with different levels of FRET. Using global analysis, we determined the FRET efficiencies of the Rac1 GTP (active) and GDP bound (inactive) states to be E = 0.65 and E = 0.02. By fitting the contributions of each component, we can estimate the fraction of active Rac1 biosensor in each pixel as shown in <xref ref-type="fig" rid="fig4">Figure 4A</xref>.</p><fig-group><fig id="fig4" position="float"><object-id pub-id-type="doi">10.7554/eLife.35800.009</object-id><label>Figure 4.</label><caption><title>FLIM of intestinal crypts from the Rac1-FRET biosensor mouse in vivo and ex vivo using motion compensation.</title><p>(<bold>A</bold>) Imaging of intestinal crypts in vivo using an abdominal titanium imaging window (i–ii) Example FRET biosensor activity maps (i) before and (ii) after motion compensation showing fraction of active FRET biosensor determined by fitting to a FRET model accounting for the complex exponential decay of ECFP. White scale bars, 50 μm. (iii) Estimated displacement traces in (<italic>blue</italic>) x and (<italic>red</italic>) y directions over time. Pastel shaded regions indicate frames that could not be successfully corrected with correlation coefficients &lt; 0.8. (iv) Correlation between reference frame and (<italic>red</italic>) uncorrected and (<italic>blue</italic>) corrected images over time. Black dashed line denotes threshold (0.8) used to reject frames which could not be corrected. (<bold>v</bold>) Selected reference frame (vi,vii) Example of a successfully corrected frame (vi) before and (vii) after correction. (viii,ix) Example of a frame that could not be corrected. (<bold>B</bold>) Imaging of intestinal crypts ex vivo. (i–iv) as (<bold>A</bold>), no correlation threshold applied. (<bold>C</bold>) (i) Phasor plot of image shown in (<bold>B</bold>) to separate biosensor fluorescence (<italic>blue</italic>) from autofluorescence (<italic>red</italic>) and i) back projection of selected gates. (<bold>D</bold>) Intensity merged lifetime images of crypts (i) before and (ii) after motion compensation treated with (<italic>left-right</italic>) no drug, 200 nM PMA or 1 μM scopolamine. White scale bars 50 μm. (<bold>E</bold>) Quantification of fraction of active biosensor in crypts after drug treatment. (<bold>F</bold>) Subcellular analysis of fraction of active biosensor in basal (<italic>blue</italic>) and apical (<italic>red</italic>) membranes after drug treatment, shown per cell. Error bars show means ± SEM. **p&lt;0.01; ***p&lt;0.001 using one-way ANOVA. Mouse and intestine illustrations were adapted from Servier Medial Art, licensed under the Creative Commons Attribution 3.0 Unported license.</p><p><supplementary-material id="fig4sdata1"><object-id pub-id-type="doi">10.7554/eLife.35800.012</object-id><label>Figure 4—source data 1.</label><caption><title>Source data for graphs show in <xref ref-type="fig" rid="fig4">Figure 4E and F</xref>.</title><p>(Sheet 1) Fraction of active Rac1-FRET biosensor in each cell. (Sheet 2) Fraction of active Rac1-FRET biosensor in the basal and apical membrane respectively per cell.</p></caption><media mime-subtype="xlsx" mimetype="application" xlink:href="elife-35800-fig4-data1-v1.xlsx"/></supplementary-material></p><p><supplementary-material id="fig4sdata2"><object-id pub-id-type="doi">10.7554/eLife.35800.013</object-id><label>Figure 4—source data 2.</label><caption><title>Source data for graph show in <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1C</xref>, showing (Sheet 1) average optical densities for active-Rac1 IHC staining per mouse and (Sheet 2) individual optical densities for active Rac1 IHC staining per cell for each mouse.</title></caption><media mime-subtype="xlsx" mimetype="application" xlink:href="elife-35800-fig4-data2-v1.xlsx"/></supplementary-material></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig4-v1"/></fig><fig id="fig4s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.35800.010</object-id><label>Figure 4—figure supplement 1.</label><caption><title>IHC for Rac1-GTP in intestinal crypts.</title><p>Freshly collected intestinal crypts were treated with a vehicle, 1 μM Scopolamine for 30 min or 200 nM PMA for 15 min and stained for Rac1-GTP. (<bold>A</bold>) Example IHC images, black scale bar, 50 μm. (<bold>B</bold>) Quantification of staining optical density in intestinal crypt cells, averaged over n &gt; 1,500 cells per condition. Results show mean ± SEM (<italic>shaded</italic>) over n = 3 mice. <italic>p</italic> values were determined per-mouse using non-parametric one way ANOVA; *p&lt;0.05.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig4-figsupp1-v1"/></fig><fig id="fig4s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.35800.011</object-id><label>Figure 4—figure supplement 2.</label><caption><title>Benchmarking of intensity-only motion correction performance with frames from intestinal crypts.</title><p>Intensity frames were extracted from the FLIM images of intestinal crypts shown in <xref ref-type="fig" rid="fig4">Figure 4</xref> imaged (<bold>A</bold>) in vivo through an optical window and (<bold>B</bold>) ex vivo for benchmarking against alternative motion correction packages. (i) Frame averaged motion correction results with (<italic>gray</italic>) no correction, (<italic>red</italic>) ImageJ plugin StackReg, (<italic>purple</italic>) python package SIMA and (<italic>blue</italic>) Galene. No frames were excluded from the averaging. (ii) Correlation between each frame in the sequence and the reference frame for each package. (iii) Average correlation for each correction package. Results show mean ± SEM. Mouse and organ illustrations were adapted from Servier Medial Art, licensed under the Creative Commons Attribution 3.0 Unported license.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig4-figsupp2-v1"/></fig></fig-group><p>Imaging of the intestine is further complicated by motion induced by peristalsis, wave-like contractions of the digestive tract which propel food through the intestine. The gut can be attached only gently to the window (<xref ref-type="bibr" rid="bib55">Ritsma et al., 2012</xref>) as immobilizing a tract of the intestine can obstruct the bowel. The movement caused by peristalsis almost completely obscures the sample structure when imaging for even a few seconds (<xref ref-type="fig" rid="fig4">Figure 4Ai</xref>). <xref ref-type="video" rid="video2">Video 2</xref> shows the individual frames from the acquisition with and without correction and the accumulated time resolved image. When imaging crypts we noted that, alongside persistent smaller motion, occasional large, transient displacements occur where the crypt under observation moves completely out of the field of view (shown in the displacement estimates, <xref ref-type="fig" rid="fig4">Figure 4A</xref>iii); this, of course, cannot be compensated. We automatically identify and remove these frames by applying a threshold to the correlation between the reference image and the best estimate of the corrected frame, in this case 0.8 (<xref ref-type="fig" rid="fig4">Figure 4Aiv</xref>), discarding frames with lower correlation values. <xref ref-type="fig" rid="fig4">Figure 4A</xref> shows examples of frames which were successfully corrected (vi before correction, vii after correction) and frames which were excluded from the reconstructed image (viii, ix). Using this procedure, we can successfully recover an undistorted image of the live crypt (<xref ref-type="fig" rid="fig4">Figure 4Aii</xref>), and, by fitting to a complex-donor FRET model, estimate the fraction of the active biosensor in each pixel.</p><media id="video2" mime-subtype="mp4" mimetype="video" xlink:href="elife-35800-video2.mp4"><object-id pub-id-type="doi">10.7554/eLife.35800.014</object-id><label>Video 2.</label><caption><title>Motion correction of Rac1 biosensor FRET of an intestinal crypt imaged in vivo through an optical window.</title><p>Associated with <xref ref-type="fig" rid="fig3">Figure 3</xref>.</p></caption></media><p>Peristaltic motion continues even ex vivo when the intestine is maintained appropriately for live cell imaging. We imaged intestinal crypts in freshly excised tissue from the Rac1 and observed significant peristaltic motion which we could effectively correct using <italic>Galene</italic>, as illustrated in <xref ref-type="fig" rid="fig4">Figure 4B</xref> and <xref ref-type="video" rid="video3">Video 3</xref>. To inhibit peristalsis for imaging, researchers often use scopolamine, a small molecule muscarinic antagonist that inhibits the contraction of the smooth muscle layer surrounding the intestine (<xref ref-type="bibr" rid="bib72">Wang et al., 2008</xref>). To compare this approach to image based correction, we imaged tissue with and without pre-treatment with scopolamine. To quantify the data, we first used phasor analysis (<xref ref-type="fig" rid="fig4">Figure 4C</xref>, phasor analysis of image shown in <xref ref-type="fig" rid="fig4">Figure 4B</xref>) to separate the biosensor fluorescence (blue gate) from the tissue autofluorescence (red gate). We then manually segmented single cells and computed the average fraction of active Rac1 biosensor. Treatment with scopolamine effectively inhibited peristalsis; however, unexpectedly we also observed a significant activation of Rac1 in tissue treated with scopolamine compared to untreated tissue (<xref ref-type="fig" rid="fig4">Figure 4D</xref>, quantified in E) This activation was of a similar magnitude to that of tissue treated with phorbol myristate acetate (PMA) (<xref ref-type="bibr" rid="bib28">Johnsson et al., 2014</xref>), a potent small molecule activator of Rac1. This effect was also observed when fixed tissue was stained with a Rac1-GTP specific antibody (<xref ref-type="bibr" rid="bib46">Myant et al., 2013</xref>) (representative images and quantification shown in <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>). This interference with Rac1 signalling highlights the need to ensure pharmacological approaches to reducing sample motion do not affect the process under observation. In contrast, by using image based correction, these artefacts can be avoided when looking, for example, at subtle changes in Rac1 GTPase regulation which is known to drive stem cell activity in intestinal crypts (<xref ref-type="bibr" rid="bib46">Myant et al., 2013</xref>).</p><media id="video3" mime-subtype="mp4" mimetype="video" xlink:href="elife-35800-video3.mp4"><object-id pub-id-type="doi">10.7554/eLife.35800.015</object-id><label>Video 3.</label><caption><title>Motion correction of Rac1 biosensor FRET in an intestinal crypt stimulated with PMA imaged ex vivo.</title><p>Associated with <xref ref-type="fig" rid="fig3">Figure 3</xref>.</p></caption></media><p>Without motion correction, it is extremely difficult to identify subcellular compartments in a majority of the intestinal crypt data. After correcting for motion, however, we are able to robustly identify subcellular regions and structures in the data. We performed sub-cellular analysis of Rac1 activity in the basal and apical membranes of intestinal crypts with and without drug treatment (<xref ref-type="fig" rid="fig4">Figure 4F</xref>). We observed a lower level of Rac1 activation the basal membrane compared to the apical membrane after application of PMA or scoloplamine, suggesting a potential negative regulation of Rac1 at the basal membrane. This may be consistent with the critical role of Rac1 in intestinal crypt patterning and differentiation (<xref ref-type="bibr" rid="bib77">de Santa Barbara et al., 2003</xref>).</p></sec><sec id="s2-7"><title>Benchmarking galene using in vivo and ex vivo intestinal crypt imaging data</title><p>To benchmark the core motion correction algorithm used in <italic>Galene</italic> using real data, we exported the intensity of each frame from the intestinal crypt FLIM data shown in <xref ref-type="fig" rid="fig4">Figure 4</xref> as time series data. Each frame has relatively low signal to noise and we found that the SIFT algorithm was unable to reliably extract feature points from the data to use for realignment. We therefore assessed the performance of StackReg, SIMA and <italic>Galene</italic>. <xref ref-type="fig" rid="fig4s2">Figure 4—figure supplement 2</xref> shows the results of the realignment of intensity only versions of the intestinal crypt data acquired (A) in vivo through an optical window and (B) ex vivo. Due to the rapid motion observed in this image, the linear transformation used by StackReg is not able to adequately correct for the motion and the correlation between each frame and the reference frame is not improved compared to the unaligned data. SIMA provides an improvement in the image quality compared to the unaligned data and an increase in the average correlation between frames; however, a substantial motion artefact is still visible in the integrated image. <italic>Galene</italic> produces a significant improvement in the image quality over SIMA and StackReg. In line with the results of our simulations and in addition to enabling correction of time resolved data, <italic>Galene</italic> demonstrates a significant improvement in the realignment of both in vivo and ex vivo imaging data.</p></sec><sec id="s2-8"><title>Functional and structural longitudinal imaging during early adhesion events in an intrasplenic model of pancreatic cancer metastasis through an optical window</title><p>In a recent study, we demonstrated that transient ‘priming’ using the pharmaceutical Rho kinase inhibitor Fasudil in a model of pancreatic cancer (PC) improved response to chemotherapy and impaired metastasis to the liver in an intrasplenic model (<xref ref-type="bibr" rid="bib70">Vennin et al., 2017</xref>). Src kinase has been shown to play a critical role in cell adhesion and proliferation in cancer (<xref ref-type="bibr" rid="bib6">Brunton and Frame, 2008</xref>) and is potentially an anti-invasive target in PC (<xref ref-type="bibr" rid="bib18">Evans et al., 2012</xref>; <xref ref-type="bibr" rid="bib44">Morton et al., 2010b</xref>; <xref ref-type="bibr" rid="bib48">Nobis et al., 2013</xref>). We previously observed a reduction in Src kinase activity in in vitro models of invasion and in end-point xenograft models of a primary tumour imaged using a skin flap technique. We therefore hypothesised that the reduction in the number of metastases after priming with Fasudil could be, in part, a consequence of a reduction in early adhesion events caused by disruption of Src activation. However, without correction for sample motion, the assessment of such early transient events using FRET (illustrated schematically in <xref ref-type="fig" rid="fig5">Figure 5B</xref>) is not possible in vivo, limiting our ability to quantify colonisation efficiency at this important stage.</p><fig id="fig5" position="float"><object-id pub-id-type="doi">10.7554/eLife.35800.016</object-id><label>Figure 5.</label><caption><title>Longitudinal imaging of Src activity in cancer cells colonising the liver in an intrasplenic model of pancreatic cancer metastasis with micro-environmental context in response to priming with Fasudil.</title><p>(<bold>A</bold>) Cartoon of intrasplenic model of pancreatic cancer using KPC cancer cells expressing a Src-FRET biosensor. (<bold>B</bold>) Cartoon of morphology of KPC cells during early attachment events. (<bold>C</bold>) Experimental timeline showing timings of window implantation, intrasplenic injection, Fasudil (or vehicle) administration and imaging. (<bold>D</bold>) Illustration of identification of fluorescence components; (i) merged spectral intensity image, (ii) temporal phasor plot of 525/50 nm channel with gates used to select fluorescence components, (iii) spectral phasor plot, (iv) back projection image showing gates highlighted in (ii) and (iii). (<bold>E</bold>) Merged Src-FRET biosensor lifetime and hyperspectral unmixing image <bold>i</bold> before and (ii) after motion correction acquired 8 hr after intrasplenic injection. Cancer cells expressing the Src biosensor are colour-coded using the rainbow lifetime scale. Autofluorescence contributions obtained using hyperspectral unmixing shown in (<italic>red</italic>) vasculature, (<italic>grey</italic>) hepatocytes and (<italic>magenta</italic>) collagen. (iii) Estimated displacement traces in (<italic>blue</italic>) x and (<italic>red</italic>) y directions over time. (iv) Correlation between reference frame and (red) uncorrected and (blue) corrected images over time. (<bold>F</bold>) (i,ii) Example images showing Src activity and micro-environmental context in mice treated with (<bold>i</bold>) vehicle and (ii) 100 mg/kg Fasudil according to the timeline show in (<bold>C</bold>) at 4, 8, 16 and 24 hr after intrasplenic injection respectively. (<bold>G,H</bold>) Average Src biosensor lifetime in cancer cells colonising the liver in response to Fasudil treatment, using images (<bold>G</bold>) before and (<bold>H</bold>) after motion correction. <italic>n</italic> = 3 mice per condition, 20–45 cells per time point. Results show means ± SEM (shaded). <italic>p</italic> values were determined per-mouse by unpaired t-test, *p&lt;0.05; **p&lt;0.01. Mouse and liver illustrations were adapted from Servier Medial Art, licensed under the Creative Commons Attribution 3.0 Unported license.</p><p><supplementary-material id="fig5sdata1"><object-id pub-id-type="doi">10.7554/eLife.35800.017</object-id><label>Figure 5—source data 1.</label><caption><title>Source data for graphs show in <xref ref-type="fig" rid="fig5">Figure 5H and G</xref>, showing average Src-FRET biosensor lifetimes at 4, 8, 16 and 24 hr after intrasplenic injection per mouse, (Sheet 1) before motion correction and (Sheet 2) after motion correction.</title><p>Values are given in picoseconds.</p></caption><media mime-subtype="xlsx" mimetype="application" xlink:href="elife-35800-fig5-data1-v1.xlsx"/></supplementary-material></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig5-v1"/></fig><p>We used <italic>Galene</italic> to track Src activity in early adhesion events and so directly assess the effects of Fasudil during early attachment. We injected KPC cells expressing the Src-FRET biosensor (<xref ref-type="bibr" rid="bib74">Wang et al., 2005</xref>) into mice implanted with abdominal imaging windows implanted on top of the liver (see <xref ref-type="fig" rid="fig5">Figure 5A</xref>) and imaged cells arriving in the liver 4, 8, 16 and 24 hr (see timeline in <xref ref-type="fig" rid="fig5">Figure 5C</xref>) after injection. We used a multispectral FLIM system to allow us to record the lifetime of the Src biosensor alongside microenvironmental context using a variant of the hyperspectral unmixing approach recently demonstrated (<xref ref-type="bibr" rid="bib12">Cutrale et al., 2017</xref>). <xref ref-type="fig" rid="fig5">Figure 5Di</xref> shows an example motion corrected merged intensity image in the three spectral channels used and <xref ref-type="fig" rid="fig5">Figure 5Dii</xref> and iii show the temporal phasor of the 525/50 nm channel and the spectral phasor respectively. Phasor gates associated with Src-FRET, hepatocytes, the vasculature and collagen were identified as shown and used to identify the associated region in the image (<xref ref-type="fig" rid="fig5">Figure 5Div</xref>). Using the data from these regions, we created a pattern associated with each component and performed non-negative least squares to unmix the autofluorescence signal from nearby liver cells, blood vessels and the collagen network which have distinct hyperspectral signatures. To determine the lifetime of the Src biosensor, we identified regions containing the biosensor using phasor analysis and fitted the data to a single exponential model in the donor channel. We manually segmented single cells to determine the average lifetime per cell.</p><p>The liver shows significant motion when imaged behind an optical window due to its proximity to the lungs and heart and attachment to the diaphragm. This frustrates attempts to acquire data for lifetime and hyperspectral unmixing as integration over even a few frames leads to significant image blurring as illustrated in <xref ref-type="fig" rid="fig5">Figure 5Ei</xref>. <xref ref-type="fig" rid="fig5">Figure 5Eii</xref> shows the same image after correction for motion with liver cells shown in grey, blood vessels in red, collagen in magenta. The lifetime of the biosensor is color-coded from blue (low lifetime, low Src activity) to red (high lifetime, high Src activity, see schematic). Using <italic>Galene</italic>, we were able to reliably correct for motion in this context and so probe the activation of Src in relation to the true attachment state or spreading phenotype of cells during these early adhesion events in the liver. Here, we saw a significant increase in Src activity (increase in Src biosensor lifetime) after 8 hr, which was maintained up to 16 hr before plateauing after 24 hr upon spreading (see <xref ref-type="fig" rid="fig5">Figure 5E</xref>, control situation). In line with our previous study (<xref ref-type="bibr" rid="bib70">Vennin et al., 2017</xref>), to mimic systematic ROCK inhibition or adjuvant therapy in the presence of circulating tumour cells, we treated mice with Fasudil at 12 hr intervals with three treatments before intrasplenic injection (see timeline in <xref ref-type="fig" rid="fig5">Figure 5C</xref>). Mice treated with Fasudil exhibited a significantly reduced and delayed Src activity, in line with a delayed spreading phenotype, compared to those treated with the vehicle (see <xref ref-type="fig" rid="fig5">Figure 5Fi</xref>, blue-green shift at 8 hr and <xref ref-type="fig" rid="fig5">Figure 5Fii</xref>, blue-green shift at 24 hr, quantified in <xref ref-type="fig" rid="fig5">Figure 5G</xref>), indicating that Src-dependent spreading and activation during the first attachment events in the liver are indeed impaired by treatment with Fasudil. These results demonstrate a new role of Fasudil priming in altering adhesion efficiency in secondary sites (<xref ref-type="bibr" rid="bib53">Rath et al., 2017</xref>; <xref ref-type="bibr" rid="bib70">Vennin et al., 2017</xref>). There is an urgent need to develop anti-metastatic treatments in PC and other metastatic cancer types (<xref ref-type="bibr" rid="bib66">Steeg, 2016</xref>) and functional intravital microscopy combined with <italic>Galene</italic> may help development of new strategies to monitor agents that affect this critical event preceding colonisation (<xref ref-type="bibr" rid="bib55">Ritsma et al., 2012</xref>; <xref ref-type="bibr" rid="bib65">Steeg et al., 2011</xref>).</p><p>We note that aside from reducing the image quality, motion during acquisition can have a number of more subtle effects: (1) blurring of the biosensor fluorescence with background autofluorescence which may have a very different lifetime can artificially change the apparent lifetime of the biosensor, giving a misleading result and (2) motion can significantly distort the apparent shape of the cells. Both artefacts are observed here; we see a reduction in the apparent lifetime of the biosensor due to blurring with the low autofluorescence lifetime of surrounding liver cells and an artefactual elongation and apparent spreading of the cancer cell (compare <xref ref-type="fig" rid="fig5">Figure 5Di–ii</xref>) which may lead to an incorrect assumption about their attachment state (see <xref ref-type="fig" rid="fig5">Figure 5B</xref>). <xref ref-type="video" rid="video4">Video 4</xref> shows the accumulated frames before and after correction (note that <xref ref-type="video" rid="video4">Video 4</xref> shows the mean arrival time of all channels acquired, not just the Src biosensor donor). To evaluate the impact of motion correction on our ability to quantify Src activity in dataset, we analysed the lifetime of the uncorrected data in the same way (<xref ref-type="fig" rid="fig5">Figure 5H</xref>). The blurring of the biosensor lifetime with the background autofluorescence leads to an overall reduction in the lifetime in all treatment conditions. As the magnitude of this effect varies greatly from cell to cell depending on the motion and the environment of each cell, we found a significantly higher degree of variance within each condition. This increased variability abolishes our ability to statistically distinguish the conditions, highlighting the importance of motion correction to obtain robust results in this context (compare in <xref ref-type="fig" rid="fig5">Figure 5G–H</xref>).</p><media id="video4" mime-subtype="mp4" mimetype="video" xlink:href="elife-35800-video4.mp4"><object-id pub-id-type="doi">10.7554/eLife.35800.018</object-id><label>Video 4.</label><caption><title>Motion correction of KPC Src-FRET biosensor cells and liver autofluorescence imaged in an intrasplenic experiment through optical window.</title><p>Associated with <xref ref-type="fig" rid="fig5">Figure 5D</xref>. (<italic>top left</italic>) Each intensity frame from the FLIM acquisition (<italic>green</italic>) superimposed on the reference frame (<italic>magenta</italic>). (<italic>top right</italic>) The motion compensated frames (<italic>green</italic>) superimposed on the reference frame (<italic>magenta</italic>); frames which have been excluded due to a poor correlation are marked as such. (<italic>bottom left</italic>) Cumulative intensity merged FLIM lifetime image without motion correction, estimated using the first moment of the decay. (<italic>bottom right</italic>) Cumulative intensity merged FLIM lifetime image with motion correction, estimated using the first moment of the decay.</p></caption></media></sec><sec id="s2-9"><title>Motion correction of clinical autofluorescence imaging of human skin in three dimensions</title><p>The lifetime of NADH and FAD autofluorescence can be used as a readout of metabolic activity (<xref ref-type="bibr" rid="bib5">Blacker and Duchen, 2016</xref>; <xref ref-type="bibr" rid="bib37">Lakowicz et al., 1992</xref>; <xref ref-type="bibr" rid="bib62">Skala et al., 2007</xref>) with potential applications in the detection of precancerous tissue. This autofluorescence signal has been investigated in a clinical context for diagnostic purposes (<xref ref-type="bibr" rid="bib35">König, 2012</xref>) using static (<xref ref-type="bibr" rid="bib51">Patalay et al., 2012</xref>), flexible (<xref ref-type="bibr" rid="bib34">König et al., 2008</xref>) and handheld multiphoton (<xref ref-type="bibr" rid="bib58">Sherlock et al., 2015</xref>) microscopes. Unlike optical window experiments, where the inverted imaging configuration and weight of the mouse largely constrains the sample motion to two dimensions, the movement observed imaging human skin in an upright configuration occurs isotropically in three dimensions and so correction for lateral motion alone is insufficient. We therefore demonstrate two approaches for handling motion in three dimensions: (1) real-time detection and compensation for axial sample motion when imaging a single plane and (2) 3D motion correction within a z-stack. We recently demonstrated (<xref ref-type="bibr" rid="bib58">Sherlock et al., 2015</xref>) a handheld multiphoton microscope system that incorporates an active (online) axial motion compensation system that corrects for motion in z-axis in real time. The optical coherence tomography (OCT)-based correction system tracks sample motion perpendicular to the imaging plane in real time and adjusts the objective position to keep the selected plane in focus. We applied this system to collect short FLIM images of human epidermis; <xref ref-type="fig" rid="fig6">Figure 6Ai–iii</xref> shows the autofluorescence FLIM images (i) without motion compensation, (ii) with axial motion compensation alone and (iii) both axial and lateral motion compensation with <italic>Galene</italic>. The combination of active axial motion compensation and software-based lateral motion compensation is able to effectively remove the motion artefact observed.</p><fig id="fig6" position="float"><object-id pub-id-type="doi">10.7554/eLife.35800.019</object-id><label>Figure 6.</label><caption><title>Motion correction of autofluorescence imaging of human skin in vivo.</title><p>(<bold>A</bold>) Example intensity merged FLIM image of human skin around a hair follicle on a handheld multiphoton microscope with an active axial motion correction system, (i) without motion compensation, (ii) with axial motion correction and (iii) with axial and lateral motion compensation. White scale bars 50 μm. (iv) Estimated displacement traces in (blue) x and (<italic>red</italic>) y directions over time. Correlation between reference frame and (<italic>red</italic>) uncorrected and (<italic>blue</italic>) corrected images over time. (<bold>B</bold>) Cartoon illustration of (i) conventional frame-accumulation 3D stack acquisition strategy where frames from each slice in the volume are accumulated in turn and (ii) stack based accumulation where multiple acquisition of the entire stack recorded in a single pass are acquired, enabling motion correction in three dimensions. (<bold>C</bold>) Example intensity merged orthogonal projection of a 3D volume of human skin acquired on a commercial DermaInspect multiphoton microscope (i) before and (ii) after motion correction showing xy, yz, and xz sections through the volume. White scale bars 100 μm. (iv) Estimated displacement traces in (<italic>blue</italic>) x and (<italic>red</italic>) y directions over time. (v) Correlation between reference frame and (<italic>red</italic>) uncorrected and (<italic>blue</italic>) corrected images over time. Data shown in (<bold>A</bold>) were acquired at Imperial College, London (<xref ref-type="bibr" rid="bib59">Sherlock et al., 2018</xref>) and reanalysed with kind permission under the Creative Commons Attribution 4.0 International licence. Mouse and liver illustrations were adapted from Servier Medial Art, licensed under the Creative Commons Attribution 3.0 Unported license.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig6-v1"/></fig><p>In a clinical setting, it is often desirable to obtain a 3D map of the autofluorescence lifetime to build up structural and functional information resolved into the strata of the skin, for example to quantify drug penetrance and delivery (<xref ref-type="bibr" rid="bib57">Roberts et al., 2011</xref>). We acquired 3D FLIM images of autofluorescence from the dorsal forearm of a volunteer using a commercial clinical FLIM instrument (<xref ref-type="bibr" rid="bib39">Leite-Silva et al., 2016</xref>). Capturing time-resolved depth stacks with sufficient photon counts can be a time-consuming process; a 30–50 μm stack may take 10–15 min to acquire. A certain degree of motion during this period is inevitable in live subjects and, since conventionally each frame is accumulated consecutively (<xref ref-type="fig" rid="fig6">Figure 6Bi</xref>), this can lead to both blurring of individual images in the stack and displacement between images in the stack. To overcome this issue, we accumulated a number of scans over the entire stack (<xref ref-type="fig" rid="fig6">Figure 6Bii</xref>). We then apply the same motion estimation approach as used in 2D data, extending the displacement points to 3D. Each stack is aligned to a reference stack. Motion in three dimensions during each stack acquisition can then be estimated and corrected. To enable correction of these large volumes, we used GPU computation and several algorithmic optimisations to reduce the processing time (see Methods, <xref ref-type="fig" rid="fig7s1">Figure 7—figure supplement 1</xref>). We acquired 50 μm stacks with 36 images, accumulating 10 stacks in total. <xref ref-type="fig" rid="fig6">Figure 6C</xref> shows the autofluorescence FLIM images before and after image-based 3D motion compensation. We see that we are able to track and correct for motion in three dimensions during the stack acquisition, obtaining undistorted deep-tissue data free from motion artefacts. These approaches may enable the use of autofluorescence imaging of other parts of the body more susceptible to sample motion in three dimensions such as the chest.</p></sec><sec id="s2-10"><title>Motion correction of three dimensional multispectral intensity data</title><p><italic>Galene</italic> can also be used to correct for motion in time lapse fluorescence microscopy data, supporting data import and export from a number of common microscopy formats, OME-TIFF (<xref ref-type="bibr" rid="bib21">Goldberg et al., 2005</xref>) and Imaris data formats. We applied <italic>Galene</italic> to intravital multi-channel 3D imaging of immune cells in the inguinal lymph node (<xref ref-type="bibr" rid="bib67">Suan et al., 2015</xref>) and benchmarked its performance against drift correction in Imaris. Intravital imaging is a crucial tool in immunology, providing unique spatiotemporal information about the localisation, function and interactions between immune cells in their native environment. The organisation and migration of different classes of immune cells within the lymph nodes has been shown to play a critical role in the adaptive immune response (<xref ref-type="bibr" rid="bib30">Kastenmüller et al., 2012</xref>). For example, the production of antibodies in response to antigen re-exposure after vaccination depends on the interaction between CD4<sup>+</sup> T cells and B cells at a number of specific locations in the lymph node. Tracking of the migration of these cells is therefore critical to understanding this process and its dysregulation. We imaged tdTomato labelled B cells (red), Kaede CD4<sup>+</sup> OT2 T cells (green) and subcapsular sinus macrophages labelled with Alexa680 (magenta) in a 150 μm z-stack through the inguinal lymph node (SHG signal from fibrillar capsule, blue) over 30 min (<xref ref-type="fig" rid="fig7">Figure 7A</xref>). Over the time series, the macrophages and capsule are essentially static while there is significant migration of the CD4<sup>+</sup> T cells. Over this period, substantial sample motion is observed; there is a slow drift due to slight shifts in the immersion liquid meniscus and faster displacements due to physiological motion, primarily respiration. These displacements are visible in the temporally colour-coded projections shown in <xref ref-type="fig" rid="fig7">Figure 7B</xref>, where early time points are shown in blue and late time points in red. We used the Imaris ‘spot tracking’ function to track the stationary macrophages and used their trajectory to correct for drift. This provides a reduction in the motion artefact, however the correction is not complete (see <xref ref-type="fig" rid="fig7">Figure 7C</xref> inset, <xref ref-type="video" rid="video5">Video 5</xref>), and there is a gradual loss in the correlation between the nominally static capsule signal over time (<xref ref-type="fig" rid="fig7">Figure 7E and F</xref>). We then used <italic>Galene</italic> to correct for the motion based on the static capsule and macrophages and observed a significant improvement in the quality of the correction (see <xref ref-type="fig" rid="fig7">Figure 7D</xref>, <xref ref-type="video" rid="video5">Video 5</xref>). This will allow more accurate quantification of in vivo cell movement within this organ over long imaging periods even in the presence of physiological motion and sample drift.</p><fig-group><fig id="fig7" position="float"><object-id pub-id-type="doi">10.7554/eLife.35800.020</object-id><label>Figure 7.</label><caption><title>Motion correction of multispectral 3D imaging of labelled immune cells in a murine lymph node.</title><p>tdTomato labelled B cells (<italic>red</italic>), Kaede labelled OT2 T cells (<italic>green</italic>) and subcapsular sinus macrophages labelled with Alexa 680 (<italic>magenta</italic>) imaged in a 150 μm z-stack through the inguinal lymph node (SHG signal from fibrillar capsule, <italic>blue</italic>) over 30 min. (<bold>A</bold>) One time point rendered volumetrically. (<bold>B–D</bold>) Temporally colour-coded (<italic>blue</italic>, early time points; <italic>red</italic>, late time points) orthogonal projections of time series (with spectral channels merged) with (<bold>B</bold>) no correction, (<bold>C</bold>) Imaris drift correction and (<bold>D</bold>) motion correction with Galene. Inset, expanded view of region highlighted in white. (<bold>E</bold>) Correlation between the stationary collagen and macrophage signal for each volume in the sequence and the reference volume for each package. (<bold>F</bold>) Average correlation for each correction package. Results show mean ± SEM, calculated per time point.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig7-v1"/></fig><fig id="fig7s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.35800.021</object-id><label>Figure 7—figure supplement 1.</label><caption><title>Algorithmic optimisation for realignment of three dimensional data.</title><p>(<bold>A,B</bold>) Structure of Hessian matrix used during optimisaton in the Lucas–Kanade framework in the parameter formulation used by (<bold>A</bold>) <xref ref-type="bibr" rid="bib23">Greenberg and Kerr (2009</xref>) and (<bold>B</bold>) in this work for the 3D (x, y, z) case with 10 realignment points in total. Grey and white checkerbox indicate elements of the Hessian Matrix. Blue squares indicate matrix elements associated with the second realignment position, red squares indicate matrix elements associated with the third realignment position and yellow squares indicate matrix elements associated with both the second and third realignment position. (<bold>C</bold>) Time required for realignment of the 512 × 512 × 51 3D intensity data shown in <xref ref-type="fig" rid="fig7">Figure 7</xref> using 15 realignment points per z position (2295 parameters in total) and 51 time points using (i) conventional factorisation, (iii) banded factorisation and (iii) banded factorisation with GPU computation of the error function and Jacobian.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-35800-fig7-figsupp1-v1"/></fig></fig-group><media id="video5" mime-subtype="mp4" mimetype="video" xlink:href="elife-35800-video5.mp4"><object-id pub-id-type="doi">10.7554/eLife.35800.022</object-id><label>Video 5.</label><caption><title>Motion correction of multispectral imaging of labelled immune cells in a murine lymph node.</title><p>Associated with <xref ref-type="fig" rid="fig7">Figure 7</xref>. (<italic>left</italic>) Uncorrected time series. (<italic>middle</italic>) Time series corrected using Imaris drift correction (<italic>right</italic>) Time series corrected with Galene.</p></caption></media></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>We developed <italic>Galene</italic>, an open source tool to correct for sample motion in two and three-dimensional intravital functional imaging data where many frames are integrated to provide sufficient signal to noise to accurately determine, for example, the activity of FRET reporters using FLIM. The source code for <italic>Galene</italic> is freely available alongside compiled executable for Windows and Mac at <ext-link ext-link-type="uri" xlink:href="http://galene.flimfit.org/">http://galene.flimfit.org/</ext-link>.</p><p><italic>Galene</italic> uses a fitting approach that explicitly accounting for the raster scan pattern performed by laser scanning microscopes to determine sample motion both between frames and during each frame. We use the Lucas-Kanade framework to efficiently estimate the sample displacements following the approach of <xref ref-type="bibr" rid="bib23">Greenberg and Kerr (2009</xref>). Using the motion estimate, both FLIM and intensity-based data can be reconstructed, allowing quantitative analysis free from artefacts introduced by motion. To scale this approach to motion correction across 3D volumes where there may be thousands of displacement points, we implement two modifications. First, we take advantage of graphical co-processors to accelerate computationally intensive sections of the motion correction algorithm using to take advantage of graphical co-processors. We then exploit the structure of the optimisation problem to radically reduce the computational burden of estimating each optimisation step. These modifications reduce the time required to perform motion correction by a factor of 30 for typical volumetric datasets and open the door to online motion correction in the future.</p><p>Using simulations of FLIM data, we explored the range of motions that can be effectively compensated with <italic>Galene</italic>. As expected, we found that motion perpendicular to the scanner fast axis – a user controllable parameter on most modern confocal microscopes – can be more effectively compensated than those along the slow axis. We found that motions covering a broad range of physiologically relevant motions, from respiration to the heartbeat can be effectively compensated when the magnitude of the motion was ~10% of the FOV, while significantly large motions, up to 30% of the FOV could be corrected at lower frequencies. We note that faster motions still may be compensated by using faster scan rate, for example by employing a resonant scanner. The difference in quality of correction of motions in the fast and slow axis is due to the frequency with which different positions are sampled during the acquisition. Acquiring a 256 × 256 image at 1000 Hz means that every x-position will be sampled every millisecond (albeit at a different y position), while every y-position is sampled every 256 milliseconds. A motion purely in the fast scan (x-) direction will appear as a wave-like motion while a motion in the slow axis will appear to compress and stretch the image and, for sufficiently large motion, whole lines may be missed. This means that the data constrain the estimate of motion in the fast axis more strongly than in the slow axis.</p><p>We benchmarked the core motion correction algorithm against existing open source packages by generating simulated fluorescence intensity time series data and found that <italic>Galene</italic> can correct for a significantly larger range of motions than these packages. We confirmed these results using intravital FLIM-FRET biosensor imaging data and multispectral intensity-based data to demonstrate that we can compensate for a range of physiological motions. We showed that we can correct for motion occurring both between frames and within frames which otherwise render the image unintelligible and thereby retrieve both cellular and subcellular resolution. This will enable researchers to apply functional imaging modalities in contexts previously inaccessible due to excessive motion and therefore extend acquisition times, providing higher signal to noise (or using a lower excitation power to prevent tissue damage or photo-bleaching). Other recent applications of intravital FRET investigating, for example, RhoA (<xref ref-type="bibr" rid="bib47">Nobis et al., 2017</xref>), intricate Erk signalling propagation events from in the skin (<xref ref-type="bibr" rid="bib26">Hiratsuka et al., 2015</xref>) or cancer stemness (<xref ref-type="bibr" rid="bib33">Kumagai et al., 2015</xref>), PKA in vascular permeability (<xref ref-type="bibr" rid="bib79">Yamauchi et al., 2016</xref>) and stromal targeting in melanoma (<xref ref-type="bibr" rid="bib25">Hirata et al., 2015</xref>) could benefit from this approach. We contrasted our approach with pharmacological inhibition of motion using scopolamine in sections of ex vivo intestine. We observed that, although scopolamine effectively inhibited sample motion, it induces a significant activation of Rac1. This would compromise any study of Rac1 signalling in this context, illustrating the potential pitfalls of pharmacological approaches to inhibiting sample motion.</p><p>We used <italic>Galene</italic> to image the activation of Src, a key regulator of metastasis in PC (<xref ref-type="bibr" rid="bib17">Erami et al., 2016</xref>; <xref ref-type="bibr" rid="bib18">Evans et al., 2012</xref>; <xref ref-type="bibr" rid="bib48">Nobis et al., 2013</xref>; <xref ref-type="bibr" rid="bib70">Vennin et al., 2017</xref>), via FLIM-FRET in cancer cells arriving and attaching in the liver in an intrasplenic metastasis model of pancreatic cancer using live longitudinal imaging with titanium windows. We previously demonstrated that ROCK inhibition with Fasudil improved response to standard-of-care chemotherapy and reduced metastasis of pancreatic cancer cells using intrasplenic and orthotopic models and have shown that Src is a key regulator of metastasis in PC (<xref ref-type="bibr" rid="bib17">Erami et al., 2016</xref>; <xref ref-type="bibr" rid="bib70">Evans et al., 2012</xref>; <xref ref-type="bibr" rid="bib70">Nobis et al., 2013</xref>; <xref ref-type="bibr" rid="bib70">Vennin et al., 2017</xref>). To date, our ability to use FLIM-FRET imaging to observe these early, first attachment events has been hindered by sample motion. The extensive physiological motion observed in the liver not only significantly degrades the image but also, by mixing the FRET signal with the autofluorescence background, introduces a significant artefact into the FLIM readout of the Src-FRET activity. Using <italic>Galene</italic>, we observe a significant delay in Src activity after priming with Fasudil at early time points, providing a potential mechanism for the significant reduction in metastatic colonisation observed in endpoint metastatic burden experiments (<xref ref-type="bibr" rid="bib70">Vennin et al., 2017</xref>). As highlighted above, this may have wider applications in other metastatic cancers where early adhesion events are difficult to study.</p><p>Imaging human skin autofluorescence using two clinical multiphoton systems we found that, unlike murine optical window experiments, where the weight of the mouse tends to constrain sample motion laterally within the image plane, in a clinical context sample motion occurs isotropically in the x, y and z-axis. Motion in the z-axis cannot be corrected when imaging at a fixed focal plane as the sample physically moves out of the scan area. We demonstrated two methods for motion correction in three dimensions; we first combined <italic>Galene</italic> with a custom handheld multiphoton system incorporating axial motion correction (<xref ref-type="bibr" rid="bib58">Sherlock et al., 2015</xref>) while imaging human skin. By combining online axial motion compensation with lateral motion using <italic>Galene</italic> we can effectively compensate for motion in three dimensions. In an alternative approach, we acquired z-stacks of human skin, frequently used, for example, in skin penetration studies (<xref ref-type="bibr" rid="bib36">Labouta et al., 2011</xref>). Here, integration times on the order of tens of minutes are not uncommon due to weak autofluorescence signal and excitation powers limited by safety considerations. We showed that, by generalising the 2D motion correction approach to estimate motion in a three dimensional raster scan, we can effectively correct for isotropic motion in 3D. This will enable longer and more accurate FLIM volume acquisitions and imaging in locations more susceptible to physiological motion such as the chest where respiration is a significant challenge.</p><p>We have demonstrated that it is possible to robustly analyse motion corrected FLIM data using several methods which require a high signal noise levels and sample stability using data from two widely available commercial FLIM systems. <italic>Galene</italic> may be applied directly to data acquired on systems post capture and may even be applied retrospectively to existing data. This approach could be readily applied to confocal endoscopic systems (<xref ref-type="bibr" rid="bib31">Kennedy et al., 2010</xref>; <xref ref-type="bibr" rid="bib61">Siegel et al., 2003</xref>; Sparks et al., in press; <xref ref-type="bibr" rid="bib68">Sun et al., 2013</xref>) to allow TCSPC FLIM acquisitions in an intraoperative context, for example for tumour margin assessment (<xref ref-type="bibr" rid="bib22">Gorpas et al., 2015</xref>; <xref ref-type="bibr" rid="bib73">Wang et al., 2017</xref>). For such applications, this approach could readily be extended to enable real time correction of FLIM data, as the processing time is typically significantly shorter than data acquisition, even for high speed 3D applications. In principle, this system could be combined with a hardware-based lateral motion correction approach (<xref ref-type="bibr" rid="bib59">Sherlock et al., 2018</xref>), that can track large displacements to enable high fidelity correction when the microscope itself is moving. This would allow, for example, a macro scale FLIM map to be constructed by freely moving the imaging system across the sample.</p><p>In addition to correction of time resolved fluorescence data, we also demonstrated that Galene can effectively correct for motion in fluorescence intensity time series data in both two and three dimensions using multispectral intravital imaging data.</p><p><italic>Galene</italic> will therefore allow researchers to apply time resolved functional imaging in a broader range of contexts, relaxing previous restrictions on sample stability and imaging duration and make use of data which would have previously been discarded, in vitro, in vivo and in the clinic.</p></sec><sec id="s4" sec-type="materials|methods"><title>Materials and methods</title><table-wrap id="keyresource" position="anchor"><label>Key resources table</label><table frame="hsides" rules="groups"><thead><tr><th valign="top">Reagent type (species) <break/>or resource</th><th valign="top">Designation</th><th valign="top">Source or reference</th><th valign="top">Identifiers</th><th valign="top">Additional information</th></tr></thead><tbody><tr><td valign="top">Strain, strain background <break/>(Rac1-FRET, C57BL/6 (mixed))</td><td valign="top">Rac1-FRET biosensor <break/>mouse</td><td valign="top"><xref ref-type="bibr" rid="bib28">Johnsson et al. (2014</xref>)</td><td>Rac1-FRET biosensor <break/>mouse</td><td valign="top"/></tr><tr><td valign="top">Strain, strain background <break/>(BALB/c-Fox1nuAusb, Mus)</td><td valign="top">BALB/c-Fox1nuAusb</td><td valign="top">Australian BioResources</td><td>BALB/c-Fox1nuAusb</td><td valign="top"/></tr><tr><td valign="top">Cell line (Mus)</td><td valign="top">KPC</td><td valign="top"><xref ref-type="bibr" rid="bib45">Morton et al. (2010a</xref>)</td><td>KPC primary cancer <break/>cells</td><td valign="top"/></tr><tr><td valign="top">Antibody</td><td valign="top">active Rac1-GTP</td><td valign="top">NewEast Biosciences</td><td>RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_1961793">AB_1961793</ext-link></td><td valign="top">1:400 concentration</td></tr><tr><td valign="top">Recombinant DNA <break/>reagent</td><td valign="top">Rac1-FRET biosensor</td><td valign="top"><xref ref-type="bibr" rid="bib27">Itoh et al. (2002)</xref></td><td>Raichu-1011X ECFP- <break/>SEYFP</td><td valign="top"/></tr><tr><td valign="top">Recombinant DNA <break/>reagent</td><td valign="top">Src-FRET biosensor</td><td valign="top"><xref ref-type="bibr" rid="bib74">Wang et al. (2005)</xref>, <break/><xref ref-type="bibr" rid="bib70">Vennin et al. (2017)</xref></td><td>Src-FRET biosensor</td><td valign="top"/></tr><tr><td valign="top">Chemical compound, <break/>drug</td><td valign="top">(-)-Scopolamine-N- <break/>butylbromide</td><td valign="top">Sigma-Aldrich</td><td valign="bottom">PubChem:CID_6852391; <break/>Sigma:S7882</td><td valign="top"/></tr><tr><td valign="top">Chemical compound, <break/>drug</td><td valign="top">Phorbol myristate <break/>acetate</td><td valign="top">Sigma-Aldrich</td><td valign="bottom">PubChem:CID_27924; <break/>Sigma:P8139</td><td valign="top"/></tr><tr><td valign="top">Chemical compound, <break/>drug</td><td valign="top">Fasudil</td><td valign="top">Jomar Life Research</td><td valign="bottom">PubChem:CID_163751; <break/>Jomar:HA-1077</td><td valign="top"/></tr><tr><td valign="top">Software, algorithm</td><td valign="top">Matlab R2018a</td><td valign="top">Mathworks</td><td>RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/SCR_001622">SCR_001622</ext-link></td><td valign="top"/></tr><tr><td valign="top">Software, algorithm</td><td valign="top"><italic>FLIMfit</italic></td><td valign="top"><xref ref-type="bibr" rid="bib75">Warren et al. (2013)</xref></td><td>RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/SCR_016298">SCR_016298</ext-link></td><td valign="top"/></tr></tbody></table></table-wrap><sec id="s4-1"><title>Motion compensation in TTTR data</title><sec id="s4-1-1"><title>Reconstruction of frames from TTTR data</title><p>FLIM data saved in a TTTR format were read in using a custom reader implemented in C++. The TTTR data consist of a stream of events; markers corresponding to the start of frames and beginning and end of lines and photon arrival times. Each event is tagged with a 'macro' time marker, a coarse marker of the time since the experiment start, and photons contain 'micro' time information about their arrival time with respect to the last excitation pulse.</p><p>From these markers, the duration of each line, <italic>t<sub>line</sub></italic>, the time between the start of each line, <italic>t<sub>interline</sub></italic> and the time between the frames <italic>t<sub>frame</sub></italic> are determined. For many microscopes, only around a third of the total line scan time is 'active.' The photons are divided into pixels of equal duration <italic>t<sub>pixel</sub></italic> = <italic>t<sub>line</sub>/n<sub>pixel</sub></italic>. For realignment, the intensity of each frame in the FLIM image is reconstructed, disregarding micro-time information. Using <italic>t<sub>line,</sub> t<sub>interline</sub></italic> and the image dimensions, the macro time of each pixel can then be determined. To reduce noise, an elliptical Gaussian filter with a user-controllable radius in the fast scan axis and a 1px radius in the slow scan axis is applied. This filter is applied to the reference frame and each frame used for realignment but not to the final, realigned data.</p></sec><sec id="s4-1-2"><title>Estimation of sample motion</title><p>For each reconstructed frame, we aim to determine the motion during that frame with respect to a user selectable reference frame. We model the sample displacement <inline-formula><mml:math id="inf1"><mml:mi mathvariant="bold-italic">D</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> using a series of <italic>n</italic> vectorial displacements <inline-formula><mml:math id="inf2"><mml:mfenced close="}" open="{" separators="|"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">r</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>i</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:math></inline-formula> equally spaced over the frame time <italic>t</italic><sub>frame</sub> and assume that the sample moves linearly between these displacements. The sample displacement at time <italic>t</italic> is then<disp-formula id="equ1"><label>(1)</label><mml:math id="m1"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="bold-italic">D</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>t</mml:mi><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mtext> </mml:mtext><mml:msup><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>i</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup><mml:mtext> </mml:mtext><mml:mo>+</mml:mo><mml:mtext> </mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:msup><mml:mi mathvariant="bold-italic">r</mml:mi><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>i</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mtext> </mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mfrac><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>frame</mml:mtext></mml:mrow></mml:msub></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>For a given set of displacements, we can reconstruct the image using subpixel interpolation. For each pixel in the displaced image <inline-formula><mml:math id="inf3"><mml:mover accent="true"><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:math></inline-formula>, the intensity is given by<disp-formula id="equ2"><label>(2)</label><mml:math id="m2"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mi mathvariant="bold-italic">I</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mtext> </mml:mtext><mml:mo>=</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:munder><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:munder><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:munder><mml:msubsup><mml:mi>w</mml:mi><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>i</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:msubsup><mml:mi>w</mml:mi><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>j</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:msubsup><mml:mi>w</mml:mi><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>k</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mi mathvariant="bold-italic">I</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mtext> </mml:mtext><mml:mo>+</mml:mo><mml:mtext> </mml:mtext><mml:msub><mml:mi>d</mml:mi><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:mi>y</mml:mi><mml:mtext> </mml:mtext><mml:mo>+</mml:mo><mml:mtext> </mml:mtext><mml:msub><mml:mi>d</mml:mi><mml:mrow><mml:mi>y</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mi>d</mml:mi><mml:mrow><mml:mi>z</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>where<disp-formula id="equ3"><mml:math id="m3"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mi>x</mml:mi><mml:mo>⋅</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">p</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">x</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">e</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">l</mml:mi></mml:mrow></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>y</mml:mi><mml:mo>⋅</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">l</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">e</mml:mi></mml:mrow></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">t</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">e</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">r</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">l</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">n</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">e</mml:mi></mml:mrow></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mi mathvariant="normal">z</mml:mi></mml:mrow><mml:mo>⋅</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">f</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">r</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">a</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">m</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">e</mml:mi></mml:mrow></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula><disp-formula id="equ4"><label>(3)</label><mml:math id="m4"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo>⌊</mml:mo><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mi>t</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>⌋</mml:mo></mml:mrow><mml:mo>;</mml:mo><mml:mtext> </mml:mtext><mml:msubsup><mml:mi>w</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mrow><mml:mo>⌊</mml:mo><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mi>t</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>⌋</mml:mo></mml:mrow><mml:mo>;</mml:mo><mml:mtext> </mml:mtext><mml:msubsup><mml:mi>w</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msubsup><mml:mi>w</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Note that, unlike the final reconstructed FLIM data, this is not an intensity preserving transformation; instead of displacing each pixel in the input image (potentially leaving gaps in the output image due to motion), we attempt to estimate the intensity for every pixel in the output image. This gives a smoother error function and so improves the convergence.</p><p>We wish to determine the optimal set of displacements <inline-formula><mml:math id="inf4"><mml:mfenced close="}" open="{" separators="|"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">r</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>i</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:math></inline-formula> that minimise the sum of square E error between the reference image and the displaced image. We use a variant of the Lucas-Kanade algorithm (<xref ref-type="bibr" rid="bib1">Baker and Matthews, 2004</xref>). The error function is given by<disp-formula id="equ5"><label>(4)</label><mml:math id="m5"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>E</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">p</mml:mi><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mtext> </mml:mtext><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:munder><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mover><mml:mi>I</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>;</mml:mo><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>T</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Where <inline-formula><mml:math id="inf5"><mml:mi mathvariant="bold-italic">p</mml:mi><mml:mo>=</mml:mo><mml:mfenced close="}" open="{" separators="|"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>…</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>n</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>n</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>n</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:math></inline-formula> is a vector of the fit parameters. We use a trust region algorithm (<xref ref-type="bibr" rid="bib7">Byrd et al., 2000</xref>) to iteratively minimize the error E. In the trust region method, we use a quadratic approximation to the error function and take steps within a trusted region. The size of the trusted region, <inline-formula><mml:math id="inf6"><mml:mi mathvariant="normal">Δ</mml:mi></mml:math></inline-formula> is expanded or reduced depending on how well the actual reduction in the error function agrees with the predicted reduction. To determine the <italic>k+</italic>1<sup>th</sup> step, <inline-formula><mml:math id="inf7"><mml:mi>Δ</mml:mi><mml:mi mathvariant="bold-italic">p</mml:mi></mml:math></inline-formula>, we need to solve the sub problem<disp-formula id="equ6"><label>(5)</label><mml:math id="m6"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:munder><mml:mo form="prefix">min</mml:mo><mml:mi>p</mml:mi></mml:munder><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:msubsup><mml:mi>E</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msubsup><mml:mi mathvariant="bold-italic">p</mml:mi><mml:mo>+</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mn>2</mml:mn></mml:mfrac><mml:msup><mml:mi mathvariant="bold-italic">p</mml:mi><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msup><mml:msub><mml:mi mathvariant="bold-italic">H</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mtext> s.t.</mml:mtext><mml:mrow><mml:mo symmetric="true">‖</mml:mo><mml:mi mathvariant="bold-italic">p</mml:mi><mml:mo symmetric="true">‖</mml:mo></mml:mrow><mml:mo>&lt;</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Where <inline-formula><mml:math id="inf8"><mml:msub><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the value of the error function at the <italic>k</italic><sup>th</sup> step, <inline-formula><mml:math id="inf9"><mml:mo>∇</mml:mo><mml:mi>E</mml:mi></mml:math></inline-formula> and <bold><italic>H</italic></bold> and are the Jacobian and Hessian of the error function respectively. We solve the trust region problem using the approach described by Nocedal and Wright (<xref ref-type="bibr" rid="bib50">Nocedal and Wright, 1999</xref>) using the open source dlib (<xref ref-type="bibr" rid="bib32">King, 2009</xref>) implementation.</p><p>Using this algorithm, we require analytical estimates of the Jacobian and the Hessian of the error function (<xref ref-type="disp-formula" rid="equ5">Equation 4</xref>) at each step. Using the formulation above the Hessian depends on the last displacement parameters and so must be recomputed at each step. This imposes a significant computational burden. Instead of displacing the image to match the reference at each step, we can conceptually imagine displacing the reference to match the last shifted image. We then invert the displacements and apply them to the image and iterate. This approach is known as the 'inverse compositional' approach (<xref ref-type="bibr" rid="bib1">Baker and Matthews, 2004</xref>). In this formulation, the error function for the update step <inline-formula><mml:math id="inf10"><mml:mi mathvariant="bold">Δ</mml:mi><mml:mi mathvariant="bold-italic">p</mml:mi></mml:math></inline-formula> is<disp-formula id="equ7"><label>(6)</label><mml:math id="m7"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msup><mml:mi>E</mml:mi><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi><mml:mo>+</mml:mo><mml:mrow><mml:mi mathvariant="bold">Δ</mml:mi></mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mtext> </mml:mtext><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi></mml:mrow></mml:munder><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mover><mml:mi>I</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>;</mml:mo><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mover><mml:mi>T</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>;</mml:mo><mml:mrow><mml:mi mathvariant="bold">Δ</mml:mi></mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>This formulation has been demonstrated to be equivalent to the conventional Lucas-Kanade approach (<xref ref-type="bibr" rid="bib1">Baker and Matthews, 2004</xref>) in terms of convergence, but significantly reduces the computational complexity of each update step.</p><p>The Jacobian <inline-formula><mml:math id="inf11"><mml:mo>∇</mml:mo><mml:mi>E</mml:mi><mml:mi>'</mml:mi></mml:math></inline-formula> w.r.t the parameter updates is given by<disp-formula id="equ8"><label>(7)</label><mml:math id="m8"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="normal">∇</mml:mi><mml:msup><mml:mi>E</mml:mi><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:munder><mml:mn>2</mml:mn><mml:mo>⋅</mml:mo><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:mover><mml:mi>T</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>;</mml:mo><mml:mrow><mml:mi mathvariant="bold">Δ</mml:mi></mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:mrow><mml:mi mathvariant="bold">Δ</mml:mi></mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow></mml:mfrac><mml:mo>⋅</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mover><mml:mi>I</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>;</mml:mo><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mover><mml:mi>T</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>;</mml:mo><mml:mrow><mml:mi mathvariant="bold">Δ</mml:mi></mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>To first order, the derivative of the template image with respect to the parameters is given by<disp-formula id="equ9"><label>(8)</label><mml:math id="m9"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:mover><mml:mi>T</mml:mi><mml:mo>∼</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>;</mml:mo><mml:mrow><mml:mi mathvariant="bold">Δ</mml:mi></mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:mrow><mml:mi mathvariant="bold">Δ</mml:mi></mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow></mml:mfrac><mml:mo>≈</mml:mo><mml:mi mathvariant="normal">∇</mml:mi><mml:mi>T</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>⋅</mml:mo><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:mi mathvariant="bold-italic">D</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Where <inline-formula><mml:math id="inf12"><mml:mo>∇</mml:mo><mml:mi>T</mml:mi><mml:mo>=</mml:mo><mml:mfenced separators="|"><mml:mrow><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:mfrac><mml:mo>,</mml:mo><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi>y</mml:mi></mml:mrow></mml:mfrac><mml:mo>,</mml:mo><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:math></inline-formula> is the gradient of the template image. For the model of motion described above, the partial derivatives of the displacements with respect to <inline-formula><mml:math id="inf13"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> are given by<disp-formula id="equ10"><mml:math id="m10"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:msub><mml:mi mathvariant="bold-italic">D</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:msub><mml:mi>i</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mtable columnalign="left left" columnspacing="1em" displaystyle="false" rowspacing=".2em"><mml:mtr><mml:mtd><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>frame</mml:mtext></mml:mrow></mml:msub></mml:mfrac></mml:mtd><mml:mtd><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>&lt;</mml:mo><mml:mi>t</mml:mi><mml:mo>≤</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mfrac><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>frame</mml:mtext></mml:mrow></mml:msub></mml:mfrac></mml:mtd><mml:mtd><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>&lt;</mml:mo><mml:mi>t</mml:mi><mml:mo>≤</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mn>0</mml:mn></mml:mtd><mml:mtd><mml:mtext>otherwise</mml:mtext></mml:mtd></mml:mtr></mml:mtable><mml:mo fence="true" stretchy="true" symmetric="true"/></mml:mrow><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula><disp-formula id="equ11"><label>(9)</label><mml:math id="m11"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mfrac><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:msub><mml:mi mathvariant="bold-italic">D</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="normal">∂</mml:mi><mml:msub><mml:mi>j</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mo>}</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mtext> </mml:mtext><mml:mi>i</mml:mi><mml:mo>≠</mml:mo><mml:mi>j</mml:mi><mml:mo>≠</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:mstyle></mml:math></disp-formula>extending the formulation of Greenberg (<xref ref-type="bibr" rid="bib23">Greenberg and Kerr, 2009</xref>). The Hessian matrix is given by<disp-formula id="equ12"><label>(10)</label><mml:math id="m12"><mml:mi>H</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msup><mml:mrow><mml:mfenced close="]" open="[" separators="|"><mml:mrow><mml:mo>∇</mml:mo><mml:mi>T</mml:mi><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi mathvariant="bold-italic">D</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msup><mml:mfenced close="]" open="[" separators="|"><mml:mrow><mml:mo>∇</mml:mo><mml:mi>T</mml:mi><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi mathvariant="bold-italic">D</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:mrow></mml:mrow></mml:math></disp-formula></p><p>Since the Hessian does not depend on the current values of the parameters, it may be precomputed and reused at each iteration, and indeed between frames. This means that the update step may be performed efficiently, even for relatively large images or numbers of realignment points. Using this formulation, the following parameters may be computed in advance</p><list list-type="order"><list-item><p>The gradient images <inline-formula><mml:math id="inf14"><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:mfrac></mml:math></inline-formula>, <inline-formula><mml:math id="inf15"><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi>y</mml:mi></mml:mrow></mml:mfrac></mml:math></inline-formula> and <inline-formula><mml:math id="inf16"><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:mfrac></mml:math></inline-formula> of the template image <inline-formula><mml:math id="inf17"><mml:mi>T</mml:mi></mml:math></inline-formula>.</p></list-item><list-item><p>The Jacobian of the displacements <inline-formula><mml:math id="inf18"><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi>p</mml:mi></mml:mrow></mml:mfrac></mml:math></inline-formula> (<xref ref-type="disp-formula" rid="equ11">Equation 9</xref>).</p></list-item><list-item><p>The steepest decent images <inline-formula><mml:math id="inf19"><mml:mo>∇</mml:mo><mml:mi>T</mml:mi><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi mathvariant="bold-italic">D</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow></mml:mfrac></mml:math></inline-formula>.</p></list-item><list-item><p>The Hessian <bold><italic>H</italic></bold> (<xref ref-type="disp-formula" rid="equ12">Equation 10</xref>).</p></list-item></list><p>The trust region algorithm is performed iteratively until the change in the error function is below a certain threshold, in this case <inline-formula><mml:math id="inf20"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi><mml:mi>E</mml:mi><mml:mo>&lt;</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>−</mml:mo><mml:mn>5</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mstyle></mml:math></inline-formula>.</p></sec><sec id="s4-1-3"><title>Exploiting structure in the hessian matrix</title><p>The computational complexity of computing the error value and the Hessian is <inline-formula><mml:math id="inf21"><mml:mi mathvariant="script">𝒪</mml:mi><mml:mo>(</mml:mo><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:math></inline-formula>. We note that the particular form of the Jacobian (<xref ref-type="disp-formula" rid="equ7">Equation 6</xref>) means that the Hessian is relatively sparse; increasingly so as the number of parameters increases since the displacement of distant points do not interact.</p><p>The computational complexity of each step in the trust region algorithm is dominated by the Cholesky factorization of the Hessian matrix, with is <inline-formula><mml:math id="inf22"><mml:mi mathvariant="script">𝒪</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msup><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced><mml:mo>≈</mml:mo><mml:mi mathvariant="script">𝒪</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:math></inline-formula>, since the number of displacement points required scales approximately linearly with the number of pixels for a given motion profile. For 2D problems, the former calculation dominates the computation time, however for even moderate 3D problems, the Cholesky factorization quickly dominates the computation time. For the 3D z-stack timeseries analysed in <xref ref-type="fig" rid="fig7">Figure 7</xref>, with 51 slices, 51 time points and 15 points per frame (giving 2295 parameter in total), factorisation uses approximately 90% of the computational effort and the realignment process takes 1.5 hours (<xref ref-type="fig" rid="fig7s1">Figure 7—figure supplement 1C</xref>).</p><p><xref ref-type="bibr" rid="bib23">Greenberg and Kerr (2009</xref>) organise the parameters <inline-formula><mml:math id="inf23"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:msubsup><mml:mi>r</mml:mi><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>i</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mo>}</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:msubsup><mml:mi>r</mml:mi><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>i</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula>. In this case, the non-zero entries of the Hessian are organized as shown in <xref ref-type="fig" rid="fig7s1">Figure 7—figure supplement 1</xref>. In this case, the non-zero entries are distributed throughout the Hessian. However, if the parameters are organized according to <inline-formula><mml:math id="inf24"><mml:mi mathvariant="bold-italic">p</mml:mi><mml:mo>=</mml:mo><mml:mfenced close="}" open="{" separators="|"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>…</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>n</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>n</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>n</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:math></inline-formula> then the non-zero entries appear as shown in <xref ref-type="fig" rid="fig7s1">Figure 7—figure supplement 1B</xref>. In this case, the matrix takes a banded structure with bandwidth <inline-formula><mml:math id="inf25"><mml:mi>b</mml:mi><mml:mo>=</mml:mo><mml:mn>6</mml:mn></mml:math></inline-formula>. Matrices of this form can be factorized significantly more efficiently (<xref ref-type="bibr" rid="bib42">Martin and Wilkinson, 1965</xref>). We use the lapack routine pbtrf with computational complexity <inline-formula><mml:math id="inf26"><mml:mi mathvariant="script">𝒪</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>b</mml:mi><mml:msup><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:math></inline-formula>. Using banded factorisation, the realignment of the data in <xref ref-type="fig" rid="fig7">Figure 7</xref> takes 7.5 minutes (<xref ref-type="fig" rid="fig7s1">Figure 7—figure supplement 1B</xref>) and, in this case, the computation time is dominated again by the computation of the error value and Hessian matrix.</p></sec><sec id="s4-1-4"><title>GPU acceleration</title><p>Computation of the error value (<xref ref-type="disp-formula" rid="equ7">Equation 6</xref>) and the Jacobian (<xref ref-type="disp-formula" rid="equ8">Equation 7</xref>) at a particular set of displacements is a highly parallel task as the contribution from each pixel can be calculated independently. This task is particularly suited for computation on a GPU for a number of reasons: (1) modern GPUs implement 3D interpolation (<xref ref-type="disp-formula" rid="equ2">Equation 2</xref>) in hardware, a task which can be relatively inefficient to perform on CPUs due to the random and highly strided nature of the memory access pattern. (2) The host-GPU memory transfer during the computation (often the rate limiting step for GPU acceleration) is low as the images can be stored on the GPU at the start of the optimization and do not need to be subsequently updated.</p><p>We have implemented a GPU version of the code for calculating both these values. The parameters which may be computed in advance for each optimization are computed on the CPU and transferred to the GPU. <xref ref-type="disp-formula" rid="equ7 equ8">Equations 6 and 7</xref> are implemented on the GPU and a GPU parallel reduction used to compute the respective sums. Since the steepest decent images <inline-formula><mml:math id="inf27"><mml:mo>∇</mml:mo><mml:mi>T</mml:mi><mml:mfrac><mml:mrow><mml:mo>∂</mml:mo><mml:mi mathvariant="bold-italic">D</mml:mi></mml:mrow><mml:mrow><mml:mo>∂</mml:mo><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow></mml:mfrac></mml:math></inline-formula> can be very large for a 3D problem (e.g. over 2 Gb for the problem shown in <xref ref-type="fig" rid="fig7">Figure 7</xref>, too large to fit in many consumer GPUs) these values are streamed to the GPU from the host in parallel with the computation. This allows even large problems to be computed on low to mid-range GPU hardware with 1-2 Gb of memory. Using the GPU routines, realignment of the data in <xref ref-type="fig" rid="fig7">Figure 7</xref> is reduced by over a factor of 2, to 3.4 minutes.</p></sec><sec id="s4-1-5"><title>Thresholding based on image correlation</title><p>To assess the quality of the motion estimation, the correlation coefficient <inline-formula><mml:math id="inf28"><mml:mi>r</mml:mi></mml:math></inline-formula> between each motion corrected frame <inline-formula><mml:math id="inf29"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">I</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover> <mml:mi/></mml:math></inline-formula>and the reference frame <inline-formula><mml:math id="inf30"><mml:mi mathvariant="bold-italic">R</mml:mi></mml:math></inline-formula> is computed according to<disp-formula id="equ13"><label>(11)</label><mml:math id="m13"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>r</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:munder><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mover><mml:mi mathvariant="bold-italic">I</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mo>∣</mml:mo><mml:mrow><mml:mover><mml:mi mathvariant="bold-italic">I</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:mrow><mml:mo>∣</mml:mo><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">R</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mo>∣</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">R</mml:mi></mml:mrow><mml:mo>∣</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msqrt><mml:mo stretchy="false">[</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:munder><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mover><mml:mi mathvariant="bold-italic">I</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mo>∣</mml:mo><mml:mrow><mml:mover><mml:mi mathvariant="bold-italic">I</mml:mi><mml:mo stretchy="false">~</mml:mo></mml:mover></mml:mrow><mml:mo>∣</mml:mo><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo stretchy="false">]</mml:mo></mml:msqrt><mml:mo stretchy="false">[</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi></mml:mrow></mml:munder><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">R</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mo>∣</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">R</mml:mi></mml:mrow><mml:mo>∣</mml:mo><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf31"><mml:mfenced close="|" open="|" separators="|"><mml:mrow><mml:mo>⋅</mml:mo></mml:mrow></mml:mfenced></mml:math></inline-formula> denotes the image mean. A threshold <inline-formula><mml:math id="inf32"><mml:msub><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mtext>thresh</mml:mtext> <mml:mi/></mml:mrow></mml:msub></mml:math></inline-formula>value may be set such that any motion corrected frames where <inline-formula><mml:math id="inf33"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>r</mml:mi><mml:mo>&lt;</mml:mo><mml:msub><mml:mi>r</mml:mi><mml:mrow><mml:mtext>thresh </mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> are excluded from the reconstructed image. This allows the user to exclude frames where the motion could not be corrected, or the sample has temporarily moved out of the field of view, from the final reconstruction.</p></sec><sec id="s4-1-6"><title>Initial displacement estimates</title><p>In any non-linear estimation problem, judicious selection of the initial parameters is important to ensure the global minimum is obtained. Here, we evaluate two potential initial parameter sets. The set yielding the lowest error is used. First, a null displacement <inline-formula><mml:math id="inf34"><mml:msubsup><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:math></inline-formula> is evaluated. Then a three dimensional rigid body displacement estimated using a 3D version of the phase correlation algorithm (<xref ref-type="bibr" rid="bib20">Foroosh et al., 2002</xref>) is evaluated according to Algorithm 1.</p></sec></sec><sec id="s4-2"><title>Algorithm 1. Rigid body estimation of displacement</title><list list-type="order"><list-item><p>Apply a 3D Hanning window to each stack to reduce edge artefacts.</p></list-item><list-item><p>Compute the discrete Fourier transform of each image, <inline-formula><mml:math id="inf35"><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf36"><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> respectively, using the fast Fourier transform algorithm.</p></list-item><list-item><p>Compute the cross power spectrum <inline-formula><mml:math id="inf37"><mml:mi>R</mml:mi></mml:math></inline-formula>,<disp-formula id="equ14"><mml:math id="m14"><mml:mi>R</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msub><mml:mo>∘</mml:mo><mml:msubsup><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow><mml:mrow><mml:mi>'</mml:mi></mml:mrow></mml:msubsup></mml:mrow><mml:mrow><mml:mfenced close="|" open="|" separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>A</mml:mi></mml:mrow></mml:msub><mml:mo>∘</mml:mo><mml:msubsup><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>B</mml:mi></mml:mrow><mml:mrow><mml:mi>'</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:math></disp-formula></p></list-item><list-item><p>where <inline-formula><mml:math id="inf38"><mml:mi>'</mml:mi></mml:math></inline-formula> denotes complex conjugation and <inline-formula><mml:math id="inf39"><mml:mo>∘</mml:mo></mml:math></inline-formula> element-wise multiplication.</p></list-item><list-item><p>Determine the sub-pixel location of the maximum position of the peak value of the cross-power spectrum by interpolation around the peak.</p></list-item><list-item><p>Determine the translation between the two images given by the displacement of the peak location from the origin.</p></list-item></list></sec><sec id="s4-3"><title>Reconstruction of motion compensated FLIM data</title><p>After computing the displacement estimates, the TTTR data are reconstructed into histogrammed FLIM data taking the estimated sample motion into account. Each photon arrival is assigned to a pixel coordinate <inline-formula><mml:math id="inf40"><mml:mo>(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>)</mml:mo></mml:math></inline-formula> based on the frame, line and (if they exist) pixel markers in the dataset. The photon is then reassigned to the coordinate <inline-formula><mml:math id="inf41"><mml:mo>(</mml:mo><mml:mi>x</mml:mi><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mfenced separators="|"><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow></mml:msub><mml:mfenced separators="|"><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>z</mml:mi></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mi>t</mml:mi><mml:mo>)</mml:mo><mml:mo>)</mml:mo></mml:math></inline-formula> using the final displacement estimates for the current frame, where <inline-formula><mml:math id="inf42"><mml:mi>t</mml:mi></mml:math></inline-formula> is the macro time relative to the start of the frame. If a correlation threshold has been set, photons arriving during frames where the correlation coefficient is less than the threshold value will be discarded. The sample motion leads to an effective variable integration time across the image. To correct for this, we calculate the integration time by integrating the dwell time in each pixel across the image. This integration time image is saved alongside the data and used to correct the intensity merged FLIM images. This corrects for the variable integration time without altering the photon statistics in the data used for analysis.</p></sec><sec id="s4-4"><title>Loading intensity fluorescence imaging data</title><p>OME-TIFF data (<xref ref-type="bibr" rid="bib21">Goldberg et al., 2005</xref>) is supported using the OME files C++ implementation (<ext-link ext-link-type="uri" xlink:href="https://github.com/ome/ome-files-cpp">https://github.com/ome/ome-files-cpp</ext-link>), a number of standard microscopy data formats are supported using libbioimage (<ext-link ext-link-type="uri" xlink:href="https://bitbucket.org/dimin/bioimageconvert/">https://bitbucket.org/dimin/bioimageconvert/</ext-link>). Imaris data are supported using a custom reader implemented in C++ using the HDF5 library. Motion corrected data can be saved to an OME-TIFF or Imaris file respectively.</p></sec><sec id="s4-5"><title>Simulation of motion distorted time tagged FLIM data</title><p>Monte Carlo simulations of 2D TTTR data distorted by sample motion were performed using a subset of a high SNR, motion-free intensity image <inline-formula><mml:math id="inf43"><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> of ex vivo pancreas (shown in <xref ref-type="fig" rid="fig1">Figure 1</xref>). The sample motion was set to a sinusoidal motion such that<disp-formula id="equ15"><mml:math id="m15"><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mfenced separators="|"><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi>A</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">cos</mml:mi></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mi>θ</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:mrow><mml:mrow><mml:mrow><mml:mi mathvariant="normal">sin</mml:mi></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:mi>f</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:mrow></mml:math></disp-formula><disp-formula id="equ16"><mml:math id="m16"><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow></mml:msub><mml:mfenced separators="|"><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi>A</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">sin</mml:mi></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mi>θ</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:mrow><mml:mrow><mml:mrow><mml:mi mathvariant="normal">sin</mml:mi></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:mi>f</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:mrow></mml:math></disp-formula>where <inline-formula><mml:math id="inf44"><mml:mi>A</mml:mi></mml:math></inline-formula> and <inline-formula><mml:math id="inf45"><mml:mi>f</mml:mi> <mml:mi/></mml:math></inline-formula>are the sample amplitude and frequency respectively while <inline-formula><mml:math id="inf46"><mml:mi>θ</mml:mi></mml:math></inline-formula> is the angle of the motion with respect to the scanner fast axis. A TTTR event stream was simulated according to Algorithm 2.</p></sec><sec id="s4-6"><title>Algorithm 2. Simulation of TTTR data</title><list list-type="order"><list-item><p>Start at pixel <inline-formula><mml:math id="inf47"><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:math></inline-formula> at macro time <inline-formula><mml:math id="inf48"><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:math></inline-formula>.</p></list-item><list-item><p>Determine the sample intensity <inline-formula><mml:math id="inf49"><mml:mi>λ</mml:mi></mml:math></inline-formula> at the current pixel, accounting for the sample motion according to <inline-formula><mml:math id="inf50"><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mi>α</mml:mi><mml:msub><mml:mrow><mml:mo>⋅</mml:mo><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msub><mml:mfenced separators="|"><mml:mrow><mml:mi>x</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mfenced separators="|"><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:mfenced><mml:mo>,</mml:mo> <mml:mi/><mml:mi>y</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi>y</mml:mi></mml:mrow></mml:msub><mml:mfenced separators="|"><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:math></inline-formula>, where <inline-formula><mml:math id="inf51"><mml:mi>α</mml:mi></mml:math></inline-formula> is an intensity scaling factor controlling the simulated count rate.</p></list-item><list-item><p>Determine the number of photons arriving at this pixel, <inline-formula><mml:math id="inf52"><mml:mi>N</mml:mi></mml:math></inline-formula>, drawn from a Poisson distribution with mean <inline-formula><mml:math id="inf53"><mml:mi>λ</mml:mi></mml:math></inline-formula>.</p></list-item><list-item><p>For each photon,</p><list list-type="order"><list-item><p>Determine the photon arrival time, drawn from the sum of value drawn from the sum of values drawn from an exponential distribution with mean parameter <inline-formula><mml:math id="inf54"><mml:mi>τ</mml:mi></mml:math></inline-formula> and a Gaussian distribution representing the instrument response characterized by <inline-formula><mml:math id="inf55"><mml:mi>μ</mml:mi><mml:mo>=</mml:mo><mml:mn>1.0</mml:mn></mml:math></inline-formula> ns and <inline-formula><mml:math id="inf56"><mml:mi>σ</mml:mi><mml:mo>=</mml:mo><mml:mn>100</mml:mn></mml:math></inline-formula> ps</p></list-item><list-item><p>Determine the macro arrival time by evenly spacing the <inline-formula><mml:math id="inf57"><mml:mi>N</mml:mi></mml:math></inline-formula> photons across the pixel time.</p></list-item><list-item><p>and add to the event stream.</p></list-item></list></list-item><list-item><p>Increment the macro time <inline-formula><mml:math id="inf58"><mml:mi>t</mml:mi></mml:math></inline-formula> by the pixel time</p></list-item><list-item><p>Move to the next pixel</p><list list-type="order"><list-item><p>If moving to the next row</p><list list-type="order"><list-item><p>Insert a line end marker,</p></list-item><list-item><p>increment the macro time by the interline time,</p></list-item><list-item><p>insert a line start marker</p></list-item></list></list-item><list-item><p>If moving to the next frame</p><list list-type="order"><list-item><p>Insert a line end marker,</p></list-item><list-item><p>increment the macro time by the interface time,</p></list-item><list-item><p>insert a frame start marker,</p></list-item><list-item><p>insert a line end marker</p></list-item></list></list-item></list></list-item><list-item><p>Repeat for the specified number of frames.</p></list-item></list><p>All simulations shown in <xref ref-type="fig" rid="fig1">Figure 1</xref> were performed using a frame size of 256 × 256 pixels. The pixel time and interline time were set such that line rate was 1 kHz with a duty cycle of 0.33 and the interframe time was set equal to the interline time, approximately matching the scan pattern of the Leica SP8 scanner. The intensity was scaled to produce an average count rate of 1 MHz and 50 frames were generated per image.</p></sec><sec id="s4-7"><title>Animal experiments</title><p>Animals were kept in conventional animal facilities on a 12 hr day-night cycle and fed <italic>ad libitum</italic>. All experiments were carried out in compliance with the Australian code for the care and use of animals for scientific purposes and in compliance with Garvan Institute of Medical Research/St. Vincent’s Hospital Animal Ethics Committee guidelines (ARA 13/17, 16/13, 15/29).</p><p>For in vivo Rac1 activity experiments, mice ubiquitously expressing the Raichu-1011X ECFP-SEYFP Rac1 biosensor (<xref ref-type="bibr" rid="bib27">Itoh et al., 2002</xref>), generated previously (<xref ref-type="bibr" rid="bib28">Johnsson et al., 2014</xref>), were used.</p></sec><sec id="s4-8"><title>Human experiments</title><p>Experiments conducted on healthy human subjects using the DermaInspect were performed with informed consent and approval from the University of Queensland Human Research Ethics Committee (approval number 2007/197–2008001342). Experiments conducted on healthy human subjects using the hand held multiphoton system were performed with informed consent and approval from Imperial College London (approval number 14IC2364).</p></sec><sec id="s4-9"><title>Cell culture</title><p>Primary KPC cancer cells isolated from <italic>Pdx1-Cre; LSL-KRas<sup>G12D/+</sup>; LSL-Trp53<sup>R172H/+</sup></italic> tumours (<xref ref-type="bibr" rid="bib45">Morton et al., 2010a</xref>) were engineered to express a Src-FRET biosensor (<xref ref-type="bibr" rid="bib74">Wang et al., 2005</xref>) modified to replace ECFP with mTurquoise2 using a transposon system (<xref ref-type="bibr" rid="bib70">Vennin et al., 2017</xref>; <xref ref-type="bibr" rid="bib78">Wilson et al., 2007</xref>). KPC cells were cultured in DMEM (Gibco) supplemented with 10% FBS and 1% glutamine, penicillin/streptomycin in 5% CO<sub>2</sub>.</p></sec><sec id="s4-10"><title>Small animal surgery and imaging</title><sec id="s4-10-1"><title>Implantation of and imaging through optical windows</title><p>The application of optical imaging windows in in vivo imaging and their implantation into the peritoneal wall were described in detail previously (<xref ref-type="bibr" rid="bib56">Ritsma et al., 2013</xref>). Prior to the surgery and up to a mininum of 72 hr afterwards the mice were kept on 5 mg/kg of the analgesic Carprofen (Rimadyl) in the drinking water. Mice were weaned of the analgesic 24 hr before imaging took place. Mice were administered buprenorphine (0.2 mg/kg) s.c. immediately prior to and 6 hr post-surgery for further pain control. The imaging window consists of a titanium window ring, onto which a glass coverslip with a diameter of 12 mm was glued with cyanoacrylate one day prior to surgery. The incision site was cleared of hair by shaving and depilation and disinfected with 0.5% chlorhexidine in 70% ethanol. An incision was made down the midline of the peritoneum for imaging of the small intestine or to the left of the midline of the mouse for the imaging of the pancreas. After blunt dissection of the skin surrounding the incision, a purse string suture (Mersilk, non-absorbable silk based) was placed through the skin and muscle of the abdominal wall. To reduce peristaltic and respiration-associated movement of the organs to be imaged in the peritoneum, a drop of cyanoacrylate was placed on the inner ring of the abdominal imaging windows and the organ of interest immobilized at the edge. Positioning was done using sterile cotton gauzes. The windows were then inserted into the incisions with the skin and the muscle layer placed into the lateral groove of the windows. Finally, the suture was tightened and firmly tied off at the ends. The mice were allowed to recover from the surgery for at least 72 hr, actively foraging, grooming and feeding within minutes after being removed from the anaesthesia respirator. Mice were anesthetized with 3% isoflurane, supplemented with 100% oxygen and were imaged under 1–2% isoflurane supplemented with 100% oxygen on a 37°C heated stage.</p></sec><sec id="s4-10-2"><title>Intrasplenic injection of cancer cells</title><p>Prior to intrasplenic injection, abdominal optical windows were implanted in BALB/c-Fox1nuAusb mice on top of the liver, which were subsequently allowed to recover for 1 week. For intrasplenic injection experiments, KPC cells expressing the Src biosensor (3 × 10<sup>6</sup> cells/50 μL HBSS) were injected into the spleens of BALB/c-Fox1nuAusb mice (anesthetized with 3% isoflurane, O<sub>2</sub>1 L/min, vacuum was used constantly to remove excess of O<sub>2</sub>) as previously described (<xref ref-type="bibr" rid="bib63">Soares et al., 2014</xref>). Mice were subjected to three rounds of priming with 100 mg/kg Fasudil (HA-1077, Jomar Life Research) in saline buffer (or vehicle control) every 12 hr and by oral gavage before intrasplenic injection, and two subsequent rounds of priming with Fasudil to mimic systemic ROCK inhibition during metastatic spread of KPC cells (twice daily administration by oral gavage). The mice were imaged at 4, 8, 16 and 24 hr after injection and sacrificed after the final imaging time point. See <xref ref-type="fig" rid="fig5">Figure 5C</xref> for treatment timeline.</p></sec><sec id="s4-10-3"><title>Immunisation and antigen trafficking</title><p>Kaede OT2 T cells were enriched by negative depletion with biotinylated antibodies for anti-B220 clone RA3-6B2, anti-CD11b clone M1/70, anti-CD11c clone HL3, anti-CD8 clone 53–6.7, and tdtomato SW<sub>HEL</sub> B cells (<xref ref-type="bibr" rid="bib52">Phan et al., 2003</xref>) were enriched by negative depletion with biotinylated antibodies for anti-CD11b, anti-CD11c, anti-CD4 clone GK1.5, anti-CD43 clone S7 (all from BD Bisociences) and MACs anti-biotin magnetic beads (Miltenyi). 2.5 × 10<sup>5</sup> B220<sup>+</sup> HEL<sup>+</sup> SWHEL tdTomato B cells and V<sub>α</sub>2<sup>+</sup> CD4<sup>+</sup> Kaede OT2 cells were adoptively transferred into C57BL/6 recipients and immunised the next day with 20 μg HEL-OVA in Sigma Adjuvant System (Sigma) injected subcutaneously in the lower flank and tail base. To label SCS macrophages, we injected CD169 clone Ser-4 (UCSF Hybridoma Core) conjugated to Alexa Fluor 680 (Invitrogen), 12 hr before imaging. Mice were imaged 7 days after immunisation.</p></sec></sec><sec id="s4-11"><title>Ex vivo tissue drug treatment</title><p>Sections of freshly excised and flushed duodenal tissue were treated with 1 μM (-)-Scopolamine-N-butylbromide (scopolamine, Sigma-Aldrich, S7882) in PBS for 30 mins at 37°C or 200 nM phorbol myristate acetate (PMA, Sigma-Aldrich, P8139) for 15 mins.</p></sec><sec id="s4-12"><title>Image acquisition</title><sec id="s4-12-1"><title>Small animal and ex vivo FLIM imaging</title><p>Multi-photon FLIM data were acquired using an inverted Leica DMI 6000 SP8 confocal microscope using a 25 × 0.95 NA water immersion objective on an inverted stage. The sample was excited using a Ti:Sapphire femto-second laser (Coherent Chameleon Ultra II) operating at 80 MHz and tuned to a wavelength of 840 nm. A RLD HyD detector was used with a 483/32 nm bandpass emission filter for FRET biosensor imaging. FLIM data were recorded in single channel mode using a Picoquant PicoHarp 300 in TTTR mode or using a Cronologic TimeTagger4-2G. For Src biosensor imaging, photon counting was performed in three spectral channels, 435/40, 483/32 and 525/50 nm, using a Cronologic TimeTagger4-2G. Detailed acquisition parameters for all imaging experiments are given in <xref ref-type="supplementary-material" rid="supp1">Supplementary file 1</xref>. Imaging was performed using a heated stage maintained at 37°C.</p></sec><sec id="s4-12-2"><title>Human skin imaging, DermaInspect</title><p>Depth resolved in vivo multiphoton tomography of human skin was performed with a DermaInspect system (JenLab GmbH, Jena, Germany), illuminated with an ultrashort (85 femtosecond pulse width) pulsed mode-locked 80 MHz Ti:Sapphire laser (MaiTai, Spectra Physics, Mountain View, USA), tuned to excitation at 760 nm. Emission was collected in four spectral channels using cooled PMTs (PMC-100 Becker and Hickl, Berlin, Germany) with the following spectral filters: 350–450 nm (Channel 1); 450–515 nm (Channel 2); 515–620 nm (Channel 3); 620–670 nm (Channel 4). A TCSPC system (SPC830, Becker and Hickl, Berlin, Germany) was used to perform FLIM measurements in FIFO mode. A 40 × NA 1.30 Plan-Neofluar oil-immersion (Carl Zeiss, Germany) was used with an in vivo adaptor designed to hold a coverslip against the skin. The space between the in vivo adaptor and the objective lens was filled with index-matching oil. The first spectral channel, 350–450 nm, was used for FLIM analysis.</p></sec><sec id="s4-12-3"><title>Human skin imaging, handheld multiphoton</title><p>Autofluorescence images of human skin were acquired using a handheld multiphoton system as previously described (<xref ref-type="bibr" rid="bib59">Sherlock et al., 2018</xref>). Briefly, the sample was excited using a Ti:Sapphire femto-second laser (Spectra Physics Mai Tai HP) operating at 80MHz tuned to a wavelength of 760 nm coupled to the imaging head through 4 m of NCF. The pulse FWHM at the output of the NCF was approximately 150 fs (<xref ref-type="bibr" rid="bib60">Sherlock et al., 2016</xref>). The sample was imaged using a 60 × 1.2 NA water immersion microscope objective lens (Olympus UPLSAPO60XW). Emission light was separated using a dichroic filter with centre wavelength 705 nm (Smock FF705-Di0) and relayed to a hybrid PMT (Becker and Hickl HPM-100–40) using a fibre bundle. FLIM data were recorded using a Becker and Hickl SPC-830 TCSPC card in FIFO (TTTR) mode. Multiphoton images were acquired with a line scan rate of 256 Hz, allowing a 256 × 256 pixel images to be acquired in 1 s. The system incorporates a hardware axial motion compensation system actively moving the objective using a piezo actuator (PI P-725 PIFOC) in response to the sample axial displacement tracked employing an optical computed tomography (OCT) system operating using a super luminescent diode with centre wavelength of 930 nm (Supremum 930-B-I-10-PM) (<xref ref-type="bibr" rid="bib58">Sherlock et al., 2015</xref>). A volunteer’s dorsal forearm was imaged with their arm lying on a flat rigid surface and with the scanner handheld such that the objective was approximately vertical (<xref ref-type="bibr" rid="bib59">Sherlock et al., 2018</xref>). Some of the weight of the scanner was taken by the operator and some was taken by the scanner resting gently on the arm. To introduce axial motion, the volunteer continuously opened and closed their fist with a period of approximately 0.9 s during the acquisition which introduced a change in pressure between the skin and the front surface of the scanner due to the change in the size of the muscle beneath.</p></sec><sec id="s4-12-4"><title>Intravital lymph node imaging</title><p>Intravital two-photon microscopy was performed as previously described with some minor changes (<xref ref-type="bibr" rid="bib8">Chtanova et al., 2014</xref>). Briefly, mice were induced with 100 mg/kg ketamine, 5 mg/kg xylazine and maintained on 1–2% isoflurane supplemented with 100% oxygen for anesthesia. Mice were kept warm on a custom heated SmartStage (Biotherm) set to 37°C. The inguinal lymph node was mobilised along with the intact inguinal ligament in a skin flap and fixed on a base of thermal conductive T-putty (Thermagon Inc.) with VetBond tissue glue (3M). The cortical surface of the lymph node was exposed by microdisseting the skin and overlying fat and fascia layers. Imaging was performed on a Zeiss 7MP two-photon microscope (Carl Zeiss) powered by a Chameleon Vision II ultrafast Ti:Sapphire laser (Coherent Scientific). Images were acquired with a W Plan-Apochromat 20 × 1.0 NA DIC (UV)Vis-IR water immersion objective. Excitation wavelengths used were 870 nm, to detect KD green and tdtomato red. Fluorescent images were acquired with a LBF 760 and BSMP 760 to enable detection of far-red signals. Non-descanned detectors were SP 485 (blue; SHG), BP 500–550 (green; KD), BP 565–610 (red; tdTomato) and BP 640–710 (far-red; Alexa Fluor 680).</p></sec></sec><sec id="s4-13"><title>Data analysis</title><sec id="s4-13-1"><title>Lifetime analysis of FLIM data</title><p>Raw and aligned FLIM data were analyzed in <italic>FLIMfit</italic> (<xref ref-type="bibr" rid="bib75">Warren et al., 2013</xref>) using a maximum likelihood estimator. A 3 × 3 smoothing kernel was applied to the data before analysis. Instrument response functions (IRFs) were determined using a reference dye measurement as previously described (<xref ref-type="bibr" rid="bib11">Conway et al., 2017</xref>). The data were fitted to a single exponential model to determine the average fluorescence lifetime.</p></sec><sec id="s4-13-2"><title>Complex donor FRET analysis of Rac1 biosensor intestinal crypt data</title><p>The data were fitted to a FRET model accounting for the complex decay profile of the ECFP donor as presented in (<xref ref-type="bibr" rid="bib75">Warren et al., 2013</xref>). The complex decay of ECFP originates in the existence of two major conformations of ECFP with different lifetimes (<xref ref-type="bibr" rid="bib13">Demachy et al., 2005</xref>). In this model, we assume the ECFP Rac1 biosensor exists in two conformations, associated with high and low FRET activity respectively. In each of these conformations, there is a mix of ECFP conformations, which do not affect the overall biosensor conformation. In this model, the FRET efficiencies for the two ECFP conformations are linked by<disp-formula id="equ17"><label>(12)</label><mml:math id="m17"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mfrac><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mfrac><mml:msub><mml:mi>τ</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>τ</mml:mi><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mfrac><mml:mo>⋅</mml:mo><mml:mfrac><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula>and so the total decay for a given biosensor conformation is<disp-formula id="equ18"><label>(13)</label><mml:math id="m18"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>F</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>;</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:munderover><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi>exp</mml:mi><mml:mo>⁡</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>τ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>We can then fit our data to a model consisting of two biosensor conformations with a high FRET activity <inline-formula><mml:math id="inf59"><mml:msubsup><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup></mml:math></inline-formula> and low FRET activity <inline-formula><mml:math id="inf60"><mml:msubsup><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:msubsup></mml:math></inline-formula> respectively<disp-formula id="equ19"><label>(14)</label><mml:math id="m19"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>I</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>;</mml:mo><mml:msubsup><mml:mi>E</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mi>E</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>I</mml:mi><mml:mo>⋅</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msub><mml:mi>F</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>;</mml:mo><mml:msubsup><mml:mi>E</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi>F</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:msubsup><mml:mi>E</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf61"><mml:msub><mml:mrow><mml:mi>γ</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the fraction of biosensor in the active conformation in a given pixel.</p><p>To determine the lifetimes of the two ECFP conformations, we made time resolved measurements of KPC cells expressing ECFP alone. By fitting globally to a bi-exponential decay, we found ECFP was best fit by two components <inline-formula><mml:math id="inf62"><mml:msub><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1330</mml:mn></mml:math></inline-formula> ps and <inline-formula><mml:math id="inf63"><mml:msub><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>3350</mml:mn></mml:math></inline-formula> ps with fractional contribution of the first component <inline-formula><mml:math id="inf64"><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0.434</mml:mn></mml:math></inline-formula>. We fixed these values and fitted the measured Rac1 FRET data to the model described in <xref ref-type="disp-formula" rid="equ19">Equation 14</xref> globally to obtain the values of the FRET efficiency for the high- and low-activity conformations, <inline-formula><mml:math id="inf65"><mml:msubsup><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup></mml:math></inline-formula> and <inline-formula><mml:math id="inf66"><mml:msubsup><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:msubsup></mml:math></inline-formula>. We used these values to determine the fraction of active biosensor in each pixel.</p></sec><sec id="s4-13-3"><title>Phasor analysis of FLIM data</title><p>Phasor analysis of FLIM data was performed following (<xref ref-type="bibr" rid="bib14">Digman et al., 2008</xref>). The <italic>s</italic> and <italic>g</italic> coordinates of the phasor plot for the decay <inline-formula><mml:math id="inf67"><mml:mi>I</mml:mi><mml:mo>(</mml:mo><mml:mi>t</mml:mi><mml:mo>)</mml:mo></mml:math></inline-formula> in each pixel were computed according to<disp-formula id="equ20"><mml:math id="m20"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnalign="left left" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mi>g</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>ω</mml:mi><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munderover><mml:mi>I</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow><mml:mi>cos</mml:mi><mml:mo>⁡</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mfrac><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mi>T</mml:mi></mml:mfrac><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munderover><mml:mi>I</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula><disp-formula id="equ21"><label>(15)</label><mml:math id="m21"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>s</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>ω</mml:mi><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munderover><mml:mi>I</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow><mml:mi>sin</mml:mi><mml:mo>⁡</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mfrac><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:mi>t</mml:mi></mml:mrow><mml:mi>T</mml:mi></mml:mfrac><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munderover><mml:mi>I</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf68"><mml:mi>T</mml:mi></mml:math></inline-formula> is the laser repetition period and <inline-formula><mml:math id="inf69"><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> the number of time points. For display and back gating, the phasor values were smoothed using a 5 × 5 uniform kernel. To generate the phasor plot, the phasor values for each pixel in an image were histogrammed into a 256 × 256 matrix with limits <inline-formula><mml:math id="inf70"><mml:mn>0</mml:mn><mml:mo>≤</mml:mo><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:mi>s</mml:mi><mml:mo>≤</mml:mo><mml:mn>1</mml:mn></mml:math></inline-formula>. The histogram was weighted according to the intensity in each pixel.</p></sec><sec id="s4-13-4"><title>Hyperspectral unmixing of lifetime data</title><p>Using phasor analysis as described above, regions associated with liver cells, blood, collagen and the Src biosensor respectively were identified. For each region, the pixels were summed and a multispectral ‘pattern’ was generated by fitting the summed data in each spectral channel to a 4-component exponential model <inline-formula><mml:math id="inf71"><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>λ</mml:mi></mml:mrow></mml:msub><mml:mo>(</mml:mo><mml:mi mathvariant="bold-italic">A</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold-italic">τ</mml:mi><mml:mo>)</mml:mo></mml:math></inline-formula>.<disp-formula id="equ22"><label>(16)</label><mml:math id="m22"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>λ</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">A</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold-italic">τ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>g</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>λ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>⊗</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>4</mml:mn></mml:mrow></mml:munderover><mml:msub><mml:mi>A</mml:mi><mml:mrow><mml:mi>λ</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi>exp</mml:mi><mml:mo>⁡</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mi>t</mml:mi><mml:msub><mml:mi>τ</mml:mi><mml:mrow><mml:mi>λ</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Where <inline-formula><mml:math id="inf72"><mml:mi>g</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>λ</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> is the instrument response function, <inline-formula><mml:math id="inf73"><mml:msub><mml:mrow><mml:mi>A</mml:mi></mml:mrow><mml:mrow><mml:mi>λ</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the contribution of the <italic>i</italic><sup>th</sup> lifetime component <inline-formula><mml:math id="inf74"><mml:msub><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mi>λ</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> in channel <inline-formula><mml:math id="inf75"><mml:mi>λ</mml:mi></mml:math></inline-formula>. To identify the relative abundance of each component using these pre-determined patterns, non-negative least squares fitting was performed using each of the patterns for each pixel using the LAPACK routine ‘nnls’ (<xref ref-type="bibr" rid="bib38">Lawson and Hanson, 1995</xref>) to determine the solution to the linear problem<disp-formula id="equ23"><label>(17)</label><mml:math id="m23"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>λ</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>λ</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup></mml:mtd></mml:mtr></mml:mtable><mml:mtext> </mml:mtext><mml:mo>⋯</mml:mo><mml:mtext> </mml:mtext><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>m</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>m</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>λ</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>m</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>λ</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>m</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msubsup></mml:mtd></mml:mtr></mml:mtable></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mi>m</mml:mi></mml:mrow></mml:msub></mml:mtd></mml:mtr></mml:mtable><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:msub><mml:mi>y</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msub><mml:mi>y</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msub><mml:mi>y</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>λ</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:msub><mml:mi>y</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>λ</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:mtd></mml:mtr></mml:mtable><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula>where <inline-formula><mml:math id="inf76"><mml:msub><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>λ</mml:mi><mml:mo>=</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> is the intensity of the <italic>i</italic><sup>th</sup> time point and <italic>j</italic><sup>th</sup> channel and <inline-formula><mml:math id="inf77"><mml:msub><mml:mrow><mml:mi>γ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:math></inline-formula> is the abundance of pattern <inline-formula><mml:math id="inf78"><mml:msubsup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mi>i</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:msubsup></mml:math></inline-formula> in the pixel.</p></sec></sec><sec id="s4-14"><title>Rac1-GTP immunohistochemistry</title><p>The tissue was fixed in 10% buffered formalin solution overnight and embedded in paraffin using the swiss roll method (<xref ref-type="bibr" rid="bib4">Bialkowska et al., 2016</xref>). Cut sections were de-paraffinised using xylene and rehydrated in graded ethanol washes. Antigen retrieval was performed in citrate buffer (S1699, pH = 6) for 30 min at 99°C and allowed to cool to RT for another 30 min. Endogenous peroxidase activity was subsequently quenched in 1.5% H<sub>2</sub>O<sub>2</sub> before the application of 10% normal goat serum (NGS) in protein block (Dako) for 1 hr at RT. Slides were incubated overnight at 4°C with primary antibody (active Rac1-GTP, 1:400, NewEast Biosciences) in 10% NGS in protein block prior to applying secondary HRP-coupled anti-mouse antibody (Envision). Detection was performed with diaminobenzidine (DAB) for 5 min and slides counterstained with haematoxylin. Slides were digitalised at 20 × magnification using a slide scanner (AperioCS2, Leica Biosystems). Data were analysed using QuPath (<xref ref-type="bibr" rid="bib2">Bankhead et al., 2017</xref>). DAB and haematoxylin optical densities were computed for each pixel using colour deconvolution and regions containing crypts were manually identified. Nuclei within these regions were identified automatically using watershed cell detection based on the haematoxylin counterstain. Cell regions were then segmented by dilating the nuclear detections by 5 μm. The average DAB optical density was computed for each cell. These values were then averaged across each sample for n = 3 mice.</p></sec><sec id="s4-15"><title>Software availability</title><p><italic>Galene</italic> is provided as an open source package with a graphical user interface and is available for download at <ext-link ext-link-type="uri" xlink:href="https://galene.flimfit.org/">https://galene.flimfit.org/</ext-link> alongside user documentation, and is integrated directly into the <italic>FLIMfit</italic> analysis software (<xref ref-type="bibr" rid="bib75">Warren et al., 2013</xref>). This software may be directly applied to data acquired on commercial microscope systems. The source code is available under the GPLv2 license at <ext-link ext-link-type="uri" xlink:href="https://github.com/flimfit/Galene">https://github.com/flimfit/Galene</ext-link> (copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/Galene">https://github.com/elifesciences-publications/Galene</ext-link>). The executables, manual and source code used in this manuscript are attached as Supplementary files. A tutorial screencast documenting the use of <italic>Galene</italic> is shown in <xref ref-type="video" rid="video6">Video 6</xref>.</p><media id="video6" mime-subtype="mp4" mimetype="video" xlink:href="elife-35800-video6.mp4"><object-id pub-id-type="doi">10.7554/eLife.35800.023</object-id><label>Video 6.</label><caption><title>Tutorial screencast.</title><p>Screencast documenting motion correction of FLIM data using <italic>Galene</italic>.</p></caption></media></sec></sec></body><back><ack id="ack"><title>Acknowledgements</title><p>This study was supported by the National Health and Medical Research Council (NHMRC, project and fellowship funding), Cancer Institute NSW Early Career Fellowship, Cancer Council NSW, Cancer Australia, National Breast Cancer Foundation, St. Vincent’s Clinical Foundation, Tour de Cure grants and a Len Ainsworth Pancreatic Cancer Research Fellowship. This project is made possible by an Avner Pancreatic Cancer Foundation Grant.</p></ack><sec id="s5" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="COI-statement" id="conf1"><p>No competing interests declared</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>Conceptualization, Software, Formal analysis, Investigation, Visualization, Writing—original draft</p></fn><fn fn-type="con" id="con2"><p>Resources, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con3"><p>Formal analysis, Visualization, Writing—review and editing</p></fn><fn fn-type="con" id="con4"><p>Resources, Investigation, Writing—review and editing</p></fn><fn fn-type="con" id="con5"><p>Resources, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con6"><p>Methodology, Writing—original draft</p></fn><fn fn-type="con" id="con7"><p>Resources, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con8"><p>Resources, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con9"><p>Investigation, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con10"><p>Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con11"><p>Resources, Writing—review and editing</p></fn><fn fn-type="con" id="con12"><p>Resources, Writing—review and editing</p></fn><fn fn-type="con" id="con13"><p>Resources, Writing—review and editing</p></fn><fn fn-type="con" id="con14"><p>Resources, Writing—review and editing</p></fn><fn fn-type="con" id="con15"><p>Resources, Writing—review and editing</p></fn><fn fn-type="con" id="con16"><p>Supervision, Funding acquisition, Methodology</p></fn><fn fn-type="con" id="con17"><p>Resources, Funding acquisition, Writing—review and editing</p></fn><fn fn-type="con" id="con18"><p>Conceptualization, Supervision, Funding acquisition, Writing—review and editing</p></fn></fn-group><fn-group content-type="ethics-information"><title>Ethics</title><fn fn-type="other" id="fn1"><p>Human subjects: Experiments conducted on healthy human subjects using the DermaInspect were performed with informed consent and approval from the University of Queensland Human Research Ethics Committee (approval number 2007/197-2008001342). Experiments conducted on healthy human subjects using the hand-held multiphoton system were performed with informed consent and approval from Imperial College London (approval number 14IC2364).</p></fn><fn fn-type="other" id="fn2"><p>Animal experimentation: All experiments were carried out in compliance with the Australian code for the care and use of animals for scientific purposes and in compliance with Garvan Institute of Medical Research/St. Vincent's Hospital Animal Ethics Committee guidelines (ARA 13/17, 16/13, 15/29).</p></fn></fn-group></sec><sec id="s6" sec-type="supplementary-material"><title>Additional files</title><supplementary-material id="supp1"><object-id pub-id-type="doi">10.7554/eLife.35800.024</object-id><label>Supplementary file 1.</label><caption><title>Acquisition and realignment parameters used through the study.</title></caption><media mime-subtype="docx" mimetype="application" xlink:href="elife-35800-supp1-v1.docx"/></supplementary-material><supplementary-material id="transrepform"><object-id pub-id-type="doi">10.7554/eLife.35800.025</object-id><label>Transparent reporting form</label><media mime-subtype="pdf" mimetype="application" xlink:href="elife-35800-transrepform-v1.pdf"/></supplementary-material><sec id="s7" sec-type="data-availability"><title>Data availability</title><p>All data generated or analysed during this study are included in the manuscript and supporting files.</p><p>The following previously published dataset was used:</p><p><related-object content-type="generated-dataset" id="dataset1" source-id="https://omero.bioinformatics.ic.ac.uk/omero/webclient/?show=project-4552" source-id-type="uri"><collab collab-type="author">Sherlock B</collab><collab collab-type="author">Warren SC</collab><collab collab-type="author">Alexandrov Y</collab><collab collab-type="author">Yu F</collab><collab collab-type="author">Stone J</collab><collab collab-type="author">Knight J</collab><collab collab-type="author">Neil MAA</collab><collab collab-type="author">Paterson C</collab><collab collab-type="author">French PMW</collab><collab collab-type="author">Dunsby C</collab><year>2018</year><source>Data from: In vivo multiphoton microscopy using a handheld scanner with lateral and axial motion compensation</source><ext-link ext-link-type="uri" xlink:href="https://omero.bioinformatics.ic.ac.uk/omero/webclient/?show=project-4552">https://omero.bioinformatics.ic.ac.uk/omero/webclient/?show=project-4552</ext-link><comment>Publicly available at OMERO (project number 4552)</comment></related-object></p></sec></sec><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Baker</surname> <given-names>S</given-names></name><name><surname>Matthews</surname> <given-names>I</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>Lucas-Kanade 20 years on: a unifying framework</article-title><source>International Journal of Computer Vision</source><volume>56</volume><fpage>221</fpage><lpage>255</lpage><pub-id pub-id-type="doi">10.1023/B:VISI.0000011205.11775.fd</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bankhead</surname> <given-names>P</given-names></name><name><surname>Loughrey</surname> <given-names>MB</given-names></name><name><surname>Fernández</surname> <given-names>JA</given-names></name><name><surname>Dombrowski</surname> <given-names>Y</given-names></name><name><surname>McArt</surname> <given-names>DG</given-names></name><name><surname>Dunne</surname> <given-names>PD</given-names></name><name><surname>McQuaid</surname> <given-names>S</given-names></name><name><surname>Gray</surname> <given-names>RT</given-names></name><name><surname>Murray</surname> <given-names>LJ</given-names></name><name><surname>Coleman</surname> <given-names>HG</given-names></name><name><surname>James</surname> <given-names>JA</given-names></name><name><surname>Salto-Tellez</surname> <given-names>M</given-names></name><name><surname>Hamilton</surname> <given-names>PW</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>QuPath: Open source software for digital pathology image analysis</article-title><source>Scientific Reports</source><volume>7</volume><elocation-id>16878</elocation-id><pub-id pub-id-type="doi">10.1038/s41598-017-17204-5</pub-id><pub-id pub-id-type="pmid">29203879</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Becker</surname> <given-names>W</given-names></name><name><surname>Bergmann</surname> <given-names>A</given-names></name><name><surname>Haustein</surname> <given-names>E</given-names></name><name><surname>Petrasek</surname> <given-names>Z</given-names></name><name><surname>Schwille</surname> <given-names>P</given-names></name><name><surname>Biskup</surname> <given-names>C</given-names></name><name><surname>Kelbauskas</surname> <given-names>L</given-names></name><name><surname>Benndorf</surname> <given-names>K</given-names></name><name><surname>Klöcker</surname> <given-names>N</given-names></name><name><surname>Anhut</surname> <given-names>T</given-names></name><name><surname>Riemann</surname> <given-names>I</given-names></name><name><surname>König</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>Fluorescence lifetime images and correlation spectra obtained by multidimensional time-correlated single photon counting</article-title><source>Microscopy Research and Technique</source><volume>69</volume><fpage>186</fpage><lpage>195</lpage><pub-id pub-id-type="doi">10.1002/jemt.20251</pub-id><pub-id pub-id-type="pmid">16538624</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bialkowska</surname> <given-names>AB</given-names></name><name><surname>Ghaleb</surname> <given-names>AM</given-names></name><name><surname>Nandan</surname> <given-names>MO</given-names></name><name><surname>Yang</surname> <given-names>VW</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Improved Swiss-rolling technique for intestinal tissue preparation for immunohistochemical and immunofluorescent analyses</article-title><source>Journal of Visualized Experiments</source><pub-id pub-id-type="doi">10.3791/54161</pub-id><pub-id pub-id-type="pmid">27501188</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Blacker</surname> <given-names>TS</given-names></name><name><surname>Duchen</surname> <given-names>MR</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Investigating mitochondrial redox state using NADH and NADPH autofluorescence</article-title><source>Free Radical Biology and Medicine</source><volume>100</volume><fpage>53</fpage><lpage>65</lpage><pub-id pub-id-type="doi">10.1016/j.freeradbiomed.2016.08.010</pub-id><pub-id pub-id-type="pmid">27519271</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Brunton</surname> <given-names>VG</given-names></name><name><surname>Frame</surname> <given-names>MC</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Src and focal adhesion kinase as therapeutic targets in cancer</article-title><source>Current Opinion in Pharmacology</source><volume>8</volume><fpage>427</fpage><lpage>432</lpage><pub-id pub-id-type="doi">10.1016/j.coph.2008.06.012</pub-id><pub-id pub-id-type="pmid">18625340</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Byrd</surname> <given-names>RH</given-names></name><name><surname>Gilbert</surname> <given-names>JC</given-names></name><name><surname>Nocedal</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2000">2000</year><article-title>A trust region method based on interior point techniques for nonlinear programming</article-title><source>Mathematical Programming</source><volume>89</volume><fpage>149</fpage><lpage>185</lpage><pub-id pub-id-type="doi">10.1007/PL00011391</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chtanova</surname> <given-names>T</given-names></name><name><surname>Hampton</surname> <given-names>HR</given-names></name><name><surname>Waterhouse</surname> <given-names>LA</given-names></name><name><surname>Wood</surname> <given-names>K</given-names></name><name><surname>Tomura</surname> <given-names>M</given-names></name><name><surname>Miwa</surname> <given-names>Y</given-names></name><name><surname>Mackay</surname> <given-names>CR</given-names></name><name><surname>Brink</surname> <given-names>R</given-names></name><name><surname>Phan</surname> <given-names>TG</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Real-time interactive two-photon photoconversion of recirculating lymphocytes for discontinuous cell tracking in live adult mice</article-title><source>Journal of Biophotonics</source><volume>7</volume><fpage>425</fpage><lpage>433</lpage><pub-id pub-id-type="doi">10.1002/jbio.201200175</pub-id><pub-id pub-id-type="pmid">23184395</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Conway</surname> <given-names>JR</given-names></name><name><surname>Carragher</surname> <given-names>NO</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Developments in preclinical cancer imaging: innovating the discovery of therapeutics</article-title><source>Nature Reviews Cancer</source><volume>14</volume><fpage>314</fpage><lpage>328</lpage><pub-id pub-id-type="doi">10.1038/nrc3724</pub-id><pub-id pub-id-type="pmid">24739578</pub-id></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Conway</surname> <given-names>JRW</given-names></name><name><surname>Warren</surname> <given-names>SC</given-names></name><name><surname>Herrmann</surname> <given-names>D</given-names></name><name><surname>Murphy</surname> <given-names>KJ</given-names></name><name><surname>Cazet</surname> <given-names>AS</given-names></name><name><surname>Vennin</surname> <given-names>C</given-names></name><name><surname>Shearer</surname> <given-names>RF</given-names></name><name><surname>Killen</surname> <given-names>MJ</given-names></name><name><surname>Magenau</surname> <given-names>A</given-names></name><name><surname>Mélénec</surname> <given-names>P</given-names></name><name><surname>Pinese</surname> <given-names>M</given-names></name><name><surname>Nobis</surname> <given-names>M</given-names></name><name><surname>Zaratzian</surname> <given-names>A</given-names></name><name><surname>Boulghourjian</surname> <given-names>A</given-names></name><name><surname>Da Silva</surname> <given-names>AM</given-names></name><name><surname>Del Monte-Nieto</surname> <given-names>G</given-names></name><name><surname>Adam</surname> <given-names>ASA</given-names></name><name><surname>Harvey</surname> <given-names>RP</given-names></name><name><surname>Haigh</surname> <given-names>JJ</given-names></name><name><surname>Wang</surname> <given-names>Y</given-names></name><name><surname>Croucher</surname> <given-names>DR</given-names></name><name><surname>Sansom</surname> <given-names>OJ</given-names></name><name><surname>Pajic</surname> <given-names>M</given-names></name><name><surname>Caldon</surname> <given-names>CE</given-names></name><name><surname>Morton</surname> <given-names>JP</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Intravital imaging to monitor therapeutic response in moving hypoxic regions resistant to PI3K pathway targeting in pancreatic cancer</article-title><source>Cell Reports</source><volume>23</volume><fpage>3312</fpage><lpage>3326</lpage><pub-id pub-id-type="doi">10.1016/j.celrep.2018.05.038</pub-id><pub-id pub-id-type="pmid">29898401</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Conway</surname> <given-names>JRW</given-names></name><name><surname>Warren</surname> <given-names>SC</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Context-dependent intravital imaging of therapeutic response using intramolecular FRET biosensors</article-title><source>Methods</source><volume>128</volume><fpage>78</fpage><lpage>94</lpage><pub-id pub-id-type="doi">10.1016/j.ymeth.2017.04.014</pub-id><pub-id pub-id-type="pmid">28435000</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cutrale</surname> <given-names>F</given-names></name><name><surname>Trivedi</surname> <given-names>V</given-names></name><name><surname>Trinh</surname> <given-names>LA</given-names></name><name><surname>Chiu</surname> <given-names>CL</given-names></name><name><surname>Choi</surname> <given-names>JM</given-names></name><name><surname>Artiga</surname> <given-names>MS</given-names></name><name><surname>Fraser</surname> <given-names>SE</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Hyperspectral phasor analysis enables multiplexed 5D in vivo imaging</article-title><source>Nature Methods</source><volume>14</volume><fpage>149</fpage><lpage>152</lpage><pub-id pub-id-type="doi">10.1038/nmeth.4134</pub-id><pub-id pub-id-type="pmid">28068315</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Demachy</surname> <given-names>I</given-names></name><name><surname>Ridard</surname> <given-names>J</given-names></name><name><surname>Laguitton-Pasquier</surname> <given-names>H</given-names></name><name><surname>Durnerin</surname> <given-names>E</given-names></name><name><surname>Vallverdu</surname> <given-names>G</given-names></name><name><surname>Archirel</surname> <given-names>P</given-names></name><name><surname>Lévy</surname> <given-names>B</given-names></name></person-group><year iso-8601-date="2005">2005</year><article-title>Cyan fluorescent protein: molecular dynamics, simulations, and electronic absorption spectrum</article-title><source>The Journal of Physical Chemistry B</source><volume>109</volume><fpage>24121</fpage><lpage>24133</lpage><pub-id pub-id-type="doi">10.1021/jp054656w</pub-id><pub-id pub-id-type="pmid">16375404</pub-id></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Digman</surname> <given-names>MA</given-names></name><name><surname>Caiolfa</surname> <given-names>VR</given-names></name><name><surname>Zamai</surname> <given-names>M</given-names></name><name><surname>Gratton</surname> <given-names>E</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>The phasor approach to fluorescence lifetime imaging analysis</article-title><source>Biophysical Journal</source><volume>94</volume><fpage>L14</fpage><lpage>L16</lpage><pub-id pub-id-type="doi">10.1529/biophysj.107.120154</pub-id><pub-id pub-id-type="pmid">17981902</pub-id></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dombeck</surname> <given-names>DA</given-names></name><name><surname>Khabbaz</surname> <given-names>AN</given-names></name><name><surname>Collman</surname> <given-names>F</given-names></name><name><surname>Adelman</surname> <given-names>TL</given-names></name><name><surname>Tank</surname> <given-names>DW</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>Imaging large-scale neural activity with cellular resolution in awake, mobile mice</article-title><source>Neuron</source><volume>56</volume><fpage>43</fpage><lpage>57</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2007.08.003</pub-id><pub-id pub-id-type="pmid">17920014</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ellenbroek</surname> <given-names>SI</given-names></name><name><surname>van Rheenen</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Imaging hallmarks of cancer in living mice</article-title><source>Nature Reviews Cancer</source><volume>14</volume><fpage>406</fpage><lpage>418</lpage><pub-id pub-id-type="doi">10.1038/nrc3742</pub-id><pub-id pub-id-type="pmid">24854083</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Erami</surname> <given-names>Z</given-names></name><name><surname>Herrmann</surname> <given-names>D</given-names></name><name><surname>Warren</surname> <given-names>SC</given-names></name><name><surname>Nobis</surname> <given-names>M</given-names></name><name><surname>McGhee</surname> <given-names>EJ</given-names></name><name><surname>Lucas</surname> <given-names>MC</given-names></name><name><surname>Leung</surname> <given-names>W</given-names></name><name><surname>Reischmann</surname> <given-names>N</given-names></name><name><surname>Mrowinska</surname> <given-names>A</given-names></name><name><surname>Schwarz</surname> <given-names>JP</given-names></name><name><surname>Kadir</surname> <given-names>S</given-names></name><name><surname>Conway</surname> <given-names>JRW</given-names></name><name><surname>Vennin</surname> <given-names>C</given-names></name><name><surname>Karim</surname> <given-names>SA</given-names></name><name><surname>Campbell</surname> <given-names>AD</given-names></name><name><surname>Gallego-Ortega</surname> <given-names>D</given-names></name><name><surname>Magenau</surname> <given-names>A</given-names></name><name><surname>Murphy</surname> <given-names>KJ</given-names></name><name><surname>Ridgway</surname> <given-names>RA</given-names></name><name><surname>Law</surname> <given-names>AM</given-names></name><name><surname>Walters</surname> <given-names>SN</given-names></name><name><surname>Grey</surname> <given-names>ST</given-names></name><name><surname>Croucher</surname> <given-names>DR</given-names></name><name><surname>Zhang</surname> <given-names>L</given-names></name><name><surname>Herzog</surname> <given-names>H</given-names></name><name><surname>Hardeman</surname> <given-names>EC</given-names></name><name><surname>Gunning</surname> <given-names>PW</given-names></name><name><surname>Ormandy</surname> <given-names>CJ</given-names></name><name><surname>Evans</surname> <given-names>TRJ</given-names></name><name><surname>Strathdee</surname> <given-names>D</given-names></name><name><surname>Sansom</surname> <given-names>OJ</given-names></name><name><surname>Morton</surname> <given-names>JP</given-names></name><name><surname>Anderson</surname> <given-names>KI</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Intravital FRAP imaging using an E-cadherin-GFP mouse reveals disease- and Drug-Dependent dynamic regulation of Cell-Cell junctions in live tissue</article-title><source>Cell Reports</source><volume>14</volume><fpage>152</fpage><lpage>167</lpage><pub-id pub-id-type="doi">10.1016/j.celrep.2015.12.020</pub-id><pub-id pub-id-type="pmid">26725115</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Evans</surname> <given-names>TRJ</given-names></name><name><surname>Van Cutsem</surname> <given-names>E</given-names></name><name><surname>Moore</surname> <given-names>MJ</given-names></name><name><surname>Purvis</surname> <given-names>JD</given-names></name><name><surname>Strauss</surname> <given-names>LC</given-names></name><name><surname>Rock</surname> <given-names>EP</given-names></name><name><surname>Lee</surname> <given-names>J</given-names></name><name><surname>Lin</surname> <given-names>C</given-names></name><name><surname>Rosemurgy</surname> <given-names>A</given-names></name><name><surname>Arena</surname> <given-names>FP</given-names></name><name><surname>Gara</surname> <given-names>M</given-names></name><name><surname>Armstrong</surname> <given-names>E</given-names></name><name><surname>O’Dwyer</surname> <given-names>PJ</given-names></name></person-group><year iso-8601-date="2012">2012</year><source>Journal of Clinical Oncology</source><volume>30</volume><elocation-id>TPS4134</elocation-id><pub-id pub-id-type="doi">10.1200/jco.2012.30.15_suppl.tps4134</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ewald</surname> <given-names>AJ</given-names></name><name><surname>Werb</surname> <given-names>Z</given-names></name><name><surname>Egeblad</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Monitoring of vital signs for long-term survival of mice under anesthesia</article-title><source>Cold Spring Harbor Protocols</source><volume>2011</volume><elocation-id>pdb.prot5563</elocation-id><pub-id pub-id-type="doi">10.1101/pdb.prot5563</pub-id><pub-id pub-id-type="pmid">21285263</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Foroosh</surname> <given-names>H</given-names></name><name><surname>Zerubia</surname> <given-names>JB</given-names></name><name><surname>Berthod</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2002">2002</year><article-title>Extension of phase correlation to subpixel registration</article-title><source>IEEE Transactions on Image Processing</source><volume>11</volume><fpage>188</fpage><lpage>200</lpage><pub-id pub-id-type="doi">10.1109/83.988953</pub-id><pub-id pub-id-type="pmid">18244623</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Goldberg</surname> <given-names>IG</given-names></name><name><surname>Allan</surname> <given-names>C</given-names></name><name><surname>Burel</surname> <given-names>JM</given-names></name><name><surname>Creager</surname> <given-names>D</given-names></name><name><surname>Falconi</surname> <given-names>A</given-names></name><name><surname>Hochheiser</surname> <given-names>H</given-names></name><name><surname>Johnston</surname> <given-names>J</given-names></name><name><surname>Mellen</surname> <given-names>J</given-names></name><name><surname>Sorger</surname> <given-names>PK</given-names></name><name><surname>Swedlow</surname> <given-names>JR</given-names></name></person-group><year iso-8601-date="2005">2005</year><article-title>The open microscopy environment (OME) data model and XML file: open tools for informatics and quantitative analysis in biological imaging</article-title><source>Genome Biology</source><volume>6</volume><elocation-id>R47</elocation-id><pub-id pub-id-type="doi">10.1186/gb-2005-6-5-r47</pub-id><pub-id pub-id-type="pmid">15892875</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Gorpas</surname> <given-names>D</given-names></name><name><surname>Fatakdawala</surname> <given-names>H</given-names></name><name><surname>Zhang</surname> <given-names>Y</given-names></name><name><surname>Bold</surname> <given-names>R</given-names></name><name><surname>Marcu</surname> <given-names>L</given-names></name></person-group><year iso-8601-date="2015">2015</year><chapter-title>Fluorescence lifetime spectroscopy for breast cancer margins assessment</chapter-title><person-group person-group-type="editor"><name><surname>Alfano</surname> <given-names>R. R</given-names></name><name><surname>Demos</surname> <given-names>S. G</given-names></name></person-group><source>Optical Biopsy XIII: Toward Real-Time Spectroscopic Imaging and Diagnosis, SPIE Proceedings. Presented at the SPIE BiOS</source><publisher-name>SPIE</publisher-name><fpage>93180B</fpage><pub-id pub-id-type="doi">10.1117/12.2079622</pub-id></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Greenberg</surname> <given-names>DS</given-names></name><name><surname>Kerr</surname> <given-names>JN</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Automated correction of fast motion artifacts for two-photon imaging of awake animals</article-title><source>Journal of Neuroscience Methods</source><volume>176</volume><fpage>1</fpage><lpage>15</lpage><pub-id pub-id-type="doi">10.1016/j.jneumeth.2008.08.020</pub-id><pub-id pub-id-type="pmid">18789968</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Heasman</surname> <given-names>SJ</given-names></name><name><surname>Ridley</surname> <given-names>AJ</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Mammalian Rho GTPases: new insights into their functions from in vivo studies</article-title><source>Nature Reviews Molecular Cell Biology</source><volume>9</volume><fpage>690</fpage><lpage>701</lpage><pub-id pub-id-type="doi">10.1038/nrm2476</pub-id><pub-id pub-id-type="pmid">18719708</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hirata</surname> <given-names>E</given-names></name><name><surname>Girotti</surname> <given-names>MR</given-names></name><name><surname>Viros</surname> <given-names>A</given-names></name><name><surname>Hooper</surname> <given-names>S</given-names></name><name><surname>Spencer-Dene</surname> <given-names>B</given-names></name><name><surname>Matsuda</surname> <given-names>M</given-names></name><name><surname>Larkin</surname> <given-names>J</given-names></name><name><surname>Marais</surname> <given-names>R</given-names></name><name><surname>Sahai</surname> <given-names>E</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Intravital imaging reveals how BRAF inhibition generates drug-tolerant microenvironments with high integrin β1/FAK signaling</article-title><source>Cancer Cell</source><volume>27</volume><fpage>574</fpage><lpage>588</lpage><pub-id pub-id-type="doi">10.1016/j.ccell.2015.03.008</pub-id><pub-id pub-id-type="pmid">25873177</pub-id></element-citation></ref><ref id="bib26"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hiratsuka</surname> <given-names>T</given-names></name><name><surname>Fujita</surname> <given-names>Y</given-names></name><name><surname>Naoki</surname> <given-names>H</given-names></name><name><surname>Aoki</surname> <given-names>K</given-names></name><name><surname>Kamioka</surname> <given-names>Y</given-names></name><name><surname>Matsuda</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Intercellular propagation of extracellular signal-regulated kinase activation revealed by in vivo imaging of mouse skin</article-title><source>eLife</source><volume>4</volume><elocation-id>e05178</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.05178</pub-id><pub-id pub-id-type="pmid">25668746</pub-id></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Itoh</surname> <given-names>RE</given-names></name><name><surname>Kurokawa</surname> <given-names>K</given-names></name><name><surname>Ohba</surname> <given-names>Y</given-names></name><name><surname>Yoshizaki</surname> <given-names>H</given-names></name><name><surname>Mochizuki</surname> <given-names>N</given-names></name><name><surname>Matsuda</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2002">2002</year><article-title>Activation of rac and cdc42 video imaged by fluorescent resonance energy transfer-based single-molecule probes in the membrane of living cells</article-title><source>Molecular and Cellular Biology</source><volume>22</volume><fpage>6582</fpage><lpage>6591</lpage><pub-id pub-id-type="doi">10.1128/MCB.22.18.6582-6591.2002</pub-id><pub-id pub-id-type="pmid">12192056</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Johnsson</surname> <given-names>AE</given-names></name><name><surname>Dai</surname> <given-names>Y</given-names></name><name><surname>Nobis</surname> <given-names>M</given-names></name><name><surname>Baker</surname> <given-names>MJ</given-names></name><name><surname>McGhee</surname> <given-names>EJ</given-names></name><name><surname>Walker</surname> <given-names>S</given-names></name><name><surname>Schwarz</surname> <given-names>JP</given-names></name><name><surname>Kadir</surname> <given-names>S</given-names></name><name><surname>Morton</surname> <given-names>JP</given-names></name><name><surname>Myant</surname> <given-names>KB</given-names></name><name><surname>Huels</surname> <given-names>DJ</given-names></name><name><surname>Segonds-Pichon</surname> <given-names>A</given-names></name><name><surname>Sansom</surname> <given-names>OJ</given-names></name><name><surname>Anderson</surname> <given-names>KI</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name><name><surname>Welch</surname> <given-names>HCE</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>The Rac-FRET mouse reveals tight spatiotemporal control of Rac activity in primary cells and tissues</article-title><source>Cell Reports</source><volume>6</volume><fpage>1153</fpage><lpage>1164</lpage><pub-id pub-id-type="doi">10.1016/j.celrep.2014.02.024</pub-id><pub-id pub-id-type="pmid">24630994</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kaifosh</surname> <given-names>P</given-names></name><name><surname>Zaremba</surname> <given-names>JD</given-names></name><name><surname>Danielson</surname> <given-names>NB</given-names></name><name><surname>Losonczy</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>SIMA: Python software for analysis of dynamic fluorescence imaging data</article-title><source>Frontiers in Neuroinformatics</source><volume>8</volume><elocation-id>80</elocation-id><pub-id pub-id-type="doi">10.3389/fninf.2014.00080</pub-id><pub-id pub-id-type="pmid">25295002</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kastenmüller</surname> <given-names>W</given-names></name><name><surname>Torabi-Parizi</surname> <given-names>P</given-names></name><name><surname>Subramanian</surname> <given-names>N</given-names></name><name><surname>Lämmermann</surname> <given-names>T</given-names></name><name><surname>Germain</surname> <given-names>RN</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>A spatially-organized multicellular innate immune response in lymph nodes limits systemic pathogen spread</article-title><source>Cell</source><volume>150</volume><fpage>1235</fpage><lpage>1248</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2012.07.021</pub-id><pub-id pub-id-type="pmid">22980983</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kennedy</surname> <given-names>GT</given-names></name><name><surname>Manning</surname> <given-names>HB</given-names></name><name><surname>Elson</surname> <given-names>DS</given-names></name><name><surname>Neil</surname> <given-names>MA</given-names></name><name><surname>Stamp</surname> <given-names>GW</given-names></name><name><surname>Viellerobe</surname> <given-names>B</given-names></name><name><surname>Lacombe</surname> <given-names>F</given-names></name><name><surname>Dunsby</surname> <given-names>C</given-names></name><name><surname>French</surname> <given-names>PM</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>A fluorescence lifetime imaging scanning confocal endomicroscope</article-title><source>Journal of Biophotonics</source><volume>3</volume><fpage>103</fpage><lpage>107</lpage><pub-id pub-id-type="doi">10.1002/jbio.200910065</pub-id><pub-id pub-id-type="pmid">19787682</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>King</surname> <given-names>DE</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Dlib-ml: a machine learning toolkit</article-title><source>Journal of Machine Learning Research</source><volume>10</volume><fpage>1755</fpage><lpage>1758</lpage></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kumagai</surname> <given-names>Y</given-names></name><name><surname>Naoki</surname> <given-names>H</given-names></name><name><surname>Nakasyo</surname> <given-names>E</given-names></name><name><surname>Kamioka</surname> <given-names>Y</given-names></name><name><surname>Kiyokawa</surname> <given-names>E</given-names></name><name><surname>Matsuda</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Heterogeneity in ERK activity as visualized by in vivo FRET imaging of mammary tumor cells developed in MMTV-Neu mice</article-title><source>Oncogene</source><volume>34</volume><fpage>1051</fpage><lpage>1057</lpage><pub-id pub-id-type="doi">10.1038/onc.2014.28</pub-id><pub-id pub-id-type="pmid">24632612</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>König</surname> <given-names>K</given-names></name><name><surname>Weinigel</surname> <given-names>M</given-names></name><name><surname>Hoppert</surname> <given-names>D</given-names></name><name><surname>Bückle</surname> <given-names>R</given-names></name><name><surname>Schubert</surname> <given-names>H</given-names></name><name><surname>Köhler</surname> <given-names>MJ</given-names></name><name><surname>Kaatz</surname> <given-names>M</given-names></name><name><surname>Elsner</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Multiphoton tissue imaging using high-NA microendoscopes and flexible scan heads for clinical studies and small animal research</article-title><source>Journal of Biophotonics</source><volume>1</volume><fpage>506</fpage><lpage>513</lpage><pub-id pub-id-type="doi">10.1002/jbio.200810049</pub-id><pub-id pub-id-type="pmid">19343676</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>König</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2012">2012</year><person-group person-group-type="editor"><name><surname>Periasamy</surname> <given-names>A</given-names></name><name><surname>König</surname> <given-names>K</given-names></name><name><surname>So</surname> <given-names>P. T. C</given-names></name></person-group><source>Multiphoton Microscopy in the Biomedical Sciences XII, SPIE Proceedings. Presented at the SPIE BiOS</source><publisher-name>SPIE</publisher-name><fpage>82260H</fpage><pub-id pub-id-type="doi">10.1002/jbio.200710022</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Labouta</surname> <given-names>HI</given-names></name><name><surname>Liu</surname> <given-names>DC</given-names></name><name><surname>Lin</surname> <given-names>LL</given-names></name><name><surname>Butler</surname> <given-names>MK</given-names></name><name><surname>Grice</surname> <given-names>JE</given-names></name><name><surname>Raphael</surname> <given-names>AP</given-names></name><name><surname>Kraus</surname> <given-names>T</given-names></name><name><surname>El-Khordagui</surname> <given-names>LK</given-names></name><name><surname>Soyer</surname> <given-names>HP</given-names></name><name><surname>Roberts</surname> <given-names>MS</given-names></name><name><surname>Schneider</surname> <given-names>M</given-names></name><name><surname>Prow</surname> <given-names>TW</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Gold nanoparticle penetration and reduced metabolism in human skin by toluene</article-title><source>Pharmaceutical Research</source><volume>28</volume><fpage>2931</fpage><lpage>2944</lpage><pub-id pub-id-type="doi">10.1007/s11095-011-0561-z</pub-id><pub-id pub-id-type="pmid">21833791</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lakowicz</surname> <given-names>JR</given-names></name><name><surname>Szmacinski</surname> <given-names>H</given-names></name><name><surname>Nowaczyk</surname> <given-names>K</given-names></name><name><surname>Johnson</surname> <given-names>ML</given-names></name></person-group><year iso-8601-date="1992">1992</year><article-title>Fluorescence lifetime imaging of free and protein-bound NADH</article-title><source>PNAS</source><volume>89</volume><fpage>1271</fpage><lpage>1275</lpage><pub-id pub-id-type="doi">10.1073/pnas.89.4.1271</pub-id><pub-id pub-id-type="pmid">1741380</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Lawson</surname> <given-names>CL</given-names></name><name><surname>Hanson</surname> <given-names>RJ</given-names></name></person-group><year iso-8601-date="1995">1995</year><source>Solving Least Squares Problems</source><publisher-name>Society for Industrial and Applied Mathematics</publisher-name><pub-id pub-id-type="doi">10.1137/1.9781611971217</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Leite-Silva</surname> <given-names>VR</given-names></name><name><surname>Liu</surname> <given-names>DC</given-names></name><name><surname>Sanchez</surname> <given-names>WY</given-names></name><name><surname>Studier</surname> <given-names>H</given-names></name><name><surname>Mohammed</surname> <given-names>YH</given-names></name><name><surname>Holmes</surname> <given-names>A</given-names></name><name><surname>Becker</surname> <given-names>W</given-names></name><name><surname>Grice</surname> <given-names>JE</given-names></name><name><surname>Benson</surname> <given-names>HA</given-names></name><name><surname>Roberts</surname> <given-names>MS</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Effect of flexing and massage on in vivo human skin penetration and toxicity of zinc oxide nanoparticles</article-title><source>Nanomedicine</source><volume>11</volume><fpage>1193</fpage><lpage>1205</lpage><pub-id pub-id-type="doi">10.2217/nnm-2016-0010</pub-id><pub-id pub-id-type="pmid">27102240</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lowe</surname> <given-names>DG</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>Distinctive image features from Scale-Invariant keypoints</article-title><source>International Journal of Computer Vision</source><volume>60</volume><fpage>91</fpage><lpage>110</lpage><pub-id pub-id-type="doi">10.1023/B:VISI.0000029664.99615.94</pub-id></element-citation></ref><ref id="bib41"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Lucas</surname> <given-names>BD</given-names></name><name><surname>Kanade</surname> <given-names>T</given-names></name></person-group><year iso-8601-date="1981">1981</year><chapter-title>An iterative image registration technique with an application to stereo vision</chapter-title><source>Proceedings of the 7th International Joint Conference on Artificial Intelligence. Presented at the IJCAI’81</source><publisher-loc>Vancouver, BC, Canada</publisher-loc><publisher-name>Morgan Kaufmann Publishers Inc</publisher-name><fpage>674</fpage><lpage>679</lpage></element-citation></ref><ref id="bib42"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Martin</surname> <given-names>RS</given-names></name><name><surname>Wilkinson</surname> <given-names>JH</given-names></name></person-group><year iso-8601-date="1965">1965</year><article-title>Symmetric decomposition of positive definite band matrices</article-title><source>Numerische Mathematik</source><volume>7</volume><fpage>355</fpage><lpage>361</lpage><pub-id pub-id-type="doi">10.1007/BF01436248</pub-id></element-citation></ref><ref id="bib43"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mizuno</surname> <given-names>R</given-names></name><name><surname>Kamioka</surname> <given-names>Y</given-names></name><name><surname>Sakai</surname> <given-names>Y</given-names></name><name><surname>Matsuda</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Visualization of signaling molecules during neutrophil recruitment in transgenic mice expressing FRET biosensors</article-title><source>Methods in Molecular Biology</source><volume>1422</volume><fpage>149</fpage><lpage>160</lpage><pub-id pub-id-type="doi">10.1007/978-1-4939-3603-8_14</pub-id><pub-id pub-id-type="pmid">27246030</pub-id></element-citation></ref><ref id="bib44"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Morton</surname> <given-names>JP</given-names></name><name><surname>Karim</surname> <given-names>SA</given-names></name><name><surname>Graham</surname> <given-names>K</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name><name><surname>Jamieson</surname> <given-names>N</given-names></name><name><surname>Athineos</surname> <given-names>D</given-names></name><name><surname>Doyle</surname> <given-names>B</given-names></name><name><surname>McKay</surname> <given-names>C</given-names></name><name><surname>Heung</surname> <given-names>MY</given-names></name><name><surname>Oien</surname> <given-names>KA</given-names></name><name><surname>Frame</surname> <given-names>MC</given-names></name><name><surname>Evans</surname> <given-names>TR</given-names></name><name><surname>Sansom</surname> <given-names>OJ</given-names></name><name><surname>Brunton</surname> <given-names>VG</given-names></name></person-group><year iso-8601-date="2010">2010b</year><article-title>Dasatinib inhibits the development of metastases in a mouse model of pancreatic ductal adenocarcinoma</article-title><source>Gastroenterology</source><volume>139</volume><fpage>292</fpage><lpage>303</lpage><pub-id pub-id-type="doi">10.1053/j.gastro.2010.03.034</pub-id><pub-id pub-id-type="pmid">20303350</pub-id></element-citation></ref><ref id="bib45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Morton</surname> <given-names>JP</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name><name><surname>Karim</surname> <given-names>SA</given-names></name><name><surname>Ridgway</surname> <given-names>RA</given-names></name><name><surname>Athineos</surname> <given-names>D</given-names></name><name><surname>Doyle</surname> <given-names>B</given-names></name><name><surname>Jamieson</surname> <given-names>NB</given-names></name><name><surname>Oien</surname> <given-names>KA</given-names></name><name><surname>Lowy</surname> <given-names>AM</given-names></name><name><surname>Brunton</surname> <given-names>VG</given-names></name><name><surname>Frame</surname> <given-names>MC</given-names></name><name><surname>Evans</surname> <given-names>TR</given-names></name><name><surname>Sansom</surname> <given-names>OJ</given-names></name></person-group><year iso-8601-date="2010">2010a</year><article-title>Mutant p53 drives metastasis and overcomes growth arrest/senescence in pancreatic cancer</article-title><source>PNAS</source><volume>107</volume><fpage>246</fpage><lpage>251</lpage><pub-id pub-id-type="doi">10.1073/pnas.0908428107</pub-id><pub-id pub-id-type="pmid">20018721</pub-id></element-citation></ref><ref id="bib46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Myant</surname> <given-names>KB</given-names></name><name><surname>Cammareri</surname> <given-names>P</given-names></name><name><surname>McGhee</surname> <given-names>EJ</given-names></name><name><surname>Ridgway</surname> <given-names>RA</given-names></name><name><surname>Huels</surname> <given-names>DJ</given-names></name><name><surname>Cordero</surname> <given-names>JB</given-names></name><name><surname>Schwitalla</surname> <given-names>S</given-names></name><name><surname>Kalna</surname> <given-names>G</given-names></name><name><surname>Ogg</surname> <given-names>EL</given-names></name><name><surname>Athineos</surname> <given-names>D</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name><name><surname>Vidal</surname> <given-names>M</given-names></name><name><surname>Murray</surname> <given-names>GI</given-names></name><name><surname>Greten</surname> <given-names>FR</given-names></name><name><surname>Anderson</surname> <given-names>KI</given-names></name><name><surname>Sansom</surname> <given-names>OJ</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>ROS production and NF-κB activation triggered by RAC1 facilitate WNT-driven intestinal stem cell proliferation and colorectal cancer initiation</article-title><source>Cell Stem Cell</source><volume>12</volume><fpage>761</fpage><lpage>773</lpage><pub-id pub-id-type="doi">10.1016/j.stem.2013.04.006</pub-id><pub-id pub-id-type="pmid">23665120</pub-id></element-citation></ref><ref id="bib47"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nobis</surname> <given-names>M</given-names></name><name><surname>Herrmann</surname> <given-names>D</given-names></name><name><surname>Warren</surname> <given-names>SC</given-names></name><name><surname>Kadir</surname> <given-names>S</given-names></name><name><surname>Leung</surname> <given-names>W</given-names></name><name><surname>Killen</surname> <given-names>M</given-names></name><name><surname>Magenau</surname> <given-names>A</given-names></name><name><surname>Stevenson</surname> <given-names>D</given-names></name><name><surname>Lucas</surname> <given-names>MC</given-names></name><name><surname>Reischmann</surname> <given-names>N</given-names></name><name><surname>Vennin</surname> <given-names>C</given-names></name><name><surname>Conway</surname> <given-names>JRW</given-names></name><name><surname>Boulghourjian</surname> <given-names>A</given-names></name><name><surname>Zaratzian</surname> <given-names>A</given-names></name><name><surname>Law</surname> <given-names>AM</given-names></name><name><surname>Gallego-Ortega</surname> <given-names>D</given-names></name><name><surname>Ormandy</surname> <given-names>CJ</given-names></name><name><surname>Walters</surname> <given-names>SN</given-names></name><name><surname>Grey</surname> <given-names>ST</given-names></name><name><surname>Bailey</surname> <given-names>J</given-names></name><name><surname>Chtanova</surname> <given-names>T</given-names></name><name><surname>Quinn</surname> <given-names>JMW</given-names></name><name><surname>Baldock</surname> <given-names>PA</given-names></name><name><surname>Croucher</surname> <given-names>PI</given-names></name><name><surname>Schwarz</surname> <given-names>JP</given-names></name><name><surname>Mrowinska</surname> <given-names>A</given-names></name><name><surname>Zhang</surname> <given-names>L</given-names></name><name><surname>Herzog</surname> <given-names>H</given-names></name><name><surname>Masedunskas</surname> <given-names>A</given-names></name><name><surname>Hardeman</surname> <given-names>EC</given-names></name><name><surname>Gunning</surname> <given-names>PW</given-names></name><name><surname>Del Monte-Nieto</surname> <given-names>G</given-names></name><name><surname>Harvey</surname> <given-names>RP</given-names></name><name><surname>Samuel</surname> <given-names>MS</given-names></name><name><surname>Pajic</surname> <given-names>M</given-names></name><name><surname>McGhee</surname> <given-names>EJ</given-names></name><name><surname>Johnsson</surname> <given-names>AE</given-names></name><name><surname>Sansom</surname> <given-names>OJ</given-names></name><name><surname>Welch</surname> <given-names>HCE</given-names></name><name><surname>Morton</surname> <given-names>JP</given-names></name><name><surname>Strathdee</surname> <given-names>D</given-names></name><name><surname>Anderson</surname> <given-names>KI</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>A RhoA-FRET biosensor mouse for intravital imaging in normal tissue homeostasis and disease contexts</article-title><source>Cell Reports</source><volume>21</volume><fpage>274</fpage><lpage>288</lpage><pub-id pub-id-type="doi">10.1016/j.celrep.2017.09.022</pub-id><pub-id pub-id-type="pmid">28978480</pub-id></element-citation></ref><ref id="bib48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nobis</surname> <given-names>M</given-names></name><name><surname>McGhee</surname> <given-names>EJ</given-names></name><name><surname>Morton</surname> <given-names>JP</given-names></name><name><surname>Schwarz</surname> <given-names>JP</given-names></name><name><surname>Karim</surname> <given-names>SA</given-names></name><name><surname>Quinn</surname> <given-names>J</given-names></name><name><surname>Edward</surname> <given-names>M</given-names></name><name><surname>Campbell</surname> <given-names>AD</given-names></name><name><surname>McGarry</surname> <given-names>LC</given-names></name><name><surname>Evans</surname> <given-names>TR</given-names></name><name><surname>Brunton</surname> <given-names>VG</given-names></name><name><surname>Frame</surname> <given-names>MC</given-names></name><name><surname>Carragher</surname> <given-names>NO</given-names></name><name><surname>Wang</surname> <given-names>Y</given-names></name><name><surname>Sansom</surname> <given-names>OJ</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name><name><surname>Anderson</surname> <given-names>KI</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Intravital FLIM-FRET imaging reveals dasatinib-induced spatial control of src in pancreatic cancer</article-title><source>Cancer Research</source><volume>73</volume><fpage>4674</fpage><lpage>4686</lpage><pub-id pub-id-type="doi">10.1158/0008-5472.CAN-12-4545</pub-id><pub-id pub-id-type="pmid">23749641</pub-id></element-citation></ref><ref id="bib49"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nobis</surname> <given-names>M</given-names></name><name><surname>Warren</surname> <given-names>SC</given-names></name><name><surname>Lucas</surname> <given-names>MC</given-names></name><name><surname>Murphy</surname> <given-names>KJ</given-names></name><name><surname>Herrmann</surname> <given-names>D</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Molecular mobility and activity in an intravital imaging setting - implications for cancer progression and targeting</article-title><source>Journal of Cell Science</source><volume>131</volume><fpage>jcs206995</fpage><pub-id pub-id-type="doi">10.1242/jcs.206995</pub-id><pub-id pub-id-type="pmid">29511095</pub-id></element-citation></ref><ref id="bib50"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nocedal</surname> <given-names>J</given-names></name><name><surname>Wright</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="1999">1999</year><source>Numerical Optimization</source><publisher-loc>New York</publisher-loc><publisher-name>Springer</publisher-name><pub-id pub-id-type="doi">10.1007/978-0-387-40065-5</pub-id></element-citation></ref><ref id="bib51"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Patalay</surname> <given-names>R</given-names></name><name><surname>Talbot</surname> <given-names>C</given-names></name><name><surname>Alexandrov</surname> <given-names>Y</given-names></name><name><surname>Lenz</surname> <given-names>MO</given-names></name><name><surname>Kumar</surname> <given-names>S</given-names></name><name><surname>Warren</surname> <given-names>S</given-names></name><name><surname>Munro</surname> <given-names>I</given-names></name><name><surname>Neil</surname> <given-names>MA</given-names></name><name><surname>König</surname> <given-names>K</given-names></name><name><surname>French</surname> <given-names>PM</given-names></name><name><surname>Chu</surname> <given-names>A</given-names></name><name><surname>Stamp</surname> <given-names>GW</given-names></name><name><surname>Dunsby</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Multiphoton multispectral fluorescence lifetime tomography for the evaluation of basal cell carcinomas</article-title><source>PLoS One</source><volume>7</volume><elocation-id>e43460</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0043460</pub-id><pub-id pub-id-type="pmid">22984428</pub-id></element-citation></ref><ref id="bib52"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Phan</surname> <given-names>TG</given-names></name><name><surname>Amesbury</surname> <given-names>M</given-names></name><name><surname>Gardam</surname> <given-names>S</given-names></name><name><surname>Crosbie</surname> <given-names>J</given-names></name><name><surname>Hasbold</surname> <given-names>J</given-names></name><name><surname>Hodgkin</surname> <given-names>PD</given-names></name><name><surname>Basten</surname> <given-names>A</given-names></name><name><surname>Brink</surname> <given-names>R</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>B cell receptor-independent stimuli trigger immunoglobulin (Ig) class switch recombination and production of IgG autoantibodies by anergic self-reactive B cells</article-title><source>The Journal of Experimental Medicine</source><volume>197</volume><fpage>845</fpage><lpage>860</lpage><pub-id pub-id-type="doi">10.1084/jem.20022144</pub-id><pub-id pub-id-type="pmid">12668643</pub-id></element-citation></ref><ref id="bib53"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rath</surname> <given-names>N</given-names></name><name><surname>Morton</surname> <given-names>JP</given-names></name><name><surname>Julian</surname> <given-names>L</given-names></name><name><surname>Helbig</surname> <given-names>L</given-names></name><name><surname>Kadir</surname> <given-names>S</given-names></name><name><surname>McGhee</surname> <given-names>EJ</given-names></name><name><surname>Anderson</surname> <given-names>KI</given-names></name><name><surname>Kalna</surname> <given-names>G</given-names></name><name><surname>Mullin</surname> <given-names>M</given-names></name><name><surname>Pinho</surname> <given-names>AV</given-names></name><name><surname>Rooman</surname> <given-names>I</given-names></name><name><surname>Samuel</surname> <given-names>MS</given-names></name><name><surname>Olson</surname> <given-names>MF</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>ROCK signaling promotes collagen remodeling to facilitate invasive pancreatic ductal adenocarcinoma tumor cell growth</article-title><source>EMBO Molecular Medicine</source><volume>9</volume><fpage>198</fpage><lpage>218</lpage><pub-id pub-id-type="doi">10.15252/emmm.201606743</pub-id><pub-id pub-id-type="pmid">28031255</pub-id></element-citation></ref><ref id="bib54"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ritsma</surname> <given-names>L</given-names></name><name><surname>Ellenbroek</surname> <given-names>SIJ</given-names></name><name><surname>Zomer</surname> <given-names>A</given-names></name><name><surname>Snippert</surname> <given-names>HJ</given-names></name><name><surname>de Sauvage</surname> <given-names>FJ</given-names></name><name><surname>Simons</surname> <given-names>BD</given-names></name><name><surname>Clevers</surname> <given-names>H</given-names></name><name><surname>van Rheenen</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Intestinal crypt homeostasis revealed at single-stem-cell level by in vivo live imaging</article-title><source>Nature</source><volume>507</volume><fpage>362</fpage><lpage>365</lpage><pub-id pub-id-type="doi">10.1038/nature12972</pub-id><pub-id pub-id-type="pmid">24531760</pub-id></element-citation></ref><ref id="bib55"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ritsma</surname> <given-names>L</given-names></name><name><surname>Steller</surname> <given-names>EJ</given-names></name><name><surname>Beerling</surname> <given-names>E</given-names></name><name><surname>Loomans</surname> <given-names>CJ</given-names></name><name><surname>Zomer</surname> <given-names>A</given-names></name><name><surname>Gerlach</surname> <given-names>C</given-names></name><name><surname>Vrisekoop</surname> <given-names>N</given-names></name><name><surname>Seinstra</surname> <given-names>D</given-names></name><name><surname>van Gurp</surname> <given-names>L</given-names></name><name><surname>Schäfer</surname> <given-names>R</given-names></name><name><surname>Raats</surname> <given-names>DA</given-names></name><name><surname>de Graaff</surname> <given-names>A</given-names></name><name><surname>Schumacher</surname> <given-names>TN</given-names></name><name><surname>de Koning</surname> <given-names>EJ</given-names></name><name><surname>Rinkes</surname> <given-names>IH</given-names></name><name><surname>Kranenburg</surname> <given-names>O</given-names></name><name><surname>van Rheenen</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Intravital microscopy through an abdominal imaging window reveals a pre-micrometastasis stage during liver metastasis</article-title><source>Science Translational Medicine</source><volume>4</volume><elocation-id>ra145</elocation-id><pub-id pub-id-type="doi">10.1126/scitranslmed.3004394</pub-id><pub-id pub-id-type="pmid">23115354</pub-id></element-citation></ref><ref id="bib56"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ritsma</surname> <given-names>L</given-names></name><name><surname>Steller</surname> <given-names>EJ</given-names></name><name><surname>Ellenbroek</surname> <given-names>SI</given-names></name><name><surname>Kranenburg</surname> <given-names>O</given-names></name><name><surname>Borel Rinkes</surname> <given-names>IH</given-names></name><name><surname>van Rheenen</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Surgical implantation of an abdominal imaging window for intravital microscopy</article-title><source>Nature Protocols</source><volume>8</volume><fpage>583</fpage><lpage>594</lpage><pub-id pub-id-type="doi">10.1038/nprot.2013.026</pub-id><pub-id pub-id-type="pmid">23429719</pub-id></element-citation></ref><ref id="bib57"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Roberts</surname> <given-names>MS</given-names></name><name><surname>Dancik</surname> <given-names>Y</given-names></name><name><surname>Prow</surname> <given-names>TW</given-names></name><name><surname>Thorling</surname> <given-names>CA</given-names></name><name><surname>Lin</surname> <given-names>LL</given-names></name><name><surname>Grice</surname> <given-names>JE</given-names></name><name><surname>Robertson</surname> <given-names>TA</given-names></name><name><surname>König</surname> <given-names>K</given-names></name><name><surname>Becker</surname> <given-names>W</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Non-invasive imaging of skin physiology and percutaneous penetration using fluorescence spectral and lifetime imaging with multiphoton and confocal microscopy</article-title><source>European Journal of Pharmaceutics and Biopharmaceutics</source><volume>77</volume><fpage>469</fpage><lpage>488</lpage><pub-id pub-id-type="doi">10.1016/j.ejpb.2010.12.023</pub-id><pub-id pub-id-type="pmid">21256962</pub-id></element-citation></ref><ref id="bib58"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sherlock</surname> <given-names>B</given-names></name><name><surname>Warren</surname> <given-names>S</given-names></name><name><surname>Stone</surname> <given-names>J</given-names></name><name><surname>Neil</surname> <given-names>M</given-names></name><name><surname>Paterson</surname> <given-names>C</given-names></name><name><surname>Knight</surname> <given-names>J</given-names></name><name><surname>French</surname> <given-names>P</given-names></name><name><surname>Dunsby</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Fibre-coupled multiphoton microscope with adaptive motion compensation</article-title><source>Biomedical Optics Express</source><volume>6</volume><fpage>1876</fpage><lpage>1884</lpage><pub-id pub-id-type="doi">10.1364/BOE.6.001876</pub-id><pub-id pub-id-type="pmid">26137387</pub-id></element-citation></ref><ref id="bib59"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sherlock</surname> <given-names>B</given-names></name><name><surname>Warren</surname> <given-names>SC</given-names></name><name><surname>Alexandrov</surname> <given-names>Y</given-names></name><name><surname>Yu</surname> <given-names>F</given-names></name><name><surname>Stone</surname> <given-names>J</given-names></name><name><surname>Knight</surname> <given-names>J</given-names></name><name><surname>Neil</surname> <given-names>MAA</given-names></name><name><surname>Paterson</surname> <given-names>C</given-names></name><name><surname>French</surname> <given-names>PMW</given-names></name><name><surname>Dunsby</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>In vivo multiphoton microscopy using a handheld scanner with lateral and axial motion compensation</article-title><source>Journal of Biophotonics</source><volume>11</volume><elocation-id>e201700131</elocation-id><pub-id pub-id-type="doi">10.1002/jbio.201700131</pub-id></element-citation></ref><ref id="bib60"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sherlock</surname> <given-names>B</given-names></name><name><surname>Yu</surname> <given-names>F</given-names></name><name><surname>Stone</surname> <given-names>J</given-names></name><name><surname>Warren</surname> <given-names>S</given-names></name><name><surname>Paterson</surname> <given-names>C</given-names></name><name><surname>Neil</surname> <given-names>MA</given-names></name><name><surname>French</surname> <given-names>PM</given-names></name><name><surname>Knight</surname> <given-names>J</given-names></name><name><surname>Dunsby</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Tunable fibre-coupled multiphoton microscopy with a negative curvature fibre</article-title><source>Journal of Biophotonics</source><volume>9</volume><fpage>715</fpage><lpage>720</lpage><pub-id pub-id-type="doi">10.1002/jbio.201500290</pub-id><pub-id pub-id-type="pmid">26989868</pub-id></element-citation></ref><ref id="bib61"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Siegel</surname> <given-names>J</given-names></name><name><surname>Elson</surname> <given-names>DS</given-names></name><name><surname>Webb</surname> <given-names>SE</given-names></name><name><surname>Lee</surname> <given-names>KC</given-names></name><name><surname>Vlandas</surname> <given-names>A</given-names></name><name><surname>Gambaruto</surname> <given-names>GL</given-names></name><name><surname>Lévêque-Fort</surname> <given-names>S</given-names></name><name><surname>Lever</surname> <given-names>MJ</given-names></name><name><surname>Tadrous</surname> <given-names>PJ</given-names></name><name><surname>Stamp</surname> <given-names>GW</given-names></name><name><surname>Wallace</surname> <given-names>AL</given-names></name><name><surname>Sandison</surname> <given-names>A</given-names></name><name><surname>Watson</surname> <given-names>TF</given-names></name><name><surname>Alvarez</surname> <given-names>F</given-names></name><name><surname>French</surname> <given-names>PM</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Studying biological tissue with fluorescence lifetime imaging: microscopy, endoscopy, and complex decay profiles</article-title><source>Applied Optics</source><volume>42</volume><elocation-id>2995</elocation-id><pub-id pub-id-type="doi">10.1364/AO.42.002995</pub-id><pub-id pub-id-type="pmid">12790450</pub-id></element-citation></ref><ref id="bib62"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Skala</surname> <given-names>MC</given-names></name><name><surname>Riching</surname> <given-names>KM</given-names></name><name><surname>Gendron-Fitzpatrick</surname> <given-names>A</given-names></name><name><surname>Eickhoff</surname> <given-names>J</given-names></name><name><surname>Eliceiri</surname> <given-names>KW</given-names></name><name><surname>White</surname> <given-names>JG</given-names></name><name><surname>Ramanujam</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>In vivo multiphoton microscopy of NADH and FAD redox states, fluorescence lifetimes, and cellular morphology in precancerous epithelia</article-title><source>PNAS</source><volume>104</volume><fpage>19494</fpage><lpage>19499</lpage><pub-id pub-id-type="doi">10.1073/pnas.0708425104</pub-id><pub-id pub-id-type="pmid">18042710</pub-id></element-citation></ref><ref id="bib63"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Soares</surname> <given-names>KC</given-names></name><name><surname>Foley</surname> <given-names>K</given-names></name><name><surname>Olino</surname> <given-names>K</given-names></name><name><surname>Leubner</surname> <given-names>A</given-names></name><name><surname>Mayo</surname> <given-names>SC</given-names></name><name><surname>Jain</surname> <given-names>A</given-names></name><name><surname>Jaffee</surname> <given-names>E</given-names></name><name><surname>Schulick</surname> <given-names>RD</given-names></name><name><surname>Yoshimura</surname> <given-names>K</given-names></name><name><surname>Edil</surname> <given-names>B</given-names></name><name><surname>Zheng</surname> <given-names>L</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>A preclinical murine model of hepatic metastases</article-title><source>Journal of Visualized Experiments</source><elocation-id>51677</elocation-id><pub-id pub-id-type="doi">10.3791/51677</pub-id><pub-id pub-id-type="pmid">25285458</pub-id></element-citation></ref><ref id="bib64"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Soulet</surname> <given-names>D</given-names></name><name><surname>Paré</surname> <given-names>A</given-names></name><name><surname>Coste</surname> <given-names>J</given-names></name><name><surname>Lacroix</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Automated filtering of intrinsic movement artifacts during two-photon intravital microscopy</article-title><source>PLoS One</source><volume>8</volume><elocation-id>e53942</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0053942</pub-id><pub-id pub-id-type="pmid">23326545</pub-id></element-citation></ref><ref id="bib65"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Steeg</surname> <given-names>PS</given-names></name><name><surname>Camphausen</surname> <given-names>KA</given-names></name><name><surname>Smith</surname> <given-names>QR</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Brain metastases as preventive and therapeutic targets</article-title><source>Nature Reviews Cancer</source><volume>11</volume><fpage>352</fpage><lpage>363</lpage><pub-id pub-id-type="doi">10.1038/nrc3053</pub-id><pub-id pub-id-type="pmid">21472002</pub-id></element-citation></ref><ref id="bib66"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Steeg</surname> <given-names>PS</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Targeting metastasis</article-title><source>Nature Reviews Cancer</source><volume>16</volume><fpage>201</fpage><lpage>218</lpage><pub-id pub-id-type="doi">10.1038/nrc.2016.25</pub-id><pub-id pub-id-type="pmid">27009393</pub-id></element-citation></ref><ref id="bib67"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Suan</surname> <given-names>D</given-names></name><name><surname>Nguyen</surname> <given-names>A</given-names></name><name><surname>Moran</surname> <given-names>I</given-names></name><name><surname>Bourne</surname> <given-names>K</given-names></name><name><surname>Hermes</surname> <given-names>JR</given-names></name><name><surname>Arshi</surname> <given-names>M</given-names></name><name><surname>Hampton</surname> <given-names>HR</given-names></name><name><surname>Tomura</surname> <given-names>M</given-names></name><name><surname>Miwa</surname> <given-names>Y</given-names></name><name><surname>Kelleher</surname> <given-names>AD</given-names></name><name><surname>Kaplan</surname> <given-names>W</given-names></name><name><surname>Deenick</surname> <given-names>EK</given-names></name><name><surname>Tangye</surname> <given-names>SG</given-names></name><name><surname>Brink</surname> <given-names>R</given-names></name><name><surname>Chtanova</surname> <given-names>T</given-names></name><name><surname>Phan</surname> <given-names>TG</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>T follicular helper cells have distinct modes of migration and molecular signatures in naive and memory immune responses</article-title><source>Immunity</source><volume>42</volume><fpage>704</fpage><lpage>718</lpage><pub-id pub-id-type="doi">10.1016/j.immuni.2015.03.002</pub-id><pub-id pub-id-type="pmid">25840682</pub-id></element-citation></ref><ref id="bib68"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sun</surname> <given-names>Y</given-names></name><name><surname>Phipps</surname> <given-names>JE</given-names></name><name><surname>Meier</surname> <given-names>J</given-names></name><name><surname>Hatami</surname> <given-names>N</given-names></name><name><surname>Poirier</surname> <given-names>B</given-names></name><name><surname>Elson</surname> <given-names>DS</given-names></name><name><surname>Farwell</surname> <given-names>DG</given-names></name><name><surname>Marcu</surname> <given-names>L</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Endoscopic fluorescence lifetime imaging for in vivo intraoperative diagnosis of oral carcinoma</article-title><source>Microscopy and Microanalysis</source><volume>19</volume><fpage>791</fpage><lpage>798</lpage><pub-id pub-id-type="doi">10.1017/S1431927613001530</pub-id><pub-id pub-id-type="pmid">23702007</pub-id></element-citation></ref><ref id="bib69"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Thévenaz</surname> <given-names>P</given-names></name><name><surname>Ruttimann</surname> <given-names>UE</given-names></name><name><surname>Unser</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="1998">1998</year><article-title>A pyramid approach to subpixel registration based on intensity</article-title><source>IEEE Transactions on Image Processing</source><volume>7</volume><fpage>27</fpage><lpage>41</lpage><pub-id pub-id-type="doi">10.1109/83.650848</pub-id><pub-id pub-id-type="pmid">18267377</pub-id></element-citation></ref><ref id="bib70"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Vennin</surname> <given-names>C</given-names></name><name><surname>Chin</surname> <given-names>VT</given-names></name><name><surname>Warren</surname> <given-names>SC</given-names></name><name><surname>Lucas</surname> <given-names>MC</given-names></name><name><surname>Herrmann</surname> <given-names>D</given-names></name><name><surname>Magenau</surname> <given-names>A</given-names></name><name><surname>Melenec</surname> <given-names>P</given-names></name><name><surname>Walters</surname> <given-names>SN</given-names></name><name><surname>Del Monte-Nieto</surname> <given-names>G</given-names></name><name><surname>Conway</surname> <given-names>JR</given-names></name><name><surname>Nobis</surname> <given-names>M</given-names></name><name><surname>Allam</surname> <given-names>AH</given-names></name><name><surname>McCloy</surname> <given-names>RA</given-names></name><name><surname>Currey</surname> <given-names>N</given-names></name><name><surname>Pinese</surname> <given-names>M</given-names></name><name><surname>Boulghourjian</surname> <given-names>A</given-names></name><name><surname>Zaratzian</surname> <given-names>A</given-names></name><name><surname>Adam</surname> <given-names>AA</given-names></name><name><surname>Heu</surname> <given-names>C</given-names></name><name><surname>Nagrial</surname> <given-names>AM</given-names></name><name><surname>Chou</surname> <given-names>A</given-names></name><name><surname>Steinmann</surname> <given-names>A</given-names></name><name><surname>Drury</surname> <given-names>A</given-names></name><name><surname>Froio</surname> <given-names>D</given-names></name><name><surname>Giry-Laterriere</surname> <given-names>M</given-names></name><name><surname>Harris</surname> <given-names>NL</given-names></name><name><surname>Phan</surname> <given-names>T</given-names></name><name><surname>Jain</surname> <given-names>R</given-names></name><name><surname>Weninger</surname> <given-names>W</given-names></name><name><surname>McGhee</surname> <given-names>EJ</given-names></name><name><surname>Whan</surname> <given-names>R</given-names></name><name><surname>Johns</surname> <given-names>AL</given-names></name><name><surname>Samra</surname> <given-names>JS</given-names></name><name><surname>Chantrill</surname> <given-names>L</given-names></name><name><surname>Gill</surname> <given-names>AJ</given-names></name><name><surname>Kohonen-Corish</surname> <given-names>M</given-names></name><name><surname>Harvey</surname> <given-names>RP</given-names></name><name><surname>Biankin</surname> <given-names>AV</given-names></name><name><surname>Evans</surname> <given-names>TR</given-names></name><name><surname>Anderson</surname> <given-names>KI</given-names></name><name><surname>Grey</surname> <given-names>ST</given-names></name><name><surname>Ormandy</surname> <given-names>CJ</given-names></name><name><surname>Gallego-Ortega</surname> <given-names>D</given-names></name><name><surname>Wang</surname> <given-names>Y</given-names></name><name><surname>Samuel</surname> <given-names>MS</given-names></name><name><surname>Sansom</surname> <given-names>OJ</given-names></name><name><surname>Burgess</surname> <given-names>A</given-names></name><name><surname>Cox</surname> <given-names>TR</given-names></name><name><surname>Morton</surname> <given-names>JP</given-names></name><name><surname>Pajic</surname> <given-names>M</given-names></name><name><surname>Timpson</surname> <given-names>P</given-names></name><collab>Australian Pancreatic Cancer Genome Initiative (APGI)</collab></person-group><year iso-8601-date="2017">2017</year><article-title>Transient tissue priming via ROCK inhibition uncouples pancreatic cancer progression, sensitivity to chemotherapy, and metastasis</article-title><source>Science Translational Medicine</source><volume>9</volume><elocation-id>eaai8504</elocation-id><pub-id pub-id-type="doi">10.1126/scitranslmed.aai8504</pub-id><pub-id pub-id-type="pmid">28381539</pub-id></element-citation></ref><ref id="bib71"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Vercauteren</surname> <given-names>T</given-names></name><name><surname>Perchant</surname> <given-names>A</given-names></name><name><surname>Malandain</surname> <given-names>G</given-names></name><name><surname>Pennec</surname> <given-names>X</given-names></name><name><surname>Ayache</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>Robust mosaicing with correction of motion distortions and tissue deformations for in vivo fibered microscopy</article-title><source>Medical Image Analysis</source><volume>10</volume><fpage>673</fpage><lpage>692</lpage><pub-id pub-id-type="doi">10.1016/j.media.2006.06.006</pub-id><pub-id pub-id-type="pmid">16887375</pub-id></element-citation></ref><ref id="bib72"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname> <given-names>B</given-names></name><name><surname>Kunze</surname> <given-names>WA</given-names></name><name><surname>Zhu</surname> <given-names>Y</given-names></name><name><surname>Huizinga</surname> <given-names>JD</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>In situ recording from gut pacemaker cells</article-title><source>Pflügers Archiv - European Journal of Physiology</source><volume>457</volume><fpage>243</fpage><lpage>251</lpage><pub-id pub-id-type="doi">10.1007/s00424-008-0513-6</pub-id><pub-id pub-id-type="pmid">18458942</pub-id></element-citation></ref><ref id="bib73"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname> <given-names>M</given-names></name><name><surname>Tang</surname> <given-names>F</given-names></name><name><surname>Pan</surname> <given-names>X</given-names></name><name><surname>Yao</surname> <given-names>L</given-names></name><name><surname>Wang</surname> <given-names>X</given-names></name><name><surname>Jing</surname> <given-names>Y</given-names></name><name><surname>Ma</surname> <given-names>J</given-names></name><name><surname>Wang</surname> <given-names>G</given-names></name><name><surname>Mi</surname> <given-names>L</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Rapid diagnosis and intraoperative margin assessment of human lung cancer with fluorescence lifetime imaging microscopy</article-title><source>BBA Clinical</source><volume>8</volume><fpage>7</fpage><lpage>13</lpage><pub-id pub-id-type="doi">10.1016/j.bbacli.2017.04.002</pub-id><pub-id pub-id-type="pmid">28567338</pub-id></element-citation></ref><ref id="bib74"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wang</surname> <given-names>Y</given-names></name><name><surname>Botvinick</surname> <given-names>EL</given-names></name><name><surname>Zhao</surname> <given-names>Y</given-names></name><name><surname>Berns</surname> <given-names>MW</given-names></name><name><surname>Usami</surname> <given-names>S</given-names></name><name><surname>Tsien</surname> <given-names>RY</given-names></name><name><surname>Chien</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="2005">2005</year><article-title>Visualizing the mechanical activation of Src</article-title><source>Nature</source><volume>434</volume><fpage>1040</fpage><lpage>1045</lpage><pub-id pub-id-type="doi">10.1038/nature03469</pub-id><pub-id pub-id-type="pmid">15846350</pub-id></element-citation></ref><ref id="bib75"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Warren</surname> <given-names>SC</given-names></name><name><surname>Margineanu</surname> <given-names>A</given-names></name><name><surname>Alibhai</surname> <given-names>D</given-names></name><name><surname>Kelly</surname> <given-names>DJ</given-names></name><name><surname>Talbot</surname> <given-names>C</given-names></name><name><surname>Alexandrov</surname> <given-names>Y</given-names></name><name><surname>Munro</surname> <given-names>I</given-names></name><name><surname>Katan</surname> <given-names>M</given-names></name><name><surname>Dunsby</surname> <given-names>C</given-names></name><name><surname>French</surname> <given-names>PM</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Rapid global fitting of large fluorescence lifetime imaging microscopy datasets</article-title><source>PLoS One</source><volume>8</volume><elocation-id>e70687</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0070687</pub-id><pub-id pub-id-type="pmid">23940626</pub-id></element-citation></ref><ref id="bib76"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Warren</surname> <given-names>SC</given-names></name></person-group><year iso-8601-date="2018">2018</year><data-title>Galene</data-title><source>GitHub</source><version designator="7f6f20ac9226ffdce8f579e6b63e50385ec346a0">7f6f20ac9226ffdce8f579e6b63e50385ec346a0</version><ext-link ext-link-type="uri" xlink:href="https://github.com/flimfit/Galene">https://github.com/flimfit/Galene</ext-link></element-citation></ref><ref id="bib77"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>de Santa Barbara</surname> <given-names>P</given-names></name><name><surname>van den Brink</surname> <given-names>GR</given-names></name><name><surname>Roberts</surname> <given-names>DJ</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Development and differentiation of the intestinal epithelium</article-title><source>Cellular and Molecular Life Sciences</source><volume>60</volume><fpage>1322</fpage><lpage>1332</lpage><pub-id pub-id-type="doi">10.1007/s00018-003-2289-3</pub-id><pub-id pub-id-type="pmid">12943221</pub-id></element-citation></ref><ref id="bib78"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wilson</surname> <given-names>MH</given-names></name><name><surname>Coates</surname> <given-names>CJ</given-names></name><name><surname>George</surname> <given-names>AL</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>PiggyBac transposon-mediated gene transfer in human cells</article-title><source>Molecular Therapy</source><volume>15</volume><fpage>139</fpage><lpage>145</lpage><pub-id pub-id-type="doi">10.1038/sj.mt.6300028</pub-id><pub-id pub-id-type="pmid">17164785</pub-id></element-citation></ref><ref id="bib79"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yamauchi</surname> <given-names>F</given-names></name><name><surname>Kamioka</surname> <given-names>Y</given-names></name><name><surname>Yano</surname> <given-names>T</given-names></name><name><surname>Matsuda</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>In vivo FRET imaging of tumor endothelial cells highlights a role of low PKA activity in vascular hyperpermeability</article-title><source>Cancer Research</source><volume>76</volume><fpage>5266</fpage><lpage>5276</lpage><pub-id pub-id-type="doi">10.1158/0008-5472.CAN-15-3534</pub-id><pub-id pub-id-type="pmid">27488524</pub-id></element-citation></ref></ref-list></back><sub-article article-type="decision-letter" id="SA1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.35800.029</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group><contrib contrib-type="editor"><name><surname>Akhmanova</surname><given-names>Anna</given-names></name><role>Reviewing Editor</role><aff id="aff11"><institution>Utrecht University</institution><country>Netherlands</country></aff></contrib></contrib-group></front-stub><body><boxed-text><p>In the interests of transparency, eLife includes the editorial decision letter and accompanying author responses. A lightly edited version of the letter sent to the authors after peer review is shown, indicating the most substantive concerns; minor comments are not usually included.</p></boxed-text><p>Thank you for submitting your article &quot;Galene: Removing physiological motion from intravital and clinical functional imaging data&quot; for consideration by <italic>eLife</italic>. Your article has been reviewed by three peer reviewers, and the evaluation has been overseen by Anna Akhmanova as the Senior/Reviewing Editor. The reviewers have opted to remain anonymous.</p><p>The reviewers have discussed the reviews with one another and the Reviewing Editor has drafted this decision to help you prepare a revised submission.</p><p>Summary:</p><p>Motion artefacts represent recurrent challenges to sample subcellular-resolved image sequences by longitudinal intravital microscopy. Warren and coworkers present a motion correction algorithm which, quantitatively and over time, corrects for motion artefacts of fluorescence intensity features to improve the sampling of fluorescence lifetime analyses. By monitoring fluorescence intensity and established Rac and Src sensors in intestinal cypts, metastatic colorectal cancer cells during hepatic colonization and other models, they show remarkable gain in image quality over time, allowing to reconstruct cell and tissue topology with fine detail. This procedure was benchmarked against existing drift correction tools contained in popular broadly used software packages, including ImageJ (StagReg), Phyton (SIMA) and Imaris, with superior results obtained by their approach. The results for reasonably large scan fields for the chosen application are overall convincing, quantitatively benchmarked by autocorrelation and allow to extract a broad parameter space not readily available using alternative strategies, such as sampling smaller fields of interest, and detect even small changes of fluorescence lifetime.</p><p>Whereas the workflow is strong and the range of applications illustrates well the applicability of the drift correction across different organ types, sensors and quantities / types of drift, there are a number of concerns about the analysis and presentation that need to be addressed before the paper can be published.</p><p>Essential revisions:</p><p>1) The authors justify the requirement of image drift correction for acquiring more precise FLIM based data, and they measure this as the lifetime of fluorophores across what seems to be the entire imaging field. Since the lifetime is acquired by single photon counting, voxel per voxel with microsecond dwell-time, image drifts within the range corrected here should not be expected to alter this parameter significantly. Data supporting the need for image correction to obtain better FLIM measurements, compared to native images and images corrected using other drift corrections, are not provided. The authors should analyze whether the lifetime of the Rac or Src sensor differs between corrected and uncorrected images. Possibly, analyzing the lifetime in image subregions after defining ROIs at cellular and subcellular level will emerge as a selling point for their image correction, to e.g. extract differential responses in tissue niches, but so far no data are included to substantiate this idea.</p><p>2) In addition to single exponential decay analysis used here, the phasor approach is a well-established routine to extract lifetime information from multi-spectral datasets. As a particular strength, phasor analysis allows one to separate photon subsets within the same voxel. In addition, by back-gating, the phasor strategy can identify tissue subregions with defined lifetime properties, and this requires high image stability for identifying time-dependent processes. Thus, including data on superior performance of topographic analysis to improve phasor analysis will likely increase interest in applying this method of image correction. Furthermore, the authors are advised to test more complex double exponential fitting, because the single exponentials do not reflect the likely situation of different proportions of biosensors that do or do not exhibit FRET.</p><p>3) There is no detailed analysis of the effects of the pixel dwell time and frame size on the ability of Galene to work. Some mention of this can be found in the subsection “Algorithm 2. Simulation of TTTR data”, but no rigorous analysis is presented: for example: a smoothing kernel is used, but it is not clear how sensitive the overall method is to this. This would be essential for a technical paper that could then be followed by others in the field, especially as there is even some advice on these matters on the http://galene.readthedocs.io website and in the user manual. For example, it be would important to see analysis using real data (not simulated) of how the ability of Galene to function drops off as the scan rate gets slower. Similarly, real examples should be shown where the scan axis is varied to align with the breathing motion or not on the same sample.</p><p>4) There is ambiguity about the level of advance on the methodology of Lucas-Kanade. It appears that the basis of the algorithms is the same, but that the code is greatly improved and able to run using GPU systems, which makes it much quicker. There is also the highly significant advance that the code can handle the time tagged time resolved TCSPC data. The Galene website shows some of the same data as in the manuscript as a screen shot, but worryingly the 'before' image seems transposed between the website and Figure 4 of the manuscript. This is probably a simple cut and paste error, but should be corrected. A more technical presentation might help to clarify the novelty.</p><p>5) Writing and presentation: The paper is written half as a technical paper and half as a primary research paper with various intriguing highlights of data, such as modulation of Src or Rac activity in vivo. Unfortunately, the technical part lacks the detail that will be key for other users to benefit from Galene and the research part lacks any consistent narrative. We strongly recommend re-focusing on a more technical paper with only one example of data from each type of imaging device.</p><p>Furthermore, the results are presented model by model, however the actual content per image is partly redundant, given that the overall suitability for image stabilization is clear by Figure 4. As consequence, the text is quite long and meandering, moving from model to model. Because these imaging windows have been described elsewhere, the authors might want to consider focusing on conceptual advances, e.g. moving from whole-field analysis to subregion analysis, from single-exponential decay analysis to multispectral analysis (phasor gating), and thereby progress from dataset to dataset. The findings on improving intensity data could be strongly condensed. Consequently, several largely iterative datasets currently presented as main figures might be well-suited for supplementary documentation, including most of Figure 3, Figure 5 and 8 (both lack FLIM data; intensity-based corrections are also shown in Figure 2, 4, 6, 9).</p><p>6) The reported effects of scopolamine are interesting and potentially very important. However, to make strong conclusions, the authors must corroborate them using an orthogonal biochemical method, or the conclusions need to be softened.</p><p>7) It is completely unclear what has been done to derive the diffusion metrics in the Figure 9. Clearly the authors are not measuring diffusion in the normal way, which is usually measured as area/time. This is a further example of the inadequate presentation. Also, E-cadherin diffusion would be in the plane of the membrane, which is perpendicular to the image shown. Transport in and out of the membrane compartment will not be a diffusive process for an integral membrane protein. The authors are advised to remove this part.</p></body></sub-article><sub-article article-type="reply" id="SA2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.35800.030</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><disp-quote content-type="editor-comment"><p>Essential revisions:</p><p>1) The authors justify the requirement of image drift correction for acquiring more precise FLIM based data, and they measure this as the lifetime of fluorophores across what seems to be the entire imaging field. Since the lifetime is acquired by single photon counting, voxel per voxel with microsecond dwell-time, image drifts within the range corrected here should not be expected to alter this parameter significantly. Data supporting the need for image correction to obtain better FLIM measurements, compared to native images and images corrected using other drift corrections, are not provided. The authors should analyze whether the lifetime of the Rac or Src sensor differs between corrected and uncorrected images.</p></disp-quote><p>The reviewers are correct that the arrival time of each photon event is not affected by motion correction. However, motion during image acquisition can effectively convolve pixels together from different regions, for example pixels from the biosensor and tissue autofluorescence. Since the difference in lifetime between the biosensor and autofluorescence is often significantly larger than the expected changes in the biosensor lifetime, this can introduce a significant artefact into the data. To demonstrate this effect quantitatively, we have now compared the Src biosensor lifetime in pre- and post-correction FLIM images (Figure 4G, H). We observe a significant difference in the biosensor lifetime before and after correction and have added the following text:</p><p>“To evaluate the impact of motion correction on our ability to quantify Src activity in dataset, we analysed the lifetime of the uncorrected data in the same way (Figure 5H). […] This increased variability abolishes our ability to statistically distinguish the conditions, highlighting the importance of motion correction to obtain robust results in this context (compare in Figure 5G to H).”</p><disp-quote content-type="editor-comment"><p>Possibly, analyzing the lifetime in image subregions after defining ROIs at cellular and subcellular level will emerge as a selling point for their image correction, to e.g. extract differential responses in tissue niches, but so far no data are included to substantiate this idea.</p></disp-quote><p>We agree with the reviewer; to demonstrate this point, we have performed a subcellular quantification of the Rac1 intestinal crypt data (Figure 4F), adding the following text:</p><p>“Without motion correction, it is extremely difficult to identify subcellular compartments in a majority of the intestinal crypt data. […] We observed a lower level of Rac1 activation the basal membrane compared to the apical membrane after application of PMA or scoloplamine, suggesting a potential negative regulation of Rac1 at the basal membrane.”</p><p>We believe that, together, this analysis provides a compelling argument for the use of motion correction in FLIM data.</p><disp-quote content-type="editor-comment"><p>2) In addition to single exponential decay analysis used here, the phasor approach is a well-established routine to extract lifetime information from multi-spectral datasets. As a particular strength, phasor analysis allows one to separate photon subsets within the same voxel. In addition, by back-gating, the phasor strategy can identify tissue subregions with defined lifetime properties, and this requires high image stability for identifying time-dependent processes. Thus, including data on superior performance of topographic analysis to improve phasor analysis will likely increase interest in applying this method of image correction.</p></disp-quote><p>To highlight the ability to perform phasor analysis on the motion corrected data, we have now demonstrated the use of phasor analysis with both the Rac1 and Src FRET data. Using the Rac1 FRET data, we showed the ability of phasor analysis to distinguish between the biosensor and tissue autofluorescence (new Figure 4C).</p><p>“To quantify the data, we first used phasor analysis (Figure 4C, phasor analysis of image shown in Figure 4B) to separate the biosensor fluorescence (blue gate) from the tissue autofluorescence (red gate).</p><p>For the Src FRET data we now show the ability of phasor analysis to distinguish between the biosensor, vasculature, collagen network and hepatocytes using phasor gating (new Figure 5D) and added the following text:</p><p>“Figure 5Di shows a merged intensity image in the three spectral channels used and Figure 5Dii and iii show the temporal phasor of the 525/50 channel and the spectral phasor respectively. Phasor gates associated with Src-FRET, hepatocytes, the vasculature and collagen were identified as shown and used to identify the associated region in the image (Figure 5Div).”</p><p>In the Discussion, we added:</p><p>“We have demonstrated that it is possible to robustly analyse motion corrected FLIM data using a number of methods which require a high signal noise levels and sample stability. We used reconvolution based fitting to a mono-exponential or complex donor FRET model to extract quantitative parameters about FRET activity, phasor analysis to perform model-free topographic analysis of exogenous and autofluorescent components and hyperspectral analysis to determine the abundance of different autofluorescent signals in the liver.”</p><p>We have added a corresponding section to the Materials and methods.</p><disp-quote content-type="editor-comment"><p>Furthermore, the authors are advised to test more complex double exponential fitting, because the single exponentials do not reflect the likely situation of different proportions of biosensors that do or do not exhibit FRET.</p></disp-quote><p>We agree that the use of a more complex fitting model is valuable. Since the Rac1 biosensor uses ECFP as a donor, which has a complex decay profile even in the absence of FRET, we analysed the intestinal crypt data using a complex-donor FRET model (Warren et al., 2013), instead of a double exponential model, to determine the proportion of biosensors that exhibit FRET (throughout Figure 4). We have added the following text and an appropriate additional section in the Materials and methods.</p><p>“The Rac1 biosensor contains an ECFP donor which has a complex decay profile, dominated by contributions from two conformations with similar spectral profiles. […] By fitting the contributions of each component, we can estimate the fraction of active Rac1 biosensor in each pixel as shown in Figure 4A.”</p><disp-quote content-type="editor-comment"><p>3) There is no detailed analysis of the effects of the pixel dwell time and frame size on the ability of Galene to work. Some mention of this can be found in the subsection “Algorithm 2. Simulation of TTTR data”, but no rigorous analysis is presented: for example: a smoothing kernel is used, but is not clear how sensitive the overall method is to this. This would be essential for a technical paper that could then be followed by others in the field, especially as there is even some advice on these matters on the http://galene.readthedocs.io website and in the user manual. For example, it be would important to see analysis using real data (not simulated) of how the ability of Galene to function drops off as the scan rate gets slower. Similarly, real examples should be shown where the scan axis is varied to align with the breathing motion or not on the same sample.</p></disp-quote><p>We thank the reviewers for this suggestion. We have now added a detailed discussion of the effect of the scan rate (or, equivalently pixel dwell time) and the relative alignment of the scan axis and the sample motion using real data acquired in the pancreas in the new section “Evaluation of the effect of image scan configuration on motion correction performance” and new Figure 3. We have explored the effect of the number of realignment points and the smoothing kernel used in new section “Evaluation of the effect of realignment parameters on motion correction performance” and new Figure 3—figure supplement 1. For brevity, these sections are not quoted here. Additionally, we have clarified the use of the Gaussian smoothing filter in the section “Reconstruction of frames from TTTR data”.</p><p>“To reduce noise, an elliptical Gaussian filter with a user-controllable radius in the fast scan axis and a 1px radius in the slow scan axis is applied. This filter is applied to the reference frame and each frame used for realignment but not to the final, realigned data.”</p><disp-quote content-type="editor-comment"><p>4) There is ambiguity about the level of advance on the methodology of Lucas-Kanade. It appears that the basis of the algorithms is the same, but that the code is greatly improved and able to run using GPU systems, which makes it much quicker. There is also the highly significant advance that the code can handle the time tagged time resolved TCSPC data.</p></disp-quote><p>We apologise for the lack of clarity in presentation here. The reviewer is correct in their assessment. The Lucas-Kanade framework is a more general approach for estimating image warps. We are applying this algorithm to data acquired using a raster pattern. We have now significantly expanded the exposition of the method in the new section “Correction for motion in time-tagged, time-resolved FLIM data” (expanded from a previous discussion in the Introduction, not quoted here for brevity) which makes this clear. We also discuss the novel extensions presented here in the Discussion:</p><p>“Galene uses a fitting approach that explicitly accounting for the raster scan pattern performed by laser scanning microscopes to determine sample motion both between frames and during each frame. […] These modifications reduce the time required to perform motion correction by a factor of 30 for typical volumetric datasets and open the door to online motion correction in the future.”</p><disp-quote content-type="editor-comment"><p>The Galene website shows some of the same data as in the manuscript as a screen shot, but worryingly the 'before' image seems transposed between the website and Figure 4 of the manuscript. This is probably a simple cut and paste error, but should be corrected. A more technical presentation might help to clarify the novelty.</p></disp-quote><p>We apologise for this oversight. In an earlier version of the (non-motion correction) FLIM reconstruction software, we did not correct for the difference in row-major and column-major interpretations of matrix data between C++ and Matlab, leading to a transposition error when loading the FLIM data for analysis. This was corrected; however we had not reflected this change in the figure. We have now corrected the figure.</p><disp-quote content-type="editor-comment"><p>5) Writing and presentation: The paper is written half as a technical paper and half as a primary research paper with various intriguing highlights of data, such as modulation of Src or Rac activity in vivo. Unfortunately, the technical part lacks the detail that will be key for other users to benefit from Galene and the research part lacks any consistent narrative. We strongly recommend re-focusing on a more technical paper with only one example of data from each type of imaging device.</p><p>Furthermore, the results are presented model by model, however the actual content per image is partly redundant, given that the overall suitability for image stabilization is clear by Figure 4. As consequence, the text is quite long and meandering, moving from model to model. Because these imaging windows have been described elsewhere, the authors might want to consider focusing on conceptual advances, e.g. moving from whole-field analysis to subregion analysis, from single-exponential decay analysis to multispectral analysis (phasor gating), and thereby progress from dataset to dataset. The findings on improving intensity data could be strongly condensed. Consequently, several largely iterative datasets currently presented as main figures might be well-suited for supplementary documentation, including most of Figure 3, Figure 5 and 8 (both lack FLIM data; intensity-based corrections are also shown in Figure 2, 4, 6, 9).</p></disp-quote><p>We have now refocussed the manuscript on discussion of the technical aspects of motion correction, using the data where appropriate to illustrate these points. As discussed in the response to points 3 and 4, we have significantly expanded the description of the realignment process and added new technical sections discussing the effect of the scan parameters and realignment options on the correction performance to help the reader make the most effective use of this technology. In response to point 2, we have refocussed the text to further discuss different analysis techniques that may be applied to motion-corrected data.</p><p>Specifically, we have refocussed the intravital Rac1 FRET data so that the pancreas data is used to discuss the effect of scan speed and angle relative to motion and the realignment parameters. We now use the intestinal crypt data as an example of analysis using the complex-donor FRET method and to demonstrate the ability to detect and reject frames where the sample has moved out of frame. We have significantly reworked and simplified the ex-vivo intestinal crypt data. We now simply highlight the difference between pharmacological motion reduction with Scopolamine and the present motion correction approach. Instead, we focus on the ability to perform sub-region analysis using this dataset.</p><p>In line with this, we have removed the previous text and figure relating to motion correction of Rac1-FRET data in the mammary gland and pancreas which was largely iterative. As requested, we then moved the benchmarking (previous Figures 3 and 5) to the supplement. Further, we have significantly reduced the duplication in the figures, for example removing the displacement traces in Figures 4B and 5.</p><p>We have also reduced the background to the Src intrasplenic experiment to the minimum required to understand the experiment and its motivation. We then refocussed this section to demonstrate phasor analysis and backgating and the effect of motion correction on FLIM quantification due to background fluorescence, adding the quantitative comparison with uncorrected FLIM data.</p><p>We have removed the murine liver NADH window data, focussing the NADH autofluorescence data on the ability to correct for motion in 3D in clinical imaging data using either online axial motion correction (Figure 5A) or full 3D motion correction using <italic>Galene</italic> (Figure 5B).</p><p>Finally, we have removed the ICS data as requested, leaving the lymph node as the sole non-FLIM dataset, which highlights the ability to apply raster-pattern aware correction to 3D data. We note that, to our knowledge, this is the first demonstration of this ability even in intensity data. We have condensed the discussion of this data.</p><p>These changes occur systemically throughout the manuscript so are not quoted here.</p><disp-quote content-type="editor-comment"><p>6) The reported effects of scopolamine are interesting and potentially very important. However, to make strong conclusions, the authors must corroborate them using an orthogonal biochemical method, or the conclusions need to be softened.</p></disp-quote><p>We agree with the reviewers, to address this point we have performed immunhistochemical staining against active Rac1-GTP in freshly excised tissue to confirm that Rac1 activity is increased in intestinal crypts following treatment with Scopolamine (new Figure 4—figure supplement 1).</p><disp-quote content-type="editor-comment"><p>7) It is completely unclear what has been done to derive the diffusion metrics in the Figure 9. Clearly the authors are not measuring diffusion in the normal way, which is usually measured as area/time. This is a further example of the inadequate presentation. Also, E-cadherin diffusion would be in the plane of the membrane, which is perpendicular to the image shown. Transport in and out of the membrane compartment will not be a diffusive process for an integral membrane protein. The authors are advised to remove this part.</p></disp-quote><p>We apologise for the unclear presentation and have removed this section.</p></body></sub-article></article>