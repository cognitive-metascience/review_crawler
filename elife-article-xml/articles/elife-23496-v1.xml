<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1d3 20150301//EN"  "JATS-archivearticle1.dtd"><article article-type="research-article" dtd-version="1.1d3" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="hwp">eLife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn pub-type="epub" publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">23496</article-id><article-id pub-id-type="doi">10.7554/eLife.23496</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Research Article</subject></subj-group><subj-group subj-group-type="heading"><subject>Neuroscience</subject></subj-group></article-categories><title-group><article-title>Angular velocity integration in a fly heading circuit</article-title></title-group><contrib-group><contrib contrib-type="author" equal-contrib="yes" id="author-73836"><name><surname>Turner-Evans</surname><given-names>Daniel</given-names></name><contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-8020-0170</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="equal-contrib">†</xref><xref ref-type="other" rid="par-1"/><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" equal-contrib="yes" id="author-75609"><name><surname>Wegener</surname><given-names>Stephanie</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0002-5809-2222</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="equal-contrib">†</xref><xref ref-type="other" rid="par-1"/><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-75610"><name><surname>Rouault</surname><given-names>Hervé</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0002-4997-2711</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="par-1"/><xref ref-type="fn" rid="con3"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-33422"><name><surname>Franconville</surname><given-names>Romain</given-names></name><contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-4440-7297</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="par-1"/><xref ref-type="fn" rid="con4"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-83906"><name><surname>Wolff</surname><given-names>Tanya</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="con5"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-75611"><name><surname>Seelig</surname><given-names>Johannes D</given-names></name><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="par-1"/><xref ref-type="fn" rid="con6"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-28203"><name><surname>Druckmann</surname><given-names>Shaul</given-names></name><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="par-1"/><xref ref-type="fn" rid="con7"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" corresp="yes" id="author-5086"><name><surname>Jayaraman</surname><given-names>Vivek</given-names></name><contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-3680-7378</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="corresp" rid="cor1">*</xref><xref ref-type="other" rid="par-1"/><xref ref-type="fn" rid="con8"/><xref ref-type="fn" rid="conf1"/></contrib><aff id="aff1"><label>1</label><institution>Janelia Research Campus, Howard Hughes Medical Institute</institution>, <addr-line><named-content content-type="city">Ashburn</named-content></addr-line>, <country>United States</country></aff><aff id="aff2"><label>2</label><institution>Center of Advanced European Studies and Research (CAESAR)</institution>, <addr-line><named-content content-type="city">Bonn</named-content></addr-line>, <country>Germany</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Borst</surname><given-names>Alexander</given-names></name><role>Reviewing editor</role><aff><institution>Max Planck Institute of Neurobiology</institution>, <country>Germany</country></aff></contrib></contrib-group><author-notes><corresp id="cor1"><email>vivek@janelia.hhmi.org</email></corresp><fn fn-type="con" id="equal-contrib"><label>†</label><p>These authors contributed equally to this work</p></fn></author-notes><pub-date date-type="pub" publication-format="electronic"><day>22</day><month>05</month><year>2017</year></pub-date><pub-date pub-type="collection"><year>2017</year></pub-date><volume>6</volume><elocation-id>e23496</elocation-id><history><date date-type="received"><day>21</day><month>11</month><year>2016</year></date><date date-type="accepted"><day>11</day><month>04</month><year>2017</year></date></history><permissions><copyright-statement>© 2017, Turner-Evans et al</copyright-statement><copyright-year>2017</copyright-year><copyright-holder>Turner-Evans et al</copyright-holder><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-23496-v1.pdf"/><abstract><object-id pub-id-type="doi">10.7554/eLife.23496.001</object-id><p>Many animals maintain an internal representation of their heading as they move through their surroundings. Such a compass representation was recently discovered in a neural population in the <italic>Drosophila melanogaster</italic> central complex, a brain region implicated in spatial navigation. Here, we use two-photon calcium imaging and electrophysiology in head-fixed walking flies to identify a different neural population that conjunctively encodes heading and angular velocity, and is excited selectively by turns in either the clockwise or counterclockwise direction. We show how these mirror-symmetric turn responses combine with the neurons’ connectivity to the compass neurons to create an elegant mechanism for updating the fly’s heading representation when the animal turns in darkness. This mechanism, which employs recurrent loops with an angular shift, bears a resemblance to those proposed in theoretical models for rodent head direction cells. Our results provide a striking example of structure matching function for a broadly relevant computation.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.001">http://dx.doi.org/10.7554/eLife.23496.001</ext-link></p></abstract><kwd-group kwd-group-type="author-keywords"><title>Author Keywords</title><kwd>navigation</kwd><kwd>internal representation</kwd><kwd>neural circuits</kwd><kwd>modeling</kwd><kwd>two-photon calcium imaging</kwd><kwd>electrophysiology</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research Organism</title><kwd><italic>D. melanogaster</italic></kwd></kwd-group><funding-group><award-group id="par-1"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000011</institution-id><institution>Howard Hughes Medical Institute</institution></institution-wrap></funding-source><principal-award-recipient><name><surname>Turner-Evans</surname><given-names>Daniel</given-names></name><name><surname>Wegener</surname><given-names>Stephanie</given-names></name><name><surname>Rouault</surname><given-names>Hervé</given-names></name><name><surname>Franconville</surname><given-names>Romain</given-names></name><name><surname>Seelig</surname><given-names>Johannes D.</given-names></name><name><surname>Druckmann</surname><given-names>Shaul</given-names></name><name><surname>Jayaraman</surname><given-names>Vivek</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta><meta-name>elife-xml-version</meta-name><meta-value>2.5</meta-value></custom-meta><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>A distinctive recurrent network motif in the <italic>Drosophila</italic> central brain enables neurons that encode angular velocity to shift population activity in compass neurons, thereby updating their heading representation whenever the fly turns.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>When navigating an environment, animals rely on a range of sensory cues from their surroundings to determine their actions. However, even in the absence of such external input, several animals, including insects, can rely on self-motion cues to maintain and update their bearings. In rodents, this ability is thought to rely on head direction cells, which represent the animal’s orientation with respect to a fixed external landmark (<xref ref-type="bibr" rid="bib32">Taube et al., 1990</xref>) and use vestibular signals to maintain their directional tuning in darkness (<xref ref-type="bibr" rid="bib33">Taube, 2007</xref>). A variety of ring attractor models — theorized networks of neurons schematized as being arranged in a ring based on their directional tuning, with connectivity strengths depending on their mutual distances — have been proposed to explain how the brain might maintain and update such an internal compass representation (<xref ref-type="bibr" rid="bib20">Knierim and Zhang, 2012</xref>; <xref ref-type="bibr" rid="bib29">Skaggs et al., 1995</xref>; <xref ref-type="bibr" rid="bib37">Xie et al., 2002</xref>). Neural activity in these structures is localized into a ‘bump’ comprised of co-active neurons with similar heading preferences. This activity bump, which represents the animal’s angular orientation, moves around the ring as the animal changes its heading. While some models have proposed specific network configurations that would enable angular velocity signals to update this compass representation in darkness, for example, (<xref ref-type="bibr" rid="bib29">Skaggs et al., 1995</xref>), experimental support for such mechanisms has been limited.</p><p>In the central brain of <italic>Drosophila melanogaster</italic>, a population of neurons has been found to track a tethered walking fly’s virtual heading in visual surroundings and in darkness (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>). These neurons reside in the central complex, a brain region comprised of several distinct neuropiles, among them the donut-shaped ellipsoid body and the handle-bar-shaped protocerebral bridge (<xref ref-type="fig" rid="fig1">Figure 1A</xref>). We will refer to these ‘compass neurons’ (PB<sub>G1–8</sub>.b-EBw.s-D/Vgall.b [<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>]) as E-PG neurons, to signify their predominantly spiny (and, thus, putatively post-synaptic) projections within the ellipsoid body (‘E-’) and their predominantly bouton-like projections within the protocerebral bridge (‘-P’) and the gall (‘G’) (<xref ref-type="fig" rid="fig1">Figure 1B</xref>). Dendritic calcium activity in the E-PG population localizes into a single bump that moves around the ellipsoid body as the fly turns (<xref ref-type="fig" rid="fig1">Figure 1C–E</xref>), (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>). In this study, we demonstrate how a distinctive recurrent circuit motif enables angular velocity signals carried by a different population of neurons to move the bump of E-PG population activity around the ellipsoid body so that it tracks the fly’s angular orientation in darkness.<fig id="fig1" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.002</object-id><label>Figure 1.</label><caption><title>Anatomy suggests a potential circuit mechanism to update a compass representation.</title><p>(<bold>A</bold>) Schematic of the fly brain. Highlighted in green are the ellipsoid body (EB), protocerebral bridge (PB), and the paired gall and noduli (NO). (<bold>B</bold>) (Left) Schematic of the morphology of two E-PG neurons innervating different sides of the protocerebral bridge. The probable direction of information flow is from their predominantly spiny arbors in the ellipsoid body (‘E-’) to their predominantly bouton-like projections in the protocerebral bridge and gall (‘-PG’). (Right) A single GFP-labeled E-PG neuron. Scale bar: 10 µm. (<bold>C</bold>) Schematic of the head-fixed walking fly preparation used for two-photon calcium imaging and single cell electrophysiology. (<bold>D</bold>) For a given two-photon imaged volume (Left, maximum intensity projection of the ellipsoid body), the population vector average (PVA, brown arrow, Center) for a given time point is computed by summing vectors representing the instantaneous calcium activity of each sector of the ellipsoid body (for example, the dotted red arrows shown here for a few sectors). Each sector is a 22.5<sup>o</sup> slice of the ellipsoid body, defined manually, and each sector’s vector points radially outward along its half angle. PVA strength is the normalized amplitude of the summed vector. (<bold>E</bold>) (Top) E-PG calcium activity (blue) in the ellipsoid body as the fly turns in darkness. The 16 ellipsoid body sectors are shown unwrapped from –π to π. The PVA is shown in brown, PVA strength is at the top. (Bottom) Comparison of the fly’s heading (black) with the PVA shows a tight correlation of the two, albeit with some drift. This example shows a trial in which the PVA closely matches the heading. We also observed larger, low frequency shifts between the two, as reported previously (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>). (<bold>F</bold>) (Left) Schematic of the morphology of two P-EN neurons innervating different sides of the protocerebral bridge. P-EN neurons arborizing in the same protocerebral bridge glomeruli as their E-PG counterparts send processes to offset (neighboring) sectors of the ellipsoid body. Processes in the protocerebral bridge are overwhelmingly spiny and likely dendritic (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>). Processes in the ellipsoid body and noduli are predominantly bouton-like and suggestive of presynaptic specializations. (Right) A single GFP labeled P-EN neuron. Scale bar: 10 µm. (<bold>G</bold>) (Top left) GFP-labeled E-PG neurons in the R60D05 Gal4 line (maximum intensity projection, reproduced with permission from Janelia FlyLight Image Database (<xref ref-type="bibr" rid="bib15">Jenett et al., 2012</xref>). (Top right) GFP-labeled P-EN neurons in the R37F06 Gal4 line (maximum intensity projection reproduced from Janelia FlyLight Image Database [<xref ref-type="bibr" rid="bib15">Jenett et al., 2012</xref>]). (Middle left) Ellipsoid body to protocerebral bridge connectivity map for E-PG neurons. Single neurons that arborize in one wedge of the ellipsoid body arborize in the glomerulus of the same color and shading in the bridge. Arborizations in the gall do not exhibit a stereotyped pattern. (Middle right). Protocerebral bridge to ellipsoid body connectivity map for P-EN neurons. Single neurons that arborize in one glomerulus in the bridge arborize in the ellipsoid body tile with the corresponding color. Arborizations in the noduli do not exhibit stereotyped patterns. (Bottom) Single E-PG and P-EN neurons that arborize in the same protocerebral bridge glomerulus have non-overlapping processes in the ellipsoid body with a stereotyped angular shift between the two. All scale bars are 50 µm. (<bold>H</bold>) Overview of an anatomically motivated mechanism to update a heading representation. E-PG neurons are assumed to make excitatory connections onto P-EN neurons in the protocerebral bridge. P-EN neurons, in turn, are assumed to make excitatory connections onto E-PG neurons in the ellipsoid body. A bump of activity in E-PG neurons (dark blue) represents the fly’s heading in the ellipsoid body. This bump of activity would result in two bumps of E-PG activity in the protocerebral bridge, one on either side. If the two sides of the bridge were to receive asymmetric input dependent on the fly’s angular velocity and turning direction, P-EN neurons with dendrites in the bridge columns that also receive E-PG input would be activated. The anatomical shift between the P-EN and E-PG neurons in the ellipsoid body (compare <bold>B</bold> and <bold>F</bold>) would then cause the P-EN neurons to excite E-PG neurons nearby, shifting the E-PG activity bump and updating the heading representation. Note also that the mirror-symmetric activation of the two sides of the bridge would also be visible in activity differences in the noduli (see <bold>F</bold> and <xref ref-type="fig" rid="fig2">Figure 2A</xref>), each of which only receives P-EN projections from the opposite side of the brain.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.002">http://dx.doi.org/10.7554/eLife.23496.002</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig1-v1"/></fig></p><p>For our investigation of potential inputs that might move the E-PG bump, we focused on a population of neurons called PB<sub>G2–9</sub>.s-EBt.b-NO<sub>1</sub>.b neurons (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>), P-EN neurons for short, to signify their spiny arbors in the protocerebral bridge and their predominantly bouton-like — and therefore likely presynaptic — projections within the ellipsoid body and noduli (see <xref ref-type="fig" rid="fig1">Figure 1F</xref>). The anatomy and polarity of P-EN neurons relative to E-PG neurons suggested a possible mechanism for how these neurons might update the position of an existing E-PG bump in the ellipsoid body: Each E-PG neuron putatively relays information from one of 16 wedge-shaped slices of the ellipsoid body to a single protocerebral bridge slice (<xref ref-type="bibr" rid="bib14">Ito et al., 2014</xref>), also known as a glomerulus (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>) (<xref ref-type="fig" rid="fig1">Figure 1B</xref>). In contrast, the morphology of P-EN neurons suggests that they each have dendrites in one of the bridge glomeruli and send outputs to one of 8 tile-shaped sectors of the ellipsoid body (<xref ref-type="fig" rid="fig1">Figure 1F</xref>). Thus, a single P-EN tile overlaps with two E-PG wedges. However, P-EN neurons and E-PG neurons that arborize in the same bridge glomerulus have shifted processes in the ellipsoid body (compare <xref ref-type="fig" rid="fig1">Figure 1B and F</xref>, <xref ref-type="bibr" rid="bib36">Wolff et al. [2015]</xref>). Putative P-EN axons from the left side of the bridge arborize in tiles that are shifted clockwise with respect to the E-PG wedges while P-EN axons from the right side of the bridge are shifted counterclockwise (<xref ref-type="fig" rid="fig1">Figure 1G</xref>). We hypothesized that this anatomical shift, which bears a remarkable resemblance to network motifs proposed in ring attractor models explaining head direction system function (<xref ref-type="bibr" rid="bib29">Skaggs et al., 1995</xref>; <xref ref-type="bibr" rid="bib37">Xie et al., 2002</xref>; <xref ref-type="bibr" rid="bib40">Zhang, 1996</xref>), could allow the P-EN population to move the E-PG bump in either direction depending on the fly’s turns in the dark. Although the E-PG dendritic activity is localized in a single bump in the ellipsoid body (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>), the projection patterns of the E-PG neurons (<xref ref-type="fig" rid="fig1">Figure 1B</xref>) predict that this bump would manifest as two separate bumps in the protocerebral bridge, one on the right side and one on the left, each in synchrony with the bump in the ellipsoid body. These activity bumps in the bridge could then be passed to P-EN neurons whose dendrites co-localize with E-PG axons (<xref ref-type="fig" rid="fig1">Figure 1H</xref>, top). If P-EN activity on different sides of the protocerebral bridge were asymmetrically modulated by angular velocity input when the fly turned one way or the other, this, in turn, would cause P-EN axonal projections in the ellipsoid body to be asymmetrically activated on one or the other side of the existing E-PG bump (<xref ref-type="fig" rid="fig1">Figure 1H</xref>, middle). If the P-ENs make excitatory connections with the E-PGs, this asymmetric activation would then pull the E-PG bump in one direction or the other. Thus, if the fly turned left (counterclockwise), and P-EN neurons on the left side of the bridge were more strongly excited, their projections in the ellipsoid body would then pull the E-PG bump clockwise, maintaining an appropriate representation of heading (<xref ref-type="fig" rid="fig1">Figure 1H</xref>, bottom, <xref ref-type="other" rid="media1">Video 1</xref>).<media content-type="glencoe play-in-place height-250 width-310" id="media1" mime-subtype="mp4" mimetype="video" xlink:href="elife-23496-media1.mp4"><object-id pub-id-type="doi">10.7554/eLife.23496.003</object-id><label>Video 1.</label><caption><title>Cartoon animation of E-PG and P-EN compass function during a turn.</title><p>Activity of E-PG neurons is shown in red, and that of P-EN neurons in blue. Animation shows the interaction of the two populations during a turn, and highlights how heading-dependent E-PG input combines with turn-direction-dependent angular velocity input to trigger P-EN activity in the appropriate protocerebral bridge glomeruli. This activity, in turn, activates E-PG neurons in ellipsoid body sectors neighboring those that the bump originally inhabited, thereby updating the heading representation.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.003">http://dx.doi.org/10.7554/eLife.23496.003</ext-link></p></caption></media></p><p>This conceptual model rests on three key assumptions. First, that P-EN activity encodes angular velocity, with mirror-symmetric tuning profiles for the left and right subpopulation. Such angular velocity coding has been reported in extracellular recordings of unidentified neurons in the cockroach central complex (<xref ref-type="bibr" rid="bib11">Guo and Ritzmann, 2013</xref>; <xref ref-type="bibr" rid="bib22">Martin et al., 2015</xref>). We tested this assumption by recording the population calcium activity of P-EN neurons in head-fixed flies walking on an air-supported ball (<xref ref-type="bibr" rid="bib26">Seelig et al., 2010</xref>) as well as by recording the electrophysiological activity of individual P-ENs. Second, that activity in P-EN subpopulations on both sides of the protocerebral bridge localizes in a bump that conjunctively encodes both the fly’s rotational velocity and its heading, which we assess through electrophysiological recordings and population calcium imaging. Third, that P-EN and E-PG neurons are functionally connected to one another, which we assessed anatomically, using immunohistochemical staining of presynaptic markers, and functionally, using a combination of optogenetics and two-photon calcium imaging in an ex-vivo preparation. This functional circuit architecture predicts a specific phase relationship between the two neural populations, with, for example, the P-EN population inheriting a bump of activity from the output of the E-PG population in the protocerebral bridge and the P-EN activity bump leading the E-PG bump in the ellipsoid body during turns. To examine this more fine-grained prediction, we recorded the population activity of P-EN and E-PG neurons simultaneously in the walking fly with two-color, two-photon calcium imaging. We found evidence in support of most of these assumptions, which enabled us to formalize our understanding in a firing rate model of this circuit mechanism that included a key additional component — recurrent inhibition. Finally, we validate a core assumption of our model by demonstrating that the population activity of E-PG neurons depends on synaptic input from P-ENs by conditionally blocking P-EN synaptic output using the temperature-sensitive dynamin mutation, shibire<sup>TS</sup> (abbreviated shi<sup>TS</sup>).</p></sec><sec id="s2" sec-type="results"><title>Results</title><sec id="s2-1"><title>Calcium activity of P-EN neurons in the noduli correlates with angular velocity</title><p>To test our first assumption, namely that P-EN neurons mirror-symmetrically encode angular velocity in the right versus left side of the protocerebral bridge, we expressed GCaMP6f in P-EN neurons (under the control of the R37F06-GAL4 driver) and imaged the calcium activity of the left and right P-EN subpopulations in the noduli, a third, paired structure that is innervated by these neurons (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>, <xref ref-type="fig" rid="fig2">Figure 2A</xref>). All P-EN neurons whose dendrites project to glomeruli on the right side of the bridge innervate the left nodulus, whereas those on the left side of the bridge project to the right nodulus. The proximity and compact nature of the noduli enables unambiguous assignment of activity to the left and right P-EN populations with a high signal-to-noise ratio (<xref ref-type="fig" rid="fig2">Figure 2B,C</xref>).<fig id="fig2" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.004</object-id><label>Figure 2.</label><caption><title>Calcium activity of E-PG neurons in the paired noduli correlates with fly’s rotational velocity in darkness.</title><p>(<bold>A</bold>) Schematic showing how a conceptual model (<xref ref-type="fig" rid="fig1">Figure 1H</xref>) to update heading representation would influence calcium activity in the paired noduli. Asymmetric activation of one or the other side of the bridge when the fly turns would, because of P-EN neurons’ projection to the contralateral nodulus, result in activation of the opposite nodulus. (<bold>B</bold>) (Left) Schematic of the P-EN neurons, highlighting the left and right P-EN populations in red and light blue, respectively. Dashed rectangles mark the imaged region shown at right. (Right) Average of sample two-photon calcium imaging stack showing P-EN GCaMP6f signal in the left and right nodulus. ROIs used to calculate ΔF/F values are outlined by dotted ovals. For this and all other imaging experiments, F is defined as the lowest 10% of fluorescence levels during the trial. The scale bar is 20 μm. (<bold>C</bold>) P-EN calcium transients in the right (red) and left (blue) nodulus, and the difference between activity levels in the two noduli (green), compared to the fly’s rotational velocity when walking in darkness (black). The velocity trace is convolved with the GCaMP6f time constant (see Materials and methods). (<bold>D</bold>) Correlation between the convolved rotational velocity and the difference between right and left noduli calcium activity across flies and across trials. Bars show mean values (N = 10 flies). The green point marks the example shown in <bold>C</bold>. (<bold>E</bold>) Linear regression analysis for calcium imaging in the noduli shows coefficients for the correlation of P-EN calcium activity in each nodulus with forward as well as clockwise and counter-clockwise rotational velocity.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.004">http://dx.doi.org/10.7554/eLife.23496.004</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig2-v1"/></fig></p><p>P-EN population calcium activity in the noduli of flies walking in the dark was strongly modulated by the fly’s angular velocity. When the fly turned clockwise, P-EN activity increased in the left nodulus, and vice versa. This led to an apparent flip-flopping of activity between the two noduli as the fly made turns in either direction (<xref ref-type="fig" rid="fig2">Figure 2C</xref>). Thus, the difference between calcium transients evoked in the two noduli was correlated to the fly’s angular velocity (Pearson’s R = 0.65 ± 0.14, mean ± SD, N = 10 flies, p&lt;0.001 in all cases, <xref ref-type="fig" rid="fig2">Figure 2C,D</xref>, see Materials and methods). In fact, noduli calcium responses were dominated by the fly’s angular velocity and largely indifferent to the fly’s forward speed, as revealed by generalized linear regression analysis (<xref ref-type="fig" rid="fig2">Figure 2E</xref>, see Materials and methods). Thus, P-EN population activity is mirror-symmetrically tuned to angular velocity, with neurons innervating the right side of the bridge (and therefore the left nodulus) preferentially responding to clockwise rotation and vice versa, matching the requirements of our conceptual model (<xref ref-type="fig" rid="fig1">Figures 1H</xref> and <xref ref-type="fig" rid="fig2">2A</xref>).</p></sec><sec id="s2-2"><title>Two P-EN subpopulations mirror-symmetrically encode the fly’s rotational velocity</title><p>To understand how individual P-EN neurons respond as the fly turns, we performed somatic loose patch and whole cell patch clamp recordings from identified neurons in tethered walking flies expressing GFP under control of the same GAL4 driver as used for calcium imaging, R37F06 (<xref ref-type="fig" rid="fig3">Figure 3A</xref>). We filled cells with Alexa dyes and confirmed neuron identity and soma location by epifluorescence imaging and/or post-hoc confocal imaging of PFA-fixated brains (<xref ref-type="fig" rid="fig3">Figure 3A</xref>, see Materials and methods). We let head-fixed flies walk in darkness during the recording, or, alternatively, linked the rotational component of their movements on the ball to the angular position of a 15° wide vertical stripe (visual closed loop, see Materials and methods).<fig id="fig3" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.005</object-id><label>Figure 3.</label><caption><title>Individual P-ENs are tuned to the fly’s rotations.</title><p>(<bold>A</bold>) Z-projection of confocal image of a single P-EN neuron filled with Alexa594 (magenta) during intracellular whole-cell patch clamp recording in R37F06-GAL4 flies expressing GFP (green). Scale bar: 20 µm. (<bold>B</bold>) Example recording of a P-EN with soma location and protocerebral bridge innervation in the right hemisphere. The fly was walking in darkness. (<bold>Bi</bold>) Plotted are the fly’s translational velocity (top row, gray) and accumulated rotation (second row, black), along with the cell’s membrane potential (third row, black). Spike times are indicated with dots. Epochs of fast rotations are highlighted in red and blue on the rotation trace (left and right rotations, respectively). Since the change in P-EN activity often outlasted the duration of a turn, the vertical blue and red shaded regions indicate a time window of ~500 ms in which the neuron’s activity reflected these prior fast rotations. (<bold>Bii</bold>) Expanded view, highlighting the P-EN neuron’s hyperpolarization in response to rotations in the contralateral direction (for this neuron, left, red) and depolarization with spiking in response to rotations in the ipsilateral direction (for this neuron, right, blue). (<bold>C</bold>) All of the epochs during which the fly’s angular velocity exceeded 80°/s were temporally aligned and color-coded by turn amplitude (right: red, left: blue). The top panel shows the mean rotation in each direction, the second panel the individual turns. Note that the time point ‘0’ denotes when the angular velocity exceeds 80°/s, which is not the time of turn onset, since rotational velocities vary smoothly and continuously. The neural activity is plotted as a raster plot for individual turns (third panel) and as averaged spike rates (bottom panel).</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.005">http://dx.doi.org/10.7554/eLife.23496.005</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig3-v1"/></fig></p><p>As hinted at by P-EN population imaging in the noduli, the electrical activity of individual P-EN neurons was strongly modulated by rotational velocity. We found that P-ENs segregated into two anatomically defined subpopulations: Neurons with their soma in the right hemisphere increased their activity during turns to the right and decreased it during turns to the left, whereas neurons residing in the left hemisphere showed the inverse activity profile (<xref ref-type="fig" rid="fig3">Figure 3B,C</xref> and <xref ref-type="fig" rid="fig4">Figure 4A,B</xref>). Note that P-EN responses to changes in rotational velocity were similar in darkness and visual closed loop conditions (see <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1A,D,E,H</xref>), which allowed us to pool data for all population statistics presented in <xref ref-type="fig" rid="fig4">Figure 4</xref>. Consistent with our previous observations, P-ENs were generally not tuned to forward velocity (see Materials and methods and also <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1B</xref>). We next quantitatively characterized P-EN responses during the fly’s turns by computing rotational velocity tuning curves. For each cell, we sorted rotational velocities of all walking periods into 12°/s bins and fit the mean P-EN spike rate across bins with a weighted sigmoidal function (<xref ref-type="fig" rid="fig4">Figure 4A</xref>; mean R<sup>2</sup> = 0.87 ± 0.01, N = 12, see also <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1C</xref>; see Materials and methods for details). On average, P-EN spike rates increased by 5.6 Hz during fast turns in the preferred compared to fast turns in the non-preferred direction, but there was considerable heterogeneity across cells (‘rate modulation’: 5.6 ± 3.7 Hz, N = 12; <xref ref-type="fig" rid="fig4">Figure 4B</xref> and <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1D</xref>). Likewise, P-ENs were heterogeneous in the range of rotational velocities over which their activity was modulated (‘P-EN bandwidth’: 145 ± 82°/s, N = 12). Overall, however, P-EN bandwidth corresponded well with the range of rotational velocities displayed by turning flies (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1E</xref>). We also noted that the P-EN bandwidths of the left and right P-EN subpopulations were largely overlapping (<xref ref-type="fig" rid="fig4">Figure 4C</xref>, left), so that the inflexion points of their tuning curves (the rotational velocities for half-maximal P-EN activation) were clustered around 0°/s (<xref ref-type="fig" rid="fig4">Figure 4C</xref>, right). Thus, when the fly is walking, the total activity of the P-EN population is roughly constant, with the contributions of the left and right P-EN subpopulations depending on the fly’s momentary rotational velocity (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1F</xref>).<fig-group><fig id="fig4" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.006</object-id><label>Figure 4.</label><caption><title>Two P-EN subpopulations mirror-symmetrically encode the fly’s rotational velocity.</title><p>(<bold>A</bold>) Example tuning curves of P-EN spike rate to the fly’s rotations as the fly walks in darkness. Angular velocities were binned in 12°/s bins and a sigmoid was fitted with bin counts used as weights (see Materials and methods for details). Mean spike rate and 95% confidence interval in black, sigmoidal fits in blue and red. (<bold>Ai</bold>) Tuning curve for a right P-EN neuron (same as in <xref ref-type="fig" rid="fig3">Figure 3</xref>). P-EN membrane potential changes were similar to the observed changes in spike rates (see <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1C</xref> for V<sub>m</sub> tuning curve). (<bold>Aii</bold>) Tuning curve for a left P-EN neuron (see <xref ref-type="fig" rid="fig4s2">Figure 4—figure supplement 2A</xref> for example trace). (<bold>B</bold>) Fitted spike rates for the flies’ turns to the left versus right illustrate mirror-symmetric tuning properties of the left and right P-EN subpopulations. Spike rates were computed either at saturation or at an absolute rotational velocity of 200°/s, whichever was lower. Example cells from panel <bold>A</bold> are color coded. (<bold>C</bold>) Encoding of rotations by the two subpopulations is mirror-symmetric yet overlapping, that is, each P-EN subpopulation encodes rotations in both directions. Left: Normalized tuning curve fits for all P-EN neurons. Left hemisphere P-EN curves have been reflected for simplicity. Neurons plotted in <bold>A</bold> are color coded for comparison. Open circles mark each sigmoid’s half-maximum (inflexion point). Right: On average, the P-EN neurons’ receptive field for rotations is centered around 0°/s, where P-EN’s are half-maximally activated. Closed and open circles in the right subplot represent inflexion points of right and left P-EN tuning curves, respectively. Example cells from panel <bold>A</bold> are in blue and red. (<bold>D</bold>) Spike-triggered averages of angular velocities were constructed to characterize P-EN timing. Since P-EN neurons tend to spike at rest, all spikes with rotational velocities not exceeding 40°/s at any time in a one second window around the spike were excluded. Left: Membrane potential is plotted at top, angular velocity at bottom. Inset shows a magnification of the average spike shape. Right: The peak of the angular velocity precedes the spike in all P-ENs recorded. Example cells from panel <bold>A</bold> are in blue and red.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.006">http://dx.doi.org/10.7554/eLife.23496.006</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig4-v1"/></fig><fig id="fig4s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.007</object-id><label>Figure 4—figure supplement 1.</label><caption><title>Extended data on P-EN rotational velocity tuning.</title><p>(<bold>A</bold>) Tuning curves for recordings in both experimental conditions (‘dark’ and ‘visual closed loop’) were well fit by a sigmoidal function. P value refers to unpaired t-test across conditions. Cells in the lower spectrum of R<sup>2</sup> values (&lt;0.8) showed a higher variance around the mean, but no systematic deviation from the sigmoidal shape of the tuning curve. (<bold>B</bold>) Heat map of spike rate as a function of forward and angular velocity for the neuron plotted in <xref ref-type="fig" rid="fig3">Figure 3B</xref>. (<bold>C</bold>) Angular velocity tuning curve of the P-EN neuron plotted in <xref ref-type="fig" rid="fig4">Figure 4Ai</xref>, but relating membrane potential, rather than spike rate, to angular velocity. Mean membrane potential and 95% confidence intervals in black, sigmoidal fit in blue. (<bold>D</bold>) Each P-EN’s rate modulation was quantified as the absolute difference of fitted spike rates at saturation or at an absolute rotational velocity of 200°/s, whichever was lower (see inset in panel <bold>C</bold>). P-EN modulation appeared stronger in flies walking in darkness than in those with visual closed loop. P value refers to unpaired t-test across conditions. (<bold>E</bold>) Comparison of the fly’s dynamic range of rotations (‘behavioral bandwidth’) to the P-EN’s dynamic range for angular velocity encoding (‘P-EN coding bandwidth’, see inset in Panel <bold>C</bold>) for the two experimental conditions. Behavioral bandwidth was defined, for each fly, as the range between the 10<sup>th</sup> and 90<sup>th</sup> percentile of its rotational velocity distribution (in 50 ms bins, excluding velocities between −5 and 5°/s). P-value refers to a two-way ANOVA result across conditions (p-value for comparison of behavior to neural response: p=0.82). (<bold>F</bold>) Simulation of P-EN population activity based on electrophysiological recordings of 12 P-EN neurons. Spike rates of individual P-EN neurons were normalized to their respective mean spike rate across all bins. P-EN neurons from the left hemisphere were flipped so that population activity of ‘right P-ENs’ (blue) represents the mean of all cells. The tuning profile of ‘left P-ENs’ (red) was assumed to be the same, except mirror-symmetric around the y-axis (<xref ref-type="fig" rid="fig4">Figure 4C</xref>). The population activity (the sum of left and right P-EN neurons, green) was calculated as the linear sum of all 24 simulated P-EN neurons. (<bold>G</bold>) Generalized linear regression analysis of P-EN instantaneous spike rate relative to the fly’s turns, shown for the experiment plotted in <xref ref-type="fig" rid="fig3">Figure 3</xref>. The autocorrelation of the rotational velocity is plotted in black, the correlation coefficients for right and left turns with the neuron’s spike rate are plotted in blue and red, respectively. In brief, P-EN spike rates were regressed with rotations to the left and right as predictors, yielding a single pair of coefficients. A series of temporal shifts was introduced between rotations and spike train, giving rise to the temporal sequence plotted along the x-axis. The temporal shift that produced the maximum difference in left minus right turn coefficients was defined as the neurons response lag. This lag was positive for all P-EN neurons (that is, the neural response followed the change in rotational velocity). See Materials and methods for details. (<bold>H</bold>) P-EN response lag grouped by recording conditions. ‘STA’ refers to timing information extracted from spike triggered averages (see <xref ref-type="fig" rid="fig4">Figure 4D</xref>). ‘Regression’ refers to timing information obtained through fitting a generalized linear regression to the P-EN spike rate (see panel F and Materials and methods for details). P-value refers to a two-way ANOVA result across conditions (p-value for comparison of STA to regression: p=0.57). Timing information extracted from linear regression analysis of the membrane potential was similar to that extracted from generalized linear regression of spike rates (response lag V<sub>m</sub>: 125 ± 21 ms, spike rates: 138 ± 83 ms, N = 8 for both groups, paired t-test: p=0.69).</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.007">http://dx.doi.org/10.7554/eLife.23496.007</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig4-figsupp1-v1"/></fig><fig id="fig4s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.008</object-id><label>Figure 4—figure supplement 2.</label><caption><title>Loose patch recordings.</title><p>(<bold>A</bold>) Example loose patch recording of a P-EN neuron located in the left hemisphere. (<bold>Ai</bold>) Plotted are the translational velocity (top row, gray), the accumulated rotation (second row, black) and the band-pass filtered extracellularly recorded potential changes (third row, black; see Materials and methods). Epochs of fast turning are highlighted in red and blue for left and right turns, respectively. Spike times are indicated with dots following the same color code. (<bold>Aii</bold>) Expanded view highlighting the spike shape of three events (left) in comparison to the average of all spikes recorded in this trial (right). Y-axis scale bar is the same for both panels. (<bold>B</bold>) Average spike shape across all events recorded in four consecutive epochs of five minute length. The traces in panel <bold>A</bold> are taken from the last epoch and illustrate the minimum quality criterion for inclusion of a recording in the final data set. In most recordings, spike amplitude decreased over time, and spike shape, particularly the post-spike hyperpolarization component, became less distinctive. Usually, but not always, this was accompanied by a slow increase in spike frequency. Experiments were terminated (and/or late trials excluded post-hoc) if the spike frequency increased notably, be it due to decreased signal-to-noise ratio and increased uncertainty in spike detection or, in rare cases, a partial break-in into the cell. (<bold>C</bold>) Threshold-based spike detection for trials included in the final dataset is robust, i.e. the number of detected spikes is largely constant in a ± 20% window around the chosen threshold.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.008">http://dx.doi.org/10.7554/eLife.23496.008</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig4-figsupp2-v1"/></fig></fig-group></p><p>To examine whether increases in P-EN activity preceded upcoming turns, we computed spike-triggered averages (STAs) of instantaneous rotational velocity during periods of significant turning (with instantaneous rotational velocities greater than 40°/s, see Materials and methods). Across all P-ENs, we found that spikes occurred well after the peak of the rotational velocity, on average by 123 ± 43 ms (N = 12) (<xref ref-type="fig" rid="fig4">Figure 4D</xref>). In an alternative approach, we used generalized linear regression to fit the instantaneous P-EN spike rate with the past, present, or future rotational velocities by introducing a series of lags between the two parameters (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1G</xref>, see Materials and methods). In all P-ENs, the maximum difference between left and right turn correlation coefficients occurred at positive temporal lags (130 ± 73 ms, N = 12), confirming that P-EN spiking activity changed as a response to turns instead of preceding them (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1H</xref>). Overall, individual P-ENs encode the fly’s recent rotational velocity, with left and right P-ENs segregating into two subpopulations with mirror-symmetric tuning profiles.</p></sec><sec id="s2-3"><title>Single-cell correlates of heading tuning in P-ENs</title><p>Since our conceptual model relies on the P-ENs to also be tuned to the fly’s heading (<xref ref-type="fig" rid="fig1">Figure 1H</xref>), we next asked if the patch-clamp recordings would reveal such properties. To avoid complications caused by error accumulation in flies walking in the dark (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>), which would result in a drift of the neuron’s preferred heading angle over time, we first restricted this analysis to experiments with closed loop visual feedback (see Materials and methods). We constructed two-dimensional tuning maps of P-EN spike rates to rotational velocity and virtual heading, which revealed localized peaks in firing rate (<xref ref-type="fig" rid="fig5">Figure 5A</xref>). We collapsed these maps along either of the two axes to fit the P-EN’s tuning to the fly’s virtual heading with a compound von Mises function and its tuning to rotational velocity with a sigmoidal function, as before (<xref ref-type="fig" rid="fig5">Figure 5A</xref>, see Materials and methods). For each cell, we also calculated indices for rotation and heading tuning (<xref ref-type="fig" rid="fig5">Figure 5B</xref>, see Materials and methods), which were, in all but one case (p=0.0676), larger than the 95<sup>th</sup> percentile of the shuffled control distribution.<fig-group><fig id="fig5" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.009</object-id><label>Figure 5.</label><caption><title>P-ENs are conjunctively tuned to angular velocity and heading.</title><p>(<bold>A</bold>) Two-dimensional tuning properties of a P-EN’s spike output averaged over the entire duration of the experiment. The cell was located in the left hemisphere (schematic at top). The fly walked with closed loop visual feedback. The heat map (upper left) shows spike rates as a function of angular velocity and virtual heading. A tuning curve was fitted to the fly’s virtual heading angle (upper right) as well as the fly’s angular velocity (lower left) (see Materials and methods). Black: mean rate and 95% confidence intervals. Tuning curves are least squares fit to the sum of two von Mises functions for heading (green) and to a sigmoidal function for rotations (red). (<bold>B</bold>) Quantification of the heading tuning index (mean vector length of spike rates across virtual heading angles) and the rotation tuning index (R<sup>2</sup> values for sigmoidal tuning curve fit) for the two example cells plotted in <bold>A</bold> and <bold>C</bold> (bold red open circle and blue open circle, respectively). Shuffled controls (see Materials and methods) are plotted as dots and dotted lines mark 95<sup>th</sup> percentile boundaries (plotted in red and blue for the two example cells). Histograms of shuffled data indices are plotted at top and at right following the same color code. Tuning indices for all cells are shown in <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1C</xref>. (<bold>C</bold>) Two-dimensional tuning properties of a P-EN’s spike output during a brief epoch that still sufficiently sampled the two-dimensional parameter space. The cell was located in the right hemisphere (schematic at top). The fly walked with a closed loop visual feedback. The heat map (upper left) shows spike rates as a function of angular velocity and virtual heading. Colorbar at right. Tuning curves to the fly’s virtual heading angle and angular velocity are plotted analogous to <bold>A</bold>. (<bold>D</bold>) Example traces for the epoch plotted in <bold>C</bold> illustrating tuning to rotational velocity as well as virtual heading. The two parameters are color coded according to the neural activity expected from the tuning curves plotted in panel <bold>C</bold>.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.009">http://dx.doi.org/10.7554/eLife.23496.009</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig5-v1"/></fig><fig id="fig5s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.010</object-id><label>Figure 5—figure supplement 1.</label><caption><title>Extended data on P-EN conjunctive tuning.</title><p>(<bold>A</bold>) Tuning properties are consistent over time. Heat map showing spike rate as a function of angular velocity and virtual heading angle for the neuron shown in <xref ref-type="fig" rid="fig5">Figure 5A</xref>, plotted separately for the first (left) and second half of the experiment (right). (<bold>B</bold>) Grayscale map of sample sizes in individual angular velocity ∪ heading angle bins, expressed in seconds of experimental data, plotted with a logarithmic scale color code. To minimize biases in the sampling of particular angular velocity ∪ heading angle combinations, only data within a well-sampled rectangle were included in the analysis of conjunctive tuning properties (indicated by the red box). For the cell plotted here (the same one as plotted above and in <xref ref-type="fig" rid="fig5">Figure 5A</xref>), angular velocities &lt;-200°/s and &gt;225°/s were excluded from the analysis. (<bold>C</bold>) Quantification of the heading tuning index (mean vector length of spike rates across virtual heading angles) and the rotation tuning index (R<sup>2</sup> values for sigmoidal tuning curve fit) for all data used to analyze P-EN conjunctive tuning properties. Bold open circles represent closed loop experiment averages, thin open circles in matching colors mark short epochs analyzed from those experiments. Filled circles represent short epochs analyzed from flies walking in darkness. Shuffled controls are omitted for clarity. Color code for individual experiments is matched to <xref ref-type="fig" rid="fig6">Figure 6</xref>. (<bold>D</bold>) Schematic illustrating how preferred and non-preferred heading quadrants were derived from heading tuning curves.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.010">http://dx.doi.org/10.7554/eLife.23496.010</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig5-figsupp1-v1"/></fig></fig-group></p><p>P-EN heading tuning was generally stable over time, although we occasionally observed drifts in the neuron’s preferred heading angle (<xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1A</xref>). We assessed tuning stability more quantitatively by analyzing short epochs (5–10 min) that sampled a sufficient range of rotational velocities (≥250°/s) across all virtual heading angles (see Materials and methods). We identified seven such epochs in six different cells recorded in flies walking with closed loop visual feedback as well as in darkness (see <xref ref-type="fig" rid="fig5">Figure 5C,D</xref> for an example and <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1C</xref> for tuning indices, which were, for all but one epoch, larger than the 95<sup>th</sup> percentile of the shuffled control distributions). For all epochs recorded in flies walking with visual feedback, we found that the P-ENs’ preferred heading angles during the epochs differed by only 6 ± 5% from the average of the entire experiment (population mean, N = 4). As a second line of evidence, we found the P-EN bump width to be roughly similar for short epochs and across whole experiments, suggesting that a neuron’s preferred heading angle did not drift much over time (average tuning curve width at half-maximal P-EN heading modulation: 56 ± 20<underline>°</underline> (N = 7 epochs) versus 76 ± 35° [N = 5 experiment averages]). Overall, we found P-EN neurons to be tuned to the fly’s heading as well as the fly’s rotations, both when flies walked under visual closed loop conditions and in darkness (<xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1C</xref>).</p></sec><sec id="s2-4"><title>Conjunctive tuning to heading and rotation is sharpened within individual P-ENs</title><p>Having established that P-EN neurons are conjunctively tuned to the fly’s heading and rotations, we examined our recordings for hints of integrative computations within individual neurons. Specifically, we began by asking whether P-EN activity was tuned to one of the two parameters even in the absence of contribution from the other. <xref ref-type="fig" rid="fig6">Figure 6A–B</xref> depicts an example of strong P-EN tuning to rotational velocity as well as to virtual heading for a fly walking in darkness. To quantitatively assess whether tuning to one parameter depended on the other, we computed the rotation and heading tuning indices separately for the respective preferred and non-preferred conditions, i.e. one rotation index each for the fly’s turns within the preferred versus non-preferred heading quadrant and one heading index each for when the fly rotated in its preferred versus non-preferred turn direction. These tuning indices were not significantly different (<xref ref-type="fig" rid="fig6">Figure 6C</xref>, left). Along the same lines, the preferred heading angle of individual P-ENs (the mean vector angle of spike rates across headings) was similar for preferred and non-preferred rotations (<xref ref-type="fig" rid="fig6">Figure 6C</xref>, bottom right). Following the same logic, we also fit conditional tuning curves to subsets of the parameter space (see Materials and methods for details). As evident from the example (<xref ref-type="fig" rid="fig6">Figure 6D</xref>) and the population data (<xref ref-type="fig" rid="fig6">Figure 6E</xref>), strong conjunctive tuning was apparent in the pronounced differences in rate modulation between preferred and non-preferred conditions. Nevertheless, we found P-EN spiking to be tuned to rotational velocity in non-preferred heading quadrants and to heading during non-preferred rotations (<xref ref-type="fig" rid="fig6">Figure 6E</xref> left; rotation tuning at non-preferred heading angles: 2.3 ± 2.1 Hz, heading tuning during non-preferred rotations: 1.2 ± 1.1 Hz; one sample t-test: p=0.026 and p=0.043, respectively; N = 6 for both comparisons). The pronounced conjunctive tuning we observed at the level of spike rates was less apparent in the subthreshold activity of P-EN neurons (<xref ref-type="fig" rid="fig6s1">Figure 6—figure supplement 1</xref>). In contrast to the spike rates, for which rate modulation in response to one parameter strongly depended on the other, quantitative modulation of the membrane potential did not show significant mutual dependence between the two parameters (<xref ref-type="fig" rid="fig6s1">Figure 6—figure supplement 1C</xref>, see Materials and methods for details). These observations suggest not only that tuning of P-EN output is strongly conjunctive, but also that this property may be sharpened within single P-ENs.<fig-group><fig id="fig6" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.011</object-id><label>Figure 6.</label><caption><title>Tuning of P-EN spiking activity is evident even for non-preferred heading and rotational velocities.</title><p>(<bold>A</bold>) Heat map shows conjunctive tuning of a P-EN’s spike output to angular velocity and virtual heading. The fly walked in darkness. (The recording is the same as shown in <xref ref-type="fig" rid="fig4">Figure 4Aii</xref> and <xref ref-type="fig" rid="fig4s2">Figure 4—figure supplement 2</xref>). (<bold>B</bold>) Example traces from that recording illustrating conjunctive tuning to rotational velocity and virtual heading. The fly’s rotational velocity is color-coded by preferred (left, blue) and non-preferred (right, red) turn direction. The fly’s heading is color coded according to the neural activity expected from the heading tuning curve computed from A (see Materials and methods, light green: low, black: high). (<bold>C</bold>) P-EN spike output is tuned to rotations irrespective of the fly’s heading (top, R<sup>2</sup> value of sigmoidal tuning curve fit) and informative about the fly’s heading irrespective of rotations, as evident both from the heading tuning index (bottom left, mean vector length of spike rates across virtual heading angles) and the relative stability of the preferred heading angle (mean vector angle). P-values are results of paired two-sample t-tests. (<bold>D</bold>) Conditional tuning curves for the cell plotted in <bold>A</bold>. Schematics illustrate the subset of data used to construct the tuning curves. Mean and 95% confidence intervals are plotted in black, fits for preferred conditions in solid and for non-preferred conditions in dotted lines. Top: Tuning to angular velocity given heading (left: rotations in non-preferred heading quadrant, right: rotations in preferred heading quadrant). Bottom: Tuning to heading given turn direction (left: non-preferred turn direction, right: preferred turn direction). (<bold>E</bold>) Strong P-EN conjunctive tuning is apparent from the increased rate modulation for tuning to one parameter in the preferred range of the other. Top: Difference in fitted spike rates at −150 and 150°/s for each condition (two sample t-test: p=0.049, N = 6). Bottom: Difference in fitted spike rates at the heading angles corresponding to the peak and the trough of the unconditional heading tuning curve (two sample t-test: p=0.042, N = 6). Tuning to rotations in non-preferred heading quadrants (top left) and tuning to heading during non-preferred rotations (bottom left) is, however, significantly different from zero (one sample t-test: p=0.026 and p=0.043, respectively). Filled circles are recordings in darkness; open circles, in visual closed loop. Color code is the same as used in <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1C</xref>. p&lt;0.05.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.011">http://dx.doi.org/10.7554/eLife.23496.011</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig6-v1"/></fig><fig id="fig6s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.012</object-id><label>Figure 6—figure supplement 1.</label><caption><title>P-EN spiking activity shows stronger conjunctive tuning than membrane potential.</title><p>(<bold>A</bold>) Heat maps show tuning of a P-EN neuron’s spike rate (left) and membrane potential (right) to angular velocity and virtual heading. Left panel replotted from <xref ref-type="fig" rid="fig5">Figure 5C</xref>. (<bold>B</bold>) Conditional tuning curves for the recording plotted in <bold>A</bold>. Top: Tuning to angular velocity given heading. Bottom: Tuning to heading given turn direction. Tuning to one parameter in the second parameter’s preferred and non-preferred range is plotted in green and gray, respectively. Tuning curves within one subpanel show more pronounced differences on the level of spike rates (left) than subthreshold changes in membrane potential (right). Individual data points show mean and 95% confidence intervals. (<bold>C</bold>) Rate modulation (maximum minus minimum spike rate along the fitted curve) for all whole-cell recordings (N = 6) shows strong conjunctive tuning at the level of spike rates (left). Conjunctive tuning is much less pronounced at the level of the cell’s membrane potential (right). In a two-way ANOVA, quantitative modulation of membrane potential tuning was indistinguishable for preferred versus non-preferred conditions (p=0.454) whereas quantitative modulation of spike rates was significantly different (p=0.009). Closed circles represent recordings in darkness, open circles recordings in visual closed loop. The color code for individual neurons is the same as in <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1D</xref>.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.012">http://dx.doi.org/10.7554/eLife.23496.012</ext-link></p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-23496-fig6-figsupp1-v1"/></fig></fig-group></p></sec><sec id="s2-5"><title>A recurrent loop between P-ENs and E-PGs</title><p>We next sought to test the third pillar of our conceptual model, that the E-PG and P-EN neurons are connected in an excitatory loop. Light level analysis of P-EN neuron morphology suggests that they likely have post-synaptic specializations in the bridge and pre-synaptic boutons in the ellipsoid body, while E-PG morphology indicates the opposite polarity (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>), making it possible for the two cell types to be mutually connected. We sought histochemical confirmation of this polarity by expressing the presynaptic reporter synaptotagmin-smGFP-HA (<xref ref-type="bibr" rid="bib1">Aso et al., 2014</xref>) in GAL4 lines that drive expression in P-EN and E-PG neurons, respectively. Light level analysis of brains in which HA-tagged synaptotagmin was expressed in P-EN neurons revealed stronger labeling in the ellipsoid body and noduli than in the bridge (<xref ref-type="fig" rid="fig7">Figure 7A</xref>, 11/14 brains). In contrast, analysis of the E-PG targeted brains revealed high levels of HA-tagged synaptotagmin in the protocerebral bridge, but also in the ellipsoid body (at higher levels than in the ellipsoid body in 5/15 brains, at comparable levels in both neuropils in 10/15 brains, see <xref ref-type="fig" rid="fig7">Figure 7B</xref>). These results are consistent with the anatomical finding that the P-EN neurons receive input in the bridge and send output to the ellipsoid body.<fig id="fig7" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.013</object-id><label>Figure 7.</label><caption><title>Functional connectivity of E-PG and P-EN neurons.</title><p>(<bold>A</bold>) P-EN neuron membranes and presynaptic sites are labeled by expressing myr-sm::GFP and synaptotagmin in VT008135-GAL4, a second genetic line that drives expression in the P-EN neurons. While additional central complex and central brain cell types are targeted in this line, only the P-EN neuron arborizes in the protocerebral bridge (see Materials and methods). Expression is evident in the protocerebral bridge, the ellipsoid body and the paired noduli (behind the ellipsoid body, labelled by arrowhead). Intensity of presynaptic labeling was strongest in the ellipsoid body. The scale bar is 20 μm and applies to A and B. Though the image stack was rotated in three dimensions to obtain the included view, the scale bar was obtained from a single plane of the imaging stack. (<bold>B</bold>) Analogous to <bold>A</bold>, but using R60D05-GAL4 to drive expression in the E-PG neurons. Although presynaptic labeling was most intense in the protocerebral bridge and gall, synaptotagmin was also detected in the ellipsoid body, suggesting E-PG presynaptic sites in that neuropil as well. (<bold>C</bold>) Functional connectivity experiment with CsChrimson-mCherry expressed in P-EN, and GCaMP6m in E-PG neurons. (<bold>Ci</bold>) (Left) Average projection of fluorescence from a dissected brain. Both E-PG and P-EN arborizations can be seen in the ellipsoid body. E-PGs furthermore project to the gall (box, left) and P-ENs to the noduli (paired structure at bottom). (Right) Average frame from imaging the E-PGs in the gall while activating the P-ENs. (<bold>Cii</bold>) Average response (in black) from six flies to a train of 2 ms, 590 nm light pulses delivered at 30 Hz and 50 μW/mm<sup>2</sup>. Stimulation time indicated by gray area. Gray traces correspond to the average of 4 trials for individual flies. (<bold>D</bold>) Functional connectivity experiment with CsChrimson-mCherry expressed in E-PG and GCaMP6f in P-EN neurons. (<bold>Di</bold>) (Left) Average projection of fluorescence from a dissected brain. (Right) Average frame from imaging the P-ENs in the protocerebral bridge while activating the E-PGs. (<bold>Dii</bold>) Analogous to <bold>Cii</bold>, except that stimulation light intensity was increased to 500 μW/mm<sup>2</sup>. (inset) Comparison of low stimulation intensity responses (50 μW/mm<sup>2</sup>, dotted line) and the high stimulation responses shown in the plot below (solid line). These responses were acquired in different regions (low stimulation: noduli, high stimulation: protocerebral bridge), but results were consistent across neuropiles. The scale bars are scaled versions of those shown in <bold>Cii</bold>. All scale bars in <bold>Ci</bold>, <bold>Di</bold>: 10 µm.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.013">http://dx.doi.org/10.7554/eLife.23496.013</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig7-v1"/></fig></p><p>To confirm these key connections, we then performed functional connectivity experiments between the two neuronal subtypes in ex vivo preparations. We expressed the red-shifted channelrhodopsin CsChrimson (<xref ref-type="bibr" rid="bib19">Klapoetke et al., 2014</xref>) in either the E-PG or the P-EN populations while expressing GCaMP6m or GCaMP6f in the putative downstream partner cell type. Optogenetic activation of P-EN neurons reliably evoked positive calcium transients in E-PG neurons (<xref ref-type="fig" rid="fig7">Figure 7C</xref>, see Materials and methods), suggesting that angular velocity information is indeed relayed to E-PGs via this pathway. However, activation of the E-PG population induced more variable responses in P-ENs. Although we observed responses consistent with excitatory connections when we used strong light intensities for optogenetic activation (<xref ref-type="fig" rid="fig7">Figure 7D</xref>), the same pairing evoked activation, inhibition, and a lack of response at different times with weaker light intensities (dotted line in <xref ref-type="fig" rid="fig7">Figure 7D</xref>, inset). Thus, the excitatory loop between E-PG and P-EN neurons may be both direct and indirect, and the connection from the E-PG neurons onto the P-EN neurons likely also recruits inhibition. Overall, we hypothesize that other neurons in the ellipsoid body and protocerebral bridge (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>) likely influence the exchange of information between these two neuron types.</p></sec><sec id="s2-6"><title>P-EN calcium activity in the protocerebral bridge follows E-PG activity</title><p>Consistent with our conceptual model (<xref ref-type="fig" rid="fig1">Figure 1H</xref>), our electrophysiological results showed that individual P-EN neurons are tuned to heading and rotational velocity. Further, our functional connectivity results are supportive of a recurrent loop between the P-EN and E-PG populations, albeit perhaps with greater complexity than proposed by our simple conceptual model. This loop would, in the model, imply that the P-EN population inherits a bump of activity from the output of the E-PG population in the bridge, and that P-EN activity leads the E-PG bump in the ellipsoid body. To understand the spatiotemporal relationship between the two populations, we performed two-color calcium imaging (<xref ref-type="bibr" rid="bib7">Dana et al., 2016</xref>) in flies walking in darkness. We expressed GCaMP6f in one population and jRGECO1a, a red indicator, in the other (<xref ref-type="fig" rid="fig8">Figure 8A</xref>). We tested for bleed-through and cross talk between the two channels (<xref ref-type="bibr" rid="bib31">Sun et al., 2017</xref>), and verified clean color channel separation (see <xref ref-type="fig" rid="fig8s1">Figure 8—figure supplement 1</xref> and Materials and methods for details; <xref ref-type="bibr" rid="bib31">Sun et al., 2017</xref>). We also checked that our results were qualitatively consistent across the calcium indicator combinations we used and pooled the data for both color combinations in the results presented below, color-coding data according to the calcium indicator with which they were obtained in <xref ref-type="fig" rid="fig8">Figure 8</xref>.<fig-group><fig id="fig8" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.014</object-id><label>Figure 8.</label><caption><title>In the protocerebral bridge, P-EN calcium activity overlaps E-PG calcium activity with an offset.</title><p>(<bold>A</bold>) Overview of a typical protocerebral bridge imaging experiment. jRGECO1a (shown in magenta), a red calcium indicator, is expressed in the E-PG neurons. GCaMP6f (shown in green), a green calcium indicator, is expressed in the P-EN neurons. Both populations are imaged simultaneously. (<bold>B</bold>) Maximum intensity projections of fluorescence from simultaneous imaging of E-PG and P-EN neural populations. Time points are 0.4 s apart. Scale bar: 50 μm. (<bold>C</bold>) ROI definition and ΔF/F projections for E-PG neurons (magenta) and P-EN neurons (green). The three time points shown in <bold>B</bold> are displayed at the bottom. The dotted line divides the right and the left half of the protocerebral bridge. Arrows indicate the direction of bump movement. (<bold>D</bold>) Protocerebral bridge activity over time for one trial for the E-PG and P-EN neurons. The fly’s rotational velocity during the trial is shown in the black trace at top. The right and left side activity is concatenated. (<bold>E</bold>) Fluorescence transients binned by angular velocity and aligned to the peak of E-PG (magenta) activity in the right protocerebral bridge for five trials for one fly. The bar projections show the mean values while the cross-sectional plots show the mean and standard deviation. Colored vertical arrows show the PVA values of the traces. (<bold>F</bold>) Bump half widths (full width at half maximum, or FWHM) for P-EN neurons and E-PG neurons across flies and across velocity bins. The center velocity of each bin is shown, and the bin width is 30°/s. Points for individual flies are connected with colored lines indicating the calcium indicator tag. Normalized P-EN (E–PG) widths, obtained by dividing each width by the bump width for the given fly at 0–30°/s, were flat across velocities, with slopes of −0.71 ± 2.2×10<sup>−3</sup> (0.98 ± 0.68×10<sup>−3</sup>) s/° for the green indicator and 0.36 ± 0.68×10<sup>−3</sup> (0.55 ± 1.1×10<sup>−3</sup>) s/° for the red indicator. (<bold>G</bold>) Difference in the population vector average (PVA) for the mean E-PG and P-EN calcium activity in the side of the protocerebral bridge ipsilateral and contralateral to a turn, plotted across flies and across angular velocity bins (N = 5 flies with the P-EN neurons tagged with GCaMP6f and E-PG neurons tagged with jRGECO1a, and N = 6 flies with the opposite calcium indicator combination). Each point represents the mean across trials for one fly and bars show the mean across flies. Individual dots are shaded to match P-EN PVA strength. At 120–150°/s, the offset is 0.96 ± 0.40 glomeruli for the ipsilateral side and 1.0 ± 0.56 glomeruli for the contralateral side. If the offset is instead calculated by finding the average PVA offsets of all of the individual traces (instead of the one PVA offset of the average trace), those values become 0.97 ± 0.43 and 0.46 ± 1.0 for the ipsilateral and contralateral sides, respectively. If the peaks are used instead of the PVA, the offsets at 120–150°/s are found to be 0.59 ± 1.2 and 0.36 ± 1.3 for the mean traces and 0.95 ± 0.42 and 0.41 ± 0.91 for the mean of the peak differences of the individual traces.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.014">http://dx.doi.org/10.7554/eLife.23496.014</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig8-v1"/></fig><fig id="fig8s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.015</object-id><label>Figure 8—figure supplement 1.</label><caption><title>The red and green channels are well separated.</title><p>(<bold>A</bold>) Mean of the maximum intensity projection of an ellipsoid body volume, and mean of the bottom plane for one trial. The P-EN and E-PG populations are noticeably distinct, showing that bleed-through is limited. (<bold>B</bold>) (Top) If ROIs are drawn around each of the noduli, the mean signal in the green channel within each is strongly modulated by the fly’s turns, without noticeable signals in the red channel. (Bottom) When, instead, a triangular ROI is drawn around an area with a high baseline red fluorescence, but no apparent green signal, the red signal varies noticeably across the trial while the green signal does not. This further shows that the GCaMP6f signal is not bleeding through to the red PMT. (<bold>C</bold>) The rotational velocity of the fly over the course of the trial shown in A and B.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.015">http://dx.doi.org/10.7554/eLife.23496.015</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig8-figsupp1-v1"/></fig><fig id="fig8s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.016</object-id><label>Figure 8—figure supplement 2.</label><caption><title>Additional quantification of protocerebral bridge activity.</title><p>(<bold>A</bold>) Amplitude differences between P-EN and E-PG fluorescence transients evoked by counterclockwise and clockwise turns for different angular velocities. Points are connected by colored lines representing the indicator used in a particular fly (magenta: jRGECO1a; green: GCaMP6f). For ipsilateral turns across flies, the normalized P-EN (E–PG) peaks increased at a rate of 2.2 ± 0.96×10<sup>−3</sup> (0.69 ± 0.31×10<sup>−3</sup>) s/<sup>o</sup> for the green indicator and a rate of 1.2 ± 0.29×10<sup>−3</sup> (0.48 ± 0.28×10<sup>−3</sup>) s/<sup>o</sup> for the red indicator. (<bold>B</bold>) PVA offset between the P-EN and E-PG activity as binned by turn velocity, for both ipsilateral and contralateral turns for a second fly line, VT008135, that also labels the P-EN neurons. The dots are shaded by the mean P-EG PVA strength for the given bin.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.016">http://dx.doi.org/10.7554/eLife.23496.016</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig8-figsupp2-v1"/></fig></fig-group></p><p>Imaging in the protocerebral bridge revealed two bumps of activity in the E-PG and P-EN neurons, one on each side of the bridge (<xref ref-type="fig" rid="fig8">Figure 8B</xref>), as predicted by our working model. To analyze the imaging stacks, we subdivided each half of the protocerebral bridge into nine regions of interest, one for each glomerulus (<xref ref-type="fig" rid="fig8">Figure 8C</xref>) and compared the activity in those regions over time to the rotational velocity for single trials (<xref ref-type="fig" rid="fig8">Figure 8D</xref>) and across trials (<xref ref-type="fig" rid="fig8">Figure 8E</xref>). For both neuron types, the bump intensities, but not widths, increased with increasing angular velocity across trials (<xref ref-type="fig" rid="fig8">Figure 8E,F</xref>). Although the P-EN bump intensity increased for both turn directions, which was unexpected, the increase was larger for ipsilateral turns than for contralateral turns (<xref ref-type="fig" rid="fig8s2">Figure 8—figure supplement 2A</xref>, top), a mirror-symmetry consistent with imaging results in the noduli (<xref ref-type="fig" rid="fig2">Figure 2</xref>) and with single cell electrophysiology (<xref ref-type="fig" rid="fig4">Figure 4B</xref>). The bump half-widths spanned ~2 glomeruli, which, if projected to the ellipsoid body, would lead to an activity width of 90 degrees. Consistent with our model, in which E-PG neurons carry the heading representation to the protocerebral bridge (<xref ref-type="fig" rid="fig1">Figure 1H</xref>), and in contrast with the activity of the P-EN subpopulations, there was no difference between E-PG activity for ipsilateral versus contralateral turns at any turn velocity (<xref ref-type="fig" rid="fig8s2">Figure 8—figure supplement 2A</xref>, bottom).</p><p>To determine the spatiotemporal relationship of the E-PG and P-EN bumps, we carefully examined their relative positions over time and across rotational velocities. To facilitate this comparison, we simultaneously registered both populations with respect to the E-PG bump in the right half of the bridge. We then binned these registered traces by rotational velocity. Across velocities, the registered E-PG and P-EN activity bumps overlapped, but with the P-EN bumps slightly lagging the E-PG bumps (<xref ref-type="fig" rid="fig8">Figure 8E,G</xref>, see Materials and methods for further details on the registration and binning procedures). The lag led to bump offsets of approximately one glomerulus (the equivalent of 45 degrees in the ellipsoid body) at 120–150°/s, the fastest rotational velocity bin considered (and the bin with the greatest offset), whether measured by the population vector average or by peak difference (<xref ref-type="fig" rid="fig8">Figure 8G</xref>). This offset was also consistent across different fly lines (<xref ref-type="fig" rid="fig8s2">Figure 8—figure supplement 2B</xref>). While the substantial overlap between the two bumps suggests that the heading representation in the two populations is, in fact, roughly coincident, the observation that P-EN activity follows E-PG activity by one glomerulus on both sides of the bridge was not predicted by our simple model. This lag may be due to the subtleties of connectivity between the E-PG neurons and P-EN neurons (as hinted at, for example, by E-PG presynaptic specializations in the ellipsoid body <xref ref-type="fig" rid="fig7">[Figure 7B</xref>] and by the complex responses seen in our functional connectivity experiments [<xref ref-type="fig" rid="fig7">Figure 7D</xref>, inset]) or, simply, due to delays caused by neural time constants (see model below).</p></sec><sec id="s2-7"><title>P-EN calcium activity in the ellipsoid body leads E-PG activity</title><p>Next, we sought to investigate the relationship of the P-EN and E-PG population activity in the ellipsoid body, where, the conceptual model would suggest (<xref ref-type="fig" rid="fig1">Figure 1H</xref>), P-EN activity should lead E-PG activity. To do so, we once again performed two-color imaging of the two populations (<xref ref-type="fig" rid="fig9">Figure 9A</xref>). As in the protocerebral bridge, we observed bumps of activity in both neural populations (<xref ref-type="fig" rid="fig9">Figure 9B</xref>). We then subdivided the activity into 16 regions of interest, corresponding to the number of distinct E-PG arborization sectors in the ellipsoid body (<xref ref-type="fig" rid="fig9">Figure 9B</xref>, bottom; [<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>]) and compared the activity in those regions over time (<xref ref-type="fig" rid="fig9">Figure 9C</xref>). Bump amplitudes, but not half-widths, varied with angular velocity (<xref ref-type="fig" rid="fig9">Figure 9D,E</xref>), and both bumps were ~100° wide (full width at half maximum, <xref ref-type="fig" rid="fig9">Figure 9E</xref>).<fig-group><fig id="fig9" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.017</object-id><label>Figure 9.</label><caption><title>P-EN activity leads E-PG activity in the ellipsoid body.</title><p>(<bold>A</bold>) Overview of a typical two-color calcium imaging experiment targeting the ellipsoid body. jRGECO1a is expressed in E-PG neurons (shown in magenta), and GCaMP6f is expressed in the P-EN neurons (shown in green). (<bold>B</bold>) Maximum intensity projections of fluorescence from simultaneous imaging of the E-PG and P-EN neural populations. Time points are 0.4 s apart. The bottom images show the regions of interest (solid white lines) and a scale bar of 20 μm. (<bold>C</bold>) Fluorescence transients and PVA for the three successive time points shown in <bold>B</bold>, labeled with the corresponding rotational velocities. The direction of bump movement is shown in the inner black arrows. The colored arrows represent the direction but not the magnitude of the PVA. (<bold>D</bold>) P-EN and E-PG bump amplitude as a function of rotational velocity. The center of each rotational velocity bin is shown. Bin width is 30°/s. Each point represents the mean across trials for one fly and bars show the mean across flies. The values for each fly are normalized to the intensity in the 0–30°/s bin. Statistics for flies with the two populations labeled with the opposite colored indicators are shown in <xref ref-type="fig" rid="fig9s2">Figure 9—figure supplement 2</xref>. Normalized P-EN (E-PG) peaks increased at a rate of 7.4 ± 2.3×10<sup>−3</sup> (3.1 ± 1.6×10<sup>−3</sup>) s/° for the green indicator and a rate of 2.7 ± 1.23×10<sup>−3</sup> (3.0 ± 2.2×10<sup>−3</sup>) s/° for the red indicator. (<bold>E</bold>) P-EN and E-PG bump half widths (FWHM). Each point represents the mean across trials for one fly and bars show the mean across flies. Statistics for flies with the two populations labeled with the opposite colored indicators are shown in <xref ref-type="fig" rid="fig9s2">Figure 9—figure supplement 2</xref>. Normalized P-EN (E–PG) widths, obtained by dividing each width by the bump width for the given fly at 0–30°/s, were flat across velocity bins, with slopes of −0.20 ± 0.57×10<sup>−3</sup> (−0.36 ± 1.3×10<sup>−3</sup>) s/<sup>o</sup> for the green indicator and 0.92 ± 0.81×10<sup>−3</sup> (0.48 ± 1.1×10<sup>−3</sup>) s/<sup>o</sup> for the red indicator. (<bold>F</bold>) Mean fluorescence transients binned by rotational velocity and aligned to the peak of E-PG activity at 12 o’clock across five trials for the fly shown in <bold>A–C</bold>. (<bold>G</bold>) Difference in PVA for mean P-EN and E-PG fluorescence transients across flies and rotational velocity bins. Each point represents the mean across trials for one fly and bars show the mean across flies. (N = 10 flies) The P-EN and E-PG PVA strengths are shown at the top. The offset increase across bins is significant (one-way ANOVA across angular velocities, p=1.3×10<sup>−7</sup>). The PVA offset at 150–180°/s is 20.7 ± 11.7°. If the PVA offset is instead calculated for each individual pair of traces, the offset is 14.6 ± 20.9° The peak offset of the mean traces is 24.8 ± 22.4° and the mean offset of the peak differences of the individual traces is 25.8 ± 9.8°.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.017">http://dx.doi.org/10.7554/eLife.23496.017</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig9-v1"/></fig><fig id="fig9s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.018</object-id><label>Figure 9—figure supplement 1.</label><caption><title>Cross sections of binned and aligned E-PG and P-EN activity.</title><p>Cross-sectional plots of binned and aligned ellipsoid body activity. Standard deviations are shown in lighter colors. P-EN activity is in green and E-PG activity is in magenta. Colored arrows show the PVA values in the cross sections.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.018">http://dx.doi.org/10.7554/eLife.23496.018</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig9-figsupp1-v1"/></fig><fig id="fig9s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.019</object-id><label>Figure 9—figure supplement 2.</label><caption><title>Statistics of P-EN and E-PG activity in the ellipsoid body for flies with the opposite calcium indicator combination.</title><p>Comparison of ellipsoid body statistics between N = 10 flies with jRGECO1a expressed in the E-PG neurons and GCaMP6f expressed in the P-EN neurons and N = 5 flies with the flipped indicator combination. Plots A-D are shown and described in <xref ref-type="fig" rid="fig9">Figure 9</xref>, and repeated here for easy comparison. (<bold>A</bold>) Overview of color indicator expression. jRGECO1a is expressed in E-PG neurons (shown in magenta), and GCaMP6f is expressed in the P-EN neurons (shown in green). (<bold>B</bold>) The intensity increase, normalized for the 0–30°/s condition for the P-EN and E-PG neurons as a function of rotational velocity. (<bold>C</bold>) The full width at half maximum (FWHM) width of the P-EN and E-PG bumps as a function of rotational velocity bin. (<bold>D</bold>) The PVA offset between the P-EN and E-PG activity as binned by turn velocity. (<bold>E</bold>) As in A. jRGECO1a is now expressed in the P-EN neurons while GCaMP6f is expressed in the E-PG neurons. (<bold>F</bold>) As in B. with the colored indicators now reversed. (<bold>G</bold>) As in C. with the colored indicators now reversed. (<bold>H</bold>) As in C. with the colored indicators now reversed. The change in PVA difference, though still positive, is not significant across bins (one-way ANOVA of PVA difference across angular velocities, p=0.26).</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.019">http://dx.doi.org/10.7554/eLife.23496.019</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig9-figsupp2-v1"/></fig></fig-group></p><p>To compare E-PG and P-EN bump positions in the ellipsoid body across time, we performed a registration and binning procedure similar to the one used in the protocerebral bridge (see Materials and methods). Here, we used the E-PG bump in the ellipsoid body to align averaged calcium transients binned by the fly’s angular velocity (<xref ref-type="fig" rid="fig9">Figure 9F</xref>, standard deviations shown in <xref ref-type="fig" rid="fig9s1">Figure 9—figure supplement 1</xref>). As the fly turned, the relative position of the E-PG and P-EN bumps around the ellipsoid body changed. At angular velocities less than 30°/s, all flies showed bump offsets of less than 6° (2.5 ± 2.1°, N = 10 flies, <xref ref-type="fig" rid="fig9">Figure 9F,G</xref>). However, at rotational velocities above 30°/s, P-EN population activity separated from E-PG activity, with the P-EN bump leading the E-PG bump around the ellipse (<xref ref-type="fig" rid="fig9">Figure 9G</xref>, <xref ref-type="other" rid="media2">Video 2</xref>). When the red indicator was expressed in the E-PG neurons and the green indicator in the P-EN neurons, the bump offset exceeded 15 degrees of separation for turns faster than 90°/s regardless of turn direction and regardless of whether the fly was angularly accelerating or decelerating (20.7 ± 11.7° at 150–180°/s). When, instead, the red indicator was expressed in the P-ENs, the lead-lag behavior was qualitatively similar, though the shift only rose to 7.3 ± 7.2°/s at 150–180°/s (<xref ref-type="fig" rid="fig9s2">Figure 9—figure supplement 2</xref>). As jRGECO1a's kinetics are different from those of GCaMP6f, a difference in the observed shift across color combinations is to be expected (<xref ref-type="bibr" rid="bib7">Dana et al., 2016</xref>). Thus, we concluded that the P-EN bump leads the E-PG bump in the ellipsoid body during turns, consistent with the conceptual model.<media content-type="glencoe play-in-place height-250 width-310" id="media2" mime-subtype="mp4" mimetype="video" xlink:href="elife-23496-media2.mp4"><object-id pub-id-type="doi">10.7554/eLife.23496.020</object-id><label>Video 2.</label><caption><title>P-EN bump leads the E-PG bump in the ellipsoid body.</title><p>Example of two-color calcium imaging in the ellipsoid body of a fly walking on a ball. Part 1. (Top) Red channel signal from the E-PG neurons. The outline of the E-PG arborizations in the ellipsoid body is marked with dotted white lines. The heading of the fly, as read out from the ball position, is shown by the white circle. The population vector average of the activity is labeled by the magenta line. (Bottom) Video of the fly on the ball. Part 2. (Top) Green channel signal from the P-EN neurons. The outline of the P-EN arborizations in the ellipsoid body is marked with dotted white lines. The amplitude of the rotational velocity is indicated by the white bar at right. The population vector average is labeled with the green line. (Bottom) Video of the fly on the ball. Part 3. (Top) Combined red and green activity and PVA of both the E-PG and P-EN neurons. (Bottom) Video of the fly on the ball.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.020">http://dx.doi.org/10.7554/eLife.23496.020</ext-link></p></caption></media></p></sec><sec id="s2-8"><title>Firing rate model captures interaction of angular velocity and compass signals</title><p>Our conceptual model (<xref ref-type="fig" rid="fig1">Figure 1H</xref>) suggested that the anatomical offset between the E-PG and P-EN populations would move the activity bump in both populations during turns, thereby integrating rotational velocity to compute heading. However, it offered few predictions for how the feedback loops in the circuit might shape bump dynamics. In our two-color imaging experiments, we observed the hypothesized P-EN to E-PG activity offset, but the shift was small, between 10° and 30° at the highest angular velocities. Further, the E-PG activity in the bridge was consistently advanced from the P-EN activity by an offset that could exceed one glomerulus, which is half of the typical bump full width at half maximum in the protocerebral bridge. Finally, our functional connectivity experiments suggested that E-PG to P-EN connections may involve not just direct excitation, but the likely recruitment of inhibition as well. Thus, the simple conceptual model could not sufficiently explain the circuit dynamics we observed.</p><p>We therefore designed and simulated a firing rate model that built on the known facts about the circuit’s topology. We separated the P-EN neurons into two subpopulations of nine neurons each (one neuron per protocerebral bridge glomerulus, see Materials and methods), one population for neurons with dendritic projections on the right side of the protocerebral bridge, and another for neurons with dendritic projections on the left side. 54 E-PG neurons (three neurons per protocerebral bridge glomerulus) locally excite P-EN neurons, with each P-EN neuron innervating one glomerulus of the protocerebral bridge. In return, P-EN neurons excite E-PG neurons in the ellipsoid body, but with a shift in either the clockwise or counterclockwise direction, depending on whether they belong to the left or the right subpopulation. Further, we stipulated that the E-PG neurons uniformly and strongly inhibit P-EN neurons (all connections shown in <xref ref-type="fig" rid="fig10">Figure 10A</xref>; see <xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1A</xref> for the connectivity matrix; see Discussion for possible inhibitory pathways). Such inhibition was a pre-requisite to obtain a stationary bump of activity and a near-linear integration of velocity inputs (<xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1B</xref>; see below). Finally, turns were initiated by an external input to the model that uniformly excites either the right or left P-EN subpopulations (<xref ref-type="fig" rid="fig10">Figure 10A</xref>, bottom).<fig-group><fig id="fig10" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.021</object-id><label>Figure 10.</label><caption><title>Firing rate model for a circuit mechanism displaying persistent localized activity and angular velocity integration.</title><p>(<bold>A</bold>) Schematic of effective excitatory (top) and inhibitory (middle) connectivity assumed in the firing rate model and external inputs to the P-EN populations (bottom). Note the anatomical shift in the ellipsoid body between E-PG and P-EN neurons relative to their protocerebral bridge connections. We assume one P-EN and three E-PG neurons per protocerebral bridge glomerulus. (<bold>B</bold>) Activity of E-PG and P-EN neurons in the ellipsoid body for counterclockwise turns at low (left, 35°/s) and high—that is, close to saturation— (right, 190°/s) angular velocities. (<bold>C</bold>) Activity of E-PG and P-EN neurons in the protocerebral bridge at low (left) and high (right) angular velocities for a snapshot in time. The velocities are the same as in <bold>B</bold>. (<bold>D</bold>) PVA difference between P-EN and E-PG bumps in the ellipsoid body (black) or protocerebral bridge (red, blue) for different angular velocities for counterclockwise turns. (<bold>E</bold>) E-PG bump velocity as a function of the fly’s rotational velocity. The bump velocity displays saturation at high velocities. A linear fit of slope one around the origin is also displayed (upward shifted for display purposes). Rotational velocities along this line will be reliably integrated. (<bold>F</bold>) Simulated PVA of the E-PG population as a function of time for a time varying rotational velocity input (see <xref ref-type="fig" rid="fig10s2">Figure 10—figure supplement 2</xref> for a description of the input). (<bold>G</bold>) Evolution of the estimator of the error variance between the velocity input and the simulated PVA. Beyond 10 s, the statistics of the discrepancy follow a diffusion equation with a diffusion coefficient of 1.82 × 10<sup>−3</sup> rad<sup>2</sup>/s (see Materials and methods for a description of the fitting procedure). The shaded area indicates the standard deviation of the estimator.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.021">http://dx.doi.org/10.7554/eLife.23496.021</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig10-v1"/></fig><fig id="fig10s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.022</object-id><label>Figure 10—figure supplement 1.</label><caption><title>Model connectivity and performance.</title><p>(<bold>A</bold>) Connection matrix for the firing rate model. Note that local E-PG-to-P-EN excitation appears as a reduction in inhibition in the connectivity matrix because of strong uniform inhibition, but is converted to excitation by a constant and positive bias current in the P-EN neurons (see Materials and methods). (<bold>B</bold>) The linearity of rotational velocity integration in the model depends on the balance of local excitation and inhibition, as represented by model parameters α and β. The parameters we selected lie within the black box, that is, in a near-linear regime of velocity integration for the range of rotational velocities represented by the P-EN neuron tuning curves. Note that perfectly linear velocity integration is represented here by a linearity score of 1 (see Materials and methods). (<bold>C</bold>) Tuning curves of single, simulated P-EN neurons as a function of the velocity input. (<bold>D</bold>) Amplitude of the bumps in the ellipsoid body and the protocerebral bridge as a function of rotational velocity. (<bold>E</bold>) Velocity of the bump compared to artificially generated velocity input to P-EN neurons over a short timescale of 10 s for an artificially generated input velocity (see <xref ref-type="fig" rid="fig10s2">Figure 10—figure supplement 2</xref> and Materials and methods). High frequencies are smoothed out, but the input is otherwise tracked well. (<bold>F</bold>) Cross-correlation of the rotational velocity input to model P-EN neurons against the velocity of the activity bump shows that the bump velocity lags the velocity input by ~30 ms. Note that this is the lag of the bump relative to the P-EN velocity input, not to the fly’s rotational velocity.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.022">http://dx.doi.org/10.7554/eLife.23496.022</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig10-figsupp1-v1"/></fig><fig id="fig10s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.023</object-id><label>Figure 10—figure supplement 2.</label><caption><title>Angular velocity statistics.</title><p>(<bold>A</bold>) Example of an experimentally measured angular velocity track for 20 s. The velocity was downsampled to a rate of 12 Hz to match the volume imaging rate. (<bold>B</bold>) Histogram of the recorded angular velocities. The velocity was recorded over 350 s and the time points for which the angular velocity was zero were not considered for the analysis. The standard deviation of the distribution is 54°/s. (<bold>C</bold>) Time autocorrelation of the velocity tracks. The autocorrelation is well fit by an exponential with a time constant of 128 ms (orange curve). <bold>D</bold>, <bold>E</bold>, <bold>F</bold> Same as <bold>A</bold>, <bold>B</bold>, <bold>C</bold> but for a simulated track (see Materials and methods) at a rate of 50 Hz for 1000 s.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.023">http://dx.doi.org/10.7554/eLife.23496.023</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig10-figsupp2-v1"/></fig></fig-group></p><p>This rate model, which is reminiscent of past models of mammalian head direction cells (<xref ref-type="bibr" rid="bib29">Skaggs et al., 1995</xref>; <xref ref-type="bibr" rid="bib37">Xie et al., 2002</xref>; <xref ref-type="bibr" rid="bib40">Zhang, 1996</xref>), albeit with key differences in connectivity, captured the essence of much of what we observed in our experiments. Simulated firing rate curves of P-ENs in response to rotational velocity input were sigmoidal with an inflexion point at 0°/s, matching our experimental observations (compare <xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1C</xref> and <xref ref-type="fig" rid="fig4">Figure 4C</xref>). Further, the simulations indicated that the circuit functions as a ring attractor, enforcing a unique bump across the E-PG population, consistent with previous experimental results (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>, <xref ref-type="bibr" rid="bib17">Kim et al., 2017</xref>) (<xref ref-type="fig" rid="fig10">Figure 10B,C</xref>). Our model does not feature an attractor network within the E-PG population. Rather, E-PG activity is driven entirely by P-EN neurons and the persistent bump of activity arises from a feedback loop between these two neural populations. As a result, the activity and bump amplitudes of both populations are sensitive to velocity input, as observed experimentally (<xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1C,D</xref>).</p><p>The firing rate model also produced offsets in the activity of the E-PG and P-EN neurons in the ellipsoid body and in the protocerebral bridge, qualitatively matching our experimental observations. In the simulations, the offsets are due to the neural time constants (see Materials and methods); the bump in the P-EN population is not updated immediately after the E-PG bump shifts. We thus observe a phase difference in the bridge, with the P-EN bumps lagging the E-PG bumps, as observed experimentally (<xref ref-type="fig" rid="fig8">Figure 8G</xref>). This lead-lag relationship was reversed in the ellipsoid body, where the P-EN population drives the E-PG population. The neural constants are expected to be largely independent of the bump’s velocity. Consequently, when the E-PG bump in the protocerebral bridge, for instance, traveled further in a given time window (as during a fast turn), the P-EN bump lag and phase difference increased, consistent with experimental observations (<xref ref-type="fig" rid="fig9">Figure 9F</xref>, <xref ref-type="fig" rid="fig10">Figure 10D</xref>).</p><p>For an animal to reliably track its heading over long periods of time, it must accurately integrate its rotational velocity. Thus, in a robust system, the heading representation should update with an internal rotational velocity that matches the animal’s external velocity. Indeed, the architecture of our model ensures a quasi-linear relationship between bump rotation and steady velocity input (<xref ref-type="fig" rid="fig10">Figure 10E</xref>) up to an inherent saturating angular velocity. This linearity mainly depends on an appropriate balance of local E-PG to P-EN excitation, and inhibition onto the P-EN neurons (<xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1B</xref>). When we drove the P-ENs with a simulated but realistic time varying velocity input (<xref ref-type="fig" rid="fig10s2">Figure 10—figure supplement 2</xref>), we saw that the bump in the model closely followed the integrated external velocity, reliably tracking the animal’s heading (see <xref ref-type="fig" rid="fig10">Figure 10F</xref>, <xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1E,F</xref>). The errors that did arise were due to inaccurate integration of small input velocities. The limited number of P-EN neurons in the model (nine per subpopulation) caused the bump to ‘stick’ at individual P-EN neurons until the input velocity provides enough drive to free it, at values greater than 15°/s. The integration error, the difference between the bump position and the integrated velocity input, followed a distribution centered on zero, with a variance that increased over time (see Materials and methods). For short times (on the order of 10 s or less), the variance of the distribution was small, that is, the error between the animal’s heading and the animal’s representation of its heading was likely to be small (<xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1E</xref>). This error was influenced by the neural time delays of the angular integration circuit (<xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1F</xref>). For longer time scales, the error distribution broadened (<xref ref-type="fig" rid="fig10">Figure 10G</xref>) so that the variance increased linearly, a characteristic feature of a diffusion process (that is, the heading representation diffused away from the true heading over time). Overall, the linearity of the heading response to input and the small value of the diffusion coefficient suggest that this simple model of only three neural populations and E-PG to P-EN inhibition, which may be mediated by an additional and as-yet-uncharacterized neural population, can not only maintain a bump of activity, but can accurately update that bump position to reflect the animal’s heading.</p></sec><sec id="s2-9"><title>Blocking the P-EN synaptic output alters the E-PG activity</title><p>Both the conceptual model (<xref ref-type="fig" rid="fig1">Figure 1H</xref>) and the quantitative model (<xref ref-type="fig" rid="fig10">Figure 10</xref>) rely on P-EN input to the E-PG neurons to maintain and move the bump. To assess the impact of the loss of P-EN input on E-PG bump strength and movement, we imaged E-PG activity while impairing P-EN synaptic transmission. To that end, we used shi<sup>TS</sup>, a temperature-sensitive mutation of the <italic>Drosophila</italic> gene encoding a dynamin orthologue, which blocks vesicle endocytosis at elevated temperatures (<xref ref-type="bibr" rid="bib18">Kitamoto, 2001</xref>). We compared E-PG activity between control flies expressing shi<sup>TS</sup> in an empty promoter Gal4 and flies expressing shi<sup>TS</sup> in two different P-EN lines, R37F06 and VT008135. For each line, we compared the activity at room temperature (permitting synaptic transmission) to the activity at the restrictive temperature of 31°C, where vesicle reuptake and, thus, synaptic transmission should be blocked (<xref ref-type="fig" rid="fig11">Figure 11</xref>).<fig-group><fig id="fig11" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.024</object-id><label>Figure 11.</label><caption><title>Synaptic block of P-EN neurons disrupts E-PG activity.</title><p>(<bold>A</bold>) Walking statistics for flies across temperatures and across genotypes. (<bold>Ai</bold>) Example rotational velocity (top) and forward velocity (bottom) distributions for single trials for control (left, shi<sup>TS</sup> expressed in Empty Gal4) and P-EN blocked (right, shi<sup>TS</sup> expressed in the P-EN containing line R37F06, herein referred to as P-EN line 2). (<bold>Aii</bold>) Walking statistics at room temperature (RT, black) and at 31°C (red) for the control line and for two lines that express shi<sup>TS</sup> in the P-EN neurons. P-EN line one is GAL4-VT008135. The standard deviation of the rotational velocity is plotted at top, while the median of the forward velocity is shown at bottom. Lines show the means of all values. (<bold>B</bold>) Recordings at 31°C for one fly with shi<sup>TS</sup> expressed in empty Gal4. (Top) E-PG activity recorded in the ellipsoid body. (Center) The E-PG PVA strength. (Bottom) E-PG PVA and fly heading. The PVA is only shown when the PVA strength exceeds 0.025. (<bold>C</bold>) Same as in A, but now for a fly with shi<sup>TS</sup> expressed in the P-EN neurons (P-EN line 2). The PVA strength is lower and the bump movement is sporadic. The PVA is only shown when the PVA strength exceeds 0.025. (<bold>D</bold>) Mean bump amplitude at RT and at 31°C for all flies and fly lines (N = 10 for the control, N = 9 for P-EN line 1, N = 10 for P-EN line 2, bootstrapping gives p=0.0056 (**) and p=6.0×10<sup>−4</sup> (***)). (<bold>E</bold>) Comparison of the firing rate model predictions and the shi<sup>TS</sup> data. (Left) E-PG bump amplitude as a function of the P-EN to E-PG synaptic efficacy for the firing rate model. (Center) The predicted ellipsoid body activity for three points along the curve that are marked with orange circles. (Right) The mean and standard deviation of the ellipsoid body activity across trials for the control fly shown in <bold>B</bold> and the shi<sup>TS</sup> &gt; P-EN line 2 fly shown in <bold>C</bold>. The synaptic efficacy for the shi<sup>TS</sup> fly, likely less than 1, is unknown.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.024">http://dx.doi.org/10.7554/eLife.23496.024</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig11-v1"/></fig><fig id="fig11s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.23496.025</object-id><label>Figure 11—figure supplement 1.</label><caption><title>PVA behavior during turns under synaptic block.</title><p>(<bold>A</bold>) PVA strength distribution at room temperature (RT, shown in blue) and at 31°C (shown in red) across trials for the flies shown in <xref ref-type="fig" rid="fig11">Figure 11B and C</xref>. The flies walk forward quickly at 31°C, which causes the PVA strength distribution to shift right for the control fly. A PVA strength threshold of 0.025 is shown with the vertical black line. Only periods where the data exceeds this threshold are considered in <bold>B</bold>. (<bold>B</bold>) The change in PVA vs. the change in heading for each turn where the PVA strength exceeds 0.025 throughout the turn. A turn is defined as any sustained period where the rotational speed exceeds 15°/s. The solid colored lines show a linear fit to the data. The dotted gray lines show the condition where the change in heading equals the change in PVA. (<bold>C</bold>) Simulated PVA as a function of time given a time varying rotational velocity input (see <xref ref-type="fig" rid="fig10s2">Figure 10—figure supplement 2</xref> for a description of the input) and a synaptic efficacy of 55%. (<bold>D</bold>) R<sup>2</sup> values for the linear fits to the change in heading vs. the change in PVA data for thresholded turns, as described in B. (<bold>E</bold>) The slopes of the linear fits for the change in heading vs. change in PVA data.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.025">http://dx.doi.org/10.7554/eLife.23496.025</ext-link></p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-23496-fig11-figsupp1-v1"/></fig></fig-group></p><p>We first checked that the flies’ behavior was consistent across genotypes. Indeed, the walking statistics were similar at a given temperature across GAL4 lines (see, for example, the distributions for two flies at 31°C in <xref ref-type="fig" rid="fig11">Figure 11Ai</xref>), though we consistently observed a strong increase in forward walking at the higher temperature (<xref ref-type="fig" rid="fig11">Figure 11Aii</xref>). In experiments with control flies, we found that this increased forward velocity reliably led to a high-amplitude E-PG activity bump at the higher temperature (<xref ref-type="fig" rid="fig11">Figure 11B</xref>, top). As expected, the bump position slowly drifted away from the fly’s heading in darkness, but otherwise tracked the fly’s rotations (<xref ref-type="fig" rid="fig11">Figure 11B</xref>, bottom). In contrast, in flies that expressed shi<sup>TS</sup> in P-EN neurons, the bump was significantly weaker and more variable (<xref ref-type="fig" rid="fig11">Figure 11C</xref>), although these flies walked just as actively at the higher temperature as control flies.</p><p>We next quantified the effects of blocking P-EN neurons on E-PG bump amplitude. At room temperature, the distribution of E-PG bump amplitude across trials was similar for the control flies and for flies that expressed shi<sup>TS</sup> in the P-EN neurons (<xref ref-type="fig" rid="fig11">Figure 11D</xref>). At 31°C, however, when the flies became more active and increased their forward velocity, the amplitude distribution of the control flies shifted to higher values. In contrast, in the shi<sup>TS</sup> P-EN flies, where this activity increase was accompanied by a synaptic block in P-EN neurons, the bump amplitude distribution remained relatively unchanged, or even decreased (<xref ref-type="fig" rid="fig11">Figure 11D</xref>).</p><p>We looked to see if this reduced amplitude could be explained by our firing rate model. The model demonstrated that two recurrent E-PG/P-EN loops are sufficient to maintain and shift a bump of activity (<xref ref-type="fig" rid="fig10">Figure 10</xref>). If connections between the model’s loops are broken, the bump would be expected to disappear. To explore the consequences of weakening the P-EN to E-PG connections instead of breaking them entirely, we continuously tuned the weights down to 0 from their initial value (thereby modifying the P-EN to E-PG synaptic efficacy) and observed a range of simulated activity profiles in the ellipsoid body (<xref ref-type="fig" rid="fig11">Figure 11E</xref>, <xref ref-type="fig" rid="fig11s1">Figure 11—figure supplement 1C</xref>). When the synaptic efficacy was close to 0, activity in the network was relatively uniform and did not localize into a bump. At higher P-EN to E-PG synaptic efficacies, network activity localized into a bump, and its amplitude increased as the efficacy of the synaptic connection between P-EN and E-PG neurons increased. This critical role for the P-EN-to-E-PG connection in maintaining bump strength was consistent with the reduction in bump amplitude that we observed experimentally across flies and genotypes when P-EN output was impaired (<xref ref-type="fig" rid="fig11">Figure 11D</xref>).</p><p>Finally, we examined the reliability of the E-PG bump in tracking turns across flies and across conditions. Individual turns were defined as continuous periods where the rotational speed exceeded 15°/s. To guarantee that we could reliably track the bump across these turns, all turns with a PVA amplitude below a set signal-to-noise threshold were excluded from this analysis (<xref ref-type="fig" rid="fig11s1">Figure 11—figure supplement 1A</xref>, see Materials and methods). We then compared the change in PVA position to the change in the fly’s heading over the course of these turns (<xref ref-type="fig" rid="fig11s1">Figure 11—figure supplement 1B</xref>). We fit the data with a simple linear model and extracted R<sup>2</sup> values to gauge how reliably the PVA tracked turns (<xref ref-type="fig" rid="fig11s1">Figure 11—figure supplement 1D,E</xref>). These R<sup>2</sup> values were, on average, lower for the P-EN lines than for the control line, suggesting that disrupting the P-EN synaptic output affects the reliability of the E-PG bump to track turns. However, while our conceptual model and our simulation suggest that the E-PG bump should move less when P-EN output is reduced (<xref ref-type="fig" rid="fig11s1">Figure 11—figure supplement 1C</xref>), we instead observed that the E-PG bump often drifted at the restrictive temperature in the shi<sup>TS</sup> P-EN flies (see Discussion), as can be seen in part from the wide range of PVA changes seen during turns (<xref ref-type="fig" rid="fig11s1">Figure 11—figure supplement 1B</xref>).</p><p>Overall, although our shi<sup>TS</sup> results could not clarify how exclusive a role the P-EN neurons play in moving the E-PG bump in darkness, they revealed the importance of P-EN activity for maintaining the E-PG bump’s strength and stability, consistent with the assumptions of our model.</p></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>A stable internal representation of heading is fundamental to successful navigation. Neurons that maintain such a representation in darkness have been reported across various species (<xref ref-type="bibr" rid="bib20">Knierim and Zhang, 2012</xref>; <xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>; <xref ref-type="bibr" rid="bib32">Taube et al., 1990</xref>; <xref ref-type="bibr" rid="bib35">Varga and Ritzmann, 2016</xref>). Several computational models have been proposed to explain how a population representation of heading might be updated using angular velocity signals from different neural populations, but identifying connections between neurons that carry and integrate these disparate signals has been challenging in mammals (<xref ref-type="bibr" rid="bib20">Knierim and Zhang, 2012</xref>). Here, we took advantage of the small size, strong topography and well-described anatomy and cell types of the fly central complex to identify a candidate neuron population, P-ENs, which carry angular velocity signals. We used cell-type-specific genetic tools to perform electrophysiological recordings from single P-EN neurons and two-photon calcium imaging from entire populations of both P-ENs and the previously described 'compass neurons' (E-PGs) in head-fixed walking flies to demonstrate how these neurons together create an elegant circuit mechanism to update a heading representation when the fly turns in darkness. The circuit motif underlying this mechanism (see cartoon animation of this in <xref ref-type="other" rid="media1">Video 1</xref>) shares some characteristics with past conceptual models of head-direction cell function (<xref ref-type="bibr" rid="bib13">Hartmann and Wehner, 1995</xref>; <xref ref-type="bibr" rid="bib29">Skaggs et al., 1995</xref>; <xref ref-type="bibr" rid="bib37">Xie et al., 2002</xref>).</p><p>The rate model we implemented was able to capture the essence of the observed network activity, reproducing physiological activity in response to an input that is specific to one side of the protocerebral bridge, but uniform otherwise. This suggests a level of control over moving the activity bump that is quite simple to implement in neural circuitry. In addition, our model is agnostic to the type of input that is needed to rotate the bump. It does, however, require inputs that are activated when the fly turns, with a strength proportional to the strength of the turn, and that such inputs preferentially innervate one hemisphere to create a mirror-symmetry in the system. This description anatomically matches at least one known cell type: PB<sub>G1/2–9</sub>.b-SPSi.s (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>). The model also requires inhibition to maintain a stationary bump and linear velocity integration. The widely arborizing and glutamatergic PB18.s-GxΔ7Gy.b neurons (<xref ref-type="bibr" rid="bib8">Daniels et al., 2008</xref>; <xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>) may provide such large-scale inhibition onto the P-EN neurons.</p><p>Some discrepancies remain between our proposed model and the experimental evidence we present here. Our model assumes only one P-EN neuron per protocerebral bridge glomerulus (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>), which puts a strong constraint on the angular velocity integration properties of the circuit. In particular, although the circuit displays linear velocity integration within the typical range of angular velocities, the activity bump gets ‘stuck’ at individual P-EN neurons for small turns (<xref ref-type="fig" rid="fig10">Figure 10E</xref>). That is, when the fly turns slowly, the corresponding small inputs to the circuit do not trigger bump movements. We did not observe such bump dynamics in our imaging experiments, indicating that other, unexplored factors may help smooth bump movement in the actual circuit. Noise in the circuit, potential gap junctions and dendro-dendritic connections within and between E-PG and P-EN neurons, as well as the activity of other cell types in the circuit, such as the PB<sub>G1-8</sub>.s-EBt.b-D/Vgall.b neurons (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>), may all play a role in smoothing bump movement. These factors may also contribute to differences in bump shape and width between the model and experimental data. Further, our model suggests that E-PG activity is directly passed to the P-EN neurons in the protocerebral bridge, possibly with some anatomical offset and modulation through inhibition. Indeed, we observed almost coincident bumps of activity in the bridge for the two cell types. However, while functional connectivity showed a clear connection from the P-EN neurons to the E-PG neurons, our connectivity, electrophysiology, and imaging results suggested that the E-PG to P-EN connection might be more indirect and also recruit inhibition. In the functional connectivity experiments, very strong activation of the E-PG population reliably excited the P-EN neurons, but weaker excitation evoked a variety of responses (<xref ref-type="fig" rid="fig7">Figure 7D</xref>). Our electrophysiological recordings also revealed an unanticipated complexity in the tuning of the P-ENs’ membrane potential. Membrane potential tuning curves generally showed a peak at the same heading as the spike rate tuning curves, but also a pronounced trough about 150° distant from that peak. That trough, likely a result of inhibition in the circuit, was not always evident in the spike rate tuning (see <xref ref-type="fig" rid="fig5">Figure 5C</xref> for an exception). Finally, in two-color imaging, we observed offsets of up to one glomerulus between the E-PG and P-EN activity on the ipsilateral side of the bridge, and unexpected P-EN activity on the contralateral side, also offset from the E-PG activity (discussed below). These results were consistent for both color indicator pairings, as well as in experiments involving a second driver line (VT008135, see Materials and methods for further details, <xref ref-type="fig" rid="fig8s2">Figure 8—figure supplement 2</xref>), suggesting that the effects are not merely an artifact of indicator kinetics or co-expression in another population of neurons. We noted that during slow rotations, when P-EN activity is low and the E-PG bump is weak, these offsets decreased and, depending on the driver line used, also differed between the ipsi- and contralateral side during a turn (compare <xref ref-type="fig" rid="fig8">Figure 8G</xref> and <xref ref-type="fig" rid="fig8s2">Figure 8—figure supplement 2</xref>). We take this as indications that the connectivity between the E-PG and P-EN neurons in the protocerebral bridge may be partly indirect. Future studies will address how excitatory and inhibitory connectivity between these populations and others shape the circuit’s compass function.</p><p>Still uncertain is whether an activity bump can be independently sustained in the P-EN and E-PG populations, or in the left vs. right P-EN subpopulations. The connections from P-ENs to E-PGs may be the substrate that sustains the maintenance of E-PG bump position in the ellipsoid body in the absence of both visual and self-motion cues (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>), as in our model (<xref ref-type="fig" rid="fig11">Figure 11E</xref>). The significant reduction we saw in E-PG bump amplitude and PVA strength when synaptic transmission from P-ENs was blocked (<xref ref-type="fig" rid="fig11">Figure 11</xref>) is supportive of such an idea. Whether E-PG input is similarly essential to the maintenance of P-EN bump strength is less clear, but P-EN heading tuning hints at a dependence on E-PG input. On the other hand, appropriate local connections between nearby neurons either in the ellipsoid body or in the protocerebral bridge may allow bumps of activity to be independently sustained in the E-PG neurons. Signs of such internal connections come, for example, from evidence of presynaptic specializations of E-PGs in the ellipsoid body (see synaptotagmin labeling in <xref ref-type="fig" rid="fig7">Figure 7B</xref>). Bump persistence could also be achieved through long time-scale cellular biophysics (<xref ref-type="bibr" rid="bib39">Yoshida and Hasselmo, 2009</xref>). Future experiments and electron microscopy-based circuit reconstruction efforts should provide stronger constraints on the space of possible models, and clarify the functional and behavioral relevance of the actual circuit structure.</p><sec id="s3-1"><title>Comparing results from electrophysiological and calcium imaging experiments</title><p>For a circuit mechanism in which phase relationships and conjunctive coding are important, calcium imaging may seem an unreliable arbiter of truth. Somatic single cell recordings, on the other hand, can be hard to interpret given the intricate projection patterns of fly neurons and the compartmentalization of information processing that this can produce (<xref ref-type="bibr" rid="bib38">Yang et al., 2016</xref>). However, we found the results from our calcium imaging and electrophysiology experiments in P-EN neurons to be in broad agreement. The electrical signature of P-EN responses to angular and forward velocity mirrored what we saw with calcium imaging in the noduli. The measured width of a single P-EN neuron’s receptive field (~60°) was lower than that observed with calcium imaging (~110°, <xref ref-type="fig" rid="fig9">Figure 9</xref> and <xref ref-type="fig" rid="fig9s2">Figure 9—figure supplement 2</xref>), but this may arise from the slow decay kinetics of calcium indicators. One inconsistency between results, however, related to the imaging of neural activity in the protocerebral bridge. Based on imaging in the noduli (<xref ref-type="fig" rid="fig2">Figure 2</xref>) and electrophysiology (<xref ref-type="fig" rid="fig4">Figure 4</xref> and <xref ref-type="fig" rid="fig5">Figure 5</xref>), we expected that turns in one direction would evoke a steady decrease in activity on the other (contralateral) side of the bridge with increasing rotational velocity. Instead, imaging in the bridge showed a mild increase in activity at higher velocities (<xref ref-type="fig" rid="fig8">Figure 8</xref>), albeit while preserving the expected asymmetry between the ipsi- and contralateral side (<xref ref-type="fig" rid="fig8s2">Figure 8—figure supplement 2</xref>). We hypothesize that this calcium signal might represent synaptic inputs to the P-ENs more than their spiking activity.</p></sec><sec id="s3-2"><title>The role of P-ENs in the maintenance, stabilization and movement of the E-PG bump</title><p>Blocking P-EN output using shi<sup>TS</sup> had two effects on the E-PG bump: Its amplitude was reduced and its position sometimes changed dramatically during small turns (visible as an increase in variability and low R<sup>2</sup> for the correlation of changes in heading versus PVA in <xref ref-type="fig" rid="fig11s1">Figure 11—figure supplement 1B,D</xref>). The bump amplitude decrease in shi<sup>TS</sup> flies at high temperature can be readily explained by the reduction in synaptic input to the E-PGs — indeed, in our firing rate model (<xref ref-type="fig" rid="fig10">Figure 10</xref>) P-EN input is essential to the maintenance of the E-PG bump. Several factors may explain why the E-PG bump did not completely disappear during this manipulation. First, cell-intrinsic properties of the E-PG neurons may contribute to the persistence of activity in those neurons even in the absence of external input. Second, the shi<sup>TS</sup> block may have been incomplete (<xref ref-type="bibr" rid="bib34">Thum et al., 2006</xref>), meaning that there was sufficient P-EN drive even at high temperatures to keep the E-PG bump alive. Third, we cannot rule out the possibility of gap junctions between P-EN and E-PG neurons, which our experiments would not block. Finally, as mentioned above, other neuron types, such as the PB<sub>G1–8</sub>.s-EBt.b-D/Vgall.b (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>), may also provide synaptic input to the E-PG population in the ellipsoid body. Some of these possibilities have been suggested in a recent study that used the anatomy of protocerebral bridge neurons to create a spiking model that generates ring attractor dynamics (<xref ref-type="bibr" rid="bib16">Kakaria and de Bivort, 2017</xref>).</p><p>Further, our conceptual and firing rate models would imply that if the P-EN to E-PG connections were entirely removed, E-PG activity would be unable to follow the fly’s turns. However, the E-PG activity does still track the fly’s turns at high temperature, when the P-EN synaptic output should be blocked. This may, once again, be the result of an incomplete block. We speculate that one reason that the E-PG bump makes large movements across the ellipsoid body even during small turns is that a reduction in bump amplitude destabilizes the compass representation. Thus, fluctuations in the activity of the E-PGs elsewhere in the ellipsoid body may exert a greater influence on the movements of the bump than under normal conditions, when activity in distant E-PGs is likely to be suppressed (<xref ref-type="bibr" rid="bib17">Kim et al., 2017</xref>). Yet another possibility that could explain the bump’s movements is raised by a parallel study, which provides further evidence for P-ENs serving a role in angular integration and describes a second subtype of P-EN neurons that likely also influences the position of the E-PG bump (<xref ref-type="bibr" rid="bib10">Green et al., 2017</xref>).</p></sec><sec id="s3-3"><title>The role of the compass representation in the fly’s behavior</title><p>The coordinated activity of the E-PG population and its control by the P-EN population when the fly turns are strongly evocative of a compass. The animal could, in principle, use such a neural compass to tether its actions to local landmarks or other sensory cues during navigation, and maintain its bearings in the temporary absence of such cues (<xref ref-type="bibr" rid="bib23">Neuser et al., 2008</xref>). Consistent with this idea, the PVA computed with E-PG population activity tracks the fly’s heading quite accurately even in darkness. However, we do not yet know how downstream circuits read out E-PG population activity. Thus, although the PVA metric is a useful representation of E-PG compass-like activity, whether downstream circuits perform similar computations to extract the fly’s heading is unclear. Further, we derive the PVA by combining the strength and angular position of activity in the E-PG population. Although both these features of E-PG activity likely influence downstream neurons, their specific influence on such neurons will depend on the precise connectivity of the circuit, something that a combination of functional connectivity studies and electron microscopy may reveal in time. Although there is considerable evidence across insects suggesting that CX neurons influence action initiation and turning movements (<xref ref-type="bibr" rid="bib3">Bender et al., 2010</xref>; <xref ref-type="bibr" rid="bib22">Martin et al., 2015</xref>), the connection of E-PG and P-EN neurons to the largely unidentified class of CX neurons that drive behavioral decisions is as yet unclear.</p></sec><sec id="s3-4"><title>Other elements of the compass system</title><p>We have focused here on the effects of self-motion cues on bump movement, to which end most of our experiments were conducted with flies walking in the dark. However, E-PG activity is strongly influenced by visual cues, as evidenced by the fact that cue jumps can reset the bump position (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>; <xref ref-type="bibr" rid="bib17">Kim et al., 2017</xref>). The angular velocity representation of P-EN neurons, by contrast, seemed unaffected by the presence of closed loop visual feedback (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>). Thus, while we have suggested a circuit mechanism for updating heading representation in the dark using self-motion signals, we anticipate that strong sensory inputs, including those from visual cues, control updating in other circumstances. For example, we have previously observed that the ring neurons retinotopically respond to visual cues (<xref ref-type="bibr" rid="bib27">Seelig and Jayaraman, 2013</xref>). As the putative ring neuron axons arborize in the ellipsoid body along with the E-PG dendrites, it may be possible for them to convey visual information to the E-PG neurons, influencing the movement of the bump of activity. Further, we suggested above that the E-PG to P-EN connection in the protocerebral bridge may be indirect and recruit sources of inhibition. There exist a few classes of bridge interneurons, the so-called PB<sub>G6-8</sub>.s<sub>G9</sub>.b, PB18.s-GxΔ7Gy.b and PB18.s-9i1i8c.b neurons (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>), which may serve as intermediaries in E-PG to P-EN connections (<xref ref-type="bibr" rid="bib16">Kakaria and de Bivort, 2017</xref>). Future studies should help clarify their role in the compass network.</p></sec><sec id="s3-5"><title>Angular velocity signals and heading representation in the fly and other animals</title><p>Fly E-PG neurons share several characteristics with mammalian head direction cells. Both head direction cells and E-PG neurons maintain one stable bump of activity and both track the animal’s heading in darkness, a feature that is well described by appropriately wired ring attractor models. Rodents that are deprived of proprioceptive and motor efference signals, as in passive transport experiments (<xref ref-type="bibr" rid="bib30">Stackman et al., 2003</xref>), show impaired heading representation. To update their heading in darkness, head direction cells in rodent thalamic nuclei and post-subiculum are thought to depend on angular velocity input from the vestibular system, mediated by the dorsal tegmental nucleus (<xref ref-type="bibr" rid="bib2">Bassett and Taube, 2001</xref>). Although 75% of neurons in this region were found to encode angular head velocity, only about a third of those did so in the mirror-symmetric, turn-direction-selective fashion of <italic>Drosophila</italic> P-EN neurons that we describe here.</p><p>Individual P-EN neurons were deterministic in their left-right mirror-symmetric rotation tuning, but diverse in the range of rotational velocities that their tuning curves spanned. Indeed, the measured bandwidth of individual P-ENs ranged anywhere between 30 and 270°/s. This diversity may reflect the diversity of tuning of the three to four P-EN neurons that innervate each protocerebral bridge glomerulus (estimated from cell body counts [<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>]). Such a range of sensitivities and bandwidths would permit a more precise tracking of the flies’ turns across a wide range of rotational velocities.</p><p>The origins of angular velocity responses in P-ENs are as yet unclear, but these responses show a latency relative to the fly's turning movements that we estimated to be ~150 ms, suggesting that they arise from proprioception rather than motor efference. Anatomically, both the two halves of the protocerebral bridge as well as the two noduli are mirror-symmetric structures innervated by a number of neuron types in a lateralized manner (for example, PB<sub>G2-9</sub>.b-IB.s.SPS.s [<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>]), making them likely candidates for receiving such rotation-tuned input. In the cockroach, neurons encoding angular as well as forward velocity have been recorded in the fan-shaped body (<xref ref-type="bibr" rid="bib11">Guo and Ritzmann, 2013</xref>; <xref ref-type="bibr" rid="bib22">Martin et al., 2015</xref>), a substructure of the central complex that is evolutionarily conserved in flies. Of note, only one of the forty turn responsive neurons in the latter study showed bidirectional modulation, with excitation for turns in the preferred direction and inhibition for turns the other way, a hallmark of the P-EN neurons. These studies, which relied on extracellular recordings and did not identify cell types, found that changes in spike rate regularly preceded locomotor changes instead of tracking them as we found for the fly P-ENs. If we assume that neurons of the type recorded in the cockroach also exist in the fly, it is not yet clear whether the P-EN/E-PG compass network that we describe here exploit advance information about expected changes in angular velocity.</p></sec><sec id="s3-6"><title>Structure-function relationships in central brain circuits</title><p>A striking aspect of the fly compass system is its structural symmetry. Mirror symmetry is a prominent feature of the anatomical layout of the protocerebral bridge. The developmental origins of the anatomical positions of central complex neurons have been the focus of numerous studies (recently, for example, <xref ref-type="bibr" rid="bib5">Boyan and Liu, 2016</xref>). However, although the two sides of the protocerebral bridge and the noduli are tuned to rotations in opposite directions, maintaining symmetry at the large scale, the activity of the E-PGs and P-ENs at the scale of bridge glomeruli breaks this symmetry. During a turn, bumps of activity propagate through the left and right sides of the bridge in parallel, in a manner reminiscent of windshield wipers, rather than obeying mirror symmetry. This pattern of activity, together with the connectivity of protocerebral bridge glomeruli and ellipsoid body sectors (see schematic in <xref ref-type="fig" rid="fig1">Figure 1G</xref>) ensures that the E-PG bump moves smoothly around the ellipsoid body when the fly turns.</p><p>More broadly, topographical organization is a striking feature of many sensory circuits, but structure often follows computational function in neural circuits in the central brain as well. The feedforward pathways to and from the Mauthner cell make clear these neurons role in rapid escape behavior (<xref ref-type="bibr" rid="bib12">Hale et al., 2016</xref>), and the parallel delay loops of the barn owl auditory system and the electric fish point to their comparative roles in localizing prey (<xref ref-type="bibr" rid="bib21">Konishi, 2006</xref>). The anatomical shift of the P-EN neurons with respect to the E-PG neurons (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>) provided an immediate clue to a potential structure/function relationship, that of a mechanism for shifting the bump of E-PG activity to update their internal representation of heading. The fact that topography often matches topology in the small fly brain makes the system ideal for the identification of circuit mechanisms underlying complex computations. Only time —and perhaps large scale circuit reconstruction efforts (<xref ref-type="bibr" rid="bib9">Denk et al., 2012</xref>)— will tell whether such network motifs are also present, but perhaps better hidden, in the more distributed circuits of much larger brains.</p></sec></sec><sec id="s4" sec-type="materials|methods"><title>Materials and methods</title><sec id="s4-1"><title>Fly stocks</title><sec id="s4-1-1"><title>Calcium imaging (7–10 days old females)</title><list list-type="order"><list-item><p>UAS-jRGECO1a/LexA-R37F06;LexAop-GCaMP6f/GAL4-R60D05</p></list-item><list-item><p>UAS-jRGECO1a/LexA-R60D05;LexAop-GCaMP6f/GAL4-R37F06</p></list-item></list></sec><sec id="s4-1-2"><title>Visually guided patch-clamp recordings (1–2 days old females)</title><list list-type="order"><list-item><p>GAL4-R37F06/UAS-GFP</p></list-item><list-item><p>LexAop-mCD8-GFP;LexA-R37F06;UAS-Jaws-mCherry,GAL4-R55G08</p></list-item><list-item><p>LexAop-mCD8-GFP;LexA-R37F06;UAS-Jaws-mCherry,GAL4-R76E11</p></list-item><list-item><p>LexA-R37F06;UAS-CsChrimson-mCherry,LexAop-GFP/GAL4-R55G08</p></list-item><list-item><p>LexA-R37F06;UAS-CsChrimson,LexAop-GFP/GAL4-R55G08</p></list-item><list-item><p>LexA-R60D05;L4-R37F06/UAS-GCamp6m,LexAop-CsChrimson</p></list-item><list-item><p>GAL4-R37F06/UAS-Jaws-GFP</p></list-item></list></sec><sec id="s4-1-3"><title>Functional connectivity experiments (5–8 days old females)</title><list list-type="order"><list-item><p>LexA-R60D05/+;GAL4-R37F06/UAS-GCaMP6-m in attP2 -- LexOp-CsChrimson-tdTomato in VK00005</p></list-item><list-item><p>LexA-R60D05/+;GAL4-R37F06/UAS-CsChrimson-mCherry in su(Hw)attP1-- LexOp-GCaMP6-m in VK00005</p></list-item></list></sec><sec id="s4-1-4"><title>Polarity studies</title><list list-type="order"><list-item><p>w, pBPhsFlp2::PEST, tub-FRT-Gal80-FRT; pJFRC-5XUAS-IVS-TLN::smGFP-V5 in su(Hw)attP5 (/CyO); pJFRC225-5XUAS-IVS-myr::smGFP-FLAG in VK00005, pJFRC51-3XUAS-IVS-Syt::smGFP-HA in su(Hw)attP1 (/TM2 or TM6b) (gift of Y. Aso).</p></list-item></list></sec><sec id="s4-1-5"><title>shi<sup>TS</sup> experiments (3–5 days old females)</title><list list-type="order"><list-item><p>pJFRC99 UAS-shiTS Su(Hw) attp1/LexA-VT025957, LexAop – Gcamp6f (VK00005)/GAL4-X where X was R37F06, VT008135, or pBDPGal4U (attp2) (empty Gal4 control).</p></list-item></list><p>Flies were randomly picked from the food vials for all experiments.</p></sec></sec><sec id="s4-2"><title>Visualization of GAL4 expression patterns</title><p>Imaging stacks for R60D05 and R37F06 were obtained from the FlyLight imaging database (<xref ref-type="bibr" rid="bib15">Jenett et al., 2012</xref>). As the protocerebral bridge expression was significantly dimmer than the ellipsoid body expression, the volume was divided in two, with the ellipsoid body in the front half and the bridge in the back. The two half volumes were then collapsed into maximum intensity projections, and the contrast and brightness independently varied to best show the individual structures. The two images were then combined and used to generate a third maximum intensity projection, which is shown in <xref ref-type="fig" rid="fig1">Figure 1</xref>.</p></sec><sec id="s4-3"><title>Fly preparation for imaging during walking</title><p>Flies were prepared for imaging as described in (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>). Briefly, flies were affixed to a metal shim that held their head and thorax in place while allowing their legs and abdomen to move freely. The fly’s head was immersed in saline of the following composition (in mM): NaCl (103), KCl (3), TES (5), trehalose 2 H<sub>2</sub>O (8), glucose (10), NaHCO<sub>3</sub> (26), NaH<sub>2</sub>PO<sub>4</sub> (1), CaCl<sub>2</sub> 2 H<sub>2</sub>O (2.5), MgCl<sub>2</sub> × 6 H<sub>2</sub>O (4). The head capsule was opened and soft tissue removed, exposing the brain. For imaging the noduli or ellipsoid body, the fly’s head was positioned so that the top of the head was level. For imaging the protocerebral bridge, the head was pushed down so that the back of the head was at a ~30° angle. The flies were then suspended over a free-floating foam ball and allowed to walk freely while an immersion objective was lowered into the saline. An 8 mm diameter, 92 mg ball was used for the fly treadmill.</p></sec><sec id="s4-4"><title>Two-photon calcium imaging</title><p>Red and green indicator calcium imaging was performed on a custom two-photon microscope running ScanImage 2015 and similar to the one described in (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>). An 875 nm longpass filter was placed in the incident light path to cut out shorter wavelengths from the laser that otherwise contaminated the red channel. A primary dichroic at 705 nm was used to direct emitted light to the red and green PMTs, and a secondary dichroic at 594 nm split the light to the red and green channels. 50 nm bandpass filters centered around 525 and 542 nm were placed in front of the red channel and a 90 nm wide filter centered at 625 nm was set in front of the green channel. For five of the flies used for ellipsoid body imaging, a 660 nm primary dichroic was used instead of the 705 nm filter.</p><p>All imaging was performed using a 1020 nm, femtosecond pulsed laser at ~20 mW power. For the ellipsoid body and noduli imaging, 256 × 256 pixel volumes were obtained. The volumes were ~50 μm on a side and consisted of 6 Z planes, each spaced 8 μm apart and chosen so as to tile the ellipsoid body and noduli. Volumes were obtained at a rate of 11.4 Hz. For protocerebral bridge imaging, 256 × 256 volumes were again obtained, but they were now ~200 μm on a side and consisted of 6 or 12 Z planes imaged at 11.4 Hz and 6.2 Hz, respectively. An 8 μm spacing was used for the six plane volumes, and a 3 or 4 μm spacing was used for the 12 plane volumes. The ball position was tracked at 200 Hz and synchronized to the calcium imaging using TTL pulses triggered after each frame grab.</p><p>Recordings began as soon as the fly was placed on the ball and the software was initialized, usually within five minutes, and never longer than 15 min. If the brain was visibly moving more than ~5 µm or if the fly ceased to move within the first four trials, the experiment was discarded. Otherwise, all trials were analyzed.</p></sec><sec id="s4-5"><title>Matching the behavioral and imaging data</title><p>The timestamps for each imaging frame were found from the TTL signal, and the behavioral data at the point that corresponded to the end of each volume acquisition was tabulated to create downsampled behavioral data to match the imaging data. Rotational, translational, and side slip velocities were then calculated by taking the difference of the fly’s heading, total translation, or side translation across each time point and dividing them by the time between points. Velocities were also Savitzky-Golay filtered over 11 frames with a third order polynomial to smooth out artifacts due to downsampling.</p></sec><sec id="s4-6"><title>Correlating noduli activity and fly velocity</title><p>We defined ellipsoidal regions of interest over each nodulus, calculated ΔF/Fs, and then computed the difference in activity between the two sides. Rotational velocities were convolved with the function:<disp-formula id="equ1"><mml:math id="m1"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>t</mml:mi><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:msub><mml:mi>τ</mml:mi><mml:mrow><mml:mi>o</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>t</mml:mi><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:msub><mml:mi>τ</mml:mi><mml:mrow><mml:mi>o</mml:mi><mml:mi>f</mml:mi><mml:mi>f</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msup><mml:mo>,</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>using time constants for GCaMP6f obtained in response to 10 action potentials in dissociated mammalian neurons: τ<sub>on</sub> = 0.13 s and τ<sub>off</sub> = 0.63 s (<xref ref-type="bibr" rid="bib6">Chen et al., 2013</xref>). The convolved velocities were then correlated with the net activity. Correlations were not significantly different if other time constants from the same study were used.</p><p>For linear regression analysis, rotational velocities were separated into right and left rotations by taking the absolute values of all negative or, respectively, the positive rotational velocities. The rotational velocities and forward velocity were fit to determine regression coefficients for Z-scored locomotor parameters (predictors: v<sub>Rot right</sub>, v<sub>Rot left</sub>, v<sub>For</sub>), using the ΔF/F signal of a given ROI (left or right nodulus) as observation. Bin size for all parameters was 25 ms. Time shifts (−375 to 750 ms in 25 ms steps) were introduced between observation and predictor variables to get a sense of neural responses over time.</p><p>We should note that the GAL4 driver line that we used for these experiments, R37F06, also contains PB<sub>G2-9</sub>.s-FB<italic>l</italic>3.b-NO<sub>2</sub>V.b (PFN<sub>V</sub>) neurons (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>). To avoid potential contamination from this population, we only imaged the top plane of the noduli that contain the P-EN arbors in the NO<sub>1</sub> subdivision. NO<sub>2</sub>, where the PFN<sub>V</sub>s arborize, is distinct from and more ventral to NO<sub>1</sub>. The expression of the PFN<sub>V</sub> neurons was often too weak to see, but, when visible, NO<sub>1</sub> and NO<sub>2</sub> could be clearly distinguished.</p></sec><sec id="s4-7"><title>Fly preparation for electrophysiology during walking</title><p>The fly was anaesthetized on ice and transferred to a cold plate at 4°C. The fly’s proboscis was pressed onto its head and immobilized with wax. The fly’s head and thorax were UV-glued to a plastic shim, the chamber was sealed with grease, the head covered with saline, and the head capsule opened. The saline used for electrophysiology was the same as used for imaging, except that the concentration of CaCl<sub>2</sub> was 1.5 mM instead of 2.5 mM. The fly was positioned on an air-supported ball and the walking velocity of the fly was monitored using a camera system (<xref ref-type="bibr" rid="bib28">Seelig and Jayaraman, 2015</xref>). For all electrophysiology experiments, we used an 8 mm diameter, 47 mg polyurethane foam ball. Ball movement was recorded at a sampling rate of 4 kHz. Flies were either recorded in darkness, or given closed loop control over a 15° wide blue vertical stripe, presented on a cylindrical LED display spanning 240° in azimuth and 120° in elevation (<xref ref-type="bibr" rid="bib24">Reiser and Dickinson, 2008</xref>). For all experiments presented in this paper, the gain of the closed loop was set to a natural gain of 1, meaning that a 90° rotation of the ball was mirrored as a 90° counter rotation of the stripe in the visual arena. The gap of the arena (in the back of the fly) was ignored, i.e. the stripe ran smoothly from one side of the gap to the next as if the space in between did not exist. For analysis, stripe positions on the 240° arena were mapped linearly to an arena spanning 360°.</p></sec><sec id="s4-8"><title>Electrophysiology recordings</title><p>For electrophysiology experiments, GFP was expressed in P-EN neurons and visually guided single cell recordings were performed under epifluorescence and IR illumination. Whole-cell and loose patch recordings from P-EN neurons were performed with a recording solution of the following composition (in mM): K-aspartate (140), HEPES (10), KCl (2), EGTA (1.1), CaCl2 (0.1), MgATP (4), Na3GTP 0.5), phosphocreatine (5), and biocytin (0 to 6). The brain was perfused with oxygenated saline containing 1.5 mM CaCl<sub>2</sub>. The faithfulness of spike rates reported with whole-cell patch-clamp recordings was verified by extracellular loose patch recordings (<xref ref-type="supplementary-material" rid="SD1-data">Supplementary file 1</xref>). Pipette resistance and capacitance was compensated. For whole-cell recordings, recording quality was monitored throughout the experiment through positive and negative current injections. Access resistance and liquid junction potential was not compensated for. Data was acquired at 20 kHz and low-pass filtered at 4 kHz. Cells were filled with Alexa dyes and neuron identity and soma location was confirmed by epifluorescence imaging and/or post-hoc confocal imaging of PFA-fixated brains.</p></sec><sec id="s4-9"><title>Electrophysiological characterization of P-ENs</title><p>The input resistance R<sub>in</sub> was estimated from fitting an exponential decay to the membrane potential after the offset of current injections. Since the offset of a hyperpolarizing current pulse often resulted in rebound spiking and a concomitant overestimation of R<sub>in</sub> we fitted the offset of depolarizing current injections to derive the passive electrical properties. P-ENs are unipolar neurons with a small soma (diameter &lt;5 μm), a thin primary neurite, and a high input resistance (1.9 ± 0.8 GΩ) close to typical patch clamp seal resistances. Since in that scenario the two resistances function as a voltage divider, the measured membrane potential might be erroneous. We thus performed loose patch recordings from P-ENs to determine their firing rates in an unperturbed recording configuration (3.9 ± 2.6 Hz during standing epochs) and aimed at adjusting the resting membrane potential in whole-cell recordings to a value that would roughly yield similar spike rates. The bias current injected to that end was on average −5.8 ± 3.6 pA. See <xref ref-type="supplementary-material" rid="SD1-data">Supplementary file 1</xref> for quantification of electrophysiological properties. Patch-clamp recordings of cells with lower input resistance, higher membrane potential, and/or higher bias currents than those reported in <xref ref-type="supplementary-material" rid="SD1-data">Supplementary file 1</xref> were excluded from analysis, as were cells in which the access resistance was too high to allow the unambiguous detection of action potentials. Both whole-cell and loose patch recordings were terminated (and/or late trials excluded post-hoc) if the spike frequency increased (or decreased) notably, whether it was because of unfavorable changes in signal-to-noise ratio, sudden depolarizations in the whole-cell configuration, or partial break-ins in loose patch recordings. All reported values for the cellular membrane potential are not corrected for liquid junction potential.</p></sec><sec id="s4-10"><title>Post-processing of brains and confocal imaging</title><p>After the end of a patch-clamp experiment flies were carefully detached from the holder and their brains dissected out. After 10 min fixation in 4% PFA in 0.1M phosphate buffer at room temperature, brains were washed three times for five minutes each in phosphate buffer and mounted in Vectashield on a microscopy slide. Samples were imaged on a Zeiss 710 confocal microscope with a 63x objective. Since P-EN arborizations span the entire dorso-ventral axis of the fly brain, a given set of frames encompassing an individual neuropile was merged in a maximum z-projection and adjusted for brightness and contrast. These individual neuropile projections were then max-projected to yield the overview image shown in <xref ref-type="fig" rid="fig3">Figure 3A</xref>.</p></sec><sec id="s4-11"><title>Spike detection</title><p>For both loose patch as well as whole-cell recordings, the recorded voltage was bandpass filtered (50–1000 Hz) and a threshold was set for automatic spike detection. The threshold was set individually for each recording and, if necessary, manually adjusted for individual sweeps (10–300 s). Only recordings with a reasonable signal to noise ratio and sufficient robustness to the setting of the spike threshold were included in the final dataset (see also <xref ref-type="fig" rid="fig4s2">Figure 4—figure supplement 2</xref>).</p></sec><sec id="s4-12"><title>Characterization of P-EN responses to locomotor parameters</title><p>The fly’s velocities were calculated from the displacement of the ball as reported by the treadmill (<xref ref-type="bibr" rid="bib26">Seelig et al., 2010</xref>).</p><p>To quantify the neural response to rotational velocity, we fit sigmoidal tuning curves to membrane potential and spike rates as a function of rotational velocity. All parameters were binned into 50 ms windows. The membrane potential was 50 Hz lowpass filtered and spike rates were smoothed with a 1 s Gaussian window with a half-width of 0.35 s. After shifting the neural responses by the cell’s respective response lag (see below) to align them with the rotational velocities they correlated most strongly with, we excluded all periods in which the fly was not walking. Subsequently, mean values were calculated for 12°/s wide rotational velocity bins and fit with a sigmoid of the form<disp-formula id="equ2"><mml:math id="m2"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>v</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mi>o</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:msub><mml:mi>r</mml:mi><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>∗</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>v</mml:mi><mml:mrow><mml:mi>r</mml:mi><mml:mi>o</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>v</mml:mi><mml:mi>o</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mfrac><mml:mo>+</mml:mo><mml:msub><mml:mi>r</mml:mi><mml:mrow><mml:mi>m</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>with <italic>r<sub>max</sub></italic> being the neurons maximum response, <italic>s</italic> the slope of the tuning curve, <italic>v<sub>rot</sub></italic> the rotational velocity, <italic>v<sub>0</sub></italic> the lateral displacement of the curve on the x-axis and <italic>r<sub>min</sub></italic> the minimum response of the neuron. The number of samples that contributed to each mean were used as weights.</p><p>Heat maps for spike rates and membrane potential as a function of rotational and forward velocity were constructed from non-overlapping 20 ms bins of data, similar to (<xref ref-type="bibr" rid="bib11">Guo and Ritzmann, 2013</xref>) except that velocities were not smoothed. Spike rates were smoothed with a 1 s Gaussian window with a half-width of 0.3 s and the membrane potential was 50 Hz low-pass filtered. For each time bin, values were assigned to a field in a two-dimensional array depending on the fly’s rotational velocity (in a 12°/s grid) and forward velocity (in a 1 mm/s grid). The heat map represents the mean value of each of those fields containing at least 50 time bins (1 s of data).</p><p>Since P-EN neurons tend to spike at rest, spike-triggered averages (STAs) of rotational velocities were constructed from only those spikes that occurred during 2 s epochs with rotational velocities exceeding 40°/s at any point in time.</p><p>For linear regression analyses, the membrane potential was 50 Hz low-pass filtered. Rotational velocities were separated into right and left rotations by taking the absolute values of all negative or, respectively, positive rotational velocities. The rotational velocities, membrane voltage and spike counts were subsequently binned in non-overlapping 20 ms windows. Generalized linear model regressions were fit to determine regression coefficients for Z-scored locomotor parameters (predictors: v<sub>rot right</sub>, v<sub>rot left</sub>, v<sub>rot right</sub><sup>3</sup>, v<sub>rot left</sub><sup>3</sup>), using either membrane potential or spike count as observations. We assumed a normal distribution for the membrane potential (making the procedure an ordinary linear regression) and a Poisson distribution for the spike count (modeling the logarithm of the spike count as a linear combination of the predictors). Time shifts (−2 to 2s in 20 ms steps) were introduced between observation and predictor variables to reveal possible delays between the neural response and the fly’s behavior (or vice versa). To calculate the autocorrelation of the rotational velocity, the same method was applied, using v<sub>rot</sub> as predictor and observation both. In all cells, the regression coefficients for rotational velocity with neural responses followed a stereotypical time course. The neural response lag was defined as the time point of the maximum absolute difference of regression coefficients for ipsi- and contralateral rotations. Inclusion of forward velocity in the generalized linear regression did not yield consistent results across P-ENs. On average, coefficients at zero temporal lag were not different from zero (0.00 ± 0.08, one-sample t-test: p=0.99). Thus, we did not include forward velocity as a parameter for determining temporal properties of P-EN firing.</p></sec><sec id="s4-13"><title>Generation of heat maps and tuning curves to the fly’s heading</title><p>Heat maps for spike rates and membrane potential as a function of rotational velocity and the fly’s heading were constructed from non-overlapping 25 ms bins of data. In visual closed loop experiments, the heading angle was approximated as 2π minus the azimuthal position of the stripe. In experiments where the fly walked in darkness, the heading angle was calculated as the accumulated rotation of the fly. Spike rates were smoothed with a 1 s Gaussian window with a half-width of 0.3 s and the membrane potential was 50 Hz low-pass filtered. For each time bin, values were assigned to a field in a two-dimensional array depending on the fly’s rotational velocity (in a 12°/s grid) and the fly’s heading (in a π/4 grid). The heat map represents the mean value of each of those fields containing at least eight time bins (0.2 s of data).</p><p>For fitting tuning curves to the fly’s rotations and virtual heading, we restricted the analysis – for each cell individually – to the range of rotational velocities that was well sampled across all virtual heading angles to avoid strong biases in the sampling of particular heading angles at a given rotational velocity. To that end, we visually inspected grayscale heat maps of a sample size matrix analogously generated to the neural response matrix (see <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1B</xref>) and excluded all columns outside a well-sampled rectangle. Rotational velocity tuning curves were fit with a sigmoidal function as outlined above, except that rotational velocity bins were 12.5°/s wide (to fit with the margins of the heading ∪ rotational velocity array created for the heat map on the basis of which the velocities to be included were determined). Heading angles were binned into 32 bins of 11.25° width. Tuning to the fly’s heading angle θ was fit with a compound von Mises function of the form<disp-formula id="equ3"><mml:math id="m3"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">Θ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mi>r</mml:mi><mml:mrow><mml:mi>m</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mspace width="thinmathspace"/><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>s</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">Θ</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi mathvariant="normal">Θ</mml:mi><mml:mrow><mml:msub><mml:mn>0</mml:mn><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:msub><mml:mi>I</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mspace width="thinmathspace"/><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>s</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">Θ</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi mathvariant="normal">Θ</mml:mi><mml:mrow><mml:msub><mml:mn>0</mml:mn><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:msub><mml:mi>I</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>with <italic>r<sub>min</sub></italic> being the minimum response of the neuron, <italic>g</italic> the rate modulation of the neuron, <italic>θ<sub>0</sub></italic> the preferred heading angle, κ the concentration of the modulation around <italic>θ<sub>0</sub></italic>, and <italic>I<sub>0</sub>(κ)</italic> the modified Bessel function of order 0. P-EN heading tuning often showed a peak and a trough (see <xref ref-type="fig" rid="fig5">Figure 5C</xref>), a phenomenon that was more pronounced on the level of the membrane potential, and was not well described by a unimodal von Mises function. Initial values for the parameters θ<sub>01</sub> and θ<sub>02</sub> were chosen to be angles of the peak and trough of the smoothed mean spike rates curves.</p></sec><sec id="s4-14"><title>Calculation of tuning indices</title><p>A rotation tuning and a heading tuning index was calculated for each cell. The rotation tuning index was defined as the R<sup>2</sup> value of the sample-size weighted spike rate fit to a sigmoidal function (see above).</p><p>The heading tuning index H was defined as the mean vector length of spike rates over all virtual heading angles and calculated according to the following formula:<disp-formula id="equ4"><mml:math id="m4"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>H</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msubsup><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mi>r</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>∗</mml:mo><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>∗</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msup></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:msubsup><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mi>r</mml:mi><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>with N being the number of heading bins (N = 32), θ<sub>n</sub> the bin center, and r<sub>n</sub> the mean spike rate in a given bin. The preferred heading angle was defined as the argument of H, i.e. the phase of the mean vector.</p><p>Chance-level statistics for rotation and head direction tuning indices of experiment averages were computed for each cell individually through a shuffling procedure (performed for 5/6 visual closed loop cells, since the 6<sup>th</sup> fly did not sufficiently sample all heading quadrants for a wide enough range of rotational velocities). For each of the 1000 shuffling repetitions, a cell’s spike train was chopped into 1s fragments that were randomly re-assembled. The shuffled instance of the two tuning indices was calculated using the scrambled spike train. The significance level was set at the 95<sup>th</sup> percentile of the shuffled rotation and heading indices.</p></sec><sec id="s4-15"><title>Epoch identification, conditional tuning curves, conditional tuning indices</title><p>Experimental epochs for analysis of heading tuning stability and extraction of conditional tuning curves were identified as follows: All recordings were partitioned in five minute trials for which two-dimensional sample size matrices were constructed as described above (see <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1B</xref>) and visually inspected for non-zero bin counts within a rectangular portion of this matrix that spanned all heading angles and at least 250°/s width of rotational velocities. Practically, we thus selected for epochs in which the flies rotated vigorously on the ball, visiting all possible heading quadrants by balanced turning about the right and left body axis. In one case, two such five minute trials were concatenated to obtain sufficient sampling. The same shuffling procedure as described above was performed for the experimental epochs, except that trials were now chopped in 0.5 s fragments. 6/7 epochs passed the significance threshold (p-value of the failed epoch: p=0.193).</p><p>To generate conditional tuning curves for a neuron’s tuning to the fly’s heading dependent on rotational velocity, separate tuning curves were fit to spike rate and membrane potential as a function of the fly’s heading for all epochs of positive versus negative rotational velocities, respectively. To generate conditional tuning curves for P-EN tuning to rotations, separate tuning curves were fit to the fly’s spike rate and membrane potential as a function of the rotational velocity for epochs when the fly’s virtual heading was aligned with the neuron’s preferred versus non-preferred heading quadrant. The preferred heading quadrant was determined from the unconditional tuning curve containing all data points (see <xref ref-type="fig" rid="fig5">Figure 5C</xref> for an example) and defined as all bins where the firing rate exceeded the half-maximal positive modulation, that is, the baseline (defined as the median firing rate across bins) plus half the difference between baseline and peak firing rate. The non-preferred quadrant was defined as all heading bins where the firing rate was below the median (see <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1D</xref> for visualization). Otherwise, the fitting procedure was the same as outlined above: Data was binned into non-overlapping 25 ms bins of data, spike rates were smoothed with a 1 s Gaussian window with a half-width of 0.3 s, membrane potential was 50 Hz low-pass filtered, rotational velocities were sorted in 12.5°/s bins, heading angles in 11.25° bins.</p><p>The calculation of conditional tuning indices was performed in an analogous fashion: The conditional rotation tuning index was defined as the R<sup>2</sup> value of the conditional tuning curve described above. The conditional heading tuning index was defined as the mean vector length of spike rates over all virtual heading angles, computed separately for rotations to the P-EN’s preferred versus non-preferred turn direction.</p><p>For quantifications presented in <xref ref-type="fig" rid="fig6">Figure 6E</xref>, rotational tuning was defined as the difference of the fitted neural response at −150 and 150°/s. Heading tuning was defined as the difference of the conditional tuning curves at the positions corresponding to the maximum and minimum of the unconditional tuning curve that was fitted to all data points irrespective of turn direction. To avoid blurring the boundaries of preferred and non-preferred heading quadrants over time, the analysis of conditional tuning curves presented in <xref ref-type="fig" rid="fig6">Figure 6</xref> was performed on the 5–10 min experimental epochs presented in <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1C</xref>. In one case where two separate epochs had been identified for the same cell, only the first one was included in the analysis. For the analysis of the relative differences in membrane potential versus spike rate modulation presented in <xref ref-type="fig" rid="fig6s1">Figure 6—figure supplement 1</xref>, we used these same epochs from all whole cell recordings (at most one per cell) plus the experiment averages of the two neurons that showed significant heading tuning over the course of the experiment, but no sufficient sampling during short epochs.</p></sec><sec id="s4-16"><title>Immunohistochemistry, clearing, mounting</title><p>Immunohistochemistry was performed largely as described in (<xref ref-type="bibr" rid="bib1">Aso et al., 2014</xref>), but with several exceptions. Standard dissection, fixation and rinse conditions were used, as outlined previously. The concentrations of the two primary antibodies were changed as follows: Rat a-FLAG was diluted at 1:100 and Rabbit a-HA at 1:600. In addition, the tissue was incubated in all three primary antibodies (the two noted above plus mouse α-bruchpilot) simultaneously, diluted in 5% goat serum (GS) in PBT 0.5% Triton X-100 in PBS at RT for four hours on a rotator and then for 48 hr at 4°C on a rotator. Following rinses, as outlined in (<xref ref-type="bibr" rid="bib1">Aso et al., 2014</xref>), tissue was incubated simultaneously in secondary antibodies ATTO647N goat a-rat IgG (1:150; H and L; Rockland # 612-156-120) and CY3 goat a-rabbit (1:1000; Jackson Immuno Research # 111-165-144) for 4 hr at RT and then 2–3 days at 4°, both incubations on a rotator. Following immunohistochemistry, tissue was post-fixed and rinsed, then mounted on coverslips for further processing. Tissue was dehydrated through an ethanol series, then rinsed in xylene before embedding in DPX mounting medium (Electron Microscopy Sciences, Hatfield, PA). Embedded tissue was dried for two days before imaging.</p></sec><sec id="s4-17"><title>Microscopy and image analysis</title><p>Images were acquired using a Zeiss LSM 710 confocal microscope and a Plan-Apochromat 63x/NA1.4 oil immersion objective. Frame sizes were 1024 × 1024 pixels with a voxel size of 0.19 x 0.19 × 0.38 micrometers, a zoom factor of 0.8 and one frame average. The reference intensity was ramped throughout the depth of a given sample (reference channel not shown here), but the gain and power for the two data channels (synaptic and membrane) were maintained at constant levels within each sample.</p><p>Confocal stacks were viewed and analyzed in the image-viewing software ‘Janelia Workstation’ (S Murphy; K Rokicki; C Bruns; Y Yu; L Foster; E Trautman; D Olbris; T Wolff; A Nern; Y Aso; N Clack; P Davies; S Kravitz; T Safford, unpublished). Since the red channel (synaptotagmin) was weak, the signal was artificially yet uniformly enhanced in the Janelia Workstation so as to be able to see staining in the ellipsoid body, noduli and the protocerebral bridge: this was done only for the P-EN neurons. Additional image processing was not necessary for the E-PG image. The membrane staining (blue) was robust and this channel was not enhanced in the images shown.</p><p>As the R37F06 line weakly expresses PB<sub>G2-9</sub>.s-FB<italic>l</italic>3.b-NO<sub>2</sub>V.b neurons in addition to the P-EN neurons, we used a second GAL4 line, VT008135, for the synaptotagmin experiments. As confirmed by multicolor stochastic labeling images (data not shown), the only protocerebral bridge neurons targeted by this second line are the P-EN neurons. In the three P-EN brains that did not show obviously higher HA-tagged synaptotagmin in the ellipsoid body, expression was relatively weak in the ellipsoid body but still reasonably strong in the noduli. Over all of the brains, staining in the ellipsoid body was not consistently uniform: in most brains, only some tiles of the ellipsoid body were strongly stained.</p></sec><sec id="s4-18"><title>Functional connectivity</title><p>The brain and VNC were taken out of 5 to 8 days old female flies and laid on a poly-Lysine coated coverslip. The dissection was realized using the minimum level of illumination possible to avoid spurious activation of CsChrimson. Brains were then continuously perfused in a saline solution with 2 mM CaCl<sub>2</sub>, bubbled with carbogen (95% O<sub>2</sub>, 5% CO<sub>2</sub>) at 60 mL/hour throughout the experiment. Imaging was done on a two-photon scanning microscope (Prairie Technologies, Bruker). The excitation wavelength was 920 nm. P-EN neurons were imaged in the protocerebral bridge and noduli. E-PG neurons were imaged in the gall.</p><p>CsChrimson was excited with trains of 2 ms, 590 nm light pulses via an LED shining through the objective. Trains were delivered at 30 Hz. The number of pulses was varied between 1, 5, 10, 20 and 30. Only data obtained from 30-pulse stimulations are shown. Each experimental run consisted of 4 repeats, each approximately 20 s long. Runs were themselves repeated every 2 min (approximately). When present, responses did not desensitize.</p></sec><sec id="s4-19"><title>Calculation of fluorescence changes over ROIs</title><p>For two-color calcium imaging, each volume was collapsed into one maximum intensity image. Regions of interest (ROIs) were then defined over the average of the maximum intensity stacks. For the noduli, ellipses were manually drawn over each side. For the ellipsoid body, ellipses were drawn around the circumference of the P-EN or E-PG neurons and equi-angularly segmented into 16 regions. For the protocerebral bridge, the red and green channels were combined, and 18 polygonal regions of interest were drawn over the glomeruli. 1024 × 1024 pixel stacks consisting of 25–30 planes, each 2 μm apart, were obtained at ~50 mW of power at the end of each bridge experiment to facilitate glomeruli identification.</p><p>The stacks were then spatially smoothed using a two pixel wide Gaussian filter, and the mean fluorescence was calculated over each ROI for each maximum intensity image. The lowest 10% ROI means were computed, and all of the ROI means were then divided by the mean of these lowest values and filtered (Savitsky-Golay, third order polynomial) over 11 time steps to match the time scale of the behavior, thereby creating a final ΔF/F.</p><p>ΔF/F<sub>0</sub> was calculated for the functional connectivity as follows. F<sub>0</sub> was defined as the average signal before the stimulation. Regions of interest (ROI) were obtained by calculating the average projection of the movie and clustering pixels of the projection by a k-means algorithm between ROI and non-ROI pixels. It's worth noting that the selection method relies only on average intensity and not activity. This is because we want to use the same detection method for responsive and non-responsive runs. This also relies on selecting fields of view as unambiguously containing the neuron of interest — and only the neuron of interest — during the experiment.</p></sec><sec id="s4-20"><title>Red/Green channel separation</title><p>To test if the red channel was leaking into the green, or vice versa, the raw fluorescence of the noduli ROIs was compared between the red and green channels in flies that expressed GCaMP6f in the P-ENs and jRGECO1a in the E-PG neurons (<xref ref-type="fig" rid="fig8s1">Figure 8—figure supplement 1</xref>). No clear correlation was seen between the two. Additionally, the noduli were clearly visible in the green channel and nonexistent in the red, while the outer ellipsoid body was clear in the E-PG expressing red channel but not in the green. ROIs drawn around the noduli showed large fluorescence changes in the green and small responses in the red, while an ROI drawn in a region that overlapped the ellipsoid body E-PG processes showed large responses in the red and only small fluctuations in the green.</p></sec><sec id="s4-21"><title>Population vector average</title><p>The population vector average was calculating using the circ_mean function from the Circular Statistics Toolbox (See Data analysis, statistical methods below). For the ellipsoid body, 16 equiangular bins were used, between 0 and 2π, corresponding to the ROIs. For the protocerebral bridge, eight equiangular bins were used, again between 0 and 2π, corresponding to the eight glomeruli in which either the P-EN or the E-PG neurons arborize. The corresponding angle was then multiplied by 8/ (2π) to convert it back into an indicator of the number of the glomerulus.</p></sec><sec id="s4-22"><title>Statistics of the P-EN and E-PG protocerebral bridge bumps</title><p>For protocerebral bridge analysis, changes in the red and green fluorescence transients across the 18 ROIs were sorted into bins according to the rotational velocity at the time of imaging. The right bridge E-PG peak was then used for aligning both the left bridge E-PG signal and the P-EN signal on both sides. That is, for each frame, we drew ROIs corresponding to the estimated boundaries of the 18 bridge glomeruli (see Calculation of fluorescence changes over ROIs), circularly shifted the right ROI fluorescence transients around the nine rightmost protocerebral bridge glomeruli to place the right protocerebral bridge bump peak at glomerulus 14, and circularly shifted the left E-PG bump and the two P-EN bumps by the same offset around their corresponding protocerebral bridge halves. As the P-ENs only arborize in the outer 16 glomeruli and the E-PGs only arborize in the inner 16 glomeruli, the ‘empty’ glomeruli were skipped when shifting the ΔF/Fs for alignment. The population vector average of the mean P-EN and E-PG bump on each side was calculated, and the difference found. We also compared the peaks of the E-PG and P-EN traces, and the mean of the peak and PVA differences for all individual pairs of traces to confirm that the trends were consistent regardless of the statistic that was used. Bump amplitudes and half widths were found for each time point and then averaged.</p><p>Further, we confirmed that activity offsets were consistent regardless of which indicator combination labeled the two neural populations, arguing against the lag being merely a result of indicator kinetics (<xref ref-type="fig" rid="fig8">Figure 8G</xref>). Finally, the R37F06 line also contains PB<sub>G2-9</sub>.s-FB<italic>l</italic>3.b-NO<sub>2</sub>V.b neurons, and so we also compared offsets using a second GAL4 line, VT008135, which only expresses in the P-EN neurons in the bridge. The results were qualitatively the same and quantitatively similar (<xref ref-type="fig" rid="fig8s2">Figure 8—figure supplement 2</xref>).</p></sec><sec id="s4-23"><title>Statistics of the P-EN and E-PG ellipsoid body bumps</title><p>For the ellipsoid body experiments, the data were binned as described above with the exception that 16 equiangular ROIs were now used. The peak of the E-PG ROI was used for alignment, and the ROIs were circularly shifted to place the peak at position 8 (out of 16). The P-EN ROIs were shifted by the same amount to preserve the relative offset. All statistics were then calculated as described above for the protocerebral bridge. We again compared the two color directions and found that, while clear numerical discrepancies existed, all qualitative trends were the same (<xref ref-type="fig" rid="fig9s2">Figure 9—figure supplement 2</xref>).</p></sec><sec id="s4-24"><title>Data analysis, statistical methods</title><p>We used MATLAB (MathWorks, Inc., Natick, MA) and the Circular Statistics Toolbox (<xref ref-type="bibr" rid="bib4">Berens, 2009</xref>) for data analysis. All errors and error bars shown are standard deviation (SD). No statistical methods were used to predetermine sample size. Reported sample sizes refer to the number of flies throughout. One-way ANOVA was used for statistical comparisons between three or more groups, Student’s t-test was used to compare differences from zero or between two sets of paired data. Two-way ANOVA was used to compare different experimental groups across conditions.</p></sec><sec id="s4-25"><title>Firing rate model</title><p>Our model consists of three populations of neurons corresponding to the E-PG neurons, the P-EN neurons for the left side and the P-EN neurons for the right side. We assume that the E-PG neurons make excitatory synapses onto the P-EN neurons and that the P-EN neurons, in turn, make excitatory synapses onto the E-PG neurons. Finally, we assume global inhibition, a necessary requirement for obtaining localized bumps of activity. A third type of neuron implicitly mediates this interaction from the E-PG neurons to the P-EN neurons. The left and right P-EN populations contain nine neurons each (one neuron per protocerebral bridge glomerulus). Based on anatomical estimates (<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>), the E-PG population contains three neurons per protocerebral bridge glomerulus, and thus a total of 54 neurons (27 neurons per protocerebral bridge side). Note that some uncertainties remain regarding the topology of the circuit around the ventral side of the ellipsoid body and the medial and lateral-most protocerebral bridge glomeruli. The P-EN neurons are thought not to arborize in the most medial protocerebral bridge glomeruli, and the E-PG neurons are thought to skip the outermost protocerebral bridge glomeruli (although there is a class of E-PG neuron, the PB<sub>G9</sub>.b-EB.P.s-ga-t.b, that may help fill this gap [<xref ref-type="bibr" rid="bib36">Wolff et al., 2015</xref>]). Thus, it is still not entirely clear how the recurrent loop is closed all the way around the ring, something that we simplify in our model by assuming E-PG and P-EN neurons for each of the protocerebral bridge glomeruli.</p><p>Neural activity in each of the populations was modeled as a firing rate: <inline-formula><mml:math id="inf1"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> for the E-PG neurons connecting to the left protocerebral bridge, <inline-formula><mml:math id="inf2"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> for the E-PG neurons connecting to the right protocerebral bridge, <inline-formula><mml:math id="inf3"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>P</mml:mi><mml:mi>l</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> for the left P-EN neurons and <inline-formula><mml:math id="inf4"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>P</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> for the right P-EN neurons. The firing rates obeyed the following equations:<disp-formula id="equ5"><mml:math id="m5"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnalign="right left right left right left right left right left right left" columnspacing="0em 2em 0em 2em 0em 2em 0em 2em 0em 2em 0em" displaystyle="true" rowspacing="3pt"><mml:mlabeledtr><mml:mtd><mml:mtext>(23)</mml:mtext></mml:mtd><mml:mtd><mml:mi>τ</mml:mi><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac></mml:mtd><mml:mtd><mml:mi/><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi>α</mml:mi><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>P</mml:mi><mml:mi>l</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="thinmathspace"/><mml:msub><mml:mi>K</mml:mi><mml:mi>l</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>+</mml:mo></mml:msub></mml:mtd></mml:mlabeledtr><mml:mlabeledtr><mml:mtd><mml:mtext>(24)</mml:mtext></mml:mtd><mml:mtd><mml:mi>τ</mml:mi><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac></mml:mtd><mml:mtd><mml:mi/><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi>α</mml:mi><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mi>P</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="thinmathspace"/><mml:msub><mml:mi>K</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>+</mml:mo></mml:msub></mml:mtd></mml:mlabeledtr><mml:mlabeledtr><mml:mtd><mml:mtext>(25)</mml:mtext></mml:mtd><mml:mtd><mml:msub><mml:mi>τ</mml:mi><mml:mi>p</mml:mi></mml:msub><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:msub><mml:mi>P</mml:mi><mml:mi>l</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac></mml:mtd><mml:mtd><mml:mi/><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mi>l</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mfrac><mml:mi>α</mml:mi><mml:mn>3</mml:mn></mml:mfrac><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>m</mml:mi><mml:mo>∈</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="script">𝒩</mml:mi></mml:mrow><mml:mi>k</mml:mi><mml:mi>l</mml:mi></mml:msubsup></mml:mrow></mml:munder><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>m</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mfrac><mml:mi>β</mml:mi><mml:mi>N</mml:mi></mml:mfrac><mml:munder><mml:mo>∑</mml:mo><mml:mi>n</mml:mi></mml:munder><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msub><mml:mi>v</mml:mi><mml:mo>+</mml:mo></mml:msub></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>+</mml:mo></mml:msub></mml:mtd></mml:mlabeledtr><mml:mlabeledtr><mml:mtd><mml:mtext>(26)</mml:mtext></mml:mtd><mml:mtd><mml:msub><mml:mi>τ</mml:mi><mml:mi>p</mml:mi></mml:msub><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:msub><mml:mi>P</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac></mml:mtd><mml:mtd><mml:mi/><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mfrac><mml:mi>α</mml:mi><mml:mn>3</mml:mn></mml:mfrac><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>m</mml:mi><mml:mo>∈</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="script">𝒩</mml:mi></mml:mrow><mml:mi>k</mml:mi><mml:mi>r</mml:mi></mml:msubsup></mml:mrow></mml:munder><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>m</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mfrac><mml:mi>β</mml:mi><mml:mi>N</mml:mi></mml:mfrac><mml:munder><mml:mo>∑</mml:mo><mml:mi>n</mml:mi></mml:munder><mml:mi>E</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>n</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msub><mml:mi>v</mml:mi><mml:mo>−</mml:mo></mml:msub></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>+</mml:mo></mml:msub></mml:mtd></mml:mlabeledtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>where <inline-formula><mml:math id="inf5"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>τ</mml:mi><mml:mo>=</mml:mo><mml:mn>80</mml:mn><mml:mrow><mml:mtext>ms</mml:mtext></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> is the time constant of the E-PG neurons, <inline-formula><mml:math id="inf6"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>τ</mml:mi><mml:mi>p</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>65</mml:mn><mml:mrow><mml:mtext>ms</mml:mtext></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> is the time constant of the P-EN neurons, <inline-formula><mml:math id="inf7"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>α</mml:mi><mml:mo>=</mml:mo><mml:mn>10</mml:mn></mml:mrow></mml:mstyle></mml:math></inline-formula>, and <inline-formula><mml:math id="inf8"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>β</mml:mi><mml:mo>=</mml:mo><mml:mn>25.</mml:mn><mml:mtext> </mml:mtext><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> is the angular position of the P-EN neurons that project to the E-PG neuron at position <inline-formula><mml:math id="inf9"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>.</mml:mo><mml:mtext> </mml:mtext><mml:msubsup><mml:mi>N</mml:mi><mml:mi>k</mml:mi><mml:mi>l</mml:mi></mml:msubsup></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf10"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msubsup><mml:mi>N</mml:mi><mml:mi>k</mml:mi><mml:mi>r</mml:mi></mml:msubsup></mml:mrow></mml:mstyle></mml:math></inline-formula> are the sets of indices for the E-PG neurons that share a protocerebral bridge glomerulus with, respectively, the left or right P-EN neuron at position <inline-formula><mml:math id="inf11"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>.</mml:mo><mml:mtext> </mml:mtext><mml:msub><mml:mi>K</mml:mi><mml:mi>l</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf12"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>K</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> are kernels that describe overlapping connectivity between the E-PG and P-EN populations in the ellipsoid body: <inline-formula><mml:math id="inf13"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>K</mml:mi><mml:mi>l</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>θ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>θ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>κ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:mfrac><mml:mo>+</mml:mo><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>θ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msup><mml:mn>35</mml:mn><mml:mo>∘</mml:mo></mml:msup><mml:mo>,</mml:mo><mml:mi>κ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf14"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>K</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>θ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>θ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>κ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:mfrac><mml:mo>+</mml:mo><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>θ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:msup><mml:mn>35</mml:mn><mml:mo>∘</mml:mo></mml:msup><mml:mo>,</mml:mo><mml:mi>κ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula></p><p>where <inline-formula><mml:math id="inf15"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>θ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi><mml:mo>,</mml:mo><mml:mi>κ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> are von Mises distribution functions with <inline-formula><mml:math id="inf16"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>κ</mml:mi><mml:mo>=</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:mstyle></mml:math></inline-formula>:<disp-formula id="equ6"><mml:math id="m6"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>θ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi><mml:mo>,</mml:mo><mml:mi>κ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mi>κ</mml:mi><mml:mspace width="thinmathspace"/><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>s</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>θ</mml:mi><mml:mo>−</mml:mo><mml:mi>A</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msup><mml:mrow><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:msub><mml:mi>I</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>K</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>The inputs <inline-formula><mml:math id="inf17"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>v</mml:mi><mml:mo>+</mml:mo></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf18"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>v</mml:mi><mml:mo>−</mml:mo></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> are rectified velocities: <inline-formula><mml:math id="inf19"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>v</mml:mi><mml:mo>+</mml:mo></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mi>v</mml:mi><mml:msub><mml:mo stretchy="false">]</mml:mo><mml:mo>+</mml:mo></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf20"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>v</mml:mi><mml:mo>−</mml:mo></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mo>−</mml:mo><mml:mi>v</mml:mi><mml:msub><mml:mo stretchy="false">]</mml:mo><mml:mo>+</mml:mo></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula>.</p><p>The connectivity matrix of the circuit, corresponding to the previous equations, is shown in <xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1A</xref>. The time constants of the dynamics, <inline-formula><mml:math id="inf21"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>τ</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf22"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>τ</mml:mi><mml:mrow><mml:msub><mml:mi/><mml:mrow><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula>, were chosen to account for the experimentally observed phase shifts in the ellipsoid body and the protocerebral bridge. When a population receives a moving bump as its input, it responds with a spatially shifted moving bump. This phase shift is generally close to <inline-formula><mml:math id="inf23"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>τ</mml:mi><mml:mi>v</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula>, where <inline-formula><mml:math id="inf24"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>τ</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> is the time constant of the neural population and <inline-formula><mml:math id="inf25"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>v</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> is the angular velocity of the input. We see that this phase shift is proportional to the angular velocity. Moreover, the angular velocity at which the circuit can no longer track an input velocity and saturates is set by the total time constant and the structural phase shift of the circuit <inline-formula><mml:math id="inf26"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="normal">△</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> as follows: <inline-formula><mml:math id="inf27"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>ν</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mi>a</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi mathvariant="normal">Δ</mml:mi><mml:mrow/><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>τ</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mi>τ</mml:mi><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula>. Thus, <inline-formula><mml:math id="inf28"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>τ</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mi>τ</mml:mi><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> should be lower than 150 ms for the circuit to track velocity inputs of at least 200°/s. The particular values <inline-formula><mml:math id="inf29"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>τ</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf30"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>τ</mml:mi><mml:mrow><mml:mi>ρ</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> were then chosen to obtain the slopes of the phase shifts as a function of the input velocity (<xref ref-type="fig" rid="fig10">Figure 10D</xref>).</p><p>All simulations were performed with the python programming language, and all code is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/hrouault/ang_veloc_integr">https://github.com/hrouault/ang_veloc_integr</ext-link> (<xref ref-type="bibr" rid="bib25">Rouault, 2017</xref>), with a copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/ang_veloc_integr">https://github.com/elifesciences-publications/ang_veloc_integr</ext-link>.</p></sec><sec id="s4-26"><title>Generation of angular velocity tracks for measuring the simulation diffusion coefficient</title><p>The time auto-correlation functions recorded angular velocities were extracted and fitted by exponentials (<xref ref-type="fig" rid="fig10s2">Figure 10—figure supplement 2</xref>). From these fits, we found a time auto-correlation of 128 ms and a standard deviation of the angular velocity distribution of 54°/s.</p><p>In order to test the model over long times and to check for error scaling, we generated artificial angular tracks according to an Ornstein-Uhlenbeck process:<disp-formula id="equ7"><mml:math id="m7"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>τ</mml:mi><mml:mfrac><mml:mrow><mml:mi>d</mml:mi><mml:mi>υ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:mi>υ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:msqrt><mml:mn>2</mml:mn><mml:mi>τ</mml:mi></mml:msqrt><mml:mi>σ</mml:mi><mml:mi>η</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>where <inline-formula><mml:math id="inf31"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>η</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> is a Gaussian white noise of variance 1. We took the following parameters for this process: τ = 120 ms, σ = 50°/s.</p></sec><sec id="s4-27"><title>Measurement of the diffusion coefficient</title><p>We input to the network the result of the Ornstein-Uhlenbeck process <inline-formula><mml:math id="inf32"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>υ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> shown above. The circuit integrates this input, and the bump position, <inline-formula><mml:math id="inf33"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> is recorded over time. We then compared the angular position of the bump with the integrated velocity:<disp-formula id="equ8"><mml:math id="m8"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msubsup><mml:mo>∫</mml:mo><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msubsup><mml:mrow><mml:mi>υ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mi>d</mml:mi><mml:msup><mml:mi>t</mml:mi><mml:mo>′</mml:mo></mml:msup></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>At time scales on the order of the time scale of the circuit, about 200 ms, the difference <inline-formula><mml:math id="inf34"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mrow><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> has a finite variance due to the time delay between the input and the actual bump movement. At longer time scales, the behavior of this is diffusive.</p><p>The variance of the difference of angles is estimated from the generated trajectories (see <xref ref-type="fig" rid="fig10">Figure 10G</xref>) as follows:<disp-formula id="equ9"><mml:math id="m9"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>V</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>s</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfrac><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:munderover><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msubsup><mml:mi>θ</mml:mi><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:msubsup><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:msubsup><mml:mi>θ</mml:mi><mml:mi>b</mml:mi><mml:mi>k</mml:mi></mml:msubsup><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>And the uncertainty can be evaluated as:<disp-formula id="equ10"><mml:math id="m10"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>b</mml:mi></mml:msub><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mo>=</mml:mo><mml:mi>V</mml:mi><mml:mo>±</mml:mo><mml:mi>V</mml:mi><mml:msqrt><mml:mfrac><mml:mn>2</mml:mn><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>s</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfrac></mml:msqrt></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>We then fit the difference curve by the following equation:<disp-formula id="equ11"><mml:math id="m11"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>b</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mo>=</mml:mo><mml:msubsup><mml:mi>σ</mml:mi><mml:mn>0</mml:mn><mml:mn>2</mml:mn></mml:msubsup><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:mi>D</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>where we initialized the origin on <inline-formula><mml:math id="inf35"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>b</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> so that <inline-formula><mml:math id="inf36"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>θ</mml:mi><mml:mi>b</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mn>0</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mi>θ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mn>0</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula>.</p><p>We found <inline-formula><mml:math id="inf37"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>D</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula>= 1.82×10<sup>−3</sup> rad<sup>2</sup>/s and <inline-formula><mml:math id="inf38"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msubsup><mml:mi>σ</mml:mi><mml:mn>0</mml:mn><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mstyle></mml:math></inline-formula>= 1.27×10<sup>−3</sup> rad<sup>2</sup>.</p></sec><sec id="s4-28"><title>Linearity of the angular integration</title><p>We sought to evaluate the linearity of the angular velocity integration for our model (<xref ref-type="fig" rid="fig10s1">Figure 10—figure supplement 1B</xref>) as a function of the main parameters <inline-formula><mml:math id="inf39"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>α</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf40"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>β</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula>. When varying these parameters, we computed a velocity input-output curve similar to the one displayed in <xref ref-type="fig" rid="fig10">Figure 10E</xref>. We then computed the slope of this curve for low velocities, <inline-formula><mml:math id="inf41"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">l</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">n</mml:mi></mml:mrow></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula>, in the linear regime. We also computed the ratio of the input and output velocities at the onset of the saturation, <inline-formula><mml:math id="inf42"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula>. Our linearity values are expressed as follows:<disp-formula id="equ12"><mml:math id="m12"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>L</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:mrow></mml:msub><mml:msub><mml:mi>γ</mml:mi><mml:mrow><mml:mrow><mml:mi mathvariant="normal">l</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">n</mml:mi></mml:mrow></mml:mrow></mml:msub></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>By definition, if the integration is perfectly linear, <inline-formula><mml:math id="inf43"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> should be equal to 1. Note that this definition is correct because we are not varying <inline-formula><mml:math id="inf44"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>τ</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula>, <inline-formula><mml:math id="inf45"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>τ</mml:mi><mml:mi>p</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> or <inline-formula><mml:math id="inf46"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula>, and hence the value of the bump velocity at saturation does not vary.</p></sec><sec id="s4-29"><title>shi<sup>TS</sup> experiments</title><p>All trials were 2 min long and were performed in the dark. The E-PG neurons were imaged with a wavelength of 930 nm. The line VT025957 was used to image these neurons due to its strong GCaMP expression. The first three trials occurred at room temperature. Heated saline was then perfused across the brain until a temperature of 30°C was reached, as measured by a thermocouple placed near the head capsule. The fly was then shown successive 30 s bouts of clockwise and counterclockwise sine gratings for 5 min to evoke rotational optomotor responses, and the temperature was stabilized at 31°C. We used this 5 min period of turning at the restrictive temperature to accelerate depletion of the pool of P-EN synaptic vesicles. Nine more trials were then performed in the dark. Finally, the perfusion was stopped and the bath was allowed to cool down to 26°C. After waiting a further 10 min, six more trials were performed. The fly’s behavior was variable in the recovery experiments, with some flies continuing to run, some not moving at all, and many gradations in between. Further, the bump amplitude did not recover across all flies. We therefore decided not to include this data. Statistics for walking performance during imaging are available as part of <xref ref-type="supplementary-material" rid="SD2-data">Supplementary file 2</xref>.</p><p>Significance testing between 31°C distributions (shown in <xref ref-type="fig" rid="fig11">Figure 11D</xref>) was performed via bootstrapping. For each pair of datasets, the data of the two pairs were combined. Two new pairs, each with the same number of samples as the original pairs were then created from the combined data via random sampling with replacement. The difference of the means of the two new pairs was then calculated. This procedure was repeated 10,000 times to create a distribution of differences. The difference of the means of the original dataset was then compared to this distribution.</p><p>When comparing the change in heading to the change in PVA position for turns, we first defined turns as continuous periods where the rotational speed exceeded 15°/s. We then only considered turns where the PVA strength exceeded a certain threshold. This threshold was defined as follows: for the room temperature cases, where the flies primarily rotate on the ball without much forward walking, we expect the E-PG Ca<sup>2+</sup> activity to roughly scale with rotational speed. As flies exhibits roughly Gaussian distributions of rotational velocities, we would therefore expect the Ca<sup>2+</sup> activity to exhibit a half-Gaussian distribution over the course of the experiment. The calculated PVA strength will depend on this activity as follows: At low E-PG activity, the noise of the imaging will dominate the signal, leading to a range of low, but non-zero PVA strengths. During periods of high activity, the signal will dominate, leading to a clear bump and a high PVA strength. Thus, we would expect the PVA strength distribution to be peaked, with the values on the low side of the peak being dictated by noise and the values on the high side of the peak coming from the activity itself. We therefore chose a PVA strength threshold, 0.025, that reliably matched or exceeded the peak of the half-Gaussian distribution seen at higher PVA strengths, attributing values above that to the E-PG activity and values below that to the noise of the system.</p><p>Once we had selected turns where the PVA strength exceeded the threshold throughout the turn, we then calculated the change in heading and the change in PVA position over the course of the turn and plotted these values against one another. We fit the data with a linear regression model (using the fitlm function in MATLAB) and extracted the slopes and R<sup>2</sup> values.</p></sec></sec></body><back><ack id="ack"><title>Acknowledgements</title><p>We thank Yi Sun for advice on two-color calcium imaging, Martin Peek, Igor Negrashov and Bill Biddle for help in designing the fly holder for electrophysiology, Adam Taylor and David Ackerman for WaveSurfer development, Lakshmi Ramasamy for help with LabView programming, Scarlett Coffman, Karen Hibbard, and Todd Laverty for fly husbandry, Geoffrey Meissner and the Janelia FlyLight Project Team for brain dissections, histology and confocal imaging for the presynaptic marker experiments, Ellie Sterne for help searching the VT fly collection, Saba Ali, Jack McCarty, Arlo Sheridan, Claire Peterson, and Stanley Tran for useful discussions about the anatomy and structural connectivity of E-PG and P-EN neurons. We thank Ed Rogers and Michael Reiser for generously sharing unpublished fly lines for perturbation experiments. Sung Soo Kim, Hannah Haberkern, and Chuntao Dan provided experimental advice. Emily Nielson created the animation for <xref ref-type="other" rid="media1">Video 1</xref>. We are grateful to Glenn Turner, Michael Reiser, Eugenia Chiappe, Toshi Hige, Alice Robie, Eyal Gruntman, TJ Florence and members of Vivek's lab for useful discussions, and Arseny Finkelstein, Sandro Romani, and Lorenzo Fontolan for feedback on the manuscript. This work was supported by the Howard Hughes Medical Institute.</p></ack><sec id="s5" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="conflict" id="conf1"><p>The authors declare that no competing interests exist.</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>DT-E, Conceptualization, Data curation, Software, Formal analysis, Investigation, Visualization, Writing—original draft, Writing—review and editing, Performed and analyzed two-color calcium imaging and shibire silencing experiments</p></fn><fn fn-type="con" id="con2"><p>SW, Conceptualization, Data curation, Software, Investigation, Visualization, Writing—original draft, Writing—review and editing, Performed and analyzed electrophysiology experiments</p></fn><fn fn-type="con" id="con3"><p>HR, Conceptualization, Software, Formal analysis, Writing—original draft, Writing—review and editing, Performed all theoretical and modeling work</p></fn><fn fn-type="con" id="con4"><p>RF, Investigation, Writing—review and editing, Performed functional connectivity experiments</p></fn><fn fn-type="con" id="con5"><p>TW, Data curation, Writing—review and editing, Managed and analyzed presynaptic marker experiments</p></fn><fn fn-type="con" id="con6"><p>JDS, Conceptualization, Methodology, Performed pilot calcium imaging experiments that described angular velocity signals in P-EN neurons in the noduli</p></fn><fn fn-type="con" id="con7"><p>SD, Conceptualization, Writing—original draft</p></fn><fn fn-type="con" id="con8"><p>VJ, Conceptualization, Supervision, Visualization, Writing—original draft, Writing—review and editing</p></fn></fn-group></sec><sec id="s6" sec-type="supplementary-material"><title>Additional files</title><supplementary-material id="SD1-data"><object-id pub-id-type="doi">10.7554/eLife.23496.026</object-id><label>Supplementary file 1.</label><caption><title>Recording parameters of in vivo electrophysiology.</title><p>Listed are, for all in vivo electrophysiology experiments, the fly’s genotype, experimental condition, time spent walking, mean forward, absolute sideslip, and absolute rotational velocity as well as the range of rotational velocities displayed by the fly while walking. Spike rate and membrane potential (V<sub>m</sub>) at rest were determined for non-walking periods, maximum spike rates are computed for 50 ms windows. All previous parameters are reported as mean and standard deviation across one-minute windows of the entire experiment. The spike threshold is the membrane potential at the peak of the second derivative of the membrane potential before a spike and was determined for a subset of spikes measured at resting membrane potential. The apparent input resistance was computed from a single exponential fit to the decay phase of a depolarizing current pulse. The bias current is a constant current injected to compensate for the leak through the seal resistance, in some experiments this current was readjusted during the recording.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.026">http://dx.doi.org/10.7554/eLife.23496.026</ext-link></p></caption><media mime-subtype="docx" mimetype="application" xlink:href="elife-23496-supp1-v1.docx"/></supplementary-material><supplementary-material id="SD2-data"><object-id pub-id-type="doi">10.7554/eLife.23496.027</object-id><label>Supplementary file 2.</label><caption><title>Imaging genotypes and walking statistics.</title><p>Listed are, for all in vivo calcium imaging experiments, the fly’s genotype, temperature (in the case of the shi<sup>TS</sup> flies), percentage of time spent walking, mean forward, absolute sideslip, and absolute rotational velocity as well as the range of rotational velocities displayed by the fly while walking.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.027">http://dx.doi.org/10.7554/eLife.23496.027</ext-link></p></caption><media mime-subtype="docx" mimetype="application" xlink:href="elife-23496-supp2-v1.docx"/></supplementary-material></sec><ref-list><title>References</title> <ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Aso</surname><given-names>Y</given-names></name><name><surname>Hattori</surname><given-names>D</given-names></name><name><surname>Yu</surname><given-names>Y</given-names></name><name><surname>Johnston</surname><given-names>RM</given-names></name><name><surname>Iyer</surname><given-names>NA</given-names></name><name><surname>Ngo</surname><given-names>TT</given-names></name><name><surname>Dionne</surname><given-names>H</given-names></name><name><surname>Abbott</surname><given-names>LF</given-names></name><name><surname>Axel</surname><given-names>R</given-names></name><name><surname>Tanimoto</surname><given-names>H</given-names></name><name><surname>Rubin</surname><given-names>GM</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>The neuronal architecture of the mushroom body provides a logic for associative learning</article-title><source>eLife</source><volume>3</volume><elocation-id>e04577</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.04577</pub-id><pub-id pub-id-type="pmid">25535793</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bassett</surname><given-names>JP</given-names></name><name><surname>Taube</surname><given-names>JS</given-names></name></person-group><year iso-8601-date="2001">2001</year><article-title>Neural correlates for angular head velocity in the rat dorsal tegmental nucleus</article-title><source>Journal of Neuroscience</source><volume>21</volume><fpage>5740</fpage><lpage>5751</lpage><pub-id pub-id-type="pmid">11466446</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bender</surname><given-names>JA</given-names></name><name><surname>Pollack</surname><given-names>AJ</given-names></name><name><surname>Ritzmann</surname><given-names>RE</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Neural activity in the central complex of the insect brain is linked to locomotor changes</article-title><source>Current Biology</source><volume>20</volume><fpage>921</fpage><lpage>926</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2010.03.054</pub-id><pub-id pub-id-type="pmid">20451382</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Berens</surname><given-names>P</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>CircStat : a MATLAB toolbox for circular statistics</article-title><source>Journal of Statistical Software</source><volume>31</volume><pub-id pub-id-type="doi">10.18637/jss.v031.i10</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Boyan</surname><given-names>GS</given-names></name><name><surname>Liu</surname><given-names>Y</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Development of the neurochemical architecture of the central complex</article-title><source>Frontiers in Behavioral Neuroscience</source><volume>10</volume><elocation-id>167</elocation-id><pub-id pub-id-type="doi">10.3389/fnbeh.2016.00167</pub-id><pub-id pub-id-type="pmid">27630548</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chen</surname><given-names>TW</given-names></name><name><surname>Wardill</surname><given-names>TJ</given-names></name><name><surname>Sun</surname><given-names>Y</given-names></name><name><surname>Pulver</surname><given-names>SR</given-names></name><name><surname>Renninger</surname><given-names>SL</given-names></name><name><surname>Baohan</surname><given-names>A</given-names></name><name><surname>Schreiter</surname><given-names>ER</given-names></name><name><surname>Kerr</surname><given-names>RA</given-names></name><name><surname>Orger</surname><given-names>MB</given-names></name><name><surname>Jayaraman</surname><given-names>V</given-names></name><name><surname>Looger</surname><given-names>LL</given-names></name><name><surname>Svoboda</surname><given-names>K</given-names></name><name><surname>Kim</surname><given-names>DS</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Ultrasensitive fluorescent proteins for imaging neuronal activity</article-title><source>Nature</source><volume>499</volume><fpage>295</fpage><lpage>300</lpage><pub-id pub-id-type="doi">10.1038/nature12354</pub-id><pub-id pub-id-type="pmid">23868258</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dana</surname><given-names>H</given-names></name><name><surname>Mohar</surname><given-names>B</given-names></name><name><surname>Sun</surname><given-names>Y</given-names></name><name><surname>Narayan</surname><given-names>S</given-names></name><name><surname>Gordus</surname><given-names>A</given-names></name><name><surname>Hasseman</surname><given-names>JP</given-names></name><name><surname>Tsegaye</surname><given-names>G</given-names></name><name><surname>Holt</surname><given-names>GT</given-names></name><name><surname>Hu</surname><given-names>A</given-names></name><name><surname>Walpita</surname><given-names>D</given-names></name><name><surname>Patel</surname><given-names>R</given-names></name><name><surname>Macklin</surname><given-names>JJ</given-names></name><name><surname>Bargmann</surname><given-names>CI</given-names></name><name><surname>Ahrens</surname><given-names>MB</given-names></name><name><surname>Schreiter</surname><given-names>ER</given-names></name><name><surname>Jayaraman</surname><given-names>V</given-names></name><name><surname>Looger</surname><given-names>LL</given-names></name><name><surname>Svoboda</surname><given-names>K</given-names></name><name><surname>Kim</surname><given-names>DS</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Sensitive red protein calcium indicators for imaging neural activity</article-title><source>eLife</source><volume>5</volume><elocation-id>e12727</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.12727</pub-id><pub-id pub-id-type="pmid">27011354</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Daniels</surname><given-names>RW</given-names></name><name><surname>Gelfand</surname><given-names>MV</given-names></name><name><surname>Collins</surname><given-names>CA</given-names></name><name><surname>DiAntonio</surname><given-names>A</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Visualizing glutamatergic cell bodies and synapses in Drosophila larval and adult CNS</article-title><source>The Journal of Comparative Neurology</source><volume>508</volume><fpage>131</fpage><lpage>152</lpage><pub-id pub-id-type="doi">10.1002/cne.21670</pub-id><pub-id pub-id-type="pmid">18302156</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Denk</surname><given-names>W</given-names></name><name><surname>Briggman</surname><given-names>KL</given-names></name><name><surname>Helmstaedter</surname><given-names>M</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Structural neurobiology: missing link to a mechanistic understanding of neural computation</article-title><source>Nature Reviews Neuroscience</source><volume>13</volume><fpage>351</fpage><lpage>358</lpage><pub-id pub-id-type="doi">10.1038/nrn3169</pub-id><pub-id pub-id-type="pmid">22353782</pub-id></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Green</surname><given-names>J</given-names></name><name><surname>Adachi</surname><given-names>A</given-names></name><name><surname>Shah</surname><given-names>KK</given-names></name><name><surname>Hirokawa</surname><given-names>JD</given-names></name><name><surname>Magani</surname><given-names>PS</given-names></name><name><surname>Maimon</surname><given-names>G</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>A neural circuit architecture for angular integration in Drosophila</article-title><source>Nature</source><volume>36</volume><pub-id pub-id-type="doi">10.1038/nature22343</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Guo</surname><given-names>P</given-names></name><name><surname>Ritzmann</surname><given-names>RE</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Neural activity in the central complex of the cockroach brain is linked to turning behaviors</article-title><source>Journal of Experimental Biology</source><volume>216</volume><fpage>992</fpage><lpage>1002</lpage><pub-id pub-id-type="doi">10.1242/jeb.080473</pub-id><pub-id pub-id-type="pmid">23197098</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hale</surname><given-names>ME</given-names></name><name><surname>Katz</surname><given-names>HR</given-names></name><name><surname>Peek</surname><given-names>MY</given-names></name><name><surname>Fremont</surname><given-names>RT</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Neural circuits that drive startle behavior, with a focus on the mauthner cells and spiral fiber neurons of fishes</article-title><source>Journal of Neurogenetics</source><volume>30</volume><fpage>89</fpage><lpage>100</lpage><pub-id pub-id-type="doi">10.1080/01677063.2016.1182526</pub-id><pub-id pub-id-type="pmid">27302612</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hartmann</surname><given-names>G</given-names></name><name><surname>Wehner</surname><given-names>R</given-names></name></person-group><year iso-8601-date="1995">1995</year><article-title>The ant's path integration system: a neural architecture</article-title><source>Biological Cybernetics</source><volume>73</volume><fpage>483</fpage><lpage>497</lpage><pub-id pub-id-type="doi">10.1007/s004220050204</pub-id></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ito</surname><given-names>K</given-names></name><name><surname>Shinomiya</surname><given-names>K</given-names></name><name><surname>Ito</surname><given-names>M</given-names></name><name><surname>Armstrong</surname><given-names>JD</given-names></name><name><surname>Boyan</surname><given-names>G</given-names></name><name><surname>Hartenstein</surname><given-names>V</given-names></name><name><surname>Harzsch</surname><given-names>S</given-names></name><name><surname>Heisenberg</surname><given-names>M</given-names></name><name><surname>Homberg</surname><given-names>U</given-names></name><name><surname>Jenett</surname><given-names>A</given-names></name><name><surname>Keshishian</surname><given-names>H</given-names></name><name><surname>Restifo</surname><given-names>LL</given-names></name><name><surname>Rössler</surname><given-names>W</given-names></name><name><surname>Simpson</surname><given-names>JH</given-names></name><name><surname>Strausfeld</surname><given-names>NJ</given-names></name><name><surname>Strauss</surname><given-names>R</given-names></name><name><surname>Vosshall</surname><given-names>LB</given-names></name><collab>Insect Brain Name Working Group</collab></person-group><year iso-8601-date="2014">2014</year><article-title>A systematic nomenclature for the insect brain</article-title><source>Neuron</source><volume>81</volume><fpage>755</fpage><lpage>765</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2013.12.017</pub-id><pub-id pub-id-type="pmid">24559671</pub-id></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jenett</surname><given-names>A</given-names></name><name><surname>Rubin</surname><given-names>GM</given-names></name><name><surname>Ngo</surname><given-names>TT</given-names></name><name><surname>Shepherd</surname><given-names>D</given-names></name><name><surname>Murphy</surname><given-names>C</given-names></name><name><surname>Dionne</surname><given-names>H</given-names></name><name><surname>Pfeiffer</surname><given-names>BD</given-names></name><name><surname>Cavallaro</surname><given-names>A</given-names></name><name><surname>Hall</surname><given-names>D</given-names></name><name><surname>Jeter</surname><given-names>J</given-names></name><name><surname>Iyer</surname><given-names>N</given-names></name><name><surname>Fetter</surname><given-names>D</given-names></name><name><surname>Hausenfluck</surname><given-names>JH</given-names></name><name><surname>Peng</surname><given-names>H</given-names></name><name><surname>Trautman</surname><given-names>ET</given-names></name><name><surname>Svirskas</surname><given-names>RR</given-names></name><name><surname>Myers</surname><given-names>EW</given-names></name><name><surname>Iwinski</surname><given-names>ZR</given-names></name><name><surname>Aso</surname><given-names>Y</given-names></name><name><surname>DePasquale</surname><given-names>GM</given-names></name><name><surname>Enos</surname><given-names>A</given-names></name><name><surname>Hulamm</surname><given-names>P</given-names></name><name><surname>Lam</surname><given-names>SC</given-names></name><name><surname>Li</surname><given-names>HH</given-names></name><name><surname>Laverty</surname><given-names>TR</given-names></name><name><surname>Long</surname><given-names>F</given-names></name><name><surname>Qu</surname><given-names>L</given-names></name><name><surname>Murphy</surname><given-names>SD</given-names></name><name><surname>Rokicki</surname><given-names>K</given-names></name><name><surname>Safford</surname><given-names>T</given-names></name><name><surname>Shaw</surname><given-names>K</given-names></name><name><surname>Simpson</surname><given-names>JH</given-names></name><name><surname>Sowell</surname><given-names>A</given-names></name><name><surname>Tae</surname><given-names>S</given-names></name><name><surname>Yu</surname><given-names>Y</given-names></name><name><surname>Zugates</surname><given-names>CT</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>A GAL4-driver line resource for Drosophila neurobiology</article-title><source>Cell Reports</source><volume>2</volume><fpage>991</fpage><lpage>1001</lpage><pub-id pub-id-type="doi">10.1016/j.celrep.2012.09.011</pub-id><pub-id pub-id-type="pmid">23063364</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kakaria</surname><given-names>KS</given-names></name><name><surname>de Bivort</surname><given-names>BL</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Ring attractor dynamics emerge from a spiking model of the entire protocerebral bridge</article-title><source>Frontiers in Behavioral Neuroscience</source><volume>11</volume><elocation-id>8</elocation-id><pub-id pub-id-type="doi">10.3389/fnbeh.2017.00008</pub-id><pub-id pub-id-type="pmid">28261066</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kim</surname> <given-names>SS</given-names></name><name><surname>Rouault</surname><given-names>H</given-names></name><name><surname>Druckmann</surname><given-names>S</given-names></name><name><surname>Jayaraman</surname><given-names>V</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Ring attractor dynamics in the Drosophila central brain</article-title><source>Science</source><elocation-id>eaal4835</elocation-id><pub-id pub-id-type="doi">10.1126/science.aal4835</pub-id><pub-id pub-id-type="pmid">28473639</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kitamoto</surname><given-names>T</given-names></name></person-group><year iso-8601-date="2001">2001</year><article-title>Conditional modification of behavior in Drosophila by targeted expression of a temperature-sensitive shibire allele in defined neurons</article-title><source>Journal of Neurobiology</source><volume>47</volume><fpage>81</fpage><lpage>92</lpage><pub-id pub-id-type="doi">10.1002/neu.1018</pub-id><pub-id pub-id-type="pmid">11291099</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Klapoetke</surname><given-names>NC</given-names></name><name><surname>Murata</surname><given-names>Y</given-names></name><name><surname>Kim</surname><given-names>SS</given-names></name><name><surname>Pulver</surname><given-names>SR</given-names></name><name><surname>Birdsey-Benson</surname><given-names>A</given-names></name><name><surname>Cho</surname><given-names>YK</given-names></name><name><surname>Morimoto</surname><given-names>TK</given-names></name><name><surname>Chuong</surname><given-names>AS</given-names></name><name><surname>Carpenter</surname><given-names>EJ</given-names></name><name><surname>Tian</surname><given-names>Z</given-names></name><name><surname>Wang</surname><given-names>J</given-names></name><name><surname>Xie</surname><given-names>Y</given-names></name><name><surname>Yan</surname><given-names>Z</given-names></name><name><surname>Zhang</surname><given-names>Y</given-names></name><name><surname>Chow</surname><given-names>BY</given-names></name><name><surname>Surek</surname><given-names>B</given-names></name><name><surname>Melkonian</surname><given-names>M</given-names></name><name><surname>Jayaraman</surname><given-names>V</given-names></name><name><surname>Constantine-Paton</surname><given-names>M</given-names></name><name><surname>Wong</surname><given-names>GK</given-names></name><name><surname>Boyden</surname><given-names>ES</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Independent optical excitation of distinct neural populations</article-title><source>Nature Methods</source><volume>11</volume><fpage>338</fpage><lpage>346</lpage><pub-id pub-id-type="doi">10.1038/nmeth.2836</pub-id><pub-id pub-id-type="pmid">24509633</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Knierim</surname><given-names>JJ</given-names></name><name><surname>Zhang</surname><given-names>K</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Attractor dynamics of spatially correlated neural activity in the limbic system</article-title><source>Annual Review of Neuroscience</source><volume>35</volume><fpage>267</fpage><lpage>285</lpage><pub-id pub-id-type="doi">10.1146/annurev-neuro-062111-150351</pub-id><pub-id pub-id-type="pmid">22462545</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Konishi</surname><given-names>M</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>Behavioral guides for sensory neurophysiology</article-title><source>Journal of Comparative Physiology A</source><volume>192</volume><fpage>671</fpage><lpage>676</lpage><pub-id pub-id-type="doi">10.1007/s00359-006-0097-6</pub-id><pub-id pub-id-type="pmid">16432726</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Martin</surname><given-names>JP</given-names></name><name><surname>Guo</surname><given-names>P</given-names></name><name><surname>Mu</surname><given-names>L</given-names></name><name><surname>Harley</surname><given-names>CM</given-names></name><name><surname>Ritzmann</surname><given-names>RE</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Central-complex control of movement in the freely walking cockroach</article-title><source>Current Biology</source><volume>25</volume><fpage>2795</fpage><lpage>2803</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2015.09.044</pub-id><pub-id pub-id-type="pmid">26592340</pub-id></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Neuser</surname><given-names>K</given-names></name><name><surname>Triphan</surname><given-names>T</given-names></name><name><surname>Mronz</surname><given-names>M</given-names></name><name><surname>Poeck</surname><given-names>B</given-names></name><name><surname>Strauss</surname><given-names>R</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Analysis of a spatial orientation memory in Drosophila</article-title><source>Nature</source><volume>453</volume><fpage>1244</fpage><lpage>1247</lpage><pub-id pub-id-type="doi">10.1038/nature07003</pub-id><pub-id pub-id-type="pmid">18509336</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Reiser</surname><given-names>MB</given-names></name><name><surname>Dickinson</surname><given-names>MH</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>A modular display system for insect behavioral neuroscience</article-title><source>Journal of Neuroscience Methods</source><volume>167</volume><fpage>127</fpage><lpage>139</lpage><pub-id pub-id-type="doi">10.1016/j.jneumeth.2007.07.019</pub-id><pub-id pub-id-type="pmid">17854905</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Rouault</surname><given-names>H</given-names></name></person-group><year iso-8601-date="2017">2017</year><data-title>Angular velocity integration in a fly heading circuit</data-title><source>GitHub</source><version>d20978df4580dd215a7390957ccbcbd1ff5b6a60</version><uri xlink:href="https://github.com/hrouault/ang_veloc_integr">https://github.com/hrouault/ang_veloc_integr</uri></element-citation></ref><ref id="bib26"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Seelig</surname><given-names>JD</given-names></name><name><surname>Chiappe</surname><given-names>ME</given-names></name><name><surname>Lott</surname><given-names>GK</given-names></name><name><surname>Dutta</surname><given-names>A</given-names></name><name><surname>Osborne</surname><given-names>JE</given-names></name><name><surname>Reiser</surname><given-names>MB</given-names></name><name><surname>Jayaraman</surname><given-names>V</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Two-photon calcium imaging from head-fixed Drosophila during optomotor walking behavior</article-title><source>Nature Methods</source><volume>7</volume><fpage>535</fpage><lpage>540</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1468</pub-id><pub-id pub-id-type="pmid">20526346</pub-id></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Seelig</surname><given-names>JD</given-names></name><name><surname>Jayaraman</surname><given-names>V</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Feature detection and orientation tuning in the Drosophila central complex</article-title><source>Nature</source><volume>503</volume><fpage>262</fpage><lpage>266</lpage><pub-id pub-id-type="doi">10.1038/nature12601</pub-id><pub-id pub-id-type="pmid">24107996</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Seelig</surname><given-names>JD</given-names></name><name><surname>Jayaraman</surname><given-names>V</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Neural dynamics for landmark orientation and angular path integration</article-title><source>Nature</source><volume>521</volume><fpage>186</fpage><lpage>191</lpage><pub-id pub-id-type="doi">10.1038/nature14446</pub-id><pub-id pub-id-type="pmid">25971509</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Skaggs</surname><given-names>WE</given-names></name><name><surname>Knierim</surname><given-names>JJ</given-names></name><name><surname>Kudrimoti</surname><given-names>HS</given-names></name><name><surname>McNaughton</surname><given-names>BL</given-names></name></person-group><year iso-8601-date="1995">1995</year><article-title>A model of the neural basis of the rat's sense of direction</article-title><source>Advances in Neural Information Processing Systems</source><volume>7</volume><fpage>173</fpage><lpage>180</lpage><pub-id pub-id-type="pmid">11539168</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stackman</surname><given-names>RW</given-names></name><name><surname>Golob</surname><given-names>EJ</given-names></name><name><surname>Bassett</surname><given-names>JP</given-names></name><name><surname>Taube</surname><given-names>JS</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Passive transport disrupts directional path integration by rat head direction cells</article-title><source>Journal of Neurophysiology</source><volume>90</volume><fpage>2862</fpage><lpage>2874</lpage><pub-id pub-id-type="doi">10.1152/jn.00346.2003</pub-id><pub-id pub-id-type="pmid">12890795</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sun</surname><given-names>Y</given-names></name><name><surname>Nern</surname><given-names>A</given-names></name><name><surname>Franconville</surname><given-names>R</given-names></name><name><surname>Dana</surname><given-names>H</given-names></name><name><surname>Schreiter</surname><given-names>ER</given-names></name><name><surname>Looger</surname><given-names>LL</given-names></name><name><surname>Svoboda</surname><given-names>K</given-names></name><name><surname>Kim</surname><given-names>DS</given-names></name><name><surname>Hermundstad</surname><given-names>AM</given-names></name><name><surname>Jayaraman</surname><given-names>V</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Neural signatures of dynamic stimulus selection in Drosophila</article-title><source>Nature Neuroscience</source><volume>30</volume><fpage>181</fpage><lpage>207</lpage><pub-id pub-id-type="doi">10.1038/nn.4581</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Taube</surname><given-names>JS</given-names></name><name><surname>Muller</surname><given-names>RU</given-names></name><name><surname>Ranck</surname><given-names>JB</given-names></name></person-group><year iso-8601-date="1990">1990</year><article-title>Head-direction cells recorded from the postsubiculum in freely moving rats. I. description and quantitative analysis</article-title><source>Journal of Neuroscience</source><volume>10</volume><fpage>420</fpage><lpage>435</lpage><pub-id pub-id-type="pmid">2303851</pub-id></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Taube</surname><given-names>JS</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>The head direction signal: origins and sensory-motor integration</article-title><source>Annual Review of Neuroscience</source><volume>30</volume><fpage>181</fpage><lpage>207</lpage><pub-id pub-id-type="doi">10.1146/annurev.neuro.29.051605.112854</pub-id><pub-id pub-id-type="pmid">17341158</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Thum</surname><given-names>AS</given-names></name><name><surname>Knapek</surname><given-names>S</given-names></name><name><surname>Rister</surname><given-names>J</given-names></name><name><surname>Dierichs-Schmitt</surname><given-names>E</given-names></name><name><surname>Heisenberg</surname><given-names>M</given-names></name><name><surname>Tanimoto</surname><given-names>H</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>Differential potencies of effector genes in adult Drosophila</article-title><source>The Journal of Comparative Neurology</source><volume>498</volume><fpage>194</fpage><lpage>203</lpage><pub-id pub-id-type="doi">10.1002/cne.21022</pub-id><pub-id pub-id-type="pmid">16856137</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Varga</surname><given-names>AG</given-names></name><name><surname>Ritzmann</surname><given-names>RE</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Cellular basis of head direction and contextual cues in the insect brain</article-title><source>Current Biology</source><volume>26</volume><fpage>1816</fpage><lpage>1828</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2016.05.037</pub-id><pub-id pub-id-type="pmid">27397888</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wolff</surname><given-names>T</given-names></name><name><surname>Iyer</surname><given-names>NA</given-names></name><name><surname>Rubin</surname><given-names>GM</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Neuroarchitecture and neuroanatomy of the <italic>Drosophila</italic> central complex: a GAL4-based dissection of protocerebral bridge neurons and circuits</article-title><source>Journal of Comparative Neurology</source><volume>523</volume><fpage>997</fpage><lpage>1037</lpage><pub-id pub-id-type="doi">10.1002/cne.23705</pub-id><pub-id pub-id-type="pmid">25380328</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Xie</surname><given-names>X</given-names></name><name><surname>Hahnloser</surname><given-names>RH</given-names></name><name><surname>Seung</surname><given-names>HS</given-names></name></person-group><year iso-8601-date="2002">2002</year><article-title>Double-ring network model of the head-direction system</article-title><source>Physical Review E</source><volume>66</volume><elocation-id>041902</elocation-id><pub-id pub-id-type="doi">10.1103/PhysRevE.66.041902</pub-id><pub-id pub-id-type="pmid">12443230</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yang</surname><given-names>HH</given-names></name><name><surname>St-Pierre</surname><given-names>F</given-names></name><name><surname>Sun</surname><given-names>X</given-names></name><name><surname>Ding</surname><given-names>X</given-names></name><name><surname>Lin</surname><given-names>MZ</given-names></name><name><surname>Clandinin</surname><given-names>TR</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Subcellular imaging of voltage and calcium signals reveals neural processing in vivo</article-title><source>Cell</source><volume>166</volume><fpage>245</fpage><lpage>257</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2016.05.031</pub-id><pub-id pub-id-type="pmid">27264607</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yoshida</surname><given-names>M</given-names></name><name><surname>Hasselmo</surname><given-names>ME</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Persistent firing supported by an intrinsic cellular mechanism in a component of the head direction system</article-title><source>Journal of Neuroscience</source><volume>29</volume><fpage>4945</fpage><lpage>4952</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.5154-08.2009</pub-id><pub-id pub-id-type="pmid">19369563</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>K</given-names></name></person-group><year iso-8601-date="1996">1996</year><article-title>Representation of spatial orientation by the intrinsic dynamics of the head-direction cell ensemble: a theory</article-title><source>Journal of Neuroscience</source><volume>16</volume><fpage>2112</fpage><lpage>2126</lpage><pub-id pub-id-type="pmid">8604055</pub-id></element-citation></ref></ref-list></back><sub-article article-type="article-commentary" id="SA1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.23496.030</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Borst</surname><given-names>Alexander</given-names></name><role>Reviewing editor</role><aff><institution>Max Planck Institute of Neurobiology</institution>, <country>Germany</country></aff></contrib></contrib-group></front-stub><body><boxed-text><p>In the interests of transparency, eLife includes the editorial decision letter and accompanying author responses. A lightly edited version of the letter sent to the authors after peer review is shown, indicating the most substantive concerns; minor comments are not usually included.</p></boxed-text><p>Thank you for submitting your article &quot;Angular velocity integration in a fly heading circuit&quot; for consideration by <italic>eLife</italic>. Your article has been reviewed by three peer reviewers, one of whom, Alexander Borst (Reviewer #1), is a member of our Board of Reviewing Editors, and the evaluation has been overseen by K VijayRaghavan as the Senior Editor. The following individual involved in review of your submission has agreed to reveal their identity: Andreas V M Herz (Reviewer #2).</p><p>The reviewers have discussed the reviews with one another and the Reviewing Editor has drafted this decision to help you prepare a revised submission.</p><p>Summary</p><p>This is a magnificent paper! Based on a clear-cut hypothesis for the neural mechanism underlying head-direction coding in the ellipsoid body of the fly, Turner-Evans et al. continue their discovery story about the neural network underlying spatial navigation in <italic>Drosophila</italic>. Previously, they reported on a neural population termed 'compass neurons' that tracks the fly's heading orientation in visual surrounds and in darkness. Here, they show a novel cell population that is both pre- (in one neuropil) and postsynaptic (in another neuropil) to the compass neurons and moves the activity bump of the compass neurons in darkness, an elegant mechanism to update the fly's heading representation during turns. The study addresses a timely question and has been carried out with great care. It is technically at the highest level, comprising state-of-the-art genetics, voltage recording, calcium imaging and modeling. Given the unresolved neural mechanisms underlying head-direction signaling in vertebrates, this paper provides an important advance toward resolving that question by focusing on the simpler insect organism. In summary, Turner-Evans et al. present an excellent piece of modern systems neuroscience and provide a very interesting solution to a key problem in spatial navigation.</p><p>Major Comments</p><p>There is an overwhelming amount of supplementary figures. Some supplementary figures could be merged with the respective main figures. Other supplementary figures do not seem to be entirely necessary. Figure 2—figure supplement 1 could be moved to . Figure 3—figure supplement 1, Figure 3—figure supplement 4, Figure 3—figure supplement 5, Figure 3—figure supplement 6, , Figure 7—figure supplement 4 could be removed and, if not already the case, some of the information from these figures could be mentioned in the main text or Materials and methods section.</p><p>A lot of text is used to interpret the anatomy of both E-PG and P-EN neurons in terms of their polarity. Why haven't the authors used a presynaptic marker to show that directly?</p><p>As the authors mention, it is counterintuitive that the activity bump of E-PNs lags the E-PG bump in the PCB, but leads it in the EB. Based on the conceptual model and the anatomy it would be expected that both bumps overlap in the PCB. Do the data indicate that the peak of the E-PN bump in the PCB is formed by different E-PN cells than the E-PN bump in the EB, and thus that the location of the bump is different for E-PN dendrites versus axons? This was not entirely clear to me.</p><p>Subsection “P-EN spiking activity and membrane potential dynamics encode changes in angular velocity”: It is an interesting finding that the coding bandwidth of P-ENs corresponds with the behavioral bandwidth. Was this expected? Does the bandwidth of heading angles in E-PGs in darkness also correlate with behavioral bandwidth? Is every single glomerulus of the PCB only innervated by one P-EN and one E-PG neuron, or by multiple neurons of the same type? If so, different neurons innervating the same glomerulus could have different bandwidths. This point should be discussed more extensively.</p><p><xref ref-type="fig" rid="fig1">Figure 1B</xref>: Please show a single E-PG neuron. Also, a connectivity map of the bridge and the ellipsoid body like <xref ref-type="fig" rid="fig6">Figure 6</xref> in Hanesch et al., 1989, or <xref ref-type="fig" rid="fig3">Figure 3</xref> of the authors in their Current Biology article 2016 would be helpful. Along these lines, some words about the intriguing bilateral asymmetry of this structure could be included in the discussion.</p><p>For <xref ref-type="fig" rid="fig2">Figure 2</xref> the behavioral trace was convolved with the GCamP6f filter before correlation with the calcium signals in the noduli. In my understanding this was not done for the dual color calcium experiments in <xref ref-type="fig" rid="fig7">Figure 7</xref> and <xref ref-type="fig" rid="fig8">Figure 8</xref>. Why not? Maybe this would account for the quantitative differences in the PVA offsets for the different indicator combinations.</p><p><xref ref-type="fig" rid="fig1">Figures 1</xref>, <xref ref-type="fig" rid="fig2">2</xref>, and 8 provide partial sketches about the system's connectivity but I missed a comprehensive wiring diagram: Which P glomerulus projects via P-ENs to which of the 8 tile-shaped sectors of the ellipsoid body, and which of the 16 wedge-shaped sectors of the ellipsoid body projects via E-PGs to which glomerulus? In particular, one would like to know how successive tile-shaped sectors overlap – I assume by one wedge, but these important details do not seem to be addressed in the manuscript (the movie touches a bit on these issues but can't provide a good solution).</p><p>The authors use the population vector to decode the heading direction from the E-PG activity. It would be great if they could elaborate on that concept and discuss whether the PV is also calculated by the fly (and if so: where) or whether the PV is simply a method for the experimentalist to study E-PG activity (if so: does the animal estimate its heading direction, and if so: how?)</p><p>Definition of the model system: the notation, e.g., <italic>ω(Θ<sub>i</sub>,t)</italic> or the <italic>∂<sub>t</sub> ω</italic>, suggests a system of partial differential equations, in contrast to the finite number of neurons (54) in each cell population. This approach also suggests that each cell population is continuous, i.e. without the notion of wedges or tiles with (more or less) homogeneous populations within each sector. In addition, the model does not distinguish between the larger tiles and smaller wedges – in fact, 54 is not divisible by 8 so this choice remains a bit mysterious. On the other hand, the authors' compact model is appealing. But one would like to see a detailed discussion on how the model relates to the experimental (in particular: anatomical) facts.</p><p>Predictions of the model system: it would be nice if the authors could run a simulation with time-dependent velocity input, similar to the experimental situation shown in <xref ref-type="fig" rid="fig1">Figure 1E</xref>. This would greatly help to appreciate the model's predictive power and could be included as a separate new panel in <xref ref-type="fig" rid="fig8">Figure 8</xref>.</p><p>Figure 2—figure supplement 1: Why are there negative correlation coefficients for CCW in the left nodulus (and for CW in the right nodulus)? Could this phenomenon hint at a pull-push mechanism, with pull (excitation) in front of the E-PG bump and push (inhibition) behind it?</p><p>Interestingly, several features of the P-EN neurons do not fit well with the hypothetic wiring scheme, while other, yet unknown neural elements, still need to be identified in order to fully explain the neural network involved in head direction coding. I suggest addressing these issues more clearly and openly in the discussion, in particular the apparent lack of visual responses in P-EN neurons and the unexpected one-glomerulus shift of P-EN activity following the E-PG activity as these will guide future efforts to unravel the missing elements in the mechanisms of head-direction coding.</p><p>Why do the authors use the term &quot;glomerulus&quot; for substructures in the protocerebral bridge that Ito et al., 2014, in a widely accepted intention for a uniform nomenclature of insect brain structures have termed &quot;slice&quot; instead? The term &quot;glomerulus&quot; has originally been used to denote substructures in the antennal lobe/olfactory bulb that are reminiscent in organization to a kidney glomerulus (shell and core). Nothing like this is apparent in the slices of the protocerebral bridge and using the term &quot;glomerulus&quot; instead might cause confusion about its internal organization. By the way, the term has only been used in flies and not in other insect species, which is again highly unfortunate. Therefore, I suggest changing the term &quot;glomerulus&quot; to the widely accepted term &quot;slice&quot;.</p><p>Subsection “An excitatory loop between P-ENs and E-PGs”. It is highly surprising to see that the P-EN neurons apparently do not respond to visual cues. Unfortunately, only two experiments are provided to support this (Figure 3—figure supplement 2). If this is correct, however, the P-EN neurons cannot receive synaptic input (directly or indirectly) from E-PG neurons in the ellipsoid body, because their signaling as shown by Seelig and Jayaraman (2013, 2015) is dominated by visual over proprioceptive feedback cues. This may be the reason why activation of the E-PG neurons resulted in inconclusive responses in P-EN neurons. I think this discrepancy in the results should be more clearly addressed in the discussion. In other insect species there are multiple sets of P-EN and E-PG neurons (e.g. in locust 3 sets of EPG neurons termed CL1 and 2 sets of PEN neurons termed CL2, partly with opposite polarity). How is it in flies? If the situation is similar, these second or third set, not studied here, will likewise contribute to compass coding, and might be in part responsible for the discrepancies between hypotheses and results.</p></body></sub-article><sub-article article-type="reply" id="SA2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.23496.031</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><p><italic>Major Comments</italic> </p><p><italic>There is an overwhelming amount of supplementary figures. Some supplementary figures could be merged with the respective main figures. Other supplementary figures do not seem to be entirely necessary. Figure 2—figure supplement 1 could be moved to <xref ref-type="fig" rid="fig2">Figure 2</xref>.Figure 3—figure supplement 1</italic>, <italic>Figure 3—figure supplement 4</italic>, <italic>Figure 3—figure supplement 5</italic>, <italic>Figure 3—figure supplement 6, <xref ref-type="fig" rid="fig6s1">Figure 6—figure supplement 1</xref>, Figure 7—figure supplement 4 could be removed and, if not already the case, some of the information from these figures could be mentioned in the main text or Materials and methods section.</italic> </p><p>We have largely followed the reviewers’ suggestions and removed non-essential data plots from the manuscript. To follow the e<italic>Life</italic> recommendations for figure size and complexity, we have further split <xref ref-type="fig" rid="fig3">Figure 3</xref> (into the new <xref ref-type="fig" rid="fig3">Figure 3</xref> and <xref ref-type="fig" rid="fig4">4</xref>) and <xref ref-type="fig" rid="fig4">Figure 4</xref> (into the new <xref ref-type="fig" rid="fig5">Figure 5</xref> and <xref ref-type="fig" rid="fig6">6</xref>). We have removed a total of 10 out of 19 supplementary figures: We have merged Figure 2—figure supplement 1 with <xref ref-type="fig" rid="fig2">Figure 2</xref>. We have removed Figure 3—figure supplement 1, merged Figure 3—figure supplement 2 and 3 into the new <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref> and removed Figures 3—figure supplement 5, Figure 3—figure supplement 6, and Figure 7—figure supplement 4, moving the data to tables in the Materials and methods section where appropriate. We have integrated <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1</xref> into <xref ref-type="fig" rid="fig5">Figure 5</xref> (now <xref ref-type="fig" rid="fig7">Figure 7</xref>). We have simplified <xref ref-type="fig" rid="fig6s1">Figure 6—figure supplement 1</xref> and Figure 6—figure supplement 3 significantly (now <xref ref-type="fig" rid="fig8s1">Figure 8—figure supplement 1</xref> and <xref ref-type="fig" rid="fig8s2">Figure 8—figure supplement 2</xref>) and removed Figure 6—figure supplement 2, Figure 6—figure supplement 4, and Figure 7—figure supplement 3.</p><p><italic>A lot of text is used to interpret the anatomy of both E-PG and P-EN neurons in terms of their polarity. Why haven't the authors used a presynaptic marker to show that directly?</italic></p><p>We thank the reviewers for their suggestion. We followed their recommendation and used a presynaptic marker to map the polarity of E-PG and P-EN neurons (<xref ref-type="fig" rid="fig7">Figure 7A, B</xref>). We hope that ongoing EM reconstructions of E-PG and P-EN neurons will more firmly establish not just the morphology and polarity of these neurons, but also the connectivity of the circuit.</p><p><italic>As the authors mention, it is counterintuitive that the activity bump of E-PNs lags the E-PG bump in the PCB, but leads it in the EB. Based on the conceptual model and the anatomy it would be expected that both bumps overlap in the PCB. Do the data indicate that the peak of the E-PN bump in the PCB is formed by different E-PN cells than the E-PN bump in the EB, and thus that the location of the bump is different for E-PN dendrites versus axons? This was not entirely clear to me.</italic> </p><p>We understand the reviewer’s comments to express the concern “The offset in activity in the protocerebral bridge is counterintuitive based on how we have introduced the anatomy and the conceptual model” and the question “Can this offset be explained by different bump locations in the P-EN axons and dendrites?”</p><p>For their concern, the reviewers are correct to point out that the protocerebral bridge bump offset is inconsistent with our simple conceptual model as we have introduced it. We believe that the offset can be explained by a combination of factors, and we have attempted to clarify these factors in the text. To elaborate here:</p><p>1) Neural and synaptic time constants within the circuit may lead to an offset of E-PG and P-EN bump positions when the fly is walking. When the bump of activity is moving, the delay in the transfer of heading direction from the E-PG bump to the P-EN bump in the protocerebral bridge will cause the P-EN bump to show delayed movement with respect to the E-PG bump. This lag will manifest as an offset in the PVA of the two bumps, with the P-EN bump lagging the E-PG bump in the protocerebral bridge. This is precisely the effect we see in our model (<xref ref-type="fig" rid="fig9">Figure 9D</xref>, subsection “P-EN calcium activity in the ellipsoid body leads E-PG activity”).</p><p>2) As we mention in the Discussion section, we believe that connections between the E-PG neurons and the P-EN neurons in the protocerebral bridge may be both direct and indirect, and shaped by recurrent inhibition. In addition, our presynaptic markers cannot rule out that there might be additional connections from E-PG neurons to P-EN neurons in the ellipsoid body. These additional direct and indirect connections may increase the lag due to time constants and may also shift the P-EN bump position with respect to the E-PG bump (see the following paragraph for further discussion of this point).</p><p>To address the reviewer’s question (whether the protocerebral bridge and ellipsoid body bumps may represent the local activity of distinct P-EN neurons), we performed experiments where we simultaneously imaged E-PG activity in the ellipsoid body and the protocerebral bridge. We found the activity bumps in both neuropil to be consistent with anatomical projections (data not shown). The fact that the E-PG and P-EN bumps do not coincide in the protocerebral bridge has, we believe, to do with a dynamic equilibrium between the two populations. Given the anatomical shift between the E-PG and P-EN populations, we could expect to see a shift in the P-EN activity relative to the E-PG activity in either neuropil, the ellipsoid body or the protocerebral bridge. Our conceptual model assumed a direct transfer of activity in the protocerebral bridge and a resulting shift in the ellipsoid body. This is a “protocerebral-bridge-centric” view. An “ellipsoid-body-centric” view that focuses on information transfer in the ellipsoid body would predict different offsets: In this scenario, the P-EN bump would follow the E-PG bump on one side of the protocerebral bridge and lead it on the other. This would be consistent with our observed offset on the ipsilateral side of the bridge. The small shift in P-EN activity relative to E-PG activity in the ellipsoid body and the larger shift in the bridge could, in sum, equal the anatomical offset.</p><p>This does raise the question of why we observe a lag (instead of a lead) in the side of the bridge that is contralateral to the turn direction. It has to be said here that the calcium signal in this half of the protocerebral bridge (which increases with increasing turn velocity, see <xref ref-type="fig" rid="fig8">Figure 8E</xref>), is somewhat enigmatic to us as a whole. We know from the electrophysiology that spiking activity in the contralateral side of the bridge is suppressed with increasing turn velocities. This is in line with our calcium imaging results in the noduli (<xref ref-type="fig" rid="fig2">Figure 2</xref>). In the ellipsoid body, we cannot disambiguate the contra- and ipsilateral P-EN populations, though we assume that we only see Ca<sup>2+</sup> activity from the ipsilateral neurons. Thus, at this point, we cannot explain the P-EN calcium activity in the turn-contralateral side of the protocerebral bridge, neither with respect to intensity nor bump position. As we speculate in the Discussion section, we suspect that we may be imaging the synaptic inputs to the P-EN neurons in the protocerebral bridge rather than seeing a proxy for their spiking activity, which might explain both the intensity and the position of the contralateral bridge P-EN activity. However, the precise nature of these inputs is, at present, unknown to us.</p><p>Overall, we cannot yet estimate the relative contributions of these and perhaps other factors to the observed offsets between P-EN and E-PG bumps in the protocerebral bridge and recognize that this is a limitation of our study.</p><p><italic>Subsection “P-EN spiking activity and membrane potential dynamics encode changes in angular velocity”: It is an interesting finding that the coding bandwidth of P-ENs corresponds with the behavioral bandwidth. Was this expected? Does the bandwidth of heading angles in E-PGs in darkness also correlate with behavioral bandwidth? Is every single glomerulus of the PCB only innervated by one P-EN and one E-PG neuron, or by multiple neurons of the same type? If so, different neurons innervating the same glomerulus could have different bandwidths. This point should be discussed more extensively.</italic> </p><p>To clarify: We did not mean to make the point that the coding bandwidth of each individual neuron corresponds with the behavioral bandwidth of turning velocities displayed by the fly in that particular experiment. This correlation is in fact rather weak (R<sup>2</sup> = 0.51, p = 0.094). The information we intended to convey is that, as a population, P-ENs responded to the full range of rotational velocities displayed by the flies as they walked on the ball. To correct the misrepresentation, we have slightly reworded the respective section in the text and changed the plot from ‘behavioral bandwidth = X versus P-EN bandwidth = Y’ style in Figure 3—figure supplement 2I to a category plot with interconnecting lines (now <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1E</xref>).</p><p>We have also added the point to the discussion that every single glomerulus of the protocerebral brige is innervated by several P-ENs and that hence the diversity in P-EN response bandwidth could be harnessed by the circuit to integrate a broad range of rotational velocities with high precision.</p><p><italic><xref ref-type="fig" rid="fig1">Figure 1B</xref>: Please show a single E-PG neuron. Also, a connectivity map of the bridge and the ellipsoid body like <xref ref-type="fig" rid="fig6">Figure 6</xref> in Hanesch et al., 1989, or <xref ref-type="fig" rid="fig3">Figure 3</xref> of the authors in their Current Biology article 2016 would be helpful. Along these lines, some words about the intriguing bilateral asymmetry of this structure could be included in the discussion.</italic> </p><p>We have modified <xref ref-type="fig" rid="fig1">Figure 1</xref> to include examples of single E-PG and P-EN neurons and to feature a connectivity map of the bridge and ellipsoid body for both neuron types.</p><p>We have also added discussion relating to the bilateral asymmetry of the central complex.</p><p><italic>For <xref ref-type="fig" rid="fig2">Figure 2</xref> the behavioral trace was convolved with the GCamP6f filter before correlation with the calcium signals in the noduli. In my understanding this was not done for the dual color calcium experiments in <xref ref-type="fig" rid="fig7">Figure 7</xref> and <xref ref-type="fig" rid="fig8">Figure 8</xref>. Why not? Maybe this would account for the quantitative differences in the PVA offsets for the different indicator combinations.</italic></p><p>The reviewers are correct to point out that quantitative differences in PVA offsets for different indicator combinations may arise from the different rise and decay kinetics of the red and green indicators we used. Not knowing indicator time constants for P-EN neurons, we wanted to minimize the use of deconvolution to cases in which interpretations would not be significantly affected by possible inaccuracies in the time constants we chose. We thus used the “raw” data when we were making direct comparisons of phase relationships between two populations, and acquired that data using both combinations of calcium indicators (an issue explored in more depth in a GENIE Team publication, <xref ref-type="bibr" rid="bib31">Sun et al., 2017</xref>). We saw that P-EN activity led E-PG activity regardless of the indicator combination used, albeit more strongly in one direction. We are therefore confident in the existence of an offset between the two populations, but we do not wish to push our interpretation too much further.</p><p>To gain some intuition for the magnitude of the offset across velocities, and in response to the reviewers’ question, we did simulate offsets that would be predicted given a variety of different time constants. Time constants for the <italic>Drosophila</italic> larval NMJ were taken from (Dana et al., 2016) (Figure 7—figure supplement 3) and for the dissociated neurons from (Chen et al., 2013) (<xref ref-type="fig" rid="fig1">Figure 1</xref>) and (Dana et al., 2016) (<xref ref-type="fig" rid="fig2">Figure 2</xref>). We assumed Gaussian activity profiles for the E-PG and P-EN neurons with a FWHM of 90<sup>o</sup> and a variety of phase offsets as a function of velocity. <xref ref-type="fig" rid="fig12">Author response image 1A</xref> shows the results for a linearly increasing offset between the E-PG and P-EN bumps with increasing velocity. While we can “fit” the data to the linear profile for a choice of time constants, this involves an arbitrary, if bounded, choice of time constants and an assumed function that relates the offset to the phase difference. We expect that such a choice of time constants would lead to a similarly broad range of “extracted” phase difference functions with a deconvolution procedure, so we would prefer not to include it in the main manuscript.<fig id="fig12" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.028</object-id><label>Author response image 1.</label><caption><title>Simulating the effects of the Ca<sup>2+</sup> time constants on the observed bump activity.</title><p>(<bold>A</bold>) Overview of the procedure for convolving a simulated activity profile with on and off GECI time constants. The bump profiles are assumed to be Gaussians with full width at half maxima of 90<sup>o</sup>. Those profiles are then convolved with the difference between a decaying exponential with time constant τ<sub>on</sub> and a decaying exponential with time constant τ<sub>off</sub> to create a final simulated activity profile. (<bold>B</bold>) The phase difference between the simulated P-EN Gaussian bump and the simulated E-PG Gaussian bump was assumed to vary linearly with the rotational velocity. (<bold>C</bold>) The simulated phase difference of the activity bumps after being convolved with a variety of time constants. (Top) The time constants are assumed to be those measured after exciting dissociated mouse neurons with 10 action potentials (Chen et al., 2013) (Dana et al., 2016) (Middle). Time constants chosen to best fit the data. (Bottom) The time constants are assumed to be those measured after exciting neurons in the larval <italic>Drosophila</italic> neuromuscular junction at 5 Hz (Dana et al., 2016). For the left columns, the P-EN neurons are assumed to express the green GECI, GCaMP6f, while the E-PG neurons are assumed to express the red GEC, jRGECO1a. The opposite colors are assumed to have been used at right.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.028">http://dx.doi.org/10.7554/eLife.23496.028</ext-link></p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-23496-resp-fig1-v1"/></fig></p><p><italic><xref ref-type="fig" rid="fig1">Figures 1</xref>, <xref ref-type="fig" rid="fig2">2</xref> and <xref ref-type="fig" rid="fig8">8</xref> provide partial sketches about the system's connectivity but I missed a comprehensive wiring diagram: Which P glomerulus projects via P-ENs to which of the 8 tile-shaped sectors of the ellipsoid body, and which of the 16 wedge-shaped sectors of the ellipsoid body projects via E-PGs to which glomerulus? In particular, one would like to know how successive tile-shaped sectors overlap – I assume by one wedge, but these important details do not seem to be addressed in the manuscript (the movie touches a bit on these issues but can't provide a good solution).</italic> </p><p>We have added a connectivity map to <xref ref-type="fig" rid="fig1">Figure 1</xref>.</p><p><italic>The authors use the population vector to decode the heading direction from the E-PG activity. It would be great if they could elaborate on that concept and discuss whether the PV is also calculated by the fly (and if so: where) or whether the PV is simply a method for the experimentalist to study E-PG activity (if so: does the animal estimate its heading direction, and if so: how?)</italic> </p><p>This is an important issue that we are actively exploring, but that we have few definitive answers for at this stage. Nevertheless, we have added a paragraph related to this issue in Discussion section (Paragraph four).</p><p><italic>Definition of the model system: the notation, e.g., ω(Θ<sub>i</sub>,t) or the ∂t ω</italic>,<italic>, suggests a system of partial differential equations, in contrast to the finite number of neurons (54) in each cell population. This approach also suggests that each cell population is continuous, i.e. without the notion of wedges or tiles with (more or less) homogeneous populations within each sector. In addition, the model does not distinguish between the larger tiles and smaller wedges – in fact, 54 is not divisible by 8 so this choice remains a bit mysterious. On the other hand, the authors' compact model is appealing. But one would like to see a detailed discussion on how the model relates to the experimental (in particular: anatomical) facts.</italic> </p><p>All the simulations are done in continuous time and the dynamics are written in terms of temporal derivatives (i.e. with<inline-formula><mml:math id="inf47"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi mathvariant="normal">∂</mml:mi><mml:mi>t</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> operators). In terms of angles, however, everything is indeed discrete, as the reviewer notes. It is then true that the integrals in the equations are actually just sums over all the discrete angles. We chose 54 neurons based partly on known anatomy and partly for simplicity. There are 9 glomeruli in the protocerebral bridge, which have corresponding tiles in ellipsoid body. We thus have 9 tiles that we divide into two wedges and wedges are believed, based on cell counts, to have approximately 3 E-PG neurons (which make 9 * 2 * 3 = 54). For simplification, we consider that there are as many left and right P-EN neurons as E-PG neurons, even though this is not true in the actual fly central complex. Since, at this stage, the precise anatomical interactions between P-EN neurons and E-PG neurons are still uncertain, we chose simplicity over accurate detail. This simple model will be revisited as more anatomical data becomes available. However, we expect that some of the desirable properties of the network (linear angular velocity response, for example) will remain in the more precise models. We agree with the reviewers that this is a very important point, especially for future research and we have now added comments along these lines in the Discussion section.</p><p><italic>Predictions of the model system: it would be nice if the authors could run a simulation with time-dependent velocity input, similar to the experimental situation shown in <xref ref-type="fig" rid="fig1">Figure 1E</xref>. This would greatly help to appreciate the model's predictive power and could be included as a separate new panel in <xref ref-type="fig" rid="fig8">Figure 8</xref>.</italic> </p><p>We thank the reviewers for this suggestion, and we have done as the reviewers recommend (see <xref ref-type="fig" rid="fig10">Figure 10F, G</xref>). One of the nice features of the dynamics that emerge from the architecture we assumed is the linearity of the angular velocity response (see <xref ref-type="fig" rid="fig10">Figure 10E</xref>). This means that it should respond well to time varying velocity input. We have checked this in <xref ref-type="fig" rid="fig10">Figure 10F</xref> and have measured the diffusion coefficient for the angular integration errors that emerge over the course of these simulations (<xref ref-type="fig" rid="fig10">Figure 10G</xref>). Overall, we have a system that works well, at least in the absence of noise, for the velocity ranges that are observed experimentally. This is an important point and we have added a description of these properties in the main text.</p><p><italic>Figure 2—figure supplement 1: Why are there negative correlation coefficients for CCW in the left nodulus (and for CW in the right nodulus)? Could this phenomenon hint at a pull-push mechanism, with pull (excitation) in front of the E-PG bump and push (inhibition) behind it?</italic> </p><p>The negative correlations in the noduli are consistent with the electrophysiological recordings, where the activity decreases for turns in the contralateral direction. While this suggests a ‘pull – no pull’ mechanism, we see no evidence for a pull-push mechanism.</p><p><italic>Interestingly, several features of the P-EN neurons do not fit well with the hypothetic wiring scheme, while other, yet unknown neural elements, still need to be identified in order to fully explain the neural network involved in head direction coding. I suggest addressing these issues more clearly and openly in the discussion, in particular the apparent lack of visual responses in P-EN neurons and the unexpected one-glomerulus shift of P-EN activity following the E-PG activity as these will guide future efforts to unravel the missing elements in the mechanisms of head-direction coding.</italic> </p><p>We have converted the “Other inputs to the compass system” section of the Discussion to “Other elements of the compass system,” and added the following statements:</p><p>“For example, we have previously observed that the ring neurons retinotopically respond to visual cues (Seelig and Jayaraman, 2013). As the putative ring neuron axons arborize in the ellipsoid body along with the E-PG dendrites, it may be possible for them to convey visual information to the E-PG neurons, influencing the movement of the bump of activity.”</p><p>“Further, we suggested above that the E-PG to P-EN connection in the protocerebral bridge may be indirect and recruit sources of inhibition. There exist a few classes of bridge interneurons, the so-called PBG6-8.sG9.b, PB18.s-GxΔ7Gy.b and PB18.s-9i1i8c.b neurons (Wolff et al., 2015), which may serve as intermediaries in E-PG to P-EN connections. “</p><p>And, finally, we have added a mention to a parallel, independent study that we hope to coordinate publication with. This study, from the Maimon lab, finds evidence for a second type of P-EN neuron that may influence bump movement.</p><p>We have decided to remove visual response data from the manuscript, for example, the data for closed loop gains of ‘-1’, as these will require a more in-depth exploration to be properly understood.</p><p><italic>Why do the authors use the term &quot;glomerulus&quot; for substructures in the protocerebral bridge that Ito et al., 2014, in a widely accepted intention for a uniform nomenclature of insect brain structures have termed &quot;slice&quot; instead? The term &quot;glomerulus&quot; has originally been used to denote substructures in the antennal lobe/olfactory bulb that are reminiscent in organization to a kidney glomerulus (shell and core). Nothing like this is apparent in the slices of the protocerebral bridge and using the term &quot;glomerulus&quot; instead might cause confusion about its internal organization. By the way, the term has only been used in flies and not in other insect species, which is again highly unfortunate. Therefore, I suggest changing the term &quot;glomerulus&quot; to the widely accepted term &quot;slice&quot;.</italic> </p><p>We drew heavy inspiration from the anatomical study of Wolff et al., 2015 (and from the earlier study of Hanesch et al., 1989) and would prefer to preserve their nomenclature. We acknowledge that Ito et al., 2014 have termed these structures “slices”, but also note that they make ample use of the term “glomerulus” for regions outside the antennal lobe (specifically, the Bulb and Optic Glomeruli). As a compromise, we mention protocerebral bridge “slices” before we first use the term “glomerulus”. Finally, we did some etymological archeology in response to the reviewers’ concerns about the word itself, and learned that “glomerulus” is derived from the Latin “glomus”, or a “ball of yarn”, which seems to describe the internals of protocerebral bridge slices rather well.</p><p><italic>Subsection “An excitatory loop between P-ENs and E-PGs”. It is highly surprising to see that the P-EN neurons apparently do not respond to visual cues. Unfortunately, only two experiments are provided to support this (Figure 3—figure supplement 2). If this is correct, however, the P-EN neurons cannot receive synaptic input (directly or indirectly) from E-PG neurons in the ellipsoid body, because their signaling as shown by Seelig and Jayaraman (2013, 2015) is dominated by visual over proprioceptive feedback cues. This may be the reason why activation of the E-PG neurons resulted in inconclusive responses in P-EN neurons. I think this discrepancy in the results should be more clearly addressed in the discussion. In other insect species there are multiple sets of P-EN and E-PG neurons (e.g. in locust 3 sets of EPG neurons termed CL1 and 2 sets of PEN neurons termed CL2, partly with opposite polarity). How is it in flies? If the situation is similar, these second or third set, not studied here, will likewise contribute to compass coding, and might be in part responsible for the discrepancies between hypotheses and results.</italic></p><p>The reviewers correctly point out that P-EN angular velocity tuning as assessed by electrophysiology is apparently unaltered in the presence of a stripe that is coupled to the fly’s movements with a gain of 1 or -1. To probe this response further, we performed two color imaging in the protocerebral bridge under three conditions: in the dark, with a stripe with 1x closed loop gain, or with a stripe with a -1x closed loop gain. The results are summarized in <xref ref-type="fig" rid="fig13">Author response image 2</xref>. As reported previously, E-PG activity follows the stripe/heading for a gain of 1. For a gain of -1, E-PG activity predominantly follows the fly’s heading, with the exception of rare periods where E-PG activity tracks the stripe instead (highlighted in blue). This is also consistent with our previous report, where E-PG activity was often seen to track the fly’s movements rather than visual cue position for a gain of 0.5 (Seelig &amp; Jayaraman 2015, Extended Data <xref ref-type="fig" rid="fig6">Figure 6</xref>). Thus, it is not surprising that the P-EN activity is comparable across all three of these conditions, as seen in the electrophysiology and the imaging. We also cannot conclude that “the P-EN neurons cannot receive synaptic input from E-PG neurons” given these results. Visual cues may predominantly drive the E-PG activity under other conditions and, in fact, alternative pathways likely exist to update the E-PG bump position with respect to visual cues, but such conclusions must be left to future experiments. Despite these findings being in accordance with our interpretation and despite the consistency between E-PG and P-EN results, we would prefer to remove the gain = -1 data from the paper as it is an issue that deserves more thorough investigation.</p><p>Regarding other types of P-EN/CL2 neurons: although we know of Homberg lab studies that have identified 3 sets of CL1 neurons in locusts, we are unaware of published evidence for two types of CL2 neurons in that system. We are, however, aware of a different <italic>Drosophila</italic> study carried out in parallel with ours that does identify a second class of P-EN neuron. As mentioned earlier, we now briefly refer to this work in Discussion section (with permission from the Maimon lab).<fig id="fig13" position="float"><object-id pub-id-type="doi">10.7554/eLife.23496.029</object-id><label>Author response image 2.</label><caption><title>P-EN and E-PG activity in the protocerebral bridge while the fly controls a 15<sup>o</sup> wide stripe with a gain of -1.</title><p>(<bold>A</bold>) Left and right E-PG bump position, as measured by the bump PVA, for a fly viewing a closed loop strip with a gain of 1 (top) and a gain of -1 (bottom) as compared to the position of the visual stripe and to the fly’s heading. (<bold>B</bold>) The mean and standard deviation of the left and right P-EN activity in the protocerebral bridge as a function of rotational velocity when the fly is in the dark or viewing a stipe with a gain of 1 or -1 for one fly. (<bold>C</bold>) Mean (dot) and standard deviation (line) of the mean ipsilatateral P-EN activity (from 0-150 <sup>o</sup>/s) across flies.</p><p><bold>DOI:</bold> <ext-link ext-link-type="doi" xlink:href="10.7554/eLife.23496.029">http://dx.doi.org/10.7554/eLife.23496.029</ext-link></p></caption><graphic mime-subtype="x-tiff" mimetype="image" xlink:href="elife-23496-resp-fig2-v1"/></fig></p></body></sub-article></article>